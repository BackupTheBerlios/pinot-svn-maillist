From fabricecolin at mail.berlios.de  Mon Dec  1 13:56:15 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 1 Dec 2008 13:56:15 +0100
Subject: [Pinot-svn] r1423 - trunk
Message-ID: <200812011256.mB1CuFdg009736@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-01 13:56:07 +0100 (Mon, 01 Dec 2008)
New Revision: 1423

Modified:
   trunk/configure.in
Log:
If textcat.h can't be found, we'll have to do without.
Look for the library pthreadGCE2 if others can't be found.
The test for GIO can be disabled with --enable-gio=yes/no.
Substitute MISC_CFLAGS in Makefile's.
Check for the dlfcn.h header, and the functions gmtime_r(), localtime_r(),
strptime() and mkstemp().


Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2008-11-30 10:09:54 UTC (rev 1422)
+++ trunk/configure.in	2008-12-01 12:56:07 UTC (rev 1423)
@@ -71,7 +71,7 @@
 AC_PATH_PROG(DESKTOP_INSTALL, desktop-file-install, no)
 
 dnl DEBUG mode
-CXXFLAGS="-fPIC"
+CXXFLAGS="-fPIC $CXXFLAGS"
 AC_MSG_CHECKING(whether to enable DEBUG mode)
 AC_ARG_ENABLE(debug,
    [AS_HELP_STRING([--enable-debug], [enable debug [default=no]])],
@@ -99,7 +99,6 @@
 ;;
 esac
 fi
-AC_SUBST(VISIB_CFLAGS)
 
 dnl SOAP API support
 AC_MSG_CHECKING(whether to enable SOAP support)
@@ -245,8 +244,7 @@
 
 dnl TextCat
 AC_CHECK_HEADERS([textcat.h],,
-   [AC_CHECK_HEADERS([libtextcat/textcat.h],,
-   [AC_MSG_ERROR([Can't find textcat.h.])])
+   [AC_CHECK_HEADERS([libtextcat/textcat.h])
    ])
 AC_CHECK_LIB(textcat, textcat_Cat,
    [AM_CONDITIONAL(HAVE_TEXTCAT_CAT, true)],
@@ -281,21 +279,37 @@
    fi
 else
    AC_MSG_RESULT(no)
-   AC_MSG_ERROR([Can't find pthreads.])
-   exit 1
+   AC_CHECK_LIB(pthreadGCE2, pthread_mutex_lock,
+      [PTHREAD_CFLAGS="-Ipthread"
+       PTHREAD_LIBS="-lpthreadGCE2"])
+
+   if test -z "$PTHREAD_LIBS" ; then
+      AC_MSG_ERROR([Can't find pthreads.])
+      exit 1
+   fi
 fi
 
 dnl Check whether we can use GIO instead of xdgmime
-dnl This test is from gtk's configure.in, with some modifications
 AM_CONDITIONAL(HAVE_GIO_MIME, false)
 AC_MSG_CHECKING([if gio can sniff png])
-gtk_save_LIBS="$LIBS"
-gtk_save_CFLAGS="$CFLAGS"
-gtk_save_CXXFLAGS="$CXXFLAGS"
-LIBS="`$PKG_CONFIG --libs gio-2.0`"
-CFLAGS="`$PKG_CONFIG --cflags gio-2.0`"
-CXXFLAGS="`$PKG_CONFIG --cflags gio-2.0`"
-AC_RUN_IFELSE([AC_LANG_SOURCE([[
+AC_ARG_ENABLE(gio,
+   [AS_HELP_STRING([--enable-gio], [enable gio [default=test]])],
+   ,[enable_gio=test])
+if test "x$enable_gio" = "xyes"; then
+   gio_can_sniff=yes
+   AM_CONDITIONAL(HAVE_GIO_MIME, true)
+else if test "x$enable_gio" = "xno"; then
+   gio_can_sniff=no
+   AM_CONDITIONAL(HAVE_GIO_MIME, false)
+else
+   dnl This test is from gtk's configure.in, with some modifications
+   gtk_save_LIBS="$LIBS"
+   gtk_save_CFLAGS="$CFLAGS"
+   gtk_save_CXXFLAGS="$CXXFLAGS"
+   LIBS="`$PKG_CONFIG --libs gio-2.0`"
+   CFLAGS="`$PKG_CONFIG --cflags gio-2.0`"
+   CXXFLAGS="`$PKG_CONFIG --cflags gio-2.0`"
+   AC_RUN_IFELSE([AC_LANG_SOURCE([[
   #include <string.h>
   #include <gio/gio.h>
   static const gsize data_size = 159;
@@ -328,15 +342,19 @@
   [gio_can_sniff=yes
    AM_CONDITIONAL(HAVE_GIO_MIME, true)],
   [gio_can_sniff=no])
+   LIBS="$gtk_save_LIBS"
+   CFLAGS="$gtk_save_CFLAGS"
+   CXXFLAGS="$gtk_save_CXXFLAGS"
+fi
+fi
 AC_MSG_RESULT($gio_can_sniff)
-LIBS="$gtk_save_LIBS"
-CFLAGS="$gtk_save_CFLAGS"
-CXXFLAGS="$gtk_save_CXXFLAGS"
 
 dnl Other libraries
+MISC_CFLAGS="$PTHREAD_CFLAGS $VISIB_CFLAGS"
 MISC_LIBS="-lcrypt $PTHREAD_LIBS"
+AC_SUBST(MISC_CFLAGS)
 AC_SUBST(MISC_LIBS)
-AC_CHECK_HEADERS([sys/vfs.h sys/statfs.h sys/mount.h sys/statvfs.h])
+AC_CHECK_HEADERS([sys/vfs.h sys/statfs.h sys/mount.h sys/statvfs.h dlfcn.h])
 PKG_CHECK_MODULES(MIMEINFO, shared-mime-info )
 SHARED_MIME_INFO_PREFIX=`pkg-config --variable=prefix shared-mime-info`
 AC_SUBST(SHARED_MIME_INFO_PREFIX)
@@ -395,6 +413,9 @@
 AC_CHECK_FUNCS(vsnprintf)
 AC_CHECK_FUNCS(gettimeofday)
 AC_CHECK_FUNCS(timegm)
+AC_CHECK_FUNCS(gmtime_r)
+AC_CHECK_FUNCS(localtime_r)
+AC_CHECK_FUNCS(strptime)
 AC_CHECK_FUNCS(lstat)
 AC_CHECK_FUNCS(mmap)
 AC_CHECK_FUNCS(socketpair)
@@ -403,6 +424,7 @@
 AC_CHECK_FUNCS(statvfs)
 AC_CHECK_FUNCS(statfs)
 AC_CHECK_FUNCS(sysctlbyname)
+AC_CHECK_FUNCS(mkstemp)
 
 AC_OUTPUT( pinot.spec UI/GTK2/src/de.berlios.Pinot.service Makefile \
 	Utils/Makefile Tokenize/Makefile SQL/Makefile po/Makefile.in Collect/Makefile \



From fabricecolin at mail.berlios.de  Mon Dec  1 13:57:48 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 1 Dec 2008 13:57:48 +0100
Subject: [Pinot-svn] r1424 - in trunk: Collect IndexSearch
	IndexSearch/Xapian IndexSearch/XesamGLib Monitor SQL Tokenize
	UI/GTK2/src Utils
Message-ID: <200812011257.mB1CvmKo009907@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-01 13:57:36 +0100 (Mon, 01 Dec 2008)
New Revision: 1424

Modified:
   trunk/Collect/Makefile.am
   trunk/IndexSearch/Makefile.am
   trunk/IndexSearch/Xapian/Makefile.am
   trunk/IndexSearch/XesamGLib/Makefile.am
   trunk/Monitor/Makefile.am
   trunk/SQL/Makefile.am
   trunk/Tokenize/Makefile.am
   trunk/UI/GTK2/src/Makefile.am
   trunk/Utils/Makefile.am
Log:
Use MISC_CFLAGS not VISIB_CFLAGS.


Modified: trunk/Collect/Makefile.am
===================================================================
--- trunk/Collect/Makefile.am	2008-12-01 12:56:07 UTC (rev 1423)
+++ trunk/Collect/Makefile.am	2008-12-01 12:57:36 UTC (rev 1424)
@@ -18,7 +18,7 @@
 	MboxCollector.cpp
 
 libCollect_la_CXXFLAGS = \
-	@VISIB_CFLAGS@ \
+	@MISC_CFLAGS@ \
 	-I$(top_srcdir)/Utils \
 	-I$(top_srcdir)/Tokenize \
 	-I$(top_srcdir)/Tokenize/filters \

Modified: trunk/IndexSearch/Makefile.am
===================================================================
--- trunk/IndexSearch/Makefile.am	2008-12-01 12:56:07 UTC (rev 1423)
+++ trunk/IndexSearch/Makefile.am	2008-12-01 12:57:36 UTC (rev 1424)
@@ -87,7 +87,7 @@
 pinot_search_DEPENDENCIES = libIndexSearch.la
 
 AM_CXXFLAGS = \
-	@VISIB_CFLAGS@ \
+	@MISC_CFLAGS@ \
 	-I$(top_srcdir)/Utils \
 	-I$(top_srcdir)/Tokenize \
 	-I$(top_srcdir)/Tokenize/filters \

Modified: trunk/IndexSearch/Xapian/Makefile.am
===================================================================
--- trunk/IndexSearch/Xapian/Makefile.am	2008-12-01 12:56:07 UTC (rev 1423)
+++ trunk/IndexSearch/Xapian/Makefile.am	2008-12-01 12:57:36 UTC (rev 1424)
@@ -39,7 +39,7 @@
 	@INDEX_LIBS@ @MISC_LIBS@
 
 AM_CXXFLAGS = \
-	@VISIB_CFLAGS@ \
+	@MISC_CFLAGS@ \
 	-I$(top_srcdir)/Utils \
 	-I$(top_srcdir)/Tokenize \
 	-I$(top_srcdir)/Tokenize/filters \

Modified: trunk/IndexSearch/XesamGLib/Makefile.am
===================================================================
--- trunk/IndexSearch/XesamGLib/Makefile.am	2008-12-01 12:56:07 UTC (rev 1423)
+++ trunk/IndexSearch/XesamGLib/Makefile.am	2008-12-01 12:57:36 UTC (rev 1424)
@@ -18,7 +18,7 @@
 	@XESAMGLIB_LIBS@ @MISC_LIBS@
 
 AM_CXXFLAGS = \
-	@VISIB_CFLAGS@ \
+	@MISC_CFLAGS@ \
 	-I$(top_srcdir)/Utils \
 	-I$(top_srcdir)/Tokenize \
 	-I$(top_srcdir)/Tokenize/filters \

Modified: trunk/Monitor/Makefile.am
===================================================================
--- trunk/Monitor/Makefile.am	2008-12-01 12:56:07 UTC (rev 1423)
+++ trunk/Monitor/Makefile.am	2008-12-01 12:57:36 UTC (rev 1424)
@@ -19,7 +19,7 @@
 endif
 
 libMonitor_la_CXXFLAGS = \
-	@VISIB_CFLAGS@ \
+	@MISC_CFLAGS@ \
 	-I$(top_srcdir)/Utils \
 	-I$(top_srcdir)/Tokenize \
 	-I$(top_srcdir)/Tokenize/filters \

Modified: trunk/SQL/Makefile.am
===================================================================
--- trunk/SQL/Makefile.am	2008-12-01 12:56:07 UTC (rev 1423)
+++ trunk/SQL/Makefile.am	2008-12-01 12:57:36 UTC (rev 1424)
@@ -21,6 +21,6 @@
 	ViewHistory.cpp
 
 AM_CXXFLAGS = \
-	@VISIB_CFLAGS@ \
+	@MISC_CFLAGS@ \
 	-I$(top_srcdir)/Utils
 

Modified: trunk/Tokenize/Makefile.am
===================================================================
--- trunk/Tokenize/Makefile.am	2008-12-01 12:56:07 UTC (rev 1423)
+++ trunk/Tokenize/Makefile.am	2008-12-01 12:57:36 UTC (rev 1424)
@@ -61,7 +61,7 @@
 	$(top_srcdir)/Tokenize/filters/XmlFilter.cc
 
 AM_CXXFLAGS = \
-	@VISIB_CFLAGS@ \
+	@MISC_CFLAGS@ \
 	-I$(top_srcdir)/Utils -Ifilters \
 	@GMIME_CFLAGS@ @XML_CFLAGS@ @EXIF_CFLAGS@ @TAGLIB_CFLAGS@ \
 	-D_DYNAMIC_DIJON_FILTERS \

Modified: trunk/UI/GTK2/src/Makefile.am
===================================================================
--- trunk/UI/GTK2/src/Makefile.am	2008-12-01 12:56:07 UTC (rev 1423)
+++ trunk/UI/GTK2/src/Makefile.am	2008-12-01 12:57:36 UTC (rev 1424)
@@ -69,7 +69,7 @@
 bin_PROGRAMS = pinot pinot-dbus-daemon
 
 AM_CXXFLAGS = \
-	@VISIB_CFLAGS@ \
+	@MISC_CFLAGS@ \
 	-I$(top_srcdir)/Utils \
 	-I$(top_srcdir)/Tokenize \
 	-I$(top_srcdir)/Tokenize/filters \

Modified: trunk/Utils/Makefile.am
===================================================================
--- trunk/Utils/Makefile.am	2008-12-01 12:56:07 UTC (rev 1423)
+++ trunk/Utils/Makefile.am	2008-12-01 12:57:36 UTC (rev 1424)
@@ -62,6 +62,6 @@
 
 AM_CFLAGS = -fPIC -DXDG_PREFIX=pinot_xdg -DUNAC_VERSION=\"1.0.7\"
 AM_CXXFLAGS = \
-	@VISIB_CFLAGS@ \
+	@MISC_CFLAGS@ \
 	@HTTP_CFLAGS@ @INDEX_CFLAGS@ @GLIBMM_CFLAGS@ -DXDG_PREFIX=pinot_xdg -DUNAC_VERSION=\"1.0.7\"
 



From fabricecolin at mail.berlios.de  Mon Dec  1 14:01:19 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 1 Dec 2008 14:01:19 +0100
Subject: [Pinot-svn] r1425 - in trunk: IndexSearch IndexSearch/Xapian
	Tokenize Utils Utils/unac
Message-ID: <200812011301.mB1D1JON010475@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-01 14:01:09 +0100 (Mon, 01 Dec 2008)
New Revision: 1425

Modified:
   trunk/IndexSearch/ModuleFactory.cpp
   trunk/IndexSearch/Xapian/LanguageDetector.cpp
   trunk/Tokenize/FilterUtils.cpp
   trunk/Utils/Document.cpp
   trunk/Utils/TimeConverter.cpp
   trunk/Utils/unac/unac.c
Log:
Portability fixes, brought up when compiling with MingW.


Modified: trunk/IndexSearch/ModuleFactory.cpp
===================================================================
--- trunk/IndexSearch/ModuleFactory.cpp	2008-12-01 12:57:36 UTC (rev 1424)
+++ trunk/IndexSearch/ModuleFactory.cpp	2008-12-01 13:01:09 UTC (rev 1425)
@@ -15,28 +15,29 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
+
+#include "config.h"
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <unistd.h>
 #include <dirent.h>
+#ifdef HAVE_DLFCN_H
 #include <dlfcn.h>
+#endif
 #include <utility>
 #include <iostream>
 
 #include "DBusIndex.h"
 #include "PluginWebEngine.h"
 #include "ModuleFactory.h"
-#if 0
-#include "XapianDatabaseFactory.h"
-#include "XapianIndex.h"
-#include "XapianEngine.h"
-#endif
 
+#ifdef HAVE_DLFCN_H
 #ifdef __CYGWIN__
 #define DLOPEN_FLAGS RTLD_NOW
 #else
 #define DLOPEN_FLAGS (RTLD_NOW|RTLD_LOCAL)
 #endif
+#endif
 
 #define GETMODULEPROPERTIESFUNC	"getModuleProperties"
 #define OPENORCREATEINDEXFUNC	"openOrCreateIndex"
@@ -136,12 +137,14 @@
 		return NULL;
 	}
 
+#ifdef HAVE_DLFCN_H
 	getIndexFunc *pFunc = (getIndexFunc *)dlsym(pHandle,
 		GETINDEXFUNC);
 	if (pFunc != NULL)
 	{
 		return (*pFunc)(option);
 	}
+#endif
 #ifdef DEBUG
 	cout << "ModuleFactory::getLibraryIndex: couldn't find export getIndex" << endl;
 #endif
@@ -164,12 +167,14 @@
 		return NULL;
 	}
 
+#ifdef HAVE_DLFCN_H
 	getSearchEngineFunc *pFunc = (getSearchEngineFunc *)dlsym(pHandle,
 		GETSEARCHENGINEFUNC);
 	if (pFunc != NULL)
 	{
 		return (*pFunc)(option);
 	}
+#endif
 #ifdef DEBUG
 	cout << "ModuleFactory::getLibrarySearchEngine: couldn't find export getSearchEngine" << endl;
 #endif
@@ -179,8 +184,9 @@
 
 unsigned int ModuleFactory::loadModules(const string &directory)
 {
+	unsigned int count = 0;
+#ifdef HAVE_DLFCN_H
 	struct stat fileStat;
-	unsigned int count = 0;
 
 	if (directory.empty() == true)
 	{
@@ -280,6 +286,7 @@
 		pDirEntry = readdir(pDir);
 	}
 	closedir(pDir);
+#endif
 
 	return count;
 }
@@ -301,12 +308,14 @@
 		return false;
 	}
 
+#ifdef HAVE_DLFCN_H
 	openOrCreateIndexFunc *pFunc = (openOrCreateIndexFunc *)dlsym(pHandle,
 		OPENORCREATEINDEXFUNC);
 	if (pFunc != NULL)
 	{
 		return (*pFunc)(option, obsoleteFormat, readOnly, overwrite);
 	}
+#endif
 #ifdef DEBUG
 	cout << "ModuleFactory::openOrCreateIndex: couldn't find export openOrCreateIndex" << endl;
 #endif
@@ -331,12 +340,14 @@
 		return false;
 	}
 
+#ifdef HAVE_DLFCN_H
 	mergeIndexesFunc *pFunc = (mergeIndexesFunc *)dlsym(pHandle,
 		MERGEINDEXESFUNC);
 	if (pFunc != NULL)
 	{
 		return (*pFunc)(option0, option1, option2);
 	}
+#endif
 #ifdef DEBUG
 	cout << "ModuleFactory::mergeIndexes: couldn't find export mergeIndexes" << endl;
 #endif
@@ -482,6 +493,7 @@
 			continue;
 		}
 
+#ifdef HAVE_DLFCN_H
 		closeAllFunc *pFunc = (closeAllFunc *)dlsym(pHandle, CLOSEALLFUNC);
 		if (pFunc != NULL)
 		{
@@ -497,6 +509,7 @@
 			cout << "ModuleFactory::unloadModules: failed on " << typeIter->first << endl;
 #endif
 		}
+#endif
 	}
 
 	m_types.clear();

Modified: trunk/IndexSearch/Xapian/LanguageDetector.cpp
===================================================================
--- trunk/IndexSearch/Xapian/LanguageDetector.cpp	2008-12-01 12:57:36 UTC (rev 1424)
+++ trunk/IndexSearch/Xapian/LanguageDetector.cpp	2008-12-01 13:01:09 UTC (rev 1425)
@@ -1,5 +1,5 @@
 /*
- *  Copyright 2005,2006 Fabrice Colin
+ *  Copyright 2005-2008 Fabrice Colin
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -25,11 +25,16 @@
 #include "config.h"
 extern "C"
 {
+#define USE_TEXTCAT 1
 #ifdef HAVE_LIBTEXTCAT_TEXTCAT_H
 #include <libtextcat/textcat.h>
 #else
+#ifdef HAVE_TEXTCAT_H
 #include <textcat.h>
+#else
+#undef USE_TEXTCAT
 #endif
+#endif
 }
 
 #include "StringManip.h"
@@ -61,6 +66,7 @@
 void LanguageDetector::guessLanguage(const char *pData, unsigned int dataLength,
 			std::vector<std::string> &candidates)
 {
+#ifdef USE_TEXTCAT
 	string confFile(SYSCONFDIR);
 	char *textCatVersion = textcat_Version();
 #ifdef HAVE_TEXTCAT_CAT
@@ -177,4 +183,7 @@
 
 	// Close the descriptor
 	textcat_Done(td);
+#else
+	candidates.push_back("unknown");
+#endif
 }

Modified: trunk/Tokenize/FilterUtils.cpp
===================================================================
--- trunk/Tokenize/FilterUtils.cpp	2008-12-01 12:57:36 UTC (rev 1424)
+++ trunk/Tokenize/FilterUtils.cpp	2008-12-01 13:01:09 UTC (rev 1425)
@@ -16,11 +16,15 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <fcntl.h>
 #include <stdlib.h>
 #include <unistd.h>
 #include <iostream>
 #include <set>
 
+#include "config.h"
 #include "MIMEScanner.h"
 #include "StringManip.h"
 #include "TimeConverter.h"
@@ -230,7 +234,16 @@
 	{
 		char inTemplate[18] = "/tmp/filterXXXXXX";
 
+#ifdef HAVE_MKSTEMP
 		int inFd = mkstemp(inTemplate);
+#else
+		int inFd = -1;
+		char *pInFile = mktemp(inTemplate);
+		if (pInFile != NULL)
+		{
+			inFd = open(pInFile, O_RDONLY);
+		}
+#endif
 		if (inFd != -1)
 		{
 #ifdef DEBUG

Modified: trunk/Utils/Document.cpp
===================================================================
--- trunk/Utils/Document.cpp	2008-12-01 12:57:36 UTC (rev 1424)
+++ trunk/Utils/Document.cpp	2008-12-01 13:01:09 UTC (rev 1425)
@@ -22,7 +22,9 @@
 #include <ctype.h>
 #include <sys/types.h>
 #include <sys/stat.h>
+#ifdef HAVE_MMAP
 #include <sys/mman.h>
+#endif
 #ifdef HAVE_ATTR_XATTR_H
 #include <attr/xattr.h>
 #endif
@@ -208,21 +210,37 @@
 	// Discard existing data
 	resetData();
 
+#ifdef HAVE_MMAP
 	// Request a private mapping of the whole file
 	void *mapSpace = mmap(NULL, fileStat.st_size, PROT_READ, MAP_PRIVATE, fd, 0);
 	if (mapSpace != MAP_FAILED)
 	{
 		m_pData = (char*)mapSpace;
 		m_dataLength = fileStat.st_size;
-		setTimestamp(TimeConverter::toTimestamp(fileStat.st_mtime));
-		setSize(fileStat.st_size);
 		m_isMapped = true;
 	}
-	else
+	else cerr << "Document::setDataFromFile: mapping failed" << endl;
+#else
+	m_pData = (char *)malloc(sizeof(char) * (fileStat.st_size + 1));
+	if (m_pData != NULL)
 	{
-		cerr << "Document::setDataFromFile: mapping failed" << endl;
+		if (read(fd, (void*)m_pData, fileStat.st_size) == fileStat.st_size)
+		{
+			m_pData[fileStat.st_size] = '\0';
+			m_dataLength = (unsigned int)fileStat.st_size;
+		}
+		else
+		{
+			free(m_pData);
+			m_pData = NULL;
+		}
 	}
+	else cerr << "Document::setDataFromFile: reading failed" << endl;
+#endif
 
+	setTimestamp(TimeConverter::toTimestamp(fileStat.st_mtime));
+	setSize(fileStat.st_size);
+
 #ifdef HAVE_ATTR_XATTR_H
 	// Any extended attributes ?
 	ssize_t listSize = flistxattr(fd, NULL, 0);
@@ -311,11 +329,13 @@
 			// Free
 			free(m_pData);
 		}
+#ifdef HAVE_MMAP
 		else
 		{
 			// Unmap
 			munmap((void*)m_pData, m_dataLength);
 		}
+#endif
 	}
 
 	m_pData = NULL;

Modified: trunk/Utils/TimeConverter.cpp
===================================================================
--- trunk/Utils/TimeConverter.cpp	2008-12-01 12:57:36 UTC (rev 1424)
+++ trunk/Utils/TimeConverter.cpp	2008-12-01 13:01:09 UTC (rev 1425)
@@ -1,5 +1,5 @@
 /*
- *  Copyright 2005,2006 Fabrice Colin
+ *  Copyright 2005-2008 Fabrice Colin
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -17,6 +17,7 @@
  */
 
 #include "config.h"
+#include <stdlib.h>
 #ifdef HAVE_TIMEGM
 #ifndef _XOPEN_SOURCE
 #define _XOPEN_SOURCE
@@ -118,24 +119,36 @@
 /// Converts into an RFC 822 timestamp.
 string TimeConverter::toTimestamp(time_t aTime, bool inGMTime)
 {
-	struct tm timeTm;
+	struct tm *pTimeTm = new struct tm;
 
 	if (((inGMTime == true) &&
-		(gmtime_r(&aTime, &timeTm) != NULL)) ||
-		(localtime_r(&aTime, &timeTm) != NULL))
+#ifdef HAVE_GMTIME_R
+		(gmtime_r(&aTime, pTimeTm) != NULL)
+#else
+		((pTimeTm = gmtime(&aTime)) != NULL)
+#endif
+		) ||
+#ifdef HAVE_LOCALTIME_R
+		(localtime_r(&aTime, pTimeTm) != NULL)
+#else
+		((pTimeTm = localtime(&aTime)) != NULL)
+#endif
+		)
 	{
 		char timeStr[64];
 
+		// FIXME: don't use this extension ?
 #if defined(__GNU_LIBRARY__)
 		// %z is a GNU extension
-		if (strftime(timeStr, 64, "%a, %d %b %Y %H:%M:%S %z", &timeTm) > 0)
+		if (strftime(timeStr, 64, "%a, %d %b %Y %H:%M:%S %z", pTimeTm) > 0)
 #else
-		if (strftime(timeStr, 64, "%a, %d %b %Y %H:%M:%S %Z", &timeTm) > 0)
+		if (strftime(timeStr, 64, "%a, %d %b %Y %H:%M:%S %Z", pTimeTm) > 0)
 #endif
 		{
 			return timeStr;
 		}
 	}
+	delete pTimeTm;
 
 	return "";
 }
@@ -207,7 +220,13 @@
 	timeTm.tm_sec = timeTm.tm_min = timeTm.tm_hour = timeTm.tm_mday = 0;
 	timeTm.tm_mon = timeTm.tm_year = timeTm.tm_wday = timeTm.tm_yday = timeTm.tm_isdst = 0;
 
+#ifdef HAVE_STRPTIME
 	strptime(yyyymmdd.c_str(), "%Y%m%d", &timeTm);
+#else
+	timeTm.tm_year = atoi(yyyymmdd.substr(0, 4).c_str());
+	timeTm.tm_mon = atoi(yyyymmdd.substr(4, 2).c_str());
+	timeTm.tm_mday = atoi(yyyymmdd.substr(6, 2).c_str());
+#endif
 #ifdef DEBUG
 	cout << "TimeConverter::fromYYYYMMDDString: " << timeTm.tm_year << " " << timeTm.tm_mon << " " << timeTm.tm_mday << endl;
 #endif
@@ -271,7 +290,13 @@
 	timeTm.tm_sec = timeTm.tm_min = timeTm.tm_hour = timeTm.tm_mday = 0;
 	timeTm.tm_mon = timeTm.tm_year = timeTm.tm_wday = timeTm.tm_yday = timeTm.tm_isdst = 0;
 
+#ifdef HAVE_STRPTIME
 	strptime(hhmmss.c_str(), "%H%M%S", &timeTm);
+#else
+	timeTm.tm_hour = atoi(hhmmss.substr(0, 2).c_str());
+	timeTm.tm_min = atoi(hhmmss.substr(2, 2).c_str());
+	timeTm.tm_sec = atoi(hhmmss.substr(4, 2).c_str());
+#endif
 #ifdef DEBUG
 	cout << "TimeConverter::fromHHMMSSString: " << timeTm.tm_hour << " " << timeTm.tm_min << " " << timeTm.tm_sec << endl;
 #endif

Modified: trunk/Utils/unac/unac.c
===================================================================
--- trunk/Utils/unac/unac.c	2008-12-01 12:57:36 UTC (rev 1424)
+++ trunk/Utils/unac/unac.c	2008-12-01 13:01:09 UTC (rev 1425)
@@ -12617,10 +12617,10 @@
   if(*outp) {
     out = *outp;
     /* +1 for null */
-    out = realloc(out, out_size + 1);
+    out = (char*)realloc(out, out_size + 1);
   } else {
     /* +1 for null */
-    out = malloc(out_size + 1);
+    out = (char*)malloc(out_size + 1);
     if(out == 0) return -1;
   }
   out_length = 0;
@@ -12657,7 +12657,7 @@
      */
     if(out_length + ((l + 1) * 2) > out_size) {
       out_size += ((l + 1) * 2) + 1024;
-      out = realloc(out, out_size);
+      out = (char*)realloc(out, out_size);
       if(out == 0) {
 	if(debug_level == UNAC_DEBUG_LOW)
 	  DEBUG("realloc %d bytes failed\n", out_size);
@@ -12718,10 +12718,10 @@
   if(*outp) {
     out = *outp;
     /* +1 for null */
-    out = realloc(out, out_size + 1);
+    out = (char*)realloc(out, out_size + 1);
   } else {
     /* +1 for null */
-    out = malloc(out_size + 1);
+    out = (char*)malloc(out_size + 1);
     if(out == 0) return -1;
   }
   out_remain = out_size;
@@ -12779,7 +12779,7 @@
 	  int length = out - out_base;
 	  out_size *= 2;
 	  /* +1 for null */
-	  out_base = realloc(out_base, out_size + 1);
+	  out_base = (char*)realloc(out_base, out_size + 1);
 	  if(out_base == 0) return -1;
 	  out = out_base + length;
 	  out_remain = out_size - length;
@@ -12810,7 +12810,7 @@
    */
   if(in_length <= 0) {
     if(!*outp)
-      *outp = malloc(32);
+      *outp = (char*)malloc(32);
     (*outp)[0] = '\0';
     *out_lengthp = 0;
   } else {



From fabricecolin at mail.berlios.de  Mon Dec  1 14:16:45 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 1 Dec 2008 14:16:45 +0100
Subject: [Pinot-svn] r1426 - trunk/UI/GTK2/src
Message-ID: <200812011316.mB1DGjog012046@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-01 14:16:35 +0100 (Mon, 01 Dec 2008)
New Revision: 1426

Modified:
   trunk/UI/GTK2/src/DaemonState.cpp
   trunk/UI/GTK2/src/DaemonState.h
   trunk/UI/GTK2/src/ServerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Identify threads spawned by DBusServlet by their ID.
In mainWindow, use mktemp() if mkstemp() isn't available.


Modified: trunk/UI/GTK2/src/DaemonState.cpp
===================================================================
--- trunk/UI/GTK2/src/DaemonState.cpp	2008-12-01 13:01:09 UTC (rev 1425)
+++ trunk/UI/GTK2/src/DaemonState.cpp	2008-12-01 13:16:35 UTC (rev 1426)
@@ -131,7 +131,6 @@
 	m_pRequest(pRequest),
 	m_pReply(NULL),
 	m_pArray(NULL),
-	m_queryName(""),
 	m_simpleQuery(true),
 	m_pThread(NULL),
 	m_replied(false)
@@ -680,9 +679,6 @@
 			{
 				m_servletsInfo.insert(pInfo);
 
-#ifdef DEBUG
-				cout << "DaemonState::on_thread_end: running query " << pInfo->m_queryName << endl;
-#endif
 				start_thread(pInfo->m_pThread);
 			}
 			else
@@ -724,10 +720,10 @@
 			DBusServletInfo *pInfo = const_cast<DBusServletInfo *>(*servIter);
 
 			if ((pInfo != NULL) &&
-				(pInfo->m_queryName == queryProps.getName()))
+				(pInfo->m_pThread->getId() == pThread->getId()))
 			{
 #ifdef DEBUG
-				cout << "DaemonState::on_thread_end: ran query " << pInfo->m_queryName << endl;
+				cout << "DaemonState::on_thread_end: ran query " << queryProps.getName() << endl;
 #endif
 				// Prepare and send the reply
 				pInfo->newQueryReply(resultsList, pQueryThread->getDocumentsCount());

Modified: trunk/UI/GTK2/src/DaemonState.h
===================================================================
--- trunk/UI/GTK2/src/DaemonState.h	2008-12-01 13:01:09 UTC (rev 1425)
+++ trunk/UI/GTK2/src/DaemonState.h	2008-12-01 13:16:35 UTC (rev 1426)
@@ -60,7 +60,6 @@
 		DBusMessage *m_pRequest;
 		DBusMessage *m_pReply;
 		GPtrArray *m_pArray;
-		std::string m_queryName;
 		bool m_simpleQuery;
 		WorkerThread *m_pThread;
 

Modified: trunk/UI/GTK2/src/ServerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.cpp	2008-12-01 13:01:09 UTC (rev 1425)
+++ trunk/UI/GTK2/src/ServerThreads.cpp	2008-12-01 13:16:35 UTC (rev 1426)
@@ -1167,10 +1167,9 @@
 
 				// Give the query a unique name
 				queryNameStr << "DBUS" << m_id;
-				m_pServletInfo->m_queryName = queryNameStr.str();
 				m_pServletInfo->m_simpleQuery = false;
 
-				QueryProperties queryProps(m_pServletInfo->m_queryName, pSearchText);
+				QueryProperties queryProps(queryNameStr.str(), pSearchText);
 				queryProps.setMaximumResultsCount(maxHits);
 
 				string engineType, engineOption;
@@ -1221,10 +1220,9 @@
 
 				// Give the query a unique name
 				queryNameStr << "DBUS" << m_id;
-				m_pServletInfo->m_queryName = queryNameStr.str();
 				m_pServletInfo->m_simpleQuery = true;
 
-				QueryProperties queryProps(m_pServletInfo->m_queryName, pSearchText);
+				QueryProperties queryProps(queryNameStr.str(), pSearchText);
 				queryProps.setMaximumResultsCount(maxHits);
 
 				m_pServletInfo->m_pThread = new EngineQueryThread(settings.m_defaultBackend,

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2008-12-01 13:01:09 UTC (rev 1425)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2008-12-01 13:16:35 UTC (rev 1426)
@@ -137,7 +137,7 @@
 
 WorkerThread::WorkerThread() :
 	m_startTime(time(NULL)),
-	m_id(0),
+	m_id(ThreadsManager::get_next_id()),
 	m_background(false),
 	m_stopped(false),
 	m_done(false),
@@ -267,11 +267,12 @@
 	}
 }
 
+unsigned int ThreadsManager::m_nextThreadId = 1;
+
 ThreadsManager::ThreadsManager(const string &defaultIndexLocation,
 	unsigned int maxIndexThreads, unsigned int maxThreadsTime) :
 	m_defaultIndexLocation(defaultIndexLocation),
 	m_maxIndexThreads(maxIndexThreads),
-	m_nextThreadId(1),
 	m_backgroundThreadsCount(0),
 	m_foregroundThreadsMaxTime(maxThreadsTime),
 	m_numCPUs(1),
@@ -483,6 +484,13 @@
 	}
 }
 
+unsigned int ThreadsManager::get_next_id(void)
+{
+	unsigned int nextThreadId = ++m_nextThreadId;
+
+	return nextThreadId;
+}
+
 bool ThreadsManager::start_thread(WorkerThread *pWorkerThread, bool inBackground)
 {
 	bool createdThread = false;
@@ -492,7 +500,6 @@
 		return false;
 	}
 
-	pWorkerThread->setId(m_nextThreadId);
 	if (inBackground == true)
 	{
 #ifdef DEBUG
@@ -542,8 +549,6 @@
 		}
 	}
 
-	++m_nextThreadId;
-
 	return createdThread;
 }
 

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2008-12-01 13:01:09 UTC (rev 1425)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2008-12-01 13:16:35 UTC (rev 1426)
@@ -113,6 +113,8 @@
 			unsigned int maxThreadsTime = 300);
 		virtual ~ThreadsManager();
 
+		static unsigned int get_next_id(void);
+
 		bool start_thread(WorkerThread *pWorkerThread, bool inBackground = false);
 
 		unsigned int get_threads_count(void);
@@ -136,13 +138,13 @@
 		bool pop_queue(const std::string &urlWasIndexed = "");
 
 	protected:
+		static unsigned int m_nextThreadId;
 		sigc::connection m_threadsEndConnection;
 		pthread_rwlock_t m_threadsLock;
 		pthread_rwlock_t m_listsLock;
 		std::map<unsigned int, WorkerThread *> m_threads;
 		std::string m_defaultIndexLocation;
 		unsigned int m_maxIndexThreads;
-		unsigned int m_nextThreadId;
 		unsigned int m_backgroundThreadsCount;
 		unsigned int m_foregroundThreadsMaxTime;
 		long m_numCPUs;

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2008-12-01 13:01:09 UTC (rev 1425)
+++ trunk/UI/GTK2/src/mainWindow.cc	2008-12-01 13:16:35 UTC (rev 1426)
@@ -16,6 +16,9 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <fcntl.h>
 #include <stdlib.h>
 #include <errno.h>
 #include <time.h>
@@ -1567,7 +1570,16 @@
 				(dataLength > 0))
 			{
 				char inTemplate[21] = "/tmp/pinottempXXXXXX";
+#ifdef HAVE_MKSTEMP
 				int inFd = mkstemp(inTemplate);
+#else
+				int inFd = -1;
+				char *pInFile = mktemp(inTemplate);
+				if (pInFile != NULL)
+				{
+					inFd = open(pInFile, O_RDONLY);
+				}
+#endif
 				bool viewDoc = false;
 
 				if (inFd != -1)



From fabricecolin at mail.berlios.de  Mon Dec  1 14:51:40 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 1 Dec 2008 14:51:40 +0100
Subject: [Pinot-svn] r1427 - in trunk: Collect Utils
Message-ID: <200812011351.mB1DpeGL015306@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-01 14:51:32 +0100 (Mon, 01 Dec 2008)
New Revision: 1427

Modified:
   trunk/Collect/DownloaderInterface.cpp
   trunk/Utils/DocumentInfo.cpp
   trunk/Utils/Timer.cpp
   trunk/Utils/Timer.h
Log:
More portability fixes.


Modified: trunk/Collect/DownloaderInterface.cpp
===================================================================
--- trunk/Collect/DownloaderInterface.cpp	2008-12-01 13:16:35 UTC (rev 1426)
+++ trunk/Collect/DownloaderInterface.cpp	2008-12-01 13:51:32 UTC (rev 1427)
@@ -16,6 +16,9 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#ifdef __MINGW32__
+#include <windows.h>
+#endif
 #include <stdlib.h>
 #include <pthread.h>
 #include <iostream>
@@ -61,7 +64,11 @@
 
 static unsigned long idCallback(void)
 {
+#ifdef __MINGW32__
+	return (unsigned long)GetCurrentThreadId();
+#else
 	return (unsigned long)pthread_self();
+#endif
 }
 #endif
 

Modified: trunk/Utils/DocumentInfo.cpp
===================================================================
--- trunk/Utils/DocumentInfo.cpp	2008-12-01 13:16:35 UTC (rev 1426)
+++ trunk/Utils/DocumentInfo.cpp	2008-12-01 13:51:32 UTC (rev 1427)
@@ -17,6 +17,7 @@
  */
 
 #include <stdlib.h>
+#include <time.h>
 #include <algorithm>
 
 #include "StringManip.h"

Modified: trunk/Utils/Timer.cpp
===================================================================
--- trunk/Utils/Timer.cpp	2008-12-01 13:16:35 UTC (rev 1426)
+++ trunk/Utils/Timer.cpp	2008-12-01 13:51:32 UTC (rev 1427)
@@ -53,11 +53,9 @@
 }
 
 /// Stops the timer and returns the number of milliseconds elapsed.
-suseconds_t Timer::stop(void)
+long Timer::stop(void)
 {
 	gettimeofday(&m_stop, NULL);
 
-	suseconds_t timeDiff = (((m_stop.tv_sec - m_start.tv_sec) * 1000) + ((m_stop.tv_usec - m_start.tv_usec) / 1000));
-
-	return timeDiff;
+	return (long)(((m_stop.tv_sec - m_start.tv_sec) * 1000) + ((m_stop.tv_usec - m_start.tv_usec) / 1000));
 }

Modified: trunk/Utils/Timer.h
===================================================================
--- trunk/Utils/Timer.h	2008-12-01 13:16:35 UTC (rev 1426)
+++ trunk/Utils/Timer.h	2008-12-01 13:51:32 UTC (rev 1427)
@@ -38,7 +38,7 @@
 		void start(void);
 
 		/// Stops the timer and returns the number of milliseconds elapsed.
-		suseconds_t stop(void);
+		long stop(void);
 
 	protected:
 		struct timeval m_start;



From fabricecolin at mail.berlios.de  Tue Dec  2 16:54:57 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Tue, 2 Dec 2008 16:54:57 +0100
Subject: [Pinot-svn] r1428 - in trunk: . IndexSearch/Xapian SQL
Message-ID: <200812021554.mB2FsvRS006285@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-02 16:54:50 +0100 (Tue, 02 Dec 2008)
New Revision: 1428

Modified:
   trunk/IndexSearch/Xapian/XapianDatabase.cpp
   trunk/SQL/QueryHistory.cpp
   trunk/configure.in
Log:
Header fixes.
Do without regex.h in XapianDatabase if not available.
In configure.in, libcrypt should no longer be required.


Modified: trunk/IndexSearch/Xapian/XapianDatabase.cpp
===================================================================
--- trunk/IndexSearch/Xapian/XapianDatabase.cpp	2008-12-01 13:51:32 UTC (rev 1427)
+++ trunk/IndexSearch/Xapian/XapianDatabase.cpp	2008-12-02 15:54:50 UTC (rev 1428)
@@ -16,6 +16,7 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include "config.h"
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <fcntl.h>
@@ -23,7 +24,9 @@
 #include <stdlib.h>
 #include <string.h>
 #include <strings.h>
+#ifdef HAVE_REGEX_H
 #include <regex.h>
+#endif
 #include <stdio.h>
 #include <sstream>
 #include <iostream>
@@ -272,8 +275,12 @@
 			<< " doesn't exist" << endl;
 #endif
 
-		// Database directory doesn't exist, create it (mode 755)
-		if (mkdir(m_databaseName.c_str(), (mode_t)S_IRUSR|S_IWUSR|S_IXUSR|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH) != 0)
+		// Database directory doesn't exist, create it
+#ifdef WIN32
+		if (mkdir(m_databaseName.c_str()) != 0)
+#else
+		if (mkdir(m_databaseName.c_str(), (mode_t)(S_IRUSR|S_IWUSR|S_IXUSR|S_IRGRP|S_IXGRP|S_IROTH|S_IXOTH)) != 0)
+#endif
 		{
 			cerr << "XapianDatabase::openDatabase: couldn't create database directory "
 				<< m_databaseName << endl;
@@ -507,9 +514,10 @@
 
 bool XapianDatabase::badRecordField(const string &field)
 {
+	bool isBadField = false;
+#ifdef HAVE_REGEX_H
 	regex_t fieldRegex;
 	regmatch_t pFieldMatches[1];
-	bool isBadField = false;
 
 	// A bad field is one that includes one of our field delimiters
 	if (regcomp(&fieldRegex,
@@ -523,6 +531,19 @@
 		}
 	}
 	regfree(&fieldRegex);
+#else
+	// A bad field is one that includes one of our field delimiters
+	if ((field.find("url") != string::npos) ||
+		(field.find("sample") != string::npos) ||
+		(field.find("caption") != string::npos) ||
+		(field.find("type") != string::npos) ||
+		(field.find("modtime") != string::npos) ||
+		(field.find("language") != string::npos) ||
+		(field.find("size") != string::npos))
+	{
+		isBadField = true;
+	}
+#endif
 
 	return isBadField;
 }

Modified: trunk/SQL/QueryHistory.cpp
===================================================================
--- trunk/SQL/QueryHistory.cpp	2008-12-01 13:51:32 UTC (rev 1427)
+++ trunk/SQL/QueryHistory.cpp	2008-12-02 15:54:50 UTC (rev 1428)
@@ -18,9 +18,10 @@
 
 #include <sys/types.h>
 #include <sys/stat.h>
+#include <stdlib.h>
 #include <unistd.h>
+#include <time.h>
 #include <iostream>
-#include <cstdlib>
 
 #include "TimeConverter.h"
 #include "Url.h"

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2008-12-01 13:51:32 UTC (rev 1427)
+++ trunk/configure.in	2008-12-02 15:54:50 UTC (rev 1428)
@@ -351,10 +351,10 @@
 
 dnl Other libraries
 MISC_CFLAGS="$PTHREAD_CFLAGS $VISIB_CFLAGS"
-MISC_LIBS="-lcrypt $PTHREAD_LIBS"
+MISC_LIBS="$PTHREAD_LIBS"
 AC_SUBST(MISC_CFLAGS)
 AC_SUBST(MISC_LIBS)
-AC_CHECK_HEADERS([sys/vfs.h sys/statfs.h sys/mount.h sys/statvfs.h dlfcn.h])
+AC_CHECK_HEADERS([sys/vfs.h sys/statfs.h sys/mount.h sys/statvfs.h dlfcn.h regex.h])
 PKG_CHECK_MODULES(MIMEINFO, shared-mime-info )
 SHARED_MIME_INFO_PREFIX=`pkg-config --variable=prefix shared-mime-info`
 AC_SUBST(SHARED_MIME_INFO_PREFIX)



From fabricecolin at mail.berlios.de  Wed Dec  3 16:10:44 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Wed, 3 Dec 2008 16:10:44 +0100
Subject: [Pinot-svn] r1429 - in trunk: . Collect UI/GTK2/src
Message-ID: <200812031510.mB3FAigS013408@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-03 16:10:26 +0100 (Wed, 03 Dec 2008)
New Revision: 1429

Modified:
   trunk/Collect/DownloaderInterface.cpp
   trunk/UI/GTK2/src/DaemonState.cpp
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/ServerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/statisticsDialog.cc
   trunk/configure.in
Log:
In DownloaderInterface, GetCurrentThreadId() is specific to Windows, not to
MingW.
Check for fnmatch.h, pwd.h, sigaction(), sysconf(), getloadavg() and pipe().


Modified: trunk/Collect/DownloaderInterface.cpp
===================================================================
--- trunk/Collect/DownloaderInterface.cpp	2008-12-02 15:54:50 UTC (rev 1428)
+++ trunk/Collect/DownloaderInterface.cpp	2008-12-03 15:10:26 UTC (rev 1429)
@@ -16,7 +16,7 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-#ifdef __MINGW32__
+#ifdef WIN32
 #include <windows.h>
 #endif
 #include <stdlib.h>
@@ -64,7 +64,7 @@
 
 static unsigned long idCallback(void)
 {
-#ifdef __MINGW32__
+#ifdef WIN32
 	return (unsigned long)GetCurrentThreadId();
 #else
 	return (unsigned long)pthread_self();

Modified: trunk/UI/GTK2/src/DaemonState.cpp
===================================================================
--- trunk/UI/GTK2/src/DaemonState.cpp	2008-12-02 15:54:50 UTC (rev 1428)
+++ trunk/UI/GTK2/src/DaemonState.cpp	2008-12-03 15:10:26 UTC (rev 1429)
@@ -651,7 +651,7 @@
 			CrawlHistory crawlHistory(PinotSettings::getInstance().getHistoryDatabaseName());
 
 			// An entry should already exist for this
-			crawlHistory.updateItem(indexedUrl, CrawlHistory::ERROR, time(NULL), errorNum);
+			crawlHistory.updateItem(indexedUrl, CrawlHistory::CRAWL_ERROR, time(NULL), errorNum);
 		}
 	}
 	else if (type == "UnindexingThread")

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2008-12-02 15:54:50 UTC (rev 1428)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2008-12-03 15:10:26 UTC (rev 1429)
@@ -16,6 +16,7 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include "config.h"
 #include <stdio.h>
 #include <stdlib.h>
 #include <ctype.h>
@@ -24,8 +25,12 @@
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <dirent.h>
+#ifdef HAVE_PWD_H
 #include <pwd.h>
+#endif
+#ifdef HAVE_FNMATCH_H
 #include <fnmatch.h>
+#endif
 #include <algorithm>
 #include <iostream>
 
@@ -35,7 +40,6 @@
 #include <libxml++/nodes/node.h>
 #include <libxml++/nodes/textnode.h>
 
-#include "config.h"
 #include "NLS.h"
 #include "CommandLine.h"
 #include "Languages.h"
@@ -120,7 +124,11 @@
 	if (stat(directoryName.c_str(), &fileStat) != 0)
 	{
 		// No, create it then
+#ifdef WIN32
+		if (mkdir(directoryName.c_str()) == 0)
+#else
 		if (mkdir(directoryName.c_str(), (mode_t)S_IRUSR|S_IWUSR|S_IXUSR|S_IRGRP|S_IWGRP|S_IXGRP|S_IROTH|S_IXOTH) == 0)
+#endif
 		{
 			cerr << "Created directory " << directoryName << endl;
 			m_firstRun = true;
@@ -167,6 +175,7 @@
 
 string PinotSettings::getHomeDirectory(void)
 {
+#ifdef HAVE_PWD_H
 	struct passwd *pPasswd = getpwuid(geteuid());
 
 	if ((pPasswd != NULL) &&
@@ -176,14 +185,17 @@
 	}
 	else
 	{
+#endif
 		char *homeDir = getenv("HOME");
 		if (homeDir != NULL)
 		{
 			return homeDir;
 		}
+#ifdef HAVE_PWD_H
 	}
 
 	return "~";
+#endif
 }
 
 string PinotSettings::getConfigurationDirectory(void)
@@ -217,6 +229,7 @@
 
 string PinotSettings::getCurrentUserName(void)
 {
+#ifdef HAVE_PWD_H
 	struct passwd *pPasswd = getpwuid(geteuid());
 
 	if ((pPasswd != NULL) &&
@@ -224,6 +237,7 @@
 	{
 		return pPasswd->pw_name;
 	}
+#endif
 
 	return "";
 }
@@ -406,6 +420,7 @@
 		m_isBlackList = getDefaultPatterns(m_filePatternsList);
 
 		// Create default queries
+#ifdef HAVE_PWD_H
 		struct passwd *pPasswd = getpwuid(geteuid());
 		if (pPasswd != NULL)
 		{
@@ -429,6 +444,7 @@
 				addQuery(queryProps);
 			}
 		}
+#endif
 
 		QueryProperties queryProps(_("Latest First"), "dir:/");
 		queryProps.setSortOrder(QueryProperties::DATE);
@@ -1971,6 +1987,7 @@
 		return true;
 	}
 
+#ifdef HAVE_FNMATCH_H
 	// Any pattern matches this file name ?
 	for (set<ustring>::iterator patternIter = m_filePatternsList.begin(); patternIter != m_filePatternsList.end() ; ++patternIter)
 	{
@@ -1983,6 +2000,7 @@
 			return m_isBlackList;
 		}
 	}
+#endif
 
 	return !m_isBlackList;
 }

Modified: trunk/UI/GTK2/src/ServerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.cpp	2008-12-02 15:54:50 UTC (rev 1428)
+++ trunk/UI/GTK2/src/ServerThreads.cpp	2008-12-03 15:10:26 UTC (rev 1429)
@@ -492,11 +492,11 @@
 		// Record this error
 		if (itemExists == false)
 		{
-			crawlHistory.insertItem(location, CrawlHistory::ERROR, m_sourceId, timeNow, entryStatus);
+			crawlHistory.insertItem(location, CrawlHistory::CRAWL_ERROR, m_sourceId, timeNow, entryStatus);
 		}
 		else
 		{
-			crawlHistory.updateItem(location, CrawlHistory::ERROR, timeNow, entryStatus);
+			crawlHistory.updateItem(location, CrawlHistory::CRAWL_ERROR, timeNow, entryStatus);
 		}
 	}
 
@@ -526,7 +526,7 @@
 			m_sourceId);
 	}
 	// Remove errors
-	crawlHistory.deleteItems(m_sourceId, CrawlHistory::ERROR);
+	crawlHistory.deleteItems(m_sourceId, CrawlHistory::CRAWL_ERROR);
 
 	if (scanEntry(m_dirName, crawlHistory) == false)
 	{

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2008-12-02 15:54:50 UTC (rev 1428)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2008-12-03 15:10:26 UTC (rev 1429)
@@ -226,7 +226,7 @@
 void WorkerThread::threadHandler(void)
 {
 #ifdef DEBUG
-	cout << "WorkerThread::threadHandler: thread " << m_id << " " << pthread_self() << endl;
+	cout << "WorkerThread::threadHandler: thread " << m_id << endl;
 #endif
 	try
 	{
@@ -281,7 +281,9 @@
 	pthread_rwlock_init(&m_threadsLock, NULL);
 	pthread_rwlock_init(&m_listsLock, NULL);
 
+#ifdef HAVE_SYSCONF
 	m_numCPUs = sysconf(_SC_NPROCESSORS_ONLN);
+#endif
 }
 
 ThreadsManager::~ThreadsManager()
@@ -633,7 +635,6 @@
 
 ustring ThreadsManager::queue_index(const DocumentInfo &docInfo)
 {
-	double averageLoad[3];
 	bool addToQueue = false;
 
 	if (get_threads_count() >= m_maxIndexThreads)
@@ -643,16 +644,23 @@
 #endif
 		addToQueue = true;
 	}
+#ifdef HAVE_GETLOADAVG
 	// Get the load averaged over the last minute
-	else if (getloadavg(averageLoad, 3) != -1)
+	else
 	{
-		// FIXME: is LOADAVG_1MIN Solaris specific ?
-		if (averageLoad[0] >= (double)m_numCPUs * 4)
+		double averageLoad[3];
+
+		if (getloadavg(averageLoad, 3) != -1)
 		{
-			// Don't add to the load, queue this
-			addToQueue = true;
+			// FIXME: is LOADAVG_1MIN Solaris specific ?
+			if (averageLoad[0] >= (double)m_numCPUs * 4)
+			{
+				// Don't add to the load, queue this
+				addToQueue = true;
+			}
 		}
 	}
+#endif
 
 	if (addToQueue == true)
 	{
@@ -1986,18 +1994,26 @@
 {
 	int pipeFds[2];
 
+#ifdef HAVE_PIPE
 	if (pipe(pipeFds) == 0)
 	{
 		// This pipe will allow to stop select()
 		m_ctrlReadPipe = pipeFds[0];
 		m_ctrlWritePipe = pipeFds[1];
 	}
+#endif
 }
 
 MonitorThread::~MonitorThread()
 {
-	close(m_ctrlReadPipe);
-	close(m_ctrlWritePipe);
+	if (m_ctrlReadPipe >= 0)
+	{
+		close(m_ctrlReadPipe);
+	}
+	if (m_ctrlWritePipe >= 0)
+	{
+		close(m_ctrlWritePipe);
+	}
 }
 
 string MonitorThread::getType(void) const
@@ -2008,7 +2024,10 @@
 void MonitorThread::stop(void)
 {
 	WorkerThread::stop();
-	write(m_ctrlWritePipe, "X", 1);
+	if (m_ctrlWritePipe >= 0)
+	{
+		write(m_ctrlWritePipe, "X", 1);
+	}
 }
 
 void MonitorThread::processEvents(void)

Modified: trunk/UI/GTK2/src/statisticsDialog.cc
===================================================================
--- trunk/UI/GTK2/src/statisticsDialog.cc	2008-12-02 15:54:50 UTC (rev 1428)
+++ trunk/UI/GTK2/src/statisticsDialog.cc	2008-12-03 15:10:26 UTC (rev 1429)
@@ -364,7 +364,7 @@
 
 		// Did any error occur on this source ?
 		unsigned int errorCount = crawlHistory.getSourceItems(sourceNum,
-			CrawlHistory::ERROR, errors, currentOffset, currentOffset + 100,
+			CrawlHistory::CRAWL_ERROR, errors, currentOffset, currentOffset + 100,
 			latestErrorDate);
 		while ((errorCount > 0) &&
 			(errors.empty() == false))
@@ -427,7 +427,7 @@
 			}
 			currentOffset += 100;
 			errorCount = crawlHistory.getSourceItems(sourceNum,
-				CrawlHistory::ERROR, errors, currentOffset, currentOffset + 100,
+				CrawlHistory::CRAWL_ERROR, errors, currentOffset, 100, // currentOffset + 100,
 				latestErrorDate);
 		}
 

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2008-12-02 15:54:50 UTC (rev 1428)
+++ trunk/configure.in	2008-12-03 15:10:26 UTC (rev 1429)
@@ -354,7 +354,7 @@
 MISC_LIBS="$PTHREAD_LIBS"
 AC_SUBST(MISC_CFLAGS)
 AC_SUBST(MISC_LIBS)
-AC_CHECK_HEADERS([sys/vfs.h sys/statfs.h sys/mount.h sys/statvfs.h dlfcn.h regex.h])
+AC_CHECK_HEADERS([sys/vfs.h sys/statfs.h sys/mount.h sys/statvfs.h dlfcn.h regex.h fnmatch.h pwd.h])
 PKG_CHECK_MODULES(MIMEINFO, shared-mime-info )
 SHARED_MIME_INFO_PREFIX=`pkg-config --variable=prefix shared-mime-info`
 AC_SUBST(SHARED_MIME_INFO_PREFIX)
@@ -425,6 +425,10 @@
 AC_CHECK_FUNCS(statfs)
 AC_CHECK_FUNCS(sysctlbyname)
 AC_CHECK_FUNCS(mkstemp)
+AC_CHECK_FUNCS(sigaction)
+AC_CHECK_FUNCS(sysconf)
+AC_CHECK_FUNCS(getloadavg)
+AC_CHECK_FUNCS(pipe)
 
 AC_OUTPUT( pinot.spec UI/GTK2/src/de.berlios.Pinot.service Makefile \
 	Utils/Makefile Tokenize/Makefile SQL/Makefile po/Makefile.in Collect/Makefile \



From fabricecolin at mail.berlios.de  Wed Dec  3 16:11:22 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Wed, 3 Dec 2008 16:11:22 +0100
Subject: [Pinot-svn] r1430 - trunk/SQL
Message-ID: <200812031511.mB3FBMS5013484@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-03 16:11:16 +0100 (Wed, 03 Dec 2008)
New Revision: 1430

Modified:
   trunk/SQL/CrawlHistory.cpp
   trunk/SQL/CrawlHistory.h
Log:
Renamed CrawlHistory::ERROR to CRAWL_ERROR.


Modified: trunk/SQL/CrawlHistory.cpp
===================================================================
--- trunk/SQL/CrawlHistory.cpp	2008-12-03 15:10:26 UTC (rev 1429)
+++ trunk/SQL/CrawlHistory.cpp	2008-12-03 15:11:16 UTC (rev 1430)
@@ -55,7 +55,7 @@
 		case CRAWLED:
 			text = "CRAWLED";
 			break;
-		case ERROR:
+		case CRAWL_ERROR:
 			text = "ERROR";
 			break;
 		default:
@@ -79,7 +79,7 @@
 	}
 	else if (text == "ERROR")
 	{
-		status = ERROR;
+		status = CRAWL_ERROR;
 	}
 
 	return status;

Modified: trunk/SQL/CrawlHistory.h
===================================================================
--- trunk/SQL/CrawlHistory.h	2008-12-03 15:10:26 UTC (rev 1429)
+++ trunk/SQL/CrawlHistory.h	2008-12-03 15:11:16 UTC (rev 1430)
@@ -33,7 +33,7 @@
 		CrawlHistory(const std::string &database);
 		virtual ~CrawlHistory();
 
-		typedef enum { UNKNOWN, CRAWLING, CRAWLED, ERROR } CrawlStatus;
+		typedef enum { UNKNOWN, CRAWLING, CRAWLED, CRAWL_ERROR } CrawlStatus;
 
 		/// Creates the CrawlHistory table in the database.
 		static bool create(const std::string &database);



From fabricecolin at mail.berlios.de  Wed Dec  3 16:14:09 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Wed, 3 Dec 2008 16:14:09 +0100
Subject: [Pinot-svn] r1431 - trunk/UI/GTK2/src
Message-ID: <200812031514.mB3FE9RQ013736@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-03 16:14:02 +0100 (Wed, 03 Dec 2008)
New Revision: 1431

Modified:
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
   trunk/UI/GTK2/src/pinot.cc
Log:
Use signal() if sigaction() isn't available.


Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2008-12-03 15:11:16 UTC (rev 1430)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2008-12-03 15:14:02 UTC (rev 1431)
@@ -271,7 +271,6 @@
 
 int main(int argc, char **argv)
 {
-	struct sigaction newAction;
 	int longOptionIndex = 0, priority = 15;
 	bool resetHistory = false;
 	bool resetLabels = false;
@@ -462,12 +461,21 @@
 	settings.load(PinotSettings::LOAD_ALL);
 
 	// Catch interrupts
+#ifdef HAVE_SIGACTION
+	struct sigaction newAction;
 	sigemptyset(&newAction.sa_mask);
 	newAction.sa_flags = 0;
 	newAction.sa_handler = quitAll;
 	sigaction(SIGINT, &newAction, NULL);
 	sigaction(SIGQUIT, &newAction, NULL);
 	sigaction(SIGTERM, &newAction, NULL);
+#else
+	signal(SIGINT, quitAll);
+#ifdef SIGQUIT
+	signal(SIGQUIT, quitAll);
+#endif
+	signal(SIGTERM, quitAll);
+#endif
 
 	// Open the daemon index in read-write mode 
 	bool wasObsoleteFormat = false;

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2008-12-03 15:11:16 UTC (rev 1430)
+++ trunk/UI/GTK2/src/pinot.cc	2008-12-03 15:14:02 UTC (rev 1431)
@@ -101,7 +101,6 @@
 {
 	string prefixDir(PREFIX);
 	Glib::ustring errorMsg;
-	struct sigaction newAction;
 	int longOptionIndex = 0;
 	bool warnAboutVersion = false, prefsMode = false;
 
@@ -274,12 +273,21 @@
 	settings.load(PinotSettings::LOAD_ALL);
 
 	// Catch interrupts
+#ifdef HAVE_SIGACTION
+	struct sigaction newAction;
 	sigemptyset(&newAction.sa_mask);
 	newAction.sa_flags = 0;
 	newAction.sa_handler = quitAll;
 	sigaction(SIGINT, &newAction, NULL);
 	sigaction(SIGQUIT, &newAction, NULL);
 	sigaction(SIGTERM, &newAction, NULL);
+#else
+	signal(SIGINT, quitAll);
+#ifdef SIGQUIT
+	signal(SIGQUIT, quitAll);
+#endif
+	signal(SIGTERM, quitAll);
+#endif
 
 	// Open this index read-write, unless we are in preferences mode
 	bool wasObsoleteFormat = false;



From fabricecolin at mail.berlios.de  Thu Dec  4 15:40:26 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Thu, 4 Dec 2008 15:40:26 +0100
Subject: [Pinot-svn] r1432 - in trunk: . IndexSearch UI/GTK2/src
Message-ID: <200812041440.mB4EeQ4F032548@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-04 15:40:17 +0100 (Thu, 04 Dec 2008)
New Revision: 1432

Modified:
   trunk/IndexSearch/Makefile.am
   trunk/UI/GTK2/src/Makefile.am
   trunk/configure.in
Log:
Allow disabling DBus support. This will turn off building of libIndex.a,
pinot-label and pinot-dbus-daemon.


Modified: trunk/IndexSearch/Makefile.am
===================================================================
--- trunk/IndexSearch/Makefile.am	2008-12-03 15:14:02 UTC (rev 1431)
+++ trunk/IndexSearch/Makefile.am	2008-12-04 14:40:17 UTC (rev 1432)
@@ -17,13 +17,16 @@
 	WebEngine.h \
 	XesamLog.h
 
+if HAVE_DBUS
 noinst_LTLIBRARIES = libIndex.la libIndexSearch.la
+else
+noinst_LTLIBRARIES = libIndexSearch.la
+endif
 
 libIndex_la_SOURCES = \
 	DBusIndex.cpp
 
 libIndexSearch_la_SOURCES = \
-	DBusIndex.cpp \
 	FilterWrapper.cpp \
 	ModuleFactory.cpp \
 	OpenSearchParser.cpp \
@@ -34,11 +37,19 @@
 	SearchPluginProperties.cpp \
 	WebEngine.cpp
 
+if HAVE_DBUS
+libIndexSearch_la_SOURCES += DBusIndex.cpp
+endif
+
 if HAVE_BOOST_SPIRIT
 libIndexSearch_la_SOURCES += SherlockParser.cpp
 endif
 
+if HAVE_DBUS
 bin_PROGRAMS = pinot-index pinot-label pinot-search
+else
+bin_PROGRAMS = pinot-index pinot-search
+endif
 
 pinot_index_LDFLAGS = \
 	-rdynamic
@@ -98,6 +109,10 @@
 	@HTTP_CFLAGS@ @XML_CFLAGS@ @DBUS_CFLAGS@ \
 	@INDEX_CFLAGS@ @GLIBMM_CFLAGS@
 
+if HAVE_DBUS
+AM_CXXFLAGS += -DHAVE_DBUS
+endif
+
 if HAVE_BOOST_SPIRIT
 AM_CXXFLAGS += -DHAVE_BOOST_SPIRIT
 endif

Modified: trunk/UI/GTK2/src/Makefile.am
===================================================================
--- trunk/UI/GTK2/src/Makefile.am	2008-12-03 15:14:02 UTC (rev 1431)
+++ trunk/UI/GTK2/src/Makefile.am	2008-12-04 14:40:17 UTC (rev 1432)
@@ -66,7 +66,11 @@
 	UniqueApplication.cpp \
 	WorkerThreads.cpp
 
+if HAVE_DBUS
 bin_PROGRAMS = pinot pinot-dbus-daemon
+else
+bin_PROGRAMS = pinot
+endif
 
 AM_CXXFLAGS = \
 	@MISC_CFLAGS@ \
@@ -80,6 +84,10 @@
 	@SQL_CFLAGS@ @HTTP_CFLAGS@ @XML_CFLAGS@ @DBUS_CFLAGS@ \
 	@INDEX_CFLAGS@ @GTHREAD_CFLAGS@ @GTKMM_CFLAGS@
 
+if HAVE_DBUS
+AM_CXXFLAGS += -DHAVE_DBUS
+endif
+
 pinot_LDFLAGS = \
 	-rdynamic
 

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2008-12-03 15:14:02 UTC (rev 1431)
+++ trunk/configure.in	2008-12-04 14:40:17 UTC (rev 1432)
@@ -139,6 +139,27 @@
 AC_SUBST(XESAMGLIB_CFLAGS)
 AC_SUBST(XESAMGLIB_LIBS)
 
+dnl DBus
+AC_MSG_CHECKING(whether to enable DBus support)
+AC_ARG_ENABLE(dbus,
+   [AS_HELP_STRING([--enable-dbus], [enable DBus support [default=yes]])],
+   ,[enable_dbus=yes])
+if test "x$enable_dbus" != "xyes"; then
+   DBUS_CFLAGS=""
+   DBUS_LIBS=""
+   enable_dbus=no
+fi
+AC_MSG_RESULT($enable_dbus)
+AM_CONDITIONAL(HAVE_DBUS, false)
+if test "x$enable_dbus" = "xyes"; then
+   PKG_CHECK_MODULES(DBUS, dbus-glib-1)
+   DBUS_NUM_VERSION=`pkg-config --modversion dbus-1 | $AWK 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
+   AC_DEFINE_UNQUOTED(DBUS_NUM_VERSION,$DBUS_NUM_VERSION, [DBus version number])
+   AM_CONDITIONAL(HAVE_DBUS, true)
+fi
+AC_SUBST(DBUS_CFLAGS)
+AC_SUBST(DBUS_LIBS)
+
 dnl Neon or Curl ?
 AC_MSG_CHECKING(which HTTP library to use)
 AC_ARG_WITH(http,
@@ -224,12 +245,6 @@
    exit 1
 fi
 
-dnl xattrs
-AM_CONDITIONAL(HAVE_ATTR_XATTR, false)
-AC_CHECK_HEADERS([attr/xattr.h],
-   [AM_CONDITIONAL(HAVE_ATTR_XATTR, true)
-   ])
-
 dnl inotify
 AM_CONDITIONAL(HAVE_LINUX_INOTIFY, false)
 AC_CHECK_HEADERS([sys/inotify.h],
@@ -354,7 +369,7 @@
 MISC_LIBS="$PTHREAD_LIBS"
 AC_SUBST(MISC_CFLAGS)
 AC_SUBST(MISC_LIBS)
-AC_CHECK_HEADERS([sys/vfs.h sys/statfs.h sys/mount.h sys/statvfs.h dlfcn.h regex.h fnmatch.h pwd.h])
+AC_CHECK_HEADERS([sys/vfs.h sys/statfs.h sys/mount.h sys/statvfs.h attr/xattr.h dlfcn.h regex.h fnmatch.h pwd.h])
 PKG_CHECK_MODULES(MIMEINFO, shared-mime-info )
 SHARED_MIME_INFO_PREFIX=`pkg-config --variable=prefix shared-mime-info`
 AC_SUBST(SHARED_MIME_INFO_PREFIX)
@@ -383,12 +398,6 @@
 INDEX_LIBS="$XAPIAN_LIBS -ltextcat"
 AC_SUBST(INDEX_CFLAGS)
 AC_SUBST(INDEX_LIBS)
-PKG_CHECK_MODULES(DBUS, dbus-glib-1)
-AC_SUBST(DBUS_CFLAGS)
-AC_SUBST(DBUS_LIBS)
-DBUS_NUM_VERSION=`pkg-config --modversion dbus-1 | $AWK 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
-AC_DEFINE_UNQUOTED(DBUS_NUM_VERSION,$DBUS_NUM_VERSION,
-    [DBus version number])
 PKG_CHECK_MODULES(SIGCPP, sigc++-2.0 >= 2.0 )
 AC_SUBST(SIGCPP_CFLAGS)
 AC_SUBST(SIGCPP_LIBS)



From fabricecolin at mail.berlios.de  Thu Dec  4 15:43:10 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Thu, 4 Dec 2008 15:43:10 +0100
Subject: [Pinot-svn] r1433 - in trunk: IndexSearch UI/GTK2/src
Message-ID: <200812041443.mB4EhAeJ032733@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-04 15:42:57 +0100 (Thu, 04 Dec 2008)
New Revision: 1433

Modified:
   trunk/IndexSearch/ModuleFactory.cpp
   trunk/UI/GTK2/src/DaemonState.cpp
   trunk/UI/GTK2/src/DaemonState.h
   trunk/UI/GTK2/src/ServerThreads.cpp
   trunk/UI/GTK2/src/ServerThreads.h
   trunk/UI/GTK2/src/pinot.cc
   trunk/UI/GTK2/src/prefsWindow.cc
   trunk/UI/GTK2/src/statisticsDialog.cc
Log:
Wrap all DBus specific code with HAVE_DBUS ifdef's.


Modified: trunk/IndexSearch/ModuleFactory.cpp
===================================================================
--- trunk/IndexSearch/ModuleFactory.cpp	2008-12-04 14:40:17 UTC (rev 1432)
+++ trunk/IndexSearch/ModuleFactory.cpp	2008-12-04 14:42:57 UTC (rev 1433)
@@ -27,7 +27,9 @@
 #include <utility>
 #include <iostream>
 
+#ifdef HAVE_DBUS
 #include "DBusIndex.h"
+#endif
 #include "PluginWebEngine.h"
 #include "ModuleFactory.h"
 
@@ -369,7 +371,11 @@
 		pIndex = getLibraryIndex(type.substr(5), option);
 		if (pIndex != NULL)
 		{
+#ifdef HAVE_DBUS
 			return new DBusIndex(pIndex);
+#else
+			return pIndex;
+#endif
 		}
 
 		return NULL;

Modified: trunk/UI/GTK2/src/DaemonState.cpp
===================================================================
--- trunk/UI/GTK2/src/DaemonState.cpp	2008-12-04 14:40:17 UTC (rev 1432)
+++ trunk/UI/GTK2/src/DaemonState.cpp	2008-12-04 14:42:57 UTC (rev 1433)
@@ -60,7 +60,9 @@
 #include "Url.h"
 #include "MonitorFactory.h"
 #include "CrawlHistory.h"
+#ifdef HAVE_DBUS
 #include "DBusIndex.h"
+#endif
 #include "DaemonState.h"
 #include "OnDiskHandler.h"
 #include "PinotSettings.h"
@@ -126,6 +128,7 @@
 	}
 };
 
+#ifdef HAVE_DBUS
 DBusServletInfo::DBusServletInfo(DBusConnection *pConnection, DBusMessage *pRequest) :
 	m_pConnection(pConnection),
 	m_pRequest(pRequest),
@@ -301,6 +304,7 @@
 
 	return false;
 }
+#endif
 
 DaemonState::DaemonState() :
 	ThreadsManager(PinotSettings::getInstance().m_daemonIndexLocation, 10),
@@ -662,6 +666,7 @@
 	{
 		// FIXME: do something about this
 	}
+#ifdef HAVE_DBUS
 	else if (type == "DBusServletThread")
 	{
 		DBusServletThread *pDBusThread = dynamic_cast<DBusServletThread *>(pThread);
@@ -700,6 +705,7 @@
 			m_signalQuit(0);
 		}
 	}
+#endif
 	else if (type == "QueryingThread")
 	{
 		QueryingThread *pQueryThread = dynamic_cast<QueryingThread *>(pThread);
@@ -713,6 +719,7 @@
 		QueryProperties queryProps(pQueryThread->getQuery(wasCorrected));
 		const vector<DocumentInfo> &resultsList = pQueryThread->getDocuments();
 
+#ifdef HAVE_DBUS
 		// Find the servlet info
 		for (set<DBusServletInfo *>::const_iterator servIter = m_servletsInfo.begin();
 			servIter != m_servletsInfo.end(); ++servIter)
@@ -735,6 +742,7 @@
 				break;
 			}
 		}
+#endif
 	}
 
 	// Delete the thread

Modified: trunk/UI/GTK2/src/DaemonState.h
===================================================================
--- trunk/UI/GTK2/src/DaemonState.h	2008-12-04 14:40:17 UTC (rev 1432)
+++ trunk/UI/GTK2/src/DaemonState.h	2008-12-04 14:42:57 UTC (rev 1433)
@@ -16,13 +16,14 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-#ifndef _DBUSERVER_HH
-#define _DBUSERVER_HH
+#ifndef _DAEMONSTATE_HH
+#define _DAEMONSTATE_HH
 
 #include <sys/select.h>
 #include <string>
 #include <queue>
 #include <set>
+#ifdef HAVE_DBUS
 extern "C"
 {
 #if DBUS_VERSION < 1000000
@@ -32,6 +33,7 @@
 #include <dbus/dbus-glib.h>
 #include <dbus/dbus-glib-lowlevel.h>
 }
+#endif
 #include <sigc++/sigc++.h>
 
 #include "MonitorInterface.h"
@@ -39,6 +41,7 @@
 #include "PinotSettings.h"
 #include "WorkerThreads.h"
 
+#ifdef HAVE_DBUS
 class DBusServletInfo
 {
 	public:
@@ -67,6 +70,7 @@
 		bool m_replied;
 
 };
+#endif
 
 class DaemonState : public ThreadsManager
 {
@@ -107,7 +111,9 @@
 		sigc::signal1<void, int> m_signalQuit;
 		unsigned int m_crawlers;
 		std::queue<PinotSettings::IndexableLocation> m_crawlQueue;
+#ifdef HAVE_DBUS
 		std::set<DBusServletInfo *> m_servletsInfo;
+#endif
 
 		bool on_activity_timeout(void);
 
@@ -117,4 +123,4 @@
 
 };
 
-#endif
+#endif // _DAEMONSTATE_HH

Modified: trunk/UI/GTK2/src/ServerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.cpp	2008-12-04 14:40:17 UTC (rev 1432)
+++ trunk/UI/GTK2/src/ServerThreads.cpp	2008-12-04 14:42:57 UTC (rev 1433)
@@ -40,7 +40,9 @@
 #include "Url.h"
 #include "CrawlHistory.h"
 #include "MetaDataBackup.h"
+#ifdef HAVE_DBUS
 #include "DBusIndex.h"
+#endif
 #include "ModuleFactory.h"
 #include "DaemonState.h"
 #include "PinotSettings.h"
@@ -619,6 +621,7 @@
 	}
 }
 
+#ifdef HAVE_DBUS
 DBusServletThread::DBusServletThread(DaemonState *pServer, DBusServletInfo *pInfo) :
 	WorkerThread(),
 	m_pServer(pServer),
@@ -1325,4 +1328,5 @@
 
 	delete pIndex;
 }
+#endif
 

Modified: trunk/UI/GTK2/src/ServerThreads.h
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.h	2008-12-04 14:40:17 UTC (rev 1432)
+++ trunk/UI/GTK2/src/ServerThreads.h	2008-12-04 14:42:57 UTC (rev 1433)
@@ -75,6 +75,7 @@
 
 };
 
+#ifdef HAVE_DBUS
 class DBusServletThread : public WorkerThread
 {
 	public:
@@ -99,5 +100,6 @@
 		DBusServletThread &operator=(const DBusServletThread &other);
 
 };
+#endif
 
 #endif // _SERVERTHREADS_HH

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2008-12-04 14:40:17 UTC (rev 1432)
+++ trunk/UI/GTK2/src/pinot.cc	2008-12-04 14:42:57 UTC (rev 1433)
@@ -30,6 +30,7 @@
 #include <glibmm/miscutils.h>
 #include <glibmm/convert.h>
 #include "config.h"
+#ifdef HAVE_DBUS
 extern "C"
 {
 #if DBUS_NUM_VERSION < 1000000
@@ -39,6 +40,7 @@
 #include <dbus/dbus-glib.h>
 #include <dbus/dbus-glib-lowlevel.h>
 }
+#endif
 #include <gtkmm/main.h>
 
 #include "NLS.h"
@@ -157,10 +159,12 @@
 	}
 	// Initialize the GType and the D-Bus thread system
 	g_type_init();
+#ifdef HAVE_DBUS
 #if DBUS_NUM_VERSION > 1000000
 	dbus_threads_init_default();
 #endif
 	dbus_g_thread_init();
+#endif
 
 	Gtk::Main m(&argc, &argv);
 	if (prefsMode == false)
@@ -213,8 +217,10 @@
 
 	// This will create the necessary directories on the first run
 	PinotSettings &settings = PinotSettings::getInstance();
+#ifdef HAVE_DBUS
 	// Talk to the daemon through DBus
 	settings.enableClientMode(true);
+#endif
 
 	string confDirectory = PinotSettings::getConfigurationDirectory();
 	if (chdir(confDirectory.c_str()) == 0)

Modified: trunk/UI/GTK2/src/prefsWindow.cc
===================================================================
--- trunk/UI/GTK2/src/prefsWindow.cc	2008-12-04 14:40:17 UTC (rev 1432)
+++ trunk/UI/GTK2/src/prefsWindow.cc	2008-12-04 14:42:57 UTC (rev 1433)
@@ -32,7 +32,9 @@
 #include "config.h"
 #include "NLS.h"
 #include "StringManip.h"
+#ifdef HAVE_DBUS
 #include "DBusIndex.h"
+#endif
 #include "ModuleFactory.h"
 #include "PinotUtils.h"
 #include "prefsWindow.hh"
@@ -42,6 +44,7 @@
 using namespace Gdk;
 using namespace Gtk;
 
+#ifdef HAVE_DBUS
 class StartDaemonThread : public WorkerThread
 {
 	public:
@@ -74,6 +77,7 @@
 		StartDaemonThread &operator=(const StartDaemonThread &other);
 
 };
+#endif
 
 class GetLabelsThread : public WorkerThread
 {
@@ -713,6 +717,7 @@
 	save_labelsTreeview();
 	bool startForDirectories = save_directoriesTreeview();
 	bool startForPatterns = save_patternsTreeview();
+#ifdef HAVE_DBUS
 	if ((startForDirectories == true) ||
 		(startForPatterns == true))
 	{
@@ -727,6 +732,7 @@
 			startedThread = true;
 		}
 	}
+#endif
 	if ((m_addedLabels.empty() == false) ||
 		(m_deletedLabels.empty() == false))
 	{

Modified: trunk/UI/GTK2/src/statisticsDialog.cc
===================================================================
--- trunk/UI/GTK2/src/statisticsDialog.cc	2008-12-04 14:40:17 UTC (rev 1432)
+++ trunk/UI/GTK2/src/statisticsDialog.cc	2008-12-04 14:42:57 UTC (rev 1433)
@@ -29,7 +29,9 @@
 #include "Url.h"
 #include "CrawlHistory.h"
 #include "ViewHistory.h"
+#ifdef HAVE_DBUS
 #include "DBusIndex.h"
+#endif
 #include "ModuleFactory.h"
 #include "PinotSettings.h"
 #include "PinotUtils.h"
@@ -39,6 +41,7 @@
 using namespace Glib;
 using namespace Gtk;
 
+#ifdef HAVE_DBUS
 class DaemonStatusThread : public WorkerThread
 {
         public:
@@ -86,6 +89,7 @@
                 DaemonStatusThread &operator=(const DaemonStatusThread &other);
 
 };
+#endif
 
 statisticsDialog::InternalState::InternalState(unsigned int maxIndexThreads, statisticsDialog *pWindow) :
         ThreadsManager(PinotSettings::getInstance().m_docsIndexLocation, maxIndexThreads),
@@ -264,6 +268,7 @@
 		// FIXME: check whether it's actually running !
 		row[m_statsColumns.m_name] = ustring(_("Running under PID")) + " " + countStr;
 
+#ifdef HAVE_DBUS
 		if ((m_state.m_getStats == true) &&
 			(m_state.m_gettingStats == false))
 		{
@@ -275,6 +280,7 @@
 				m_state.m_getStats = false;
 			}
 		}
+#endif
 	}
 	else
 	{
@@ -466,6 +472,7 @@
 
 	// What type of thread was it ?
 	string type = pThread->getType();
+#ifdef HAVE_DBUS
 	if (type == "DaemonStatusThread")
 	{
 		// Did it succeed ?
@@ -485,6 +492,7 @@
 			}
 		}
 	}
+#endif
 
 	// Delete the thread
 	delete pThread;



From fabricecolin at mail.berlios.de  Sat Dec  6 02:23:41 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Sat, 6 Dec 2008 02:23:41 +0100
Subject: [Pinot-svn] r1434 - in trunk: IndexSearch Monitor UI/GTK2/src Utils
Message-ID: <200812060123.mB61NfBf026431@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-06 02:23:28 +0100 (Sat, 06 Dec 2008)
New Revision: 1434

Modified:
   trunk/IndexSearch/DBusIndex.cpp
   trunk/Monitor/INotifyMonitor.h
   trunk/UI/GTK2/src/DaemonState.cpp
   trunk/Utils/DocumentInfo.cpp
   trunk/Utils/TimeConverter.cpp
   trunk/Utils/Url.cpp
Log:
GCC 4.4 patch by Martin Michlmayr (Debian bug #504908).


Modified: trunk/IndexSearch/DBusIndex.cpp
===================================================================
--- trunk/IndexSearch/DBusIndex.cpp	2008-12-04 14:42:57 UTC (rev 1433)
+++ trunk/IndexSearch/DBusIndex.cpp	2008-12-06 01:23:28 UTC (rev 1434)
@@ -16,6 +16,7 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include <stdio.h>
 #include <stdlib.h>
 #include <iostream>
 

Modified: trunk/Monitor/INotifyMonitor.h
===================================================================
--- trunk/Monitor/INotifyMonitor.h	2008-12-04 14:42:57 UTC (rev 1433)
+++ trunk/Monitor/INotifyMonitor.h	2008-12-06 01:23:28 UTC (rev 1434)
@@ -19,6 +19,7 @@
 #ifndef _INOTIFY_MONITOR_H
 #define _INOTIFY_MONITOR_H
 
+#include <stdint.h>
 #include <pthread.h>
 #include <string>
 #include <map>

Modified: trunk/UI/GTK2/src/DaemonState.cpp
===================================================================
--- trunk/UI/GTK2/src/DaemonState.cpp	2008-12-04 14:42:57 UTC (rev 1433)
+++ trunk/UI/GTK2/src/DaemonState.cpp	2008-12-06 01:23:28 UTC (rev 1434)
@@ -22,6 +22,7 @@
 #include <dirent.h>
 #include <sys/stat.h>
 #include <unistd.h>
+#include <stdint.h>
 #include <stdlib.h>
 #ifdef HAVE_STATFS
   #ifdef HAVE_SYS_VFS_H

Modified: trunk/Utils/DocumentInfo.cpp
===================================================================
--- trunk/Utils/DocumentInfo.cpp	2008-12-04 14:42:57 UTC (rev 1433)
+++ trunk/Utils/DocumentInfo.cpp	2008-12-06 01:23:28 UTC (rev 1434)
@@ -16,6 +16,7 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include <stdio.h>
 #include <stdlib.h>
 #include <time.h>
 #include <algorithm>

Modified: trunk/Utils/TimeConverter.cpp
===================================================================
--- trunk/Utils/TimeConverter.cpp	2008-12-04 14:42:57 UTC (rev 1433)
+++ trunk/Utils/TimeConverter.cpp	2008-12-06 01:23:28 UTC (rev 1434)
@@ -17,6 +17,7 @@
  */
 
 #include "config.h"
+#include <stdio.h>
 #include <stdlib.h>
 #ifdef HAVE_TIMEGM
 #ifndef _XOPEN_SOURCE

Modified: trunk/Utils/Url.cpp
===================================================================
--- trunk/Utils/Url.cpp	2008-12-04 14:42:57 UTC (rev 1433)
+++ trunk/Utils/Url.cpp	2008-12-06 01:23:28 UTC (rev 1434)
@@ -1,5 +1,5 @@
 /*
- *  Copyright 2005,2006 Fabrice Colin
+ *  Copyright 2005-2008 Fabrice Colin
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -19,6 +19,8 @@
 #include "StringManip.h"
 #include "Url.h"
 
+#include <stdio.h>
+
 using std::string;
 
 static const int g_rfc2396Encoded[] = {



From fabricecolin at mail.berlios.de  Sun Dec  7 04:07:14 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Sun, 7 Dec 2008 04:07:14 +0100
Subject: [Pinot-svn] r1435 - trunk/UI/GTK2/src
Message-ID: <200812070307.mB737E2Z019522@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-07 04:07:10 +0100 (Sun, 07 Dec 2008)
New Revision: 1435

Modified:
   trunk/UI/GTK2/src/ResultsTree.cpp
Log:
Get an iterator to the extract TextBuffer after clearing it, as the iterator
would otherwise be invalidated and GTK would complain about it.


Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2008-12-06 01:23:28 UTC (rev 1434)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2008-12-07 03:07:10 UTC (rev 1435)
@@ -1,5 +1,5 @@
 /*
- *  Copyright 2005,2006 Fabrice Colin
+ *  Copyright 2005-2008 Fabrice Colin
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -386,7 +386,6 @@
 		if (refBuffer)
 		{
 			ustring extract(findResultsExtract(row));
-			TextBuffer::iterator bufferPos = refBuffer->begin();
 			ustring::size_type textPos = 0, boldPos = extract.find("<b>");
 
 			// Clear the extract
@@ -401,6 +400,8 @@
 			}
 			else
 			{
+				TextBuffer::iterator bufferPos = refBuffer->begin();
+
 				while (boldPos != ustring::npos)
 				{
 					bufferPos = refBuffer->insert(bufferPos, extract.substr(textPos, boldPos - textPos));



From fabricecolin at mail.berlios.de  Sun Dec  7 04:08:00 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Sun, 7 Dec 2008 04:08:00 +0100
Subject: [Pinot-svn] r1436 - trunk/UI/GTK2/src
Message-ID: <200812070308.mB7380Wo019547@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-07 04:07:56 +0100 (Sun, 07 Dec 2008)
New Revision: 1436

Modified:
   trunk/UI/GTK2/src/PinotSettings.cpp
Log:
Another fix for engine channels.
New default query "pinot search".


Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2008-12-07 03:07:10 UTC (rev 1435)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2008-12-07 03:07:56 UTC (rev 1436)
@@ -454,6 +454,7 @@
 		addQuery(QueryProperties(_("Have CJKV"), "tokens:CJKV"));
 		addQuery(QueryProperties(_("In English"), "lang:en"));
 		addQuery(QueryProperties(_("10kb And Smaller"), "0..10240b"));
+		addQuery(QueryProperties("Pinot search", "pinot search"));
 	}
 
 	return true;
@@ -501,7 +502,10 @@
 					}
 					// SearchPluginProperties derives ModuleProperties
 					m_engines.insert(properties);
-					m_engineChannels.insert(pair<string, bool>(properties.m_channel, true));
+					if (m_engineChannels.find(properties.m_channel) == m_engineChannels.end())
+					{
+						m_engineChannels.insert(pair<string, bool>(properties.m_channel, true));
+					}
 
 					// Any editable parameters in this plugin ?
 					for (map<string, string>::const_iterator editableIter = properties.m_editableParameters.begin();



From fabricecolin at mail.berlios.de  Sun Dec  7 06:44:14 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Sun, 7 Dec 2008 06:44:14 +0100
Subject: [Pinot-svn] r1438 - trunk/scripts/bash
Message-ID: <200812070544.mB75iE4T029467@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-07 06:44:07 +0100 (Sun, 07 Dec 2008)
New Revision: 1438

Added:
   trunk/scripts/bash/pinot-cd.sh
Log:
This script implements a "tagged cd". The idea, from C. Scott Ananian, is to
allow changing to a directory based on tags it matches. Tags here are the
components of the path that leads to that directory, and the directory name
itself.
This will only work on an index built with the latest Xapian back-end.


Added: trunk/scripts/bash/pinot-cd.sh
===================================================================
--- trunk/scripts/bash/pinot-cd.sh	2008-12-07 05:39:40 UTC (rev 1437)
+++ trunk/scripts/bash/pinot-cd.sh	2008-12-07 05:44:07 UTC (rev 1438)
@@ -0,0 +1,129 @@
+#!/bin/bash
+# A "tagged cd" implementation
+# Based on an idea by C. Scott Ananian (http://wiki.laptop.org/go/Experiments_with_unordered_paths)
+# Run this script with ". /path/to/pinot-cd.sh"
+
+MISSING_PROGRAM=1
+MISSING_INDEX=1
+FOUND_MATCH=0
+
+# Check programs we need are available
+checkprograms()
+{
+  WHICH_BN=`which basename`
+  if [ $? != 0 ]; then
+    echo "Couldn't find basename. Is the coreutils package installed ?"
+    return
+  fi
+  WHICH_CAT=`which cat`
+  if [ $? != 0 ]; then
+    echo "Couldn't find cat. Is the coreutils package installed ?"
+    return
+  fi
+  WHICH_MKTEMP=`which mktemp`
+  if [ $? != 0 ]; then
+    echo "Couldn't find mktemp. Is the coreutils package installed ?"
+    return
+  fi
+  WHICH_GREP=`which grep`
+  if [ $? != 0 ]; then
+    echo "Couldn't find grep. Is the grep package installed ?"
+    return
+  fi
+  WHICH_SED=`which sed`
+  if [ $? != 0 ]; then
+    echo "Couldn't find sed. Is the sed package installed ?"
+    return
+  fi
+  WHICH_PS=`which pinot-search`
+  if [ $? != 0 ]; then
+    echo "Couldn't find pinot-search. Is the pinot package installed ?"
+    return
+  fi
+
+  MISSING_PROGRAM=0
+}
+
+# Check the daemon's index exists
+checkindex()
+{
+  if [ ! -d "$HOME/.pinot/daemon" ]; then
+    echo "Configure Pinot to crawl and index directories first."
+    return
+  fi
+
+  MISSING_INDEX=0
+}
+
+# Run the actual search and get matches
+runsearch()
+{
+  local TEMP_FILE=`mktemp`
+
+  pinot-search -l xapian "$HOME/.pinot/daemon" "type:x-directory/normal $1" 2>/dev/null | grep "file://" | sed -e "s/file:\/\/\(.*\)/\1/g" >$TEMP_FILE 2>/dev/null
+
+  local RESULTS=`cat $TEMP_FILE`
+  local RESULTS_COUNT=`cat $TEMP_FILE|wc -l`
+
+  if [ $RESULTS_COUNT -eq 1 ]; then
+    FOUND_MATCH=1
+    echo $RESULTS
+    cd "$RESULTS"
+  elif [ $RESULTS_COUNT -gt 1 ]; then
+    FOUND_MATCH=1
+    echo "Matches for \"$1\":"
+    cat $TEMP_FILE
+  fi
+  \rm -f $TEMP_FILE >/dev/null 2>&1
+}
+
+# Prepares the query string
+preparequery()
+{
+  local ARGS=""
+  local LAST_ARG=""
+
+  for ARG in `echo $@` ;
+  do
+    ARGS="$ARGS path:$ARG"
+    LAST_ARG="$ARG"
+  done
+
+  if [ -z "$LAST_ARG" ]; then
+    return
+  fi
+
+  PATHS_ONLY_STRING=$ARGS
+  # Assume the last path is the name of the final directory
+  PATHS_AND_FILE_STRING=`echo $ARGS | sed -e "s/path:$LAST_ARG/file:$LAST_ARG/g"`
+
+  runsearch "$PATHS_AND_FILE_STRING"
+  if [ $FOUND_MATCH -eq 0 ]; then
+    # That assumption doesn't seem correct
+    runsearch "$PATHS_ONLY_STRING"
+    if [ $FOUND_MATCH -eq 0 ]; then
+      echo "No match"
+    fi
+  fi
+}
+
+# Warn if not sourced
+BASE_NAME=`basename $0`
+if [ "$BASE_NAME" == "pinot-cd.sh" ]; then
+  echo "Run this script with . $0"
+  exit 1
+fi
+
+checkprograms
+checkindex
+
+if [ $# == 0 ]; then
+  echo "Usage: pinot-cd.sh path1 path2..."
+elif [ "$MISSING_PROGRAM" == 0 ] || [ "$MISSING_INDEX" == 0 ]; then
+  if [ $# -eq 1 ] && [ "$1" == "-" ] && [ ! -z "$OLDPWD" ]; then
+    cd "$OLDPWD"
+  else
+    preparequery $@
+  fi
+fi
+


Property changes on: trunk/scripts/bash/pinot-cd.sh
___________________________________________________________________
Name: svn:executable
   + *



From fabricecolin at mail.berlios.de  Thu Dec 11 14:42:35 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Thu, 11 Dec 2008 14:42:35 +0100
Subject: [Pinot-svn] r1439 - trunk/IndexSearch/Xapian
Message-ID: <200812111342.mBBDgZj3004619@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-11 14:42:28 +0100 (Thu, 11 Dec 2008)
New Revision: 1439

Modified:
   trunk/IndexSearch/Xapian/XapianEngine.cpp
   trunk/IndexSearch/Xapian/XapianEngine.h
Log:
Get PrefixDecider to reject short terms instead of doing it after it ran. Also
reject terms that occur only once and stop words.
If Xapian >= 1.0.4 is available, set the empty prefix so that both text and
title are searched for on non-prefixed query terms.


Modified: trunk/IndexSearch/Xapian/XapianEngine.cpp
===================================================================
--- trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-12-07 05:44:07 UTC (rev 1438)
+++ trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-12-11 13:42:28 UTC (rev 1439)
@@ -140,8 +140,12 @@
 class PrefixDecider : public Xapian::ExpandDecider
 {
 	public:
-		PrefixDecider(const string &allowedPrefixes) :
+		PrefixDecider(Xapian::Database *pIndex,
+			Xapian::Stopper *pStopper,
+			const string &allowedPrefixes) :
 			Xapian::ExpandDecider(),
+			m_pIndex(pIndex),
+			m_pStopper(pStopper),
 			m_allowedPrefixes(allowedPrefixes)
 		{
 		}
@@ -151,19 +155,44 @@
 
 		virtual bool operator()(const std::string &term) const
 		{
-			if ((isupper((int)(term[0])) == 0) ||
-				(m_allowedPrefixes.find(term[0]) != string::npos))
+			CJKVTokenizer tokenizer;
+
+			// Reject short terms
+			if ((tokenizer.has_cjkv(term) == false) &&
+				(term.length() < 3))
 			{
-				return true;
+				return false;
 			}
-#ifdef DEBUG
-			cout << "PrefixDecider::operator: rejecting " << term << endl;
-#endif
 
-			return false;
+			// Reject terms with prefixes we don't want
+			if ((isupper((int)(term[0])) != 0) && 
+				(m_allowedPrefixes.find(term[0]) == string::npos))
+			{
+				return false;
+			}
+
+			// Reject terms that occur only once
+			if ((m_pIndex != NULL) &&
+				(m_pIndex->get_termfreq(term) <= 1))
+			{
+				return false;
+			}
+
+			// Reject stop words
+			if ((m_pStopper != NULL) &&
+				((*m_pStopper)(term) == true))
+			{
+				return false;
+			}
+
+			// FIXME: reject terms that stem to the same as query terms
+
+			return true;
 		}
 
 	protected:
+		Xapian::Database *m_pIndex;
+		Xapian::Stopper *m_pStopper;
 		string m_allowedPrefixes;
 
 };
@@ -560,9 +589,7 @@
 		// Don't bother loading the stopwords list if there's only one token
 		if (tokensCount > 1)
 		{
-			string languageCode(Languages::toCode(stemLanguage));
-
-			FileStopper *pStopper = FileStopper::get_stopper(languageCode);
+			FileStopper *pStopper = FileStopper::get_stopper(Languages::toCode(stemLanguage));
 			if ((pStopper != NULL) &&
 				(pStopper->get_stopwords_count() > 0))
 			{
@@ -586,6 +613,11 @@
 	{
 		parser.set_default_op(Xapian::Query::OP_OR);
 	}
+#if XAPIAN_NUM_VERSION >= 1000004
+	// Search across text body and title
+	parser.add_prefix("", "");
+	parser.add_prefix("", "S");
+#endif
 	// X prefixes should always include a colon
 	parser.add_boolean_prefix("site", "H");
 	parser.add_boolean_prefix("file", "P");
@@ -760,7 +792,7 @@
 }
 
 bool XapianEngine::queryDatabase(Xapian::Database *pIndex, Xapian::Query &query,
-	unsigned int startDoc, const QueryProperties &queryProps)
+	const string &stemLanguage, unsigned int startDoc, const QueryProperties &queryProps)
 {
 	Timer timer;
 	unsigned int maxResultsCount = queryProps.getMaximumResultsCount();
@@ -904,7 +936,6 @@
 		if (m_expandDocuments.empty() == false)
 		{
 			Xapian::RSet expandDocs;
-			unsigned int count = 0;
 
 			for (set<string>::const_iterator docIter = m_expandDocuments.begin();
 				docIter != m_expandDocuments.end(); ++docIter)
@@ -924,25 +955,18 @@
 
 			// Get 10 non-prefixed terms
 			string allowedPrefixes("RS");
-			PrefixDecider expandDecider(allowedPrefixes);
+			PrefixDecider expandDecider(pIndex, FileStopper::get_stopper(Languages::toCode(stemLanguage)), allowedPrefixes);
 			CJKVTokenizer tokenizer;
-			Xapian::ESet expandTerms = enquire.get_eset(20, expandDocs, &expandDecider);
+			Xapian::ESet expandTerms = enquire.get_eset(10, expandDocs, &expandDecider);
 #ifdef DEBUG
 			cout << "XapianEngine::queryDatabase: " << expandTerms.size() << " expand terms" << endl;
 #endif
 			for (Xapian::ESetIterator termIter = expandTerms.begin();
-				(termIter != expandTerms.end()) && (count < 10); ++termIter)
+				termIter != expandTerms.end(); ++termIter)
 			{
 				string expandTerm(*termIter);
 				char firstChar = expandTerm[0];
 
-				// Skip short terms
-				if ((tokenizer.has_cjkv(expandTerm) == false) &&
-					(expandTerm.length() < 3))
-				{
-					continue;
-				}
-
 				// Is this prefixed ?
 				if (allowedPrefixes.find(firstChar) != string::npos)
 				{
@@ -950,7 +974,6 @@
 				}
 
 				m_expandTerms.insert(expandTerm);
-				++count;
 			}
 		}
 	}
@@ -1064,14 +1087,14 @@
 		unsigned int searchStep = 1;
 
 		// Searches are run in this order :
-		// 1. don't stem terms
-		// 2. if no results, stem terms if a language is defined for the query
+		// 1. no stemming, exact matches only
+		// 2. stem terms if a language is defined for the query
 		Xapian::Query fullQuery = parseQuery(pIndex, queryProps, "",
 			m_defaultOperator, m_limitQuery, m_correctedFreeQuery);
 		while (fullQuery.empty() == false)
 		{
 			// Query the database
-			if (queryDatabase(pIndex, fullQuery, startDoc, queryProps) == false)
+			if (queryDatabase(pIndex, fullQuery, stemLanguage, startDoc, queryProps) == false)
 			{
 				break;
 			}

Modified: trunk/IndexSearch/Xapian/XapianEngine.h
===================================================================
--- trunk/IndexSearch/Xapian/XapianEngine.h	2008-12-07 05:44:07 UTC (rev 1438)
+++ trunk/IndexSearch/Xapian/XapianEngine.h	2008-12-11 13:42:28 UTC (rev 1439)
@@ -64,7 +64,8 @@
 		std::set<std::string> m_expandDocuments;
 
 		bool queryDatabase(Xapian::Database *pIndex, Xapian::Query &query,
-			unsigned int startDoc, const QueryProperties &queryProps);
+			const string &stemLanguage, unsigned int startDoc,
+			const QueryProperties &queryProps);
 
 		static Xapian::Query parseQuery(Xapian::Database *pIndex, const QueryProperties &queryProps,
 			const string &stemLanguage, DefaultOperator defaultOperator,



From fabricecolin at mail.berlios.de  Sun Dec 14 02:42:15 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Sun, 14 Dec 2008 02:42:15 +0100
Subject: [Pinot-svn] r1440 - trunk/UI/GTK2/src
Message-ID: <200812140142.mBE1gFLd028863@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-14 02:42:04 +0100 (Sun, 14 Dec 2008)
New Revision: 1440

Modified:
   trunk/UI/GTK2/src/PinotSettings.cpp
Log:
Fixed getHomeDirectory() to always return when HAVE_PWD_H isn't defined.


Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2008-12-11 13:42:28 UTC (rev 1439)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2008-12-14 01:42:04 UTC (rev 1440)
@@ -195,6 +195,9 @@
 	}
 
 	return "~";
+#else
+
+	return ".";
 #endif
 }
 



From fabricecolin at mail.berlios.de  Sun Dec 14 02:45:36 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Sun, 14 Dec 2008 02:45:36 +0100
Subject: [Pinot-svn] r1441 - trunk/UI/GTK2/src
Message-ID: <200812140145.mBE1ja1E030418@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-14 02:45:32 +0100 (Sun, 14 Dec 2008)
New Revision: 1441

Modified:
   trunk/UI/GTK2/src/statisticsDialog.cc
Log:
Don't check status right away, say we are checking and wait for the first timer
to kick in to get those values.


Modified: trunk/UI/GTK2/src/statisticsDialog.cc
===================================================================
--- trunk/UI/GTK2/src/statisticsDialog.cc	2008-12-14 01:42:04 UTC (rev 1440)
+++ trunk/UI/GTK2/src/statisticsDialog.cc	2008-12-14 01:45:32 UTC (rev 1441)
@@ -156,10 +156,14 @@
 	row = *statIter;
 	row[m_statsColumns.m_name] = _("My Web Pages");
 	m_myWebPagesIter = m_refStore->append(statIter->children());
+	row = *m_myWebPagesIter;
+	row[m_statsColumns.m_name] = ustring(_("Checking"));
 	statIter = m_refStore->append(folderIter->children());
 	row = *statIter;
 	row[m_statsColumns.m_name] = _("My Documents");
 	m_myDocumentsIter = m_refStore->append(statIter->children());
+	row = *m_myDocumentsIter;
+	row[m_statsColumns.m_name] = ustring(_("Checking"));
 
 	// Search engines
 	TreeModel::iterator enginesIter = m_refStore->append();
@@ -179,20 +183,24 @@
 	row = *folderIter;
 	row[m_statsColumns.m_name] = _("History");
 	m_viewStatIter = m_refStore->append(folderIter->children());
+	row = *m_viewStatIter;
+	row[m_statsColumns.m_name] = ustring(_("Checking"));
 	m_crawledStatIter = m_refStore->append(folderIter->children());
+	row = *m_crawledStatIter;
+	row[m_statsColumns.m_name] = ustring(_("Checking"));
 
 	// Daemon
 	m_daemonIter = m_refStore->append();
 	row = *m_daemonIter;
 	row[m_statsColumns.m_name] = _("Daemon");
 	m_daemonProcIter = m_refStore->append(m_daemonIter->children());
+	row = *m_daemonProcIter;
+	row[m_statsColumns.m_name] = ustring(_("Checking"));
 
 	// Expand everything
 	statisticsTreeview->expand_all();
 	TreeModel::Path enginesPath = m_refStore->get_path(enginesIter);
 	statisticsTreeview->collapse_row(enginesPath);
-
-	on_activity_timeout();
 }
 
 bool statisticsDialog::on_activity_timeout(void)



From fabricecolin at mail.berlios.de  Sun Dec 14 05:11:41 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Sun, 14 Dec 2008 05:11:41 +0100
Subject: [Pinot-svn] r1442 - trunk/UI/GTK2/src
Message-ID: <200812140411.mBE4BfjY021424@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-14 05:11:27 +0100 (Sun, 14 Dec 2008)
New Revision: 1442

Modified:
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Changed the "Showing..." message to something a bit easier to translate.


Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2008-12-14 01:45:32 UTC (rev 1441)
+++ trunk/UI/GTK2/src/mainWindow.cc	2008-12-14 04:11:27 UTC (rev 1442)
@@ -1274,18 +1274,16 @@
 
 				status = _("Showing");
 				status += " ";
-				snprintf(docsCountStr, 64, "%u", pResultsTree->getRowsCount());
+				snprintf(docsCountStr, 64, "%u", pIndexPage->getFirstDocument());
 				status += docsCountStr;
+				status += " - ";
+				snprintf(docsCountStr, 64, "%u", pIndexPage->getFirstDocument() + pResultsTree->getRowsCount());
+				status += docsCountStr;
 				status += " ";
 				status += _("of");
 				status += " ";
 				snprintf(docsCountStr, 64, "%u", pIndexPage->getDocumentsCount());
 				status += docsCountStr;
-				status += " ";
-				status += _("documents, starting at");
-				status += " ";
-				snprintf(docsCountStr, 64, "%u", pIndexPage->getFirstDocument());
-				status += docsCountStr;
 				set_status(status);
 
 				if (pIndexPage->getDocumentsCount() > 0)



From fabricecolin at mail.berlios.de  Sun Dec 14 05:12:35 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Sun, 14 Dec 2008 05:12:35 +0100
Subject: [Pinot-svn] r1443 - trunk/UI/GTK2/src
Message-ID: <200812140412.mBE4CZ9I021494@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-14 05:12:21 +0100 (Sun, 14 Dec 2008)
New Revision: 1443

Modified:
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
Log:
Removed unused method renderExtractColumn().


Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2008-12-14 04:11:27 UTC (rev 1442)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2008-12-14 04:12:21 UTC (rev 1443)
@@ -316,29 +316,6 @@
 	}
 }
 
-void ResultsTree::renderExtractColumn(CellRenderer *pRenderer, const TreeModel::iterator &iter)
-{
-	TreeModel::Row row = *iter;
-
-	if (pRenderer == NULL)
-	{
-		return;
-	}
-
-	CellRendererText *pTextRenderer = dynamic_cast<CellRendererText*>(pRenderer);
-	if (pTextRenderer != NULL)
-	{
-		ustring markup(row[m_extractColumns.m_name]);
-		pTextRenderer->property_markup() = markup;
-		pTextRenderer->property_single_paragraph_mode() = true;
-		// These properties are not available in gtkmm 2.8
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=10
-		pTextRenderer->property_wrap_mode() = Pango::WRAP_WORD;
-		pTextRenderer->property_wrap_width() = m_pExtractScrolledwindow->get_width();
-#endif
-	}
-}
-
 void ResultsTree::onButtonPressEvent(GdkEventButton *ev)
 {
 	// Check for popup click

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2008-12-14 04:11:27 UTC (rev 1442)
+++ trunk/UI/GTK2/src/ResultsTree.h	2008-12-14 04:12:21 UTC (rev 1443)
@@ -139,8 +139,6 @@
 
 		void renderTitleColumn(Gtk::CellRenderer *pRenderer, const Gtk::TreeModel::iterator &iter);
 
-		void renderExtractColumn(Gtk::CellRenderer *pRenderer, const Gtk::TreeModel::iterator &iter);
-
 		void onButtonPressEvent(GdkEventButton *ev);
 
 		void onSelectionChanged(void);



From fabricecolin at mail.berlios.de  Sun Dec 14 05:16:38 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Sun, 14 Dec 2008 05:16:38 +0100
Subject: [Pinot-svn] r1444 - trunk
Message-ID: <200812140416.mBE4Gcip021681@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-14 05:16:33 +0100 (Sun, 14 Dec 2008)
New Revision: 1444

Modified:
   trunk/configure.in
Log:
Require at least Xapian 1.0.4 for the recent changes to XapianIndex and
XapianEngine to function as expected.


Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2008-12-14 04:12:21 UTC (rev 1443)
+++ trunk/configure.in	2008-12-14 04:16:33 UTC (rev 1444)
@@ -236,12 +236,12 @@
 XAPIAN_NUM_VERSION=`xapian-config --version | $SED -e "s/xapian-config - xapian-core //g" | $AWK 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
 AC_DEFINE_UNQUOTED(XAPIAN_NUM_VERSION,$XAPIAN_NUM_VERSION,
     [Xapian version number])
-AC_MSG_CHECKING(for Xapian >= 1.0.3)
+AC_MSG_CHECKING(for Xapian >= 1.0.4)
 if test $XAPIAN_NUM_VERSION -gt 1000002; then
    AC_MSG_RESULT(yes)
 else
    AC_MSG_RESULT(no)
-   AC_MSG_ERROR([You need at least Xapian 1.0.3])
+   AC_MSG_ERROR([You need at least Xapian 1.0.4])
    exit 1
 fi
 



From fabricecolin at mail.berlios.de  Mon Dec 15 14:53:36 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 15 Dec 2008 14:53:36 +0100
Subject: [Pinot-svn] r1445 - trunk/UI/GTK2/src
Message-ID: <200812151353.mBFDraOD004040@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-15 14:53:32 +0100 (Mon, 15 Dec 2008)
New Revision: 1445

Modified:
   trunk/UI/GTK2/src/PinotSettings.cpp
Log:
Following r1409, external back-ends with no channel specified didn't show in
the engines list.


Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2008-12-14 04:16:33 UTC (rev 1444)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2008-12-15 13:53:32 UTC (rev 1445)
@@ -397,11 +397,21 @@
 			m_engineIds[1 << m_engines.size()] = engineIter->first.m_name;
 
 			// Is a channel specified ?
-			if (channelName.empty() == true)
+			if (engineIter->first.m_channel.empty() == true)
 			{
-				channelName = currentUserChannelName;
+				ModuleProperties modProps(engineIter->first);
+
+				channelName = modProps.m_channel = currentUserChannelName;
+
+#ifdef DEBUG
+				cout << "PinotSettings::load: no channel for back-end " << engineIter->first.m_name << endl;
+#endif
+				m_engines.insert(modProps);
 			}
-			m_engines.insert(engineIter->first);
+			else
+			{
+				m_engines.insert(engineIter->first);
+			}
 
 			if (m_engineChannels.find(channelName) == m_engineChannels.end())
 			{
@@ -1819,6 +1829,9 @@
 		{
 			if (engineIter->m_channel == channelName)
 			{
+#ifdef DEBUG
+				cout << "PinotSettings::getSearchEngines: engine " << engineIter->m_longName << " in channel " << channelName << endl;
+#endif
 				engines.insert(*engineIter);
 			}
 		}



From fabricecolin at mail.berlios.de  Tue Dec 16 14:43:33 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Tue, 16 Dec 2008 14:43:33 +0100
Subject: [Pinot-svn] r1446 - trunk/IndexSearch/Xapian
Message-ID: <200812161343.mBGDhXAT026480@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-16 14:43:28 +0100 (Tue, 16 Dec 2008)
New Revision: 1446

Modified:
   trunk/IndexSearch/Xapian/XapianEngine.cpp
Log:
PrefixDecider rejects terms with spaces, which shouldn't be there in the first
place.


Modified: trunk/IndexSearch/Xapian/XapianEngine.cpp
===================================================================
--- trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-12-15 13:53:32 UTC (rev 1445)
+++ trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-12-16 13:43:28 UTC (rev 1446)
@@ -156,6 +156,7 @@
 		virtual bool operator()(const std::string &term) const
 		{
 			CJKVTokenizer tokenizer;
+			bool isPrefixed = false;
 
 			// Reject short terms
 			if ((tokenizer.has_cjkv(term) == false) &&
@@ -165,9 +166,19 @@
 			}
 
 			// Reject terms with prefixes we don't want
-			if ((isupper((int)(term[0])) != 0) && 
-				(m_allowedPrefixes.find(term[0]) == string::npos))
+			if (isupper((int)(term[0])) != 0)
 			{
+				isPrefixed = true;
+
+				if (m_allowedPrefixes.find(term[0]) == string::npos)
+				{
+					return false;
+				}
+			}
+
+			// Reject terms with spaces
+			if (term.find_first_of(" \t\r\n") != string::npos)
+			{
 				return false;
 			}
 



From fabricecolin at mail.berlios.de  Fri Dec 19 14:43:20 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Fri, 19 Dec 2008 14:43:20 +0100
Subject: [Pinot-svn] r1447 - in trunk/UI/GTK2: . src
Message-ID: <200812191343.mBJDhKcd022287@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-19 14:43:08 +0100 (Fri, 19 Dec 2008)
New Revision: 1447

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/indexDialog_glade.cc
   trunk/UI/GTK2/src/prefsWindow_glade.cc
   trunk/UI/GTK2/src/queryDialog_glade.cc
Log:
Setting an adjustment with non-zero page size on a SpinButton is deprecated.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2008-12-16 13:43:28 UTC (rev 1446)
+++ trunk/UI/GTK2/metase-gtk2.glade	2008-12-19 13:43:08 UTC (rev 1447)
@@ -1302,7 +1302,7 @@
 		  <property name="update_policy">GTK_UPDATE_ALWAYS</property>
 		  <property name="snap_to_ticks">False</property>
 		  <property name="wrap">False</property>
-		  <property name="adjustment">10 10 100 10 20 20</property>
+		  <property name="adjustment">10 10 100 10 20 0</property>
 		</widget>
 		<packing>
 		  <property name="left_attach">1</property>
@@ -2221,7 +2221,7 @@
 	      <property name="update_policy">GTK_UPDATE_ALWAYS</property>
 	      <property name="snap_to_ticks">False</property>
 	      <property name="wrap">False</property>
-	      <property name="adjustment">1024 1 65535 1 10 10</property>
+	      <property name="adjustment">1024 1 65535 1 10 0</property>
 	    </widget>
 	    <packing>
 	      <property name="left_attach">1</property>
@@ -3298,7 +3298,7 @@
 		      <property name="update_policy">GTK_UPDATE_ALWAYS</property>
 		      <property name="snap_to_ticks">False</property>
 		      <property name="wrap">False</property>
-		      <property name="adjustment">80 1 65535 1 10 10</property>
+		      <property name="adjustment">80 1 65535 1 10 0</property>
 		    </widget>
 		    <packing>
 		      <property name="left_attach">1</property>

Modified: trunk/UI/GTK2/src/indexDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/indexDialog_glade.cc	2008-12-16 13:43:28 UTC (rev 1446)
+++ trunk/UI/GTK2/src/indexDialog_glade.cc	2008-12-19 13:43:08 UTC (rev 1447)
@@ -71,7 +71,7 @@
    Gtk::Label *portLabel = Gtk::manage(new class Gtk::Label(_("Port:")));
    nameEntry = Gtk::manage(new class Gtk::Entry());
    
-   Gtk::Adjustment *portSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(1024, 1, 65535, 1, 10, 10));
+   Gtk::Adjustment *portSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(1024, 1, 65535, 1, 10, 0));
    portSpinbutton = Gtk::manage(new class Gtk::SpinButton(*portSpinbutton_adj, 1, 0));
    typeCombobox = Gtk::manage(new class Gtk::ComboBoxText());
    

Modified: trunk/UI/GTK2/src/prefsWindow_glade.cc
===================================================================
--- trunk/UI/GTK2/src/prefsWindow_glade.cc	2008-12-16 13:43:28 UTC (rev 1446)
+++ trunk/UI/GTK2/src/prefsWindow_glade.cc	2008-12-19 13:43:08 UTC (rev 1447)
@@ -88,7 +88,7 @@
    
    Gtk::Label *proxyTypeLabel = Gtk::manage(new class Gtk::Label(_("Type:")));
    Gtk::Label *proxyPortLabel = Gtk::manage(new class Gtk::Label(_("Port:")));
-   Gtk::Adjustment *proxyPortSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(80, 1, 65535, 1, 10, 10));
+   Gtk::Adjustment *proxyPortSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(80, 1, 65535, 1, 10, 0));
    proxyPortSpinbutton = Gtk::manage(new class Gtk::SpinButton(*proxyPortSpinbutton_adj, 1, 0));
    proxyTypeCombobox = Gtk::manage(new class Gtk::ComboBoxText());
    

Modified: trunk/UI/GTK2/src/queryDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog_glade.cc	2008-12-16 13:43:28 UTC (rev 1446)
+++ trunk/UI/GTK2/src/queryDialog_glade.cc	2008-12-19 13:43:08 UTC (rev 1447)
@@ -83,7 +83,7 @@
    labelNameCombobox = Gtk::manage(new class Gtk::ComboBoxText());
    
    Gtk::Label *resultsCountLabel = Gtk::manage(new class Gtk::Label(_("Number of results:")));
-   Gtk::Adjustment *resultsCountSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(10, 10, 100, 10, 20, 20));
+   Gtk::Adjustment *resultsCountSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(10, 10, 100, 10, 20, 0));
    resultsCountSpinbutton = Gtk::manage(new class Gtk::SpinButton(*resultsCountSpinbutton_adj, 1, 0));
    
    Gtk::Label *sortOrderLabel = Gtk::manage(new class Gtk::Label(_("Sort order:")));



From fabricecolin at mail.berlios.de  Fri Dec 19 15:13:19 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Fri, 19 Dec 2008 15:13:19 +0100
Subject: [Pinot-svn] r1448 - trunk/IndexSearch/Xapian
Message-ID: <200812191413.mBJEDJeM024492@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-19 15:13:14 +0100 (Fri, 19 Dec 2008)
New Revision: 1448

Modified:
   trunk/IndexSearch/Xapian/XapianEngine.cpp
   trunk/IndexSearch/Xapian/XapianEngine.h
Log:
Don't wait for query step 2 to get a stemmer if the query defines a stemming
language. Pass it to PrefixDecider so that it can reject query terms and
terms that stem to the same as them.


Modified: trunk/IndexSearch/Xapian/XapianEngine.cpp
===================================================================
--- trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-12-19 13:43:08 UTC (rev 1447)
+++ trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-12-19 14:13:14 UTC (rev 1448)
@@ -141,13 +141,38 @@
 {
 	public:
 		PrefixDecider(Xapian::Database *pIndex,
+			Xapian::Stem *pStemmer,
 			Xapian::Stopper *pStopper,
-			const string &allowedPrefixes) :
+			const string &allowedPrefixes,
+			Xapian::Query &query) :
 			Xapian::ExpandDecider(),
 			m_pIndex(pIndex),
+			m_pStemmer(pStemmer),
 			m_pStopper(pStopper),
 			m_allowedPrefixes(allowedPrefixes)
 		{
+			for (Xapian::TermIterator termIter = query.get_terms_begin();
+				termIter != query.get_terms_end(); ++termIter)
+			{
+				string term(*termIter);
+
+				if (isupper((int)(term[0])) == 0)
+				{
+					m_termsToAvoid.insert(term);
+					if (m_pStemmer != NULL)
+					{
+						string stem((*m_pStemmer)(term));
+						m_termsToAvoid.insert(stem);
+					}
+				}
+				else if (term[0] == 'Z')
+				{
+					m_termsToAvoid.insert(term.substr(1));
+				}
+			}
+#ifdef DEBUG
+			cout << "PrefixDecider: avoiding " << m_termsToAvoid.size() << " terms" << endl;
+#endif
 		}
 		~PrefixDecider()
 		{
@@ -196,15 +221,48 @@
 				return false;
 			}
 
-			// FIXME: reject terms that stem to the same as query terms
+			// Stop here if there's no specific terms to avoid
+			if (m_termsToAvoid.empty() == true)
+			{
+				return true;
+			}
 
+			// Reject query terms
+			if (m_termsToAvoid.find(term) != m_termsToAvoid.end())
+			{
+				return false;
+			}
+
+			// Stop here is there's no stemmer
+			if (m_pStemmer == NULL)
+			{
+				return true;
+			}
+
+			// Reject terms that stem to the same as query terms
+			string stem;
+			if (isPrefixed == true)
+			{
+				stem = (*m_pStemmer)(term.substr(1));
+			}
+			else
+			{
+				stem = (*m_pStemmer)(term);
+			}
+			if (m_termsToAvoid.find(stem) != m_termsToAvoid.end())
+			{
+				return false;
+			}
+
 			return true;
 		}
 
 	protected:
 		Xapian::Database *m_pIndex;
+		Xapian::Stem *m_pStemmer;
 		Xapian::Stopper *m_pStopper;
 		string m_allowedPrefixes;
+		set<string> m_termsToAvoid;
 
 };
 
@@ -526,7 +584,6 @@
 	const string &limitQuery, string &correctedFreeQuery, bool minimal)
 {
 	Xapian::QueryParser parser;
-	Xapian::Stem stemmer;
 	CJKVTokenizer tokenizer;
 	string freeQuery(queryProps.getFreeQuery());
 	unsigned int tokensCount = 1;
@@ -583,18 +640,7 @@
 	if ((minimal == false) &&
 		(stemLanguage.empty() == false))
 	{
-#ifdef DEBUG
-		cout << "XapianEngine::parseQuery: " << stemLanguage << " stemming" << endl;
-#endif
-		try
-		{
-			stemmer = Xapian::Stem(StringManip::toLowerCase(stemLanguage));
-		}
-		catch (const Xapian::Error &error)
-		{
-			cerr << "Couldn't create stemmer: " << error.get_type() << ": " << error.get_msg() << endl;
-		}
-		parser.set_stemmer(stemmer);
+		parser.set_stemmer(m_stemmer);
 		parser.set_stemming_strategy(Xapian::QueryParser::STEM_SOME);
 
 		// Don't bother loading the stopwords list if there's only one token
@@ -786,7 +832,6 @@
 
 	if (minimal == false)
 	{
-
 #if ENABLE_XAPIAN_SPELLING_CORRECTION>0
 		// Any correction ?
 		correctedFreeQuery = parser.get_corrected_query_string();
@@ -966,8 +1011,9 @@
 
 			// Get 10 non-prefixed terms
 			string allowedPrefixes("RS");
-			PrefixDecider expandDecider(pIndex, FileStopper::get_stopper(Languages::toCode(stemLanguage)), allowedPrefixes);
-			CJKVTokenizer tokenizer;
+			PrefixDecider expandDecider(pIndex, ((stemLanguage.empty() == true) ? NULL : &m_stemmer),
+				FileStopper::get_stopper(Languages::toCode(stemLanguage)),
+				allowedPrefixes, query);
 			Xapian::ESet expandTerms = enquire.get_eset(10, expandDocs, &expandDecider);
 #ifdef DEBUG
 			cout << "XapianEngine::queryDatabase: " << expandTerms.size() << " expand terms" << endl;
@@ -1070,6 +1116,8 @@
 bool XapianEngine::runQuery(QueryProperties& queryProps,
 	unsigned int startDoc)
 {
+	string stemLanguage(Languages::toEnglish(queryProps.getStemmingLanguage()));
+
 	// Clear the results list
 	m_resultsList.clear();
 	m_resultsCountEstimate = 0;
@@ -1089,12 +1137,26 @@
 		return false;
 	}
 
+	if (stemLanguage.empty() == false)
+	{
+#ifdef DEBUG
+		cout << "XapianEngine::runQuery: " << stemLanguage << " stemming" << endl;
+#endif
+		try
+		{
+			m_stemmer = Xapian::Stem(StringManip::toLowerCase(stemLanguage));
+		}
+		catch (const Xapian::Error &error)
+		{
+			cerr << "Couldn't create stemmer: " << error.get_type() << ": " << error.get_msg() << endl;
+		}
+	}
+
 	// Get the latest revision...
 	pDatabase->reopen();
 	Xapian::Database *pIndex = pDatabase->readLock();
 	try
 	{
-		string stemLanguage(Languages::toEnglish(queryProps.getStemmingLanguage()));
 		unsigned int searchStep = 1;
 
 		// Searches are run in this order :

Modified: trunk/IndexSearch/Xapian/XapianEngine.h
===================================================================
--- trunk/IndexSearch/Xapian/XapianEngine.h	2008-12-19 13:43:08 UTC (rev 1447)
+++ trunk/IndexSearch/Xapian/XapianEngine.h	2008-12-19 14:13:14 UTC (rev 1448)
@@ -62,12 +62,13 @@
 		std::string m_databaseName;
 		std::string m_limitQuery;
 		std::set<std::string> m_expandDocuments;
+		Xapian::Stem m_stemmer;
 
 		bool queryDatabase(Xapian::Database *pIndex, Xapian::Query &query,
 			const string &stemLanguage, unsigned int startDoc,
 			const QueryProperties &queryProps);
 
-		static Xapian::Query parseQuery(Xapian::Database *pIndex, const QueryProperties &queryProps,
+		Xapian::Query parseQuery(Xapian::Database *pIndex, const QueryProperties &queryProps,
 			const string &stemLanguage, DefaultOperator defaultOperator,
 			const string &limitQuery, string &correctedFreeQuery, bool minimal = false);
 



From fabricecolin at mail.berlios.de  Mon Dec 29 18:52:12 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 29 Dec 2008 18:52:12 +0100
Subject: [Pinot-svn] r1449 - trunk/IndexSearch/Xapian
Message-ID: <200812291752.mBTHqCxx022195@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-29 18:52:02 +0100 (Mon, 29 Dec 2008)
New Revision: 1449

Modified:
   trunk/IndexSearch/Xapian/XapianEngine.cpp
Log:
Renamed PrefixDecider to TermDecider.
Reject terms that stem to the same as a previously validated term.


Modified: trunk/IndexSearch/Xapian/XapianEngine.cpp
===================================================================
--- trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-12-19 14:13:14 UTC (rev 1448)
+++ trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-12-29 17:52:02 UTC (rev 1449)
@@ -137,10 +137,10 @@
 
 };
 
-class PrefixDecider : public Xapian::ExpandDecider
+class TermDecider : public Xapian::ExpandDecider
 {
 	public:
-		PrefixDecider(Xapian::Database *pIndex,
+		TermDecider(Xapian::Database *pIndex,
 			Xapian::Stem *pStemmer,
 			Xapian::Stopper *pStopper,
 			const string &allowedPrefixes,
@@ -149,8 +149,11 @@
 			m_pIndex(pIndex),
 			m_pStemmer(pStemmer),
 			m_pStopper(pStopper),
-			m_allowedPrefixes(allowedPrefixes)
+			m_allowedPrefixes(allowedPrefixes),
+			m_pTermsToAvoid(NULL)
 		{
+			m_pTermsToAvoid = new set<string>();
+
 			for (Xapian::TermIterator termIter = query.get_terms_begin();
 				termIter != query.get_terms_end(); ++termIter)
 			{
@@ -158,24 +161,28 @@
 
 				if (isupper((int)(term[0])) == 0)
 				{
-					m_termsToAvoid.insert(term);
+					m_pTermsToAvoid->insert(term);
 					if (m_pStemmer != NULL)
 					{
 						string stem((*m_pStemmer)(term));
-						m_termsToAvoid.insert(stem);
+						m_pTermsToAvoid->insert(stem);
 					}
 				}
 				else if (term[0] == 'Z')
 				{
-					m_termsToAvoid.insert(term.substr(1));
+					m_pTermsToAvoid->insert(term.substr(1));
 				}
 			}
 #ifdef DEBUG
-			cout << "PrefixDecider: avoiding " << m_termsToAvoid.size() << " terms" << endl;
+			cout << "TermDecider: avoiding " << m_pTermsToAvoid->size() << " terms" << endl;
 #endif
 		}
-		~PrefixDecider()
+		~TermDecider()
 		{
+			if (m_pTermsToAvoid != NULL)
+			{
+				delete m_pTermsToAvoid;
+			}
 		}
 
 		virtual bool operator()(const std::string &term) const
@@ -222,13 +229,13 @@
 			}
 
 			// Stop here if there's no specific terms to avoid
-			if (m_termsToAvoid.empty() == true)
+			if (m_pTermsToAvoid->empty() == true)
 			{
 				return true;
 			}
 
 			// Reject query terms
-			if (m_termsToAvoid.find(term) != m_termsToAvoid.end())
+			if (m_pTermsToAvoid->find(term) != m_pTermsToAvoid->end())
 			{
 				return false;
 			}
@@ -240,6 +247,7 @@
 			}
 
 			// Reject terms that stem to the same as query terms
+			// or previously validated terms
 			string stem;
 			if (isPrefixed == true)
 			{
@@ -249,10 +257,11 @@
 			{
 				stem = (*m_pStemmer)(term);
 			}
-			if (m_termsToAvoid.find(stem) != m_termsToAvoid.end())
+			if (m_pTermsToAvoid->find(stem) != m_pTermsToAvoid->end())
 			{
 				return false;
 			}
+			m_pTermsToAvoid->insert(stem);
 
 			return true;
 		}
@@ -262,7 +271,7 @@
 		Xapian::Stem *m_pStemmer;
 		Xapian::Stopper *m_pStopper;
 		string m_allowedPrefixes;
-		set<string> m_termsToAvoid;
+		set<string> *m_pTermsToAvoid;
 
 };
 
@@ -1011,7 +1020,7 @@
 
 			// Get 10 non-prefixed terms
 			string allowedPrefixes("RS");
-			PrefixDecider expandDecider(pIndex, ((stemLanguage.empty() == true) ? NULL : &m_stemmer),
+			TermDecider expandDecider(pIndex, ((stemLanguage.empty() == true) ? NULL : &m_stemmer),
 				FileStopper::get_stopper(Languages::toCode(stemLanguage)),
 				allowedPrefixes, query);
 			Xapian::ESet expandTerms = enquire.get_eset(10, expandDocs, &expandDecider);



From fabricecolin at mail.berlios.de  Mon Dec 29 18:53:28 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 29 Dec 2008 18:53:28 +0100
Subject: [Pinot-svn] r1450 - trunk/IndexSearch/Xapian
Message-ID: <200812291753.mBTHrSKQ023729@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-29 18:53:17 +0100 (Mon, 29 Dec 2008)
New Revision: 1450

Modified:
   trunk/IndexSearch/Xapian/XapianIndex.cpp
Log:
Always add the term XDIR:/.


Modified: trunk/IndexSearch/Xapian/XapianIndex.cpp
===================================================================
--- trunk/IndexSearch/Xapian/XapianIndex.cpp	2008-12-29 17:52:02 UTC (rev 1449)
+++ trunk/IndexSearch/Xapian/XapianIndex.cpp	2008-12-29 17:53:17 UTC (rev 1450)
@@ -609,6 +609,10 @@
 			doc.add_term(string("XPATH:") + XapianDatabase::limitTermLength(Url::escapeUrl(StringManip::toLowerCase(*pathIter)), true));
 		}
 	}
+	else
+	{
+		doc.add_term("XDIR:/");
+	}
 	// ...and the file name with prefix P
 	string fileName(urlObj.getFile());
 	if (fileName.empty() == false)
@@ -755,6 +759,10 @@
 			commonTerms.insert(string("XPATH:") + XapianDatabase::limitTermLength(Url::escapeUrl(StringManip::toLowerCase(*pathIter)), true));
 		}
 	}
+	else
+	{
+		commonTerms.insert("XDIR:/");
+	}
 	// ...and file name
 	string fileName(urlObj.getFile());
 	if (fileName.empty() == false)



From fabricecolin at mail.berlios.de  Mon Dec 29 18:56:44 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 29 Dec 2008 18:56:44 +0100
Subject: [Pinot-svn] r1451 - trunk/UI/GTK2/src
Message-ID: <200812291756.mBTHui7e027246@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-29 18:56:26 +0100 (Mon, 29 Dec 2008)
New Revision: 1451

Modified:
   trunk/UI/GTK2/src/IndexPage.cpp
   trunk/UI/GTK2/src/IndexPage.h
   trunk/UI/GTK2/src/Notebook.cpp
   trunk/UI/GTK2/src/Notebook.h
Log:
Moved the tree in NotebookPageBox.


Modified: trunk/UI/GTK2/src/IndexPage.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexPage.cpp	2008-12-29 17:53:17 UTC (rev 1450)
+++ trunk/UI/GTK2/src/IndexPage.cpp	2008-12-29 17:56:26 UTC (rev 1451)
@@ -35,13 +35,13 @@
 IndexPage::IndexPage(const ustring &indexName, ResultsTree *pTree,
 	PinotSettings &settings) :
 	NotebookPageBox(indexName, NotebookPageBox::INDEX_PAGE, settings),
-	m_pTree(pTree),
 	m_pQueryCombobox(NULL),
 	m_pBackButton(NULL),
 	m_pForwardButton(NULL),
 	m_docsCount(0),
 	m_firstDoc(0)
 {
+	m_pTree = pTree;
 	m_pQueryCombobox = manage(new ComboBoxText());
 
 	Image *image521 = manage(new Image(StockID("gtk-media-rewind"), IconSize(4)));
@@ -157,14 +157,6 @@
 }
 
 //
-// Returns the page's tree.
-//
-ResultsTree *IndexPage::getTree(void) const
-{
-	return m_pTree;
-}
-
-//
 // Returns the name of the current query.
 //
 ustring IndexPage::getQueryName(void) const

Modified: trunk/UI/GTK2/src/IndexPage.h
===================================================================
--- trunk/UI/GTK2/src/IndexPage.h	2008-12-29 17:53:17 UTC (rev 1450)
+++ trunk/UI/GTK2/src/IndexPage.h	2008-12-29 17:56:26 UTC (rev 1451)
@@ -45,9 +45,6 @@
 			PinotSettings &settings);
 		virtual ~IndexPage();
 
-		/// Returns the page's tree.
-		virtual ResultsTree *getTree(void) const;
-
 		/// Returns the name of the current query.
 		Glib::ustring getQueryName(void) const;
 
@@ -81,7 +78,6 @@
 	protected:
 		Glib::ustring m_indexName;
 		Glib::ustring m_queryName;
-		ResultsTree *m_pTree;
 		Gtk::ComboBoxText *m_pQueryCombobox;
 		Gtk::Button *m_pBackButton;
 		Gtk::Button *m_pForwardButton;

Modified: trunk/UI/GTK2/src/Notebook.cpp
===================================================================
--- trunk/UI/GTK2/src/Notebook.cpp	2008-12-29 17:53:17 UTC (rev 1450)
+++ trunk/UI/GTK2/src/Notebook.cpp	2008-12-29 17:56:26 UTC (rev 1451)
@@ -33,7 +33,8 @@
 	VBox(),
 	m_title(title),
 	m_type(type),
-	m_settings(settings)
+	m_settings(settings),
+	m_pTree(NULL)
 {
 }
 
@@ -57,6 +58,14 @@
 	return m_type;
 }
 
+//
+// Returns the page's tree.
+//
+ResultsTree *NotebookPageBox::getTree(void) const
+{
+	return m_pTree;
+}
+
 ResultsPage::ResultsPage(const ustring &queryName, ResultsTree *pTree,
 	int parentHeight, PinotSettings &settings) :
 	NotebookPageBox(queryName, NotebookPageBox::RESULTS_PAGE, settings),
@@ -67,11 +76,11 @@
 	m_pCloseButton(NULL),
 	m_pHBox(NULL),
 	m_pVBox(NULL),
-	m_pVPaned(NULL),
-	m_pTree(pTree)
+	m_pVPaned(NULL)
 {
 	if (pTree != NULL)
 	{
+		m_pTree = pTree;
 		m_pLabel = manage(new Label(_("Did you mean ?")));
 		m_pCombobox = manage(new ComboBoxText());
 		m_pYesButton = manage(new Button(StockID("gtk-yes")));
@@ -145,14 +154,6 @@
 	m_pHBox->hide();
 }
 
-//
-// Returns the page's tree.
-//
-ResultsTree *ResultsPage::getTree(void) const
-{
-	return m_pTree;
-}
-
 // Returns the suggest signal.
 sigc::signal2<void, ustring, ustring>& ResultsPage::getSuggestSignal(void)
 {

Modified: trunk/UI/GTK2/src/Notebook.h
===================================================================
--- trunk/UI/GTK2/src/Notebook.h	2008-12-29 17:53:17 UTC (rev 1450)
+++ trunk/UI/GTK2/src/Notebook.h	2008-12-29 17:56:26 UTC (rev 1451)
@@ -48,10 +48,14 @@
 		/// Returns the page type.
 		PageType getType(void) const;
 
+		/// Returns the page's tree.
+		virtual ResultsTree *getTree(void) const;
+
 	protected:
 		Glib::ustring m_title;
 		PageType m_type;
 		PinotSettings &m_settings;
+		ResultsTree *m_pTree;
 
 };
 
@@ -62,9 +66,6 @@
 			int parentHeight, PinotSettings &settings);
 		virtual ~ResultsPage();
 
-		/// Returns the page's tree.
-		virtual ResultsTree *getTree(void) const;
-
 		/// Returns the suggest signal.
 		sigc::signal2<void, Glib::ustring, Glib::ustring>& getSuggestSignal(void);
 
@@ -80,7 +81,6 @@
 		Gtk::HBox *m_pHBox;
 		Gtk::VBox *m_pVBox;
 		Gtk::VPaned *m_pVPaned;
-		ResultsTree *m_pTree;
 		sigc::signal2<void, Glib::ustring, Glib::ustring> m_signalSuggest;
 		std::set<Glib::ustring> m_suggestions;
 		void onYesButtonClicked();



From fabricecolin at mail.berlios.de  Mon Dec 29 18:59:15 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 29 Dec 2008 18:59:15 +0100
Subject: [Pinot-svn] r1452 - trunk/UI/GTK2/src
Message-ID: <200812291759.mBTHxFc6029087@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-29 18:59:08 +0100 (Mon, 29 Dec 2008)
New Revision: 1452

Modified:
   trunk/UI/GTK2/src/prefsWindow.cc
   trunk/UI/GTK2/src/prefsWindow.hh
   trunk/UI/GTK2/src/prefsWindow_glade.cc
   trunk/UI/GTK2/src/prefsWindow_glade.hh
Log:
Reorded tabs, renamed General to Miscellaneous.


Modified: trunk/UI/GTK2/src/prefsWindow.cc
===================================================================
--- trunk/UI/GTK2/src/prefsWindow.cc	2008-12-29 17:56:26 UTC (rev 1451)
+++ trunk/UI/GTK2/src/prefsWindow.cc	2008-12-29 17:59:08 UTC (rev 1452)
@@ -755,54 +755,6 @@
 	// FIXME: else, disable all buttons or provide some visual feedback, until threads are done
 }
 
-void prefsWindow::on_directConnectionRadiobutton_toggled()
-{
-	bool enabled = proxyRadiobutton->get_active();
-
-	proxyAddressEntry->set_sensitive(enabled);
-	proxyPortSpinbutton->set_sensitive(enabled);
-	proxyTypeCombobox->set_sensitive(enabled);
-}
-
-void prefsWindow::on_addLabelButton_clicked()
-{
-	// Now create a new entry in the labels list
-	TreeModel::iterator iter = m_refLabelsTree->append();
-	TreeModel::Row row = *iter;
-	row[m_labelsColumns.m_name] = to_utf8(_("New Label"));
-	// This marks the label as new
-	row[m_labelsColumns.m_enabled] = false;
-
-	// Enable this button
-	removeLabelButton->set_sensitive(true);
-}
-
-void prefsWindow::on_removeLabelButton_clicked()
-{
-	// Get the selected label in the list
-	TreeModel::iterator iter = labelsTreeview->get_selection()->get_selected();
-	if (iter)
-	{
-		// Unselect
-		labelsTreeview->get_selection()->unselect(iter);
-		// Select another row
-		TreeModel::Path labelPath = m_refLabelsTree->get_path(iter);
-		labelPath.next();
-		labelsTreeview->get_selection()->select(labelPath);
-		// Erase
-		TreeModel::Row row = *iter;
-		m_deletedLabels.insert(from_utf8(row[m_labelsColumns.m_name]));
-		m_refLabelsTree->erase(row);
-
-		TreeModel::Children children = m_refLabelsTree->children();
-		if (children.empty() == true)
-		{
-			// Disable this button
-			removeLabelButton->set_sensitive(false);
-		}
-	}
-}
-
 void prefsWindow::on_addDirectoryButton_clicked()
 {
 	ustring dirName;
@@ -945,6 +897,54 @@
 	populate_patternsTreeview(defaultPatterns, isBlackList);
 }
 
+void prefsWindow::on_addLabelButton_clicked()
+{
+	// Now create a new entry in the labels list
+	TreeModel::iterator iter = m_refLabelsTree->append();
+	TreeModel::Row row = *iter;
+	row[m_labelsColumns.m_name] = to_utf8(_("New Label"));
+	// This marks the label as new
+	row[m_labelsColumns.m_enabled] = false;
+
+	// Enable this button
+	removeLabelButton->set_sensitive(true);
+}
+
+void prefsWindow::on_removeLabelButton_clicked()
+{
+	// Get the selected label in the list
+	TreeModel::iterator iter = labelsTreeview->get_selection()->get_selected();
+	if (iter)
+	{
+		// Unselect
+		labelsTreeview->get_selection()->unselect(iter);
+		// Select another row
+		TreeModel::Path labelPath = m_refLabelsTree->get_path(iter);
+		labelPath.next();
+		labelsTreeview->get_selection()->select(labelPath);
+		// Erase
+		TreeModel::Row row = *iter;
+		m_deletedLabels.insert(from_utf8(row[m_labelsColumns.m_name]));
+		m_refLabelsTree->erase(row);
+
+		TreeModel::Children children = m_refLabelsTree->children();
+		if (children.empty() == true)
+		{
+			// Disable this button
+			removeLabelButton->set_sensitive(false);
+		}
+	}
+}
+
+void prefsWindow::on_directConnectionRadiobutton_toggled()
+{
+	bool enabled = proxyRadiobutton->get_active();
+
+	proxyAddressEntry->set_sensitive(enabled);
+	proxyPortSpinbutton->set_sensitive(enabled);
+	proxyTypeCombobox->set_sensitive(enabled);
+}
+
 bool prefsWindow::on_prefsWindow_delete_event(GdkEventAny *ev)
 {
 	// Any thread still running ?

Modified: trunk/UI/GTK2/src/prefsWindow.hh
===================================================================
--- trunk/UI/GTK2/src/prefsWindow.hh	2008-12-29 17:56:26 UTC (rev 1451)
+++ trunk/UI/GTK2/src/prefsWindow.hh	2008-12-29 17:59:08 UTC (rev 1452)
@@ -65,15 +65,15 @@
 
 	virtual void on_prefsCancelbutton_clicked();
 	virtual void on_prefsOkbutton_clicked();
-	virtual void on_directConnectionRadiobutton_toggled();
-	virtual void on_addLabelButton_clicked();
-	virtual void on_removeLabelButton_clicked();
 	virtual void on_addDirectoryButton_clicked();
 	virtual void on_removeDirectoryButton_clicked();
 	virtual void on_patternsCombobox_changed();
 	virtual void on_addPatternButton_clicked();
 	virtual void on_removePatternButton_clicked();
 	virtual void on_resetPatternsButton_clicked();
+	virtual void on_addLabelButton_clicked();
+	virtual void on_removeLabelButton_clicked();
+	virtual void on_directConnectionRadiobutton_toggled();
 	virtual bool on_prefsWindow_delete_event(GdkEventAny *ev);
 
 	void on_thread_end(WorkerThread *pThread);

Modified: trunk/UI/GTK2/src/prefsWindow_glade.cc
===================================================================
--- trunk/UI/GTK2/src/prefsWindow_glade.cc	2008-12-29 17:56:26 UTC (rev 1451)
+++ trunk/UI/GTK2/src/prefsWindow_glade.cc	2008-12-29 17:59:08 UTC (rev 1452)
@@ -1,9 +1,9 @@
-// generated 2008/11/18 23:24:22 SGT by fabrice at rexor.dyndns.org.(none)
+// generated 2008/12/27 19:39:02 SGT by fabrice at rexor.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.12.12 and gtkmm 2.12.7
+// for gtk 2.14.5 and gtkmm 2.14.3
 //
 // Please modify the corresponding derived classes in ./src/prefsWindow.cc
 
@@ -38,13 +38,13 @@
 #include <gtkmm/accelgroup.h>
 #include <gtkmm/buttonbox.h>
 #include <gtkmm/label.h>
-#include <gtkmm/radiobutton.h>
-#include <gtkmm/adjustment.h>
-#include <gtkmm/table.h>
 #include <gtkmm/scrolledwindow.h>
 #include <gtkmm/image.h>
 #include <gtkmm/box.h>
 #include <gtkmm/alignment.h>
+#include <gtkmm/radiobutton.h>
+#include <gtkmm/adjustment.h>
+#include <gtkmm/table.h>
 #ifndef ENABLE_NLS
 #  define textdomain(String) (String)
 #  define gettext(String) (String)
@@ -66,55 +66,6 @@
    prefsOkbutton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-ok")));
    
    Gtk::HButtonBox *hbuttonbox1 = Gtk::manage(new class Gtk::HButtonBox(Gtk::BUTTONBOX_END, 0));
-   apiKeyLabel = Gtk::manage(new class Gtk::Label(_("Google API key:")));
-   apiKeyEntry = Gtk::manage(new class Gtk::Entry());
-   
-   Gtk::Label *queriesLabel = Gtk::manage(new class Gtk::Label(_("Queries:")));
-   enableCompletionCheckbutton = Gtk::manage(new class Gtk::CheckButton(_("Enable search terms suggestion")));
-   newResultsColorbutton = Gtk::manage(new class Gtk::ColorButton());
-   ignoreRobotsCheckbutton = Gtk::manage(new class Gtk::CheckButton(_("Ignore robots.txt and Robots META tag")));
-   robotsLabels = Gtk::manage(new class Gtk::Label(_("HTTP crawling:")));
-   
-   Gtk::Label *newResultsLabel = Gtk::manage(new class Gtk::Label(_("New results:")));
-   generalTable = Gtk::manage(new class Gtk::Table(2, 2, false));
-   
-   Gtk::Label *label65 = Gtk::manage(new class Gtk::Label(_("General")));
-   Gtk::RadioButton::Group _RadioBGroup_directConnectionRadiobutton;
-   directConnectionRadiobutton = Gtk::manage(new class Gtk::RadioButton(_RadioBGroup_directConnectionRadiobutton, _("Direct connection to the Internet")));
-   proxyRadiobutton = Gtk::manage(new class Gtk::RadioButton(_RadioBGroup_directConnectionRadiobutton, _("Manual proxy configuration:")));
-   
-   Gtk::Label *proxyAddressLabel = Gtk::manage(new class Gtk::Label(_("Address:")));
-   proxyAddressEntry = Gtk::manage(new class Gtk::Entry());
-   
-   Gtk::Label *proxyTypeLabel = Gtk::manage(new class Gtk::Label(_("Type:")));
-   Gtk::Label *proxyPortLabel = Gtk::manage(new class Gtk::Label(_("Port:")));
-   Gtk::Adjustment *proxyPortSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(80, 1, 65535, 1, 10, 0));
-   proxyPortSpinbutton = Gtk::manage(new class Gtk::SpinButton(*proxyPortSpinbutton_adj, 1, 0));
-   proxyTypeCombobox = Gtk::manage(new class Gtk::ComboBoxText());
-   
-   Gtk::Table *table3 = Gtk::manage(new class Gtk::Table(2, 2, false));
-   Gtk::Table *table2 = Gtk::manage(new class Gtk::Table(2, 2, false));
-   Gtk::Label *label69 = Gtk::manage(new class Gtk::Label(_("Network")));
-   Gtk::Label *indexLabelsLabel = Gtk::manage(new class Gtk::Label(_("Labels are used to classify indexed documents:")));
-   labelsTreeview = Gtk::manage(new class Gtk::TreeView());
-   
-   Gtk::ScrolledWindow *scrolledwindow1 = Gtk::manage(new class Gtk::ScrolledWindow());
-   Gtk::Image *image725 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-add"), Gtk::IconSize(4)));
-   Gtk::Label *label71 = Gtk::manage(new class Gtk::Label(_("Add")));
-   Gtk::HBox *hbox58 = Gtk::manage(new class Gtk::HBox(false, 2));
-   Gtk::Alignment *alignment37 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
-   addLabelButton = Gtk::manage(new class Gtk::Button());
-   
-   Gtk::Image *image726 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-remove"), Gtk::IconSize(4)));
-   Gtk::Label *label72 = Gtk::manage(new class Gtk::Label(_("Remove")));
-   Gtk::HBox *hbox59 = Gtk::manage(new class Gtk::HBox(false, 2));
-   Gtk::Alignment *alignment38 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
-   removeLabelButton = Gtk::manage(new class Gtk::Button());
-   
-   Gtk::VButtonBox *vbuttonbox1 = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
-   Gtk::HBox *hbox57 = Gtk::manage(new class Gtk::HBox(false, 0));
-   Gtk::VBox *vbox2 = Gtk::manage(new class Gtk::VBox(false, 0));
-   Gtk::Label *label73 = Gtk::manage(new class Gtk::Label(_("Labels")));
    Gtk::Label *directoriesLabel = Gtk::manage(new class Gtk::Label(_("These directories will be indexed and optionally monitored for changes:")));
    directoriesTreeview = Gtk::manage(new class Gtk::TreeView());
    
@@ -146,7 +97,56 @@
    Gtk::VButtonBox *vbuttonbox3 = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
    Gtk::HBox *hbox62 = Gtk::manage(new class Gtk::HBox(false, 0));
    Gtk::VBox *vbox3 = Gtk::manage(new class Gtk::VBox(false, 0));
-   Gtk::Label *label78 = Gtk::manage(new class Gtk::Label(_("Indexing")));
+   Gtk::Label *indexingLabel = Gtk::manage(new class Gtk::Label(_("Indexing")));
+   Gtk::Label *indexLabelsLabel = Gtk::manage(new class Gtk::Label(_("Labels are used to classify indexed documents:")));
+   labelsTreeview = Gtk::manage(new class Gtk::TreeView());
+   
+   Gtk::ScrolledWindow *scrolledwindow1 = Gtk::manage(new class Gtk::ScrolledWindow());
+   Gtk::Image *image725 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-add"), Gtk::IconSize(4)));
+   Gtk::Label *label71 = Gtk::manage(new class Gtk::Label(_("Add")));
+   Gtk::HBox *hbox58 = Gtk::manage(new class Gtk::HBox(false, 2));
+   Gtk::Alignment *alignment37 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
+   addLabelButton = Gtk::manage(new class Gtk::Button());
+   
+   Gtk::Image *image726 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-remove"), Gtk::IconSize(4)));
+   Gtk::Label *label72 = Gtk::manage(new class Gtk::Label(_("Remove")));
+   Gtk::HBox *hbox59 = Gtk::manage(new class Gtk::HBox(false, 2));
+   Gtk::Alignment *alignment38 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
+   removeLabelButton = Gtk::manage(new class Gtk::Button());
+   
+   Gtk::VButtonBox *vbuttonbox1 = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
+   Gtk::HBox *hbox57 = Gtk::manage(new class Gtk::HBox(false, 0));
+   Gtk::VBox *vbox2 = Gtk::manage(new class Gtk::VBox(false, 0));
+   Gtk::Label *labelsLabel = Gtk::manage(new class Gtk::Label(_("Labels")));
+   Gtk::RadioButton::Group _RadioBGroup_directConnectionRadiobutton;
+   directConnectionRadiobutton = Gtk::manage(new class Gtk::RadioButton(_RadioBGroup_directConnectionRadiobutton, _("Direct connection to the Internet")));
+   proxyRadiobutton = Gtk::manage(new class Gtk::RadioButton(_RadioBGroup_directConnectionRadiobutton, _("Manual proxy configuration:")));
+   
+   Gtk::Label *proxyAddressLabel = Gtk::manage(new class Gtk::Label(_("Address:")));
+   proxyAddressEntry = Gtk::manage(new class Gtk::Entry());
+   
+   Gtk::Label *proxyTypeLabel = Gtk::manage(new class Gtk::Label(_("Type:")));
+   Gtk::Label *proxyPortLabel = Gtk::manage(new class Gtk::Label(_("Port:")));
+   Gtk::Adjustment *proxyPortSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(80, 1, 65535, 1, 10, 0));
+   proxyPortSpinbutton = Gtk::manage(new class Gtk::SpinButton(*proxyPortSpinbutton_adj, 1, 0));
+   proxyTypeCombobox = Gtk::manage(new class Gtk::ComboBoxText());
+   
+   Gtk::Table *table3 = Gtk::manage(new class Gtk::Table(2, 2, false));
+   Gtk::Table *table2 = Gtk::manage(new class Gtk::Table(2, 2, false));
+   Gtk::Label *networkLabel = Gtk::manage(new class Gtk::Label(_("Network")));
+   apiKeyLabel = Gtk::manage(new class Gtk::Label(_("Google API key:")));
+   apiKeyEntry = Gtk::manage(new class Gtk::Entry());
+   
+   Gtk::Label *queriesLabel = Gtk::manage(new class Gtk::Label(_("Queries:")));
+   enableCompletionCheckbutton = Gtk::manage(new class Gtk::CheckButton(_("Enable search terms suggestion")));
+   newResultsColorbutton = Gtk::manage(new class Gtk::ColorButton());
+   ignoreRobotsCheckbutton = Gtk::manage(new class Gtk::CheckButton(_("Ignore robots.txt and Robots META tag")));
+   robotsLabels = Gtk::manage(new class Gtk::Label(_("HTTP crawling:")));
+   
+   Gtk::Label *newResultsLabel = Gtk::manage(new class Gtk::Label(_("New results:")));
+   generalTable = Gtk::manage(new class Gtk::Table(2, 2, false));
+   
+   Gtk::Label *miscLabel = Gtk::manage(new class Gtk::Label(_("Miscellaneous")));
    prefsNotebook = Gtk::manage(new class Gtk::Notebook());
    
    Gtk::VBox *vbox1 = Gtk::manage(new class Gtk::VBox(false, 0));
@@ -161,232 +161,6 @@
    hbuttonbox1->property_layout_style().set_value(Gtk::BUTTONBOX_END);
    hbuttonbox1->pack_start(*prefsCancelbutton);
    hbuttonbox1->pack_start(*prefsOkbutton);
-   apiKeyLabel->set_alignment(0,0.5);
-   apiKeyLabel->set_padding(4,4);
-   apiKeyLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   apiKeyLabel->set_line_wrap(false);
-   apiKeyLabel->set_use_markup(false);
-   apiKeyLabel->set_selectable(false);
-   apiKeyLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   apiKeyLabel->set_width_chars(-1);
-   apiKeyLabel->set_angle(0);
-   apiKeyLabel->set_single_line_mode(false);
-   apiKeyEntry->set_flags(Gtk::CAN_FOCUS);
-   apiKeyEntry->set_visibility(true);
-   apiKeyEntry->set_editable(true);
-   apiKeyEntry->set_max_length(0);
-   apiKeyEntry->set_text("");
-   apiKeyEntry->set_has_frame(true);
-   apiKeyEntry->set_activates_default(false);
-   queriesLabel->set_alignment(0,0.5);
-   queriesLabel->set_padding(4,4);
-   queriesLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   queriesLabel->set_line_wrap(false);
-   queriesLabel->set_use_markup(false);
-   queriesLabel->set_selectable(false);
-   queriesLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   queriesLabel->set_width_chars(-1);
-   queriesLabel->set_angle(0);
-   queriesLabel->set_single_line_mode(false);
-   enableCompletionCheckbutton->set_flags(Gtk::CAN_FOCUS);
-   enableCompletionCheckbutton->set_relief(Gtk::RELIEF_NORMAL);
-   enableCompletionCheckbutton->set_mode(true);
-   enableCompletionCheckbutton->set_active(false);
-   newResultsColorbutton->set_flags(Gtk::CAN_FOCUS);
-   ignoreRobotsCheckbutton->set_flags(Gtk::CAN_FOCUS);
-   ignoreRobotsCheckbutton->set_relief(Gtk::RELIEF_NORMAL);
-   ignoreRobotsCheckbutton->set_mode(true);
-   ignoreRobotsCheckbutton->set_active(false);
-   robotsLabels->set_alignment(0,0.5);
-   robotsLabels->set_padding(4,4);
-   robotsLabels->set_justify(Gtk::JUSTIFY_LEFT);
-   robotsLabels->set_line_wrap(false);
-   robotsLabels->set_use_markup(false);
-   robotsLabels->set_selectable(false);
-   robotsLabels->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   robotsLabels->set_width_chars(-1);
-   robotsLabels->set_angle(0);
-   robotsLabels->set_single_line_mode(false);
-   newResultsLabel->set_alignment(0,0.5);
-   newResultsLabel->set_padding(4,4);
-   newResultsLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   newResultsLabel->set_line_wrap(false);
-   newResultsLabel->set_use_markup(false);
-   newResultsLabel->set_selectable(false);
-   newResultsLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   newResultsLabel->set_width_chars(-1);
-   newResultsLabel->set_angle(0);
-   newResultsLabel->set_single_line_mode(false);
-   generalTable->set_row_spacings(0);
-   generalTable->set_col_spacings(0);
-   generalTable->attach(*apiKeyLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 0, 0);
-   generalTable->attach(*apiKeyEntry, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   generalTable->attach(*queriesLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 0, 0);
-   generalTable->attach(*enableCompletionCheckbutton, 1, 2, 2, 3, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   generalTable->attach(*newResultsColorbutton, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   generalTable->attach(*ignoreRobotsCheckbutton, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   generalTable->attach(*robotsLabels, 0, 1, 0, 1, Gtk::FILL, Gtk::AttachOptions(), 0, 0);
-   generalTable->attach(*newResultsLabel, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 0, 0);
-   label65->set_alignment(0.5,0.5);
-   label65->set_padding(0,0);
-   label65->set_justify(Gtk::JUSTIFY_LEFT);
-   label65->set_line_wrap(false);
-   label65->set_use_markup(false);
-   label65->set_selectable(false);
-   label65->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   label65->set_width_chars(-1);
-   label65->set_angle(0);
-   label65->set_single_line_mode(false);
-   directConnectionRadiobutton->set_flags(Gtk::CAN_FOCUS);
-   directConnectionRadiobutton->set_relief(Gtk::RELIEF_NORMAL);
-   directConnectionRadiobutton->set_mode(true);
-   directConnectionRadiobutton->set_active(true);
-   proxyRadiobutton->set_flags(Gtk::CAN_FOCUS);
-   proxyRadiobutton->set_relief(Gtk::RELIEF_NORMAL);
-   proxyRadiobutton->set_mode(true);
-   proxyRadiobutton->set_active(false);
-   proxyAddressLabel->set_alignment(0,0.5);
-   proxyAddressLabel->set_padding(0,0);
-   proxyAddressLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   proxyAddressLabel->set_line_wrap(false);
-   proxyAddressLabel->set_use_markup(false);
-   proxyAddressLabel->set_selectable(false);
-   proxyAddressLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   proxyAddressLabel->set_width_chars(-1);
-   proxyAddressLabel->set_angle(0);
-   proxyAddressLabel->set_single_line_mode(false);
-   proxyAddressEntry->set_flags(Gtk::CAN_FOCUS);
-   proxyAddressEntry->set_visibility(true);
-   proxyAddressEntry->set_editable(true);
-   proxyAddressEntry->set_max_length(0);
-   proxyAddressEntry->set_text("");
-   proxyAddressEntry->set_has_frame(true);
-   proxyAddressEntry->set_activates_default(false);
-   proxyTypeLabel->set_alignment(0,0.5);
-   proxyTypeLabel->set_padding(0,0);
-   proxyTypeLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   proxyTypeLabel->set_line_wrap(false);
-   proxyTypeLabel->set_use_markup(false);
-   proxyTypeLabel->set_selectable(false);
-   proxyTypeLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   proxyTypeLabel->set_width_chars(-1);
-   proxyTypeLabel->set_angle(0);
-   proxyTypeLabel->set_single_line_mode(false);
-   proxyPortLabel->set_alignment(0,0.5);
-   proxyPortLabel->set_padding(0,0);
-   proxyPortLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   proxyPortLabel->set_line_wrap(false);
-   proxyPortLabel->set_use_markup(false);
-   proxyPortLabel->set_selectable(false);
-   proxyPortLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   proxyPortLabel->set_width_chars(-1);
-   proxyPortLabel->set_angle(0);
-   proxyPortLabel->set_single_line_mode(false);
-   proxyPortSpinbutton->set_flags(Gtk::CAN_FOCUS);
-   proxyPortSpinbutton->set_update_policy(Gtk::UPDATE_ALWAYS);
-   proxyPortSpinbutton->set_numeric(false);
-   proxyPortSpinbutton->set_digits(0);
-   proxyPortSpinbutton->set_wrap(false);
-   table3->set_row_spacings(0);
-   table3->set_col_spacings(0);
-   table3->attach(*proxyAddressLabel, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 4, 4);
-   table3->attach(*proxyAddressEntry, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   table3->attach(*proxyTypeLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 4, 4);
-   table3->attach(*proxyPortLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 4, 4);
-   table3->attach(*proxyPortSpinbutton, 1, 2, 2, 3, Gtk::EXPAND|Gtk::FILL, Gtk::AttachOptions(), 4, 4);
-   table3->attach(*proxyTypeCombobox, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::AttachOptions(), 4, 4);
-   table2->set_row_spacings(0);
-   table2->set_col_spacings(0);
-   table2->attach(*directConnectionRadiobutton, 0, 1, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   table2->attach(*proxyRadiobutton, 0, 1, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   table2->attach(*table3, 0, 1, 2, 3, Gtk::FILL, Gtk::EXPAND|Gtk::FILL, 0, 0);
-   label69->set_alignment(0.5,0.5);
-   label69->set_padding(0,0);
-   label69->set_justify(Gtk::JUSTIFY_LEFT);
-   label69->set_line_wrap(false);
-   label69->set_use_markup(false);
-   label69->set_selectable(false);
-   label69->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   label69->set_width_chars(-1);
-   label69->set_angle(0);
-   label69->set_single_line_mode(false);
-   indexLabelsLabel->set_alignment(0,0.5);
-   indexLabelsLabel->set_padding(4,4);
-   indexLabelsLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   indexLabelsLabel->set_line_wrap(true);
-   indexLabelsLabel->set_use_markup(false);
-   indexLabelsLabel->set_selectable(false);
-   indexLabelsLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   indexLabelsLabel->set_width_chars(-1);
-   indexLabelsLabel->set_angle(0);
-   indexLabelsLabel->set_single_line_mode(false);
-   labelsTreeview->set_flags(Gtk::CAN_FOCUS);
-   labelsTreeview->set_headers_visible(true);
-   labelsTreeview->set_rules_hint(false);
-   labelsTreeview->set_reorderable(false);
-   labelsTreeview->set_enable_search(true);
-   scrolledwindow1->set_flags(Gtk::CAN_FOCUS);
-   scrolledwindow1->set_border_width(4);
-   scrolledwindow1->set_shadow_type(Gtk::SHADOW_NONE);
-   scrolledwindow1->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
-   scrolledwindow1->property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
-   scrolledwindow1->add(*labelsTreeview);
-   image725->set_alignment(0.5,0.5);
-   image725->set_padding(0,0);
-   label71->set_alignment(0.5,0.5);
-   label71->set_padding(0,0);
-   label71->set_justify(Gtk::JUSTIFY_LEFT);
-   label71->set_line_wrap(false);
-   label71->set_use_markup(false);
-   label71->set_selectable(false);
-   label71->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   label71->set_width_chars(-1);
-   label71->set_angle(0);
-   label71->set_single_line_mode(false);
-   hbox58->pack_start(*image725, Gtk::PACK_SHRINK, 0);
-   hbox58->pack_start(*label71, Gtk::PACK_SHRINK, 0);
-   alignment37->add(*hbox58);
-   addLabelButton->set_flags(Gtk::CAN_FOCUS);
-   addLabelButton->set_flags(Gtk::CAN_DEFAULT);
-   addLabelButton->set_border_width(4);
-   addLabelButton->set_relief(Gtk::RELIEF_NORMAL);
-   addLabelButton->add(*alignment37);
-   image726->set_alignment(0.5,0.5);
-   image726->set_padding(0,0);
-   label72->set_alignment(0.5,0.5);
-   label72->set_padding(0,0);
-   label72->set_justify(Gtk::JUSTIFY_LEFT);
-   label72->set_line_wrap(false);
-   label72->set_use_markup(false);
-   label72->set_selectable(false);
-   label72->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   label72->set_width_chars(-1);
-   label72->set_angle(0);
-   label72->set_single_line_mode(false);
-   hbox59->pack_start(*image726, Gtk::PACK_SHRINK, 0);
-   hbox59->pack_start(*label72, Gtk::PACK_SHRINK, 0);
-   alignment38->add(*hbox59);
-   removeLabelButton->set_flags(Gtk::CAN_FOCUS);
-   removeLabelButton->set_flags(Gtk::CAN_DEFAULT);
-   removeLabelButton->set_border_width(4);
-   removeLabelButton->set_relief(Gtk::RELIEF_NORMAL);
-   removeLabelButton->add(*alignment38);
-   vbuttonbox1->pack_start(*addLabelButton);
-   vbuttonbox1->pack_start(*removeLabelButton);
-   hbox57->pack_start(*scrolledwindow1);
-   hbox57->pack_start(*vbuttonbox1, Gtk::PACK_SHRINK, 0);
-   vbox2->pack_start(*indexLabelsLabel, Gtk::PACK_SHRINK, 4);
-   vbox2->pack_start(*hbox57, Gtk::PACK_EXPAND_WIDGET, 4);
-   label73->set_alignment(0.5,0.5);
-   label73->set_padding(0,0);
-   label73->set_justify(Gtk::JUSTIFY_LEFT);
-   label73->set_line_wrap(false);
-   label73->set_use_markup(false);
-   label73->set_selectable(false);
-   label73->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   label73->set_width_chars(-1);
-   label73->set_angle(0);
-   label73->set_single_line_mode(false);
    directoriesLabel->set_alignment(0,0.5);
    directoriesLabel->set_padding(4,4);
    directoriesLabel->set_justify(Gtk::JUSTIFY_LEFT);
@@ -496,28 +270,252 @@
    vbox3->pack_start(*hbox60, Gtk::PACK_EXPAND_WIDGET, 4);
    vbox3->pack_start(*label76, Gtk::PACK_SHRINK, 4);
    vbox3->pack_start(*hbox62, Gtk::PACK_EXPAND_WIDGET, 4);
-   label78->set_alignment(0.5,0.5);
-   label78->set_padding(0,0);
-   label78->set_justify(Gtk::JUSTIFY_LEFT);
-   label78->set_line_wrap(false);
-   label78->set_use_markup(false);
-   label78->set_selectable(false);
-   label78->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   label78->set_width_chars(-1);
-   label78->set_angle(0);
-   label78->set_single_line_mode(false);
+   indexingLabel->set_alignment(0.5,0.5);
+   indexingLabel->set_padding(0,0);
+   indexingLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   indexingLabel->set_line_wrap(false);
+   indexingLabel->set_use_markup(false);
+   indexingLabel->set_selectable(false);
+   indexingLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   indexingLabel->set_width_chars(-1);
+   indexingLabel->set_angle(0);
+   indexingLabel->set_single_line_mode(false);
+   indexLabelsLabel->set_alignment(0,0.5);
+   indexLabelsLabel->set_padding(4,4);
+   indexLabelsLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   indexLabelsLabel->set_line_wrap(true);
+   indexLabelsLabel->set_use_markup(false);
+   indexLabelsLabel->set_selectable(false);
+   indexLabelsLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   indexLabelsLabel->set_width_chars(-1);
+   indexLabelsLabel->set_angle(0);
+   indexLabelsLabel->set_single_line_mode(false);
+   labelsTreeview->set_flags(Gtk::CAN_FOCUS);
+   labelsTreeview->set_headers_visible(true);
+   labelsTreeview->set_rules_hint(false);
+   labelsTreeview->set_reorderable(false);
+   labelsTreeview->set_enable_search(true);
+   scrolledwindow1->set_flags(Gtk::CAN_FOCUS);
+   scrolledwindow1->set_border_width(4);
+   scrolledwindow1->set_shadow_type(Gtk::SHADOW_NONE);
+   scrolledwindow1->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
+   scrolledwindow1->property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
+   scrolledwindow1->add(*labelsTreeview);
+   image725->set_alignment(0.5,0.5);
+   image725->set_padding(0,0);
+   label71->set_alignment(0.5,0.5);
+   label71->set_padding(0,0);
+   label71->set_justify(Gtk::JUSTIFY_LEFT);
+   label71->set_line_wrap(false);
+   label71->set_use_markup(false);
+   label71->set_selectable(false);
+   label71->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   label71->set_width_chars(-1);
+   label71->set_angle(0);
+   label71->set_single_line_mode(false);
+   hbox58->pack_start(*image725, Gtk::PACK_SHRINK, 0);
+   hbox58->pack_start(*label71, Gtk::PACK_SHRINK, 0);
+   alignment37->add(*hbox58);
+   addLabelButton->set_flags(Gtk::CAN_FOCUS);
+   addLabelButton->set_flags(Gtk::CAN_DEFAULT);
+   addLabelButton->set_border_width(4);
+   addLabelButton->set_relief(Gtk::RELIEF_NORMAL);
+   addLabelButton->add(*alignment37);
+   image726->set_alignment(0.5,0.5);
+   image726->set_padding(0,0);
+   label72->set_alignment(0.5,0.5);
+   label72->set_padding(0,0);
+   label72->set_justify(Gtk::JUSTIFY_LEFT);
+   label72->set_line_wrap(false);
+   label72->set_use_markup(false);
+   label72->set_selectable(false);
+   label72->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   label72->set_width_chars(-1);
+   label72->set_angle(0);
+   label72->set_single_line_mode(false);
+   hbox59->pack_start(*image726, Gtk::PACK_SHRINK, 0);
+   hbox59->pack_start(*label72, Gtk::PACK_SHRINK, 0);
+   alignment38->add(*hbox59);
+   removeLabelButton->set_flags(Gtk::CAN_FOCUS);
+   removeLabelButton->set_flags(Gtk::CAN_DEFAULT);
+   removeLabelButton->set_border_width(4);
+   removeLabelButton->set_relief(Gtk::RELIEF_NORMAL);
+   removeLabelButton->add(*alignment38);
+   vbuttonbox1->pack_start(*addLabelButton);
+   vbuttonbox1->pack_start(*removeLabelButton);
+   hbox57->pack_start(*scrolledwindow1);
+   hbox57->pack_start(*vbuttonbox1, Gtk::PACK_SHRINK, 0);
+   vbox2->pack_start(*indexLabelsLabel, Gtk::PACK_SHRINK, 4);
+   vbox2->pack_start(*hbox57, Gtk::PACK_EXPAND_WIDGET, 4);
+   labelsLabel->set_alignment(0.5,0.5);
+   labelsLabel->set_padding(0,0);
+   labelsLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   labelsLabel->set_line_wrap(false);
+   labelsLabel->set_use_markup(false);
+   labelsLabel->set_selectable(false);
+   labelsLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   labelsLabel->set_width_chars(-1);
+   labelsLabel->set_angle(0);
+   labelsLabel->set_single_line_mode(false);
+   directConnectionRadiobutton->set_flags(Gtk::CAN_FOCUS);
+   directConnectionRadiobutton->set_relief(Gtk::RELIEF_NORMAL);
+   directConnectionRadiobutton->set_mode(true);
+   directConnectionRadiobutton->set_active(true);
+   proxyRadiobutton->set_flags(Gtk::CAN_FOCUS);
+   proxyRadiobutton->set_relief(Gtk::RELIEF_NORMAL);
+   proxyRadiobutton->set_mode(true);
+   proxyRadiobutton->set_active(false);
+   proxyAddressLabel->set_alignment(0,0.5);
+   proxyAddressLabel->set_padding(0,0);
+   proxyAddressLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   proxyAddressLabel->set_line_wrap(false);
+   proxyAddressLabel->set_use_markup(false);
+   proxyAddressLabel->set_selectable(false);
+   proxyAddressLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   proxyAddressLabel->set_width_chars(-1);
+   proxyAddressLabel->set_angle(0);
+   proxyAddressLabel->set_single_line_mode(false);
+   proxyAddressEntry->set_flags(Gtk::CAN_FOCUS);
+   proxyAddressEntry->set_visibility(true);
+   proxyAddressEntry->set_editable(true);
+   proxyAddressEntry->set_max_length(0);
+   proxyAddressEntry->set_has_frame(true);
+   proxyAddressEntry->set_activates_default(false);
+   proxyTypeLabel->set_alignment(0,0.5);
+   proxyTypeLabel->set_padding(0,0);
+   proxyTypeLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   proxyTypeLabel->set_line_wrap(false);
+   proxyTypeLabel->set_use_markup(false);
+   proxyTypeLabel->set_selectable(false);
+   proxyTypeLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   proxyTypeLabel->set_width_chars(-1);
+   proxyTypeLabel->set_angle(0);
+   proxyTypeLabel->set_single_line_mode(false);
+   proxyPortLabel->set_alignment(0,0.5);
+   proxyPortLabel->set_padding(0,0);
+   proxyPortLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   proxyPortLabel->set_line_wrap(false);
+   proxyPortLabel->set_use_markup(false);
+   proxyPortLabel->set_selectable(false);
+   proxyPortLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   proxyPortLabel->set_width_chars(-1);
+   proxyPortLabel->set_angle(0);
+   proxyPortLabel->set_single_line_mode(false);
+   proxyPortSpinbutton->set_flags(Gtk::CAN_FOCUS);
+   proxyPortSpinbutton->set_update_policy(Gtk::UPDATE_ALWAYS);
+   proxyPortSpinbutton->set_numeric(false);
+   proxyPortSpinbutton->set_digits(0);
+   proxyPortSpinbutton->set_wrap(false);
+   table3->set_row_spacings(0);
+   table3->set_col_spacings(0);
+   table3->attach(*proxyAddressLabel, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 4, 4);
+   table3->attach(*proxyAddressEntry, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   table3->attach(*proxyTypeLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 4, 4);
+   table3->attach(*proxyPortLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 4, 4);
+   table3->attach(*proxyPortSpinbutton, 1, 2, 2, 3, Gtk::EXPAND|Gtk::FILL, Gtk::AttachOptions(), 4, 4);
+   table3->attach(*proxyTypeCombobox, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::AttachOptions(), 4, 4);
+   table2->set_row_spacings(0);
+   table2->set_col_spacings(0);
+   table2->attach(*directConnectionRadiobutton, 0, 1, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   table2->attach(*proxyRadiobutton, 0, 1, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   table2->attach(*table3, 0, 1, 2, 3, Gtk::FILL, Gtk::EXPAND|Gtk::FILL, 0, 0);
+   networkLabel->set_alignment(0.5,0.5);
+   networkLabel->set_padding(0,0);
+   networkLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   networkLabel->set_line_wrap(false);
+   networkLabel->set_use_markup(false);
+   networkLabel->set_selectable(false);
+   networkLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   networkLabel->set_width_chars(-1);
+   networkLabel->set_angle(0);
+   networkLabel->set_single_line_mode(false);
+   apiKeyLabel->set_alignment(0,0.5);
+   apiKeyLabel->set_padding(4,4);
+   apiKeyLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   apiKeyLabel->set_line_wrap(false);
+   apiKeyLabel->set_use_markup(false);
+   apiKeyLabel->set_selectable(false);
+   apiKeyLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   apiKeyLabel->set_width_chars(-1);
+   apiKeyLabel->set_angle(0);
+   apiKeyLabel->set_single_line_mode(false);
+   apiKeyEntry->set_flags(Gtk::CAN_FOCUS);
+   apiKeyEntry->set_visibility(true);
+   apiKeyEntry->set_editable(true);
+   apiKeyEntry->set_max_length(0);
+   apiKeyEntry->set_has_frame(true);
+   apiKeyEntry->set_activates_default(false);
+   queriesLabel->set_alignment(0,0.5);
+   queriesLabel->set_padding(4,4);
+   queriesLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   queriesLabel->set_line_wrap(false);
+   queriesLabel->set_use_markup(false);
+   queriesLabel->set_selectable(false);
+   queriesLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   queriesLabel->set_width_chars(-1);
+   queriesLabel->set_angle(0);
+   queriesLabel->set_single_line_mode(false);
+   enableCompletionCheckbutton->set_flags(Gtk::CAN_FOCUS);
+   enableCompletionCheckbutton->set_relief(Gtk::RELIEF_NORMAL);
+   enableCompletionCheckbutton->set_mode(true);
+   enableCompletionCheckbutton->set_active(false);
+   newResultsColorbutton->set_flags(Gtk::CAN_FOCUS);
+   ignoreRobotsCheckbutton->set_flags(Gtk::CAN_FOCUS);
+   ignoreRobotsCheckbutton->set_relief(Gtk::RELIEF_NORMAL);
+   ignoreRobotsCheckbutton->set_mode(true);
+   ignoreRobotsCheckbutton->set_active(false);
+   robotsLabels->set_alignment(0,0.5);
+   robotsLabels->set_padding(4,4);
+   robotsLabels->set_justify(Gtk::JUSTIFY_LEFT);
+   robotsLabels->set_line_wrap(false);
+   robotsLabels->set_use_markup(false);
+   robotsLabels->set_selectable(false);
+   robotsLabels->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   robotsLabels->set_width_chars(-1);
+   robotsLabels->set_angle(0);
+   robotsLabels->set_single_line_mode(false);
+   newResultsLabel->set_alignment(0,0.5);
+   newResultsLabel->set_padding(4,4);
+   newResultsLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   newResultsLabel->set_line_wrap(false);
+   newResultsLabel->set_use_markup(false);
+   newResultsLabel->set_selectable(false);
+   newResultsLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   newResultsLabel->set_width_chars(-1);
+   newResultsLabel->set_angle(0);
+   newResultsLabel->set_single_line_mode(false);
+   generalTable->set_row_spacings(0);
+   generalTable->set_col_spacings(0);
+   generalTable->attach(*apiKeyLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 0, 0);
+   generalTable->attach(*apiKeyEntry, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   generalTable->attach(*queriesLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 0, 0);
+   generalTable->attach(*enableCompletionCheckbutton, 1, 2, 2, 3, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   generalTable->attach(*newResultsColorbutton, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   generalTable->attach(*ignoreRobotsCheckbutton, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   generalTable->attach(*robotsLabels, 0, 1, 0, 1, Gtk::FILL, Gtk::AttachOptions(), 0, 0);
+   generalTable->attach(*newResultsLabel, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 0, 0);
+   miscLabel->set_alignment(0.5,0.5);
+   miscLabel->set_padding(0,0);
+   miscLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   miscLabel->set_line_wrap(false);
+   miscLabel->set_use_markup(false);
+   miscLabel->set_selectable(false);
+   miscLabel->set_ellipsize(Pango::ELLIPSIZE_NONE);
+   miscLabel->set_width_chars(-1);
+   miscLabel->set_angle(0);
+   miscLabel->set_single_line_mode(false);
    prefsNotebook->set_flags(Gtk::CAN_FOCUS);
    prefsNotebook->set_show_tabs(true);
    prefsNotebook->set_show_border(true);
    prefsNotebook->set_tab_pos(Gtk::POS_TOP);
    prefsNotebook->set_scrollable(false);
-   prefsNotebook->append_page(*generalTable, *label65);
+   prefsNotebook->append_page(*vbox3, *indexingLabel);
    prefsNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
-   prefsNotebook->append_page(*table2, *label69);
+   prefsNotebook->append_page(*vbox2, *labelsLabel);
    prefsNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
-   prefsNotebook->append_page(*vbox2, *label73);
+   prefsNotebook->append_page(*table2, *networkLabel);
    prefsNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
-   prefsNotebook->append_page(*vbox3, *label78);
+   prefsNotebook->append_page(*generalTable, *miscLabel);
    prefsNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
    vbox1->set_border_width(4);
    vbox1->pack_start(*prefsNotebook);
@@ -531,44 +529,6 @@
    prefsCancelbutton->show();
    prefsOkbutton->show();
    hbuttonbox1->show();
-   apiKeyLabel->show();
-   apiKeyEntry->show();
-   queriesLabel->show();
-   enableCompletionCheckbutton->show();
-   newResultsColorbutton->show();
-   ignoreRobotsCheckbutton->show();
-   robotsLabels->show();
-   newResultsLabel->show();
-   generalTable->show();
-   label65->show();
-   directConnectionRadiobutton->show();
-   proxyRadiobutton->show();
-   proxyAddressLabel->show();
-   proxyAddressEntry->show();
-   proxyTypeLabel->show();
-   proxyPortLabel->show();
-   proxyPortSpinbutton->show();
-   proxyTypeCombobox->show();
-   table3->show();
-   table2->show();
-   label69->show();
-   indexLabelsLabel->show();
-   labelsTreeview->show();
-   scrolledwindow1->show();
-   image725->show();
-   label71->show();
-   hbox58->show();
-   alignment37->show();
-   addLabelButton->show();
-   image726->show();
-   label72->show();
-   hbox59->show();
-   alignment38->show();
-   removeLabelButton->show();
-   vbuttonbox1->show();
-   hbox57->show();
-   vbox2->show();
-   label73->show();
    directoriesLabel->show();
    directoriesTreeview->show();
    scrolledwindow2->show();
@@ -595,21 +555,59 @@
    vbuttonbox3->show();
    hbox62->show();
    vbox3->show();
-   label78->show();
+   indexingLabel->show();
+   indexLabelsLabel->show();
+   labelsTreeview->show();
+   scrolledwindow1->show();
+   image725->show();
+   label71->show();
+   hbox58->show();
+   alignment37->show();
+   addLabelButton->show();
+   image726->show();
+   label72->show();
+   hbox59->show();
+   alignment38->show();
+   removeLabelButton->show();
+   vbuttonbox1->show();
+   hbox57->show();
+   vbox2->show();
+   labelsLabel->show();
+   directConnectionRadiobutton->show();
+   proxyRadiobutton->show();
+   proxyAddressLabel->show();
+   proxyAddressEntry->show();
+   proxyTypeLabel->show();
+   proxyPortLabel->show();
+   proxyPortSpinbutton->show();
+   proxyTypeCombobox->show();
+   table3->show();
+   table2->show();
+   networkLabel->show();
+   apiKeyLabel->show();
+   apiKeyEntry->show();
+   queriesLabel->show();
+   enableCompletionCheckbutton->show();
+   newResultsColorbutton->show();
+   ignoreRobotsCheckbutton->show();
+   robotsLabels->show();
+   newResultsLabel->show();
+   generalTable->show();
+   miscLabel->show();
    prefsNotebook->show();
    vbox1->show();
    prefsWindow->show();
    prefsCancelbutton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_prefsCancelbutton_clicked), false);
    prefsOkbutton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_prefsOkbutton_clicked), false);
-   directConnectionRadiobutton->signal_toggled().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_directConnectionRadiobutton_toggled), false);
-   addLabelButton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_addLabelButton_clicked), false);
-   removeLabelButton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_removeLabelButton_clicked), false);
    addDirectoryButton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_addDirectoryButton_clicked), false);
    removeDirectoryButton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_removeDirectoryButton_clicked), false);
    patternsCombobox->signal_changed().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_patternsCombobox_changed), false);
    addPatternButton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_addPatternButton_clicked), false);
    removePatternButton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_removePatternButton_clicked), false);
    resetPatternsButton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_resetPatternsButton_clicked), false);
+   addLabelButton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_addLabelButton_clicked), false);
+   removeLabelButton->signal_clicked().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_removeLabelButton_clicked), false);
+   directConnectionRadiobutton->signal_toggled().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_directConnectionRadiobutton_toggled), false);
    prefsWindow->signal_delete_event().connect(sigc::mem_fun(*this, &prefsWindow_glade::on_prefsWindow_delete_event), false);
 }
 

Modified: trunk/UI/GTK2/src/prefsWindow_glade.hh
===================================================================
--- trunk/UI/GTK2/src/prefsWindow_glade.hh	2008-12-29 17:56:26 UTC (rev 1451)
+++ trunk/UI/GTK2/src/prefsWindow_glade.hh	2008-12-29 17:59:08 UTC (rev 1452)
@@ -1,9 +1,9 @@
-// generated 2008/11/18 23:24:22 SGT by fabrice at rexor.dyndns.org.(none)
+// generated 2008/12/27 19:39:02 SGT by fabrice at rexor.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.12.12 and gtkmm 2.12.7
+// for gtk 2.14.5 and gtkmm 2.14.3
 //
 // Please modify the corresponding derived classes in ./src/prefsWindow.hh and./src/prefsWindow.cc
 
@@ -33,14 +33,15 @@
 
 #include <gtkmm/window.h>
 #include <gtkmm/button.h>
+#include <gtkmm/treeview.h>
+#include <gtkmm/comboboxtext.h>
+#include <gtkmm/radiobutton.h>
+#include <gtkmm/entry.h>
+#include <gtkmm/spinbutton.h>
 #include <gtkmm/label.h>
-#include <gtkmm/entry.h>
+#include <gtkmm/checkbutton.h>
 #include <gtkmm/colorbutton.h>
 #include <gtkmm/table.h>
-#include <gtkmm/radiobutton.h>
-#include <gtkmm/spinbutton.h>
-#include <gtkmm/comboboxtext.h>
-#include <gtkmm/treeview.h>
 #include <gtkmm/notebook.h>
 
 class prefsWindow_glade : public Gtk::Window
@@ -50,21 +51,6 @@
 protected:
         class Gtk::Button * prefsCancelbutton;
         class Gtk::Button * prefsOkbutton;
-        class Gtk::Label * apiKeyLabel;
-        class Gtk::Entry * apiKeyEntry;
-        class Gtk::CheckButton * enableCompletionCheckbutton;
-        class Gtk::ColorButton * newResultsColorbutton;
-        class Gtk::CheckButton * ignoreRobotsCheckbutton;
-        class Gtk::Label * robotsLabels;
-        class Gtk::Table * generalTable;
-        class Gtk::RadioButton * directConnectionRadiobutton;
-        class Gtk::RadioButton * proxyRadiobutton;
-        class Gtk::Entry * proxyAddressEntry;
-        class Gtk::SpinButton * proxyPortSpinbutton;
-        class Gtk::ComboBoxText * proxyTypeCombobox;
-        class Gtk::TreeView * labelsTreeview;
-        class Gtk::Button * addLabelButton;
-        class Gtk::Button * removeLabelButton;
         class Gtk::TreeView * directoriesTreeview;
         class Gtk::Button * addDirectoryButton;
         class Gtk::Button * removeDirectoryButton;
@@ -73,6 +59,21 @@
         class Gtk::Button * addPatternButton;
         class Gtk::Button * removePatternButton;
         class Gtk::Button * resetPatternsButton;
+        class Gtk::TreeView * labelsTreeview;
+        class Gtk::Button * addLabelButton;
+        class Gtk::Button * removeLabelButton;
+        class Gtk::RadioButton * directConnectionRadiobutton;
+        class Gtk::RadioButton * proxyRadiobutton;
+        class Gtk::Entry * proxyAddressEntry;
+        class Gtk::SpinButton * proxyPortSpinbutton;
+        class Gtk::ComboBoxText * proxyTypeCombobox;
+        class Gtk::Label * apiKeyLabel;
+        class Gtk::Entry * apiKeyEntry;
+        class Gtk::CheckButton * enableCompletionCheckbutton;
+        class Gtk::ColorButton * newResultsColorbutton;
+        class Gtk::CheckButton * ignoreRobotsCheckbutton;
+        class Gtk::Label * robotsLabels;
+        class Gtk::Table * generalTable;
         class Gtk::Notebook * prefsNotebook;
         
         prefsWindow_glade();
@@ -81,15 +82,15 @@
 private:
         virtual void on_prefsCancelbutton_clicked() = 0;
         virtual void on_prefsOkbutton_clicked() = 0;
-        virtual void on_directConnectionRadiobutton_toggled() = 0;
-        virtual void on_addLabelButton_clicked() = 0;
-        virtual void on_removeLabelButton_clicked() = 0;
         virtual void on_addDirectoryButton_clicked() = 0;
         virtual void on_removeDirectoryButton_clicked() = 0;
         virtual void on_patternsCombobox_changed() = 0;
         virtual void on_addPatternButton_clicked() = 0;
         virtual void on_removePatternButton_clicked() = 0;
         virtual void on_resetPatternsButton_clicked() = 0;
+        virtual void on_addLabelButton_clicked() = 0;
+        virtual void on_removeLabelButton_clicked() = 0;
+        virtual void on_directConnectionRadiobutton_toggled() = 0;
         virtual bool on_prefsWindow_delete_event(GdkEventAny *ev) = 0;
 };
 #endif



From fabricecolin at mail.berlios.de  Mon Dec 29 19:01:58 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 29 Dec 2008 19:01:58 +0100
Subject: [Pinot-svn] r1453 - trunk/UI/GTK2/src
Message-ID: <200812291801.mBTI1w2m031332@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-29 19:01:01 +0100 (Mon, 29 Dec 2008)
New Revision: 1453

Modified:
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
Log:
Export also works in flat mode, ie when browsing an index.


Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2008-12-29 17:59:08 UTC (rev 1452)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2008-12-29 18:01:01 UTC (rev 1453)
@@ -27,14 +27,13 @@
 #include <gtkmm/stock.h>
 #include <gtkmm/cellrendererprogress.h>
 
+#include "config.h"
+#include "NLS.h"
 #include "StringManip.h"
 #include "TimeConverter.h"
 #include "Url.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
-#include "ResultsExporter.h"
-#include "config.h"
-#include "NLS.h"
 #include "PinotSettings.h"
 #include "PinotUtils.h"
 #include "ResultsTree.h"
@@ -1259,10 +1258,10 @@
 //
 // Exports results to a file.
 //
-void ResultsTree::exportResults(const string &fileName, bool csvFormat)
+void ResultsTree::exportResults(const string &fileName,
+	const string &queryName, bool csvFormat)
 {
-	QueryHistory queryHistory(m_settings.getHistoryDatabaseName());
-	QueryProperties queryProps(m_treeName, "");
+	QueryProperties queryProps(queryName, "");
 	ResultsExporter *pExporter = NULL;
 	unsigned int maxResultsCount = 0;
 
@@ -1284,7 +1283,11 @@
 
 	// How many results are there altogether ?
 	TreeModel::Children children = m_refStore->children();
-	for (TreeModel::Children::iterator iter = children.begin();
+	if (m_groupMode == FLAT)
+	{
+		maxResultsCount = children.size();
+	}
+	else for (TreeModel::Children::iterator iter = children.begin();
 		iter != children.end(); ++iter)
 	{
 		TreeModel::Row row = *iter;
@@ -1299,11 +1302,18 @@
 		TreeModel::Children groupChildren = iter->children();
 		maxResultsCount += groupChildren.size();
 	}
+#ifdef DEBUG
+	cout << "ResultsTree::exportResults: " << maxResultsCount << " results to export" << endl;
+#endif
 
 	// Start
 	pExporter->exportStart("", maxResultsCount);
 
-	for (TreeModel::Children::iterator iter = children.begin();
+	if (m_groupMode == FLAT)
+	{
+		exportResults(children, queryName, pExporter);
+	}
+	else for (TreeModel::Children::iterator iter = children.begin();
 		iter != children.end(); ++iter)
 	{
 		TreeModel::Row row = *iter;
@@ -1316,51 +1326,76 @@
 		}
 
 		TreeModel::Children groupChildren = iter->children();
-		for (TreeModel::Children::iterator childIter = groupChildren.begin();
-			childIter != groupChildren.end(); ++childIter)
+		exportResults(groupChildren, queryName, pExporter);
+	}
+
+	// End
+	pExporter->exportEnd();
+
+	delete pExporter;
+}
+
+//
+// Exports results to a file.
+//
+void ResultsTree::exportResults(TreeModel::Children &groupChildren,
+	const string &queryName, ResultsExporter *pExporter)
+{
+	QueryHistory queryHistory(m_settings.getHistoryDatabaseName());
+
+	for (TreeModel::Children::iterator childIter = groupChildren.begin();
+		childIter != groupChildren.end(); ++childIter)
+	{
+		TreeModel::Row childRow = *childIter;
+		ResultsModelColumns::RowType type = childRow[m_resultsColumns.m_resultType];
+
+		if (type == ResultsModelColumns::ROW_OTHER)
 		{
-			set<string> engineNames, indexNames;
-			TreeModel::Row childRow = *childIter;
-			DocumentInfo result;
-			string engineName, serial(from_utf8(childRow[m_resultsColumns.m_serial]));
-			unsigned int engineIds = childRow[m_resultsColumns.m_engines];
-			unsigned int indexIds = childRow[m_resultsColumns.m_indexes];
+			continue;
+		}
 
+		set<string> engineNames, indexNames;
+		DocumentInfo result;
+		string engineName, serial(from_utf8(childRow[m_resultsColumns.m_serial]));
+		unsigned int engineIds = childRow[m_resultsColumns.m_engines];
+		unsigned int indexIds = childRow[m_resultsColumns.m_indexes];
+
 #ifdef DEBUG
-			cout << "ResultsTree::exportResults: engines " << engineIds << ", indexes " << indexIds << endl;
+		cout << "ResultsTree::exportResults: engines " << engineIds << ", indexes " << indexIds << endl;
 #endif
-			result.deserialize(serial);
-			m_settings.getEngineNames(engineIds, engineNames);
-			if (engineNames.empty() == false)
+		result.deserialize(serial);
+		m_settings.getEngineNames(engineIds, engineNames);
+		if (engineNames.empty() == false)
+		{
+			// Get the first engine this result was obtained from
+			engineName = *engineNames.begin();
+			if (engineName == m_settings.m_defaultBackend)
 			{
-				// Get the first engine this result was obtained from
-				engineName = *engineNames.begin();
-				if (engineName == m_settings.m_defaultBackend)
+				m_settings.getIndexNames(indexIds, indexNames);
+				if (indexNames.empty() == false)
 				{
-					m_settings.getIndexNames(indexIds, indexNames);
-					if (indexNames.empty() == false)
-					{
-						// Use the name of the first index as engine name
-						engineName = (*indexNames.begin());
-					}
+					// Use the name of the first index as engine name
+					engineName = (*indexNames.begin());
 				}
 			}
-			if (m_groupMode != FLAT)
-			{
-				result.setExtract(queryHistory.getItemExtract(from_utf8(m_treeName),
-					engineName, result.getLocation()));
-			}
-			result.setTimestamp(from_utf8(childRow[m_resultsColumns.m_timestamp]));
+		}
+		if (m_groupMode != FLAT)
+		{
+			result.setExtract(queryHistory.getItemExtract(from_utf8(queryName),
+				engineName, result.getLocation()));
+		}
+		else
+		{
+			engineName = m_treeName;
+		}
+		result.setTimestamp(from_utf8(childRow[m_resultsColumns.m_timestamp]));
 
-			// Export this
+		// Export this
+		if (pExporter != NULL)
+		{
 			pExporter->exportResult(engineName, result);
 		}
 	}
-
-	// End
-	pExporter->exportEnd();
-
-	delete pExporter;
 }
 
 //

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2008-12-29 17:59:08 UTC (rev 1452)
+++ trunk/UI/GTK2/src/ResultsTree.h	2008-12-29 18:01:01 UTC (rev 1453)
@@ -35,6 +35,7 @@
 #include <gtkmm/treeview.h>
 #include <gtkmm/treeselection.h>
 
+#include "ResultsExporter.h"
 #include "ModelColumns.h"
 #include "PinotSettings.h"
 
@@ -103,7 +104,8 @@
 		void showExtract(bool showExtract = true);
 
 		/// Exports results to a file.
-		void exportResults(const std::string &fileName, bool csvFormat);
+		void exportResults(const std::string &fileName,
+			const string &queryName, bool csvFormat);
 
 		/// Returns the changed selection signal.
 		sigc::signal1<void, Glib::ustring>& getSelectionChangedSignal(void);
@@ -174,6 +176,10 @@
 		/// Retrieves the extract to show for the given row.
 		Glib::ustring findResultsExtract(const Gtk::TreeModel::Row &row);
 
+		/// Exports results to a file.
+		void exportResults(Gtk::TreeModel::Children &groupChildren,
+			const string &queryName, ResultsExporter *pExporter);
+
 	private:
 		ResultsTree(const ResultsTree &other);
 		ResultsTree &operator=(const ResultsTree &other);



From fabricecolin at mail.berlios.de  Mon Dec 29 19:32:13 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 29 Dec 2008 19:32:13 +0100
Subject: [Pinot-svn] r1454 - trunk/Utils
Message-ID: <200812291832.mBTIWDbr004694@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-29 19:32:11 +0100 (Mon, 29 Dec 2008)
New Revision: 1454

Modified:
   trunk/Utils/Url.cpp
Log:
Removed reference to deprecated protocols.


Modified: trunk/Utils/Url.cpp
===================================================================
--- trunk/Utils/Url.cpp	2008-12-29 18:01:01 UTC (rev 1453)
+++ trunk/Utils/Url.cpp	2008-12-29 18:32:11 UTC (rev 1454)
@@ -227,9 +227,7 @@
 
 bool Url::isLocal(const string &protocol) const
 {
-	if ((protocol == "file") ||
-		(protocol == "mailbox") ||
-		(protocol == "xapian"))
+	if (protocol == "file")
 	{
 		return true;
 	}



From fabricecolin at mail.berlios.de  Mon Dec 29 19:32:57 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Mon, 29 Dec 2008 19:32:57 +0100
Subject: [Pinot-svn] r1455 - trunk/Utils
Message-ID: <200812291832.mBTIWvPd006427@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-29 19:32:55 +0100 (Mon, 29 Dec 2008)
New Revision: 1455

Modified:
   trunk/Utils/DocumentInfo.cpp
Log:
Remove the charset specification from the MIME type.


Modified: trunk/Utils/DocumentInfo.cpp
===================================================================
--- trunk/Utils/DocumentInfo.cpp	2008-12-29 18:32:11 UTC (rev 1454)
+++ trunk/Utils/DocumentInfo.cpp	2008-12-29 18:32:55 UTC (rev 1455)
@@ -230,7 +230,16 @@
 /// Returns the type of the document.
 string DocumentInfo::getType(void) const
 {
-	return getField("type");
+	string type(getField("type"));
+	string::size_type semiColonPos = type.find(";");
+
+	// Remove the charset, if any
+	if (semiColonPos != string::npos)
+	{
+		return type.substr(0, semiColonPos);
+	}
+
+	return type;
 }
 
 /// Sets the language of the document.



From fabricecolin at mail.berlios.de  Tue Dec 30 15:04:03 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Tue, 30 Dec 2008 15:04:03 +0100
Subject: [Pinot-svn] r1456 - trunk/UI/GTK2/src
Message-ID: <200812301404.mBUE43xe022381@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-30 15:03:54 +0100 (Tue, 30 Dec 2008)
New Revision: 1456

Modified:
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/mainWindow_glade.cc
   trunk/UI/GTK2/src/mainWindow_glade.hh
Log:
Reorganized menus, merged menuitems from Results and Index that overlapped in
functionality.
Unified expansion from a document selected with More Like This and from one
dropped on the queries list.
Export works on both results lists and index pages.
Index Results will index new documents or update documents in My Web Pages, not
My Documents.


Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2008-12-29 18:32:55 UTC (rev 1455)
+++ trunk/UI/GTK2/src/mainWindow.cc	2008-12-30 14:03:54 UTC (rev 1456)
@@ -93,6 +93,14 @@
 unsigned int mainWindow::m_maxDocsCount = 100;
 unsigned int mainWindow::m_maxIndexThreads = 2;
 
+mainWindow::ExpandSet::ExpandSet()
+{
+}
+
+mainWindow::ExpandSet::~ExpandSet()
+{
+}
+
 mainWindow::InternalState::InternalState(unsigned int maxIndexThreads, mainWindow *pWindow) :
 	ThreadsManager(PinotSettings::getInstance().m_docsIndexLocation, maxIndexThreads, 60),
 	m_liveQueryLength(0),
@@ -212,7 +220,7 @@
 	removeQueryButton->set_sensitive(false);
 	queryHistoryButton->set_sensitive(false);
 	findQueryButton->set_sensitive(false);
-	show_global_menuitems(false);
+	show_pagebased_menuitems(false);
 	show_selectionbased_menuitems(false);
 	// ...and buttons
 	removeIndexButton->set_sensitive(false);
@@ -252,7 +260,7 @@
 	// Open the preferences on first run
 	if (m_settings.isFirstRun() == true)
 	{
-		on_configure_activate();
+		on_preferences_activate();
 	}
 	else if	(m_settings.m_warnAboutVersion == true)
 	{
@@ -402,7 +410,7 @@
 	if (m_pCacheMenu == NULL)
 	{
 		m_pCacheMenu = manage(new Menu());
-		viewcache1->set_submenu(*m_pCacheMenu);
+		opencache1->set_submenu(*m_pCacheMenu);
 	}
 	else
 	{
@@ -415,7 +423,7 @@
 	if (m_settings.m_cacheProviders.empty() == true)
 	{
 		// Hide the submenu
-		viewcache1->hide();
+		opencache1->hide();
 	}
 	else
 	{
@@ -441,7 +449,7 @@
 	if (m_pIndexMenu == NULL)
 	{
 		m_pIndexMenu = manage(new Menu());
-		list1->set_submenu(*m_pIndexMenu);
+		listcontents1->set_submenu(*m_pIndexMenu);
 	}
 	else
 	{
@@ -473,7 +481,7 @@
 	if (m_pFindMenu == NULL)
 	{
 		m_pFindMenu = manage(new Menu());
-		searchagain1->set_submenu(*m_pFindMenu);
+		searchthisfor1->set_submenu(*m_pFindMenu);
 	}
 	else
 	{
@@ -481,7 +489,7 @@
 		m_pFindMenu->items().clear();
 	}
 
-	sigc::slot1<void, ustring> findSlot = sigc::mem_fun(*this, &mainWindow::on_searchagain_changed);
+	sigc::slot1<void, ustring> findSlot = sigc::mem_fun(*this, &mainWindow::on_searchthis_changed);
 
 	TreeModel::Children children = m_refQueryTree->children();
 	for (TreeModel::Children::iterator iter = children.begin();
@@ -548,10 +556,12 @@
 // Get selected results in the current results tab
 //
 bool mainWindow::get_results_page_details(const ustring &queryName,
-	QueryProperties &queryProps, set<string> &locations)
+	QueryProperties &queryProps, set<string> &locations,
+	set<string> &locationsToIndex)
 {
 	vector<DocumentInfo> resultsList;
 	ustring currentQueryName(queryName);
+	bool foundQuery = false;
 
 	locations.clear();
 
@@ -560,23 +570,31 @@
 		NotebookPageBox *pNotebookPage = get_current_page();
 		if (pNotebookPage != NULL)
 		{
-			ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-			if (pResultsPage != NULL)
+			ResultsTree *pResultsTree = pNotebookPage->getTree();
+			if (pResultsTree != NULL)
 			{
-				ResultsTree *pResultsTree = pResultsPage->getTree();
-				if (pResultsTree != NULL)
+				pResultsTree->getSelection(resultsList);
+			}
+
+			NotebookPageBox::PageType type = pNotebookPage->getType();
+			if (type == NotebookPageBox::RESULTS_PAGE)
+			{
+				currentQueryName = pNotebookPage->getTitle();
+
+				if (currentQueryName.empty() == true)
 				{
-					pResultsTree->getSelection(resultsList);
+					return false;
 				}
-
-				currentQueryName = pResultsPage->getTitle();
 			}
+			else if (type == NotebookPageBox::INDEX_PAGE)
+			{
+				IndexPage *pIndexPage = dynamic_cast<IndexPage*>(pNotebookPage);
+				if (pIndexPage != NULL)
+				{
+					currentQueryName = pIndexPage->getQueryName();
+				}
+			}
 		}
-
-		if (currentQueryName.empty() == true)
-		{
-			return false;
-		}
 	}
 
 	// Find this query
@@ -585,10 +603,8 @@
 		queryProps.setName(currentQueryName);
 		queryProps.setFreeQuery(liveQueryEntry->get_text());
 	}
-	else
+	else if (currentQueryName.empty() == false)
 	{
-		bool foundQuery = false;
-
 		TreeModel::Children children = m_refQueryTree->children();
 		for (TreeModel::Children::iterator iter = children.begin();
 			iter != children.end(); ++iter)
@@ -613,12 +629,27 @@
 	for (vector<DocumentInfo>::const_iterator docIter = resultsList.begin();
 		docIter != resultsList.end(); ++docIter)
 	{
-		if (docIter->getIsIndexed() == true)
+		if (docIter->getIsIndexed() == false)
 		{
-			locations.insert(docIter->getLocation());
+			locationsToIndex.insert(docIter->getLocation());
 		}
+		locations.insert(docIter->getLocation());
 	}
 
+	if (foundQuery == false)
+	{
+		Url urlObj(*locations.begin());
+		string queryName(urlObj.getFile());
+
+		if (locations.size() > 1)
+		{
+			queryName += "...";
+		}
+
+		queryProps.setName(queryName);
+		queryProps.setFreeQuery("dir:/");
+	}
+
 	return true;
 }
 
@@ -626,7 +657,7 @@
 // Drag and drop
 //
 void mainWindow::on_data_received(const RefPtr<DragContext> &context,
-	int x, int y, const SelectionData &data, guint info, guint time)
+	int x, int y, const SelectionData &data, guint info, guint dataTime)
 {
 	list<ustring> droppedUris = data.get_uris();
 	ustring droppedText(data.get_text());
@@ -639,15 +670,17 @@
 	{
 		IndexInterface *pIndex = m_settings.getIndex("MERGED");
 		set<string> locationsToIndex;
-		bool isIndexing = true;
+		ExpandSet expandSet;
+		string queryName;
 
+		expandSet.m_queryProps.setFreeQuery("dir:/");
+
 		for (list<ustring>::iterator uriIter = droppedUris.begin();
 			uriIter != droppedUris.end(); ++uriIter)
 		{
 			string uri(*uriIter);
 
-			cout << "mainWindow::on_data_received: received URI \""
-				<< uri << "\"" << endl; 
+			cout << "mainWindow::on_data_received: received " << uri << endl; 
 
 			// Query the merged index
 			if (pIndex != NULL)
@@ -660,7 +693,14 @@
 				}
 			}
 
-			m_expandLocations.insert(uri);
+			// Name the query after the first document
+			if (queryName.empty() == true)
+			{
+				Url urlObj(uri);
+				queryName = urlObj.getFile();
+			}
+
+			expandSet.m_locations.insert(uri);
 			goodDrop = true;
 		}
 
@@ -669,8 +709,16 @@
 			delete pIndex;
 		}
 
+		if (expandSet.m_locations.size() > 1)
+		{
+			queryName += "...";
+		}
+
 		if (goodDrop == true)
 		{
+			expandSet.m_queryProps.setName(queryName);
+			m_expandSets.push_back(expandSet);
+
 			for (set<string>::iterator locationIter = locationsToIndex.begin();
 				locationIter != locationsToIndex.end(); ++locationIter)
 			{
@@ -682,7 +730,7 @@
 
 			if (locationsToIndex.empty() == true)
 			{
-				// We can run a catch-all query and expand on these documents right away
+				// Expand on these documents right away
 				expand_locations();
 			}
 			// Else, do it when indexing is completed
@@ -699,7 +747,7 @@
 		goodDrop = true;
 	}
 
-	context->drag_finish(goodDrop, false, time);
+	context->drag_finish(goodDrop, false, dataTime);
 }
 
 //
@@ -760,9 +808,6 @@
 	findQueryButton->set_sensitive(enableButtons);
 }
 
-//
-// Results tree selection changed
-//
 void mainWindow::on_resultsTreeviewSelection_changed(ustring queryName)
 {
 	vector<DocumentInfo> resultsList;
@@ -771,22 +816,53 @@
 	NotebookPageBox *pNotebookPage = get_page(queryName, NotebookPageBox::RESULTS_PAGE);
 	if (pNotebookPage != NULL)
 	{
-		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-		if (pResultsPage != NULL)
+		ResultsTree *pResultsTree = pNotebookPage->getTree();
+		if (pResultsTree != NULL)
 		{
-			ResultsTree *pResultsTree = pResultsPage->getTree();
-			if (pResultsTree != NULL)
-			{
-				hasSelection = pResultsTree->getSelection(resultsList);
-			}
+			hasSelection = pResultsTree->getSelection(resultsList);
 		}
 	}
 
-	if ((hasSelection == true) &&
-		(resultsList.empty() == false))
+	on_document_changed(resultsList, false, false, true);
+}
+
+void mainWindow::on_indexTreeviewSelection_changed(ustring indexName)
+{
+	vector<DocumentInfo> resultsList;
+	bool hasSelection = false;
+
+	NotebookPageBox *pNotebookPage = get_page(indexName, NotebookPageBox::INDEX_PAGE);
+	if (pNotebookPage != NULL)
 	{
-		bool firstResult = true, isViewable = true, isCached = false, isIndexed = false, isIndexable = true;
+		ResultsTree *pResultsTree = pNotebookPage->getTree();
+		if (pResultsTree != NULL)
+		{
+			hasSelection = pResultsTree->getSelection(resultsList);
+		}
+	}
 
+	bool isDocumentsIndex = true;
+	bool editDocuments = true;
+
+	if (indexName != _("My Web Pages"))
+	{
+		isDocumentsIndex = false;
+		if (indexName != _("My Documents"))
+		{
+			editDocuments = false;
+		}
+	}
+
+	on_document_changed(resultsList, isDocumentsIndex, editDocuments, false);
+}
+
+void mainWindow::on_document_changed(vector<DocumentInfo> &resultsList,
+	bool isDocumentsIndex, bool editDocuments, bool areResults)
+{
+	if (resultsList.empty() == false)
+	{
+		bool firstResult = true, isViewable = true, isCached = false, isLocal = false, isIndexed = false, isIndexable = true;
+
 		for (vector<DocumentInfo>::iterator resultIter = resultsList.begin();
 			resultIter != resultsList.end(); ++resultIter)
 		{
@@ -795,12 +871,12 @@
 			string protocol(urlObj.getProtocol());
 
 #ifdef DEBUG
-			cout << "mainWindow::on_resultsTreeviewSelection_changed: " << url << endl;
+			cout << "mainWindow::on_document_changed: " << url << endl;
 #endif
 			if (firstResult == true)
 			{
-				// Show the URL of the first result in the status bar
-				ustring statusText = _("Result location is");
+				// Show the URL of the first document in the status bar
+				ustring statusText = _("Document location is");
 				statusText += " ";
 				statusText += url;
 				set_status(statusText, true);
@@ -821,90 +897,48 @@
 					isCached = true;
 				}
 
+				if (urlObj.isLocal() == true)
+				{
+					isLocal = true;
+				}
+
 				isIndexed = resultIter->getIsIndexed();
+				isIndexable = !isIndexed;
 			}
 		}
 
 		// Enable these menu items
-		viewresults1->set_sensitive(isViewable);
-		viewcache1->set_sensitive(isCached);
-		morelikethis1->set_sensitive(isIndexed);
-		searchagain1->set_sensitive(isIndexed);
-		indexresults1->set_sensitive(isIndexable);
+		open1->set_sensitive(isViewable);
+		opencache1->set_sensitive(isCached);
+		openparent1->set_sensitive(isLocal);
+		addtoindex1->set_sensitive(isIndexable);
+		updateindex1->set_sensitive(isDocumentsIndex);
+		unindex1->set_sensitive(isDocumentsIndex);
+		morelikethis1->set_sensitive(true);
+		searchthisfor1->set_sensitive(areResults);
+		properties1->set_sensitive(editDocuments);
 	}
 	else
 	{
 		// Disable these menu items
-		viewresults1->set_sensitive(false);
-		viewcache1->set_sensitive(false);
+		open1->set_sensitive(false);
+		opencache1->set_sensitive(false);
+		openparent1->set_sensitive(false);
+		addtoindex1->set_sensitive(false);
+		updateindex1->set_sensitive(false);
+		unindex1->set_sensitive(false);
 		morelikethis1->set_sensitive(false);
-		searchagain1->set_sensitive(false);
-		indexresults1->set_sensitive(false);
+		searchthisfor1->set_sensitive(false);
+		addtoindex1->set_sensitive(false);
 
 		// Reset
 		set_status("");
 	}
 }
 
-//
-// Index tree selection changed
-//
-void mainWindow::on_indexTreeviewSelection_changed(ustring indexName)
-{
-	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
-	if (pIndexPage == NULL)
-	{
-		return;
-	}
-
-	ResultsTree *pResultsTree = pIndexPage->getTree();
-	if (pResultsTree != NULL)
-	{
-		string url(pResultsTree->getFirstSelectionURL());
-
-		if (url.empty() == false)
-		{
-			bool isDocumentsIndex = true;
-			bool editDocument = true;
-
-			// Enable these menu items unless it is not the documents index
-			if (indexName != _("My Web Pages"))
-			{
-				isDocumentsIndex = false;
-				if (indexName != _("My Documents"))
-				{
-					editDocument = false;
-				}
-			}
-			viewfromindex1->set_sensitive(true);
-			refreshindex1->set_sensitive(isDocumentsIndex);
-			unindex1->set_sensitive(isDocumentsIndex);
-			showfromindex1->set_sensitive(editDocument);
-
-			// Show the URL in the status bar
-			ustring statusText = _("Document location is");
-			statusText += " ";
-			statusText += pResultsTree->getFirstSelectionURL();
-			set_status(statusText, true);
-		}
-	}
-	else
-	{
-		// No, disable these
-		viewfromindex1->set_sensitive(false);
-		refreshindex1->set_sensitive(false);
-		unindex1->set_sensitive(false);
-		showfromindex1->set_sensitive(false);
-	}
-}
-
-//
-// Index > List Contents Of menu selected
-//
 void mainWindow::on_index_changed(ustring indexName)
 {
 	ResultsTree *pResultsTree = NULL;
-	IndexPage *pIndexPage = NULL;
 	ustring queryName;
 	bool foundPage = false;
 
@@ -913,7 +947,7 @@
 #endif
 
 	// Is there already a page for this index ?
-	pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
+	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
 	if (pIndexPage != NULL)
 	{
 		// Force a refresh
@@ -934,7 +968,7 @@
 			sigc::mem_fun(*this, &mainWindow::on_close_page));
 
 		// Position the index tree
-		pResultsTree = manage(new ResultsTree(indexName, indexMenuitem->get_submenu(),
+		pResultsTree = manage(new ResultsTree(indexName, fileMenuitem->get_submenu(),
 			ResultsTree::FLAT, m_settings));
 		pIndexPage = manage(new IndexPage(indexName, pResultsTree, m_settings));
 		// Connect to the "changed" signal
@@ -942,7 +976,7 @@
 			sigc::mem_fun(*this, &mainWindow::on_indexTreeviewSelection_changed));
 		// Connect to the edit document signal
 		pResultsTree->getDoubleClickSignal().connect(
-			sigc::mem_fun(*this, &mainWindow::on_showfromindex_activate));
+			sigc::mem_fun(*this, &mainWindow::on_properties_activate));
 		// Connect to the query changed signal
 		pIndexPage->getQueryChangedSignal().connect(
 			sigc::mem_fun(*this, &mainWindow::on_query_changed));
@@ -987,65 +1021,61 @@
 	NotebookPageBox *pNotebookPage = get_current_page();
 	if (pNotebookPage != NULL)
 	{
-		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-		if (pResultsPage != NULL)
+		ResultsTree *pResultsTree = pNotebookPage->getTree();
+		if (pResultsTree != NULL)
 		{
-			ResultsTree *pResultsTree = pResultsPage->getTree();
-			if (pResultsTree != NULL)
-			{
-				vector<DocumentInfo> resultsList;
+			vector<DocumentInfo> resultsList;
 
-				if (pResultsTree->getSelection(resultsList) == true)
+			if (pResultsTree->getSelection(resultsList) == true)
+			{
+				for (vector<DocumentInfo>::iterator resultIter = resultsList.begin();
+					resultIter != resultsList.end(); ++resultIter)
 				{
-					for (vector<DocumentInfo>::iterator resultIter = resultsList.begin();
-						resultIter != resultsList.end(); ++resultIter)
+					string url(resultIter->getLocation());
+					Url urlObj(url);
+					string protocol(urlObj.getProtocol());
+
+					// Is this protocol supported ?
+					if (cacheProvider.m_protocols.find(protocol) == cacheProvider.m_protocols.end())
 					{
-						string url(resultIter->getLocation());
-						Url urlObj(url);
-						string protocol(urlObj.getProtocol());
+						// No, it isn't... This document will be open in place
+						continue;
+					}
 
-						// Is this protocol supported ?
-						if (cacheProvider.m_protocols.find(protocol) == cacheProvider.m_protocols.end())
+					// Rewrite the URL
+					ustring location(cacheProvider.m_location);
+					ustring::size_type argPos = location.find("%url0");
+					if (argPos != ustring::npos)
+					{
+						string::size_type pos = url.find("://");
+						if ((pos != string::npos) &&
+							(pos + 3 < url.length()))
 						{
-							// No, it isn't... This document will be open in place
-							continue;
+							// URL without protocol
+							location.replace(argPos, 5, url.substr(pos + 3));
 						}
-
-						// Rewrite the URL
-						ustring location(cacheProvider.m_location);
-						ustring::size_type argPos = location.find("%url0");
+					}
+					else
+					{
+						argPos = location.find("%url");
 						if (argPos != ustring::npos)
 						{
-							string::size_type pos = url.find("://");
-							if ((pos != string::npos) &&
-								(pos + 3 < url.length()))
-							{
-								// URL without protocol
-								location.replace(argPos, 5, url.substr(pos + 3));
-							}
+							// Full protocol
+							location.replace(argPos, 4, url);
 						}
-						else
-						{
-							argPos = location.find("%url");
-							if (argPos != ustring::npos)
-							{
-								// Full protocol
-								location.replace(argPos, 4, url);
-							}
-						}
+					}
 
-						resultIter->setLocation(location);
+					resultIter->setLocation(location);
 #ifdef DEBUG
-						cout << "mainWindow::on_cache_changed: rewritten "
-							<< url << " to " << location << endl;
+					cout << "mainWindow::on_cache_changed: rewritten "
+						<< url << " to " << location << endl;
 #endif
-					}
+				}
 
-					view_documents(resultsList);
+				view_documents(resultsList);
 
-					// Update the rows right now
-					pResultsTree->setSelectionState(true);
-				}
+				// Update the rows right now
+				pResultsTree->setSelectionState(true);
 			}
 		}
 	}
@@ -1054,28 +1084,22 @@
 //
 // Results > Search This For menu selected
 //
-void mainWindow::on_searchagain_changed(ustring queryName)
+void mainWindow::on_searchthis_changed(ustring queryName)
 {
 	QueryProperties queryProps;
 	QueryProperties currentQueryProps;
-	set<string> locations;
+	set<string> locations, locationsToIndex;
 
 	// Get the properties of the given query and
 	// selected results on the current results page
-	if ((get_results_page_details(queryName, queryProps, locations) == false) ||
-		(get_results_page_details("", currentQueryProps, locations) == false))
+	if ((get_results_page_details(queryName, queryProps, locations, locationsToIndex) == false) ||
+		(get_results_page_details("", currentQueryProps, locations, locationsToIndex) == false))
 	{
-		// Maybe the query was deleted
-		if (queryProps.getName().empty() == false)
-		{
-			ustring status(_("Couldn't find query"));
-			status += " ";
-			status += queryName;
-			set_status(status);
-		}
+		set_status(_("Couldn't search in results"));
 
 		return;
 	}
+	// FIXME: index locations that need to be indexed
 
 	if (locations.empty() == false)
 	{
@@ -1106,16 +1130,11 @@
 //
 void mainWindow::on_query_changed(ustring indexName, ustring queryName)
 {
-	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
-	if (pIndexPage == NULL)
+	NotebookPageBox *pNotebookPage = get_page(indexName, NotebookPageBox::INDEX_PAGE);
+	if (pNotebookPage == NULL)
 	{
 		return;
 	}
-	ResultsTree *pResultsTree = pIndexPage->getTree();
-	if (pResultsTree == NULL)
-	{
-		return;
-	}
 
 	browse_index(indexName, queryName, 0);
 }
@@ -1125,8 +1144,6 @@
 //
 void mainWindow::on_switch_page(GtkNotebookPage *p0, guint p1)
 {
-	bool showResultsMenuitems = false;
-
 	NotebookPageBox *pNotebookPage = dynamic_cast<NotebookPageBox*>(m_pNotebook->get_nth_page(p1));
 	if (pNotebookPage != NULL)
 	{
@@ -1134,33 +1151,28 @@
 		if (type == NotebookPageBox::RESULTS_PAGE)
 		{
 			// Show or hide the extract field
-			ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-			if (pResultsPage != NULL)
+			ResultsTree *pResultsTree = pNotebookPage->getTree();
+			if (pResultsTree != NULL)
 			{
-				ResultsTree *pResultsTree = pResultsPage->getTree();
-				if (pResultsTree != NULL)
+				// Sync the results tree with the menuitems
+				pResultsTree->showExtract(showextracts1->get_active());
+				if (searchenginegroup1->get_active() == true)
 				{
-					// Sync the results tree with the menuitems
-					pResultsTree->showExtract(showextract1->get_active());
-					if (searchenginegroup1->get_active() == true)
-					{
-						pResultsTree->setGroupMode(ResultsTree::BY_ENGINE);
-					}
-					else
-					{
-						pResultsTree->setGroupMode(ResultsTree::BY_HOST);
-					}
+					pResultsTree->setGroupMode(ResultsTree::BY_ENGINE);
 				}
+				else
+				{
+					pResultsTree->setGroupMode(ResultsTree::BY_HOST);
+				}
 			}
-
-			showResultsMenuitems = true;
 		}
 #ifdef DEBUG
 		cout << "mainWindow::on_switch_page: page " << p1 << " has type " << type << endl;
 #endif
 	}
 
-	show_global_menuitems(showResultsMenuitems);
+	show_pagebased_menuitems(true);
+
 	// Did the page change ?
 	if (m_state.m_currentPage != p1)
 	{
@@ -1193,7 +1205,7 @@
 
 	if (m_pNotebook->get_n_pages() - pageDecrement <= 0)
 	{
-		show_global_menuitems(false);
+		show_pagebased_menuitems(false);
 		show_selectionbased_menuitems(false);
 	}
 
@@ -1252,16 +1264,14 @@
 			return;
 		}
 
-		IndexPage *pIndexPage = NULL;
-		ResultsTree *pResultsTree = NULL;
 		ustring indexName = to_utf8(pListThread->getIndexName());
 
 		// Find the page for this index
 		// It may have been closed by the user
-		pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
+		IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
 		if (pIndexPage != NULL)
 		{
-			pResultsTree = pIndexPage->getTree();
+			ResultsTree *pResultsTree = pIndexPage->getTree();
 			if (pResultsTree != NULL)
 			{
 				const vector<DocumentInfo> &docsList = pListThread->getDocuments();
@@ -1358,14 +1368,19 @@
 					isNewResult = true;
 				}
 				
-				if ((docId == 0) &&
-					((indexResults == QueryProperties::ALL_RESULTS) || (isNewResult == true)))
+				if ((indexResults == QueryProperties::ALL_RESULTS) || (isNewResult == true))
 				{
-					// This document is not in either index
-					docsToIndex.insert(*resultIter);
+					if ((docId == 0) ||
+						(indexId != m_settings.getIndexIdByName(_("My Documents"))))
+					{
+						// This document will be indexed or updated
+						docsToIndex.insert(*resultIter);
+					}
 				}
-				else if (labels.empty() == false)
+				else if ((docId > 0) &&
+					(labels.empty() == false))
 				{
+					// Apply this label
 					if (indexId == m_settings.getIndexIdByName(_("My Web Pages")))
 					{
 						docsIds.insert(docId);
@@ -1408,16 +1423,18 @@
 				groupMode = ResultsTree::BY_HOST;
 			}
 			// Position the results tree
-			pResultsTree = manage(new ResultsTree(queryName, resultsMenuitem->get_submenu(), groupMode, m_settings));
-			pResultsPage = manage(new ResultsPage(queryName, pResultsTree, m_pNotebook->get_height(), m_settings));
+			pResultsTree = manage(new ResultsTree(queryName, fileMenuitem->get_submenu(),
+				groupMode, m_settings));
+			pResultsPage = manage(new ResultsPage(queryName, pResultsTree,
+				m_pNotebook->get_height(), m_settings));
 			// Sync the results tree with the menuitems
-			pResultsTree->showExtract(showextract1->get_active());
+			pResultsTree->showExtract(showextracts1->get_active());
 			// Connect to the "changed" signal
 			pResultsTree->getSelectionChangedSignal().connect(
 				sigc::mem_fun(*this, &mainWindow::on_resultsTreeviewSelection_changed));
 			// Connect to the view results signal
 			pResultsTree->getDoubleClickSignal().connect(
-				sigc::mem_fun(*this, &mainWindow::on_viewresults_activate));
+				sigc::mem_fun(*this, &mainWindow::on_open_activate));
 
 			// Append the page
 			if (m_state.write_lock_lists() == true)
@@ -1815,10 +1832,71 @@
 }
 
 //
-// Session > Statistics menu selected
+// Suggest query button click
 //
-void mainWindow::on_statistics_activate()
+void mainWindow::on_suggestQueryButton_clicked(ustring queryName, ustring queryText)
 {
+	// Find the query
+	const std::map<string, QueryProperties> &queriesMap = m_settings.getQueries();
+	std::map<string, QueryProperties>::const_iterator queryIter = queriesMap.find(queryName);
+	if (queryIter != queriesMap.end())
+	{
+		QueryProperties queryProps(queryIter->second);
+
+		queryProps.setName("");
+		queryProps.setFreeQuery(queryText);
+		queryProps.setModified(true);
+
+		edit_query(queryProps, true);
+	}
+}
+
+//
+// Index back button click
+//
+void mainWindow::on_indexBackButton_clicked(ustring indexName)
+{
+	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
+	if (pIndexPage != NULL)
+	{
+		if (pIndexPage->getFirstDocument() >= m_maxDocsCount)
+		{
+			browse_index(indexName, pIndexPage->getQueryName(), pIndexPage->getFirstDocument() - m_maxDocsCount);
+		}
+	}
+}
+
+//
+// Index forward button click
+//
+void mainWindow::on_indexForwardButton_clicked(ustring indexName)
+{
+	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
+	if (pIndexPage != NULL)
+	{
+		if (pIndexPage->getDocumentsCount() == 0)
+		{
+#ifdef DEBUG
+			cout << "mainWindow::on_indexForwardButton_clicked: first" << endl;
+#endif
+			browse_index(indexName, pIndexPage->getQueryName(), 0);
+		}
+		else if (pIndexPage->getDocumentsCount() >= pIndexPage->getFirstDocument() + m_maxDocsCount)
+		{
+#ifdef DEBUG
+			cout << "mainWindow::on_indexForwardButton_clicked: next" << endl;
+#endif
+			browse_index(indexName, pIndexPage->getQueryName(), pIndexPage->getFirstDocument() + m_maxDocsCount);
+		}
+#ifdef DEBUG
+		cout << "mainWindow::on_indexForwardButton_clicked: counts "
+			<< pIndexPage->getFirstDocument() << " " << pIndexPage->getDocumentsCount() << endl;
+#endif
+	}
+}
+
+void mainWindow::on_status_activate()
+{
 	m_state.disconnect();
 
 	statisticsDialog statsDialog;
@@ -1828,10 +1906,7 @@
 	m_state.connect();
 }
 
-//
-// Edit > Preferences menu selected
-//
-void mainWindow::on_configure_activate()
+void mainWindow::on_preferences_activate()
 {
 	MIMEAction prefsAction("pinot-prefs", "pinot-prefs");
 	vector<string> arguments;
@@ -1842,17 +1917,11 @@
 	CommandLine::runAsync(prefsAction, arguments);
 }
 
-//
-// Session > Quit menu selected
-//
 void mainWindow::on_quit_activate()
 {
 	on_mainWindow_delete_event(NULL);
 }
 
-//
-// Edit > Cut menu selected
-//
 void mainWindow::on_cut_activate()
 {
 	// Copy
@@ -1861,9 +1930,6 @@
 	on_delete_activate();
 }
 
-//
-// Edit > Copy menu selected
-//
 void mainWindow::on_copy_activate()
 {
 	ustring text;
@@ -1892,38 +1958,17 @@
 			vector<DocumentInfo> documentsList;
 			bool firstItem = true;
 
-			ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-			if (pResultsPage != NULL)
+			ResultsTree *pResultsTree = pNotebookPage->getTree();
+			if (pResultsTree != NULL)
 			{
-#ifdef DEBUG
-				cout << "mainWindow::on_copy_activate: results tree" << endl;
-#endif
-				ResultsTree *pResultsTree = pResultsPage->getTree();
-				if (pResultsTree != NULL)
+				if (pResultsTree->focusOnExtract() == true)
 				{
-					if (pResultsTree->focusOnExtract() == true)
-					{
-						// Retrieve the extract
-						text = pResultsTree->getExtract();
-					}
-					else
-					{
-						// Get the current results selection
-						pResultsTree->getSelection(documentsList);
-					}
+					// Retrieve the extract
+					text = pResultsTree->getExtract();
 				}
-			}
-
-			IndexPage *pIndexPage = dynamic_cast<IndexPage*>(pNotebookPage);
-			if (pIndexPage != NULL)
-			{
-#ifdef DEBUG
-				cout << "mainWindow::on_copy_activate: index tree" << endl;
-#endif
-				ResultsTree *pResultsTree = pIndexPage->getTree();
-				if (pResultsTree != NULL)
+				else
 				{
-					// Get the current documents selection
+					// Get the current results selection
 					pResultsTree->getSelection(documentsList);
 				}
 			}
@@ -1964,9 +2009,6 @@
 	}
 }
 
-//
-// Edit > Paste menu selected
-//
 void mainWindow::on_paste_activate()
 {
 	RefPtr<Clipboard> refClipboard = Clipboard::get();
@@ -2008,9 +2050,6 @@
 	}
 }
 
-//
-// Edit > Delete menu selected
-//
 void mainWindow::on_delete_activate()
 {
 	if (liveQueryEntry->is_focus() == true)
@@ -2039,10 +2078,7 @@
 	// Nothing else can be deleted
 }
 
-//
-// Results > Clear menu selected
-//
-void mainWindow::on_clearresults_activate()
+void mainWindow::on_showextracts_activate()
 {
 	NotebookPageBox *pNotebookPage = get_current_page();
 	if (pNotebookPage != NULL)
@@ -2053,35 +2089,12 @@
 			ResultsTree *pResultsTree = pResultsPage->getTree();
 			if (pResultsTree != NULL)
 			{
-				pResultsTree->clear();
+				pResultsTree->showExtract(showextracts1->get_active());
 			}
 		}
 	}
 }
 
-//
-// Results > Show Extract menu selected
-//
-void mainWindow::on_showextract_activate()
-{
-	NotebookPageBox *pNotebookPage = get_current_page();
-	if (pNotebookPage != NULL)
-	{
-		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-		if (pResultsPage != NULL)
-		{
-			ResultsTree *pResultsTree = pResultsPage->getTree();
-			if (pResultsTree != NULL)
-			{
-				pResultsTree->showExtract(showextract1->get_active());
-			}
-		}
-	}
-}
-
-//
-// Results > Group menu selected
-//
 void mainWindow::on_groupresults_activate()
 {
 	// What's the new grouping criteria ?
@@ -2107,120 +2120,91 @@
 	}
 }
 
-//
-// Results > Export menu selected
-//
-void mainWindow::on_exportresults_activate()
+void mainWindow::on_export_activate()
 {
 	NotebookPageBox *pNotebookPage = get_current_page();
 	if (pNotebookPage != NULL)
 	{
-		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-		if (pResultsPage != NULL)
+		string queryName = from_utf8(pNotebookPage->getTitle());
+
+		IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_current_page());
+		if (pIndexPage != NULL)
 		{
-			ResultsTree *pResultsTree = pResultsPage->getTree();
-			if (pResultsTree != NULL)
-			{
-				FileChooserDialog fileChooser(_("Export Results"));
-				FileFilter csvFilter, xmlFilter;
-				ustring location(m_settings.getHomeDirectory());
-				bool exportToCSV = true;
+			queryName = from_utf8(pIndexPage->getQueryName());
+		}
 
-				location += "/";
-				location += pNotebookPage->getTitle();
-				location += ".csv";
-				prepare_file_chooser(fileChooser, location, false);
+		ResultsTree *pResultsTree = pNotebookPage->getTree();
+		if (pResultsTree != NULL)
+		{
+			FileChooserDialog fileChooser(_("Export"));
+			FileFilter csvFilter, xmlFilter;
+			ustring location(m_settings.getHomeDirectory());
+			bool exportToCSV = true;
 
-				// Add filters
-				csvFilter.add_mime_type("application/csv");
-				csvFilter.set_name("CSV");
-				fileChooser.add_filter(csvFilter);
-				xmlFilter.add_mime_type("application/xml");
-				xmlFilter.set_name("OpenSearch response");
-				fileChooser.add_filter(xmlFilter);
+			location += "/";
+			location += pNotebookPage->getTitle();
+			location += ".csv";
+			prepare_file_chooser(fileChooser, location, false);
 
-				fileChooser.show();
-				if (fileChooser.run() == RESPONSE_OK)
-				{
-					// Retrieve the chosen location
-					location = filename_to_utf8(fileChooser.get_filename());
-					// What file format was selected ?
-					const FileFilter *pFilter = fileChooser.get_filter();
-					if ((pFilter != NULL) &&
-						(pFilter->get_name() != "CSV"))
-					{
-						exportToCSV = false;
-					}
+			// Add filters
+			csvFilter.add_mime_type("application/csv");
+			csvFilter.set_name("CSV");
+			fileChooser.add_filter(csvFilter);
+			xmlFilter.add_mime_type("application/xml");
+			xmlFilter.set_name("OpenSearch response");
+			fileChooser.add_filter(xmlFilter);
 
-					pResultsTree->exportResults(location, exportToCSV);
-				}
-			}
-		}
-	}
-}
-
-//
-// Results > View menu selected
-//
-void mainWindow::on_viewresults_activate()
-{
-	NotebookPageBox *pNotebookPage = get_current_page();
-	if (pNotebookPage != NULL)
-	{
-		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-		if (pResultsPage != NULL)
-		{
-			ResultsTree *pResultsTree = pResultsPage->getTree();
-			if (pResultsTree != NULL)
+			fileChooser.show();
+			if (fileChooser.run() == RESPONSE_OK)
 			{
-				vector<DocumentInfo> resultsList;
-
-				if (pResultsTree->getSelection(resultsList) == true)
+				// Retrieve the chosen location
+				location = filename_to_utf8(fileChooser.get_filename());
+				// What file format was selected ?
+				const FileFilter *pFilter = fileChooser.get_filter();
+				if ((pFilter != NULL) &&
+					(pFilter->get_name() != "CSV"))
 				{
-					view_documents(resultsList);
-
-					// We can update the rows right now
-					pResultsTree->setSelectionState(true);
+					exportToCSV = false;
 				}
+
+				pResultsTree->exportResults(location, queryName, exportToCSV);
 			}
 		}
 	}
 }
 
-//
-// Results > More Like This menu selected
-//
 void mainWindow::on_morelikethis_activate()
 {
-	QueryProperties queryProps;
-	set<string> locations;
+	set<string> locationsToIndex;
+	ExpandSet expandSet;
 
 	// Get the current page's details
-	if (get_results_page_details("", queryProps, locations) == false)
+	if (get_results_page_details("", expandSet.m_queryProps, expandSet.m_locations, locationsToIndex) == false)
 	{
-		// Maybe the query was deleted
-		if (queryProps.getName().empty() == false)
-		{
-			ustring status(_("Couldn't find query"));
-			status += " ";
-			status += queryProps.getName();
-			set_status(status);
-		}
+		set_status(_("Couldn't find similar documents"));
 
 		return;
 	}
+	m_expandSets.push_back(expandSet);
 
-	if (locations.empty() == false)
+	for (set<string>::iterator locationIter = locationsToIndex.begin();
+		locationIter != locationsToIndex.end(); ++locationIter)
 	{
-		// Spawn a new thread
-		start_thread(new ExpandQueryThread(queryProps, locations));
+		DocumentInfo docInfo("", *locationIter, "", "");
+
+		// Add this to My Web Pages
+		m_state.queue_index(docInfo);
 	}
+
+	if (locationsToIndex.empty() == true)
+	{
+		// Expand on these documents right away
+		expand_locations();
+	}
+	// Else, do it when indexing is completed
 }
 
-//
-// Results > Index menu selected
-//
-void mainWindow::on_indexresults_activate()
+void mainWindow::on_addtoindex_activate()
 {
 	vector<DocumentInfo> resultsList;
 
@@ -2240,7 +2224,7 @@
 					resultIter != resultsList.end(); ++resultIter)
 				{
 #ifdef DEBUG
-					cout << "mainWindow::on_indexresults_activate: URL is " << resultIter->getLocation() << endl;
+					cout << "mainWindow::on_addtoindex_activate: URL is " << resultIter->getLocation() << endl;
 #endif
 					ustring status = m_state.queue_index(*resultIter);
 					if (status.empty() == false)
@@ -2253,9 +2237,6 @@
 	}
 }
 
-//
-// Index > Import menu selected
-//
 void mainWindow::on_import_activate()
 {
 	importDialog importBox;
@@ -2281,33 +2262,90 @@
 	}
 }
 
-//
-// Index > View menu selected
-//
-void mainWindow::on_viewfromindex_activate()
+void mainWindow::on_open_activate()
 {
-	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_current_page());
-	if (pIndexPage != NULL)
+	NotebookPageBox *pNotebookPage = get_current_page();
+	if (pNotebookPage != NULL)
 	{
-		ResultsTree *pResultsTree = pIndexPage->getTree();
+		ResultsTree *pResultsTree = pNotebookPage->getTree();
+		bool updateSelectionState = false;
 
+		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
+		if (pResultsPage != NULL)
+		{
+			updateSelectionState = true;
+		}
+
 		if (pResultsTree != NULL)
 		{
-			vector<DocumentInfo> documentsList;
+			vector<DocumentInfo> resultsList;
 
-			if (pResultsTree->getSelection(documentsList) == true)
+			if (pResultsTree->getSelection(resultsList) == true)
 			{
-				view_documents(documentsList);
+				view_documents(resultsList);
+
+				if (updateSelectionState == true)
+				{
+					// We can update the rows right now
+					pResultsTree->setSelectionState(true);
+				}
 			}
 		}
 	}
 }
 
-//
-// Index > Refresh menu selected
-//
-void mainWindow::on_refreshindex_activate()
+void mainWindow::on_openparent_activate()
 {
+	NotebookPageBox *pNotebookPage = get_current_page();
+	if (pNotebookPage != NULL)
+	{
+		ResultsTree *pResultsTree = pNotebookPage->getTree();
+		if (pResultsTree != NULL)
+		{
+			vector<DocumentInfo> resultsList;
+
+			if (pResultsTree->getSelection(resultsList) == true)
+			{
+				vector<DocumentInfo>::iterator resultIter = resultsList.begin();
+				while (resultIter != resultsList.end())
+				{
+					string location(resultIter->getLocation());
+					Url urlObj(location);
+					string::size_type slashPos = location.find_last_of("/");
+
+					if ((urlObj.isLocal() == true) &&
+						(slashPos != string::npos))
+					{
+						location.erase(slashPos);
+#ifdef DEBUG
+						cout << "mainWindow::on_openparent_activate: " << location << endl;
+#endif
+						resultIter->setLocation(location);
+						resultIter->setType("x-directory/normal");
+
+						// Next
+						++resultIter;
+					}
+					else
+					{
+						vector<DocumentInfo>::iterator nextIter = resultIter;
+						++nextIter;
+
+						resultsList.erase(resultIter);
+
+						// Next
+						resultIter = nextIter;
+					}
+				}
+
+				view_documents(resultsList);
+			}
+		}
+	}
+}
+
+void mainWindow::on_updateindex_activate()
+{
 	vector<DocumentInfo> documentsList;
 
 	// Get the current documents selection
@@ -2338,13 +2376,11 @@
 			continue;
 		}
 #ifdef DEBUG
-		cout << "mainWindow::on_refreshindex_activate: URL is " << docIter->getLocation() << endl;
+		cout << "mainWindow::on_updateindex_activate: URL is " << docIter->getLocation() << endl;
 #endif
 
 		// Add this action to the queue
-		DocumentInfo docInfo(*docIter);
-
-		ustring status = m_state.queue_index(docInfo);
+		ustring status = m_state.queue_index(*docIter);
 		if (status.empty() == false)
 		{
 			set_status(status);
@@ -2352,10 +2388,7 @@
 	}
 }
 
-//
-// Index > Show Properties menu selected
-//
-void mainWindow::on_showfromindex_activate()
+void mainWindow::on_properties_activate()
 {
 	vector<DocumentInfo> documentsList;
 	set<unsigned int> docIds;
@@ -2364,7 +2397,7 @@
 	bool docsIndex = false, daemonIndex = false;
 
 #ifdef DEBUG
-	cout << "mainWindow::on_showfromindex_activate: called" << endl;
+	cout << "mainWindow::on_properties_activate: called" << endl;
 #endif
 	ResultsTree *pResultsTree = NULL;
 	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_current_page());
@@ -2462,9 +2495,6 @@
 	}
 }
 
-//
-// Index > Unindex menu selected
-//
 void mainWindow::on_unindex_activate()
 {
 	vector<DocumentInfo> documentsList;
@@ -2527,9 +2557,6 @@
 	}
 }
 
-//
-// Help > About menu selected
-//
 void mainWindow::on_about_activate()
 {
 	AboutDialog aboutBox;
@@ -2747,9 +2774,6 @@
 	}
 }
 
-//
-// Return key pressed in live query entry field
-//
 void mainWindow::on_liveQueryEntry_activate()
 {
 	on_findButton_clicked();
@@ -2888,70 +2912,6 @@
 }
 
 //
-// Suggest query button click
-//
-void mainWindow::on_suggestQueryButton_clicked(ustring queryName, ustring queryText)
-{
-	// Find the query
-	const std::map<string, QueryProperties> &queriesMap = m_settings.getQueries();
-	std::map<string, QueryProperties>::const_iterator queryIter = queriesMap.find(queryName);
-	if (queryIter != queriesMap.end())
-	{
-		QueryProperties queryProps(queryIter->second);
-
-		queryProps.setName("");
-		queryProps.setFreeQuery(queryText);
-		queryProps.setModified(true);
-
-		edit_query(queryProps, true);
-	}
-}
-
-//
-// Index back button click
-//
-void mainWindow::on_indexBackButton_clicked(ustring indexName)
-{
-	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
-	if (pIndexPage != NULL)
-	{
-		if (pIndexPage->getFirstDocument() >= m_maxDocsCount)
-		{
-			browse_index(indexName, pIndexPage->getQueryName(), pIndexPage->getFirstDocument() - m_maxDocsCount);
-		}
-	}
-}
-
-//
-// Index forward button click
-//
-void mainWindow::on_indexForwardButton_clicked(ustring indexName)
-{
-	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
-	if (pIndexPage != NULL)
-	{
-		if (pIndexPage->getDocumentsCount() == 0)
-		{
-#ifdef DEBUG
-			cout << "mainWindow::on_indexForwardButton_clicked: first" << endl;
-#endif
-			browse_index(indexName, pIndexPage->getQueryName(), 0);
-		}
-		else if (pIndexPage->getDocumentsCount() >= pIndexPage->getFirstDocument() + m_maxDocsCount)
-		{
-#ifdef DEBUG
-			cout << "mainWindow::on_indexForwardButton_clicked: next" << endl;
-#endif
-			browse_index(indexName, pIndexPage->getQueryName(), pIndexPage->getFirstDocument() + m_maxDocsCount);
-		}
-#ifdef DEBUG
-		cout << "mainWindow::on_indexForwardButton_clicked: counts "
-			<< pIndexPage->getFirstDocument() << " " << pIndexPage->getDocumentsCount() << endl;
-#endif
-	}
-}
-
-//
 // Query list mouse click
 //
 bool mainWindow::on_queryTreeview_button_press_event(GdkEventButton *ev)
@@ -3024,11 +2984,10 @@
 //
 // Show or hide menuitems.
 //
-void mainWindow::show_global_menuitems(bool showItems)
+void mainWindow::show_pagebased_menuitems(bool showItems)
 {
 	// Results menuitems that depend on the page
-	exportresults1->set_sensitive(showItems);
-	clearresults1->set_sensitive(showItems);
+	export1->set_sensitive(showItems);
 }
 
 //
@@ -3036,18 +2995,16 @@
 //
 void mainWindow::show_selectionbased_menuitems(bool showItems)
 {
-	// Results menuitems that depend on selection
-	viewresults1->set_sensitive(showItems);
-	viewcache1->set_sensitive(showItems);
+	// Menuitems that depend on selection
+	open1->set_sensitive(showItems);
+	opencache1->set_sensitive(showItems);
+	openparent1->set_sensitive(showItems);
 	morelikethis1->set_sensitive(showItems);
-	searchagain1->set_sensitive(showItems);
-	indexresults1->set_sensitive(showItems);
-
-	// Index menuitems that depend on selection
-	viewfromindex1->set_sensitive(showItems);
-	refreshindex1->set_sensitive(showItems);
+	searchthisfor1->set_sensitive(showItems);
+	addtoindex1->set_sensitive(showItems);
+	updateindex1->set_sensitive(showItems);
 	unindex1->set_sensitive(showItems);
-	showfromindex1->set_sensitive(showItems);
+	properties1->set_sensitive(showItems);
 }
 
 //
@@ -3463,6 +3420,9 @@
 		string url(docIter->getLocation());
 		string mimeType(docIter->getType());
 
+#ifdef DEBUG
+		cout << "mainWindow::view_documents: " << url << endl;
+#endif
 		if (url.empty() == true)
 		{
 			continue;
@@ -3493,13 +3453,6 @@
 			mimeType = MIMEScanner::scanUrl(urlObj);
 		}
 
-		// Remove the charset, if any
-		string::size_type semiColonPos = mimeType.find(";");
-		if (semiColonPos != string::npos)
-		{
-			mimeType.erase(semiColonPos);
-		}
-
 #ifdef DEBUG
 		cout << "mainWindow::view_documents: " << url << " has type " << mimeType << endl;
 #endif
@@ -3709,27 +3662,27 @@
 
 bool mainWindow::expand_locations(void)
 {
-	// Was an expand operation delayed by indexing ?
-	if (m_expandLocations.empty() == true)
+	ExpandQueryThread *pExpandQueryThread = NULL;
+
+	// Grab the first set
+	vector<ExpandSet>::iterator expandIter = m_expandSets.begin();
+	if (expandIter != m_expandSets.end())
 	{
-		return false;
+		pExpandQueryThread = new ExpandQueryThread(expandIter->m_queryProps, expandIter->m_locations);
+#ifdef DEBUG
+		cout << "mainWindow::expand_locations: " << expandIter->m_locations.size() << " locations in set" << endl;
+#endif
+
+		m_expandSets.erase(expandIter);
 	}
 
-	Url urlObj(*m_expandLocations.begin());
-	string queryName(urlObj.getFile());
-
-	if (m_expandLocations.size() > 1)
+	if (pExpandQueryThread != NULL)
 	{
-		queryName += "...";
+		// Run a catch-all query and expand on these documents
+		return start_thread(pExpandQueryThread);
 	}
-	QueryProperties queryProps(queryName, "dir:/");
 
-	// Run a catch-all query and expand on these documents
-	ExpandQueryThread *pExpandQueryThread = new ExpandQueryThread(queryProps, m_expandLocations);
-	m_expandLocations.clear();
-	start_thread(pExpandQueryThread);
-
-	return true;
+	return false;
 }
 
 //

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2008-12-29 18:32:55 UTC (rev 1455)
+++ trunk/UI/GTK2/src/mainWindow.hh	2008-12-30 14:03:54 UTC (rev 1456)
@@ -65,72 +65,65 @@
 	void populate_findMenu();
 	void add_query(QueryProperties &queryProps, bool mergeQueries);
 	bool get_results_page_details(const Glib::ustring &queryName,
-		QueryProperties &queryProps, std::set<std::string> &locations);
+		QueryProperties &queryProps, std::set<std::string> &locations,
+		std::set<std::string> &locationsToIndex);
 
 	// Handlers
 	void on_data_received(const Glib::RefPtr<Gdk::DragContext> &context,
-		int x, int y, const Gtk::SelectionData &data, guint info, guint time);
+		int x, int y, const Gtk::SelectionData &data, guint info, guint dataTime);
 	void on_enginesTreeviewSelection_changed();
 	void on_queryTreeviewSelection_changed();
 	void on_resultsTreeviewSelection_changed(Glib::ustring queryName);
 	void on_indexTreeviewSelection_changed(Glib::ustring indexName);
+	void on_document_changed(std::vector<DocumentInfo> &resultsList,
+		bool isDocumentsIndex, bool editDocument, bool areResults);
 	void on_index_changed(Glib::ustring indexName);
 	void on_cache_changed(PinotSettings::CacheProvider cacheProvider);
-	void on_searchagain_changed(Glib::ustring queryName);
+	void on_searchthis_changed(Glib::ustring queryName);
 	void on_query_changed(Glib::ustring indexName, Glib::ustring queryName);
 	void on_switch_page(GtkNotebookPage *p0, guint p1);
 	void on_close_page(Glib::ustring title, NotebookPageBox::PageType type);
 	void on_thread_end(WorkerThread *pThread);
 	void on_editindex(Glib::ustring indexName, Glib::ustring location);
+	void on_suggestQueryButton_clicked(Glib::ustring queryName, Glib::ustring queryText);
+	void on_indexBackButton_clicked(Glib::ustring indexName);
+	void on_indexForwardButton_clicked(Glib::ustring indexName);
 
 	// Handlers inherited from the base class
-	virtual void on_statistics_activate();
-	virtual void on_configure_activate();
-	virtual void on_quit_activate();
+        virtual void on_open_activate();
+        virtual void on_openparent_activate();
+        virtual void on_addtoindex_activate();
+        virtual void on_updateindex_activate();
+        virtual void on_unindex_activate();
+        virtual void on_morelikethis_activate();
+        virtual void on_properties_activate();
+        virtual void on_quit_activate();
+        virtual void on_cut_activate();
+        virtual void on_copy_activate();
+        virtual void on_paste_activate();
+        virtual void on_delete_activate();
+        virtual void on_preferences_activate();
+        virtual void on_groupresults_activate();
+        virtual void on_showextracts_activate();
+        virtual void on_import_activate();
+        virtual void on_export_activate();
+        virtual void on_status_activate();
+        virtual void on_about_activate();
+        virtual void on_addIndexButton_clicked();
+        virtual void on_removeIndexButton_clicked();
+        virtual void on_enginesTogglebutton_toggled();
+        virtual void on_liveQueryEntry_changed();
+        virtual void on_liveQueryEntry_activate();
+        virtual void on_findButton_clicked();
+        virtual bool on_queryTreeview_button_press_event(GdkEventButton *ev);
+        virtual void on_addQueryButton_clicked();
+        virtual void on_removeQueryButton_clicked();
+        virtual void on_queryHistoryButton_clicked();
+        virtual void on_findQueryButton_clicked();
+        virtual bool on_mainWindow_delete_event(GdkEventAny *ev);
 
-	virtual void on_cut_activate();
-	virtual void on_copy_activate();
-	virtual void on_paste_activate();
-	virtual void on_delete_activate();
-
-	virtual void on_clearresults_activate();
-	virtual void on_showextract_activate();
-	virtual void on_groupresults_activate();
-	virtual void on_exportresults_activate();
-	virtual void on_viewresults_activate();
-	virtual void on_morelikethis_activate();
-	virtual void on_indexresults_activate();
-
-	virtual void on_import_activate();
-	virtual void on_viewfromindex_activate();
-	virtual void on_refreshindex_activate();
-	virtual void on_unindex_activate();
-	virtual void on_showfromindex_activate();
-
-	virtual void on_about_activate();
-
-	virtual void on_addIndexButton_clicked();
-	virtual void on_removeIndexButton_clicked();
-
-	virtual void on_enginesTogglebutton_toggled();
-
-	virtual void on_liveQueryEntry_changed();
-	virtual void on_liveQueryEntry_activate();
-	virtual void on_findButton_clicked();
-	virtual void on_addQueryButton_clicked();
-	virtual void on_removeQueryButton_clicked();
-	virtual void on_queryHistoryButton_clicked();
-	virtual void on_findQueryButton_clicked();
-	virtual void on_suggestQueryButton_clicked(Glib::ustring queryName, Glib::ustring queryText);
-
-	virtual void on_indexBackButton_clicked(Glib::ustring indexName);
-	virtual void on_indexForwardButton_clicked(Glib::ustring indexName);
-
-	virtual bool on_queryTreeview_button_press_event(GdkEventButton *ev);
-	virtual bool on_mainWindow_delete_event(GdkEventAny *ev);
-
 	// Action methods
-	void show_global_menuitems(bool showItems);
+	void show_pagebased_menuitems(bool showItems);
 	void show_selectionbased_menuitems(bool showItems);
 	NotebookPageBox *get_current_page(void);
 	NotebookPageBox *get_page(const Glib::ustring &title,
@@ -161,7 +154,17 @@
 	Glib::RefPtr<Gtk::EntryCompletion> m_refLiveQueryCompletion;
 	QueryModelColumns m_queryColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refQueryTree;
-	std::set<std::string> m_expandLocations;
+	class ExpandSet
+	{
+		public:
+			ExpandSet();
+			~ExpandSet();
+
+			QueryProperties m_queryProps;
+			set<string> m_locations;
+
+	};
+	std::vector<ExpandSet> m_expandSets;
 	// Notebook
 	Gtk::Notebook *m_pNotebook;
 	// Menus

Modified: trunk/UI/GTK2/src/mainWindow_glade.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.cc	2008-12-29 18:32:55 UTC (rev 1455)
+++ trunk/UI/GTK2/src/mainWindow_glade.cc	2008-12-30 14:03:54 UTC (rev 1456)
@@ -1,9 +1,9 @@
-// generated 2007/9/26 23:15:09 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2008/12/30 0:57:52 SGT by fabrice at rexor.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.14 and gtkmm 2.10.11
+// for gtk 2.14.5 and gtkmm 2.14.3
 //
 // Please modify the corresponding derived classes in ./src/mainWindow.cc
 
@@ -38,8 +38,9 @@
 #include <gtkmm/accelgroup.h>
 #include <gtk/gtkimagemenuitem.h>
 #include <gtkmm/menuitem.h>
+#include <gtkmm/image.h>
 #include <gtkmm/menu.h>
-#include <gtkmm/image.h>
+#include <gtkmm/imagemenuitem.h>
 #include <gtkmm/menubar.h>
 #include <gtkmm/box.h>
 #include <gtkmm/label.h>
@@ -60,51 +61,53 @@
 ) : Gtk::Window(Gtk::WINDOW_TOPLEVEL)
 {  mainWindow = this;
    gmm_data = new GlademmData(get_accel_group());
-   configure1 = NULL;
+   open1 = NULL;
    
-   Gtk::MenuItem *statistics1 = NULL;
+   Gtk::MenuItem *separator7 = NULL;
+   opencache1 = NULL;
+   Gtk::Image *image995 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-go-up"), Gtk::IconSize(1)));
+   openparent1 = NULL;
+   Gtk::MenuItem *separator8 = NULL;
+   Gtk::Image *image996 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-add"), Gtk::IconSize(1)));
+   addtoindex1 = NULL;
+   Gtk::Image *image997 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-refresh"), Gtk::IconSize(1)));
+   updateindex1 = NULL;
+   Gtk::Image *image998 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-delete"), Gtk::IconSize(1)));
+   unindex1 = NULL;
+   Gtk::MenuItem *separator9 = NULL;
+   morelikethis1 = NULL;
+   searchthisfor1 = NULL;
+   Gtk::MenuItem *separator10 = NULL;
+   properties1 = NULL;
    separatormenuitem1 = NULL;
    quit1 = NULL;
-   Gtk::Menu *sessionMenuitem_menu = Gtk::manage(new class Gtk::Menu());
-   sessionMenuitem = NULL;
+   Gtk::Menu *fileMenuitem_menu = Gtk::manage(new class Gtk::Menu());
+   fileMenuitem = NULL;
    cut1 = NULL;
    copy1 = NULL;
    paste1 = NULL;
    delete1 = NULL;
+   Gtk::MenuItem *separator5 = NULL;
+   preferences1 = NULL;
    Gtk::Menu *editMenuitem_menu = Gtk::manage(new class Gtk::Menu());
    editMenuitem = NULL;
-   showextract1 = NULL;
+   listcontents1 = NULL;
    Gtk::RadioMenuItem::Group _RadioMIGroup_searchenginegroup1;
    searchenginegroup1 = NULL;
    hostnamegroup1 = NULL;
    Gtk::Menu *groupresults1_menu = Gtk::manage(new class Gtk::Menu());
    groupresults1 = NULL;
-   exportresults1 = NULL;
-   Gtk::Image *image718 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-clear"), Gtk::IconSize(1)));
-   clearresults1 = NULL;
-   Gtk::MenuItem *separator1 = NULL;
-   viewresults1 = NULL;
-   viewcache1 = NULL;
-   Gtk::Image *image719 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-add"), Gtk::IconSize(1)));
-   morelikethis1 = NULL;
-   Gtk::Image *image720 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-find"), Gtk::IconSize(1)));
-   searchagain1 = NULL;
-   indexresults1 = NULL;
-   Gtk::Menu *resultsMenuitem_menu = Gtk::manage(new class Gtk::Menu());
-   resultsMenuitem = NULL;
-   list1 = NULL;
-   Gtk::Image *image721 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(1)));
+   showextracts1 = NULL;
+   Gtk::MenuItem *separator4 = NULL;
+   Gtk::Image *image999 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(1)));
    import1 = NULL;
-   Gtk::MenuItem *separator3 = NULL;
-   viewfromindex1 = NULL;
-   Gtk::Image *image722 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-refresh"), Gtk::IconSize(1)));
-   refreshindex1 = NULL;
-   Gtk::Image *image723 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-delete"), Gtk::IconSize(1)));
-   unindex1 = NULL;
-   Gtk::Image *image724 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-properties"), Gtk::IconSize(1)));
-   showfromindex1 = NULL;
-   Gtk::Menu *indexMenuitem_menu = Gtk::manage(new class Gtk::Menu());
-   indexMenuitem = NULL;
+   Gtk::Image *image1000 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-save-as"), Gtk::IconSize(1)));
+   export1 = NULL;
+   Gtk::MenuItem *separator6 = NULL;
+   Gtk::Image *image1001 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-info"), Gtk::IconSize(1)));
+   Gtk::ImageMenuItem *status1 = NULL;
+   Gtk::Menu *optionsMenuitem_menu = Gtk::manage(new class Gtk::Menu());
+   Gtk::MenuItem *optionsMenuitem = NULL;
    about1 = NULL;
    Gtk::Menu *helpMenuitem_menu = Gtk::manage(new class Gtk::Menu());
    helpMenuitem = NULL;
@@ -140,7 +143,11 @@
    Gtk::VButtonBox *queryVbuttonbox = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
    Gtk::HBox *queryHbox = Gtk::manage(new class Gtk::HBox(false, 0));
    Gtk::Label *queryLabel = Gtk::manage(new class Gtk::Label(_("Stored queries")));
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
    queryExpander = Gtk::manage(new class Gtk::Expander());
+#else //
+   queryExpander = Gtk::manage(new class Gtk::HandleBox());
+#endif //
    rightVbox = Gtk::manage(new class Gtk::VBox(false, 0));
    mainHpaned = Gtk::manage(new class Gtk::HPaned());
    mainProgressbar = Gtk::manage(new class Gtk::ProgressBar());
@@ -149,18 +156,51 @@
    Gtk::HBox *mainHbox = Gtk::manage(new class Gtk::HBox(false, 0));
    Gtk::VBox *mainVbox = Gtk::manage(new class Gtk::VBox(false, 0));
    
-   sessionMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-preferences")));
-   configure1 = (Gtk::ImageMenuItem *)&sessionMenuitem_menu->items().back();
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-open")));
+   open1 = (Gtk::ImageMenuItem *)&fileMenuitem_menu->items().back();
    
-   sessionMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("Status")));
-   statistics1 = (Gtk::MenuItem *)&sessionMenuitem_menu->items().back();
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
+   separator7 = (Gtk::MenuItem *)&fileMenuitem_menu->items().back();
    
-   sessionMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
-   separatormenuitem1 = (Gtk::MenuItem *)&sessionMenuitem_menu->items().back();
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("Open Cache")));
+   opencache1 = (Gtk::MenuItem *)&fileMenuitem_menu->items().back();
    
-   sessionMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-quit")));
-   quit1 = (Gtk::ImageMenuItem *)&sessionMenuitem_menu->items().back();
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Open Parent"), *image995));
+   openparent1 = (Gtk::ImageMenuItem *)&fileMenuitem_menu->items().back();
    
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
+   separator8 = (Gtk::MenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("_Add To Index"), *image996));
+   addtoindex1 = (Gtk::ImageMenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Update"), *image997));
+   updateindex1 = (Gtk::ImageMenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Unindex"), *image998));
+   unindex1 = (Gtk::ImageMenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
+   separator9 = (Gtk::MenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("More Like This")));
+   morelikethis1 = (Gtk::MenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("Search This For")));
+   searchthisfor1 = (Gtk::MenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
+   separator10 = (Gtk::MenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-properties")));
+   properties1 = (Gtk::ImageMenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
+   separatormenuitem1 = (Gtk::MenuItem *)&fileMenuitem_menu->items().back();
+   
+   fileMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-quit")));
+   quit1 = (Gtk::ImageMenuItem *)&fileMenuitem_menu->items().back();
+   
    editMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-cut")));
    cut1 = (Gtk::ImageMenuItem *)&editMenuitem_menu->items().back();
    
@@ -173,97 +213,73 @@
    editMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-delete")));
    delete1 = (Gtk::ImageMenuItem *)&editMenuitem_menu->items().back();
    
+   editMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
+   separator5 = (Gtk::MenuItem *)&editMenuitem_menu->items().back();
+   
+   editMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-preferences")));
+   preferences1 = (Gtk::ImageMenuItem *)&editMenuitem_menu->items().back();
+   
    groupresults1_menu->items().push_back(Gtk::Menu_Helpers::RadioMenuElem(_RadioMIGroup_searchenginegroup1, _("Search Engine")));
    searchenginegroup1 = (Gtk::RadioMenuItem *)&groupresults1_menu->items().back();
    
    groupresults1_menu->items().push_back(Gtk::Menu_Helpers::RadioMenuElem(_RadioMIGroup_searchenginegroup1, _("Host Name")));
    hostnamegroup1 = (Gtk::RadioMenuItem *)&groupresults1_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::CheckMenuElem(_("Show Extract")));
-   showextract1 = (Gtk::CheckMenuItem *)&resultsMenuitem_menu->items().back();
+   optionsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("List Contents Of")));
+   listcontents1 = (Gtk::MenuItem *)&optionsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("Group By"), *groupresults1_menu));
-   groupresults1 = (Gtk::MenuItem *)&resultsMenuitem_menu->items().back();
+   optionsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("Group Results By"), *groupresults1_menu));
+   groupresults1 = (Gtk::MenuItem *)&optionsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-save-as")));
-   exportresults1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
+   optionsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::CheckMenuElem(_("Show Extracts")));
+   showextracts1 = (Gtk::CheckMenuItem *)&optionsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Clear List"), *image718));
-   clearresults1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
+   optionsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
+   separator4 = (Gtk::MenuItem *)&optionsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
-   separator1 = (Gtk::MenuItem *)&resultsMenuitem_menu->items().back();
+   optionsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Import URL"), *image999));
+   import1 = (Gtk::ImageMenuItem *)&optionsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("Vie_w")));
-   viewresults1 = (Gtk::MenuItem *)&resultsMenuitem_menu->items().back();
+   optionsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Export List"), *image1000));
+   export1 = (Gtk::ImageMenuItem *)&optionsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("View Cache")));
-   viewcache1 = (Gtk::MenuItem *)&resultsMenuitem_menu->items().back();
+   optionsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
+   separator6 = (Gtk::MenuItem *)&optionsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("More Like This"), *image719));
-   morelikethis1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
+   optionsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Status"), *image1001));
+   status1 = (Gtk::ImageMenuItem *)&optionsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Search This For"), *image720));
-   searchagain1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
-   
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Index")));
-   indexresults1 = (Gtk::MenuItem *)&resultsMenuitem_menu->items().back();
-   
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("List Contents Of")));
-   list1 = (Gtk::MenuItem *)&indexMenuitem_menu->items().back();
-   
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Import URL"), *image721));
-   import1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
-   
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
-   separator3 = (Gtk::MenuItem *)&indexMenuitem_menu->items().back();
-   
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("View")));
-   viewfromindex1 = (Gtk::MenuItem *)&indexMenuitem_menu->items().back();
-   
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Update"), *image722));
-   refreshindex1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
-   
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Unindex"), *image723));
-   unindex1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
-   
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Properties"), *image724));
-   showfromindex1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
-   
    helpMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_About")));
    about1 = (Gtk::MenuItem *)&helpMenuitem_menu->items().back();
    
-   mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Session"), *sessionMenuitem_menu));
-   sessionMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
+   mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_File"), *fileMenuitem_menu));
+   fileMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
    
    mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Edit"), *editMenuitem_menu));
    editMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
    
-   mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Results"), *resultsMenuitem_menu));
-   resultsMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
+   mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Options"), *optionsMenuitem_menu));
+   optionsMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
    
-   mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Index"), *indexMenuitem_menu));
-   indexMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
-   
    mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Help"), *helpMenuitem_menu));
    helpMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
-   showextract1->set_active(true);
+   image995->set_alignment(0.5,0.5);
+   image995->set_padding(0,0);
+   image996->set_alignment(0.5,0.5);
+   image996->set_padding(0,0);
+   image997->set_alignment(0.5,0.5);
+   image997->set_padding(0,0);
+   image998->set_alignment(0.5,0.5);
+   image998->set_padding(0,0);
    searchenginegroup1->set_active(true);
    hostnamegroup1->set_active(false);
-   image718->set_alignment(0.5,0.5);
-   image718->set_padding(0,0);
-   image719->set_alignment(0.5,0.5);
-   image719->set_padding(0,0);
-   image720->set_alignment(0.5,0.5);
-   image720->set_padding(0,0);
-   image721->set_alignment(0.5,0.5);
-   image721->set_padding(0,0);
-   image722->set_alignment(0.5,0.5);
-   image722->set_padding(0,0);
-   image723->set_alignment(0.5,0.5);
-   image723->set_padding(0,0);
-   image724->set_alignment(0.5,0.5);
-   image724->set_padding(0,0);
+   showextracts1->set_active(true);
+   image999->set_alignment(0.5,0.5);
+   image999->set_padding(0,0);
+   image1000->set_alignment(0.5,0.5);
+   image1000->set_padding(0,0);
+   image1001->set_alignment(0.5,0.5);
+   image1001->set_padding(0,0);
    image439->set_alignment(0.5,0.5);
    image439->set_padding(0,0);
    addIndexButton->set_flags(Gtk::CAN_FOCUS);
@@ -381,44 +397,47 @@
    mainWindow->set_resizable(true);
    mainWindow->property_destroy_with_parent().set_value(false);
    mainWindow->add(*mainVbox);
-   configure1->show();
-   statistics1->show();
+   open1->show();
+   separator7->show();
+   opencache1->show();
+   image995->show();
+   openparent1->show();
+   separator8->show();
+   image996->show();
+   addtoindex1->show();
+   image997->show();
+   updateindex1->show();
+   image998->show();
+   unindex1->show();
+   separator9->show();
+   morelikethis1->show();
+   searchthisfor1->show();
+   separator10->show();
+   properties1->show();
    separatormenuitem1->show();
    quit1->show();
-   sessionMenuitem->show();
+   fileMenuitem->show();
    cut1->show();
    copy1->show();
    paste1->show();
    delete1->show();
+   separator5->show();
+   preferences1->show();
    editMenuitem->show();
-   showextract1->show();
+   listcontents1->show();
    searchenginegroup1->show();
    hostnamegroup1->show();
    groupresults1->show();
-   exportresults1->show();
-   image718->show();
-   clearresults1->show();
-   separator1->show();
-   viewresults1->show();
-   viewcache1->show();
-   image719->show();
-   morelikethis1->show();
-   image720->show();
-   searchagain1->show();
-   indexresults1->show();
-   resultsMenuitem->show();
-   list1->show();
-   image721->show();
+   showextracts1->show();
+   separator4->show();
+   image999->show();
    import1->show();
-   separator3->show();
-   viewfromindex1->show();
-   image722->show();
-   refreshindex1->show();
-   image723->show();
-   unindex1->show();
-   image724->show();
-   showfromindex1->show();
-   indexMenuitem->show();
+   image1000->show();
+   export1->show();
+   separator6->show();
+   image1001->show();
+   status1->show();
+   optionsMenuitem->show();
    about1->show();
    helpMenuitem->show();
    mainMenubar->show();
@@ -451,25 +470,24 @@
    mainStatusbar->show();
    mainHbox->show();
    mainVbox->show();
-   configure1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_configure_activate), false);
-   statistics1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_statistics_activate), false);
+   open1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_open_activate), false);
+   openparent1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_openparent_activate), false);
+   addtoindex1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_addtoindex_activate), false);
+   updateindex1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_updateindex_activate), false);
+   unindex1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_unindex_activate), false);
+   morelikethis1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_morelikethis_activate), false);
+   properties1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_properties_activate), false);
    quit1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_quit_activate), false);
    cut1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_cut_activate), false);
    copy1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_copy_activate), false);
    paste1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_paste_activate), false);
    delete1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_delete_activate), false);
-   showextract1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_showextract_activate), false);
+   preferences1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_preferences_activate), false);
    searchenginegroup1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_groupresults_activate), false);
-   exportresults1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_exportresults_activate), false);
-   clearresults1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_clearresults_activate), false);
-   viewresults1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_viewresults_activate), false);
-   morelikethis1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_morelikethis_activate), false);
-   indexresults1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_indexresults_activate), false);
+   showextracts1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_showextracts_activate), false);
    import1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_import_activate), false);
-   viewfromindex1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_viewfromindex_activate), false);
-   refreshindex1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_refreshindex_activate), false);
-   unindex1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_unindex_activate), false);
-   showfromindex1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_showfromindex_activate), false);
+   export1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_export_activate), false);
+   status1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_status_activate), false);
    about1->signal_activate().connect(sigc::mem_fun(*this, &mainWindow_glade::on_about_activate), false);
    addIndexButton->signal_clicked().connect(sigc::mem_fun(*this, &mainWindow_glade::on_addIndexButton_clicked), false);
    removeIndexButton->signal_clicked().connect(sigc::mem_fun(*this, &mainWindow_glade::on_removeIndexButton_clicked), false);

Modified: trunk/UI/GTK2/src/mainWindow_glade.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.hh	2008-12-29 18:32:55 UTC (rev 1455)
+++ trunk/UI/GTK2/src/mainWindow_glade.hh	2008-12-30 14:03:54 UTC (rev 1456)
@@ -1,9 +1,9 @@
-// generated 2007/9/26 23:15:09 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2008/12/30 0:57:52 SGT by fabrice at rexor.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.14 and gtkmm 2.10.11
+// for gtk 2.14.5 and gtkmm 2.14.3
 //
 // Please modify the corresponding derived classes in ./src/mainWindow.hh and./src/mainWindow.cc
 
@@ -34,8 +34,8 @@
 #include <gtkmm/window.h>
 #include <gtkmm/imagemenuitem.h>
 #include <gtkmm/menuitem.h>
-#include <gtkmm/checkmenuitem.h>
 #include <gtkmm/radiomenuitem.h>
+#include <gtkmm/checkmenuitem.h>
 #include <gtkmm/box.h>
 #include <gtkmm/button.h>
 #include <gtkmm/togglebutton.h>
@@ -54,34 +54,31 @@
 public:
         class Gtk::Window * mainWindow;
 protected:
-        class Gtk::ImageMenuItem * configure1;
+        class Gtk::ImageMenuItem * open1;
+        class Gtk::MenuItem * opencache1;
+        class Gtk::ImageMenuItem * openparent1;
+        class Gtk::ImageMenuItem * addtoindex1;
+        class Gtk::ImageMenuItem * updateindex1;
+        class Gtk::ImageMenuItem * unindex1;
+        class Gtk::MenuItem * morelikethis1;
+        class Gtk::MenuItem * searchthisfor1;
+        class Gtk::ImageMenuItem * properties1;
         class Gtk::MenuItem * separatormenuitem1;
         class Gtk::ImageMenuItem * quit1;
-        class Gtk::MenuItem * sessionMenuitem;
+        class Gtk::MenuItem * fileMenuitem;
         class Gtk::ImageMenuItem * cut1;
         class Gtk::ImageMenuItem * copy1;
         class Gtk::ImageMenuItem * paste1;
         class Gtk::ImageMenuItem * delete1;
+        class Gtk::ImageMenuItem * preferences1;
         class Gtk::MenuItem * editMenuitem;
-        class Gtk::CheckMenuItem * showextract1;
+        class Gtk::MenuItem * listcontents1;
         class Gtk::RadioMenuItem * searchenginegroup1;
         class Gtk::RadioMenuItem * hostnamegroup1;
         class Gtk::MenuItem * groupresults1;
-        class Gtk::ImageMenuItem * exportresults1;
-        class Gtk::ImageMenuItem * clearresults1;
-        class Gtk::MenuItem * viewresults1;
-        class Gtk::MenuItem * viewcache1;
-        class Gtk::ImageMenuItem * morelikethis1;
-        class Gtk::ImageMenuItem * searchagain1;
-        class Gtk::MenuItem * indexresults1;
-        class Gtk::MenuItem * resultsMenuitem;
-        class Gtk::MenuItem * list1;
+        class Gtk::CheckMenuItem * showextracts1;
         class Gtk::ImageMenuItem * import1;
-        class Gtk::MenuItem * viewfromindex1;
-        class Gtk::ImageMenuItem * refreshindex1;
-        class Gtk::ImageMenuItem * unindex1;
-        class Gtk::ImageMenuItem * showfromindex1;
-        class Gtk::MenuItem * indexMenuitem;
+        class Gtk::ImageMenuItem * export1;
         class Gtk::MenuItem * about1;
         class Gtk::MenuItem * helpMenuitem;
         class Gtk::VBox * enginesVbox;
@@ -106,25 +103,24 @@
         
         ~mainWindow_glade();
 private:
-        virtual void on_configure_activate() = 0;
-        virtual void on_statistics_activate() = 0;
+        virtual void on_open_activate() = 0;
+        virtual void on_openparent_activate() = 0;
+        virtual void on_addtoindex_activate() = 0;
+        virtual void on_updateindex_activate() = 0;
+        virtual void on_unindex_activate() = 0;
+        virtual void on_morelikethis_activate() = 0;
+        virtual void on_properties_activate() = 0;
         virtual void on_quit_activate() = 0;
         virtual void on_cut_activate() = 0;
         virtual void on_copy_activate() = 0;
         virtual void on_paste_activate() = 0;
         virtual void on_delete_activate() = 0;
-        virtual void on_showextract_activate() = 0;
+        virtual void on_preferences_activate() = 0;
         virtual void on_groupresults_activate() = 0;
-        virtual void on_exportresults_activate() = 0;
-        virtual void on_clearresults_activate() = 0;
-        virtual void on_viewresults_activate() = 0;
-        virtual void on_morelikethis_activate() = 0;
-        virtual void on_indexresults_activate() = 0;
+        virtual void on_showextracts_activate() = 0;
         virtual void on_import_activate() = 0;
-        virtual void on_viewfromindex_activate() = 0;
-        virtual void on_refreshindex_activate() = 0;
-        virtual void on_unindex_activate() = 0;
-        virtual void on_showfromindex_activate() = 0;
+        virtual void on_export_activate() = 0;
+        virtual void on_status_activate() = 0;
         virtual void on_about_activate() = 0;
         virtual void on_addIndexButton_clicked() = 0;
         virtual void on_removeIndexButton_clicked() = 0;



From fabricecolin at mail.berlios.de  Tue Dec 30 15:08:11 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Tue, 30 Dec 2008 15:08:11 +0100
Subject: [Pinot-svn] r1457 - trunk/UI/GTK2
Message-ID: <200812301408.mBUE8BCU022614@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-30 15:08:09 +0100 (Tue, 30 Dec 2008)
New Revision: 1457

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
Log:
Reorganized menus in mainWindow, moved tabs in prefsWindow.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2008-12-30 14:03:54 UTC (rev 1456)
+++ trunk/UI/GTK2/metase-gtk2.glade	2008-12-30 14:08:09 UTC (rev 1457)
@@ -36,35 +36,176 @@
 	  <property name="child_pack_direction">GTK_PACK_DIRECTION_LTR</property>
 
 	  <child>
-	    <widget class="GtkMenuItem" id="sessionMenuitem">
+	    <widget class="GtkMenuItem" id="fileMenuitem">
 	      <property agent="glademm" name="cxx_visibility">protected</property>
 	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">_Session</property>
+	      <property name="label" translatable="yes">_File</property>
 	      <property name="use_underline">True</property>
 
 	      <child>
-		<widget class="GtkMenu" id="sessionMenuitem_menu">
+		<widget class="GtkMenu" id="fileMenuitem_menu">
 
 		  <child>
-		    <widget class="GtkImageMenuItem" id="configure1">
+		    <widget class="GtkImageMenuItem" id="open1">
 		      <property agent="glademm" name="cxx_visibility">protected</property>
 		      <property name="visible">True</property>
-		      <property name="label">gtk-preferences</property>
+		      <property name="label">gtk-open</property>
 		      <property name="use_stock">True</property>
-		      <signal name="activate" handler="on_configure_activate" last_modification_time="Fri, 20 Feb 2004 18:58:55 GMT"/>
+		      <signal name="activate" handler="on_open_activate" last_modification_time="Sat, 27 Dec 2008 11:38:10 GMT"/>
 		    </widget>
 		  </child>
 
 		  <child>
-		    <widget class="GtkMenuItem" id="statistics1">
+		    <widget class="GtkSeparatorMenuItem" id="separator7">
 		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Status</property>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkMenuItem" id="opencache1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Open Cache</property>
 		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_statistics_activate" last_modification_time="Sun, 31 Dec 2006 11:01:47 GMT"/>
 		    </widget>
 		  </child>
 
 		  <child>
+		    <widget class="GtkImageMenuItem" id="openparent1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Open Parent</property>
+		      <property name="use_underline">True</property>
+		      <signal name="activate" handler="on_openparent_activate" last_modification_time="Sat, 27 Dec 2008 11:38:10 GMT"/>
+
+		      <child internal-child="image">
+			<widget class="GtkImage" id="image995">
+			  <property name="visible">True</property>
+			  <property name="stock">gtk-go-up</property>
+			  <property name="icon_size">1</property>
+			  <property name="xalign">0.5</property>
+			  <property name="yalign">0.5</property>
+			  <property name="xpad">0</property>
+			  <property name="ypad">0</property>
+			</widget>
+		      </child>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkSeparatorMenuItem" id="separator8">
+		      <property name="visible">True</property>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkImageMenuItem" id="addtoindex1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">_Add To Index</property>
+		      <property name="use_underline">True</property>
+		      <signal name="activate" handler="on_addtoindex_activate" last_modification_time="Sat, 27 Dec 2008 11:38:10 GMT"/>
+
+		      <child internal-child="image">
+			<widget class="GtkImage" id="image996">
+			  <property name="visible">True</property>
+			  <property name="stock">gtk-add</property>
+			  <property name="icon_size">1</property>
+			  <property name="xalign">0.5</property>
+			  <property name="yalign">0.5</property>
+			  <property name="xpad">0</property>
+			  <property name="ypad">0</property>
+			</widget>
+		      </child>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkImageMenuItem" id="updateindex1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Update</property>
+		      <property name="use_underline">True</property>
+		      <signal name="activate" handler="on_updateindex_activate" last_modification_time="Sat, 27 Dec 2008 11:38:10 GMT"/>
+
+		      <child internal-child="image">
+			<widget class="GtkImage" id="image997">
+			  <property name="visible">True</property>
+			  <property name="stock">gtk-refresh</property>
+			  <property name="icon_size">1</property>
+			  <property name="xalign">0.5</property>
+			  <property name="yalign">0.5</property>
+			  <property name="xpad">0</property>
+			  <property name="ypad">0</property>
+			</widget>
+		      </child>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkImageMenuItem" id="unindex1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Unindex</property>
+		      <property name="use_underline">True</property>
+		      <signal name="activate" handler="on_unindex_activate" last_modification_time="Thu, 28 Jul 2005 12:42:23 GMT"/>
+
+		      <child internal-child="image">
+			<widget class="GtkImage" id="image998">
+			  <property name="visible">True</property>
+			  <property name="stock">gtk-delete</property>
+			  <property name="icon_size">1</property>
+			  <property name="xalign">0.5</property>
+			  <property name="yalign">0.5</property>
+			  <property name="xpad">0</property>
+			  <property name="ypad">0</property>
+			</widget>
+		      </child>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkSeparatorMenuItem" id="separator9">
+		      <property name="visible">True</property>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkMenuItem" id="morelikethis1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">More Like This</property>
+		      <property name="use_underline">True</property>
+		      <signal name="activate" handler="on_morelikethis_activate" last_modification_time="Sun, 18 Jun 2006 10:50:56 GMT"/>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkMenuItem" id="searchthisfor1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Search This For</property>
+		      <property name="use_underline">True</property>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkSeparatorMenuItem" id="separator10">
+		      <property name="visible">True</property>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkImageMenuItem" id="properties1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label">gtk-properties</property>
+		      <property name="use_stock">True</property>
+		      <signal name="activate" handler="on_properties_activate" last_modification_time="Sat, 27 Dec 2008 11:38:10 GMT"/>
+		    </widget>
+		  </child>
+
+		  <child>
 		    <widget class="GtkSeparatorMenuItem" id="separatormenuitem1">
 		      <property agent="glademm" name="cxx_visibility">protected</property>
 		      <property name="visible">True</property>
@@ -134,29 +275,42 @@
 		      <signal name="activate" handler="on_delete_activate" last_modification_time="Mon, 12 Apr 2004 09:32:03 GMT"/>
 		    </widget>
 		  </child>
+
+		  <child>
+		    <widget class="GtkSeparatorMenuItem" id="separator5">
+		      <property name="visible">True</property>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkImageMenuItem" id="preferences1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label">gtk-preferences</property>
+		      <property name="use_stock">True</property>
+		      <signal name="activate" handler="on_preferences_activate" last_modification_time="Sat, 27 Dec 2008 11:38:10 GMT"/>
+		    </widget>
+		  </child>
 		</widget>
 	      </child>
 	    </widget>
 	  </child>
 
 	  <child>
-	    <widget class="GtkMenuItem" id="resultsMenuitem">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
+	    <widget class="GtkMenuItem" id="optionsMenuitem">
 	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">_Results</property>
+	      <property name="label" translatable="yes">_Options</property>
 	      <property name="use_underline">True</property>
 
 	      <child>
-		<widget class="GtkMenu" id="resultsMenuitem_menu">
+		<widget class="GtkMenu" id="optionsMenuitem_menu">
 
 		  <child>
-		    <widget class="GtkCheckMenuItem" id="showextract1">
+		    <widget class="GtkMenuItem" id="listcontents1">
 		      <property agent="glademm" name="cxx_visibility">protected</property>
 		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Show Extract</property>
+		      <property name="label" translatable="yes">List Contents Of</property>
 		      <property name="use_underline">True</property>
-		      <property name="active">True</property>
-		      <signal name="activate" handler="on_showextract_activate" last_modification_time="Thu, 03 Jun 2004 17:22:31 GMT"/>
 		    </widget>
 		  </child>
 
@@ -164,7 +318,7 @@
 		    <widget class="GtkMenuItem" id="groupresults1">
 		      <property agent="glademm" name="cxx_visibility">protected</property>
 		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Group By</property>
+		      <property name="label" translatable="yes">Group Results By</property>
 		      <property name="use_underline">True</property>
 
 		      <child>
@@ -176,7 +330,7 @@
 			      <property name="visible">True</property>
 			      <property name="label" translatable="yes">Search Engine</property>
 			      <property name="use_underline">True</property>
-			      <property name="active">False</property>
+			      <property name="active">True</property>
 			      <signal name="activate" handler="on_groupresults_activate" last_modification_time="Sat, 28 Feb 2004 17:56:26 GMT"/>
 			    </widget>
 			  </child>
@@ -187,7 +341,7 @@
 			      <property name="visible">True</property>
 			      <property name="label" translatable="yes">Host Name</property>
 			      <property name="use_underline">True</property>
-			      <property name="active">True</property>
+			      <property name="active">False</property>
 			      <property name="group">searchenginegroup1</property>
 			    </widget>
 			  </child>
@@ -197,148 +351,32 @@
 		  </child>
 
 		  <child>
-		    <widget class="GtkImageMenuItem" id="exportresults1">
+		    <widget class="GtkCheckMenuItem" id="showextracts1">
 		      <property agent="glademm" name="cxx_visibility">protected</property>
 		      <property name="visible">True</property>
-		      <property name="label">gtk-save-as</property>
-		      <property name="use_stock">True</property>
-		      <signal name="activate" handler="on_exportresults_activate" last_modification_time="Tue, 17 Apr 2007 13:11:42 GMT"/>
-		    </widget>
-		  </child>
-
-		  <child>
-		    <widget class="GtkImageMenuItem" id="clearresults1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Clear List</property>
+		      <property name="label" translatable="yes">Show Extracts</property>
 		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_clearresults_activate" last_modification_time="Wed, 03 Mar 2004 19:51:48 GMT"/>
-
-		      <child internal-child="image">
-			<widget class="GtkImage" id="image718">
-			  <property name="visible">True</property>
-			  <property name="stock">gtk-clear</property>
-			  <property name="icon_size">1</property>
-			  <property name="xalign">0.5</property>
-			  <property name="yalign">0.5</property>
-			  <property name="xpad">0</property>
-			  <property name="ypad">0</property>
-			</widget>
-		      </child>
+		      <property name="active">True</property>
+		      <signal name="activate" handler="on_showextracts_activate" last_modification_time="Sat, 27 Dec 2008 11:38:55 GMT"/>
 		    </widget>
 		  </child>
 
 		  <child>
-		    <widget class="GtkSeparatorMenuItem" id="separator1">
+		    <widget class="GtkSeparatorMenuItem" id="separator4">
 		      <property name="visible">True</property>
 		    </widget>
 		  </child>
 
 		  <child>
-		    <widget class="GtkMenuItem" id="viewresults1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Vie_w</property>
-		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_viewresults_activate" last_modification_time="Tue, 24 Jun 2003 18:19:21 GMT"/>
-		    </widget>
-		  </child>
-
-		  <child>
-		    <widget class="GtkMenuItem" id="viewcache1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">View Cache</property>
-		      <property name="use_underline">True</property>
-		    </widget>
-		  </child>
-
-		  <child>
-		    <widget class="GtkImageMenuItem" id="morelikethis1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">More Like This</property>
-		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_morelikethis_activate" last_modification_time="Sun, 18 Jun 2006 10:50:56 GMT"/>
-
-		      <child internal-child="image">
-			<widget class="GtkImage" id="image719">
-			  <property name="visible">True</property>
-			  <property name="stock">gtk-add</property>
-			  <property name="icon_size">1</property>
-			  <property name="xalign">0.5</property>
-			  <property name="yalign">0.5</property>
-			  <property name="xpad">0</property>
-			  <property name="ypad">0</property>
-			</widget>
-		      </child>
-		    </widget>
-		  </child>
-
-		  <child>
-		    <widget class="GtkImageMenuItem" id="searchagain1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Search This For</property>
-		      <property name="use_underline">True</property>
-
-		      <child internal-child="image">
-			<widget class="GtkImage" id="image720">
-			  <property name="visible">True</property>
-			  <property name="stock">gtk-find</property>
-			  <property name="icon_size">1</property>
-			  <property name="xalign">0.5</property>
-			  <property name="yalign">0.5</property>
-			  <property name="xpad">0</property>
-			  <property name="ypad">0</property>
-			</widget>
-		      </child>
-		    </widget>
-		  </child>
-
-		  <child>
-		    <widget class="GtkMenuItem" id="indexresults1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">_Index</property>
-		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_indexresults_activate" last_modification_time="Tue, 17 Jun 2003 19:16:56 GMT"/>
-		    </widget>
-		  </child>
-		</widget>
-	      </child>
-	    </widget>
-	  </child>
-
-	  <child>
-	    <widget class="GtkMenuItem" id="indexMenuitem">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">_Index</property>
-	      <property name="use_underline">True</property>
-
-	      <child>
-		<widget class="GtkMenu" id="indexMenuitem_menu">
-
-		  <child>
-		    <widget class="GtkMenuItem" id="list1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">List Contents Of</property>
-		      <property name="use_underline">True</property>
-		    </widget>
-		  </child>
-
-		  <child>
 		    <widget class="GtkImageMenuItem" id="import1">
 		      <property agent="glademm" name="cxx_visibility">protected</property>
 		      <property name="visible">True</property>
 		      <property name="label" translatable="yes">Import URL</property>
 		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_import_activate" last_modification_time="Tue, 02 Mar 2004 22:13:44 GMT"/>
+		      <signal name="activate" handler="on_import_activate" last_modification_time="Sat, 27 Dec 2008 11:38:55 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image721">
+			<widget class="GtkImage" id="image999">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-open</property>
 			  <property name="icon_size">1</property>
@@ -352,33 +390,17 @@
 		  </child>
 
 		  <child>
-		    <widget class="GtkSeparatorMenuItem" id="separator3">
-		      <property name="visible">True</property>
-		    </widget>
-		  </child>
-
-		  <child>
-		    <widget class="GtkMenuItem" id="viewfromindex1">
+		    <widget class="GtkImageMenuItem" id="export1">
 		      <property agent="glademm" name="cxx_visibility">protected</property>
 		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">View</property>
+		      <property name="label" translatable="yes">Export List</property>
 		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_viewfromindex_activate" last_modification_time="Sat, 21 Feb 2004 13:47:40 GMT"/>
-		    </widget>
-		  </child>
+		      <signal name="activate" handler="on_export_activate" last_modification_time="Sat, 27 Dec 2008 11:38:55 GMT"/>
 
-		  <child>
-		    <widget class="GtkImageMenuItem" id="refreshindex1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Update</property>
-		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_refreshindex_activate" last_modification_time="Fri, 20 Feb 2004 18:57:09 GMT"/>
-
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image722">
+			<widget class="GtkImage" id="image1000">
 			  <property name="visible">True</property>
-			  <property name="stock">gtk-refresh</property>
+			  <property name="stock">gtk-save-as</property>
 			  <property name="icon_size">1</property>
 			  <property name="xalign">0.5</property>
 			  <property name="yalign">0.5</property>
@@ -390,39 +412,22 @@
 		  </child>
 
 		  <child>
-		    <widget class="GtkImageMenuItem" id="unindex1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
+		    <widget class="GtkSeparatorMenuItem" id="separator6">
 		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Unindex</property>
-		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_unindex_activate" last_modification_time="Thu, 28 Jul 2005 12:42:23 GMT"/>
-
-		      <child internal-child="image">
-			<widget class="GtkImage" id="image723">
-			  <property name="visible">True</property>
-			  <property name="stock">gtk-delete</property>
-			  <property name="icon_size">1</property>
-			  <property name="xalign">0.5</property>
-			  <property name="yalign">0.5</property>
-			  <property name="xpad">0</property>
-			  <property name="ypad">0</property>
-			</widget>
-		      </child>
 		    </widget>
 		  </child>
 
 		  <child>
-		    <widget class="GtkImageMenuItem" id="showfromindex1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
+		    <widget class="GtkImageMenuItem" id="status1">
 		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Properties</property>
+		      <property name="label" translatable="yes">Status</property>
 		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_showfromindex_activate" last_modification_time="Sun, 06 Nov 2005 08:43:05 GMT"/>
+		      <signal name="activate" handler="on_status_activate" last_modification_time="Sat, 27 Dec 2008 11:38:55 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image724">
+			<widget class="GtkImage" id="image1001">
 			  <property name="visible">True</property>
-			  <property name="stock">gtk-properties</property>
+			  <property name="stock">gtk-info</property>
 			  <property name="icon_size">1</property>
 			  <property name="xalign">0.5</property>
 			  <property name="yalign">0.5</property>
@@ -2862,522 +2867,15 @@
 	  <property name="enable_popup">False</property>
 
 	  <child>
-	    <widget class="GtkTable" id="generalTable">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
+	    <widget class="GtkVBox" id="vbox3">
 	      <property name="visible">True</property>
-	      <property name="n_rows">4</property>
-	      <property name="n_columns">2</property>
 	      <property name="homogeneous">False</property>
-	      <property name="row_spacing">0</property>
-	      <property name="column_spacing">0</property>
-
-	      <child>
-		<widget class="GtkLabel" id="apiKeyLabel">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">Google API key:</property>
-		  <property name="use_underline">False</property>
-		  <property name="use_markup">False</property>
-		  <property name="justify">GTK_JUSTIFY_LEFT</property>
-		  <property name="wrap">False</property>
-		  <property name="selectable">False</property>
-		  <property name="xalign">0</property>
-		  <property name="yalign">0.5</property>
-		  <property name="xpad">4</property>
-		  <property name="ypad">4</property>
-		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-		  <property name="width_chars">-1</property>
-		  <property name="single_line_mode">False</property>
-		  <property name="angle">0</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">3</property>
-		  <property name="bottom_attach">4</property>
-		  <property name="x_options">fill</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkEntry" id="apiKeyEntry">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="editable">True</property>
-		  <property name="visibility">True</property>
-		  <property name="max_length">0</property>
-		  <property name="text" translatable="yes"></property>
-		  <property name="has_frame">True</property>
-		  <property name="invisible_char">*</property>
-		  <property name="activates_default">False</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">1</property>
-		  <property name="right_attach">2</property>
-		  <property name="top_attach">3</property>
-		  <property name="bottom_attach">4</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkLabel" id="queriesLabel">
-		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">Queries:</property>
-		  <property name="use_underline">False</property>
-		  <property name="use_markup">False</property>
-		  <property name="justify">GTK_JUSTIFY_LEFT</property>
-		  <property name="wrap">False</property>
-		  <property name="selectable">False</property>
-		  <property name="xalign">0</property>
-		  <property name="yalign">0.5</property>
-		  <property name="xpad">4</property>
-		  <property name="ypad">4</property>
-		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-		  <property name="width_chars">-1</property>
-		  <property name="single_line_mode">False</property>
-		  <property name="angle">0</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">2</property>
-		  <property name="bottom_attach">3</property>
-		  <property name="x_options">fill</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkCheckButton" id="enableCompletionCheckbutton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="label" translatable="yes">Enable search terms suggestion</property>
-		  <property name="use_underline">True</property>
-		  <property name="relief">GTK_RELIEF_NORMAL</property>
-		  <property name="focus_on_click">True</property>
-		  <property name="active">False</property>
-		  <property name="inconsistent">False</property>
-		  <property name="draw_indicator">True</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">1</property>
-		  <property name="right_attach">2</property>
-		  <property name="top_attach">2</property>
-		  <property name="bottom_attach">3</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkColorButton" id="newResultsColorbutton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="use_alpha">False</property>
-		  <property name="focus_on_click">True</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">1</property>
-		  <property name="right_attach">2</property>
-		  <property name="top_attach">1</property>
-		  <property name="bottom_attach">2</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkCheckButton" id="ignoreRobotsCheckbutton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="label" translatable="yes">Ignore robots.txt and Robots META tag</property>
-		  <property name="use_underline">True</property>
-		  <property name="relief">GTK_RELIEF_NORMAL</property>
-		  <property name="focus_on_click">True</property>
-		  <property name="active">False</property>
-		  <property name="inconsistent">False</property>
-		  <property name="draw_indicator">True</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">1</property>
-		  <property name="right_attach">2</property>
-		  <property name="top_attach">0</property>
-		  <property name="bottom_attach">1</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkLabel" id="robotsLabels">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">HTTP crawling:</property>
-		  <property name="use_underline">False</property>
-		  <property name="use_markup">False</property>
-		  <property name="justify">GTK_JUSTIFY_LEFT</property>
-		  <property name="wrap">False</property>
-		  <property name="selectable">False</property>
-		  <property name="xalign">0</property>
-		  <property name="yalign">0.5</property>
-		  <property name="xpad">4</property>
-		  <property name="ypad">4</property>
-		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-		  <property name="width_chars">-1</property>
-		  <property name="single_line_mode">False</property>
-		  <property name="angle">0</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">0</property>
-		  <property name="bottom_attach">1</property>
-		  <property name="x_options">fill</property>
-		  <property name="y_options"></property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkLabel" id="newResultsLabel">
-		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">New results:</property>
-		  <property name="use_underline">False</property>
-		  <property name="use_markup">False</property>
-		  <property name="justify">GTK_JUSTIFY_LEFT</property>
-		  <property name="wrap">False</property>
-		  <property name="selectable">False</property>
-		  <property name="xalign">0</property>
-		  <property name="yalign">0.5</property>
-		  <property name="xpad">4</property>
-		  <property name="ypad">4</property>
-		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-		  <property name="width_chars">-1</property>
-		  <property name="single_line_mode">False</property>
-		  <property name="angle">0</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">1</property>
-		  <property name="bottom_attach">2</property>
-		  <property name="x_options">fill</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-	    </widget>
-	    <packing>
-	      <property name="tab_expand">False</property>
-	      <property name="tab_fill">True</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="label65">
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">General</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0.5</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">0</property>
-	      <property name="ypad">0</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="type">tab</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkTable" id="table2">
-	      <property name="visible">True</property>
-	      <property name="n_rows">3</property>
-	      <property name="n_columns">1</property>
-	      <property name="homogeneous">False</property>
-	      <property name="row_spacing">0</property>
-	      <property name="column_spacing">0</property>
-
-	      <child>
-		<widget class="GtkRadioButton" id="directConnectionRadiobutton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="label" translatable="yes">Direct connection to the Internet</property>
-		  <property name="use_underline">True</property>
-		  <property name="relief">GTK_RELIEF_NORMAL</property>
-		  <property name="focus_on_click">True</property>
-		  <property name="active">True</property>
-		  <property name="inconsistent">False</property>
-		  <property name="draw_indicator">True</property>
-		  <signal name="toggled" handler="on_directConnectionRadiobutton_toggled" last_modification_time="Fri, 23 Mar 2007 13:40:21 GMT"/>
-		</widget>
-		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">0</property>
-		  <property name="bottom_attach">1</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkRadioButton" id="proxyRadiobutton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="label" translatable="yes">Manual proxy configuration:</property>
-		  <property name="use_underline">True</property>
-		  <property name="relief">GTK_RELIEF_NORMAL</property>
-		  <property name="focus_on_click">True</property>
-		  <property name="active">False</property>
-		  <property name="inconsistent">False</property>
-		  <property name="draw_indicator">True</property>
-		  <property name="group">directConnectionRadiobutton</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">1</property>
-		  <property name="bottom_attach">2</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkTable" id="table3">
-		  <property name="visible">True</property>
-		  <property name="n_rows">3</property>
-		  <property name="n_columns">2</property>
-		  <property name="homogeneous">False</property>
-		  <property name="row_spacing">0</property>
-		  <property name="column_spacing">0</property>
-
-		  <child>
-		    <widget class="GtkLabel" id="proxyAddressLabel">
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Address:</property>
-		      <property name="use_underline">False</property>
-		      <property name="use_markup">False</property>
-		      <property name="justify">GTK_JUSTIFY_LEFT</property>
-		      <property name="wrap">False</property>
-		      <property name="selectable">False</property>
-		      <property name="xalign">0</property>
-		      <property name="yalign">0.5</property>
-		      <property name="xpad">0</property>
-		      <property name="ypad">0</property>
-		      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-		      <property name="width_chars">-1</property>
-		      <property name="single_line_mode">False</property>
-		      <property name="angle">0</property>
-		    </widget>
-		    <packing>
-		      <property name="left_attach">0</property>
-		      <property name="right_attach">1</property>
-		      <property name="top_attach">1</property>
-		      <property name="bottom_attach">2</property>
-		      <property name="x_padding">4</property>
-		      <property name="y_padding">4</property>
-		      <property name="x_options">fill</property>
-		      <property name="y_options">fill</property>
-		    </packing>
-		  </child>
-
-		  <child>
-		    <widget class="GtkEntry" id="proxyAddressEntry">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="can_focus">True</property>
-		      <property name="editable">True</property>
-		      <property name="visibility">True</property>
-		      <property name="max_length">0</property>
-		      <property name="text" translatable="yes"></property>
-		      <property name="has_frame">True</property>
-		      <property name="invisible_char">*</property>
-		      <property name="activates_default">False</property>
-		    </widget>
-		    <packing>
-		      <property name="left_attach">1</property>
-		      <property name="right_attach">2</property>
-		      <property name="top_attach">1</property>
-		      <property name="bottom_attach">2</property>
-		      <property name="x_padding">4</property>
-		      <property name="y_padding">4</property>
-		      <property name="y_options">fill</property>
-		    </packing>
-		  </child>
-
-		  <child>
-		    <widget class="GtkLabel" id="proxyTypeLabel">
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Type:</property>
-		      <property name="use_underline">False</property>
-		      <property name="use_markup">False</property>
-		      <property name="justify">GTK_JUSTIFY_LEFT</property>
-		      <property name="wrap">False</property>
-		      <property name="selectable">False</property>
-		      <property name="xalign">0</property>
-		      <property name="yalign">0.5</property>
-		      <property name="xpad">0</property>
-		      <property name="ypad">0</property>
-		      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-		      <property name="width_chars">-1</property>
-		      <property name="single_line_mode">False</property>
-		      <property name="angle">0</property>
-		    </widget>
-		    <packing>
-		      <property name="left_attach">0</property>
-		      <property name="right_attach">1</property>
-		      <property name="top_attach">0</property>
-		      <property name="bottom_attach">1</property>
-		      <property name="x_padding">4</property>
-		      <property name="y_padding">4</property>
-		      <property name="x_options">fill</property>
-		      <property name="y_options">fill</property>
-		    </packing>
-		  </child>
-
-		  <child>
-		    <widget class="GtkLabel" id="proxyPortLabel">
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Port:</property>
-		      <property name="use_underline">False</property>
-		      <property name="use_markup">False</property>
-		      <property name="justify">GTK_JUSTIFY_LEFT</property>
-		      <property name="wrap">False</property>
-		      <property name="selectable">False</property>
-		      <property name="xalign">0</property>
-		      <property name="yalign">0.5</property>
-		      <property name="xpad">0</property>
-		      <property name="ypad">0</property>
-		      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-		      <property name="width_chars">-1</property>
-		      <property name="single_line_mode">False</property>
-		      <property name="angle">0</property>
-		    </widget>
-		    <packing>
-		      <property name="left_attach">0</property>
-		      <property name="right_attach">1</property>
-		      <property name="top_attach">2</property>
-		      <property name="bottom_attach">3</property>
-		      <property name="x_padding">4</property>
-		      <property name="y_padding">4</property>
-		      <property name="x_options">fill</property>
-		      <property name="y_options">fill</property>
-		    </packing>
-		  </child>
-
-		  <child>
-		    <widget class="GtkSpinButton" id="proxyPortSpinbutton">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="can_focus">True</property>
-		      <property name="climb_rate">1</property>
-		      <property name="digits">0</property>
-		      <property name="numeric">False</property>
-		      <property name="update_policy">GTK_UPDATE_ALWAYS</property>
-		      <property name="snap_to_ticks">False</property>
-		      <property name="wrap">False</property>
-		      <property name="adjustment">80 1 65535 1 10 0</property>
-		    </widget>
-		    <packing>
-		      <property name="left_attach">1</property>
-		      <property name="right_attach">2</property>
-		      <property name="top_attach">2</property>
-		      <property name="bottom_attach">3</property>
-		      <property name="x_padding">4</property>
-		      <property name="y_padding">4</property>
-		      <property name="y_options"></property>
-		    </packing>
-		  </child>
-
-		  <child>
-		    <widget class="GtkComboBox" id="proxyTypeCombobox">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="items" translatable="yes"></property>
-		      <property name="add_tearoffs">False</property>
-		      <property name="focus_on_click">True</property>
-		    </widget>
-		    <packing>
-		      <property name="left_attach">1</property>
-		      <property name="right_attach">2</property>
-		      <property name="top_attach">0</property>
-		      <property name="bottom_attach">1</property>
-		      <property name="x_padding">4</property>
-		      <property name="y_padding">4</property>
-		      <property name="y_options"></property>
-		    </packing>
-		  </child>
-		</widget>
-		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">2</property>
-		  <property name="bottom_attach">3</property>
-		  <property name="x_options">fill</property>
-		</packing>
-	      </child>
-	    </widget>
-	    <packing>
-	      <property name="tab_expand">False</property>
-	      <property name="tab_fill">True</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="label69">
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Network</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0.5</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">0</property>
-	      <property name="ypad">0</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="type">tab</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkVBox" id="vbox2">
-	      <property name="visible">True</property>
-	      <property name="homogeneous">False</property>
 	      <property name="spacing">0</property>
 
 	      <child>
-		<widget class="GtkLabel" id="indexLabelsLabel">
+		<widget class="GtkLabel" id="directoriesLabel">
 		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">Labels are used to classify indexed documents:</property>
+		  <property name="label" translatable="yes">These directories will be indexed and optionally monitored for changes:</property>
 		  <property name="use_underline">False</property>
 		  <property name="use_markup">False</property>
 		  <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -3400,13 +2898,13 @@
 	      </child>
 
 	      <child>
-		<widget class="GtkHBox" id="hbox57">
+		<widget class="GtkHBox" id="hbox60">
 		  <property name="visible">True</property>
 		  <property name="homogeneous">False</property>
 		  <property name="spacing">0</property>
 
 		  <child>
-		    <widget class="GtkScrolledWindow" id="scrolledwindow1">
+		    <widget class="GtkScrolledWindow" id="scrolledwindow2">
 		      <property name="border_width">4</property>
 		      <property name="visible">True</property>
 		      <property name="can_focus">True</property>
@@ -3416,7 +2914,7 @@
 		      <property name="window_placement">GTK_CORNER_TOP_LEFT</property>
 
 		      <child>
-			<widget class="GtkTreeView" id="labelsTreeview">
+			<widget class="GtkTreeView" id="directoriesTreeview">
 			  <property agent="glademm" name="cxx_visibility">protected</property>
 			  <property name="visible">True</property>
 			  <property name="can_focus">True</property>
@@ -3438,13 +2936,13 @@
 		  </child>
 
 		  <child>
-		    <widget class="GtkVButtonBox" id="vbuttonbox1">
+		    <widget class="GtkVButtonBox" id="vbuttonbox2">
 		      <property name="visible">True</property>
 		      <property name="layout_style">GTK_BUTTONBOX_START</property>
 		      <property name="spacing">0</property>
 
 		      <child>
-			<widget class="GtkButton" id="addLabelButton">
+			<widget class="GtkButton" id="addDirectoryButton">
 			  <property name="border_width">4</property>
 			  <property agent="glademm" name="cxx_visibility">protected</property>
 			  <property name="visible">True</property>
@@ -3452,10 +2950,10 @@
 			  <property name="can_focus">True</property>
 			  <property name="relief">GTK_RELIEF_NORMAL</property>
 			  <property name="focus_on_click">True</property>
-			  <signal name="clicked" handler="on_addLabelButton_clicked" last_modification_time="Wed, 28 Apr 2004 17:31:55 GMT"/>
+			  <signal name="clicked" handler="on_addDirectoryButton_clicked" last_modification_time="Sun, 20 Aug 2006 07:33:34 GMT"/>
 
 			  <child>
-			    <widget class="GtkAlignment" id="alignment37">
+			    <widget class="GtkAlignment" id="alignment39">
 			      <property name="visible">True</property>
 			      <property name="xalign">0.5</property>
 			      <property name="yalign">0.5</property>
@@ -3467,13 +2965,13 @@
 			      <property name="right_padding">0</property>
 
 			      <child>
-				<widget class="GtkHBox" id="hbox58">
+				<widget class="GtkHBox" id="hbox61">
 				  <property name="visible">True</property>
 				  <property name="homogeneous">False</property>
 				  <property name="spacing">2</property>
 
 				  <child>
-				    <widget class="GtkImage" id="image725">
+				    <widget class="GtkImage" id="image727">
 				      <property name="visible">True</property>
 				      <property name="stock">gtk-add</property>
 				      <property name="icon_size">4</property>
@@ -3490,7 +2988,7 @@
 				  </child>
 
 				  <child>
-				    <widget class="GtkLabel" id="label71">
+				    <widget class="GtkLabel" id="label75">
 				      <property name="visible">True</property>
 				      <property name="label" translatable="yes">Add</property>
 				      <property name="use_underline">True</property>
@@ -3521,19 +3019,146 @@
 		      </child>
 
 		      <child>
-			<widget class="GtkButton" id="removeLabelButton">
+			<widget class="GtkButton" id="removeDirectoryButton">
 			  <property name="border_width">4</property>
 			  <property agent="glademm" name="cxx_visibility">protected</property>
 			  <property name="visible">True</property>
 			  <property name="can_default">True</property>
 			  <property name="can_focus">True</property>
+			  <property name="label">gtk-remove</property>
+			  <property name="use_stock">True</property>
 			  <property name="relief">GTK_RELIEF_NORMAL</property>
 			  <property name="focus_on_click">True</property>
-			  <signal name="clicked" handler="on_removeLabelButton_clicked" last_modification_time="Wed, 28 Apr 2004 17:32:01 GMT"/>
+			  <signal name="clicked" handler="on_removeDirectoryButton_clicked" last_modification_time="Sun, 20 Aug 2006 07:33:50 GMT"/>
+			</widget>
+		      </child>
+		    </widget>
+		    <packing>
+		      <property name="padding">0</property>
+		      <property name="expand">False</property>
+		      <property name="fill">True</property>
+		    </packing>
+		  </child>
+		</widget>
+		<packing>
+		  <property name="padding">4</property>
+		  <property name="expand">True</property>
+		  <property name="fill">True</property>
+		</packing>
+	      </child>
 
+	      <child>
+		<widget class="GtkLabel" id="label76">
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">File patterns:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">True</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="padding">4</property>
+		  <property name="expand">False</property>
+		  <property name="fill">False</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkHBox" id="hbox62">
+		  <property name="visible">True</property>
+		  <property name="homogeneous">False</property>
+		  <property name="spacing">0</property>
+
+		  <child>
+		    <widget class="GtkVBox" id="vbox4">
+		      <property name="visible">True</property>
+		      <property name="homogeneous">False</property>
+		      <property name="spacing">0</property>
+
+		      <child>
+			<widget class="GtkScrolledWindow" id="scrolledwindow3">
+			  <property name="border_width">4</property>
+			  <property name="visible">True</property>
+			  <property name="can_focus">True</property>
+			  <property name="hscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+			  <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+			  <property name="shadow_type">GTK_SHADOW_NONE</property>
+			  <property name="window_placement">GTK_CORNER_TOP_LEFT</property>
+
 			  <child>
-			    <widget class="GtkAlignment" id="alignment38">
+			    <widget class="GtkTreeView" id="patternsTreeview">
+			      <property agent="glademm" name="cxx_visibility">protected</property>
 			      <property name="visible">True</property>
+			      <property name="can_focus">True</property>
+			      <property name="headers_visible">True</property>
+			      <property name="rules_hint">False</property>
+			      <property name="reorderable">False</property>
+			      <property name="enable_search">True</property>
+			      <property name="fixed_height_mode">True</property>
+			      <property name="hover_selection">False</property>
+			      <property name="hover_expand">False</property>
+			    </widget>
+			  </child>
+			</widget>
+			<packing>
+			  <property name="padding">0</property>
+			  <property name="expand">True</property>
+			  <property name="fill">True</property>
+			</packing>
+		      </child>
+
+		      <child>
+			<widget class="GtkComboBox" id="patternsCombobox">
+			  <property agent="glademm" name="cxx_visibility">protected</property>
+			  <property name="visible">True</property>
+			  <property name="items" translatable="yes"></property>
+			  <property name="add_tearoffs">False</property>
+			  <property name="focus_on_click">True</property>
+			  <signal name="changed" handler="on_patternsCombobox_changed" last_modification_time="Tue, 03 Jul 2007 13:02:19 GMT"/>
+			</widget>
+			<packing>
+			  <property name="padding">4</property>
+			  <property name="expand">False</property>
+			  <property name="fill">True</property>
+			</packing>
+		      </child>
+		    </widget>
+		    <packing>
+		      <property name="padding">0</property>
+		      <property name="expand">True</property>
+		      <property name="fill">True</property>
+		    </packing>
+		  </child>
+
+		  <child>
+		    <widget class="GtkVButtonBox" id="vbuttonbox3">
+		      <property name="visible">True</property>
+		      <property name="layout_style">GTK_BUTTONBOX_START</property>
+		      <property name="spacing">0</property>
+
+		      <child>
+			<widget class="GtkButton" id="addPatternButton">
+			  <property name="border_width">4</property>
+			  <property agent="glademm" name="cxx_visibility">protected</property>
+			  <property name="visible">True</property>
+			  <property name="can_default">True</property>
+			  <property name="can_focus">True</property>
+			  <property name="relief">GTK_RELIEF_NORMAL</property>
+			  <property name="focus_on_click">True</property>
+			  <signal name="clicked" handler="on_addPatternButton_clicked" last_modification_time="Tue, 31 Oct 2006 14:48:22 GMT"/>
+
+			  <child>
+			    <widget class="GtkAlignment" id="alignment40">
+			      <property name="visible">True</property>
 			      <property name="xalign">0.5</property>
 			      <property name="yalign">0.5</property>
 			      <property name="xscale">0</property>
@@ -3544,15 +3169,15 @@
 			      <property name="right_padding">0</property>
 
 			      <child>
-				<widget class="GtkHBox" id="hbox59">
+				<widget class="GtkHBox" id="hbox63">
 				  <property name="visible">True</property>
 				  <property name="homogeneous">False</property>
 				  <property name="spacing">2</property>
 
 				  <child>
-				    <widget class="GtkImage" id="image726">
+				    <widget class="GtkImage" id="image728">
 				      <property name="visible">True</property>
-				      <property name="stock">gtk-remove</property>
+				      <property name="stock">gtk-add</property>
 				      <property name="icon_size">4</property>
 				      <property name="xalign">0.5</property>
 				      <property name="yalign">0.5</property>
@@ -3567,9 +3192,9 @@
 				  </child>
 
 				  <child>
-				    <widget class="GtkLabel" id="label72">
+				    <widget class="GtkLabel" id="label77">
 				      <property name="visible">True</property>
-				      <property name="label" translatable="yes">Remove</property>
+				      <property name="label" translatable="yes">Add</property>
 				      <property name="use_underline">True</property>
 				      <property name="use_markup">False</property>
 				      <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -3596,6 +3221,36 @@
 			  </child>
 			</widget>
 		      </child>
+
+		      <child>
+			<widget class="GtkButton" id="removePatternButton">
+			  <property name="border_width">4</property>
+			  <property agent="glademm" name="cxx_visibility">protected</property>
+			  <property name="visible">True</property>
+			  <property name="can_default">True</property>
+			  <property name="can_focus">True</property>
+			  <property name="label">gtk-remove</property>
+			  <property name="use_stock">True</property>
+			  <property name="relief">GTK_RELIEF_NORMAL</property>
+			  <property name="focus_on_click">True</property>
+			  <signal name="clicked" handler="on_removePatternButton_clicked" last_modification_time="Tue, 31 Oct 2006 14:48:32 GMT"/>
+			</widget>
+		      </child>
+
+		      <child>
+			<widget class="GtkButton" id="resetPatternsButton">
+			  <property name="border_width">4</property>
+			  <property agent="glademm" name="cxx_visibility">protected</property>
+			  <property name="visible">True</property>
+			  <property name="can_default">True</property>
+			  <property name="can_focus">True</property>
+			  <property name="label" translatable="yes">Reset</property>
+			  <property name="use_underline">True</property>
+			  <property name="relief">GTK_RELIEF_NORMAL</property>
+			  <property name="focus_on_click">True</property>
+			  <signal name="clicked" handler="on_resetPatternsButton_clicked" last_modification_time="Mon, 24 Mar 2008 04:59:59 GMT"/>
+			</widget>
+		      </child>
 		    </widget>
 		    <packing>
 		      <property name="padding">0</property>
@@ -3618,9 +3273,9 @@
 	  </child>
 
 	  <child>
-	    <widget class="GtkLabel" id="label73">
+	    <widget class="GtkLabel" id="indexingLabel">
 	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Labels</property>
+	      <property name="label" translatable="yes">Indexing</property>
 	      <property name="use_underline">False</property>
 	      <property name="use_markup">False</property>
 	      <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -3641,15 +3296,15 @@
 	  </child>
 
 	  <child>
-	    <widget class="GtkVBox" id="vbox3">
+	    <widget class="GtkVBox" id="vbox2">
 	      <property name="visible">True</property>
 	      <property name="homogeneous">False</property>
 	      <property name="spacing">0</property>
 
 	      <child>
-		<widget class="GtkLabel" id="directoriesLabel">
+		<widget class="GtkLabel" id="indexLabelsLabel">
 		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">These directories will be indexed and optionally monitored for changes:</property>
+		  <property name="label" translatable="yes">Labels are used to classify indexed documents:</property>
 		  <property name="use_underline">False</property>
 		  <property name="use_markup">False</property>
 		  <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -3672,13 +3327,13 @@
 	      </child>
 
 	      <child>
-		<widget class="GtkHBox" id="hbox60">
+		<widget class="GtkHBox" id="hbox57">
 		  <property name="visible">True</property>
 		  <property name="homogeneous">False</property>
 		  <property name="spacing">0</property>
 
 		  <child>
-		    <widget class="GtkScrolledWindow" id="scrolledwindow2">
+		    <widget class="GtkScrolledWindow" id="scrolledwindow1">
 		      <property name="border_width">4</property>
 		      <property name="visible">True</property>
 		      <property name="can_focus">True</property>
@@ -3688,7 +3343,7 @@
 		      <property name="window_placement">GTK_CORNER_TOP_LEFT</property>
 
 		      <child>
-			<widget class="GtkTreeView" id="directoriesTreeview">
+			<widget class="GtkTreeView" id="labelsTreeview">
 			  <property agent="glademm" name="cxx_visibility">protected</property>
 			  <property name="visible">True</property>
 			  <property name="can_focus">True</property>
@@ -3710,13 +3365,13 @@
 		  </child>
 
 		  <child>
-		    <widget class="GtkVButtonBox" id="vbuttonbox2">
+		    <widget class="GtkVButtonBox" id="vbuttonbox1">
 		      <property name="visible">True</property>
 		      <property name="layout_style">GTK_BUTTONBOX_START</property>
 		      <property name="spacing">0</property>
 
 		      <child>
-			<widget class="GtkButton" id="addDirectoryButton">
+			<widget class="GtkButton" id="addLabelButton">
 			  <property name="border_width">4</property>
 			  <property agent="glademm" name="cxx_visibility">protected</property>
 			  <property name="visible">True</property>
@@ -3724,10 +3379,10 @@
 			  <property name="can_focus">True</property>
 			  <property name="relief">GTK_RELIEF_NORMAL</property>
 			  <property name="focus_on_click">True</property>
-			  <signal name="clicked" handler="on_addDirectoryButton_clicked" last_modification_time="Sun, 20 Aug 2006 07:33:34 GMT"/>
+			  <signal name="clicked" handler="on_addLabelButton_clicked" last_modification_time="Wed, 28 Apr 2004 17:31:55 GMT"/>
 
 			  <child>
-			    <widget class="GtkAlignment" id="alignment39">
+			    <widget class="GtkAlignment" id="alignment37">
 			      <property name="visible">True</property>
 			      <property name="xalign">0.5</property>
 			      <property name="yalign">0.5</property>
@@ -3739,13 +3394,13 @@
 			      <property name="right_padding">0</property>
 
 			      <child>
-				<widget class="GtkHBox" id="hbox61">
+				<widget class="GtkHBox" id="hbox58">
 				  <property name="visible">True</property>
 				  <property name="homogeneous">False</property>
 				  <property name="spacing">2</property>
 
 				  <child>
-				    <widget class="GtkImage" id="image727">
+				    <widget class="GtkImage" id="image725">
 				      <property name="visible">True</property>
 				      <property name="stock">gtk-add</property>
 				      <property name="icon_size">4</property>
@@ -3762,7 +3417,7 @@
 				  </child>
 
 				  <child>
-				    <widget class="GtkLabel" id="label75">
+				    <widget class="GtkLabel" id="label71">
 				      <property name="visible">True</property>
 				      <property name="label" translatable="yes">Add</property>
 				      <property name="use_underline">True</property>
@@ -3793,146 +3448,19 @@
 		      </child>
 
 		      <child>
-			<widget class="GtkButton" id="removeDirectoryButton">
+			<widget class="GtkButton" id="removeLabelButton">
 			  <property name="border_width">4</property>
 			  <property agent="glademm" name="cxx_visibility">protected</property>
 			  <property name="visible">True</property>
 			  <property name="can_default">True</property>
 			  <property name="can_focus">True</property>
-			  <property name="label">gtk-remove</property>
-			  <property name="use_stock">True</property>
 			  <property name="relief">GTK_RELIEF_NORMAL</property>
 			  <property name="focus_on_click">True</property>
-			  <signal name="clicked" handler="on_removeDirectoryButton_clicked" last_modification_time="Sun, 20 Aug 2006 07:33:50 GMT"/>
-			</widget>
-		      </child>
-		    </widget>
-		    <packing>
-		      <property name="padding">0</property>
-		      <property name="expand">False</property>
-		      <property name="fill">True</property>
-		    </packing>
-		  </child>
-		</widget>
-		<packing>
-		  <property name="padding">4</property>
-		  <property name="expand">True</property>
-		  <property name="fill">True</property>
-		</packing>
-	      </child>
+			  <signal name="clicked" handler="on_removeLabelButton_clicked" last_modification_time="Wed, 28 Apr 2004 17:32:01 GMT"/>
 
-	      <child>
-		<widget class="GtkLabel" id="label76">
-		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">File patterns:</property>
-		  <property name="use_underline">False</property>
-		  <property name="use_markup">False</property>
-		  <property name="justify">GTK_JUSTIFY_LEFT</property>
-		  <property name="wrap">True</property>
-		  <property name="selectable">False</property>
-		  <property name="xalign">0</property>
-		  <property name="yalign">0.5</property>
-		  <property name="xpad">4</property>
-		  <property name="ypad">4</property>
-		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-		  <property name="width_chars">-1</property>
-		  <property name="single_line_mode">False</property>
-		  <property name="angle">0</property>
-		</widget>
-		<packing>
-		  <property name="padding">4</property>
-		  <property name="expand">False</property>
-		  <property name="fill">False</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkHBox" id="hbox62">
-		  <property name="visible">True</property>
-		  <property name="homogeneous">False</property>
-		  <property name="spacing">0</property>
-
-		  <child>
-		    <widget class="GtkVBox" id="vbox4">
-		      <property name="visible">True</property>
-		      <property name="homogeneous">False</property>
-		      <property name="spacing">0</property>
-
-		      <child>
-			<widget class="GtkScrolledWindow" id="scrolledwindow3">
-			  <property name="border_width">4</property>
-			  <property name="visible">True</property>
-			  <property name="can_focus">True</property>
-			  <property name="hscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
-			  <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
-			  <property name="shadow_type">GTK_SHADOW_NONE</property>
-			  <property name="window_placement">GTK_CORNER_TOP_LEFT</property>
-
 			  <child>
-			    <widget class="GtkTreeView" id="patternsTreeview">
-			      <property agent="glademm" name="cxx_visibility">protected</property>
+			    <widget class="GtkAlignment" id="alignment38">
 			      <property name="visible">True</property>
-			      <property name="can_focus">True</property>
-			      <property name="headers_visible">True</property>
-			      <property name="rules_hint">False</property>
-			      <property name="reorderable">False</property>
-			      <property name="enable_search">True</property>
-			      <property name="fixed_height_mode">True</property>
-			      <property name="hover_selection">False</property>
-			      <property name="hover_expand">False</property>
-			    </widget>
-			  </child>
-			</widget>
-			<packing>
-			  <property name="padding">0</property>
-			  <property name="expand">True</property>
-			  <property name="fill">True</property>
-			</packing>
-		      </child>
-
-		      <child>
-			<widget class="GtkComboBox" id="patternsCombobox">
-			  <property agent="glademm" name="cxx_visibility">protected</property>
-			  <property name="visible">True</property>
-			  <property name="items" translatable="yes"></property>
-			  <property name="add_tearoffs">False</property>
-			  <property name="focus_on_click">True</property>
-			  <signal name="changed" handler="on_patternsCombobox_changed" last_modification_time="Tue, 03 Jul 2007 13:02:19 GMT"/>
-			</widget>
-			<packing>
-			  <property name="padding">4</property>
-			  <property name="expand">False</property>
-			  <property name="fill">True</property>
-			</packing>
-		      </child>
-		    </widget>
-		    <packing>
-		      <property name="padding">0</property>
-		      <property name="expand">True</property>
-		      <property name="fill">True</property>
-		    </packing>
-		  </child>
-
-		  <child>
-		    <widget class="GtkVButtonBox" id="vbuttonbox3">
-		      <property name="visible">True</property>
-		      <property name="layout_style">GTK_BUTTONBOX_START</property>
-		      <property name="spacing">0</property>
-
-		      <child>
-			<widget class="GtkButton" id="addPatternButton">
-			  <property name="border_width">4</property>
-			  <property agent="glademm" name="cxx_visibility">protected</property>
-			  <property name="visible">True</property>
-			  <property name="can_default">True</property>
-			  <property name="can_focus">True</property>
-			  <property name="relief">GTK_RELIEF_NORMAL</property>
-			  <property name="focus_on_click">True</property>
-			  <signal name="clicked" handler="on_addPatternButton_clicked" last_modification_time="Tue, 31 Oct 2006 14:48:22 GMT"/>
-
-			  <child>
-			    <widget class="GtkAlignment" id="alignment40">
-			      <property name="visible">True</property>
 			      <property name="xalign">0.5</property>
 			      <property name="yalign">0.5</property>
 			      <property name="xscale">0</property>
@@ -3943,15 +3471,15 @@
 			      <property name="right_padding">0</property>
 
 			      <child>
-				<widget class="GtkHBox" id="hbox63">
+				<widget class="GtkHBox" id="hbox59">
 				  <property name="visible">True</property>
 				  <property name="homogeneous">False</property>
 				  <property name="spacing">2</property>
 
 				  <child>
-				    <widget class="GtkImage" id="image728">
+				    <widget class="GtkImage" id="image726">
 				      <property name="visible">True</property>
-				      <property name="stock">gtk-add</property>
+				      <property name="stock">gtk-remove</property>
 				      <property name="icon_size">4</property>
 				      <property name="xalign">0.5</property>
 				      <property name="yalign">0.5</property>
@@ -3966,9 +3494,9 @@
 				  </child>
 
 				  <child>
-				    <widget class="GtkLabel" id="label77">
+				    <widget class="GtkLabel" id="label72">
 				      <property name="visible">True</property>
-				      <property name="label" translatable="yes">Add</property>
+				      <property name="label" translatable="yes">Remove</property>
 				      <property name="use_underline">True</property>
 				      <property name="use_markup">False</property>
 				      <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -3995,36 +3523,6 @@
 			  </child>
 			</widget>
 		      </child>
-
-		      <child>
-			<widget class="GtkButton" id="removePatternButton">
-			  <property name="border_width">4</property>
-			  <property agent="glademm" name="cxx_visibility">protected</property>
-			  <property name="visible">True</property>
-			  <property name="can_default">True</property>
-			  <property name="can_focus">True</property>
-			  <property name="label">gtk-remove</property>
-			  <property name="use_stock">True</property>
-			  <property name="relief">GTK_RELIEF_NORMAL</property>
-			  <property name="focus_on_click">True</property>
-			  <signal name="clicked" handler="on_removePatternButton_clicked" last_modification_time="Tue, 31 Oct 2006 14:48:32 GMT"/>
-			</widget>
-		      </child>
-
-		      <child>
-			<widget class="GtkButton" id="resetPatternsButton">
-			  <property name="border_width">4</property>
-			  <property agent="glademm" name="cxx_visibility">protected</property>
-			  <property name="visible">True</property>
-			  <property name="can_default">True</property>
-			  <property name="can_focus">True</property>
-			  <property name="label" translatable="yes">Reset</property>
-			  <property name="use_underline">True</property>
-			  <property name="relief">GTK_RELIEF_NORMAL</property>
-			  <property name="focus_on_click">True</property>
-			  <signal name="clicked" handler="on_resetPatternsButton_clicked" last_modification_time="Mon, 24 Mar 2008 04:59:59 GMT"/>
-			</widget>
-		      </child>
 		    </widget>
 		    <packing>
 		      <property name="padding">0</property>
@@ -4047,9 +3545,9 @@
 	  </child>
 
 	  <child>
-	    <widget class="GtkLabel" id="label78">
+	    <widget class="GtkLabel" id="labelsLabel">
 	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Indexing</property>
+	      <property name="label" translatable="yes">Labels</property>
 	      <property name="use_underline">False</property>
 	      <property name="use_markup">False</property>
 	      <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -4068,6 +3566,513 @@
 	      <property name="type">tab</property>
 	    </packing>
 	  </child>
+
+	  <child>
+	    <widget class="GtkTable" id="table2">
+	      <property name="visible">True</property>
+	      <property name="n_rows">3</property>
+	      <property name="n_columns">1</property>
+	      <property name="homogeneous">False</property>
+	      <property name="row_spacing">0</property>
+	      <property name="column_spacing">0</property>
+
+	      <child>
+		<widget class="GtkRadioButton" id="directConnectionRadiobutton">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="label" translatable="yes">Direct connection to the Internet</property>
+		  <property name="use_underline">True</property>
+		  <property name="relief">GTK_RELIEF_NORMAL</property>
+		  <property name="focus_on_click">True</property>
+		  <property name="active">True</property>
+		  <property name="inconsistent">False</property>
+		  <property name="draw_indicator">True</property>
+		  <signal name="toggled" handler="on_directConnectionRadiobutton_toggled" last_modification_time="Fri, 23 Mar 2007 13:40:21 GMT"/>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">0</property>
+		  <property name="bottom_attach">1</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkRadioButton" id="proxyRadiobutton">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="label" translatable="yes">Manual proxy configuration:</property>
+		  <property name="use_underline">True</property>
+		  <property name="relief">GTK_RELIEF_NORMAL</property>
+		  <property name="focus_on_click">True</property>
+		  <property name="active">False</property>
+		  <property name="inconsistent">False</property>
+		  <property name="draw_indicator">True</property>
+		  <property name="group">directConnectionRadiobutton</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkTable" id="table3">
+		  <property name="visible">True</property>
+		  <property name="n_rows">3</property>
+		  <property name="n_columns">2</property>
+		  <property name="homogeneous">False</property>
+		  <property name="row_spacing">0</property>
+		  <property name="column_spacing">0</property>
+
+		  <child>
+		    <widget class="GtkLabel" id="proxyAddressLabel">
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Address:</property>
+		      <property name="use_underline">False</property>
+		      <property name="use_markup">False</property>
+		      <property name="justify">GTK_JUSTIFY_LEFT</property>
+		      <property name="wrap">False</property>
+		      <property name="selectable">False</property>
+		      <property name="xalign">0</property>
+		      <property name="yalign">0.5</property>
+		      <property name="xpad">0</property>
+		      <property name="ypad">0</property>
+		      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		      <property name="width_chars">-1</property>
+		      <property name="single_line_mode">False</property>
+		      <property name="angle">0</property>
+		    </widget>
+		    <packing>
+		      <property name="left_attach">0</property>
+		      <property name="right_attach">1</property>
+		      <property name="top_attach">1</property>
+		      <property name="bottom_attach">2</property>
+		      <property name="x_padding">4</property>
+		      <property name="y_padding">4</property>
+		      <property name="x_options">fill</property>
+		      <property name="y_options">fill</property>
+		    </packing>
+		  </child>
+
+		  <child>
+		    <widget class="GtkEntry" id="proxyAddressEntry">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="can_focus">True</property>
+		      <property name="editable">True</property>
+		      <property name="visibility">True</property>
+		      <property name="max_length">0</property>
+		      <property name="text" translatable="yes"></property>
+		      <property name="has_frame">True</property>
+		      <property name="invisible_char">*</property>
+		      <property name="activates_default">False</property>
+		    </widget>
+		    <packing>
+		      <property name="left_attach">1</property>
+		      <property name="right_attach">2</property>
+		      <property name="top_attach">1</property>
+		      <property name="bottom_attach">2</property>
+		      <property name="x_padding">4</property>
+		      <property name="y_padding">4</property>
+		      <property name="y_options">fill</property>
+		    </packing>
+		  </child>
+
+		  <child>
+		    <widget class="GtkLabel" id="proxyTypeLabel">
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Type:</property>
+		      <property name="use_underline">False</property>
+		      <property name="use_markup">False</property>
+		      <property name="justify">GTK_JUSTIFY_LEFT</property>
+		      <property name="wrap">False</property>
+		      <property name="selectable">False</property>
+		      <property name="xalign">0</property>
+		      <property name="yalign">0.5</property>
+		      <property name="xpad">0</property>
+		      <property name="ypad">0</property>
+		      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		      <property name="width_chars">-1</property>
+		      <property name="single_line_mode">False</property>
+		      <property name="angle">0</property>
+		    </widget>
+		    <packing>
+		      <property name="left_attach">0</property>
+		      <property name="right_attach">1</property>
+		      <property name="top_attach">0</property>
+		      <property name="bottom_attach">1</property>
+		      <property name="x_padding">4</property>
+		      <property name="y_padding">4</property>
+		      <property name="x_options">fill</property>
+		      <property name="y_options">fill</property>
+		    </packing>
+		  </child>
+
+		  <child>
+		    <widget class="GtkLabel" id="proxyPortLabel">
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Port:</property>
+		      <property name="use_underline">False</property>
+		      <property name="use_markup">False</property>
+		      <property name="justify">GTK_JUSTIFY_LEFT</property>
+		      <property name="wrap">False</property>
+		      <property name="selectable">False</property>
+		      <property name="xalign">0</property>
+		      <property name="yalign">0.5</property>
+		      <property name="xpad">0</property>
+		      <property name="ypad">0</property>
+		      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		      <property name="width_chars">-1</property>
+		      <property name="single_line_mode">False</property>
+		      <property name="angle">0</property>
+		    </widget>
+		    <packing>
+		      <property name="left_attach">0</property>
+		      <property name="right_attach">1</property>
+		      <property name="top_attach">2</property>
+		      <property name="bottom_attach">3</property>
+		      <property name="x_padding">4</property>
+		      <property name="y_padding">4</property>
+		      <property name="x_options">fill</property>
+		      <property name="y_options">fill</property>
+		    </packing>
+		  </child>
+
+		  <child>
+		    <widget class="GtkSpinButton" id="proxyPortSpinbutton">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="can_focus">True</property>
+		      <property name="climb_rate">1</property>
+		      <property name="digits">0</property>
+		      <property name="numeric">False</property>
+		      <property name="update_policy">GTK_UPDATE_ALWAYS</property>
+		      <property name="snap_to_ticks">False</property>
+		      <property name="wrap">False</property>
+		      <property name="adjustment">80 1 65535 1 10 0</property>
+		    </widget>
+		    <packing>
+		      <property name="left_attach">1</property>
+		      <property name="right_attach">2</property>
+		      <property name="top_attach">2</property>
+		      <property name="bottom_attach">3</property>
+		      <property name="x_padding">4</property>
+		      <property name="y_padding">4</property>
+		      <property name="y_options"></property>
+		    </packing>
+		  </child>
+
+		  <child>
+		    <widget class="GtkComboBox" id="proxyTypeCombobox">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="items" translatable="yes"></property>
+		      <property name="add_tearoffs">False</property>
+		      <property name="focus_on_click">True</property>
+		    </widget>
+		    <packing>
+		      <property name="left_attach">1</property>
+		      <property name="right_attach">2</property>
+		      <property name="top_attach">0</property>
+		      <property name="bottom_attach">1</property>
+		      <property name="x_padding">4</property>
+		      <property name="y_padding">4</property>
+		      <property name="y_options"></property>
+		    </packing>
+		  </child>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">2</property>
+		  <property name="bottom_attach">3</property>
+		  <property name="x_options">fill</property>
+		</packing>
+	      </child>
+	    </widget>
+	    <packing>
+	      <property name="tab_expand">False</property>
+	      <property name="tab_fill">True</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkLabel" id="networkLabel">
+	      <property name="visible">True</property>
+	      <property name="label" translatable="yes">Network</property>
+	      <property name="use_underline">False</property>
+	      <property name="use_markup">False</property>
+	      <property name="justify">GTK_JUSTIFY_LEFT</property>
+	      <property name="wrap">False</property>
+	      <property name="selectable">False</property>
+	      <property name="xalign">0.5</property>
+	      <property name="yalign">0.5</property>
+	      <property name="xpad">0</property>
+	      <property name="ypad">0</property>
+	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+	      <property name="width_chars">-1</property>
+	      <property name="single_line_mode">False</property>
+	      <property name="angle">0</property>
+	    </widget>
+	    <packing>
+	      <property name="type">tab</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkTable" id="generalTable">
+	      <property agent="glademm" name="cxx_visibility">protected</property>
+	      <property name="visible">True</property>
+	      <property name="n_rows">4</property>
+	      <property name="n_columns">2</property>
+	      <property name="homogeneous">False</property>
+	      <property name="row_spacing">0</property>
+	      <property name="column_spacing">0</property>
+
+	      <child>
+		<widget class="GtkLabel" id="apiKeyLabel">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Google API key:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">3</property>
+		  <property name="bottom_attach">4</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkEntry" id="apiKeyEntry">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="editable">True</property>
+		  <property name="visibility">True</property>
+		  <property name="max_length">0</property>
+		  <property name="text" translatable="yes"></property>
+		  <property name="has_frame">True</property>
+		  <property name="invisible_char">*</property>
+		  <property name="activates_default">False</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">3</property>
+		  <property name="bottom_attach">4</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="queriesLabel">
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Queries:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">2</property>
+		  <property name="bottom_attach">3</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkCheckButton" id="enableCompletionCheckbutton">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="label" translatable="yes">Enable search terms suggestion</property>
+		  <property name="use_underline">True</property>
+		  <property name="relief">GTK_RELIEF_NORMAL</property>
+		  <property name="focus_on_click">True</property>
+		  <property name="active">False</property>
+		  <property name="inconsistent">False</property>
+		  <property name="draw_indicator">True</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">2</property>
+		  <property name="bottom_attach">3</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkColorButton" id="newResultsColorbutton">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="use_alpha">False</property>
+		  <property name="focus_on_click">True</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkCheckButton" id="ignoreRobotsCheckbutton">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="label" translatable="yes">Ignore robots.txt and Robots META tag</property>
+		  <property name="use_underline">True</property>
+		  <property name="relief">GTK_RELIEF_NORMAL</property>
+		  <property name="focus_on_click">True</property>
+		  <property name="active">False</property>
+		  <property name="inconsistent">False</property>
+		  <property name="draw_indicator">True</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">0</property>
+		  <property name="bottom_attach">1</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="robotsLabels">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">HTTP crawling:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">0</property>
+		  <property name="bottom_attach">1</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options"></property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="newResultsLabel">
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">New results:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+	    </widget>
+	    <packing>
+	      <property name="tab_expand">False</property>
+	      <property name="tab_fill">True</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkLabel" id="miscLabel">
+	      <property name="visible">True</property>
+	      <property name="label" translatable="yes">Miscellaneous</property>
+	      <property name="use_underline">False</property>
+	      <property name="use_markup">False</property>
+	      <property name="justify">GTK_JUSTIFY_LEFT</property>
+	      <property name="wrap">False</property>
+	      <property name="selectable">False</property>
+	      <property name="xalign">0.5</property>
+	      <property name="yalign">0.5</property>
+	      <property name="xpad">0</property>
+	      <property name="ypad">0</property>
+	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+	      <property name="width_chars">-1</property>
+	      <property name="single_line_mode">False</property>
+	      <property name="angle">0</property>
+	    </widget>
+	    <packing>
+	      <property name="type">tab</property>
+	    </packing>
+	  </child>
 	</widget>
 	<packing>
 	  <property name="padding">0</property>



From fabricecolin at mail.berlios.de  Wed Dec 31 14:27:52 2008
From: fabricecolin at mail.berlios.de (fabricecolin at mail.berlios.de)
Date: Wed, 31 Dec 2008 14:27:52 +0100
Subject: [Pinot-svn] r1458 - in trunk: SQL UI/GTK2/src
Message-ID: <200812311327.mBVDRqIV003297@sheep.berlios.de>

Author: fabricecolin
Date: 2008-12-31 14:27:49 +0100 (Wed, 31 Dec 2008)
New Revision: 1458

Modified:
   trunk/SQL/MetaDataBackup.cpp
   trunk/SQL/MetaDataBackup.h
   trunk/UI/GTK2/src/ServerThreads.cpp
Log:
Fixed use of LIKE in MetaDataBackup. The getItems() method didn't unescape URLs.
In DirectoryScannerThread::doWork(), restore metadata only for documents in the
directory being crawled.


Modified: trunk/SQL/MetaDataBackup.cpp
===================================================================
--- trunk/SQL/MetaDataBackup.cpp	2008-12-30 14:08:09 UTC (rev 1457)
+++ trunk/SQL/MetaDataBackup.cpp	2008-12-31 13:27:49 UTC (rev 1458)
@@ -232,7 +232,7 @@
 #endif
 
 	SQLResults *results = executeStatement("SELECT Value FROM MetaDataBackup \
-		WHERE Url='%q' AND Name LIKE '%q%';",
+		WHERE Url='%q' AND Name LIKE '%q%%';",
 		Url::escapeUrl(url).c_str(), name.c_str());
 	if (results != NULL)
 	{
@@ -299,7 +299,7 @@
 		else
 		{
 			results = executeStatement("DELETE FROM MetaDataBackup \
-				WHERE Url='%q' AND NAME LIKE '%q%';",
+				WHERE Url='%q' AND NAME LIKE '%q%%';",
 				Url::escapeUrl(url).c_str(), name.c_str());
 		}
 	}
@@ -428,14 +428,14 @@
 }
 
 /// Gets items.
-bool MetaDataBackup::getItems(const string &protocol, set<string> &urls,
+bool MetaDataBackup::getItems(const string &likeUrl, set<string> &urls,
 	unsigned long min, unsigned long max)
 {
 	SQLResults *results = NULL;
 	bool success = false;
 
 	// Even when attributes are used, an entry is always added to the table
-	if (protocol.empty() == true)
+	if (likeUrl.empty() == true)
 	{
 		results = executeStatement("SELECT Url FROM MetaDataBackup \
 			LIMIT %u OFFSET %u;",
@@ -444,8 +444,8 @@
 	else
 	{
 		results = executeStatement("SELECT Url FROM MetaDataBackup \
-			WHERE Url LIKE '%q%' LIMIT %u OFFSET %u;",
-			protocol.c_str(), max - min, min);
+			WHERE Url LIKE '%q%%' LIMIT %u OFFSET %u;",
+			likeUrl.c_str(), max - min, min);
 	}
 	if (results != NULL)
 	{
@@ -457,7 +457,7 @@
 				continue;
 			}
 
-			urls.insert(row->getColumn(0));
+			urls.insert(Url::unescapeUrl(row->getColumn(0)));
 			success = true;
 
 			delete row;

Modified: trunk/SQL/MetaDataBackup.h
===================================================================
--- trunk/SQL/MetaDataBackup.h	2008-12-30 14:08:09 UTC (rev 1457)
+++ trunk/SQL/MetaDataBackup.h	2008-12-31 13:27:49 UTC (rev 1458)
@@ -43,7 +43,7 @@
 		bool getItem(DocumentInfo &docInfo, DocumentInfo::SerialExtent extent);
 
 		/// Gets items.
-		bool getItems(const std::string &protocol,
+		bool getItems(const std::string &likeUrl,
 			std::set<std::string> &urls,
 			unsigned long min, unsigned long max);
 

Modified: trunk/UI/GTK2/src/ServerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.cpp	2008-12-30 14:08:09 UTC (rev 1457)
+++ trunk/UI/GTK2/src/ServerThreads.cpp	2008-12-31 13:27:49 UTC (rev 1458)
@@ -589,23 +589,23 @@
 		// Restore user-set metadata, if any
 		while ((pIndex != NULL) &&
 			(pIndex->isGood() == true) &&
-			(metaData.getItems("file://", urls,
+			(metaData.getItems(string("file://") + m_dirName, urls,
 				currentOffset, currentOffset + 100) == true))
 		{
 			for (set<string>::const_iterator urlIter = urls.begin();
 				urlIter != urls.end(); ++urlIter)
 			{
 				unsigned int docId = pIndex->hasDocument(*urlIter);
+				if (docId == 0)
+				{
+					continue;
+				}
 
-				if (docId > 0)
+				DocumentInfo docInfo("", *urlIter, "", "");
+				if (metaData.getItem(docInfo, DocumentInfo::SERIAL_ALL) == true)
 				{
-					DocumentInfo docInfo("", *urlIter, "", "");
-
-					if (metaData.getItem(docInfo, DocumentInfo::SERIAL_ALL) == true)
-					{
-						pIndex->updateDocumentInfo(docId, docInfo);
-						pIndex->setDocumentLabels(docId, docInfo.getLabels(), true);
-					}
+					pIndex->updateDocumentInfo(docId, docInfo);
+					pIndex->setDocumentLabels(docId, docInfo.getLabels(), true);
 				}
 			}
 



