<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Pinot-svn] r1011 - in trunk: . Index
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/pinot-svn/2007-October/index.html" >
   <LINK REL="made" HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r1011%20-%20in%20trunk%3A%20.%20Index&In-Reply-To=%3C200710041315.l94DFP4h022712%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001004.html">
   <LINK REL="Next"  HREF="001006.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Pinot-svn] r1011 - in trunk: . Index</H1>
    <B>fabricecolin at BerliOS</B> 
    <A HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r1011%20-%20in%20trunk%3A%20.%20Index&In-Reply-To=%3C200710041315.l94DFP4h022712%40sheep.berlios.de%3E"
       TITLE="[Pinot-svn] r1011 - in trunk: . Index">fabricecolin at mail.berlios.de
       </A><BR>
    <I>Thu Oct  4 15:15:25 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="001004.html">[Pinot-svn] r1010 - trunk/Index
</A></li>
        <LI>Next message: <A HREF="001006.html">[Pinot-svn] r1012 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1005">[ date ]</a>
              <a href="thread.html#1005">[ thread ]</a>
              <a href="subject.html#1005">[ subject ]</a>
              <a href="author.html#1005">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fabricecolin
Date: 2007-10-04 15:15:24 +0200 (Thu, 04 Oct 2007)
New Revision: 1011

Added:
   trunk/Index/pinot-label.1
   trunk/Index/pinot-label.cpp
Modified:
   trunk/Index/Makefile.am
   trunk/Index/pinot-index.cpp
   trunk/Makefile.am
   trunk/README
   trunk/configure.in
   trunk/pinot.spec.in
Log:
New pinot-label tool to manipulate labels on indexed files.
Also increased requirement on Xapian to 1.0.3. This is enforced by configure.


Modified: trunk/Index/Makefile.am
===================================================================
--- trunk/Index/Makefile.am	2007-10-04 13:10:00 UTC (rev 1010)
+++ trunk/Index/Makefile.am	2007-10-04 13:15:24 UTC (rev 1011)
@@ -21,7 +21,7 @@
 	XapianDatabaseFactory.cpp \
 	XapianIndex.cpp
 
-bin_PROGRAMS = pinot-index
+bin_PROGRAMS = pinot-index pinot-label
 
 pinot_index_LDADD = -L../Utils -L../Tokenize -L../Collect \
 	-lIndex -lCollect -lTokenize -lBasicUtils -lUtils \
@@ -32,6 +32,15 @@
 
 pinot_index_DEPENDENCIES = libIndex.la
 
+pinot_label_LDADD = -L../Utils -L../Tokenize \
+	-lIndex -lTokenize -lBasicUtils -lUtils \
+	@GLIBMM_LIBS@ @INDEX_LIBS@ @DBUS_LIBS@ @XML_LIBS@ @GMIME_LIBS@ @MISC_LIBS@
+
+pinot_label_SOURCES = \
+	pinot-label.cpp
+
+pinot_label_DEPENDENCIES = libIndex.la
+
 AM_CXXFLAGS = -I$(srcdir)/../Utils -I$(srcdir)/../Tokenize -I$(srcdir)/../Tokenize/filters \
 	-I$(srcdir)/../Collect @HTTP_CFLAGS@ @GMIME_CFLAGS@ @XML_CFLAGS@ @DBUS_CFLAGS@ @INDEX_CFLAGS@
 

Modified: trunk/Index/pinot-index.cpp
===================================================================
--- trunk/Index/pinot-index.cpp	2007-10-04 13:10:00 UTC (rev 1010)
+++ trunk/Index/pinot-index.cpp	2007-10-04 13:15:24 UTC (rev 1011)
@@ -288,11 +288,11 @@
 		}
 		if (pIndex-&gt;getDocumentLabels(docId, labels) == true)
 		{
-			cout &lt;&lt; &quot;Labels:&quot;;
+			cout &lt;&lt; &quot;Labels: &quot;;
 			for (set&lt;string&gt;::const_iterator labelIter = labels.begin();
 				labelIter != labels.end(); ++labelIter)
 			{
-				cout &lt;&lt; &quot; '&quot; &lt;&lt; *labelIter &lt;&lt; &quot;'&quot;;
+				cout &lt;&lt; &quot;[&quot; &lt;&lt; *labelIter &lt;&lt; &quot;]&quot;;
 			}
 			cout &lt;&lt; endl;
 		}

Added: trunk/Index/pinot-label.1
===================================================================
--- trunk/Index/pinot-label.1	2007-10-04 13:10:00 UTC (rev 1010)
+++ trunk/Index/pinot-label.1	2007-10-04 13:15:24 UTC (rev 1011)
@@ -0,0 +1,37 @@
+.\&quot; DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
+.TH PINOT-LABEL &quot;1&quot; &quot;October 2007&quot; &quot;pinot-label - pinot 0.76&quot; &quot;User Commands&quot;
+.SH NAME
+pinot-label \- Label files from the command-line
+.SH SYNOPSIS
+.B pinot-label
+[\fIOPTIONS\fR] [\fIFILE\fR]
+.SH DESCRIPTION
+pinot\-label \- Label files from the command\-line
+.SH OPTIONS
+.TP
+\fB\-g\fR, \fB\-\-get\fR
+get the labels list for the given file
+.TP
+\fB\-h\fR, \fB\-\-help\fR
+display this help and exit
+.TP
+\fB\-l\fR, \fB\-\-list\fR
+list known labels
+.TP
+\fB\-s\fR, \fB\-\-set\fR
+set labels on the given file
+.TP
+\fB\-v\fR, \fB\-\-version\fR
+output version information and exit
+.SH EXAMPLES
+pinot\-label \fB\-\-get\fR /home/fabrice/Documents/Bozo.txt
+.PP
+pinot\-label \fB\-\-list\fR
+.PP
+pinot\-label \fB\-\-set\fR &quot;[Clowns][Fun][My Hero]&quot; /home/fabrice/Documents/Bozo.txt/
+.SH &quot;REPORTING BUGS&quot;
+Report bugs to <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabricecolin at users.berlios.de</A>
+.PP
+This is free software.  You may redistribute copies of it under the terms of
+the GNU General Public License &lt;<A HREF="http://www.gnu.org/licenses/old\-licenses/gpl\-2.0.html">http://www.gnu.org/licenses/old\-licenses/gpl\-2.0.html</A>&gt;.
+There is NO WARRANTY, to the extent permitted by law.

Added: trunk/Index/pinot-label.cpp
===================================================================
--- trunk/Index/pinot-label.cpp	2007-10-04 13:10:00 UTC (rev 1010)
+++ trunk/Index/pinot-label.cpp	2007-10-04 13:15:24 UTC (rev 1011)
@@ -0,0 +1,253 @@
+/*
+ *  Copyright 2007 Fabrice Colin
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+ 
+#include &lt;getopt.h&gt;
+#include &lt;sys/types.h&gt;
+#include &lt;pwd.h&gt;
+#include &lt;iostream&gt;
+#include &lt;string&gt;
+#include &lt;set&gt;
+#include &quot;config.h&quot;
+extern &quot;C&quot;
+{
+#if DBUS_NUM_VERSION &lt; 1000000
+#define DBUS_API_SUBJECT_TO_CHANGE
+#endif
+#include &lt;dbus/dbus.h&gt;
+#include &lt;dbus/dbus-glib.h&gt;
+#include &lt;dbus/dbus-glib-lowlevel.h&gt;
+}
+
+#include &quot;StringManip.h&quot;
+#include &quot;MIMEScanner.h&quot;
+#include &quot;DBusXapianIndex.h&quot;
+#include &quot;XapianDatabaseFactory.h&quot;
+
+using namespace std;
+
+static struct option g_longOptions[] = {
+	{&quot;get&quot;, 0, 0, 'g'},
+	{&quot;help&quot;, 0, 0, 'h'},
+	{&quot;list&quot;, 0, 0, 'l'},
+	{&quot;set&quot;, 1, 0, 's'},
+	{&quot;version&quot;, 0, 0, 'v'},
+	{0, 0, 0, 0}
+};
+
+
+static void printLabels(const set&lt;string&gt; &amp;labels)
+{
+	cout &lt;&lt; &quot;Labels: &quot;;
+	for (set&lt;string&gt;::const_iterator labelIter = labels.begin();
+		labelIter != labels.end(); ++labelIter)
+	{
+		cout &lt;&lt; &quot;[&quot; &lt;&lt; *labelIter &lt;&lt; &quot;]&quot;;
+	}
+	cout &lt;&lt; endl;
+}
+
+static string getHomeDirectory(void)
+{
+	struct passwd *pPasswd = getpwuid(geteuid());
+
+	if ((pPasswd != NULL) &amp;&amp;
+		(pPasswd-&gt;pw_dir != NULL))
+	{
+		return pPasswd-&gt;pw_dir;
+	}
+	else
+	{
+		char *homeDir = getenv(&quot;HOME&quot;);
+		if (homeDir != NULL)
+		{
+			return homeDir;
+		}
+	}
+
+	return &quot;~&quot;;
+}
+
+static void printHelp(void)
+{
+	// Help
+	cout &lt;&lt; &quot;pinot-label - Label files from the command-line\n\n&quot;
+		&lt;&lt; &quot;Usage: pinot-label [OPTIONS] [FILE]\n\n&quot;
+		&lt;&lt; &quot;Options:\n&quot;
+		&lt;&lt; &quot;  -g, --get                 get the labels list for the given file\n&quot;
+		&lt;&lt; &quot;  -h, --help                display this help and exit\n&quot;
+		&lt;&lt; &quot;  -l, --list                list known labels\n&quot;
+		&lt;&lt; &quot;  -s, --set                 set labels on the given file\n&quot;
+		&lt;&lt; &quot;  -v, --version             output version information and exit\n\n&quot;;
+	cout &lt;&lt; &quot;Examples:\n&quot;
+		&lt;&lt; &quot;pinot-label --get /home/fabrice/Documents/Bozo.txt\n\n&quot;
+		&lt;&lt; &quot;pinot-label --list\n\n&quot;
+		&lt;&lt; &quot;pinot-label --set \&quot;[Clowns][Fun][My Hero]\&quot; /home/fabrice/Documents/Bozo.txt/\n\n&quot;
+		&lt;&lt; &quot;Report bugs to &quot; &lt;&lt; PACKAGE_BUGREPORT &lt;&lt; endl;
+}
+
+int main(int argc, char **argv)
+{
+	set&lt;string&gt; labels;
+	string labelsString;
+	int longOptionIndex = 0;
+	unsigned int docId = 0;
+	bool getLabels = false, getDocumentLabels = false, setDocumentLabels = false, success = false;
+
+	// Look at the options
+	int optionChar = getopt_long(argc, argv, &quot;ghls:v&quot;, g_longOptions, &amp;longOptionIndex);
+	while (optionChar != -1)
+	{
+		set&lt;string&gt; engines;
+
+		switch (optionChar)
+		{
+			case 'g':
+				getDocumentLabels = true;
+				break;
+			case 'h':
+				printHelp();
+				return EXIT_SUCCESS;
+			case 'l':
+				getLabels = true;
+				break;
+			case 's':
+				setDocumentLabels = true;
+				if (optarg != NULL)
+				{
+					labelsString = optarg;
+				}
+				break;
+			case 'v':
+				cout &lt;&lt; &quot;pinot-label - &quot; &lt;&lt; PACKAGE_STRING &lt;&lt; &quot;\n\n&quot;
+					&lt;&lt; &quot;This is free software.  You may redistribute copies of it under the terms of\n&quot;
+					&lt;&lt; &quot;the GNU General Public License &lt;<A HREF="http://www.gnu.org/licenses/old-licenses/gpl-2.0.html">http://www.gnu.org/licenses/old-licenses/gpl-2.0.html</A>&gt;.\n&quot;
+					&lt;&lt; &quot;There is NO WARRANTY, to the extent permitted by law.&quot; &lt;&lt; endl;
+				return EXIT_SUCCESS;
+			default:
+				return EXIT_FAILURE;
+		}
+
+		// Next option
+		optionChar = getopt_long(argc, argv, &quot;ghls:v&quot;, g_longOptions, &amp;longOptionIndex);
+	}
+
+	if (argc == 1)
+	{
+		printHelp();
+		return EXIT_SUCCESS;
+	}
+
+	if ((setDocumentLabels == true) &amp;&amp;
+		(labelsString.empty() == true))
+	{
+		cerr &lt;&lt; &quot;Incorrect parameters&quot; &lt;&lt; endl;
+		return EXIT_FAILURE;
+	}
+
+	// Initialize GType
+	g_type_init();
+
+	MIMEScanner::initialize(&quot;&quot;, &quot;&quot;);
+
+	string indexLocation(getHomeDirectory() + &quot;/.pinot/daemon&quot;);
+	DBusXapianIndex index(indexLocation);
+	if (index.isGood() == false)
+	{
+		cerr &lt;&lt; &quot;Couldn't obtain index for &quot; &lt;&lt; indexLocation &lt;&lt; endl;
+
+		XapianDatabaseFactory::closeAll();
+		MIMEScanner::shutdown();
+
+		return EXIT_FAILURE;
+	}
+
+	if ((getDocumentLabels == true) ||
+		(setDocumentLabels == true))
+	{
+		string fileParam(argv[optind]);
+
+		docId = index.hasDocument(string(&quot;<A HREF="file://">file://</A>&quot;) + fileParam);
+		if (docId == 0)
+		{
+			cerr &lt;&lt; &quot;File is not indexed&quot; &lt;&lt; endl;
+
+			XapianDatabaseFactory::closeAll();
+			MIMEScanner::shutdown();
+
+			return EXIT_FAILURE;
+		}
+	}
+
+	if (getLabels == true)
+	{
+		if (index.getLabels(labels, true) == true)
+		{
+			printLabels(labels);
+
+			success = true;
+		}
+	}
+
+	if (getDocumentLabels == true)
+	{
+		labels.clear();
+
+		if (index.getDocumentLabels(docId, labels, true) == true)
+		{
+			printLabels(labels);
+
+			success = true;
+		}
+	}
+
+	if (setDocumentLabels == true)
+	{
+		string::size_type endPos = 0;
+		string label(StringManip::extractField(labelsString, &quot;[&quot;, &quot;]&quot;, endPos));
+
+		labels.clear();
+
+		// Parse labels
+		while (label.empty() == false)
+		{
+			labels.insert(Url::unescapeUrl(label));
+
+			if (endPos == string::npos)
+			{
+				break;
+			}
+			label = StringManip::extractField(labelsString, &quot;[&quot;, &quot;]&quot;, endPos);
+		}
+
+#ifdef DEBUG
+		printLabels(labels);
+#endif
+		success = index.setDocumentLabels(docId, labels);
+	}
+
+	XapianDatabaseFactory::closeAll();
+	MIMEScanner::shutdown();
+
+	// Did whatever operation we carried out succeed ?
+	if (success == true)
+	{
+		return EXIT_SUCCESS;
+	}
+
+	return EXIT_FAILURE;
+}

Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2007-10-04 13:10:00 UTC (rev 1010)
+++ trunk/Makefile.am	2007-10-04 13:15:24 UTC (rev 1011)
@@ -6,7 +6,7 @@
 	textcat_conf.txt textcat3_conf.txt \
 	pinot.desktop pinot-dbus-daemon.desktop pinot.spec \
 	Search/Plugins/*src Search/Plugins/*.xml \
-	Index/pinot-index.1 Search/pinot-search.1 \
+	Index/pinot-index.1 Index/pinot-label.1 Search/pinot-search.1 \
 	UI/GTK2/src/pinot.1 UI/GTK2/src/pinot-dbus-daemon.1 \
 	UI/GTK2/src/pinot-dbus-daemon.xml UI/GTK2/src/de.berlios.Pinot.service \
 	UI/GTK2/xapian-powered.png UI/icons/48x48/pinot.png \
@@ -15,7 +15,7 @@
 	UI/GTK2/metase-gtk2.glade UI/GTK2/metase-gtk2.gladep \
 	scripts/bash/pinot-enum-index.sh scripts/python/pinot-live.py
 
-man_MANS = Index/pinot-index.1 Search/pinot-search.1 \
+man_MANS = Index/pinot-index.1 Index/pinot-label.1 Search/pinot-search.1 \
 	UI/GTK2/src/pinot.1 UI/GTK2/src/pinot-dbus-daemon.1
 
 install-data-local:

Modified: trunk/README
===================================================================
--- trunk/README	2007-10-04 13:10:00 UTC (rev 1010)
+++ trunk/README	2007-10-04 13:15:24 UTC (rev 1011)
@@ -378,7 +378,7 @@
 SQLite							3.3.1
 <A HREF="http://www.sqlite.org/">http://www.sqlite.org/</A>
 
-xapian-core						1.0.2
+xapian-core						1.0.3
 <A HREF="http://www.xapian.org/">http://www.xapian.org/</A>
 
 curl (1)						7.13.1

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2007-10-04 13:10:00 UTC (rev 1010)
+++ trunk/configure.in	2007-10-04 13:15:24 UTC (rev 1011)
@@ -162,6 +162,14 @@
 XAPIAN_NUM_VERSION=`xapian-config --version | $SED -e &quot;s/xapian-config - xapian-core //g&quot; | $AWK 'BEGIN { FS = &quot;.&quot;; } { printf &quot;%d&quot;, ($1 * 1000 + $2) * 1000 + $3;}'`
 AC_DEFINE_UNQUOTED(XAPIAN_NUM_VERSION,$XAPIAN_NUM_VERSION,
     [Xapian version number])
+AC_MSG_CHECKING(for Xapian &gt;= 1.0.3)
+if test $XAPIAN_NUM_VERSION -gt 1000002; then
+   AC_MSG_RESULT(yes)
+else
+   AC_MSG_RESULT(no)
+   AC_MSG_ERROR([You need at least Xapian 1.0.3])
+   exit 1
+fi
 
 dnl inotify
 linuxinotify=&quot;no&quot;

Modified: trunk/pinot.spec.in
===================================================================
--- trunk/pinot.spec.in	2007-10-04 13:10:00 UTC (rev 1010)
+++ trunk/pinot.spec.in	2007-10-04 13:15:24 UTC (rev 1011)
@@ -24,10 +24,10 @@
 Source: %{name}-%{version}.tar.gz
 URL: <A HREF="http://pinot.berlios.de/">http://pinot.berlios.de/</A>
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
-Requires: xapian-core-libs &gt;= 1.0.2, libtextcat &gt;= 2.2, sqlite &gt;= 3.3.1, curl &gt;= 7.13, gmime &gt;= 2.1
+Requires: xapian-core-libs &gt;= 1.0.3, libtextcat &gt;= 2.2, sqlite &gt;= 3.3.1, curl &gt;= 7.13, gmime &gt;= 2.1
 Requires: gtkmm24 &gt;= 2.6, libxml++ &gt;= 2.12, %{dbus_pkg} &gt;= 0.60, shared-mime-info
 Requires: unzip, antiword, unrtf, %{pftotext_pkg}
-BuildRequires: xapian-core-devel &gt;= 1.0.2, libtextcat-devel &gt;= 2.2, sqlite-devel &gt;= 3.3.1, curl-devel &gt;= 7.13, gmime-devel &gt;= 2.1, boost-devel &gt;= 1.32
+BuildRequires: xapian-core-devel &gt;= 1.0.3, libtextcat-devel &gt;= 2.2, sqlite-devel &gt;= 3.3.1, curl-devel &gt;= 7.13, gmime-devel &gt;= 2.1, boost-devel &gt;= 1.32
 BuildRequires: gtkmm24-devel &gt;= 2.6, libxml++-devel &gt;= 2.12, %{dbus_dev_pkg} &gt;= 0.60, gettext-devel, desktop-file-utils
 BuildRequires: taglib-devel &gt;= 1.4
 BuildRequires: gcc-c++
@@ -102,6 +102,7 @@
 %{_bindir}/pinot
 %{_bindir}/pinot-dbus-daemon
 %{_bindir}/pinot-index
+%{_bindir}/pinot-label
 %{_bindir}/pinot-search
 %{_libdir}/pinot/filters/libexternalfilter.so*
 %{_libdir}/pinot/filters/libmboxfilter.so*
@@ -114,10 +115,7 @@
 %{_datadir}/icons/hicolor/16x16/apps/pinot.png
 %{_sysconfdir}/xdg/autostart/*.desktop
 %{_datadir}/applications/*.desktop
-%{_mandir}/man1/pinot.*
-%{_mandir}/man1/pinot-dbus-daemon.*
-%{_mandir}/man1/pinot-index.*
-%{_mandir}/man1/pinot-search.*
+%{_mandir}/man1/pinot*
 
 %files audio-docs 
 %defattr(-, root, root, -)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001004.html">[Pinot-svn] r1010 - trunk/Index
</A></li>
	<LI>Next message: <A HREF="001006.html">[Pinot-svn] r1012 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1005">[ date ]</a>
              <a href="thread.html#1005">[ thread ]</a>
              <a href="subject.html#1005">[ subject ]</a>
              <a href="author.html#1005">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/pinot-svn">More information about the Pinot-svn
mailing list</a><br>
</body></html>
