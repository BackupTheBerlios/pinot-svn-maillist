<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Pinot-svn] r1035 - in trunk/UI/GTK2: . src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/pinot-svn/2007-October/index.html" >
   <LINK REL="made" HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r1035%20-%20in%20trunk/UI/GTK2%3A%20.%20src&In-Reply-To=%3C200710131356.l9DDuUCC001328%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001028.html">
   <LINK REL="Next"  HREF="001030.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Pinot-svn] r1035 - in trunk/UI/GTK2: . src</H1>
    <B>fabricecolin at BerliOS</B> 
    <A HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r1035%20-%20in%20trunk/UI/GTK2%3A%20.%20src&In-Reply-To=%3C200710131356.l9DDuUCC001328%40sheep.berlios.de%3E"
       TITLE="[Pinot-svn] r1035 - in trunk/UI/GTK2: . src">fabricecolin at mail.berlios.de
       </A><BR>
    <I>Sat Oct 13 15:56:30 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="001028.html">[Pinot-svn] r1034 - trunk/po
</A></li>
        <LI>Next message: <A HREF="001030.html">[Pinot-svn] r1036 - trunk/UI/GTK2/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1029">[ date ]</a>
              <a href="thread.html#1029">[ thread ]</a>
              <a href="subject.html#1029">[ subject ]</a>
              <a href="author.html#1029">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fabricecolin
Date: 2007-10-13 15:56:29 +0200 (Sat, 13 Oct 2007)
New Revision: 1035

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/propertiesDialog.cc
   trunk/UI/GTK2/src/propertiesDialog.hh
   trunk/UI/GTK2/src/propertiesDialog_glade.cc
   trunk/UI/GTK2/src/propertiesDialog_glade.hh
Log:
propertiesDialog can save a document's terms to file, and does some of the
processing previously done in mainWindow.
Also give a sensible default name to the file results are exported to.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2007-10-13 08:31:22 UTC (rev 1034)
+++ trunk/UI/GTK2/metase-gtk2.glade	2007-10-13 13:56:29 UTC (rev 1035)
@@ -2269,7 +2269,7 @@
 	    &lt;widget class=&quot;GtkTable&quot; id=&quot;nameTable&quot;&gt;
 	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 	      &lt;property name=&quot;n_rows&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;n_columns&quot;&gt;3&lt;/property&gt;
+	      &lt;property name=&quot;n_columns&quot;&gt;2&lt;/property&gt;
 	      &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
 	      &lt;property name=&quot;row_spacing&quot;&gt;0&lt;/property&gt;
 	      &lt;property name=&quot;column_spacing&quot;&gt;0&lt;/property&gt;
@@ -2326,27 +2326,6 @@
 		  &lt;property name=&quot;y_options&quot;&gt;&lt;/property&gt;
 		&lt;/packing&gt;
 	      &lt;/child&gt;
-
-	      &lt;child&gt;
-		&lt;widget class=&quot;GtkButton&quot; id=&quot;queryHistoryButton&quot;&gt;
-		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
-		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-		  &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
-		  &lt;property name=&quot;label&quot;&gt;Show History&lt;/property&gt;
-		  &lt;property name=&quot;use_underline&quot;&gt;True&lt;/property&gt;
-		  &lt;property name=&quot;relief&quot;&gt;GTK_RELIEF_NORMAL&lt;/property&gt;
-		  &lt;property name=&quot;focus_on_click&quot;&gt;True&lt;/property&gt;
-		  &lt;signal name=&quot;clicked&quot; handler=&quot;on_addFilterButton_clicked&quot; last_modification_time=&quot;Sat, 14 Oct 2006 01:28:04 GMT&quot;/&gt;
-		&lt;/widget&gt;
-		&lt;packing&gt;
-		  &lt;property name=&quot;left_attach&quot;&gt;2&lt;/property&gt;
-		  &lt;property name=&quot;right_attach&quot;&gt;3&lt;/property&gt;
-		  &lt;property name=&quot;top_attach&quot;&gt;0&lt;/property&gt;
-		  &lt;property name=&quot;bottom_attach&quot;&gt;1&lt;/property&gt;
-		  &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
-		  &lt;property name=&quot;y_options&quot;&gt;&lt;/property&gt;
-		&lt;/packing&gt;
-	      &lt;/child&gt;
 	    &lt;/widget&gt;
 	    &lt;packing&gt;
 	      &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
@@ -2973,30 +2952,6 @@
 	      &lt;/child&gt;
 
 	      &lt;child&gt;
-		&lt;widget class=&quot;GtkEntry&quot; id=&quot;termsEntry&quot;&gt;
-		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
-		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-		  &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
-		  &lt;property name=&quot;editable&quot;&gt;False&lt;/property&gt;
-		  &lt;property name=&quot;visibility&quot;&gt;True&lt;/property&gt;
-		  &lt;property name=&quot;max_length&quot;&gt;0&lt;/property&gt;
-		  &lt;property name=&quot;text&quot; translatable=&quot;yes&quot;&gt;&lt;/property&gt;
-		  &lt;property name=&quot;has_frame&quot;&gt;True&lt;/property&gt;
-		  &lt;property name=&quot;invisible_char&quot;&gt;*&lt;/property&gt;
-		  &lt;property name=&quot;activates_default&quot;&gt;False&lt;/property&gt;
-		&lt;/widget&gt;
-		&lt;packing&gt;
-		  &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
-		  &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
-		  &lt;property name=&quot;top_attach&quot;&gt;4&lt;/property&gt;
-		  &lt;property name=&quot;bottom_attach&quot;&gt;5&lt;/property&gt;
-		  &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
-		  &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
-		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
-		&lt;/packing&gt;
-	      &lt;/child&gt;
-
-	      &lt;child&gt;
 		&lt;widget class=&quot;GtkLabel&quot; id=&quot;termsLabel&quot;&gt;
 		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
 		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
@@ -3026,6 +2981,60 @@
 		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
 		&lt;/packing&gt;
 	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkHBox&quot; id=&quot;termsHbox&quot;&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;spacing&quot;&gt;0&lt;/property&gt;
+
+		  &lt;child&gt;
+		    &lt;widget class=&quot;GtkEntry&quot; id=&quot;termsEntry&quot;&gt;
+		      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;editable&quot;&gt;False&lt;/property&gt;
+		      &lt;property name=&quot;visibility&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;max_length&quot;&gt;0&lt;/property&gt;
+		      &lt;property name=&quot;text&quot; translatable=&quot;yes&quot;&gt;&lt;/property&gt;
+		      &lt;property name=&quot;has_frame&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;invisible_char&quot;&gt;*&lt;/property&gt;
+		      &lt;property name=&quot;activates_default&quot;&gt;False&lt;/property&gt;
+		    &lt;/widget&gt;
+		    &lt;packing&gt;
+		      &lt;property name=&quot;padding&quot;&gt;4&lt;/property&gt;
+		      &lt;property name=&quot;expand&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
+		    &lt;/packing&gt;
+		  &lt;/child&gt;
+
+		  &lt;child&gt;
+		    &lt;widget class=&quot;GtkButton&quot; id=&quot;saveTermsButton&quot;&gt;
+		      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;label&quot;&gt;gtk-save-as&lt;/property&gt;
+		      &lt;property name=&quot;use_stock&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;relief&quot;&gt;GTK_RELIEF_NORMAL&lt;/property&gt;
+		      &lt;property name=&quot;focus_on_click&quot;&gt;True&lt;/property&gt;
+		      &lt;signal name=&quot;clicked&quot; handler=&quot;on_saveTermsButton_clicked&quot; last_modification_time=&quot;Fri, 05 Oct 2007 07:57:40 GMT&quot;/&gt;
+		    &lt;/widget&gt;
+		    &lt;packing&gt;
+		      &lt;property name=&quot;padding&quot;&gt;4&lt;/property&gt;
+		      &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+		      &lt;property name=&quot;fill&quot;&gt;False&lt;/property&gt;
+		    &lt;/packing&gt;
+		  &lt;/child&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
+		  &lt;property name=&quot;top_attach&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;bottom_attach&quot;&gt;5&lt;/property&gt;
+		  &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
+		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
 	    &lt;/widget&gt;
 	    &lt;packing&gt;
 	      &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-10-13 08:31:22 UTC (rev 1034)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-10-13 13:56:29 UTC (rev 1035)
@@ -2020,9 +2020,12 @@
 			{
 				FileChooserDialog fileChooser(_(&quot;Export Results&quot;));
 				FileFilter csvFilter, xmlFilter;
-				ustring location;
+				ustring location(m_settings.getHomeDirectory());
 				bool exportToCSV = true;
 
+				location += &quot;/&quot;;
+				location += pNotebookPage-&gt;getTitle();
+				location += &quot;.csv&quot;;
 				prepare_file_chooser(fileChooser, location, false);
 
 				// Add filters
@@ -2255,12 +2258,8 @@
 void mainWindow::on_showfromindex_activate()
 {
 	vector&lt;DocumentInfo&gt; documentsList;
-	set&lt;string&gt; docLabels;
 	string indexName, queryName;
-	DocumentInfo docInfo;
-	unsigned int docId = 0, termsCount = 0;
 	int width, height;
-	bool editDocument = false;
 
 #ifdef DEBUG
 	cout &lt;&lt; &quot;mainWindow::on_showfromindex_activate: called&quot; &lt;&lt; endl;
@@ -2303,139 +2302,75 @@
 		return;
 	}
 
-	IndexInterface *pIndex = m_settings.getIndex(mapIter-&gt;second);
-	if ((pIndex == NULL) ||
-		(pIndex-&gt;isGood() == false))
-	{
-		if (pIndex != NULL)
-		{
-			delete pIndex;
-		}
-		return;
-	}
-
-	// If there's only one document selected, get its labels
-	if (documentsList.size() == 1)
-	{
-		vector&lt;DocumentInfo&gt;::iterator docIter = documentsList.begin();
-		unsigned int indexId = 0;
-
-		// Get the document ID
-		docId = docIter-&gt;getIsIndexed(indexId);
-#ifdef DEBUG
-		cout &lt;&lt; &quot;mainWindow::on_showfromindex_activate: document &quot; &lt;&lt; docId &lt;&lt; &quot; in index &quot; &lt;&lt; indexId &lt;&lt; endl;
-#endif
-		if (docId &gt; 0)
-		{
-			// Get the properties from the index because they have been altered
-			// by the tree for display purposes
-			pIndex-&gt;getDocumentInfo(docId, docInfo);
-			pIndex-&gt;getDocumentLabels(docId, docLabels);
-			docInfo.setIsIndexed(indexId, docId);
-			termsCount = pIndex-&gt;getDocumentTermsCount(docId);
-			editDocument = true;
-		}
-	}
-	else
-	{
-		// If all documents are of the same language, show it
-		for (vector&lt;DocumentInfo&gt;::iterator docIter = documentsList.begin();
-			docIter != documentsList.end(); ++docIter)
-		{
-			if (docInfo.getLanguage().empty() == true)
-			{
-				docInfo.setLanguage(docIter-&gt;getLanguage());
-			}
-			if (docIter-&gt;getLanguage() != docInfo.getLanguage())
-			{
-				// They aren't
-				docInfo.setLanguage(&quot;&quot;);
-				break;
-			}
-		}
-
-		// Show a blank labels list
-	}
-
 	// Let the user set the labels
 	get_size(width, height);
-	propertiesDialog propertiesBox(docLabels, docInfo, termsCount, editDocument);
+	propertiesDialog propertiesBox(mapIter-&gt;second, documentsList);
 	propertiesBox.setHeight(height / 2);
 	propertiesBox.show();
+	// What labels will this show ?
+	const set&lt;string&gt; &amp;labels = propertiesBox.getLabels();
+	bool hasNoLabels = labels.empty();
 	if (propertiesBox.run() != RESPONSE_OK)
 	{
-		delete pIndex;
 		return;
 	}
 
-	const set&lt;string&gt; &amp;labels = propertiesBox.getLabels();
-	string newTitle(propertiesBox.getDocumentInfo().getTitle());
-	string newLanguage(propertiesBox.getDocumentInfo().getLanguage());
+	DocumentInfo docInfo(propertiesBox.getDocumentInfo());
+	string newTitle(docInfo.getTitle());
+	string newLanguage(docInfo.getLanguage());
 #ifdef DEBUG
 	cout &lt;&lt; &quot;mainWindow::on_showfromindex_activate: properties changed to &quot;
 		&lt;&lt; newTitle &lt;&lt; &quot;, &quot; &lt;&lt; newLanguage &lt;&lt; endl;
 #endif
 
 	// Now apply these labels to all the documents
-	if ((docLabels.empty() == false) ||
-		(labels.empty() == false) ||
-		(documentsList.size() &gt; 1))
+	// FIXME: do that only if something was modified
+	if ((hasNoLabels == false) &amp;&amp;
+		(labels.empty() == false))
 	{
-		set&lt;unsigned int&gt; docIds;
-
-		for (vector&lt;DocumentInfo&gt;::iterator docIter = documentsList.begin();
-			docIter != documentsList.end(); ++docIter)
+		IndexInterface *pIndex = m_settings.getIndex(mapIter-&gt;second);
+		if (pIndex != NULL)
 		{
-			unsigned int indexId = 0;
+			if (pIndex-&gt;isGood() == true)
+			{
+				set&lt;unsigned int&gt; docIds;
 
-			docIds.insert(docIter-&gt;getIsIndexed(indexId));
-		}
+				for (vector&lt;DocumentInfo&gt;::iterator docIter = documentsList.begin();
+					docIter != documentsList.end(); ++docIter)
+				{
+					unsigned int indexId = 0;
 
-		// Set the document's labels list
-		pIndex-&gt;setDocumentsLabels(docIds, labels);
-	}
+					docIds.insert(docIter-&gt;getIsIndexed(indexId));
+				}
 
-	if ((documentsList.size() == 1) &amp;&amp;
-		(docId &gt; 0))
-	{
-		// Did the title or language change ?
-		if ((newTitle != docInfo.getTitle()) ||
-			(newLanguage != docInfo.getLanguage()))
-		{
-			docInfo.setTitle(newTitle);
-			docInfo.setLanguage(newLanguage);
+				// Set the document's labels list
+				// FIXME: this should be done by a thread
+				pIndex-&gt;setDocumentsLabels(docIds, labels);
+			}
 
-			// Update the document
-			start_thread(new UpdateDocumentThread(indexName, docId, docInfo));
+			delete pIndex;
 		}
 	}
-	else
+
+	// Update all documents
+	// FIXME: do that only if something was modified
+	for (vector&lt;DocumentInfo&gt;::iterator docIter = documentsList.begin();
+		docIter != documentsList.end(); ++docIter)
 	{
-		// Was the language changed ?
-		if (newLanguage.empty() == false)
-		{
-			// Update all documents
-			for (vector&lt;DocumentInfo&gt;::iterator docIter = documentsList.begin();
-				docIter != documentsList.end(); ++docIter)
-			{
-				unsigned int indexId = 0;
-				docId = docIter-&gt;getIsIndexed(indexId);
+		unsigned int indexId = 0;
+		unsigned int docId = docIter-&gt;getIsIndexed(indexId);
 
-				docIter-&gt;setLanguage(newLanguage);
+		docIter-&gt;setLanguage(newLanguage);
 
-				start_thread(new UpdateDocumentThread(indexName, docId, *docIter));
-			}
-		}
-
-		if (queryName.empty() == false)
-		{
-			// The current label may have been applied to or removed from
-			// one or more of the selected documents, so refresh the list
-			browse_index(indexName, queryName, 0, 0);
-		}
+		start_thread(new UpdateDocumentThread(indexName, docId, *docIter));
 	}
 
-	delete pIndex;
+	if (queryName.empty() == false)
+	{
+		// The current label may have been applied to or removed from
+		// one or more of the selected documents, so refresh the list
+		browse_index(indexName, queryName, 0, 0);
+	}
 }
 
 //

Modified: trunk/UI/GTK2/src/propertiesDialog.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.cc	2007-10-13 08:31:22 UTC (rev 1034)
+++ trunk/UI/GTK2/src/propertiesDialog.cc	2007-10-13 13:56:29 UTC (rev 1035)
@@ -18,11 +18,13 @@
 
 #include &lt;stdio.h&gt;
 #include &lt;iostream&gt;
+#include &lt;fstream&gt;
 #include &lt;utility&gt;
 
 #include &quot;config.h&quot;
 #include &quot;Languages.h&quot;
 #include &quot;NLS.h&quot;
+#include &quot;XapianIndex.h&quot;
 #include &quot;PinotSettings.h&quot;
 #include &quot;PinotUtils.h&quot;
 #include &quot;propertiesDialog.hh&quot;
@@ -31,27 +33,64 @@
 using namespace Glib;
 using namespace Gtk;
 
-propertiesDialog::propertiesDialog(const std::set&lt;std::string&gt; &amp;docLabels,
-	const DocumentInfo &amp;docInfo, unsigned int termsCount, bool editDocument) :
+propertiesDialog::propertiesDialog(const string &amp;indexLocation,
+	const vector&lt;DocumentInfo&gt; &amp;documentsList) :
 	propertiesDialog_glade(),
-	m_editDocument(editDocument),
-	m_docInfo(docInfo)
+	m_indexLocation(indexLocation),
+	m_docId(0),
+	m_editDocument(false)
 {
-	string language(docInfo.getLanguage());
+	set&lt;string&gt; docLabels;
+	string language;
+	unsigned int termsCount = 0;
+	bool notALanguageName = false;
 	char numStr[128];
-	unsigned int indexId = 0;
-	bool notALanguageName = false;
 
-	// Get the document ID
-	unsigned int docId = docInfo.getIsIndexed(indexId);
+	IndexInterface *pIndex = PinotSettings::getInstance().getIndex(m_indexLocation);
+	if ((pIndex == NULL) ||
+		(pIndex-&gt;isGood() == false))
+	{
+		if (pIndex != NULL)
+		{
+			delete pIndex;
+		}
+		return;
+	}
+
+	// If there's only one document selected, get its labels
+	if (documentsList.size() == 1)
+	{
+		vector&lt;DocumentInfo&gt;::const_iterator docIter = documentsList.begin();
+		unsigned int indexId = 0;
+
+		// Get the document ID
+		m_docId = docIter-&gt;getIsIndexed(indexId);
 #ifdef DEBUG
-	cout &lt;&lt; &quot;propertiesDialog: document &quot; &lt;&lt; docId &lt;&lt; endl;
+		cout &lt;&lt; &quot;propertiesDialog::propertiesDialog: document &quot; &lt;&lt; m_docId &lt;&lt; &quot; in index &quot; &lt;&lt; indexId &lt;&lt; endl;
 #endif
-	if (docId &gt; 0)
+		if (m_docId &gt; 0)
+		{
+			// Get the properties from the index because they may have been altered
+			// for display purposes
+			pIndex-&gt;getDocumentInfo(m_docId, m_docInfo);
+			pIndex-&gt;getDocumentLabels(m_docId, docLabels);
+			m_docInfo.setIsIndexed(indexId, m_docId);
+			termsCount = pIndex-&gt;getDocumentTermsCount(m_docId);
+			language = m_docInfo.getLanguage();
+			m_editDocument = true;
+
+			snprintf(numStr, 128, &quot;%u&quot;, m_docId);
+			set_title(get_title() + &quot; (ID &quot; + numStr + &quot;)&quot;);
+		}
+	}
+	else
 	{
-		snprintf(numStr, 128, &quot;%u&quot;, docId);
-		set_title(get_title() + &quot; (ID &quot; + numStr + &quot;)&quot;);
+		// Leave the labels list blank
+		// FIXME: if all documents are of the same language, show it
+		language = _(&quot;Per document&quot;);
+		notALanguageName = true;
 	}
+	delete pIndex;
 
 	// Associate the columns model to the labels tree
 	m_refLabelsTree = ListStore::create(m_labelsColumns);
@@ -63,10 +102,10 @@
 
 	if (m_editDocument == true)
 	{
-		unsigned int size = docInfo.getSize();
+		unsigned int size = m_docInfo.getSize();
 
-		titleEntry-&gt;set_text(to_utf8(docInfo.getTitle()));
-		typeEntry-&gt;set_text(to_utf8(docInfo.getType()));
+		titleEntry-&gt;set_text(to_utf8(m_docInfo.getTitle()));
+		typeEntry-&gt;set_text(to_utf8(m_docInfo.getType()));
 		if (size == 0)
 		{
 			sizeEntry-&gt;set_text(_(&quot;Unknown&quot;));
@@ -88,12 +127,6 @@
 	}
 	else
 	{
-		if (language.empty() == true)
-		{
-			language = _(&quot;Per document&quot;); 
-			notALanguageName = true;
-		}
-
 		titleLabel-&gt;hide();
 		titleEntry-&gt;hide();
 		typeLabel-&gt;hide();
@@ -102,6 +135,7 @@
 		sizeEntry-&gt;hide();
 		termsLabel-&gt;hide();
 		termsEntry-&gt;hide();
+		saveTermsButton-&gt;hide();
 	}
 
 	populate_languageCombobox(language, notALanguageName);
@@ -169,6 +203,7 @@
 		{
 			// Yup
 			row[m_labelsColumns.m_enabled] = true;
+			m_labels.insert(labelName);
 		}
 		else
 		{
@@ -227,6 +262,7 @@
 	}
 
 	// Go through the labels tree
+	m_labels.clear();
 	TreeModel::Children children = m_refLabelsTree-&gt;children();
 	if (children.empty() == false)
 	{
@@ -243,3 +279,47 @@
 		}
 	}
 }
+
+void propertiesDialog::on_saveTermsButton_clicked()
+{
+	ustring location(PinotSettings::getInstance().getHomeDirectory());
+
+	location += &quot;/terms.txt&quot;;
+#ifdef DEBUG
+	cout &lt;&lt; &quot;propertiesDialog::on_saveTermsButton_clicked: &quot; &lt;&lt; location &lt;&lt; endl;
+#endif
+
+	IndexInterface *pIndex = PinotSettings::getInstance().getIndex(m_indexLocation);
+	if ((pIndex == NULL) ||
+		(pIndex-&gt;isGood() == false))
+	{
+		if (pIndex != NULL)
+		{
+			delete pIndex;
+		}
+		return;
+	}
+
+	if (select_file_name(_(&quot;Export Terms&quot;), location, false) == true)
+	{
+		std::map&lt;unsigned int, string&gt; wordsMap;
+
+		if ((location.empty() == false) &amp;&amp;
+			(pIndex-&gt;getDocumentTerms(m_docId, wordsMap) == true))
+		{
+			ofstream termsFile;
+
+			termsFile.open(location.c_str());
+			if (termsFile.good() == true)
+			{
+				for (std::map&lt;unsigned int, string&gt;::const_iterator termIter = wordsMap.begin();
+					termIter != wordsMap.end(); ++termIter)
+				{
+					termsFile &lt;&lt; termIter-&gt;second &lt;&lt; &quot; &quot;;
+				}
+			}
+			termsFile.close();
+		}
+	}
+}
+

Modified: trunk/UI/GTK2/src/propertiesDialog.hh
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.hh	2007-10-13 08:31:22 UTC (rev 1034)
+++ trunk/UI/GTK2/src/propertiesDialog.hh	2007-10-13 13:56:29 UTC (rev 1035)
@@ -16,10 +16,11 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-#ifndef _LABELDIALOG_HH
-#define _LABELDIALOG_HH
+#ifndef _PROPERTIESDIALOG_HH
+#define _PROPERTIESDIALOG_HH
 
 #include &lt;string&gt;
+#include &lt;vector&gt;
 #include &lt;set&gt;
 #include &lt;glibmm/refptr.h&gt;
 #include &lt;gtkmm/liststore.h&gt;
@@ -31,9 +32,8 @@
 class propertiesDialog : public propertiesDialog_glade
 {  
 public:
-	propertiesDialog(const std::set&lt;std::string&gt; &amp;docLabels,
-		const DocumentInfo &amp;docInfo, unsigned int termsCount,
-		bool editDocument = true);
+	propertiesDialog(const std::string &amp;indexLocation,
+	        const std::vector&lt;DocumentInfo&gt; &amp;documentsList);
 	virtual ~propertiesDialog();
 
 	void setHeight(int maxHeight);
@@ -45,7 +45,9 @@
 protected:
 	LabelModelColumns m_labelsColumns;
 	Glib::RefPtr&lt;Gtk::ListStore&gt; m_refLabelsTree;
+	std::string m_indexLocation;
 	std::set&lt;std::string&gt; m_labels;
+	unsigned int m_docId;
 	bool m_editDocument;
 	DocumentInfo m_docInfo;
 
@@ -53,7 +55,8 @@
 
 	void populate_labelsTreeview(const std::set&lt;std::string&gt; &amp;docLabels);
 
-	void on_labelOkButton_clicked();
+	virtual void on_labelOkButton_clicked();
+	virtual void on_saveTermsButton_clicked();
 
 };
-#endif // _LABELDIALOG_HH
+#endif

Modified: trunk/UI/GTK2/src/propertiesDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog_glade.cc	2007-10-13 08:31:22 UTC (rev 1034)
+++ trunk/UI/GTK2/src/propertiesDialog_glade.cc	2007-10-13 13:56:29 UTC (rev 1035)
@@ -1,9 +1,9 @@
-// generated 2007/1/22 22:28:26 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
+// generated 2007/10/5 15:58:25 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.4 and gtkmm 2.10.5
+// for gtk 2.10.14 and gtkmm 2.10.11
 //
 // Please modify the corresponding derived classes in ./src/propertiesDialog.cc
 
@@ -39,10 +39,10 @@
 #include &lt;gtkmm/accelgroup.h&gt;
 #include &lt;gtkmm/button.h&gt;
 #include &lt;gtkmm/buttonbox.h&gt;
+#include &lt;gtkmm/box.h&gt;
 #include &lt;gtkmm/table.h&gt;
 #include &lt;gtkmm/viewport.h&gt;
 #include &lt;gtkmm/adjustment.h&gt;
-#include &lt;gtkmm/box.h&gt;
 #ifndef ENABLE_NLS
 #  define textdomain(String) (String)
 #  define gettext(String) (String)
@@ -69,9 +69,11 @@
    typeLabel = Gtk::manage(new class Gtk::Label(_(&quot;MIME type:&quot;)));
    sizeLabel = Gtk::manage(new class Gtk::Label(_(&quot;Size:&quot;)));
    sizeEntry = Gtk::manage(new class Gtk::Entry());
+   termsLabel = Gtk::manage(new class Gtk::Label(_(&quot;Terms:&quot;)));
    termsEntry = Gtk::manage(new class Gtk::Entry());
-   termsLabel = Gtk::manage(new class Gtk::Label(_(&quot;Terms:&quot;)));
+   saveTermsButton = Gtk::manage(new class Gtk::Button(Gtk::StockID(&quot;gtk-save-as&quot;)));
    
+   Gtk::HBox *termsHbox = Gtk::manage(new class Gtk::HBox(false, 0));
    Gtk::Table *propertiesTable = Gtk::manage(new class Gtk::Table(2, 2, false));
    labelsTreeview = Gtk::manage(new class Gtk::TreeView());
    
@@ -128,18 +130,22 @@
    sizeEntry-&gt;set_max_length(0);
    sizeEntry-&gt;set_has_frame(true);
    sizeEntry-&gt;set_activates_default(false);
+   termsLabel-&gt;set_alignment(0,0.5);
+   termsLabel-&gt;set_padding(0,0);
+   termsLabel-&gt;set_justify(Gtk::JUSTIFY_LEFT);
+   termsLabel-&gt;set_line_wrap(false);
+   termsLabel-&gt;set_use_markup(false);
+   termsLabel-&gt;set_selectable(false);
    termsEntry-&gt;set_flags(Gtk::CAN_FOCUS);
    termsEntry-&gt;set_visibility(true);
    termsEntry-&gt;set_editable(false);
    termsEntry-&gt;set_max_length(0);
    termsEntry-&gt;set_has_frame(true);
    termsEntry-&gt;set_activates_default(false);
-   termsLabel-&gt;set_alignment(0,0.5);
-   termsLabel-&gt;set_padding(0,0);
-   termsLabel-&gt;set_justify(Gtk::JUSTIFY_LEFT);
-   termsLabel-&gt;set_line_wrap(false);
-   termsLabel-&gt;set_use_markup(false);
-   termsLabel-&gt;set_selectable(false);
+   saveTermsButton-&gt;set_flags(Gtk::CAN_FOCUS);
+   saveTermsButton-&gt;set_relief(Gtk::RELIEF_NORMAL);
+   termsHbox-&gt;pack_start(*termsEntry, Gtk::PACK_EXPAND_WIDGET, 4);
+   termsHbox-&gt;pack_start(*saveTermsButton, Gtk::PACK_SHRINK, 4);
    propertiesTable-&gt;set_row_spacings(0);
    propertiesTable-&gt;set_col_spacings(0);
    propertiesTable-&gt;attach(*titleEntry, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
@@ -150,8 +156,8 @@
    propertiesTable-&gt;attach(*typeLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 4, 4);
    propertiesTable-&gt;attach(*sizeLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 4, 4);
    propertiesTable-&gt;attach(*sizeEntry, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   propertiesTable-&gt;attach(*termsEntry, 1, 2, 4, 5, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    propertiesTable-&gt;attach(*termsLabel, 0, 1, 4, 5, Gtk::FILL, Gtk::FILL, 4, 4);
+   propertiesTable-&gt;attach(*termsHbox, 1, 2, 4, 5, Gtk::FILL, Gtk::FILL, 0, 0);
    labelsTreeview-&gt;set_flags(Gtk::CAN_FOCUS);
    labelsTreeview-&gt;set_headers_visible(true);
    labelsTreeview-&gt;set_rules_hint(false);
@@ -192,14 +198,17 @@
    typeLabel-&gt;show();
    sizeLabel-&gt;show();
    sizeEntry-&gt;show();
+   termsLabel-&gt;show();
    termsEntry-&gt;show();
-   termsLabel-&gt;show();
+   saveTermsButton-&gt;show();
+   termsHbox-&gt;show();
    propertiesTable-&gt;show();
    labelsTreeview-&gt;show();
    viewport1-&gt;show();
    labelsScrolledwindow-&gt;show();
    propertiesVbox-&gt;show();
    labelOkButton-&gt;signal_clicked().connect(SigC::slot(*this, &amp;propertiesDialog_glade::on_labelOkButton_clicked), false);
+   saveTermsButton-&gt;signal_clicked().connect(SigC::slot(*this, &amp;propertiesDialog_glade::on_saveTermsButton_clicked), false);
 }
 
 propertiesDialog_glade::~propertiesDialog_glade()

Modified: trunk/UI/GTK2/src/propertiesDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog_glade.hh	2007-10-13 08:31:22 UTC (rev 1034)
+++ trunk/UI/GTK2/src/propertiesDialog_glade.hh	2007-10-13 13:56:29 UTC (rev 1035)
@@ -1,9 +1,9 @@
-// generated 2007/1/22 22:22:59 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
+// generated 2007/10/5 15:58:25 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.4 and gtkmm 2.10.5
+// for gtk 2.10.14 and gtkmm 2.10.11
 //
 // Please modify the corresponding derived classes in ./src/propertiesDialog.hh and./src/propertiesDialog.cc
 
@@ -55,8 +55,9 @@
         class Gtk::Label * typeLabel;
         class Gtk::Label * sizeLabel;
         class Gtk::Entry * sizeEntry;
+        class Gtk::Label * termsLabel;
         class Gtk::Entry * termsEntry;
-        class Gtk::Label * termsLabel;
+        class Gtk::Button * saveTermsButton;
         class Gtk::TreeView * labelsTreeview;
         class Gtk::ScrolledWindow * labelsScrolledwindow;
         
@@ -65,5 +66,6 @@
         ~propertiesDialog_glade();
 private:
         virtual void on_labelOkButton_clicked() = 0;
+        virtual void on_saveTermsButton_clicked() = 0;
 };
 #endif


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001028.html">[Pinot-svn] r1034 - trunk/po
</A></li>
	<LI>Next message: <A HREF="001030.html">[Pinot-svn] r1036 - trunk/UI/GTK2/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1029">[ date ]</a>
              <a href="thread.html#1029">[ thread ]</a>
              <a href="subject.html#1029">[ subject ]</a>
              <a href="author.html#1029">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/pinot-svn">More information about the Pinot-svn
mailing list</a><br>
</body></html>
