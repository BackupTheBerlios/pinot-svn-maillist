<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Pinot-svn] r794 - trunk/Utils/xdgmime
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/pinot-svn/2007-March/index.html" >
   <LINK REL="made" HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r794%20-%20trunk/Utils/xdgmime&In-Reply-To=%3C200703291313.l2TDDTJt028407%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000787.html">
   <LINK REL="Next"  HREF="000789.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Pinot-svn] r794 - trunk/Utils/xdgmime</H1>
    <B>fabricecolin at BerliOS</B> 
    <A HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r794%20-%20trunk/Utils/xdgmime&In-Reply-To=%3C200703291313.l2TDDTJt028407%40sheep.berlios.de%3E"
       TITLE="[Pinot-svn] r794 - trunk/Utils/xdgmime">fabricecolin at mail.berlios.de
       </A><BR>
    <I>Thu Mar 29 15:13:29 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000787.html">[Pinot-svn] r793 - trunk
</A></li>
        <LI>Next message: <A HREF="000789.html">[Pinot-svn] r795 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#788">[ date ]</a>
              <a href="thread.html#788">[ thread ]</a>
              <a href="subject.html#788">[ subject ]</a>
              <a href="author.html#788">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fabricecolin
Date: 2007-03-29 15:13:24 +0200 (Thu, 29 Mar 2007)
New Revision: 794

Modified:
   trunk/Utils/xdgmime/ChangeLog
   trunk/Utils/xdgmime/xdgmimecache.c
Log:
Sync with current gtk+ source.


Modified: trunk/Utils/xdgmime/ChangeLog
===================================================================
--- trunk/Utils/xdgmime/ChangeLog	2007-03-29 11:07:48 UTC (rev 793)
+++ trunk/Utils/xdgmime/ChangeLog	2007-03-29 13:13:24 UTC (rev 794)
@@ -1,366 +1,348 @@
-2006-07-13  Christian Neumair  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">chris at gnome-de.org</A>&gt;
+2007-01-07  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimemagic.c: (_xdg_mime_magic_parse_magic_line):
-	Only declare 'i' #if LITTLE_ENDIAN. Partially fixes GNOME #340277.
-	Thanks to James Andrewartha.
+	* xdgmimecache.c (cache_glob_node_lookup_suffix): Don't return &quot;&quot; 
+	as match.  (fd.o #9544, Yevgen Muntyan)
 
-2006-03-02  Christian Neumair  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">chris at gnome-de.org</A>&gt;
+2007-01-07  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimeglob.c: (_xdg_glob_hash_insert_text),
-	(_xdg_glob_hash_append_glob): Don't strdup the MIME type when passing
-	it to _xdg_glob_hash_insert_text, but let the function itself figure
-	out whether string duplication is needed. Fixes #5993.
-	Thanks to Martin Wehner.
+	* xdgmimecache.c (_xdg_mime_cache_list_mime_parents): Fix 
+	several problems with this function.  (fd.o #9560, Yevgen Muntyan)
 
-2006-02-25  Christian Neumair  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">chris at gnome-de.org</A>&gt;
+2006-08-17  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimemagic.c: (_xdg_mime_magic_lookup_data): Make
-	priority equality check more robust so that it works for three or more
-	matches. Also allow matchlets with 0 priority.
+	* === Released 2.10.2 ===
 
-2006-02-19  Christian Neumair  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">chris at gnome-de.org</A>&gt;
+2006-07-23  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
+	
+	* === Released 2.10.1 ===
 
-	* src/xdgmimemagic.c: (_xdg_mime_magic_lookup_data): When two
-	unrelated MIME types with equal priorities match, don't assume one of
-	them matches.
-	<A HREF="http://bugzilla.gnome.org/show_bug.cgi?id=331719">http://bugzilla.gnome.org/show_bug.cgi?id=331719</A>
+2006-07-20  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2006-01-03  Christian Neumair  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">chris at gnome-de.org</A>&gt;
+	Fix a thinko that leads to constantly reloading
+	the mime data if a mime.cache is present.  Patch
+	by Yevgen Muntyan, bugs.freedesktop.org #7495
+	
+	* xdgmime.c (xdg_check_dir): Look for mime.cache first.
+	(xdg_check_file): Report existance of the file separately.
+	
+2006-07-20  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimemagic.c: (_xdg_mime_magic_lookup_data): Also consider
-	match priority for the returned MIME type.
+	* xdgmime.c (xdg_mime_shutdown): Unref the caches.
+	Patch by Yevgen Muntyan, bugs.freedesktop.org #7496
 
-2005-12-01  Christian Neumair  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">chris at gnome-de.org</A>&gt;
+	* xdgmimemagic.c: 
+	* xdgmime.c: 
+	* xdgmime.h: Add xdg_init-free versions of some
+	functions and use them internally, so that we don't
+	reload caches and clobber data structures in the
+	middle of an operation.  Patch by Joe Shaw,
+	bugs.freedesktop.org #6824
 
-	* src/xdgmime.c: (xdg_mime_get_mime_type_from_file_name):
-	* src/xdgmimecache.c: (_xdg_mime_cache_get_mime_type_from_file_name):
-	Return XDG_MIME_TYPE_UNKNOWN if multiple MIME types match a simple
-	pattern.
+2006-07-19  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2005-12-01  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
+	* xdgmimeglob.c (_xdg_glob_hash_node_lookup_file_name):
+	Don't return NULL as a mimetype, ever, patch
+	by Yevgen Muntyan, bugs.freedesktop.org #5241
 
-	* src/xdgmimecache.h:
-	* src/xdgmimecache.c (_xdg_mime_cache_get_mime_type_for_file): 
-	Allow passing in a struct stat * to avoid re-stat()ing. 
-	Forgotten commit from an earlier entry.
+2006-07-02  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
+	
+	* === Released 2.10.0 ===
 
-	* src/xdgmimecache.c (cache_glob_lookup_literal):
-	(cache_glob_lookup_fnmatch):
-	(cache_glob_node_lookup_suffix): Change these functions to
-	allow returning more than one mime type if identical globs
-	match.
-
-	* src/xdgmimemagic.h: 
-	* src/xdgmimeglob.h: 
-	* src/xdgmimemagic.c (_xdg_mime_magic_lookup_data): 
-	* src/xdgmimeglob.c (_xdg_glob_hash_lookup_file_name): 
-	Change these functions to allow returning more than one
-	mime type if identical globs match.
+2006-06-21  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 	
-	* src/xdgmimecache.c (_xdg_mime_cache_get_mime_type_for_file): 
-	* src/xdgmime.c (xdg_mime_get_mime_type_for_file): 
-	If multiple identical globs match, use magic to disambiguate.
-	
-2005-11-04  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
+	* === Released 2.9.4 ===
 
-	* xdgmime.c (xdg_mime_list_mime_parents): Prevent
-	a segfault.
+2006-06-12  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2005-10-18  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
-	
-	* src/xdgmime.c:
-	* src/xdgmimecache.h:
-	* src/xdgmimecache.c: Make the array of caches NULL-terminated
-	and rename it to _caches.  (#4011)
+	* === Released 2.9.3 ===
 
-	* src/xdgmime.h:
-	* src/xdgmime.c: Add a struct statbuf * argument to 
-	xdg_mime_get_mime_type_for_file().  (#3529)
+2006-06-05  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/test-mime.c: Adjust callers. Add License.
+	* === Released 2.9.2 ===
 
-	* src/xdgmimecache.c: Make magic comparisons work correctly.
+2006-05-16  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-Thu Jun  9 23:55:25 2005  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at redhat.com</A>&gt;
+	* === Released 2.9.1 ====
 
-	* src/xdgmime.c (xdg_mime_init_from_directory): patch from
-	federico to realloc the right size, #3506
+2006-05-04  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2005-04-17  Christophe Fergeau  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">teuf at gnome.org</A>&gt;
+	* === Released 2.9.0 ===
 
-	* src/xdgmimeint.c: fix gcc4 signedness warning
+2006-04-03  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2005-04-17  Christophe Fergeau  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">teuf at gnome.org</A>&gt;
+	* xdgmime.[hc]: Move xdg_mime_type_unknown to .rodata.
 
-	* src/xdgmimemagic.c: (_xdg_mime_magic_matchlet_compare_to_data),
-	(_xdg_mime_magic_matchlet_compare_level),
-	(_xdg_mime_magic_lookup_data): when  magic patterns matches, check if
-	there aren't subtypes with matching patterns too, and if so, favour
-	the subtype over the parent type, should fix #2686
+2006-03-06  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2005-04-16  Christophe Fergeau  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">teuf at gnome.org</A>&gt;
+	* xdgmimemagic.c: Remove superfluous extern errno 
+	declaration.  (#333605, Tommi Komulainen)
 
-	* src/xdgmime.c: (xdg_mime_init_from_directory): fix leak when
-	mime.cache doesn't exist
+2006-02-27  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2005-04-16  Christophe Fergeau  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">teuf at gnome.org</A>&gt;
+	* xdgmime.h (xdg_mime_dump): Don't export xdg_mime_dump.
 
-	* src/test-mime.c: (main): disabled call to xdg_mime_dump for now
-	* src/xdgmimemagic.c: (_xdg_mime_magic_matchlet_compare_to_data):
-	fixed off by 1 error when handling offsets, fixes bug #2050 and 
-	partly bug #2359
+2005-12-01  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-Fri Apr  8 23:37:33 2005  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at redhat.com</A>&gt;
+	* Merge upstream changes to handle duplicate glob
+	patterns.
 
-	* src/xdgmimecache.c: Actually add the file.  Also, patch from
-	Matthias Clasen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt; to fix small bugs, #2939
+2005-11-04  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-Fri Apr  1 14:59:43 2005  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at redhat.com</A>&gt;
+	* xdgmime.c (xdg_mime_list_mime_parents): Prevent
+	a segfault.  
 
-	* src/xdgmimecache.c: Patch from Matthias Clasen to mmap the
-	cached xdg file.
+2005-10-18  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-Mon Mar 28 13:58:32 2005  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at redhat.com</A>&gt;
+	* xdgmimecache.c: Make magic comparisons work correctly
+	in the cache.
 
-	* src/xdgmimeglob.c (_xdg_glob_hash_insert_text): patch from
-	Matthias Clasen to handle globs that don't have '.' chars in
-	them.  As an example 'foo~' should match '*~'
+2005-10-17  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-Mon Mar 21 13:16:12 2005  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at redhat.com</A>&gt;
+	* xdgmime.c (xdg_mime_get_mime_type_for_file): Remove
+	a debugging printf.
 
-	* src/xdgmime.c (xdg_mime_shutdown): fix from  Axel Liljencrantz
-	&lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">f97-ali at nada.kth.se</A>&gt; to free parent_list in shutdown.
+2005-09-01  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2005-01-10  Christophe Fergeau  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">teuf at gnome.org</A>&gt;
+	* xdgmime.h:
+	* xdgmime.c (xdg_mime_get_mime_type_for_file): Take
+	a struct statbuf * as argument.
 
-	* src/xdgmimeglob.c: (_xdg_glob_hash_lookup_file_name): make previous
-	commit actually work...
+	* test-mime.c (main): Adjust.
 
-2005-01-10  Christophe Fergeau  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">teuf at gnome.org</A>&gt;
+2005-08-24  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimeglob.c: (_xdg_glob_hash_lookup_file_name): don't get
-	confused by multiple dots in filenames when doing extension matching
+	* === Released 2.8.2 ===
 
-2004-12-13  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+	* === Released 2.8.1 ===
 
-	* src/xdgmime.h:
+2005-08-13  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	 wrap new API in XDG_ENTRY()
+	* === Released 2.8.0 ===
 
-2004-12-13  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+2005-08-07  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimeglob.c: (_xdg_glob_hash_lookup_file_name):
+	* Rename caches to _caches, so it doesn't
+	get exported. Also don't export n_caches.
 
-	Do not assume the filename is UTF8. We just need to look
-	for the dot which is ASCII.
+2005-08-02  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2004-12-09  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+	* === Released 2.7.5 ===
 
-	* src/xdgmimeint.h:
+2005-07-22  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	Remove spacings I introduced by mistake
+	* === Released 2.7.4 === 
 
-2004-12-09  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+2005-07-15  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimealias.c: (_xdg_mime_alias_read_from_file):
-	* src/xdgmimeint.c: (_xdg_ucs4_to_lower):
-	* src/xdgmimeint.h:
-	* src/xdgmimeparent.c: (_xdg_mime_parent_read_from_file):
+	* === Released 2.7.3 ===
+	
+2005-07-08  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
+	
+	* === Released 2.7.2 ===
 
-	Check in Mariano Su&#225;rez-Alvarez &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">msuarezalvarez at arnet.com.ar</A>&gt; patch
-	for GNOME bug #160838.
+2005-07-01  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2004-12-09  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+	* === Released 2.7.1 ===
+	
+2005-06-20  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimeglob.c: (_xdg_glob_hash_node_lookup_file_name):
-	* src/xdgmimeint.c: (_xdg_ucs4_to_lower):
-	* src/xdgmimeint.h:
+	* xdgmimecache.c: Handle missing MAP_FAILED.  (#308449, Georg
+	Schwarz)
 
-	Follow the freedesktop spec about case sensitiveness. Fix #732
+2005-06-20  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2004-12-08  Christophe Fergeau  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">teuf at gnome.org</A>&gt;
+	* === Released 2.7.0 ===
 
-	* src/xdgmimeglob.c: (_xdg_mime_glob_read_from_file): backing out
-	&quot;fix&quot; for bug #1048 since it frees memory that shouldn't be freed.
+2005-06-10  Federico Mena Quintero  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">federico at ximian.com</A>&gt;
 
-2004-12-08  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+	* xdgmime.c (xdg_mime_init_from_directory): Pass the correct size
+	to realloc().  Fixes <A HREF="https://bugs.freedesktop.org/show_bug.cgi?id=3506.">https://bugs.freedesktop.org/show_bug.cgi?id=3506.</A>
 
-	* src/xdgmimemagic.c: (_xdg_mime_magic_read_from_file):
+2005-06-09  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	Check that fread succeeded reading all chars. Fix #1049
+	* xdgmimemagic.c: Don't declare errno, including errno.h 
+	is enough.  (#304164, Joerg Sonnenberger)
 
-2004-12-08  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+2005-05-20  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmime.c:
-	* src/xdgmimealias.c:
-	* src/xdgmimeglob.c:
-	* src/xdgmimeint.c:
-	* src/xdgmimemagic.c:
-	* src/xdgmimeparent.c:
+	* xdgmimecache.c (GET_UINT32): Don't rely on C99 
+	types.  (#304924, John Ehresman)
 
-	Include config.h. Fix #913
+2005-04-29  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2004-12-08  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+	* Sync to upstream.
 
-	* src/xdgmimealias.c: (_xdg_mime_alias_list_lookup):
+2005-04-08  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	Fix a typo
+	* xdgmimecache.c (cache_magic_matchlet_compare_to_data) 
+	(cache_magic_matchlet_compare): Use cache-&gt;buffer, not 
+	cache.  
 
-2004-12-08  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+Tue Apr  5 16:00:04 2005  Manish Singh  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">yosh at gimp.org</A>&gt;
 
-	* src/xdgmime.c: (xdg_mime_unalias_mime_type),
-	(xdg_mime_mime_type_equal), (xdg_mime_mime_type_subclass),
-	(xdg_mime_get_mime_parents):
-	* src/xdgmime.h:
+	* Makefile.am: add xdgmimecache.[ch].
 
-	Add apis to get parents and to unalias mime type
+2005-03-28  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2004-12-08  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+	* xdgmimeglob.c: Sync to latest upstream,
+	including fixes for matching against multiple
+	extensions (eg .tar.gz) and for suffix
+	patterns which don't start with a dot.
 
-	* src/xdgmimealias.c: (_xdg_mime_alias_list_lookup):
-	* src/xdgmimeparent.c: (_xdg_mime_parent_list_lookup):
+Sat Mar 19 23:52:33 2005  Manish Singh  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">yosh at gimp.org</A>&gt;
 
-	Protect against stupid bsearch() implementations.  (#1961,
-	Morten Welinder)
+	* xdgmimeglob.c (_xdg_glob_hash_insert_text): cast away the constness
+	in the call to free().
 
-2004-12-08  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+2005-03-20  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimeparent.c: (_xdg_mime_parent_read_from_file):
+	* xdgmimeglob.c (_xdg_glob_hash_insert_text): Don't 
+	leak node-&gt;mime_type if we are reusing an existing
+	node.  (#170774, Kjartan Maraas)
 
-	Initialize the parent field of the newly allocate list 
-	entry.  (#1916, Alex Larsson)
+2005-01-08  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-2004-12-08  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+	* === Released 2.6.1 ===
+	
+2004-12-16  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimeglob.c: (_xdg_mime_glob_read_from_file):
+	* === Released 2.6.0 ===
 
-	Patch from Matthias Clasen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt; to fix
-	a mem leak. Bug #1048
+2004-12-13  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
 
-2004-12-08  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
+	* xdgmimeglob.c: (_xdg_glob_hash_lookup_file_name):
 
-	* src/xdgmimeglob.h:
+	Resync with upstream again
 
-	Patch from <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">Michael.Wilson at bull.net</A> to fix compile error on AIX
+Fri Dec 10 13:58:38 2004  Manish Singh  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">yosh at gimp.org</A>&gt;
 
-Sun Nov  7 02:25:21 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at redhat.com</A>&gt;
+	* xdgmime.h: wrap new API in XDG_ENTRY().
 
-	* src/xdgmime.h: Patch from Matthias Clasen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
-	to add alias and inheritence support.
+2004-12-09  Marco Pesenti Gritti  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">marco at gnome.org</A>&gt;
 
-2004-09-16  Christophe Fergeau  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">teuf at gnome.org</A>&gt;
+	* xdgmime.c: (xdg_mime_unalias_mime_type),
+	(xdg_mime_mime_type_equal), (xdg_mime_mime_type_subclass),
+	(xdg_mime_get_mime_parents):
+	* xdgmime.h:
+	* xdgmimealias.c: (_xdg_mime_alias_list_lookup):
+	* xdgmimeglob.c: (_xdg_glob_hash_node_lookup_file_name):
+	* xdgmimeint.c: (_xdg_ucs4_to_lower):
+	* xdgmimeint.h:
+	* xdgmimemagic.c: (_xdg_mime_magic_read_from_file):
+	* xdgmimeparent.c: (_xdg_mime_parent_list_lookup):
 
-	* src/xdgmimeglob.c: (_xdg_glob_hash_free_nodes):
-	* src/xdgmimemagic.c: (_xdg_mime_magic_free): fix memory leaks, 
-	  fixes <A HREF="http://bugzilla.gnome.org/show_bug.cgi?id=152771">http://bugzilla.gnome.org/show_bug.cgi?id=152771</A> and
-	  <A HREF="http://bugzilla.gnome.org/show_bug.cgi?id=152768">http://bugzilla.gnome.org/show_bug.cgi?id=152768</A>
+	Resync with upstream
 
-Mon Jul 19 00:23:00 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+2004-12-09  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmime.c (xdg_mime_register_reload_callback): register a
-	callback when we reload MIME data.
+	* xdgmimealias.c (_xdg_mime_alias_read_from_file): 
+	* xdgmimeparent.c (_xdg_mime_parent_read_from_file): Make
+	repeated calls accumulate the results, don't call qsort()
+	on empty arrays.  (#160838, Mariano Su&#225;rez-Alvarez)
 
-	* src/xdgmime.c (xdg_mime_remove_callback): Add capability to
-	remove callback.
+2004-12-02  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-Sun Jul 18 20:56:22 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+	* === Released 2.5.6 ===
 
-	* src/xdgmime.c (xdg_mime_shutdown):
-	(xdg_mime_init): reread data when it changes on disk.
+2004-11-29  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-Thu May 27 16:18:14 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+	* xdgmimeparent.c (_xdg_mime_parent_list_lookup): 
+	* xdgmimealias.c (_xdg_mime_alias_list_lookup): Protect 
+	against stupid bsearch() implementations.  (#159737,
+	Morten Welinder)
+ 
+2004-11-24  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmime.h: move xdg_mime_shutdown into the XDG_ENTRY guard.
+	* xdgmimeparent.c (_xdg_mime_parent_read_from_file): 
+	Initialize the parent field of the newly allocate list 
+	entry.  (#159330, Alex Larsson)
 
-Thu May 27 15:02:13 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+Fri Nov 19 15:10:32 2004  Manish Singh  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">yosh at gimp.org</A>&gt;
 
-	* src/xdgmimemagic.c (_xdg_mime_magic_read_magic_file): patch from
-	Hongli Lai &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">h.lai at chello.nl</A>&gt; to catch magic files that don't end
-	with a '\n'.
+	* xdgmime.c: Don't put /* within a comment.
 
-Fri Apr 30 11:56:01 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+2004-11-09  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimemagic.c (_xdg_mime_magic_read_a_number): make the
-	buffer the right size.  Reported by Morten Welinder, #136323
+	* xdgmime.h: Prefix all symbols.
 
-Sun Mar 21 23:56:46 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+2004-11-08  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimemagic.c: Patch from Arjan van de Ven
-	&lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">arjanv at redhat.com</A>&gt; to do s/fgetc/getc_unlocked/g.
+	* xdgmime.c (xdg_mime_mime_type_subclass): Enable matching
+	of supertypes as text/*.
 
-Wed Mar 10 22:28:41 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+	* Sync from upstream
 
-	* src/xdgmimemagic.c (_xdg_mime_magic_read_a_number): fix usage of
-	isdigit.  Reported by Morten Welinder, #136323
+2004-10-27  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimemagic.c (_xdg_mime_magic_read_magic_file): patch from
-	Christophe Fergeau to reverse the order of the matchlet before
-	adding it to the list.
+	* === Released 2.5.4 ===
 
-	* src/xdgmimeint.h (_xdg_utf8_skip): patch from Alexander Larsson
-	to make extern.
+2004-09-19  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-Wed Jan 21 09:29:41 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+	* === Released 2.5.3 ===
 
-	* src/xdgmimemagic.c (_xdg_mime_magic_insert_match): dropped
-	patches.  Fix.
+2004-08-25  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-	* src/xdgmimeglob.c (_xdg_glob_hash_free_nodes): dropped patches.
-	Fix.
+	* === Released 2.5.2 ===
 
-Tue Jan 20 14:55:39 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+Wed Aug 11 20:44:35 2004  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">maclas at gmx.de</A>&gt;
 
-	* src/xdgmime.h (XDG_MIME_TYPE_UNKNOWN): move the definition so
-	that it catches the XDG_ENTRY mangling.
+	* xdgmime.h (xdg_mime_shutdown): Add the XDG_PREFIX to
+	this function as well.
 
-	* src/xdgmimemagic.c: make some functions static
+2004-08-01  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">mclasen at redhat.com</A>&gt;
 
-Tue Jan 20 14:34:26 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+	* === Released 2.5.1 ===
 
-	* src/xdgmime.c (xdg_mime_get_max_buffer_extents): add function so
-	that it's easy to get the max buffer extents.
+Tue Jul 20 22:24:35 2004  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">maclas at gmx.de</A>&gt;
 
-Tue Jan 20 12:55:55 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+	* xdgmimeglob.h: Remove trailing commas from 
+	enumerations. (#148035)
 
-	* src/Makefile: Test prefix code
+Sun Jul 18 20:17:41 2004  Soeren Sandmann  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">sandmann at daimi.au.dk</A>&gt;
 
-	* src/xdgmime*.h: Fully use the prefix code
+	* === Released 2.5.0 ==
 
-	* src/xdgmime.c: finish the syncing from both GTK+ and gnome-vfs.
+Thu May 27 15:23:17 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
 
-Tue Jan 13 16:21:04 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+	* Sync from upstream
 
-	* src/xdgmime.[ch] (XDG_MIME_TYPE_UNKNOWN): make an extern const
-	char * so that comparisons can work.
+Fri Apr 30 00:19:11 2004  Matthias Clasen  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">maclas at gmx.de</A>&gt;
 
-	* src/xdgmimeint.c (_xdg_utf8_to_ucs4): patch from Dave Jones
-	&lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">davej at redhat.com</A>&gt; to make operations more explicit.
+	* xdgmimemagic.c (_xdg_mime_magic_read_a_number): Make sure
+	the static string is long enough.  (#136323, Morten Welinder)
 
-Tue Oct 28 15:09:06 2003  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at redhat.com</A>&gt;
+2004-03-12  Morten Welinder  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">terra at gnome.org</A>&gt;
 
-	* README: Add a readme, and clarify the licensing terms of the
-	software.
+	* *.c: Make sure to include &lt;config.h&gt;  (#137001)
 
-Tue Oct 28 14:47:37 2003  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at redhat.com</A>&gt;
+Wed Mar 10 22:48:15 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
 
-	* src/xdgmime.c (xdg_mime_shutdown): implement shutdown.  This
-	frees all memory and resets to an uninitialized state as best as
-	possible.
+	* Sync from upstream
 
-Mon Oct 27 11:45:58 2003  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at redhat.com</A>&gt;
+Sun Feb  8 19:05:16 2004  Manish Singh  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">yosh at gimp.org</A>&gt;
 
-	* src/xdgmimemagic.c (_xdg_mime_magic_read_a_number): strtol
-	returns a long, not an int.  Thanks to Manish Singh for pointing
-	this out.
+	* xdgmimeint.h: declare _xdg_utf8_skip as extern to prevent multiple
+	definitions.
 
-	* src/xdgmimemagic.c (_xdg_mime_magic_parse_magic_line): change
-	assertion to avoid a warning.
+Wed Jan 21 09:33:13 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
 
-Tue Oct 21 15:56:55 2003  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
+	* libgnomevfs/xdgmimeglob.c:
+	* libgnomevfs/xdgmimemagic.c: Sync from upstream
 
-	* Makefile: add a simple makefile
-	* src/Makefile: ditto
+Tue Jan 20 13:07:04 2004  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
 
+	* xdgmime.c: resync with upstream sources.
+
+Fri Oct 24 16:54:57 2003  Owen Taylor  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">otaylor at redhat.com</A>&gt;
+
+	* Makefile.am (libxdgmime_la_SOURCES): Add .h files to 
+	SOURCES.
+
+Fri Oct 24 16:02:32 2003  Owen Taylor  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">otaylor at redhat.com</A>&gt;
+
+	* *.[ch]: Relicense to be dual AFL/LGPL (and thus also
+	GPL) rather than AFL/GPL. Also update AFL version to 1.2.
+
 Tue Jul 22 15:37:45 2003  Jonathan Blandford  &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">jrb at gnome.org</A>&gt;
 
 	* xdgmime/xdgmime.c (xdg_mime_init): use XDG_DATA_HOME instead of

Modified: trunk/Utils/xdgmime/xdgmimecache.c
===================================================================
--- trunk/Utils/xdgmime/xdgmimecache.c	2007-03-29 11:07:48 UTC (rev 793)
+++ trunk/Utils/xdgmime/xdgmimecache.c	2007-03-29 13:13:24 UTC (rev 794)
@@ -463,7 +463,8 @@
 	    {
 	      mimetype_offset = GET_UINT32 (cache-&gt;buffer, offset + 16 * mid + 4);
 	      n = 0;
-	      mime_types[n++] = cache-&gt;buffer + mimetype_offset;
+	      if (mimetype_offset)
+		mime_types[n++] = cache-&gt;buffer + mimetype_offset;
 	      
 	      n_children = GET_UINT32 (cache-&gt;buffer, offset + 16 * mid + 8);
 	      child_offset = GET_UINT32 (cache-&gt;buffer, offset + 16 * mid + 12);
@@ -850,10 +851,12 @@
 char **
 _xdg_mime_cache_list_mime_parents (const char *mime)
 {
-  int i, j, p;
+  int i, j, k, p;
   char *all_parents[128]; /* we'll stop at 128 */ 
   char **result;
 
+  mime = xdg_mime_unalias_mime_type (mime);
+
   p = 0;
   for (i = 0; _caches[i]; i++)
     {
@@ -864,16 +867,20 @@
 
       for (j = 0; j &lt; n_entries; j++)
 	{
-	  xdg_uint32_t mimetype_offset = GET_UINT32 (cache-&gt;buffer, list_offset + 4 + 8 * i);
-	  xdg_uint32_t parents_offset = GET_UINT32 (cache-&gt;buffer, list_offset + 4 + 8 * i + 4);
-	  
+	  xdg_uint32_t mimetype_offset = GET_UINT32 (cache-&gt;buffer, list_offset + 4 + 8 * j);
+	  xdg_uint32_t parents_offset = GET_UINT32 (cache-&gt;buffer, list_offset + 4 + 8 * j + 4);
+
 	  if (strcmp (cache-&gt;buffer + mimetype_offset, mime) == 0)
 	    {
+	      xdg_uint32_t parent_mime_offset;
 	      xdg_uint32_t n_parents = GET_UINT32 (cache-&gt;buffer, parents_offset);
-	      
-	      for (j = 0; j &lt; n_parents; j++)
-		all_parents[p++] = cache-&gt;buffer + parents_offset + 4 + 4 * j;
 
+	      for (k = 0; k &lt; n_parents &amp;&amp; p &lt; 127; k++)
+		{
+		  parent_mime_offset = GET_UINT32 (cache-&gt;buffer, parents_offset + 4 + 4 * k);
+		  all_parents[p++] = cache-&gt;buffer + parent_mime_offset;
+		}
+
 	      break;
 	    }
 	}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000787.html">[Pinot-svn] r793 - trunk
</A></li>
	<LI>Next message: <A HREF="000789.html">[Pinot-svn] r795 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#788">[ date ]</a>
              <a href="thread.html#788">[ thread ]</a>
              <a href="subject.html#788">[ subject ]</a>
              <a href="author.html#788">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/pinot-svn">More information about the Pinot-svn
mailing list</a><br>
</body></html>
