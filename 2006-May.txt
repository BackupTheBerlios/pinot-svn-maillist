From fabricecolin at berlios.de  Tue May  2 15:00:26 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 2 May 2006 15:00:26 +0200
Subject: [Pinot-svn] r225 - in trunk: Search/Plugins UI/GTK2/src
Message-ID: <200605021300.k42D0QY0029170@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-02 15:00:24 +0200 (Tue, 02 May 2006)
New Revision: 225

Modified:
   trunk/Search/Plugins/AmazonAPI.src
   trunk/Search/Plugins/YahooAPI.src
   trunk/UI/GTK2/src/PinotSettings.cpp
Log:
Merged channel Web Services with The Web.


Modified: trunk/Search/Plugins/AmazonAPI.src
===================================================================
--- trunk/Search/Plugins/AmazonAPI.src	2006-04-22 06:34:23 UTC (rev 224)
+++ trunk/Search/Plugins/AmazonAPI.src	2006-05-02 13:00:24 UTC (rev 225)
@@ -6,7 +6,7 @@
 	description="Amazon.com REST API"
 	method="GET"
 	action="http://webservices.amazon.com/onca/xml"
-	routeType="Web Services"
+	routeType="The Web"
 >
 
 <INPUT NAME="Service" VALUE="AWSECommerceService">

Modified: trunk/Search/Plugins/YahooAPI.src
===================================================================
--- trunk/Search/Plugins/YahooAPI.src	2006-04-22 06:34:23 UTC (rev 224)
+++ trunk/Search/Plugins/YahooAPI.src	2006-05-02 13:00:24 UTC (rev 225)
@@ -6,7 +6,7 @@
 	description="Yahoo! REST API"
 	method="GET"
 	action="http://api.search.yahoo.com/WebSearchService/V1/webSearch"
-	routeType="Web Services"
+	routeType="The Web"
 >
 
 # Edit this field's value to set to your application ID

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2006-04-22 06:34:23 UTC (rev 224)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2006-05-02 13:00:24 UTC (rev 225)
@@ -211,13 +211,13 @@
 	// Some search engines are hardcoded
 #ifdef HAS_GOOGLEAPI
 	m_engineIds[1 << m_engines.size()] = "Google API";
-	m_engines.insert(Engine("Google API", "googleapi", "", "Web Services"));
-	m_engineChannels.insert("Web Services");
+	m_engines.insert(Engine("Google API", "googleapi", "", "The Web"));
+	m_engineChannels.insert("The Web");
 #endif
 #ifdef HAS_OSAPI
 	m_engineIds[1 << m_engines.size()] = "ObjectsSearch API";
-	m_engines.insert(Engine("ObjectsSearch API", "objectssearchapi", "", "Web Services"));
-	m_engineChannels.insert("Web Services");
+	m_engines.insert(Engine("ObjectsSearch API", "objectssearchapi", "", "The Web"));
+	m_engineChannels.insert("The Web");
 #endif
 	m_engineIds[1 << m_engines.size()] = "Xapian";
 	m_engines.insert(Engine("Xapian", "xapian", "", ""));



From fabricecolin at berlios.de  Tue May  2 17:16:12 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 2 May 2006 17:16:12 +0200
Subject: [Pinot-svn] r226 - trunk/UI/GTK2/src
Message-ID: <200605021516.k42FGCnj028684@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-02 17:16:11 +0200 (Tue, 02 May 2006)
New Revision: 226

Modified:
   trunk/UI/GTK2/src/EnginesTree.cpp
   trunk/UI/GTK2/src/EnginesTree.h
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/PinotSettings.h
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/pinot.cc
Log:
Load and save channels whose group is collapsed in the engines tree.


Modified: trunk/UI/GTK2/src/EnginesTree.cpp
===================================================================
--- trunk/UI/GTK2/src/EnginesTree.cpp	2006-05-02 13:00:24 UTC (rev 225)
+++ trunk/UI/GTK2/src/EnginesTree.cpp	2006-05-02 15:16:11 UTC (rev 226)
@@ -99,6 +99,32 @@
 {
 }
 
+void EnginesTree::save(void)
+{
+	std::map<string, bool> &channels = m_settings.getSearchEnginesChannels();
+
+	TreeModel::Children children = m_refStore->children();
+	for (TreeModel::Children::iterator iter = children.begin(); iter != children.end(); ++iter)
+	{
+		TreeModel::Row row = *iter;
+
+		if (row[m_enginesColumns.m_type] == EnginesModelColumns::ENGINE_FOLDER)
+		{
+			ustring channelName(row[m_enginesColumns.m_name]);
+			TreeModel::Path path = m_refStore->get_path(iter);
+
+			std::map<string, bool>::iterator channelIter = channels.find(from_utf8(channelName));
+			if (channelIter != channels.end())
+			{
+#ifdef DEBUG
+				cout << "EnginesTree::save: " << channelName << " is " << row_expanded(path) << endl;
+#endif
+				channelIter->second = row_expanded(path);
+			}
+		}
+	}
+}
+
 void EnginesTree::renderEngineIcon(Gtk::CellRenderer *renderer, const Gtk::TreeModel::iterator &iter)
 {
 	TreeModel::Row row = *iter;
@@ -231,11 +257,12 @@
 	m_refStore->clear();
 
 	// Populate the tree with search engines
-	const set<string> &channels = m_settings.getSearchEnginesChannels();
-	for (set<string>::const_iterator channelIter = channels.begin();
+	std::map<string, bool> &channels = m_settings.getSearchEnginesChannels();
+	for (std::map<string, bool>::const_iterator channelIter = channels.begin();
 		channelIter != channels.end(); ++channelIter)
 	{
-		string channelName = *channelIter;
+		string channelName(channelIter->first);
+		bool isExpanded(channelIter->second);
 
 		// Enumerate search engines for this channel
 		engines.clear();
@@ -254,7 +281,6 @@
 		row[m_enginesColumns.m_option] = "";
 		row[m_enginesColumns.m_type] = EnginesModelColumns::ENGINE_FOLDER;
 
-		// FIXME: for some reason, without "std::"'s the compiler fails with a parse error before the comma
 		std::set<PinotSettings::Engine>::const_iterator engineIter = engines.begin();
 		for (; engineIter != engines.end(); ++engineIter)
 		{
@@ -283,6 +309,18 @@
 			}
 			row[m_enginesColumns.m_type] = EnginesModelColumns::WEB_ENGINE;
 		}
+
+		TreeModel::Path folderPath = m_refStore->get_path(folderIter);
+		if (isExpanded == true)
+		{
+			// Expand this
+			expand_row(folderPath, true);
+		}
+		else
+		{
+			// Collapse this
+			collapse_row(folderPath);
+		}
 	}
 
 	// Local engines
@@ -293,7 +331,6 @@
 	row[m_enginesColumns.m_option] = "";
 	row[m_enginesColumns.m_type] = EnginesModelColumns::ENGINE_FOLDER;
 
-	// FIXME: for some reason, without "std::"'s the compiler fails with a parse error before the comma
 	std::map<std::string, std::string>::const_iterator indexIter = m_settings.getIndexes().begin();
 	for (; indexIter != m_settings.getIndexes().end(); ++indexIter)
 	{
@@ -317,9 +354,10 @@
 		row[m_enginesColumns.m_type] = indexType;
 	}
 
+	// Expand this
+	expand_row(m_refStore->get_path(localIter), true);
+
 	get_selection()->select(localIter);
-
-	expand_all();
 }
 
 //

Modified: trunk/UI/GTK2/src/EnginesTree.h
===================================================================
--- trunk/UI/GTK2/src/EnginesTree.h	2006-05-02 13:00:24 UTC (rev 225)
+++ trunk/UI/GTK2/src/EnginesTree.h	2006-05-02 15:16:11 UTC (rev 226)
@@ -59,6 +59,9 @@
 		/// Clear the tree.
 		void clear(void);
 
+		/// Save the tree's state.
+		void save(void);
+
 		/// Returns the index edit signal.
 		SigC::Signal2<void, std::string, std::string>& getEditIndexSignal(void);
 

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2006-05-02 13:00:24 UTC (rev 225)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2006-05-02 15:16:11 UTC (rev 226)
@@ -178,16 +178,19 @@
 	return "";
 }
 
-bool PinotSettings::load(void)
+bool PinotSettings::load(bool reload)
 {
-	// Clear lists
-	m_indexNames.clear();
-	m_indexIds.clear();
-	m_engines.clear();
-	m_engineIds.clear();
-	m_queries.clear();
-	m_labels.clear();
-	m_mailAccounts.clear();
+	if (reload == true)
+	{
+		// Clear lists
+		m_indexNames.clear();
+		m_indexIds.clear();
+		m_engines.clear();
+		m_engineIds.clear();
+		m_queries.clear();
+		m_labels.clear();
+		m_mailAccounts.clear();
+	}
 
 	// Load the configuration file
 	string fileName = getConfigurationFileName();
@@ -212,12 +215,12 @@
 #ifdef HAS_GOOGLEAPI
 	m_engineIds[1 << m_engines.size()] = "Google API";
 	m_engines.insert(Engine("Google API", "googleapi", "", "The Web"));
-	m_engineChannels.insert("The Web");
+	m_engineChannels.insert(pair<string, bool>("The Web", true));
 #endif
 #ifdef HAS_OSAPI
 	m_engineIds[1 << m_engines.size()] = "ObjectsSearch API";
 	m_engines.insert(Engine("ObjectsSearch API", "objectssearchapi", "", "The Web"));
-	m_engineChannels.insert("The Web");
+	m_engineChannels.insert(pair<string, bool>("The Web", true));
 #endif
 	m_engineIds[1 << m_engines.size()] = "Xapian";
 	m_engines.insert(Engine("Xapian", "xapian", "", ""));
@@ -289,6 +292,10 @@
 				{
 					loadIndexes(pElem);
 				}
+				else if (nodeName == "channel")
+				{
+					loadEngineChannels(pElem);
+				}
 				else if (nodeName == "storedquery")
 				{
 					loadQueries(pElem);
@@ -438,6 +445,47 @@
 	return true;
 }
 
+bool PinotSettings::loadEngineChannels(const Element *pElem)
+{
+	if (pElem == NULL)
+	{
+		return false;
+	}
+
+	Node::NodeList childNodes = pElem->get_children();
+	if (childNodes.empty() == true)
+	{
+		return false;
+	}
+
+	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
+	{
+		Node *pNode = (*iter);
+		Element *pElem = dynamic_cast<Element*>(pNode);
+		if (pElem == NULL)
+		{
+			continue;
+		}
+
+		string nodeName = pElem->get_name();
+		string nodeContent = getElementContent(pElem);
+		if (nodeName == "name")
+		{
+			std::map<string, bool>::iterator channelIter = m_engineChannels.find(nodeContent);
+
+			if (channelIter != m_engineChannels.end())
+			{
+				channelIter->second = false;
+			}
+#ifdef DEBUG
+			cout << "PinotSettings::loadEngineChannels: " << nodeContent << " is collapsed" << endl;
+#endif
+		}
+	}
+
+	return true;
+}
+
 bool PinotSettings::loadQueries(const Element *pElem)
 {
 	if (pElem == NULL)
@@ -754,7 +802,7 @@
 						engineChannel = _("Unclassified");
 					}
 					m_engines.insert(Engine(engineName, "sherlock", location, engineChannel));
-					m_engineChannels.insert(engineChannel);
+					m_engineChannels.insert(pair<string, bool>(engineChannel, true));
 				}
 			}
 		}
@@ -817,6 +865,24 @@
 		addChildElement(pElem, "name", indexIter->first);
 		addChildElement(pElem, "location", indexIter->second);
 	}
+	// Engine channels
+	for (map<string, bool>::iterator channelIter = m_engineChannels.begin();
+		channelIter != m_engineChannels.end(); ++channelIter)
+	{
+		// Only save those whose group was collapsed
+		if (channelIter->second == false)
+		{
+#ifdef DEBUG
+			cout << "PinotSettings::save: " << channelIter->first << " is collapsed" << endl;
+#endif
+			pElem = pRootElem->add_child("channel");
+			if (pElem == NULL)
+			{
+				return false;
+			}
+			addChildElement(pElem, "name", channelIter->first);
+		}
+	}
 	// User-defined queries
 	for (map<string, QueryProperties>::iterator queryIter = m_queries.begin();
 		queryIter != m_queries.end(); ++queryIter)
@@ -827,7 +893,6 @@
 			return false;
 		}
 		addChildElement(pElem, "name", queryIter->first);
-		addChildElement(pElem, "type", "FIXED");
 		addChildElement(pElem, "and", queryIter->second.getAndWords());
 		addChildElement(pElem, "phrase", queryIter->second.getPhrase());
 		addChildElement(pElem, "any", queryIter->second.getAnyWords());
@@ -1088,7 +1153,7 @@
 }
 
 /// Returns the search engines channels.
-const set<string> &PinotSettings::getSearchEnginesChannels(void) const
+map<string, bool> &PinotSettings::getSearchEnginesChannels(void)
 {
 	return m_engineChannels;
 }

Modified: trunk/UI/GTK2/src/PinotSettings.h
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.h	2006-05-02 13:00:24 UTC (rev 225)
+++ trunk/UI/GTK2/src/PinotSettings.h	2006-05-02 15:16:11 UTC (rev 226)
@@ -41,7 +41,7 @@
 
 		static std::string getCurrentUserName(void);
 
-		bool load(void);
+		bool load(bool reload = false);
 
 		bool loadSearchEngines(const std::string &directoryName);
 
@@ -94,7 +94,7 @@
 		void getEngineNames(unsigned int id, std::set<std::string> &names);
 
 		/// Returns the search engines channels.
-		const std::set<std::string> &getSearchEnginesChannels(void) const;
+		std::map<std::string, bool> &getSearchEnginesChannels(void);
 
 		/// Returns the queries map, keyed by name.
 		const std::map<std::string, QueryProperties> &getQueries(void) const;
@@ -160,7 +160,7 @@
 		std::map<unsigned int, std::string> m_indexIds;
 		std::set<Engine> m_engines;
 		std::map<unsigned int, std::string> m_engineIds;
-		std::set<std::string> m_engineChannels;
+		std::map<std::string, bool> m_engineChannels;
 		std::map<std::string, QueryProperties> m_queries;
 		std::set<std::string> m_labels;
 
@@ -168,6 +168,7 @@
 		bool loadConfiguration(const std::string &fileName);
 		bool loadUi(const xmlpp::Element *pElem);
 		bool loadIndexes(const xmlpp::Element *pElem);
+		bool loadEngineChannels(const xmlpp::Element *pElem);
 		bool loadQueries(const xmlpp::Element *pElem);
 		bool loadResults(const xmlpp::Element *pElem);
 		bool loadLabels(const xmlpp::Element *pElem);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-05-02 13:00:24 UTC (rev 225)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-05-02 15:16:11 UTC (rev 226)
@@ -270,6 +270,9 @@
 //
 mainWindow::~mainWindow()
 {
+	// Save engines
+	m_pEnginesTree->save();
+
 	// Save queries
 	save_queryTreeview();
 

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2006-05-02 13:00:24 UTC (rev 225)
+++ trunk/UI/GTK2/src/pinot.cc	2006-05-02 15:16:11 UTC (rev 226)
@@ -130,13 +130,14 @@
 	Languages::setIntlName(10, _("Spanish"));
 	Languages::setIntlName(11, _("Swedish"));
 
-	// Load the settings
-	settings.load();
+	// Load search engines
 	settings.loadSearchEngines(prefixDir + string("/share/pinot/engines"));
 	settings.loadSearchEngines(confDirectory + string("/engines"));
 	// Load tokenizer libraries, if any
 	TokenizerFactory::loadTokenizers(prefixDir + string("/share/pinot/tokenizers"));
 	TokenizerFactory::loadTokenizers(confDirectory + string("/tokenizers"));
+	// Load the settings
+	settings.load();
 
 	// Catch interrupts
 	sigemptyset(&newAction.sa_mask);



From fabricecolin at berlios.de  Thu May  4 13:26:28 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 4 May 2006 13:26:28 +0200
Subject: [Pinot-svn] r227 - in trunk: . Collect Search UI/GTK2/src
Message-ID: <200605041126.k44BQS6Y017327@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-04 13:26:25 +0200 (Thu, 04 May 2006)
New Revision: 227

Added:
   trunk/Collect/pinot-collect.1
   trunk/Search/pinot-search.1
   trunk/UI/GTK2/src/pinot.1
Modified:
   trunk/Collect/dloadtest.cpp
   trunk/Makefile.am
   trunk/Search/senginetest.cpp
   trunk/UI/GTK2/src/pinot.cc
Log:
All programs support --help and --version. This helped to generate man pages
with help2man.


Modified: trunk/Collect/dloadtest.cpp
===================================================================
--- trunk/Collect/dloadtest.cpp	2006-05-02 15:16:11 UTC (rev 226)
+++ trunk/Collect/dloadtest.cpp	2006-05-04 11:26:25 UTC (rev 227)
@@ -14,6 +14,7 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include <getopt.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string>
@@ -22,14 +23,55 @@
 
 #include "Url.h"
 #include "DownloaderFactory.h"
+#include "config.h"
 
 using namespace std;
 
+static struct option g_longOptions[] = {
+	{"help", 0, 0, 'h'},
+	{"version", 0, 0, 'v'},
+	{0, 0, 0, 0}
+};
+
 int main(int argc, char **argv)
 {
+	int longOptionIndex = 0;
+
+	// Look at the options
+	int optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+	while (optionChar != -1)
+	{
+		switch (optionChar)
+		{
+			case 'h':
+				// Help
+				cout << "pinot-collect - Download an URL from the command-line\n\n"
+					<< "Usage: pinot-collect [OPTIONS] URL\n\n"
+					<< "Options:\n"
+					<< "  -h, --help		display this help and exit\n"
+					<< "  -v, --version		output version information and exit\n"
+					<< "\nExamples:\n"
+					<< "  pinot-collect http://some.website.com/\n"
+					<< "  pinot-collect xapian:///home/fabrice/.pinot/index/1\n"
+					<< "\nReport bugs to " << PACKAGE_BUGREPORT << endl;
+				return EXIT_SUCCESS;
+			case 'v':
+				cout << "pinot-collect - " << PACKAGE_STRING << "\n\n"
+					<< "This is free software.  You may redistribute copies of it under the terms of\n"
+					<< "the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.\n"
+					<< "There is NO WARRANTY, to the extent permitted by law." << endl;
+				return EXIT_SUCCESS;
+			default:
+				return EXIT_FAILURE;
+		}
+
+		// Next option
+		optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+	}
+
 	if (argc < 2)
 	{
-		cerr << "Usage: " << argv[0] << " <URL>" << endl;
+		cerr << "Not enough parameters" << endl;
 		return EXIT_FAILURE;
 	}
 

Added: trunk/Collect/pinot-collect.1
===================================================================
--- trunk/Collect/pinot-collect.1	2006-05-02 15:16:11 UTC (rev 226)
+++ trunk/Collect/pinot-collect.1	2006-05-04 11:26:25 UTC (rev 227)
@@ -0,0 +1,26 @@
+.\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
+.TH PINOT-COLLECT "1" "May 2006" "pinot-collect - pinot 0.46" "User Commands"
+.SH NAME
+pinot-collect \- Download an URL from the command-line
+.SH SYNOPSIS
+.B pinot-collect
+[\fIOPTIONS\fR] \fIURL\fR
+.SH DESCRIPTION
+pinot\-collect \- Download an URL from the command\-line
+.SH OPTIONS
+.TP
+\fB\-h\fR, \fB\-\-help\fR
+display this help and exit
+.TP
+\fB\-v\fR, \fB\-\-version\fR
+output version information and exit
+.SH EXAMPLES
+.IP
+pinot\-collect http://some.website.com/
+pinot\-collect xapian:///home/fabrice/.pinot/index/1
+.SH "REPORTING BUGS"
+Report bugs to fabricecolin at users.berlios.de
+.PP
+This is free software.  You may redistribute copies of it under the terms of
+the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.
+There is NO WARRANTY, to the extent permitted by law.

Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2006-05-02 15:16:11 UTC (rev 226)
+++ trunk/Makefile.am	2006-05-04 11:26:25 UTC (rev 227)
@@ -5,10 +5,13 @@
 	Index UI/RenderHTML UI/GTK2/src
 
 EXTRA_DIST = ChangeLog NEWS README TODO mkinstalldirs pinot.desktop \
-	pinot.spec Search/Plugins/*src Search/Plugins/*.xml \
+	pinot.spec textcat_conf.txt Search/Plugins/*src Search/Plugins/*.xml \
+	Collect/pinot-collect.1 Search/pinot-search.1 UI/GTK2/src/pinot.1 \
 	UI/GTK2/index.html UI/GTK2/xapian-powered.png UI/GTK2/pinot.png \
-	textcat_conf.txt UI/GTK2/metase-gtk2.glade UI/GTK2/metase-gtk2.gladep
+	UI/GTK2/metase-gtk2.glade UI/GTK2/metase-gtk2.gladep
 
+man_MANS = Collect/pinot-collect.1 Search/pinot-search.1 UI/GTK2/src/pinot.1
+
 install-data-local:
 	$(mkinstalldirs) $(DESTDIR)$(datadir)/pinot
 	$(INSTALL_DATA) UI/GTK2/index.html $(DESTDIR)$(datadir)/pinot/index.html

Added: trunk/Search/pinot-search.1
===================================================================
--- trunk/Search/pinot-search.1	2006-05-02 15:16:11 UTC (rev 226)
+++ trunk/Search/pinot-search.1	2006-05-04 11:26:25 UTC (rev 227)
@@ -0,0 +1,31 @@
+.\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
+.TH PINOT-SEARCH "1" "May 2006" "pinot-search - pinot 0.46" "User Commands"
+.SH NAME
+pinot-search \- Query search engines from the command-line
+.SH SYNOPSIS
+.B pinot-search
+[\fIOPTIONS\fR] \fISEARCHENGINETYPE SEARCHENGINENAME|SEARCHENGINEOPTION QUERYSTRING MAXRESULTSCOUNT\fR
+.SH DESCRIPTION
+pinot\-search \- Query search engines from the command\-line
+.SH OPTIONS
+.TP
+\fB\-h\fR, \fB\-\-help\fR
+display this help and exit
+.TP
+\fB\-v\fR, \fB\-\-version\fR
+output version information and exit
+.PP
+Supported search engine types are googleapi opensearch sherlock xapian
+.SH EXAMPLES
+.IP
+pinot\-search googleapi mygoogleapikey "clowns" 10
+pinot\-search opensearch /usr/share/pinot/engines/KrustyDescription.xml "clowns" 10
+pinot\-search sherlock /usr/share/pinot/engines/Bozo.src "clowns" 10
+pinot\-search xapian ~/.pinot/index "clowns" 10
+pinot\-search xapian somehostname:12345 "clowns" 10
+.SH "REPORTING BUGS"
+Report bugs to fabricecolin at users.berlios.de
+.PP
+This is free software.  You may redistribute copies of it under the terms of
+the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.
+There is NO WARRANTY, to the extent permitted by law.

Modified: trunk/Search/senginetest.cpp
===================================================================
--- trunk/Search/senginetest.cpp	2006-05-02 15:16:11 UTC (rev 226)
+++ trunk/Search/senginetest.cpp	2006-05-04 11:26:25 UTC (rev 227)
@@ -14,6 +14,7 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include <getopt.h>
 #include <cstdlib>
 #include <cstdio>
 #include <iostream>
@@ -28,25 +29,65 @@
 
 using namespace std;
 
+static struct option g_longOptions[] = {
+	{"help", 0, 0, 'h'},
+	{"version", 0, 0, 'v'},
+	{0, 0, 0, 0}
+};
+
 int main(int argc, char **argv)
 {
 	string type, option;
+	int longOptionIndex = 0;
 
-	if (argc < 5)
+	// Look at the options
+	int optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+	while (optionChar != -1)
 	{
 		set<string> engines;
 
-		cerr << "Usage: " << argv[0] << " <search engine type> <name>|<key> <query string> <max results count>" << endl;
-		cerr << "Example: " << argv[0] << " sherlock " << PREFIX << "/share/pinot/engines/Bozo.src \"clowns\" 10" << endl;
-
-		SearchEngineFactory::getSupportedEngines(engines);
-		cerr << "Supported search engine types:";
-		for (set<string>::iterator engineIter = engines.begin(); engineIter != engines.end(); ++engineIter)
+		switch (optionChar)
 		{
-			cerr << " " << *engineIter;
+			case 'h':
+				// Help
+				SearchEngineFactory::getSupportedEngines(engines);
+				cout << "pinot-search - Query search engines from the command-line\n\n"
+					<< "Usage: pinot-search [OPTIONS] SEARCHENGINETYPE SEARCHENGINENAME|SEARCHENGINEOPTION QUERYSTRING MAXRESULTSCOUNT\n\n"
+					<< "Options:\n"
+					<< "  -h, --help		display this help and exit\n"
+					<< "  -v, --version		output version information and exit\n\n"
+					<< "Supported search engine types are";
+				for (set<string>::iterator engineIter = engines.begin(); engineIter != engines.end(); ++engineIter)
+				{
+					cout << " " << *engineIter;
+				}
+				cout << "\n\nExamples:\n"
+#ifdef HAS_GOOGLEAPI
+					<< "  pinot-search googleapi mygoogleapikey \"clowns\" 10\n"
+#endif
+					<< "  pinot-search opensearch " << PREFIX << "/share/pinot/engines/KrustyDescription.xml \"clowns\" 10\n"
+					<< "  pinot-search sherlock " << PREFIX << "/share/pinot/engines/Bozo.src \"clowns\" 10\n"
+					<< "  pinot-search xapian ~/.pinot/index \"clowns\" 10\n"
+					<< "  pinot-search xapian somehostname:12345 \"clowns\" 10\n\n"
+					<< "Report bugs to " << PACKAGE_BUGREPORT << endl;
+				return EXIT_SUCCESS;
+			case 'v':
+				cout << "pinot-search - " << PACKAGE_STRING << "\n\n"
+					<< "This is free software.  You may redistribute copies of it under the terms of\n"
+					<< "the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.\n"
+					<< "There is NO WARRANTY, to the extent permitted by law." << endl;
+				return EXIT_SUCCESS;
+			default:
+				return EXIT_FAILURE;
 		}
-		cerr << endl;
 
+		// Next option
+		optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+	}
+
+	if (argc < 5)
+	{
+		cerr << "Not enough parameters" << endl;
 		return EXIT_FAILURE;
 	}
 

Added: trunk/UI/GTK2/src/pinot.1
===================================================================
--- trunk/UI/GTK2/src/pinot.1	2006-05-02 15:16:11 UTC (rev 226)
+++ trunk/UI/GTK2/src/pinot.1	2006-05-04 11:26:25 UTC (rev 227)
@@ -0,0 +1,22 @@
+.\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
+.TH PINOT "1" "May 2006" "pinot - pinot 0.46" "User Commands"
+.SH NAME
+pinot \- A metasearch tool for the Free Desktop
+.SH SYNOPSIS
+.B pinot
+[\fIOPTIONS\fR]
+.SH DESCRIPTION
+pinot \- A metasearch tool for the Free Desktop
+.SH OPTIONS
+.TP
+\fB\-h\fR, \fB\-\-help\fR
+display this help and exit
+.TP
+\fB\-v\fR, \fB\-\-version\fR
+output version information and exit
+.SH "REPORTING BUGS"
+Report bugs to fabricecolin at users.berlios.de
+.PP
+This is free software.  You may redistribute copies of it under the terms of
+the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.
+There is NO WARRANTY, to the extent permitted by law.

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2006-05-02 15:16:11 UTC (rev 226)
+++ trunk/UI/GTK2/src/pinot.cc	2006-05-04 11:26:25 UTC (rev 227)
@@ -18,6 +18,7 @@
 #include <signal.h>
 #include <unistd.h>
 #include <libintl.h>
+#include <getopt.h>
 #include <iostream>
 #include <fstream>
 #include <glibmm.h>
@@ -44,6 +45,11 @@
 static ofstream outputFile;
 static streambuf *coutBuf = NULL;
 static streambuf *cerrBuf = NULL;
+static struct option g_longOptions[] = {
+	{"help", 0, 0, 'h'},
+	{"version", 0, 0, 'v'},
+	{0, 0, 0, 0}
+};
 
 static void closeAll(void)
 {
@@ -89,7 +95,37 @@
 	string prefixDir(PREFIX);
 	Glib::ustring errorMsg;
 	struct sigaction newAction;
+	int longOptionIndex = 0;
 
+	// Look at the options
+	int optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+	while (optionChar != -1)
+	{
+		switch (optionChar)
+		{
+			case 'h':
+				// Help
+				cout << "pinot - A metasearch tool for the Free Desktop\n\n"
+					<< "Usage: pinot [OPTIONS]\n\n"
+					<< "Options:\n"
+					<< "  -h, --help		display this help and exit\n"
+					<< "  -v, --version		output version information and exit\n"
+					<< "\nReport bugs to " << PACKAGE_BUGREPORT << endl;
+				return EXIT_SUCCESS;
+			case 'v':
+				cout << "pinot - " << PACKAGE_STRING << "\n\n" 
+					<< "This is free software.  You may redistribute copies of it under the terms of\n"
+					<< "the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.\n"
+					<< "There is NO WARRANTY, to the extent permitted by law." << endl;
+				return EXIT_SUCCESS;
+			default:
+				return EXIT_FAILURE;
+		}
+
+		// Next option
+		optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+	}
+
 #if defined(ENABLE_NLS)
 	bindtextdomain(GETTEXT_PACKAGE, PACKAGE_LOCALE_DIR);
 	bind_textdomain_codeset(GETTEXT_PACKAGE, "UTF-8");



From fabricecolin at berlios.de  Fri May  5 12:42:57 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 5 May 2006 12:42:57 +0200
Subject: [Pinot-svn] r228 - in trunk: Collect Search
Message-ID: <200605051042.k45AgvKv003069@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-05 12:42:25 +0200 (Fri, 05 May 2006)
New Revision: 228

Added:
   trunk/Collect/pinot-collect.cpp
   trunk/Search/pinot-search.cpp
Removed:
   trunk/Collect/dloadtest.cpp
   trunk/Search/senginetest.cpp
Modified:
   trunk/Collect/Makefile.am
   trunk/Search/Makefile.am
   trunk/Search/pinot-search.1
Log:
Renamed source files, tidied up man page for pinot-search.


Modified: trunk/Collect/Makefile.am
===================================================================
--- trunk/Collect/Makefile.am	2006-05-04 11:26:25 UTC (rev 227)
+++ trunk/Collect/Makefile.am	2006-05-05 10:42:25 UTC (rev 228)
@@ -13,7 +13,7 @@
 bin_PROGRAMS = pinot-collect
 
 pinot_collect_SOURCES = \
-	dloadtest.cpp
+	pinot-collect.cpp
 
 pinot_collect_LDADD = -L../Utils -L../Tokenize \
 	-lCollect -lTokenize -lUtils \

Deleted: trunk/Collect/dloadtest.cpp
===================================================================
--- trunk/Collect/dloadtest.cpp	2006-05-04 11:26:25 UTC (rev 227)
+++ trunk/Collect/dloadtest.cpp	2006-05-05 10:42:25 UTC (rev 228)
@@ -1,143 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#include <getopt.h>
-#include <stdio.h>
-#include <stdlib.h>
-#include <string>
-#include <iostream>
-#include <fstream>
-
-#include "Url.h"
-#include "DownloaderFactory.h"
-#include "config.h"
-
-using namespace std;
-
-static struct option g_longOptions[] = {
-	{"help", 0, 0, 'h'},
-	{"version", 0, 0, 'v'},
-	{0, 0, 0, 0}
-};
-
-int main(int argc, char **argv)
-{
-	int longOptionIndex = 0;
-
-	// Look at the options
-	int optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
-	while (optionChar != -1)
-	{
-		switch (optionChar)
-		{
-			case 'h':
-				// Help
-				cout << "pinot-collect - Download an URL from the command-line\n\n"
-					<< "Usage: pinot-collect [OPTIONS] URL\n\n"
-					<< "Options:\n"
-					<< "  -h, --help		display this help and exit\n"
-					<< "  -v, --version		output version information and exit\n"
-					<< "\nExamples:\n"
-					<< "  pinot-collect http://some.website.com/\n"
-					<< "  pinot-collect xapian:///home/fabrice/.pinot/index/1\n"
-					<< "\nReport bugs to " << PACKAGE_BUGREPORT << endl;
-				return EXIT_SUCCESS;
-			case 'v':
-				cout << "pinot-collect - " << PACKAGE_STRING << "\n\n"
-					<< "This is free software.  You may redistribute copies of it under the terms of\n"
-					<< "the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.\n"
-					<< "There is NO WARRANTY, to the extent permitted by law." << endl;
-				return EXIT_SUCCESS;
-			default:
-				return EXIT_FAILURE;
-		}
-
-		// Next option
-		optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
-	}
-
-	if (argc < 2)
-	{
-		cerr << "Not enough parameters" << endl;
-		return EXIT_FAILURE;
-	}
-
-	DownloaderInterface::initialize();
-
-	string url(argv[1]);
-	Url thisUrl(url);
-	cout << "Protocol: " << thisUrl.getProtocol() << endl;
-	cout << "User: " << thisUrl.getUser() << endl;
-	cout << "Password: " << thisUrl.getPassword() << endl;
-	cout << "Host: " << thisUrl.getHost() << endl;
-	cout << "Location: " << thisUrl.getLocation() << endl;
-	cout << "File: " << thisUrl.getFile() << endl;
-	cout << "Parameters: " << thisUrl.getParameters() << endl;
-
-	// Which Downloader ?
-	DownloaderInterface *myDownloader = DownloaderFactory::getDownloader(thisUrl.getProtocol());
-	if (myDownloader == NULL)
-	{
-		DownloaderInterface::shutdown();
-		cerr << "Couldn't obtain downloader for protocol " << thisUrl.getProtocol() << endl;
-		return EXIT_FAILURE;
-	}
-
-	unsigned int urlContentLen;
-	string contentType;
-	DocumentInfo docInfo("Test", url, "", "");
-	Document *urlDoc = myDownloader->retrieveUrl(docInfo);
-	if (urlDoc == NULL)
-	{
-		cerr << "Download operation failed !" << endl;
-	}
-	else
-	{
-		cout << "Document type is " << urlDoc->getType() << endl;
-
-		unsigned int urlContentLen;
-		const char *urlContent = urlDoc->getData(urlContentLen);
-
-		if ((urlContent != NULL) &&
-			(urlContentLen > 0))
-		{
-			// Save the content to a file
-			string fileName = thisUrl.getFile();
-			if (fileName.empty() == true)
-			{
-				fileName = "index.html";
-			}
-
-			cout << "Saving " << urlContentLen << " bytes to " << fileName << endl;
-
-			ofstream outputFile(fileName.c_str());
-			outputFile.write(urlContent, urlContentLen);
-			outputFile.close();
-		}
-		else
-		{
-			cout << "Document is empty" << endl;
-		}
-
-		delete urlDoc;
-	}
-
-	delete myDownloader;
-
-	DownloaderInterface::shutdown();
-
-	return EXIT_SUCCESS;
-}

Copied: trunk/Collect/pinot-collect.cpp (from rev 227, trunk/Collect/dloadtest.cpp)

Modified: trunk/Search/Makefile.am
===================================================================
--- trunk/Search/Makefile.am	2006-05-04 11:26:25 UTC (rev 227)
+++ trunk/Search/Makefile.am	2006-05-05 10:42:25 UTC (rev 228)
@@ -39,7 +39,7 @@
 	SOAPEnvNS.cpp
 
 pinot_search_SOURCES = \
-	senginetest.cpp
+	pinot-search.cpp
 
 pinot_search_LDADD = -L../Utils -L../Tokenize -L../Collect -LGoogle \
 	@SEARCH_LIBS@ -lCollect -lTokenize -lUtils \

Modified: trunk/Search/pinot-search.1
===================================================================
--- trunk/Search/pinot-search.1	2006-05-04 11:26:25 UTC (rev 227)
+++ trunk/Search/pinot-search.1	2006-05-05 10:42:25 UTC (rev 228)
@@ -17,11 +17,14 @@
 .PP
 Supported search engine types are googleapi opensearch sherlock xapian
 .SH EXAMPLES
-.IP
 pinot\-search googleapi mygoogleapikey "clowns" 10
+.PP
 pinot\-search opensearch /usr/share/pinot/engines/KrustyDescription.xml "clowns" 10
+.PP
 pinot\-search sherlock /usr/share/pinot/engines/Bozo.src "clowns" 10
+.PP
 pinot\-search xapian ~/.pinot/index "clowns" 10
+.PP
 pinot\-search xapian somehostname:12345 "clowns" 10
 .SH "REPORTING BUGS"
 Report bugs to fabricecolin at users.berlios.de

Copied: trunk/Search/pinot-search.cpp (from rev 227, trunk/Search/senginetest.cpp)
===================================================================
--- trunk/Search/senginetest.cpp	2006-05-04 11:26:25 UTC (rev 227)
+++ trunk/Search/pinot-search.cpp	2006-05-05 10:42:25 UTC (rev 228)
@@ -0,0 +1,153 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <getopt.h>
+#include <cstdlib>
+#include <cstdio>
+#include <iostream>
+#include <string>
+#include <fstream>
+
+#include "SearchEngineFactory.h"
+#include "DownloaderFactory.h"
+#include "Url.h"
+#include "HtmlTokenizer.h"
+#include "config.h"
+
+using namespace std;
+
+static struct option g_longOptions[] = {
+	{"help", 0, 0, 'h'},
+	{"version", 0, 0, 'v'},
+	{0, 0, 0, 0}
+};
+
+int main(int argc, char **argv)
+{
+	string type, option;
+	int longOptionIndex = 0;
+
+	// Look at the options
+	int optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+	while (optionChar != -1)
+	{
+		set<string> engines;
+
+		switch (optionChar)
+		{
+			case 'h':
+				// Help
+				SearchEngineFactory::getSupportedEngines(engines);
+				cout << "pinot-search - Query search engines from the command-line\n\n"
+					<< "Usage: pinot-search [OPTIONS] SEARCHENGINETYPE SEARCHENGINENAME|SEARCHENGINEOPTION QUERYSTRING MAXRESULTSCOUNT\n\n"
+					<< "Options:\n"
+					<< "  -h, --help		display this help and exit\n"
+					<< "  -v, --version		output version information and exit\n\n"
+					<< "Supported search engine types are";
+				for (set<string>::iterator engineIter = engines.begin(); engineIter != engines.end(); ++engineIter)
+				{
+					cout << " " << *engineIter;
+				}
+				cout << "\n\nExamples:\n"
+#ifdef HAS_GOOGLEAPI
+					<< "pinot-search googleapi mygoogleapikey \"clowns\" 10\n\n"
+#endif
+					<< "pinot-search opensearch " << PREFIX << "/share/pinot/engines/KrustyDescription.xml \"clowns\" 10\n\n"
+					<< "pinot-search sherlock " << PREFIX << "/share/pinot/engines/Bozo.src \"clowns\" 10\n\n"
+					<< "pinot-search xapian ~/.pinot/index \"clowns\" 10\n\n"
+					<< "pinot-search xapian somehostname:12345 \"clowns\" 10\n\n\n"
+					<< "Report bugs to " << PACKAGE_BUGREPORT << endl;
+				return EXIT_SUCCESS;
+			case 'v':
+				cout << "pinot-search - " << PACKAGE_STRING << "\n\n"
+					<< "This is free software.  You may redistribute copies of it under the terms of\n"
+					<< "the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.\n"
+					<< "There is NO WARRANTY, to the extent permitted by law." << endl;
+				return EXIT_SUCCESS;
+			default:
+				return EXIT_FAILURE;
+		}
+
+		// Next option
+		optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+	}
+
+	if (argc < 5)
+	{
+		cerr << "Not enough parameters" << endl;
+		return EXIT_FAILURE;
+	}
+
+	// Which SearchEngine ?
+	type = argv[1];
+	option = argv[2];
+	SearchEngineInterface *myEngine = SearchEngineFactory::getSearchEngine(type, option);
+	if (myEngine == NULL)
+	{
+		cerr << "Couldn't obtain search engine instance" << endl;
+		return EXIT_FAILURE;
+	}
+
+	// How many results ?
+	unsigned int count = atoi(argv[4]);
+	myEngine->setMaxResultsCount(count);
+
+	QueryProperties queryProps("senginetest", argv[3], "", "", "");
+	if (myEngine->runQuery(queryProps) == true)
+	{
+		string resultsPage;
+
+		// Try getting a list of links
+		const vector<Result> resultsList = myEngine->getResults();
+		if (resultsList.empty() == false)
+		{
+			unsigned int count = 0;
+
+			cout << "Matching documents are :" << endl;
+
+			vector<Result>::const_iterator resultIter = resultsList.begin();
+			while (resultIter != resultsList.end())
+			{
+				string rawUrl = (*resultIter).getLocation();
+				Url thisUrl(rawUrl);
+
+				cout << count << " Raw URL  : '" << rawUrl << "'"<< endl;
+				cout << count << " Protocol : " << thisUrl.getProtocol() << endl;
+				cout << count << " Host     : " << thisUrl.getHost() << endl;
+				cout << count << " Location : " << thisUrl.getLocation() << "/" << thisUrl.getFile() << endl;
+				cout << count << " Title    : " << HtmlTokenizer::stripTags((*resultIter).getTitle()) << endl;
+				cout << count << " Extract  : " << HtmlTokenizer::stripTags((*resultIter).getExtract()) << endl;
+				cout << count << " Score    : " << (*resultIter).getScore() << endl;
+				count++;
+
+				// Next
+				resultIter++;
+			}
+		}
+		else
+		{
+			cerr << "Couldn't get a results list !" << endl;
+		}
+	}
+	else
+	{
+		cerr << "Couldn't run query on search engine " << argv[1] << endl;
+	}
+
+	delete myEngine;
+
+	return EXIT_SUCCESS;
+}

Deleted: trunk/Search/senginetest.cpp
===================================================================
--- trunk/Search/senginetest.cpp	2006-05-04 11:26:25 UTC (rev 227)
+++ trunk/Search/senginetest.cpp	2006-05-05 10:42:25 UTC (rev 228)
@@ -1,153 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#include <getopt.h>
-#include <cstdlib>
-#include <cstdio>
-#include <iostream>
-#include <string>
-#include <fstream>
-
-#include "SearchEngineFactory.h"
-#include "DownloaderFactory.h"
-#include "Url.h"
-#include "HtmlTokenizer.h"
-#include "config.h"
-
-using namespace std;
-
-static struct option g_longOptions[] = {
-	{"help", 0, 0, 'h'},
-	{"version", 0, 0, 'v'},
-	{0, 0, 0, 0}
-};
-
-int main(int argc, char **argv)
-{
-	string type, option;
-	int longOptionIndex = 0;
-
-	// Look at the options
-	int optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
-	while (optionChar != -1)
-	{
-		set<string> engines;
-
-		switch (optionChar)
-		{
-			case 'h':
-				// Help
-				SearchEngineFactory::getSupportedEngines(engines);
-				cout << "pinot-search - Query search engines from the command-line\n\n"
-					<< "Usage: pinot-search [OPTIONS] SEARCHENGINETYPE SEARCHENGINENAME|SEARCHENGINEOPTION QUERYSTRING MAXRESULTSCOUNT\n\n"
-					<< "Options:\n"
-					<< "  -h, --help		display this help and exit\n"
-					<< "  -v, --version		output version information and exit\n\n"
-					<< "Supported search engine types are";
-				for (set<string>::iterator engineIter = engines.begin(); engineIter != engines.end(); ++engineIter)
-				{
-					cout << " " << *engineIter;
-				}
-				cout << "\n\nExamples:\n"
-#ifdef HAS_GOOGLEAPI
-					<< "  pinot-search googleapi mygoogleapikey \"clowns\" 10\n"
-#endif
-					<< "  pinot-search opensearch " << PREFIX << "/share/pinot/engines/KrustyDescription.xml \"clowns\" 10\n"
-					<< "  pinot-search sherlock " << PREFIX << "/share/pinot/engines/Bozo.src \"clowns\" 10\n"
-					<< "  pinot-search xapian ~/.pinot/index \"clowns\" 10\n"
-					<< "  pinot-search xapian somehostname:12345 \"clowns\" 10\n\n"
-					<< "Report bugs to " << PACKAGE_BUGREPORT << endl;
-				return EXIT_SUCCESS;
-			case 'v':
-				cout << "pinot-search - " << PACKAGE_STRING << "\n\n"
-					<< "This is free software.  You may redistribute copies of it under the terms of\n"
-					<< "the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.\n"
-					<< "There is NO WARRANTY, to the extent permitted by law." << endl;
-				return EXIT_SUCCESS;
-			default:
-				return EXIT_FAILURE;
-		}
-
-		// Next option
-		optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
-	}
-
-	if (argc < 5)
-	{
-		cerr << "Not enough parameters" << endl;
-		return EXIT_FAILURE;
-	}
-
-	// Which SearchEngine ?
-	type = argv[1];
-	option = argv[2];
-	SearchEngineInterface *myEngine = SearchEngineFactory::getSearchEngine(type, option);
-	if (myEngine == NULL)
-	{
-		cerr << "Couldn't obtain search engine instance" << endl;
-		return EXIT_FAILURE;
-	}
-
-	// How many results ?
-	unsigned int count = atoi(argv[4]);
-	myEngine->setMaxResultsCount(count);
-
-	QueryProperties queryProps("senginetest", argv[3], "", "", "");
-	if (myEngine->runQuery(queryProps) == true)
-	{
-		string resultsPage;
-
-		// Try getting a list of links
-		const vector<Result> resultsList = myEngine->getResults();
-		if (resultsList.empty() == false)
-		{
-			unsigned int count = 0;
-
-			cout << "Matching documents are :" << endl;
-
-			vector<Result>::const_iterator resultIter = resultsList.begin();
-			while (resultIter != resultsList.end())
-			{
-				string rawUrl = (*resultIter).getLocation();
-				Url thisUrl(rawUrl);
-
-				cout << count << " Raw URL  : '" << rawUrl << "'"<< endl;
-				cout << count << " Protocol : " << thisUrl.getProtocol() << endl;
-				cout << count << " Host     : " << thisUrl.getHost() << endl;
-				cout << count << " Location : " << thisUrl.getLocation() << "/" << thisUrl.getFile() << endl;
-				cout << count << " Title    : " << HtmlTokenizer::stripTags((*resultIter).getTitle()) << endl;
-				cout << count << " Extract  : " << HtmlTokenizer::stripTags((*resultIter).getExtract()) << endl;
-				cout << count << " Score    : " << (*resultIter).getScore() << endl;
-				count++;
-
-				// Next
-				resultIter++;
-			}
-		}
-		else
-		{
-			cerr << "Couldn't get a results list !" << endl;
-		}
-	}
-	else
-	{
-		cerr << "Couldn't run query on search engine " << argv[1] << endl;
-	}
-
-	delete myEngine;
-
-	return EXIT_SUCCESS;
-}



From fabricecolin at berlios.de  Fri May  5 12:50:09 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 5 May 2006 12:50:09 +0200
Subject: [Pinot-svn] r229 - in trunk: Index UI/GTK2 UI/GTK2/src
Message-ID: <200605051050.k45Ao9ba009959@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-05 12:49:49 +0200 (Fri, 05 May 2006)
New Revision: 229

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/propertiesDialog.cc
   trunk/UI/GTK2/src/propertiesDialog.hh
   trunk/UI/GTK2/src/propertiesDialog_glade.cc
   trunk/UI/GTK2/src/propertiesDialog_glade.hh
Log:
Allow changing the language of documents in the properties dialog box.
A subsequent update would use the given language to stem terms.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-05-05 10:42:25 UTC (rev 228)
+++ trunk/Index/XapianIndex.cpp	2006-05-05 10:49:49 UTC (rev 229)
@@ -709,12 +709,11 @@
 		{
 			Xapian::Document doc = pIndex->get_document(docId);
 
-			// Get the current document data
-			string record = doc.get_data();
-			string language = StringManip::extractField(record, "language=", "");
-
+#ifdef DEBUG
+			cout << "XapianIndex::updateDocumentInfo: language is " << docInfo.getLanguage() << endl;
+#endif
 			// Update the document data with the current language
-			setDocumentData(doc, docInfo, language);
+			setDocumentData(doc, docInfo, docInfo.getLanguage());
 			pIndex->replace_document(docId, doc);
 			updated = true;
 		}

Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-05-05 10:42:25 UTC (rev 228)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-05-05 10:49:49 UTC (rev 229)
@@ -2710,7 +2710,7 @@
 	  <child>
 	    <widget class="GtkTable" id="propertiesTable">
 	      <property name="visible">True</property>
-	      <property name="n_rows">4</property>
+	      <property name="n_rows">3</property>
 	      <property name="n_columns">2</property>
 	      <property name="homogeneous">False</property>
 	      <property name="row_spacing">0</property>
@@ -2741,48 +2741,6 @@
 	      </child>
 
 	      <child>
-		<widget class="GtkScrolledWindow" id="extractScrolledwindow">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="hscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
-		  <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
-		  <property name="shadow_type">GTK_SHADOW_IN</property>
-		  <property name="window_placement">GTK_CORNER_TOP_LEFT</property>
-
-		  <child>
-		    <widget class="GtkTextView" id="extractTextview">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="can_focus">True</property>
-		      <property name="editable">True</property>
-		      <property name="overwrite">False</property>
-		      <property name="accepts_tab">True</property>
-		      <property name="justification">GTK_JUSTIFY_LEFT</property>
-		      <property name="wrap_mode">GTK_WRAP_NONE</property>
-		      <property name="cursor_visible">True</property>
-		      <property name="pixels_above_lines">0</property>
-		      <property name="pixels_below_lines">0</property>
-		      <property name="pixels_inside_wrap">0</property>
-		      <property name="left_margin">3</property>
-		      <property name="right_margin">0</property>
-		      <property name="indent">0</property>
-		      <property name="text" translatable="yes"></property>
-		    </widget>
-		  </child>
-		</widget>
-		<packing>
-		  <property name="left_attach">1</property>
-		  <property name="right_attach">2</property>
-		  <property name="top_attach">1</property>
-		  <property name="bottom_attach">2</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
 		<widget class="GtkLabel" id="titleLabel">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
@@ -2812,10 +2770,10 @@
 	      </child>
 
 	      <child>
-		<widget class="GtkLabel" id="extractLabel">
+		<widget class="GtkLabel" id="languageLabel">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">Extract:</property>
+		  <property name="label" translatable="yes">Language:</property>
 		  <property name="use_underline">False</property>
 		  <property name="use_markup">False</property>
 		  <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -2841,10 +2799,10 @@
 	      </child>
 
 	      <child>
-		<widget class="GtkLabel" id="languageLabel">
+		<widget class="GtkLabel" id="typeLabel">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">Language:</property>
+		  <property name="label" translatable="yes">MIME type:</property>
 		  <property name="use_underline">False</property>
 		  <property name="use_markup">False</property>
 		  <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -2870,7 +2828,7 @@
 	      </child>
 
 	      <child>
-		<widget class="GtkEntry" id="languageEntry">
+		<widget class="GtkEntry" id="typeEntry">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
 		  <property name="can_focus">True</property>
@@ -2894,52 +2852,17 @@
 	      </child>
 
 	      <child>
-		<widget class="GtkLabel" id="typeLabel">
+		<widget class="GtkComboBox" id="languageCombobox">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">MIME type:</property>
-		  <property name="use_underline">False</property>
-		  <property name="use_markup">False</property>
-		  <property name="justify">GTK_JUSTIFY_LEFT</property>
-		  <property name="wrap">False</property>
-		  <property name="selectable">False</property>
-		  <property name="xalign">0</property>
-		  <property name="yalign">0.5</property>
-		  <property name="xpad">4</property>
-		  <property name="ypad">4</property>
-		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-		  <property name="width_chars">-1</property>
-		  <property name="single_line_mode">False</property>
-		  <property name="angle">0</property>
+		  <property name="add_tearoffs">False</property>
+		  <property name="focus_on_click">True</property>
 		</widget>
 		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">3</property>
-		  <property name="bottom_attach">4</property>
-		  <property name="x_options">fill</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkEntry" id="typeEntry">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="editable">False</property>
-		  <property name="visibility">True</property>
-		  <property name="max_length">0</property>
-		  <property name="text" translatable="yes"></property>
-		  <property name="has_frame">True</property>
-		  <property name="invisible_char">*</property>
-		  <property name="activates_default">False</property>
-		</widget>
-		<packing>
 		  <property name="left_attach">1</property>
 		  <property name="right_attach">2</property>
-		  <property name="top_attach">3</property>
-		  <property name="bottom_attach">4</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
 		  <property name="x_padding">4</property>
 		  <property name="y_padding">4</property>
 		  <property name="y_options">fill</property>

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-05-05 10:42:25 UTC (rev 228)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-05-05 10:49:49 UTC (rev 229)
@@ -1901,11 +1901,18 @@
 	if ((documentsList.size() == 1) &&
 		(docId > 0))
 	{
-		// Did the title change ?
+		// Did the title or language change ?
 		string newTitle = propertiesBox.getDocumentInfo().getTitle();
-		if (newTitle != docInfo.getTitle())
+		string newLanguage = propertiesBox.getDocumentInfo().getLanguage();
+		if ((newTitle != docInfo.getTitle()) ||
+			(newLanguage != docInfo.getLanguage()))
 		{
 			docInfo.setTitle(newTitle);
+			docInfo.setLanguage(newLanguage);
+#ifdef DEBUG
+			cout << "mainWindow::on_showfromindex_activate: properties changed to "
+				<< newTitle << ", " << newLanguage << endl;
+#endif
 			
 			// Update the document
 			start_thread(new UpdateDocumentThread(indexName, docId, docInfo));

Modified: trunk/UI/GTK2/src/propertiesDialog.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.cc	2006-05-05 10:42:25 UTC (rev 228)
+++ trunk/UI/GTK2/src/propertiesDialog.cc	2006-05-05 10:49:49 UTC (rev 229)
@@ -18,6 +18,7 @@
 #include <utility>
 
 #include "config.h"
+#include "Languages.h"
 #include "NLS.h"
 #include "PinotSettings.h"
 #include "PinotUtils.h"
@@ -33,6 +34,11 @@
 	m_editDocument(editDocument),
 	m_docInfo(docInfo)
 {
+	// Associate the columns model to the language combo
+	m_refLanguageTree = ListStore::create(m_languageColumns);
+	languageCombobox->set_model(m_refLanguageTree);
+	languageCombobox->pack_start(m_languageColumns.m_name);
+
 	// Associate the columns model to the labels tree
 	m_refLabelsTree = ListStore::create(m_labelsColumns);
 	labelsTreeview->set_model(m_refLabelsTree);
@@ -43,14 +49,8 @@
 
 	if (m_editDocument == true)
 	{
-		ustring language = to_utf8(docInfo.getLanguage());
-
 		titleEntry->set_text(to_utf8(docInfo.getTitle()));
-		if (language.empty() == true)
-		{
-			language = _("Unknown");
-		}
-		languageEntry->set_text(language);
+		populate_languageCombobox(docInfo.getLanguage());
 		typeEntry->set_text(to_utf8(docInfo.getType()));
 	}
 	else
@@ -58,13 +58,10 @@
 		titleLabel->hide();
 		titleEntry->hide();
 		languageLabel->hide();
-		languageEntry->hide();
+		languageCombobox->hide();
 		typeLabel->hide();
 		typeEntry->hide();
 	}
-	// FIXME: get the extract
-	extractLabel->hide();
-	extractScrolledwindow->hide();
 
 	populate_labelsTreeview(docLabels);
 }
@@ -73,6 +70,37 @@
 {
 }
 
+void propertiesDialog::populate_languageCombobox(string language)
+{
+	TreeModel::iterator iter;
+	TreeModel::Row row;
+	unsigned int languageStart = 0;
+
+	if (language.empty() == true)
+	{
+		iter = m_refLanguageTree->append();
+		row = *iter;
+
+		row[m_languageColumns.m_name] = _("Unknown");
+		languageCombobox->set_active(0);
+		languageStart = 1;
+	}
+
+	// Add all supported languages
+	for (unsigned int languageNum = 0; languageNum < Languages::m_count; ++languageNum)
+	{
+		string languageName = Languages::getIntlName(languageNum);
+		iter = m_refLanguageTree->append();
+		row = *iter;
+		row[m_languageColumns.m_name] = languageName;
+
+		if (languageName == language)
+		{
+			languageCombobox->set_active(languageNum + languageStart);
+		}
+	}
+}
+
 void propertiesDialog::populate_labelsTreeview(const set<string> &docLabels)
 {
 	TreeModel::iterator iter;
@@ -136,8 +164,24 @@
 {
 	if (m_editDocument == true)
 	{
+		unsigned int languageStart = 0;
+
 		// Title
 		m_docInfo.setTitle(from_utf8(titleEntry->get_text()));
+
+		// Language
+		if (m_docInfo.getLanguage().empty() == true)
+		{
+			languageStart = 1;
+		}
+		int chosenLanguage = languageCombobox->get_active_row_number();
+		if (chosenLanguage < Languages::m_count + languageStart)
+		{
+			if (chosenLanguage > 0)
+			{
+				m_docInfo.setLanguage(Languages::getIntlName(chosenLanguage - languageStart));
+			}
+		}
 	}
 	// Go through the labels tree
 	TreeModel::Children children = m_refLabelsTree->children();

Modified: trunk/UI/GTK2/src/propertiesDialog.hh
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.hh	2006-05-05 10:42:25 UTC (rev 228)
+++ trunk/UI/GTK2/src/propertiesDialog.hh	2006-05-05 10:49:49 UTC (rev 229)
@@ -40,12 +40,16 @@
 	const std::set<std::string> &getLabels(void) const;
 
 protected:
+	ComboModelColumns m_languageColumns;
+	Glib::RefPtr<Gtk::ListStore> m_refLanguageTree;
 	LabelModelColumns m_labelsColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refLabelsTree;
 	std::set<std::string> m_labels;
 	bool m_editDocument;
 	DocumentInfo m_docInfo;
 
+	void populate_languageCombobox(std::string language);
+
 	void populate_labelsTreeview(const std::set<std::string> &docLabels);
 
 	void on_labelOkButton_clicked();

Modified: trunk/UI/GTK2/src/propertiesDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-05-05 10:42:25 UTC (rev 228)
+++ trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-05-05 10:49:49 UTC (rev 229)
@@ -1,9 +1,9 @@
-// generated 2006/1/5 9:17:19 SGT by fabrice at thorgrim.dyndns.org.(none)
-// using glademm V2.6.0
+// generated 2006/5/5 15:18:57 SGT by fabrice at amra.dyndns.org.(none)
+// using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.6.10 and gtkmm 2.6.2
+// glade-- metase-gtk2.glade
+// for gtk 2.8.17 and gtkmm 2.8.3
 //
 // Please modify the corresponding derived classes in ./src/propertiesDialog.cc
 
@@ -25,18 +25,11 @@
 #  else
 #    define N_(String) (String)
 #  endif
-#else
-#  define textdomain(String) (String)
-#  define gettext(String) (String)
-#  define dgettext(Domain,Message) (Message)
-#  define dcgettext(Domain,Message,Type) (Message)
-#  define bindtextdomain(Domain,Directory) (Domain)
-#  define _(String) (String)
-#  define N_(String) (String)
 #endif
 #include <gtkmmconfig.h>
 #if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
 #include <sigc++/compatibility.h>
+#include <sigc++/bind.h>
 #define GMM_GTKMM_22_24(a,b) b
 #else //gtkmm 2.2
 #define GMM_GTKMM_22_24(a,b) a
@@ -50,7 +43,17 @@
 #include <gtkmm/viewport.h>
 #include <gtkmm/adjustment.h>
 #include <gtkmm/box.h>
+#ifndef ENABLE_NLS
+#  define textdomain(String) (String)
+#  define gettext(String) (String)
+#  define dgettext(Domain,Message) (Message)
+#  define dcgettext(Domain,Message,Type) (Message)
+#  define bindtextdomain(Domain,Directory) (Domain)
+#  define _(String) (String)
+#  define N_(String) (String)
+#endif
 
+
 propertiesDialog_glade::propertiesDialog_glade(
 )
 {  propertiesDialog = this;
@@ -59,14 +62,11 @@
    Gtk::Button *cancelbutton2 = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-cancel")));
    labelOkButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-ok")));
    titleEntry = Gtk::manage(new class Gtk::Entry());
-   extractTextview = Gtk::manage(new class Gtk::TextView());
-   extractScrolledwindow = Gtk::manage(new class Gtk::ScrolledWindow());
    titleLabel = Gtk::manage(new class Gtk::Label(_("Title:")));
-   extractLabel = Gtk::manage(new class Gtk::Label(_("Extract:")));
    languageLabel = Gtk::manage(new class Gtk::Label(_("Language:")));
-   languageEntry = Gtk::manage(new class Gtk::Entry());
    typeLabel = Gtk::manage(new class Gtk::Label(_("MIME type:")));
    typeEntry = Gtk::manage(new class Gtk::Entry());
+   languageCombobox = Gtk::manage(new class Gtk::ComboBox());
    
    Gtk::Table *propertiesTable = Gtk::manage(new class Gtk::Table(2, 2, false));
    labelsTreeview = Gtk::manage(new class Gtk::TreeView());
@@ -86,48 +86,21 @@
    titleEntry->set_visibility(true);
    titleEntry->set_editable(true);
    titleEntry->set_max_length(0);
+   titleEntry->set_text("");
    titleEntry->set_has_frame(true);
    titleEntry->set_activates_default(false);
-   extractTextview->set_flags(Gtk::CAN_FOCUS);
-   extractTextview->set_editable(true);
-   extractTextview->set_cursor_visible(true);
-   extractTextview->set_pixels_above_lines(0);
-   extractTextview->set_pixels_below_lines(0);
-   extractTextview->set_pixels_inside_wrap(0);
-   extractTextview->set_left_margin(3);
-   extractTextview->set_right_margin(0);
-   extractTextview->set_indent(0);
-   extractTextview->set_wrap_mode(Gtk::WRAP_NONE);
-   extractTextview->set_justification(Gtk::JUSTIFY_LEFT);
-   extractScrolledwindow->set_flags(Gtk::CAN_FOCUS);
-   extractScrolledwindow->set_shadow_type(Gtk::SHADOW_IN);
-   extractScrolledwindow->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
-   extractScrolledwindow->property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
-   extractScrolledwindow->add(*extractTextview);
    titleLabel->set_alignment(0,0.5);
    titleLabel->set_padding(4,4);
    titleLabel->set_justify(Gtk::JUSTIFY_LEFT);
    titleLabel->set_line_wrap(false);
    titleLabel->set_use_markup(false);
    titleLabel->set_selectable(false);
-   extractLabel->set_alignment(0,0.5);
-   extractLabel->set_padding(4,4);
-   extractLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   extractLabel->set_line_wrap(false);
-   extractLabel->set_use_markup(false);
-   extractLabel->set_selectable(false);
    languageLabel->set_alignment(0,0.5);
    languageLabel->set_padding(4,4);
    languageLabel->set_justify(Gtk::JUSTIFY_LEFT);
    languageLabel->set_line_wrap(false);
    languageLabel->set_use_markup(false);
    languageLabel->set_selectable(false);
-   languageEntry->set_flags(Gtk::CAN_FOCUS);
-   languageEntry->set_visibility(true);
-   languageEntry->set_editable(false);
-   languageEntry->set_max_length(0);
-   languageEntry->set_has_frame(true);
-   languageEntry->set_activates_default(false);
    typeLabel->set_alignment(0,0.5);
    typeLabel->set_padding(4,4);
    typeLabel->set_justify(Gtk::JUSTIFY_LEFT);
@@ -138,23 +111,27 @@
    typeEntry->set_visibility(true);
    typeEntry->set_editable(false);
    typeEntry->set_max_length(0);
+   typeEntry->set_text("");
    typeEntry->set_has_frame(true);
    typeEntry->set_activates_default(false);
    propertiesTable->set_row_spacings(0);
    propertiesTable->set_col_spacings(0);
    propertiesTable->attach(*titleEntry, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   propertiesTable->attach(*extractScrolledwindow, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    propertiesTable->attach(*titleLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 0, 0);
-   propertiesTable->attach(*extractLabel, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 0, 0);
-   propertiesTable->attach(*languageLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 0, 0);
-   propertiesTable->attach(*languageEntry, 1, 2, 2, 3, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   propertiesTable->attach(*typeLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 0, 0);
-   propertiesTable->attach(*typeEntry, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   propertiesTable->attach(*languageLabel, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 0, 0);
+   propertiesTable->attach(*typeLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 0, 0);
+   propertiesTable->attach(*typeEntry, 1, 2, 2, 3, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   propertiesTable->attach(*languageCombobox, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    labelsTreeview->set_flags(Gtk::CAN_FOCUS);
    labelsTreeview->set_headers_visible(true);
    labelsTreeview->set_rules_hint(false);
    labelsTreeview->set_reorderable(false);
    labelsTreeview->set_enable_search(true);
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=5
+   labelsTreeview->set_fixed_height_mode(false);
+   labelsTreeview->set_hover_selection(false);
+   labelsTreeview->set_hover_expand(false);
+#endif //
    viewport1->set_shadow_type(Gtk::SHADOW_IN);
    viewport1->add(*labelsTreeview);
    labelsScrolledwindow->set_flags(Gtk::CAN_FOCUS);
@@ -179,14 +156,11 @@
    cancelbutton2->show();
    labelOkButton->show();
    titleEntry->show();
-   extractTextview->show();
-   extractScrolledwindow->show();
    titleLabel->show();
-   extractLabel->show();
    languageLabel->show();
-   languageEntry->show();
    typeLabel->show();
    typeEntry->show();
+   languageCombobox->show();
    propertiesTable->show();
    labelsTreeview->show();
    viewport1->show();

Modified: trunk/UI/GTK2/src/propertiesDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog_glade.hh	2006-05-05 10:42:25 UTC (rev 228)
+++ trunk/UI/GTK2/src/propertiesDialog_glade.hh	2006-05-05 10:49:49 UTC (rev 229)
@@ -1,9 +1,9 @@
-// generated 2005/11/26 18:15:06 SGT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0
+// generated 2006/5/5 15:18:57 SGT by fabrice at amra.dyndns.org.(none)
+// using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.6.10 and gtkmm 2.6.2
+// glade-- metase-gtk2.glade
+// for gtk 2.8.17 and gtkmm 2.8.3
 //
 // Please modify the corresponding derived classes in ./src/propertiesDialog.hh and./src/propertiesDialog.cc
 
@@ -34,10 +34,10 @@
 #include <gtkmm/dialog.h>
 #include <gtkmm/button.h>
 #include <gtkmm/entry.h>
-#include <gtkmm/textview.h>
-#include <gtkmm/scrolledwindow.h>
 #include <gtkmm/label.h>
+#include <gtkmm/combobox.h>
 #include <gtkmm/treeview.h>
+#include <gtkmm/scrolledwindow.h>
 
 class propertiesDialog_glade : public Gtk::Dialog
 {  
@@ -48,14 +48,11 @@
 protected:
         class Gtk::Button * labelOkButton;
         class Gtk::Entry * titleEntry;
-        class Gtk::TextView * extractTextview;
-        class Gtk::ScrolledWindow * extractScrolledwindow;
         class Gtk::Label * titleLabel;
-        class Gtk::Label * extractLabel;
         class Gtk::Label * languageLabel;
-        class Gtk::Entry * languageEntry;
         class Gtk::Label * typeLabel;
         class Gtk::Entry * typeEntry;
+        class Gtk::ComboBox * languageCombobox;
         class Gtk::TreeView * labelsTreeview;
         class Gtk::ScrolledWindow * labelsScrolledwindow;
         



From fabricecolin at berlios.de  Fri May  5 12:52:11 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 5 May 2006 12:52:11 +0200
Subject: [Pinot-svn] r230 - trunk
Message-ID: <200605051052.k45AqBIs011337@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-05 12:52:09 +0200 (Fri, 05 May 2006)
New Revision: 230

Modified:
   trunk/pinot.spec.in
Log:
Bundle man pages.


Modified: trunk/pinot.spec.in
===================================================================
--- trunk/pinot.spec.in	2006-05-05 10:49:49 UTC (rev 229)
+++ trunk/pinot.spec.in	2006-05-05 10:52:09 UTC (rev 230)
@@ -102,6 +102,9 @@
 %{_datadir}/locale/es/LC_MESSAGES/pinot.mo
 %{_datadir}/icons/hicolor/48x48/apps/pinot.png
 %{_datadir}/applications/Amra-pinot.desktop
+%{_mandir}/man1/pinot.*
+%ghost %{_mandir}/man1/pinot-collect.*
+%{_mandir}/man1/pinot-search.*
 
 %files text-docs 
 %defattr(-, root, root, -)



From fabricecolin at berlios.de  Sat May  6 05:24:27 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 6 May 2006 05:24:27 +0200
Subject: [Pinot-svn] r231 - trunk/Search/Google
Message-ID: <200605060324.k463ORWX003253@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-06 05:24:24 +0200 (Sat, 06 May 2006)
New Revision: 231

Modified:
   trunk/Search/Google/GoogleAPIEngine.cpp
Log:
Don't be picky about query parameters, invoke GoogleSearch correctly.


Modified: trunk/Search/Google/GoogleAPIEngine.cpp
===================================================================
--- trunk/Search/Google/GoogleAPIEngine.cpp	2006-05-05 10:52:09 UTC (rev 230)
+++ trunk/Search/Google/GoogleAPIEngine.cpp	2006-05-06 03:24:24 UTC (rev 231)
@@ -84,8 +84,7 @@
 /// Runs a query; true if success.
 bool GoogleAPIEngine::runQuery(QueryProperties& queryProps)
 {
-	string andTerms = queryProps.getAndWords();
-	string phrase = queryProps.getPhrase();
+	string queryString = queryProps.toString(false);
 
 	setHostNameFilter(queryProps.getHostFilter());
 	setFileNameFilter(queryProps.getFileFilter());
@@ -98,24 +97,23 @@
 		return false;
 	}
 
-	// FIXME: find out how m_notWords and m_anyWords could be used
-	if (andTerms.empty() == true)
+	if (queryString.empty() == true)
 	{
-		if (phrase.empty() == true)
-		{
-			return false;
-		}
-		// Use the phrase as search terms then...
-		andTerms = phrase;
-		phrase = "";
+#ifdef DEBUG
+		cout << "GoogleAPIEngine::runQuery: query is empty" << endl;
+#endif
+		return false;
 	}
+#ifdef DEBUG
+	cout << "GoogleAPIEngine::runQuery: query is " << queryString << endl;
+#endif
 
 	GoogleSearchBinding soapProxy;
 	struct gapi1__doGoogleSearchResponse queryOut;
 
 	// No filter, no safe search
-	int soapStatus = soapProxy.gapi1__doGoogleSearch(m_key, andTerms, 0, (int)(m_maxResultsCount > 10 ? 10 : m_maxResultsCount),
-		((phrase.empty() == false) ? true : false), phrase, false, "", "utf-8", "utf-8", queryOut);
+	int soapStatus = soapProxy.gapi1__doGoogleSearch(m_key, queryString, 0, (int)(m_maxResultsCount > 10 ? 10 : m_maxResultsCount),
+		false, "", false, "", "utf-8", "utf-8", queryOut);
 	if (soapStatus != SOAP_OK)
 	{
 #ifdef DEBUG



From fabricecolin at berlios.de  Sat May  6 05:25:26 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 6 May 2006 05:25:26 +0200
Subject: [Pinot-svn] r232 - trunk/UI/GTK2/src
Message-ID: <200605060325.k463PQF5006468@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-06 05:25:23 +0200 (Sat, 06 May 2006)
New Revision: 232

Modified:
   trunk/UI/GTK2/src/propertiesDialog_glade.cc
Log:
Removed evil set_text("") !


Modified: trunk/UI/GTK2/src/propertiesDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-05-06 03:24:24 UTC (rev 231)
+++ trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-05-06 03:25:23 UTC (rev 232)
@@ -86,7 +86,6 @@
    titleEntry->set_visibility(true);
    titleEntry->set_editable(true);
    titleEntry->set_max_length(0);
-   titleEntry->set_text("");
    titleEntry->set_has_frame(true);
    titleEntry->set_activates_default(false);
    titleLabel->set_alignment(0,0.5);
@@ -111,7 +110,6 @@
    typeEntry->set_visibility(true);
    typeEntry->set_editable(false);
    typeEntry->set_max_length(0);
-   typeEntry->set_text("");
    typeEntry->set_has_frame(true);
    typeEntry->set_activates_default(false);
    propertiesTable->set_row_spacings(0);



From fabricecolin at berlios.de  Sat May  6 08:50:16 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 6 May 2006 08:50:16 +0200
Subject: [Pinot-svn] r233 - in trunk: Search UI/GTK2/src
Message-ID: <200605060650.k466oGfc014083@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-06 08:50:11 +0200 (Sat, 06 May 2006)
New Revision: 233

Modified:
   trunk/Search/QueryProperties.cpp
   trunk/Search/QueryProperties.h
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/mainWindow.cc
Log:
QueryProperties::getTerms() returns the terms that make up the query. This is
used by ResultsPage to determine what parts of the extract field should be
shown in bold text.
Some other minor changes.


Modified: trunk/Search/QueryProperties.cpp
===================================================================
--- trunk/Search/QueryProperties.cpp	2006-05-06 03:25:23 UTC (rev 232)
+++ trunk/Search/QueryProperties.cpp	2006-05-06 06:50:11 UTC (rev 233)
@@ -17,7 +17,9 @@
 #include <iostream>
 #include <algorithm>
 
+#include "Document.h"
 #include "Languages.h"
+#include "Tokenizer.h"
 #include "QueryProperties.h"
 
 QueryProperties::QueryProperties()
@@ -239,6 +241,24 @@
 	return m_labelName;
 }
 
+/// Returns the query's terms.
+void QueryProperties::getTerms(set<string> &terms) const
+{
+	Document doc;
+	string termsString(m_andWords + m_phrase + m_anyWords + m_notWords);
+
+	doc.setData(termsString.c_str(), termsString.length());
+	Tokenizer tokens(&doc);
+
+	terms.clear();
+
+	string token;
+	while (tokens.nextToken(token) == true)
+	{
+		terms.insert(token);
+	}
+}
+
 /// Returns a displayable representation of this query's properties.
 string QueryProperties::toString(bool forPresentation) const
 {

Modified: trunk/Search/QueryProperties.h
===================================================================
--- trunk/Search/QueryProperties.h	2006-05-06 03:25:23 UTC (rev 232)
+++ trunk/Search/QueryProperties.h	2006-05-06 06:50:11 UTC (rev 233)
@@ -18,6 +18,7 @@
 #define _QUERY_PROPERTIES_H
 
 #include <string>
+#include <set>
 
 #include "Result.h"
 
@@ -95,7 +96,10 @@
 		/// Gets the name of the label to use for indexed documents.
 		string getLabelName(void) const;
 
-		/// Returns a displayable representation of this query's properties.
+		/// Returns the query's terms.
+		void getTerms(std::set<std::string> &terms) const;
+
+		/// Returns a string representation of this query's properties.
 		string toString(bool forPresentation = true) const;
 
 	protected:

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-06 03:25:23 UTC (rev 232)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-06 06:50:11 UTC (rev 233)
@@ -24,6 +24,7 @@
 #include <gtkmm/textbuffer.h>
 
 #include "HtmlTokenizer.h"
+#include "StringManip.h"
 #include "Url.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
@@ -40,10 +41,10 @@
 using namespace Gdk;
 using namespace Gtk;
 
-ResultsTree::ResultsTree(const ustring &queryName, Menu *pPopupMenu,
+ResultsTree::ResultsTree(const QueryProperties &queryProps, Menu *pPopupMenu,
 	PinotSettings &settings) :
 	TreeView(),
-	m_queryName(queryName),
+	m_queryProps(queryProps),
 	m_pPopupMenu(pPopupMenu),
 	m_pResultsScrolledwindow(NULL),
 	m_settings(settings),
@@ -88,6 +89,11 @@
 	m_pExtractScrolledwindow->property_window_placement().set_value(CORNER_TOP_LEFT);
 	m_pExtractScrolledwindow->add(*m_extractTextview);
 
+	// Create a blod text tag to highlight extract terms with
+	RefPtr<TextBuffer> refBuffer = m_extractTextview->get_buffer();
+	RefPtr<TextBuffer::Tag> refBoldTag = refBuffer->create_tag("bold-text");
+	refBoldTag->property_weight() = Pango::WEIGHT_BOLD;
+
 	// Associate the columns model to the results tree
 	m_refStore = TreeStore::create(m_resultsColumns);
 	set_model(m_refStore);
@@ -146,6 +152,9 @@
 	m_upIconPixbuf = render_icon(Stock::GO_UP, ICON_SIZE_MENU, "MetaSE-pinot");
 	m_downIconPixbuf = render_icon(Stock::GO_DOWN, ICON_SIZE_MENU, "MetaSE-pinot");
 
+	// Get the query's terms now, we'll need them later
+	m_queryProps.getTerms(m_queryTerms);
+
 	// Show all
 	show();
 	m_pResultsScrolledwindow->show();
@@ -302,7 +311,7 @@
 
 void ResultsTree::onSelectionChanged(void)
 {
-	m_signalSelectionChanged(m_queryName);
+	m_signalSelectionChanged(m_queryProps.getName());
 }
 
 bool ResultsTree::onSearchEqual(const RefPtr<TreeModel>& model, int column,
@@ -338,7 +347,7 @@
 			set<string> engineNames, indexNames;
 			string extract;
 
-			// m_queryName and row[m_resultsColumns.m_queryName] should be equal
+			// The query name and row[m_resultsColumns.m_queryName] should be equal
 			string url = from_utf8(row[m_resultsColumns.m_url]);
 			unsigned int engineIds = row[m_resultsColumns.m_engines];
 			unsigned int indexIds = row[m_resultsColumns.m_indexes];
@@ -373,11 +382,26 @@
 #ifdef DEBUG
 				cout << "ResultsTree::onSelectionSelect: first engine for " << url << " was " << engineName << endl;
 #endif
-				extract = history.getItemExtract(from_utf8(m_queryName), engineName, url);
+				extract = history.getItemExtract(from_utf8(m_queryProps.getName()), engineName, url);
 			}
 
 			RefPtr<TextBuffer> refBuffer = m_extractTextview->get_buffer();
 			refBuffer->set_text(to_utf8(extract));
+
+			// Highlight the query's terms in the extract
+			string lowerExtract(StringManip::toLowerCase(extract));
+			for (set<string>::iterator termIter = m_queryTerms.begin();
+				termIter != m_queryTerms.end(); ++termIter)
+			{
+				string::size_type pos = lowerExtract.find(StringManip::toLowerCase(*termIter));
+				if (pos != string::npos)
+				{
+					// Apply the tag
+					refBuffer->apply_tag_by_name("bold-text", refBuffer->get_iter_at_offset(pos),
+						refBuffer->get_iter_at_offset(pos + termIter->length()));
+				}
+			}
+
 			// The extract is not editable
 			m_extractTextview->set_editable(false);
 			m_extractTextview->set_cursor_visible(false);
@@ -423,14 +447,13 @@
 	const vector<Result> &resultsList, const string &charset, bool groupBySearchEngine)
 {
 	std::map<string, TreeModel::iterator> updatedGroups;
-	string registeredEngineName = engineName;
+	string registeredEngineName(engineName);
+	string queryName(queryProps.getName());
+	string language(queryProps.getLanguage());
+	string labelName(queryProps.getLabelName());
 	unsigned int count = 0;
 	ResultsModelColumns::ResultType rootType;
 
-	string queryName = queryProps.getName();
-	string language = queryProps.getLanguage();
-	string labelName = queryProps.getLabelName();
-
 	// Unselect all
 	get_selection()->unselect_all();
 
@@ -484,9 +507,9 @@
 	for (vector<Result>::const_iterator resultIter = resultsList.begin();
 		resultIter != resultsList.end(); ++resultIter)
 	{
-		string title = resultIter->getTitle();
-		string location = resultIter->getLocation();
-		string extract = resultIter->getExtract();
+		string title(resultIter->getTitle());
+		string location(resultIter->getLocation());
+		string extract(resultIter->getExtract());
 		float currentScore = resultIter->getScore();
 		string score;
 		int rankDiff = 0;

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2006-05-06 03:25:23 UTC (rev 232)
+++ trunk/UI/GTK2/src/ResultsTree.h	2006-05-06 06:50:11 UTC (rev 233)
@@ -41,7 +41,7 @@
 class ResultsTree : public Gtk::TreeView
 {
 	public:
-		ResultsTree(const Glib::ustring &queryName, Gtk::Menu *pPopupMenu,
+		ResultsTree(const QueryProperties &queryProps, Gtk::Menu *pPopupMenu,
 			PinotSettings &settings);
 		virtual ~ResultsTree();
 
@@ -93,7 +93,7 @@
 		SigC::Signal1<void, Glib::ustring>& getSelectionChangedSignal(void);
 
 	protected:
-		Glib::ustring m_queryName;
+		QueryProperties m_queryProps;
 		Gtk::Menu *m_pPopupMenu;
 		Gtk::ScrolledWindow *m_pResultsScrolledwindow;
 		Glib::RefPtr<Gtk::TreeStore> m_refStore;
@@ -109,6 +109,7 @@
 		Gtk::TextView *m_extractTextview;
 		std::set<std::string> m_indexNames;
 		bool m_showExtract;
+		std::set<std::string> m_queryTerms;
 
 		void renderViewStatus(Gtk::CellRenderer *renderer, const Gtk::TreeModel::iterator &iter);
 

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-06 03:25:23 UTC (rev 232)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-06 06:50:11 UTC (rev 233)
@@ -543,8 +543,9 @@
 		for (vector<Result>::const_iterator resultIter = resultsList.begin();
 			resultIter != resultsList.end(); ++resultIter)
 		{
-			string title = _("No title");
-			string extract = HtmlTokenizer::stripTags(resultIter->getExtract());
+			string title(_("No title"));
+			string extract(HtmlTokenizer::stripTags(resultIter->getExtract()));
+			string language(resultIter->getLanguage());
 
 			// The title may contain formatting
 			if (resultIter->getTitle().empty() == false)
@@ -552,10 +553,9 @@
 				title = HtmlTokenizer::stripTags(resultIter->getTitle());
 			}
 
-			string language = resultIter->getLanguage();
+			// Use the query's language if the result's is unknown
 			if (language.empty() == true)
 			{
-				// Use the query's language
 				language = m_queryProps.getLanguage();
 			}
 

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-05-06 03:25:23 UTC (rev 232)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-05-06 06:50:11 UTC (rev 233)
@@ -888,7 +888,7 @@
 				SigC::slot(*this, &mainWindow::on_close_page));
 
 			// Position the results tree
-			pResultsTree = manage(new ResultsTree(queryName, resultsMenuitem->get_submenu(), m_settings));
+			pResultsTree = manage(new ResultsTree(queryProps, resultsMenuitem->get_submenu(), m_settings));
 			pResultsPage = manage(new ResultsPage(queryName, pResultsTree, m_pNotebook->get_height(), m_settings));
 			// Connect to the "changed" signal
 			pResultsTree->getSelectionChangedSignal().connect(



From fabricecolin at berlios.de  Sat May  6 08:51:35 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 6 May 2006 08:51:35 +0200
Subject: [Pinot-svn] r234 - trunk
Message-ID: <200605060651.k466pZrk014595@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-06 08:51:32 +0200 (Sat, 06 May 2006)
New Revision: 234

Modified:
   trunk/pinot.spec.in
Log:
Do a DEBUG build if "--with debug" is passed to rpmbuild.


Modified: trunk/pinot.spec.in
===================================================================
--- trunk/pinot.spec.in	2006-05-06 06:50:11 UTC (rev 233)
+++ trunk/pinot.spec.in	2006-05-06 06:51:32 UTC (rev 234)
@@ -56,7 +56,7 @@
 
 %build
 %configure %{?_with_soap:--with-soap=yes}
-make
+make %{?_with_debug:CXXFLAGS="-g -DDEBUG"}
 
 %install
 [ -n "$RPM_BUILD_ROOT" -a "$RPM_BUILD_ROOT" != / ] && rm -rf $RPM_BUILD_ROOT



From fabricecolin at berlios.de  Sat May  6 13:28:08 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 6 May 2006 13:28:08 +0200
Subject: [Pinot-svn] r235 - trunk
Message-ID: <200605061128.k46BS8mM023750@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-06 13:28:03 +0200 (Sat, 06 May 2006)
New Revision: 235

Modified:
   trunk/NEWS
   trunk/TODO
Log:
Updated NEWS with changes since last release, added more items to TODO list.


Modified: trunk/NEWS
===================================================================
--- trunk/NEWS	2006-05-06 06:51:32 UTC (rev 234)
+++ trunk/NEWS	2006-05-06 11:28:03 UTC (rev 235)
@@ -1,3 +1,15 @@
+??? version_0_4_7
+General :
+ - all programs have man pages and support --help and --version
+Search :
+ - the Google API engine is no longer unnecessarily picky about queries parameters
+UI :
+ - merged channel Web Services with The Web
+ - the state of engine channels tree is saved and restored
+ - query terms are highlighted in the extract field
+ - allow editing the language of documents. A subsequent update would use the
+  given language to stem terms.
+
 2006/03/22 version_0_4_6
 Search :
  - resurrected support for the Google API, enabled with "./configure --with-soap=yes".

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2006-05-06 06:51:32 UTC (rev 234)
+++ trunk/TODO	2006-05-06 11:28:03 UTC (rev 235)
@@ -8,6 +8,10 @@
 - Change .spec to allow building with Google and ObjectsSearch SOAP APIs support
 - Don't use system(), fork and exec, especially for the external browser
 - Find out how to determine what application to use for a given MIME type and drop internal browser
+  Does xdgmime allow to consult the applications/types mappings in /usr/share/applications/defaults.list
+  and mimeinfo.cache ?
+- MIMEScanner should also return parent types so that we don't filter out types unnecessarily
+- Make sure everything works with URLs/path names that include spaces or unusual characters
 
 Search
 - Write a Spirit-based parser for extracting results from web pages
@@ -19,6 +23,7 @@
 - Implement AutoDiscovery of OpenSearch Description files (http://opensearch.a9.com/spec/1.1/description/)
 - Support for Google Buttons
 - Make sure Description files' SyndicationRight is not private or closed
+- Export search results as OpenSearch Response
 
 Collect
 - Comply with robot stuff defined at http://www.robotstxt.org/
@@ -44,6 +49,10 @@
 - Allow to monitor imported documents for changes
 - Flush after a properties update; not doing so seems to prevent abstract generation from working
  correctly, as terms positions can't be obtained
+- Xapian Query objects will become serializable at some point, this will be useful
+  for stored queries
+- Think about indexing archives (parent documents) and their contents (child documents)
+- Add a "more like this" menu to results from an index to get related documents
 
 Browser plugin
 - Write Firefox extension that searches Pinot indexes and indexes the cache
@@ -84,4 +93,8 @@
 - Closing when threads are running gives the impression Pinot has crashed; how do we tell the user
   we are waiting for something to finish ?
 - Try sizing the window optimally on the first startup
+- Use libnotify to show a popup when a new result is available ?
+- Replace labels with tags (Leaftag, http://www.chipx86.com/wiki/Leaftag)
+- Enable to import all the documents that match a specific tag
+- Double click on a word in the extract field adds it to the live query field
 



From fabricecolin at berlios.de  Sun May  7 07:50:09 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sun, 7 May 2006 07:50:09 +0200
Subject: [Pinot-svn] r236 - trunk/UI/GTK2/src
Message-ID: <200605070550.k475o9fX020393@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-07 07:49:52 +0200 (Sun, 07 May 2006)
New Revision: 236

Modified:
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Update the query terms list on addResults() as it may change from one run to
the next.
When unindexing documents, "remove" is better suited than "delete".


Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-06 11:28:03 UTC (rev 235)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-07 05:49:52 UTC (rev 236)
@@ -41,10 +41,10 @@
 using namespace Gdk;
 using namespace Gtk;
 
-ResultsTree::ResultsTree(const QueryProperties &queryProps, Menu *pPopupMenu,
+ResultsTree::ResultsTree(const ustring &queryName, Menu *pPopupMenu,
 	PinotSettings &settings) :
 	TreeView(),
-	m_queryProps(queryProps),
+	m_queryName(queryName),
 	m_pPopupMenu(pPopupMenu),
 	m_pResultsScrolledwindow(NULL),
 	m_settings(settings),
@@ -152,9 +152,6 @@
 	m_upIconPixbuf = render_icon(Stock::GO_UP, ICON_SIZE_MENU, "MetaSE-pinot");
 	m_downIconPixbuf = render_icon(Stock::GO_DOWN, ICON_SIZE_MENU, "MetaSE-pinot");
 
-	// Get the query's terms now, we'll need them later
-	m_queryProps.getTerms(m_queryTerms);
-
 	// Show all
 	show();
 	m_pResultsScrolledwindow->show();
@@ -311,7 +308,7 @@
 
 void ResultsTree::onSelectionChanged(void)
 {
-	m_signalSelectionChanged(m_queryProps.getName());
+	m_signalSelectionChanged(m_queryName);
 }
 
 bool ResultsTree::onSearchEqual(const RefPtr<TreeModel>& model, int column,
@@ -382,7 +379,7 @@
 #ifdef DEBUG
 				cout << "ResultsTree::onSelectionSelect: first engine for " << url << " was " << engineName << endl;
 #endif
-				extract = history.getItemExtract(from_utf8(m_queryProps.getName()), engineName, url);
+				extract = history.getItemExtract(from_utf8(m_queryName), engineName, url);
 			}
 
 			RefPtr<TextBuffer> refBuffer = m_extractTextview->get_buffer();
@@ -454,6 +451,9 @@
 	unsigned int count = 0;
 	ResultsModelColumns::ResultType rootType;
 
+	// Get this query's terms
+	queryProps.getTerms(m_queryTerms);
+
 	// Unselect all
 	get_selection()->unselect_all();
 

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2006-05-06 11:28:03 UTC (rev 235)
+++ trunk/UI/GTK2/src/ResultsTree.h	2006-05-07 05:49:52 UTC (rev 236)
@@ -41,7 +41,7 @@
 class ResultsTree : public Gtk::TreeView
 {
 	public:
-		ResultsTree(const QueryProperties &queryProps, Gtk::Menu *pPopupMenu,
+		ResultsTree(const Glib::ustring &queryName, Gtk::Menu *pPopupMenu,
 			PinotSettings &settings);
 		virtual ~ResultsTree();
 
@@ -93,7 +93,7 @@
 		SigC::Signal1<void, Glib::ustring>& getSelectionChangedSignal(void);
 
 	protected:
-		QueryProperties m_queryProps;
+		Glib::ustring m_queryName;
 		Gtk::Menu *m_pPopupMenu;
 		Gtk::ScrolledWindow *m_pResultsScrolledwindow;
 		Glib::RefPtr<Gtk::TreeStore> m_refStore;

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-05-06 11:28:03 UTC (rev 235)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-05-07 05:49:52 UTC (rev 236)
@@ -888,7 +888,7 @@
 				SigC::slot(*this, &mainWindow::on_close_page));
 
 			// Position the results tree
-			pResultsTree = manage(new ResultsTree(queryProps, resultsMenuitem->get_submenu(), m_settings));
+			pResultsTree = manage(new ResultsTree(queryName, resultsMenuitem->get_submenu(), m_settings));
 			pResultsPage = manage(new ResultsPage(queryName, pResultsTree, m_pNotebook->get_height(), m_settings));
 			// Connect to the "changed" signal
 			pResultsTree->getSelectionChangedSignal().connect(
@@ -1935,7 +1935,7 @@
 void mainWindow::on_unindex_activate()
 {
 	vector<IndexedDocument> documentsList;
-	ustring boxTitle = _("Delete this document from the index ?");
+	ustring boxTitle = _("Remove this document from the index ?");
 
 	IndexTree *pIndexTree = NULL;
 	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_current_page());
@@ -1954,7 +1954,7 @@
 
 	if (documentsList.size() > 1)
 	{
-		boxTitle = _("Delete these documents from the index ?");
+		boxTitle = _("Remove these documents from the index ?");
 	}
 
 	// Ask for confirmation



From fabricecolin at berlios.de  Sun May  7 07:54:39 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sun, 7 May 2006 07:54:39 +0200
Subject: [Pinot-svn] r237 - trunk/po
Message-ID: <200605070554.k475sdMK021071@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-07 07:54:30 +0200 (Sun, 07 May 2006)
New Revision: 237

Modified:
   trunk/po/es.po
   trunk/po/fr.po
Log:
Updated translations.


Modified: trunk/po/es.po
===================================================================
--- trunk/po/es.po	2006-05-07 05:49:52 UTC (rev 236)
+++ trunk/po/es.po	2006-05-07 05:54:30 UTC (rev 237)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.43\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-04-18 23:23+0800\n"
+"POT-Creation-Date: 2006-05-07 13:59+0800\n"
 "PO-Revision-Date: 2006-01-30 16:44+0800\n"
 "Last-Translator: Jes?s Tramullas <jesus at tramullas.com>\n"
 "Language-Team: es <jesus at tramullas.com>\n"
@@ -20,23 +20,23 @@
 msgid "Search Engines"
 msgstr "Motores de b?squeda"
 
-#: UI/GTK2/src/EnginesTree.cpp:291
+#: UI/GTK2/src/EnginesTree.cpp:329
 msgid "Current User"
 msgstr "Usuario"
 
-#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:372
-#: UI/GTK2/src/mainWindow.cc:375 UI/GTK2/src/mainWindow.cc:545
-#: UI/GTK2/src/mainWindow.cc:1010 UI/GTK2/src/mainWindow.cc:1066
-#: UI/GTK2/src/mainWindow.cc:1086 UI/GTK2/src/mainWindow.cc:1121
-#: UI/GTK2/src/mainWindow.cc:1711 UI/GTK2/src/PinotSettings.cpp:201
-#: UI/GTK2/src/PinotSettings.cpp:911 UI/GTK2/src/PinotSettings.cpp:967
+#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:375
+#: UI/GTK2/src/mainWindow.cc:378 UI/GTK2/src/mainWindow.cc:548
+#: UI/GTK2/src/mainWindow.cc:1013 UI/GTK2/src/mainWindow.cc:1069
+#: UI/GTK2/src/mainWindow.cc:1089 UI/GTK2/src/mainWindow.cc:1124
+#: UI/GTK2/src/mainWindow.cc:1714 UI/GTK2/src/PinotSettings.cpp:204
+#: UI/GTK2/src/PinotSettings.cpp:976 UI/GTK2/src/PinotSettings.cpp:1032
 msgid "My Documents"
 msgstr "Mis documentos"
 
-#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:378
-#: UI/GTK2/src/mainWindow.cc:381 UI/GTK2/src/mainWindow.cc:549
-#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:202
-#: UI/GTK2/src/PinotSettings.cpp:912 UI/GTK2/src/PinotSettings.cpp:968
+#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:381
+#: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:552
+#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:205
+#: UI/GTK2/src/PinotSettings.cpp:977 UI/GTK2/src/PinotSettings.cpp:1033
 #: UI/GTK2/src/prefsDialog_glade.cc:115
 msgid "My Email"
 msgstr "Mi email"
@@ -58,7 +58,7 @@
 msgstr "Directorio"
 
 #: UI/GTK2/src/importDialog.cc:142 UI/GTK2/src/IndexTree.cpp:69
-#: UI/GTK2/src/ResultsTree.cpp:122
+#: UI/GTK2/src/ResultsTree.cpp:128
 msgid "URL"
 msgstr "URL"
 
@@ -75,7 +75,7 @@
 msgstr "Localizaci?n:"
 
 #: UI/GTK2/src/importDialog_glade.cc:67
-#: UI/GTK2/src/propertiesDialog_glade.cc:64
+#: UI/GTK2/src/propertiesDialog_glade.cc:65
 msgid "Title:"
 msgstr "T?tulo:"
 
@@ -128,7 +128,7 @@
 msgid "External index"
 msgstr "?ndice externo"
 
-#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:113
+#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:119
 msgid "Title"
 msgstr "T?tulo"
 
@@ -172,200 +172,202 @@
 msgid "Ready"
 msgstr "Listo"
 
-#: UI/GTK2/src/mainWindow.cc:277 UI/GTK2/src/mainWindow.cc:967
-#: UI/GTK2/src/mainWindow.cc:1304 UI/GTK2/src/mainWindow.cc:2883
+#: UI/GTK2/src/mainWindow.cc:280 UI/GTK2/src/mainWindow.cc:970
+#: UI/GTK2/src/mainWindow.cc:1307 UI/GTK2/src/mainWindow.cc:2893
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr "Ver"
 
-#: UI/GTK2/src/mainWindow.cc:309
+#: UI/GTK2/src/mainWindow.cc:312
 msgid "N/A"
 msgstr "Desconocido"
 
-#: UI/GTK2/src/mainWindow.cc:319
+#: UI/GTK2/src/mainWindow.cc:322
 msgid "<undefined>"
 msgstr "<indefinido>"
 
-#: UI/GTK2/src/mainWindow.cc:507
+#: UI/GTK2/src/mainWindow.cc:510
 msgid "Result location is"
 msgstr "La localizaci?n del resultado es"
 
-#: UI/GTK2/src/mainWindow.cc:560
+#: UI/GTK2/src/mainWindow.cc:563
 msgid "Document location is"
 msgstr "La localizaci?n del documento es"
 
-#: UI/GTK2/src/mainWindow.cc:812
+#: UI/GTK2/src/mainWindow.cc:815
 msgid "Showing"
 msgstr "Mostrando"
 
-#: UI/GTK2/src/mainWindow.cc:817
+#: UI/GTK2/src/mainWindow.cc:820
 msgid "off"
 msgstr "desactivado"
 
-#: UI/GTK2/src/mainWindow.cc:822
+#: UI/GTK2/src/mainWindow.cc:825
 msgid "documents, starting at"
 msgstr "documentos comenzando en"
 
-#: UI/GTK2/src/mainWindow.cc:856
+#: UI/GTK2/src/mainWindow.cc:859
 msgid "Query"
 msgstr "B?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:860 UI/GTK2/src/mainWindow.cc:2711
+#: UI/GTK2/src/mainWindow.cc:863 UI/GTK2/src/mainWindow.cc:2721
 msgid "on"
 msgstr "en"
 
-#: UI/GTK2/src/mainWindow.cc:864
+#: UI/GTK2/src/mainWindow.cc:867
 msgid "ended"
 msgstr "finalizado"
 
-#: UI/GTK2/src/mainWindow.cc:942
+#: UI/GTK2/src/mainWindow.cc:945
 msgid "Updated label(s)"
 msgstr "Etiqueta(s) actualizada(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1020 UI/GTK2/src/mainWindow.cc:1132
+#: UI/GTK2/src/mainWindow.cc:1023 UI/GTK2/src/mainWindow.cc:1135
 msgid "Updated document"
 msgstr "Documento actualizado"
 
-#: UI/GTK2/src/mainWindow.cc:1035
+#: UI/GTK2/src/mainWindow.cc:1038
 msgid "Indexed"
 msgstr "Indizado"
 
-#: UI/GTK2/src/mainWindow.cc:1087
+#: UI/GTK2/src/mainWindow.cc:1090
 msgid "Unindexed document(s)"
 msgstr "Documento(s) no indizado(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1179
+#: UI/GTK2/src/mainWindow.cc:1182
 msgid "Couldn't rename index, name"
 msgstr "No se pudo renombrar ?ndice, nombre"
 
-#: UI/GTK2/src/mainWindow.cc:1183 UI/GTK2/src/mainWindow.cc:2048
-#: UI/GTK2/src/mainWindow.cc:2545
+#: UI/GTK2/src/mainWindow.cc:1186 UI/GTK2/src/mainWindow.cc:2058
+#: UI/GTK2/src/mainWindow.cc:2555
 msgid "is already in use"
 msgstr "ya est? en uso"
 
-#: UI/GTK2/src/mainWindow.cc:1196
+#: UI/GTK2/src/mainWindow.cc:1199
 msgid "Couldn't rename index"
 msgstr "No se pudo renombrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1209
+#: UI/GTK2/src/mainWindow.cc:1212
 msgid "Edited index"
 msgstr "?ndice editado"
 
-#: UI/GTK2/src/mainWindow.cc:1650 UI/GTK2/src/mainWindow.cc:1752
+#: UI/GTK2/src/mainWindow.cc:1653 UI/GTK2/src/mainWindow.cc:1755
 msgid "Please set a location for the index first"
 msgstr "Por favor, primero fije una localizaci?n para el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1677
+#: UI/GTK2/src/mainWindow.cc:1680
 msgid "Result location is unknown"
 msgstr "Se desconoce la localizaci?n del resultado"
 
-#: UI/GTK2/src/mainWindow.cc:1701
+#: UI/GTK2/src/mainWindow.cc:1704
 msgid "Import Document(s)"
 msgstr "Importar Documento(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1830 UI/GTK2/src/WorkerThreads.cpp:390
+#: UI/GTK2/src/mainWindow.cc:1833 UI/GTK2/src/WorkerThreads.cpp:390
 #: UI/GTK2/src/WorkerThreads.cpp:1112
 msgid "Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1834 UI/GTK2/src/WorkerThreads.cpp:394
+#: UI/GTK2/src/mainWindow.cc:1837 UI/GTK2/src/WorkerThreads.cpp:394
 #: UI/GTK2/src/WorkerThreads.cpp:1116
 msgid "doesn't exist"
 msgstr "no existe"
 
-#: UI/GTK2/src/mainWindow.cc:1928
-msgid "Delete this document from the index ?"
+#: UI/GTK2/src/mainWindow.cc:1938
+#, fuzzy
+msgid "Remove this document from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:1947
-msgid "Delete these documents from the index ?"
+#: UI/GTK2/src/mainWindow.cc:1957
+#, fuzzy
+msgid "Remove these documents from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:1999
+#: UI/GTK2/src/mainWindow.cc:2009
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Una herramienta metabuscador para el escritorio libre"
 
-#: UI/GTK2/src/mainWindow.cc:2000
+#: UI/GTK2/src/mainWindow.cc:2010
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2044
+#: UI/GTK2/src/mainWindow.cc:2054
 msgid "Index name"
 msgstr "Nombre del ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2059
+#: UI/GTK2/src/mainWindow.cc:2069
 msgid "Couldn't add index"
 msgstr "No se pudo a?adir el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2073
+#: UI/GTK2/src/mainWindow.cc:2083
 msgid "Added new index"
 msgstr "A?adido un nuevo ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2108
+#: UI/GTK2/src/mainWindow.cc:2118
 msgid "Couldn't remove index"
 msgstr "No se pudo borrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2203
+#: UI/GTK2/src/mainWindow.cc:2213
 msgid "Live query"
 msgstr "B?squeda activa"
 
-#: UI/GTK2/src/mainWindow.cc:2360
+#: UI/GTK2/src/mainWindow.cc:2370
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Al menos una tarea no ha finalizado. ?Parar ahora?"
 
-#: UI/GTK2/src/mainWindow.cc:2541
+#: UI/GTK2/src/mainWindow.cc:2551
 msgid "Query name"
 msgstr "Nombre la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2568
+#: UI/GTK2/src/mainWindow.cc:2578
 msgid "Couldn't update query"
 msgstr "No se pudo actualizar la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2576
+#: UI/GTK2/src/mainWindow.cc:2586
 msgid "Edited query"
 msgstr "B?squeda editada"
 
-#: UI/GTK2/src/mainWindow.cc:2583
+#: UI/GTK2/src/mainWindow.cc:2593
 msgid "Couldn't add query"
 msgstr "No se pudo a?adir la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2591
+#: UI/GTK2/src/mainWindow.cc:2601
 msgid "Added new query"
 msgstr "A?adida una nueva b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2605
+#: UI/GTK2/src/mainWindow.cc:2615
 msgid "Query is not set"
 msgstr "B?squeda no definida"
 
-#: UI/GTK2/src/mainWindow.cc:2616
+#: UI/GTK2/src/mainWindow.cc:2626
 msgid "No search engine selected"
 msgstr "Motor de b?squeda no seleccionado"
 
-#: UI/GTK2/src/mainWindow.cc:2698
+#: UI/GTK2/src/mainWindow.cc:2708
 msgid "Please set the Google API key first"
 msgstr "Por favor, primero configure el API de Google"
 
-#: UI/GTK2/src/mainWindow.cc:2707
+#: UI/GTK2/src/mainWindow.cc:2717
 msgid "Running query"
 msgstr "Ejecutando la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2814
+#: UI/GTK2/src/mainWindow.cc:2824
 msgid "is already indexed or is being indexed"
 msgstr "ya ha sido indizado, o se est? indizando"
 
-#: UI/GTK2/src/mainWindow.cc:2841
+#: UI/GTK2/src/mainWindow.cc:2851
 msgid "No URL to browse"
 msgstr "No hay URL que mostrar"
 
-#: UI/GTK2/src/mainWindow.cc:2852
+#: UI/GTK2/src/mainWindow.cc:2862
 msgid "No browser configured to view results"
 msgstr "No ha configurado un navegador para ver los resultados"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:2874
 msgid "Couldn't browse URL:"
 msgstr "No se pudo mostrar el URL:"
 
-#: UI/GTK2/src/mainWindow.cc:2923
+#: UI/GTK2/src/mainWindow.cc:2933
 msgid "Viewing"
 msgstr "Ver"
 
@@ -426,7 +428,7 @@
 msgstr "Des-indizar"
 
 #: UI/GTK2/src/mainWindow_glade.cc:216
-#: UI/GTK2/src/propertiesDialog_glade.cc:171
+#: UI/GTK2/src/propertiesDialog_glade.cc:146
 msgid "Properties"
 msgstr "Propiedades"
 
@@ -454,63 +456,63 @@
 msgid "Pinot"
 msgstr "Pinot"
 
-#: UI/GTK2/src/pinot.cc:56
+#: UI/GTK2/src/pinot.cc:62
 msgid "Couldn't save configuration file"
 msgstr "No se pudo guardar el fichero de configuraci?n"
 
-#: UI/GTK2/src/pinot.cc:120
+#: UI/GTK2/src/pinot.cc:156
 msgid "Danish"
 msgstr "Dan?s"
 
-#: UI/GTK2/src/pinot.cc:121
+#: UI/GTK2/src/pinot.cc:157
 msgid "Dutch"
 msgstr "Holand?s"
 
-#: UI/GTK2/src/pinot.cc:122
+#: UI/GTK2/src/pinot.cc:158
 msgid "English"
 msgstr "Ingl?s"
 
-#: UI/GTK2/src/pinot.cc:123
+#: UI/GTK2/src/pinot.cc:159
 msgid "Finnish"
 msgstr "Finland?s"
 
-#: UI/GTK2/src/pinot.cc:124
+#: UI/GTK2/src/pinot.cc:160
 msgid "French"
 msgstr "Franc?s"
 
-#: UI/GTK2/src/pinot.cc:125
+#: UI/GTK2/src/pinot.cc:161
 msgid "German"
 msgstr "Alem?n"
 
-#: UI/GTK2/src/pinot.cc:126
+#: UI/GTK2/src/pinot.cc:162
 msgid "Italian"
 msgstr "Italiano"
 
-#: UI/GTK2/src/pinot.cc:127
+#: UI/GTK2/src/pinot.cc:163
 msgid "Norwegian"
 msgstr "Noruego"
 
-#: UI/GTK2/src/pinot.cc:128
+#: UI/GTK2/src/pinot.cc:164
 msgid "Portuguese"
 msgstr "Portugu?s"
 
-#: UI/GTK2/src/pinot.cc:129
+#: UI/GTK2/src/pinot.cc:165
 msgid "Russian"
 msgstr "Ruso"
 
-#: UI/GTK2/src/pinot.cc:130
+#: UI/GTK2/src/pinot.cc:166
 msgid "Spanish"
 msgstr "Espa?ol"
 
-#: UI/GTK2/src/pinot.cc:131
+#: UI/GTK2/src/pinot.cc:167
 msgid "Swedish"
 msgstr "Sueco"
 
-#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/pinot.cc:161
+#: UI/GTK2/src/pinot.cc:190 UI/GTK2/src/pinot.cc:198
 msgid "Couldn't open index"
 msgstr "No se pudo abrir el ?ndice"
 
-#: UI/GTK2/src/pinot.cc:171
+#: UI/GTK2/src/pinot.cc:208
 msgid "Couldn't create history database"
 msgstr "No se pudo crear la base de datos del hist?rico"
 
@@ -518,27 +520,27 @@
 msgid "Couldn't create pinot directory at"
 msgstr "No se pudo crear un directorio pinot en"
 
-#: UI/GTK2/src/PinotSettings.cpp:197
+#: UI/GTK2/src/PinotSettings.cpp:200
 msgid "Failed to parse configuration file"
 msgstr "Fallo en el fichero de configuraci?n"
 
-#: UI/GTK2/src/PinotSettings.cpp:206
+#: UI/GTK2/src/PinotSettings.cpp:209
 msgid "Important"
 msgstr "Importante"
 
-#: UI/GTK2/src/PinotSettings.cpp:207
+#: UI/GTK2/src/PinotSettings.cpp:210
 msgid "New"
 msgstr "Nuevo"
 
-#: UI/GTK2/src/PinotSettings.cpp:208
+#: UI/GTK2/src/PinotSettings.cpp:211
 msgid "Personal"
 msgstr "Personal"
 
-#: UI/GTK2/src/PinotSettings.cpp:339
+#: UI/GTK2/src/PinotSettings.cpp:346
 msgid "Couldn't parse configuration file"
 msgstr "No se pudo procesar el fichero de configuraci?n"
 
-#: UI/GTK2/src/PinotSettings.cpp:754
+#: UI/GTK2/src/PinotSettings.cpp:802
 msgid "Unclassified"
 msgstr "No clasificado"
 
@@ -630,23 +632,19 @@
 msgid "Preferences"
 msgstr "Preferencias"
 
-#: UI/GTK2/src/propertiesDialog.cc:40
+#: UI/GTK2/src/propertiesDialog.cc:46
 msgid "Label"
 msgstr "Etiqueta"
 
-#: UI/GTK2/src/propertiesDialog.cc:51
+#: UI/GTK2/src/propertiesDialog.cc:84
 msgid "Unknown"
 msgstr "Desconocido"
 
-#: UI/GTK2/src/propertiesDialog_glade.cc:65
-msgid "Extract:"
-msgstr "Extraer:"
-
 #: UI/GTK2/src/propertiesDialog_glade.cc:66
 msgid "Language:"
 msgstr "Idioma:"
 
-#: UI/GTK2/src/propertiesDialog_glade.cc:68
+#: UI/GTK2/src/propertiesDialog_glade.cc:67
 msgid "MIME type:"
 msgstr "Tipo MIME:"
 
@@ -812,6 +810,9 @@
 msgid "Couldn't open directory"
 msgstr "No se pudo abrir el directorio"
 
+#~ msgid "Extract:"
+#~ msgstr "Extraer:"
+
 #~ msgid "Advanced"
 #~ msgstr "Avanzado"
 

Modified: trunk/po/fr.po
===================================================================
--- trunk/po/fr.po	2006-05-07 05:49:52 UTC (rev 236)
+++ trunk/po/fr.po	2006-05-07 05:54:30 UTC (rev 237)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.43\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-04-18 23:23+0800\n"
+"POT-Creation-Date: 2006-05-07 13:59+0800\n"
 "PO-Revision-Date: 2006-01-20 19:44+0800\n"
 "Last-Translator: Fabrice Colin <colinf at chez.com>\n"
 "Language-Team: fr <colinf at chez.com>\n"
@@ -20,23 +20,23 @@
 msgid "Search Engines"
 msgstr "Moteurs"
 
-#: UI/GTK2/src/EnginesTree.cpp:291
+#: UI/GTK2/src/EnginesTree.cpp:329
 msgid "Current User"
 msgstr "Utilisateur"
 
-#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:372
-#: UI/GTK2/src/mainWindow.cc:375 UI/GTK2/src/mainWindow.cc:545
-#: UI/GTK2/src/mainWindow.cc:1010 UI/GTK2/src/mainWindow.cc:1066
-#: UI/GTK2/src/mainWindow.cc:1086 UI/GTK2/src/mainWindow.cc:1121
-#: UI/GTK2/src/mainWindow.cc:1711 UI/GTK2/src/PinotSettings.cpp:201
-#: UI/GTK2/src/PinotSettings.cpp:911 UI/GTK2/src/PinotSettings.cpp:967
+#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:375
+#: UI/GTK2/src/mainWindow.cc:378 UI/GTK2/src/mainWindow.cc:548
+#: UI/GTK2/src/mainWindow.cc:1013 UI/GTK2/src/mainWindow.cc:1069
+#: UI/GTK2/src/mainWindow.cc:1089 UI/GTK2/src/mainWindow.cc:1124
+#: UI/GTK2/src/mainWindow.cc:1714 UI/GTK2/src/PinotSettings.cpp:204
+#: UI/GTK2/src/PinotSettings.cpp:976 UI/GTK2/src/PinotSettings.cpp:1032
 msgid "My Documents"
 msgstr "Mes Documents"
 
-#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:378
-#: UI/GTK2/src/mainWindow.cc:381 UI/GTK2/src/mainWindow.cc:549
-#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:202
-#: UI/GTK2/src/PinotSettings.cpp:912 UI/GTK2/src/PinotSettings.cpp:968
+#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:381
+#: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:552
+#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:205
+#: UI/GTK2/src/PinotSettings.cpp:977 UI/GTK2/src/PinotSettings.cpp:1033
 #: UI/GTK2/src/prefsDialog_glade.cc:115
 msgid "My Email"
 msgstr "Mon Courrier"
@@ -58,7 +58,7 @@
 msgstr "Repertoire"
 
 #: UI/GTK2/src/importDialog.cc:142 UI/GTK2/src/IndexTree.cpp:69
-#: UI/GTK2/src/ResultsTree.cpp:122
+#: UI/GTK2/src/ResultsTree.cpp:128
 msgid "URL"
 msgstr "URL"
 
@@ -75,7 +75,7 @@
 msgstr "Chemin:"
 
 #: UI/GTK2/src/importDialog_glade.cc:67
-#: UI/GTK2/src/propertiesDialog_glade.cc:64
+#: UI/GTK2/src/propertiesDialog_glade.cc:65
 msgid "Title:"
 msgstr "Titre:"
 
@@ -128,7 +128,7 @@
 msgid "External index"
 msgstr "Index externe"
 
-#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:113
+#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:119
 msgid "Title"
 msgstr "Titre"
 
@@ -172,200 +172,202 @@
 msgid "Ready"
 msgstr "Pret"
 
-#: UI/GTK2/src/mainWindow.cc:277 UI/GTK2/src/mainWindow.cc:967
-#: UI/GTK2/src/mainWindow.cc:1304 UI/GTK2/src/mainWindow.cc:2883
+#: UI/GTK2/src/mainWindow.cc:280 UI/GTK2/src/mainWindow.cc:970
+#: UI/GTK2/src/mainWindow.cc:1307 UI/GTK2/src/mainWindow.cc:2893
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr "Voir"
 
-#: UI/GTK2/src/mainWindow.cc:309
+#: UI/GTK2/src/mainWindow.cc:312
 msgid "N/A"
 msgstr "Inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:319
+#: UI/GTK2/src/mainWindow.cc:322
 msgid "<undefined>"
 msgstr "<inconnu>"
 
-#: UI/GTK2/src/mainWindow.cc:507
+#: UI/GTK2/src/mainWindow.cc:510
 msgid "Result location is"
 msgstr "Le chemin du resultat est"
 
-#: UI/GTK2/src/mainWindow.cc:560
+#: UI/GTK2/src/mainWindow.cc:563
 msgid "Document location is"
 msgstr "Le chemin du document is"
 
-#: UI/GTK2/src/mainWindow.cc:812
+#: UI/GTK2/src/mainWindow.cc:815
 msgid "Showing"
 msgstr "Listant"
 
-#: UI/GTK2/src/mainWindow.cc:817
+#: UI/GTK2/src/mainWindow.cc:820
 msgid "off"
 msgstr "documents,"
 
-#: UI/GTK2/src/mainWindow.cc:822
+#: UI/GTK2/src/mainWindow.cc:825
 msgid "documents, starting at"
 msgstr "au total, a partir de"
 
-#: UI/GTK2/src/mainWindow.cc:856
+#: UI/GTK2/src/mainWindow.cc:859
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:860 UI/GTK2/src/mainWindow.cc:2711
+#: UI/GTK2/src/mainWindow.cc:863 UI/GTK2/src/mainWindow.cc:2721
 msgid "on"
 msgstr "sur"
 
-#: UI/GTK2/src/mainWindow.cc:864
+#: UI/GTK2/src/mainWindow.cc:867
 msgid "ended"
 msgstr "est terminee"
 
-#: UI/GTK2/src/mainWindow.cc:942
+#: UI/GTK2/src/mainWindow.cc:945
 msgid "Updated label(s)"
 msgstr "Mis a jour l(es) etiquette(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1020 UI/GTK2/src/mainWindow.cc:1132
+#: UI/GTK2/src/mainWindow.cc:1023 UI/GTK2/src/mainWindow.cc:1135
 msgid "Updated document"
 msgstr "Mis a jour le document"
 
-#: UI/GTK2/src/mainWindow.cc:1035
+#: UI/GTK2/src/mainWindow.cc:1038
 msgid "Indexed"
 msgstr "Indexe"
 
-#: UI/GTK2/src/mainWindow.cc:1087
+#: UI/GTK2/src/mainWindow.cc:1090
 msgid "Unindexed document(s)"
 msgstr "Desindexe le(s) document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1179
+#: UI/GTK2/src/mainWindow.cc:1182
 msgid "Couldn't rename index, name"
 msgstr "N'a pas pu renommer l'index, le nom"
 
-#: UI/GTK2/src/mainWindow.cc:1183 UI/GTK2/src/mainWindow.cc:2048
-#: UI/GTK2/src/mainWindow.cc:2545
+#: UI/GTK2/src/mainWindow.cc:1186 UI/GTK2/src/mainWindow.cc:2058
+#: UI/GTK2/src/mainWindow.cc:2555
 msgid "is already in use"
 msgstr "est deja utilise"
 
-#: UI/GTK2/src/mainWindow.cc:1196
+#: UI/GTK2/src/mainWindow.cc:1199
 msgid "Couldn't rename index"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1209
+#: UI/GTK2/src/mainWindow.cc:1212
 msgid "Edited index"
 msgstr "Edite l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1650 UI/GTK2/src/mainWindow.cc:1752
+#: UI/GTK2/src/mainWindow.cc:1653 UI/GTK2/src/mainWindow.cc:1755
 msgid "Please set a location for the index first"
 msgstr "Donnez un chemin a l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1677
+#: UI/GTK2/src/mainWindow.cc:1680
 msgid "Result location is unknown"
 msgstr "Le chemin du resultat est inconnu"
 
-#: UI/GTK2/src/mainWindow.cc:1701
+#: UI/GTK2/src/mainWindow.cc:1704
 msgid "Import Document(s)"
 msgstr "Import de Document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1830 UI/GTK2/src/WorkerThreads.cpp:390
+#: UI/GTK2/src/mainWindow.cc:1833 UI/GTK2/src/WorkerThreads.cpp:390
 #: UI/GTK2/src/WorkerThreads.cpp:1112
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:1834 UI/GTK2/src/WorkerThreads.cpp:394
+#: UI/GTK2/src/mainWindow.cc:1837 UI/GTK2/src/WorkerThreads.cpp:394
 #: UI/GTK2/src/WorkerThreads.cpp:1116
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
-#: UI/GTK2/src/mainWindow.cc:1928
-msgid "Delete this document from the index ?"
+#: UI/GTK2/src/mainWindow.cc:1938
+#, fuzzy
+msgid "Remove this document from the index ?"
 msgstr "Enlever ce document de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:1947
-msgid "Delete these documents from the index ?"
+#: UI/GTK2/src/mainWindow.cc:1957
+#, fuzzy
+msgid "Remove these documents from the index ?"
 msgstr "Enlever ces documents de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:1999
+#: UI/GTK2/src/mainWindow.cc:2009
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Un outil de recherche pour le Bureau Libre"
 
-#: UI/GTK2/src/mainWindow.cc:2000
+#: UI/GTK2/src/mainWindow.cc:2010
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2044
+#: UI/GTK2/src/mainWindow.cc:2054
 msgid "Index name"
 msgstr "Nom de l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2059
+#: UI/GTK2/src/mainWindow.cc:2069
 msgid "Couldn't add index"
 msgstr "N'a pas pu ajouter l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2073
+#: UI/GTK2/src/mainWindow.cc:2083
 msgid "Added new index"
 msgstr "Ajoute un nouvel index"
 
-#: UI/GTK2/src/mainWindow.cc:2108
+#: UI/GTK2/src/mainWindow.cc:2118
 msgid "Couldn't remove index"
 msgstr "N'a pas pu enlever l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2203
+#: UI/GTK2/src/mainWindow.cc:2213
 msgid "Live query"
 msgstr "Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2360
+#: UI/GTK2/src/mainWindow.cc:2370
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2541
+#: UI/GTK2/src/mainWindow.cc:2551
 msgid "Query name"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2568
+#: UI/GTK2/src/mainWindow.cc:2578
 msgid "Couldn't update query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2576
+#: UI/GTK2/src/mainWindow.cc:2586
 msgid "Edited query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2583
+#: UI/GTK2/src/mainWindow.cc:2593
 msgid "Couldn't add query"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2591
+#: UI/GTK2/src/mainWindow.cc:2601
 msgid "Added new query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2605
+#: UI/GTK2/src/mainWindow.cc:2615
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2616
+#: UI/GTK2/src/mainWindow.cc:2626
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:2698
+#: UI/GTK2/src/mainWindow.cc:2708
 msgid "Please set the Google API key first"
 msgstr "Configurez la clef de l'API Google "
 
-#: UI/GTK2/src/mainWindow.cc:2707
+#: UI/GTK2/src/mainWindow.cc:2717
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:2814
+#: UI/GTK2/src/mainWindow.cc:2824
 msgid "is already indexed or is being indexed"
 msgstr "est deja indexe ou est en cours d'indexation"
 
-#: UI/GTK2/src/mainWindow.cc:2841
+#: UI/GTK2/src/mainWindow.cc:2851
 msgid "No URL to browse"
 msgstr "Pas d'URL a brouter"
 
-#: UI/GTK2/src/mainWindow.cc:2852
+#: UI/GTK2/src/mainWindow.cc:2862
 msgid "No browser configured to view results"
 msgstr "Pas de brouter configure"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:2874
 msgid "Couldn't browse URL:"
 msgstr "N'a pas pu brouter l'URL"
 
-#: UI/GTK2/src/mainWindow.cc:2923
+#: UI/GTK2/src/mainWindow.cc:2933
 msgid "Viewing"
 msgstr "Voir"
 
@@ -426,7 +428,7 @@
 msgstr "Desindexer"
 
 #: UI/GTK2/src/mainWindow_glade.cc:216
-#: UI/GTK2/src/propertiesDialog_glade.cc:171
+#: UI/GTK2/src/propertiesDialog_glade.cc:146
 msgid "Properties"
 msgstr "Proprietes"
 
@@ -454,63 +456,63 @@
 msgid "Pinot"
 msgstr "Pinot"
 
-#: UI/GTK2/src/pinot.cc:56
+#: UI/GTK2/src/pinot.cc:62
 msgid "Couldn't save configuration file"
 msgstr "N'a pas pu sauve le fichier de configuration"
 
-#: UI/GTK2/src/pinot.cc:120
+#: UI/GTK2/src/pinot.cc:156
 msgid "Danish"
 msgstr "Danois"
 
-#: UI/GTK2/src/pinot.cc:121
+#: UI/GTK2/src/pinot.cc:157
 msgid "Dutch"
 msgstr "Hollandais"
 
-#: UI/GTK2/src/pinot.cc:122
+#: UI/GTK2/src/pinot.cc:158
 msgid "English"
 msgstr "Anglais"
 
-#: UI/GTK2/src/pinot.cc:123
+#: UI/GTK2/src/pinot.cc:159
 msgid "Finnish"
 msgstr "Finlandais"
 
-#: UI/GTK2/src/pinot.cc:124
+#: UI/GTK2/src/pinot.cc:160
 msgid "French"
 msgstr "Francais"
 
-#: UI/GTK2/src/pinot.cc:125
+#: UI/GTK2/src/pinot.cc:161
 msgid "German"
 msgstr "Allemand"
 
-#: UI/GTK2/src/pinot.cc:126
+#: UI/GTK2/src/pinot.cc:162
 msgid "Italian"
 msgstr "Italien"
 
-#: UI/GTK2/src/pinot.cc:127
+#: UI/GTK2/src/pinot.cc:163
 msgid "Norwegian"
 msgstr "Norvegien"
 
-#: UI/GTK2/src/pinot.cc:128
+#: UI/GTK2/src/pinot.cc:164
 msgid "Portuguese"
 msgstr "Portugais"
 
-#: UI/GTK2/src/pinot.cc:129
+#: UI/GTK2/src/pinot.cc:165
 msgid "Russian"
 msgstr "Russe"
 
-#: UI/GTK2/src/pinot.cc:130
+#: UI/GTK2/src/pinot.cc:166
 msgid "Spanish"
 msgstr "Espagnol"
 
-#: UI/GTK2/src/pinot.cc:131
+#: UI/GTK2/src/pinot.cc:167
 msgid "Swedish"
 msgstr "Suedois"
 
-#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/pinot.cc:161
+#: UI/GTK2/src/pinot.cc:190 UI/GTK2/src/pinot.cc:198
 msgid "Couldn't open index"
 msgstr "N'a pas pu ouvrir l'index"
 
-#: UI/GTK2/src/pinot.cc:171
+#: UI/GTK2/src/pinot.cc:208
 msgid "Couldn't create history database"
 msgstr "N'a pas pu creer la base d'historiques"
 
@@ -518,27 +520,27 @@
 msgid "Couldn't create pinot directory at"
 msgstr "N'a pas pu creer le repertoire a"
 
-#: UI/GTK2/src/PinotSettings.cpp:197
+#: UI/GTK2/src/PinotSettings.cpp:200
 msgid "Failed to parse configuration file"
 msgstr "N'a pas pu lire le fichier de configuration"
 
-#: UI/GTK2/src/PinotSettings.cpp:206
+#: UI/GTK2/src/PinotSettings.cpp:209
 msgid "Important"
 msgstr "Important"
 
-#: UI/GTK2/src/PinotSettings.cpp:207
+#: UI/GTK2/src/PinotSettings.cpp:210
 msgid "New"
 msgstr "Nouveau"
 
-#: UI/GTK2/src/PinotSettings.cpp:208
+#: UI/GTK2/src/PinotSettings.cpp:211
 msgid "Personal"
 msgstr "Personnel"
 
-#: UI/GTK2/src/PinotSettings.cpp:339
+#: UI/GTK2/src/PinotSettings.cpp:346
 msgid "Couldn't parse configuration file"
 msgstr "N'a pas pu lire le fichier de configuration"
 
-#: UI/GTK2/src/PinotSettings.cpp:754
+#: UI/GTK2/src/PinotSettings.cpp:802
 msgid "Unclassified"
 msgstr "Sans classification"
 
@@ -630,23 +632,19 @@
 msgid "Preferences"
 msgstr "Preferences"
 
-#: UI/GTK2/src/propertiesDialog.cc:40
+#: UI/GTK2/src/propertiesDialog.cc:46
 msgid "Label"
 msgstr "L'etiquette"
 
-#: UI/GTK2/src/propertiesDialog.cc:51
+#: UI/GTK2/src/propertiesDialog.cc:84
 msgid "Unknown"
 msgstr "Inconnu"
 
-#: UI/GTK2/src/propertiesDialog_glade.cc:65
-msgid "Extract:"
-msgstr "Extrait:"
-
 #: UI/GTK2/src/propertiesDialog_glade.cc:66
 msgid "Language:"
 msgstr "Langue:"
 
-#: UI/GTK2/src/propertiesDialog_glade.cc:68
+#: UI/GTK2/src/propertiesDialog_glade.cc:67
 msgid "MIME type:"
 msgstr "Type MIME:"
 
@@ -811,3 +809,6 @@
 #: UI/GTK2/src/WorkerThreads.cpp:1606
 msgid "Couldn't open directory"
 msgstr "N'a pas pu ouvrir le repertoire"
+
+#~ msgid "Extract:"
+#~ msgstr "Extrait:"



From fabricecolin at berlios.de  Wed May 10 15:05:48 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 10 May 2006 15:05:48 +0200
Subject: [Pinot-svn] r238 - trunk/Search/Plugins
Message-ID: <200605101305.k4AD5mSt016357@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-10 15:05:48 +0200 (Wed, 10 May 2006)
New Revision: 238

Modified:
   trunk/Search/Plugins/CreativeCommons.src
Log:
Updated, based on plugin shipped with Firefox.


Modified: trunk/Search/Plugins/CreativeCommons.src
===================================================================
--- trunk/Search/Plugins/CreativeCommons.src	2006-05-07 05:54:30 UTC (rev 237)
+++ trunk/Search/Plugins/CreativeCommons.src	2006-05-10 13:05:48 UTC (rev 238)
@@ -3,24 +3,20 @@
 <SEARCH
 	version="1.0"
 	name="Creative Commons"
-	description="Yahoo.com Creative Commons Search"
+	description="Yahoo! Search for Creative Commons"
 	method="GET"
-	action="http://search.yahoo.com/search"
+	action="http://search.creativecommons.org/"
 	routeType="Content"
 >
 
-<INPUT NAME="ei" VALUE="UTF-8">
-<INPUT NAME="fr" VALUE="sfp-cc">
-<INPUT NAME="p" USER>
-<INPUT NAME="y" VALUE="Search+CC">
-<INPUT NAME="cc" VALUE="1">
-<INPUTNEXT NAME="b" FACTOR="10" VALUE="1">
+<INPUT NAME="q" USER>
+<INPUTNEXT NAME="start" FACTOR="10" VALUE="0">
 
 <INTERPRET
-resultListStart=""
-resultListEnd=""
-resultItemStart="<li><div>"
-resultItemEnd="</em> "
+resultListStart='<!-- start results -->'
+resultListEnd='<!-- end results -->'
+resultItemStart='<p class="resultitem">'
+resultItemEnd='</p>'
 >
 
 </SEARCH>



From fabricecolin at berlios.de  Wed May 10 15:07:17 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 10 May 2006 15:07:17 +0200
Subject: [Pinot-svn] r239 - in trunk: Collect Index SQL Search Search/Google Tokenize UI/GTK2/src Utils
Message-ID: <200605101307.k4AD7HYW016686@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-10 15:07:15 +0200 (Wed, 10 May 2006)
New Revision: 239

Modified:
   trunk/Collect/NeonDownloader.cpp
   trunk/Collect/XapianCollector.cpp
   trunk/Index/XapianIndex.cpp
   trunk/SQL/SQLiteBase.cpp
   trunk/Search/Google/GoogleAPIEngine.cpp
   trunk/Search/OpenSearchParser.cpp
   trunk/Search/PluginWebEngine.cpp
   trunk/Search/XapianEngine.cpp
   trunk/Tokenize/Tokenizer.cpp
   trunk/Tokenize/TokenizerFactory.cpp
   trunk/Tokenize/XmlTokenizer.cpp
   trunk/UI/GTK2/src/MonitorHandler.cpp
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/pinot.cc
   trunk/Utils/Document.cpp
   trunk/Utils/MboxParser.cpp
   trunk/Utils/XapianDatabase.cpp
Log:
Brought some sanity to debugging messages ;-)


Modified: trunk/Collect/NeonDownloader.cpp
===================================================================
--- trunk/Collect/NeonDownloader.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Collect/NeonDownloader.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -156,7 +156,7 @@
 	if (url.empty() == true)
 	{
 #ifdef DEBUG
-		cerr << "NeonDownloader::retrieveUrl: no URL specified !" << endl;
+		cout << "NeonDownloader::retrieveUrl: no URL specified !" << endl;
 #endif
 		return NULL;
 	}
@@ -172,7 +172,7 @@
 	if (pSession == NULL)
 	{
 #ifdef DEBUG
-		cerr << "NeonDownloader::retrieveUrl: couldn't create session !" << endl;
+		cout << "NeonDownloader::retrieveUrl: couldn't create session !" << endl;
 #endif
 		return NULL;
 	}
@@ -205,7 +205,7 @@
 	if (pRequest == NULL)
 	{
 #ifdef DEBUG
-		cerr << "NeonDownloader::retrieveUrl: couldn't create request !" << endl;
+		cout << "NeonDownloader::retrieveUrl: couldn't create request !" << endl;
 #endif
 		ne_session_destroy(pSession);
 		return NULL;
@@ -298,7 +298,7 @@
 					if (pSession == NULL)
 					{
 #ifdef DEBUG
-						cerr << "NeonDownloader::retrieveUrl: couldn't create session !" << endl;
+						cout << "NeonDownloader::retrieveUrl: couldn't create session !" << endl;
 #endif
 						return NULL;
 					}
@@ -326,7 +326,7 @@
 				if (pRequest == NULL)
 				{
 #ifdef DEBUG
-					cerr << "NeonDownloader::retrieveUrl: couldn't create request !" << endl;
+					cout << "NeonDownloader::retrieveUrl: couldn't create request !" << endl;
 #endif
 					ne_session_destroy(pSession);
 					return NULL;

Modified: trunk/Collect/XapianCollector.cpp
===================================================================
--- trunk/Collect/XapianCollector.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Collect/XapianCollector.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -75,7 +75,7 @@
 	if (stat(m_databaseName.c_str(), &dbStat) == -1)
 	{
 		// Database directory doesn't exist
-		cerr << "XapianCollector::openDatabase: database doesn't exist: " << m_databaseName << endl;
+		cerr << "XapianCollector::openDatabase: " << m_databaseName << " doesn't exist" << endl;
 		return false;
 	}
 	else if (!S_ISDIR(dbStat.st_mode))
@@ -170,7 +170,7 @@
 		string timestamp = StringManip::extractField(record, "timestamp=", "\n");
 		string language = StringManip::extractField(record, "language=", "\n");
 #ifdef DEBUG
-	cout << "XapianCollector::retrieveUrl: " << docId << " was indexed from " << location << " at " << timestamp << endl;
+		cout << "XapianCollector::retrieveUrl: " << docId << " was indexed from " << location << " at " << timestamp << endl;
 #endif
 
 		indexDoc = new IndexedDocument(title, url, location, type, language);

Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Index/XapianIndex.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -37,6 +37,9 @@
 #include "XapianDatabaseFactory.h"
 #include "XapianIndex.h"
 
+using std::cout;
+using std::cerr;
+using std::endl;
 using std::string;
 using std::set;
 using std::min;
@@ -240,9 +243,7 @@
 		}
 		catch (const Xapian::Error &e)
 		{
-#ifdef DEBUG
-			cout << "XapianIndex::scanDocument: no support for " << *langIter << endl;
-#endif
+			cerr << "XapianIndex::scanDocument: no support for language " << *langIter << endl;
 			continue;
 		}
 

Modified: trunk/SQL/SQLiteBase.cpp
===================================================================
--- trunk/SQL/SQLiteBase.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/SQL/SQLiteBase.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -23,6 +23,9 @@
 
 #include "SQLiteBase.h"
 
+using std::cout;
+using std::endl;
+
 SQLiteRow::SQLiteRow(const vector<string> &rowColumns, int nColumns) :
 	m_nColumns(nColumns)
 {
@@ -233,9 +236,8 @@
 	{
 		if (errMsg != NULL)
 		{
-#ifdef DEBUG
-			cout << "SQLiteBase::executeSimpleStatement: statement <" << sql << "> failed: " << errMsg << endl;
-#endif
+			cerr << "SQLiteBase::executeSimpleStatement: statement <" << sql << "> failed: " << errMsg << endl;
+
 			sqlite3_free(errMsg);
 		}
 
@@ -311,9 +313,8 @@
 	{
 		if (errMsg != NULL)
 		{
-#ifdef DEBUG
-			cout << "SQLiteBase::executeStatement: statement <" << stringBuff << "> failed: " << errMsg << endl;
-#endif
+			cerr << "SQLiteBase::executeStatement: statement <" << stringBuff << "> failed: " << errMsg << endl;
+
 			sqlite3_free(errMsg);
 		}
 	}

Modified: trunk/Search/Google/GoogleAPIEngine.cpp
===================================================================
--- trunk/Search/Google/GoogleAPIEngine.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Search/Google/GoogleAPIEngine.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -24,6 +24,7 @@
 #include "GAPI.nsmap"
 
 using std::cout;
+using std::cerr;
 using std::endl;
 
 GoogleAPIEngine::GoogleAPIEngine() :
@@ -91,9 +92,7 @@
 
 	if (m_key.empty() == true)
 	{
-#ifdef DEBUG
-		cout << "GoogleAPIEngine::runQuery: no key" << endl;
-#endif
+		cerr << "GoogleAPIEngine::runQuery: no key" << endl;
 		return false;
 	}
 
@@ -116,9 +115,7 @@
 		false, "", false, "", "utf-8", "utf-8", queryOut);
 	if (soapStatus != SOAP_OK)
 	{
-#ifdef DEBUG
-		cout << "GoogleAPIEngine::runQuery: search failed with status " << soapStatus << endl;
-#endif
+		cerr << "GoogleAPIEngine::runQuery: search failed with status " << soapStatus << endl;
 		return false;
 	}
 

Modified: trunk/Search/OpenSearchParser.cpp
===================================================================
--- trunk/Search/OpenSearchParser.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Search/OpenSearchParser.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -101,9 +101,7 @@
 	if ((mimeType.empty() == false) &&
 		(mimeType.find("xml") == string::npos))
 	{
-#ifdef DEBUG
-		cout << "OpenSearchResponseParser::parse: response is not XML" << endl;
-#endif
+		cerr << "OpenSearchResponseParser::parse: response is not XML" << endl;
 		return false;
 	}
 

Modified: trunk/Search/PluginWebEngine.cpp
===================================================================
--- trunk/Search/PluginWebEngine.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Search/PluginWebEngine.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -24,6 +24,10 @@
 #include "SherlockParser.h"
 #include "PluginWebEngine.h"
 
+using std::cout;
+using std::cerr;
+using std::endl;
+
 PluginWebEngine::PluginWebEngine(const string &fileName) :
 	WebEngine(),
 	m_pResponseParser(NULL)
@@ -69,10 +73,8 @@
 	Document *pResponseDoc = downloadPage(docInfo);
 	if (pResponseDoc == NULL)
 	{
-#ifdef DEBUG
-		cerr << "PluginWebEngine::getPage: couldn't download page "
+		cerr << "PluginWebEngine::getPage: couldn't download "
 			<< formattedQuery << endl;
-#endif
 		return false;
 	}
 
@@ -82,7 +84,7 @@
 		(contentLen == 0))
 	{
 #ifdef DEBUG
-		cerr << "PluginWebEngine::getPage: downloaded empty page" << endl;
+		cout << "PluginWebEngine::getPage: downloaded empty page" << endl;
 #endif
 		delete pResponseDoc;
 		return false;
@@ -175,9 +177,8 @@
 	ResponseParserInterface *pResponseParser = pParser->parse(properties, true);
 	if (pResponseParser == NULL)
 	{
-#ifdef DEBUG
-		cerr << "PluginWebEngine::getDetails: couldn't parse " << fileName << endl;
-#endif
+		cerr << "PluginWebEngine::getDetails: couldn't parse "
+			<< fileName << endl;
 		delete pParser;
 
 		return false;
@@ -188,7 +189,7 @@
 	if (properties.m_response == SearchPluginProperties::UNKNOWN_RESPONSE)
 	{
 #ifdef DEBUG
-		cerr << "PluginWebEngine::getDetails: bad response type for "
+		cout << "PluginWebEngine::getDetails: bad response type for "
 			<< fileName << endl;
 #endif
 		return false;

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Search/XapianEngine.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -210,7 +210,7 @@
 		}
 		catch (const Xapian::Error &error)
 		{
-			cout << "XapianEngine::queryDatabase: couldn't run query: "  << error.get_msg() << endl;
+			cerr << "XapianEngine::queryDatabase: couldn't run query: "  << error.get_msg() << endl;
 		}
 	}
 	pDatabase->unlock();
@@ -398,7 +398,7 @@
 	}
 	catch (const Xapian::Error &error)
 	{
-		cout << "XapianEngine::runQuery: couldn't run query: "  << error.get_msg() << endl;
+		cerr << "XapianEngine::runQuery: couldn't run query: "  << error.get_msg() << endl;
 	}
 
 	return false;
@@ -499,7 +499,7 @@
 	}
 	catch (const Xapian::Error &error)
 	{
-		cout << "XapianEngine::runQuery: couldn't run query: "  << error.get_msg() << endl;
+		cerr << "XapianEngine::runQuery: couldn't run query: "  << error.get_msg() << endl;
 	}
 
 	return false;

Modified: trunk/Tokenize/Tokenizer.cpp
===================================================================
--- trunk/Tokenize/Tokenizer.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Tokenize/Tokenizer.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -104,17 +104,14 @@
 						pDocument->getLocation(), pDocument->getType(),
 						pDocument->getLanguage());
 					pOutputDocument->setData(content, bytes);
-#ifdef DEBUG
+#ifdef DEBUG_TOKENIZER
 					cout << "Tokenizer::runHelperProgram: set " << bytes
 						<< " bytes of data" << endl;
 #endif
 
 					delete[] content;
 				}
-#ifdef DEBUG
-				else cerr << "Tokenizer::runHelperProgram: "
-					<< cmdLine << " failed" << endl;
-#endif
+				else cerr << "Tokenizer::runHelperProgram: " << cmdLine << " failed" << endl;
 			}
 		}
 	}
@@ -125,8 +122,8 @@
 	if ((unlink(outTemplate) != 0) ||
 		(unlink(inTemplate) != 0))
 	{
-#ifdef DEBUG
-		cerr << "Tokenizer::runHelperProgram: couldn't delete temporary files" << endl;
+#ifdef DEBUG_TOKENIZER
+		cout << "Tokenizer::runHelperProgram: couldn't delete temporary files" << endl;
 #endif
 	}
 

Modified: trunk/Tokenize/TokenizerFactory.cpp
===================================================================
--- trunk/Tokenize/TokenizerFactory.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Tokenize/TokenizerFactory.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -36,6 +36,7 @@
 #define GETTOKENIZER		"_Z12getTokenizerPK8Document"
 
 using std::cout;
+using std::cerr;
 using std::endl;
 using std::string;
 using std::map;
@@ -109,10 +110,7 @@
 
 	if (stat(dirName.c_str(), &fileStat) == -1)
 	{
-#ifdef DEBUG
-		cout << "TokenizerFactory::loadTokenizers: "
-			<< dirName << " doesn't exist" << endl;
-#endif
+		cerr << "TokenizerFactory::loadTokenizers: " << dirName << " doesn't exist" << endl;
 		return 0;
 	}
 
@@ -179,13 +177,9 @@
 								m_handles[fileName] = pHandle;
 							}
 						}
-#ifdef DEBUG
-						else cout << "TokenizerFactory::loadTokenizers: " << dlerror() << endl;
-#endif
+						else cerr << "TokenizerFactory::loadTokenizers: " << dlerror() << endl;
 					}
-#ifdef DEBUG
-					else cout << "TokenizerFactory::loadTokenizers: " << dlerror() << endl;
-#endif
+					else cerr << "TokenizerFactory::loadTokenizers: " << dlerror() << endl;
 				}
 #ifdef DEBUG
 				else cout << "TokenizerFactory::loadTokenizers: "
@@ -199,10 +193,7 @@
 
 		closedir(pDir);
 	}
-#ifdef DEBUG
-	else cout << "TokenizerFactory::loadTokenizers: "
-		<< dirName << " is not a directory" << endl;
-#endif
+	else cerr << "TokenizerFactory::loadTokenizers: " << dirName << " is not a directory" << endl;
 
 	return count;
 }

Modified: trunk/Tokenize/XmlTokenizer.cpp
===================================================================
--- trunk/Tokenize/XmlTokenizer.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Tokenize/XmlTokenizer.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -83,10 +83,6 @@
 	string::size_type startPos = 0;
 	bool isXml = false, skip = false;
 
-#ifdef DEBUG_TOKENIZER
-	cout << "XmlTokenizer::parseXML: start" << endl;
-#endif
-
 	// Tag start
 	string::size_type pos = str.find("<");
 	while (pos != string::npos)

Modified: trunk/UI/GTK2/src/MonitorHandler.cpp
===================================================================
--- trunk/UI/GTK2/src/MonitorHandler.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/UI/GTK2/src/MonitorHandler.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -335,13 +335,10 @@
 	tempSourceLabel += sourceLabel;
 
 	// Get the mail index
-	string indexLocation = PinotSettings::getInstance().m_mailIndexLocation;
-	XapianIndex index(indexLocation);
+	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
 	if (index.isGood() == false)
 	{
-#ifdef DEBUG
-		cout << "MboxHandler::fileExists: couldn't get mail index" << endl;
-#endif
+		cerr << "MboxHandler::fileExists: couldn't get mail index" << endl;
 		return false;
 	}
 
@@ -415,13 +412,10 @@
 	sourceLabel += fileName;
 
 	// Get the mail index
-	string indexLocation = PinotSettings::getInstance().m_mailIndexLocation;
-	XapianIndex index(indexLocation);
+	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
 	if (index.isGood() == false)
 	{
-#ifdef DEBUG
-		cout << "MboxHandler::fileChanged: couldn't get mail index" << endl;
-#endif
+		cerr << "MboxHandler::fileChanged: couldn't get mail index" << endl;
 		return false;
 	}
 
@@ -459,13 +453,10 @@
 	bool unindexedFile = false;
 
 	// Get the mail index
-	string indexLocation = PinotSettings::getInstance().m_mailIndexLocation;
-	XapianIndex index(indexLocation);
+	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
 	if (index.isGood() == false)
 	{
-#ifdef DEBUG
-		cout << "MboxHandler::fileDeleted: couldn't get mail index" << endl;
-#endif
+		cerr << "MboxHandler::fileDeleted: couldn't get mail index" << endl;
 		return false;
 	}
 

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -105,7 +105,7 @@
 		}
 		else
 		{
-			cerr << _("Couldn't create pinot directory at") << " "
+			cerr << "Couldn't create pinot directory at "
 				<< directoryName << endl;
 		}
 	}
@@ -197,7 +197,7 @@
 	if ((m_firstRun == false) &&
 		(loadConfiguration(fileName) == false))
 	{
-		cerr << _("Failed to parse configuration file") << " "
+		cerr << "Failed to parse configuration file "
 			<< fileName << endl;
 	}
 	// Internal indices
@@ -343,7 +343,7 @@
 	}
 	catch (const std::exception& ex)
 	{
-		cerr << _("Couldn't parse configuration file") << ": "
+		cerr << "Couldn't parse configuration file: "
 			<< ex.what() << endl;
 		success = false;
 	}
@@ -477,9 +477,6 @@
 			{
 				channelIter->second = false;
 			}
-#ifdef DEBUG
-			cout << "PinotSettings::loadEngineChannels: " << nodeContent << " is collapsed" << endl;
-#endif
 		}
 	}
 
@@ -872,9 +869,6 @@
 		// Only save those whose group was collapsed
 		if (channelIter->second == false)
 		{
-#ifdef DEBUG
-			cout << "PinotSettings::save: " << channelIter->first << " is collapsed" << endl;
-#endif
 			pElem = pRootElem->add_child("channel");
 			if (pElem == NULL)
 			{

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -139,16 +139,12 @@
 	}
 	catch (exception &ex)
 	{
-#ifdef DEBUG
-		cout << "Exception in thread " << m_id << ", type " << getType()
+		cerr << "Exception in thread " << m_id << ", type " << getType()
 			<< ":" << ex.what() << endl;
-#endif
 	}
 	catch (...)
 	{
-#ifdef DEBUG
-		cout << "Unknown exception in thread " << m_id << ", type " << getType() << endl;
-#endif
+		cerr << "Unknown exception in thread " << m_id << ", type " << getType() << endl;
 	}
 
 	emitSignal();

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/UI/GTK2/src/pinot.cc	2006-05-10 13:07:15 UTC (rev 239)
@@ -59,7 +59,7 @@
 	PinotSettings &settings = PinotSettings::getInstance();
 	if (settings.save() == false)
 	{
-		cerr << _("Couldn't save configuration file") << endl;
+		cerr << "Couldn't save configuration file" << endl;
 	}
 
 	// Close all indexes we may have opened

Modified: trunk/Utils/Document.cpp
===================================================================
--- trunk/Utils/Document.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Utils/Document.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -27,6 +27,7 @@
 #include "Document.h"
 
 using std::cout;
+using std::cerr;
 using std::endl;
 using std::string;
 
@@ -154,9 +155,7 @@
 	int fd = open(fileName.c_str(), O_RDONLY);
 	if (fd == -1)
 	{
-#ifdef DEBUG
-		cout << "Document::setDataFromFile: " << fileName << " couldn't be opened" << endl;
-#endif
+		cerr << "Document::setDataFromFile: " << fileName << " couldn't be opened" << endl;
 		return false;
 	}
 
@@ -171,9 +170,10 @@
 		m_dataLength = fileStat.st_size;
 		m_isMapped = true;
 	}
-#ifdef DEBUG
-	else	cout << "Document::setDataFromFile: mapping failed" << endl;
-#endif
+	else
+	{
+		cerr << "Document::setDataFromFile: mapping failed" << endl;
+	}
 
 	// Close the file
 	if (close(fd) == -1)

Modified: trunk/Utils/MboxParser.cpp
===================================================================
--- trunk/Utils/MboxParser.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Utils/MboxParser.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -29,7 +29,8 @@
 #include "Url.h"
 #include "MboxParser.h"
 
-using namespace std;
+using std::cout;
+using std::endl;
 
 MboxParser::MboxParser(const string &fileName, off_t mboxOffset)
 {

Modified: trunk/Utils/XapianDatabase.cpp
===================================================================
--- trunk/Utils/XapianDatabase.cpp	2006-05-10 13:05:48 UTC (rev 238)
+++ trunk/Utils/XapianDatabase.cpp	2006-05-10 13:07:15 UTC (rev 239)
@@ -66,9 +66,7 @@
 
 		if (m_readOnly == false)
 		{
-#ifdef DEBUG
-			cout << "XapianDatabase::openDatabase: remote databases are read-only" << endl;
-#endif
+			cerr << "XapianDatabase::openDatabase: remote databases are read-only" << endl;
 			return false;
 		}
 



From fabricecolin at berlios.de  Wed May 10 16:37:34 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 10 May 2006 16:37:34 +0200
Subject: [Pinot-svn] r240 - in trunk: . po
Message-ID: <200605101437.k4AEbYEg027675@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-10 16:37:34 +0200 (Wed, 10 May 2006)
New Revision: 240

Modified:
   trunk/NEWS
   trunk/TODO
   trunk/configure.in
   trunk/po/es.po
   trunk/po/fr.po
Log:
Preparing for next release, hopefully this week.


Modified: trunk/NEWS
===================================================================
--- trunk/NEWS	2006-05-10 13:07:15 UTC (rev 239)
+++ trunk/NEWS	2006-05-10 14:37:34 UTC (rev 240)
@@ -3,9 +3,10 @@
  - all programs have man pages and support --help and --version
 Search :
  - the Google API engine is no longer unnecessarily picky about queries parameters
+ - updated Creative Commons plugin, based on the one shipped with Firefox
 UI :
  - merged channel Web Services with The Web
- - the state of engine channels tree is saved and restored
+ - the state of engine channels is saved and restored
  - query terms are highlighted in the extract field
  - allow editing the language of documents. A subsequent update would use the
   given language to stem terms.

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2006-05-10 13:07:15 UTC (rev 239)
+++ trunk/TODO	2006-05-10 14:37:34 UTC (rev 240)
@@ -2,10 +2,7 @@
 - Fix the FIXMEs
 - Get rid of dead code/classes/methods...
 - Advertise service via Rendezvous
-- Man page, see help2man (http://www.gnu.org/software/help2man/)
-- Logging should not be all (DEBUG) or nothing (release)
 - Check for leaks with valgrind (eg --tool=memcheck -v --leak-check=yes --show-reachable=yes ...)
-- Change .spec to allow building with Google and ObjectsSearch SOAP APIs support
 - Don't use system(), fork and exec, especially for the external browser
 - Find out how to determine what application to use for a given MIME type and drop internal browser
   Does xdgmime allow to consult the applications/types mappings in /usr/share/applications/defaults.list
@@ -18,12 +15,11 @@
 - Allow to use "extended" INTERPRET tags selectively 
 - With engines that provide a redirection URL for results (eg Acoona), it looks like
   the query hitory is not saved/checked correctly
-- Add Creative Commons (http://search.yahoo.com/cc)
 - Add http://www.patentcommons.org/commons/patentsearch.php
 - Implement AutoDiscovery of OpenSearch Description files (http://opensearch.a9.com/spec/1.1/description/)
-- Support for Google Buttons
 - Make sure Description files' SyndicationRight is not private or closed
 - Export search results as OpenSearch Response
+- Support for Google Buttons
 
 Collect
 - Comply with robot stuff defined at http://www.robotstxt.org/
@@ -34,12 +30,12 @@
 - Allow to cache documents that had to be converted ? eg PDF, MS Word
 - Use poppler for the PDF tokenizer
 - WordPerfect tokenizer with libwpd
+- Spin tokenizers into separate project, a la libextractor
 
 Index
 - Get hold of stopwords lists for the languages supported by Xapian's stemmers and don't index stop words
 - Allow to import and use omindex-produced indexes  so that they can be used like pinot's internal indexes
 - Write a pseudo-filesystem for indexes with FUSE (http://fuse.sourceforge.net/) or gnome-vfs ?
-- Interface with libtranslate (http://www.nongnu.org/libtranslate/) ? :-)
 - Xapian lock files can be deleted at startup if no other instance is running
 - Play around with the XAPIAN_FLUSH_THRESHOLD env var
 - Switch to Xapian's new Flint back-end (set XAPIAN_PREFER_FLINT=1)
@@ -47,8 +43,6 @@
 - Flush the index before searching not after modification
 - Hash document data to determine on updates whether documents have changed
 - Allow to monitor imported documents for changes
-- Flush after a properties update; not doing so seems to prevent abstract generation from working
- correctly, as terms positions can't be obtained
 - Xapian Query objects will become serializable at some point, this will be useful
   for stored queries
 - Think about indexing archives (parent documents) and their contents (child documents)

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2006-05-10 13:07:15 UTC (rev 239)
+++ trunk/configure.in	2006-05-10 14:37:34 UTC (rev 240)
@@ -2,7 +2,7 @@
 # using glademm V2.6.0
 
 AC_PREREQ(2.50)
-AC_INIT(pinot, 0.46,[fabricecolin at users.berlios.de])
+AC_INIT(pinot, 0.47,[fabricecolin at users.berlios.de])
 AM_INIT_AUTOMAKE
 AC_CONFIG_HEADERS(config.h)
 

Modified: trunk/po/es.po
===================================================================
--- trunk/po/es.po	2006-05-10 13:07:15 UTC (rev 239)
+++ trunk/po/es.po	2006-05-10 14:37:34 UTC (rev 240)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.43\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-05-07 13:59+0800\n"
+"POT-Creation-Date: 2006-05-10 10:43+0800\n"
 "PO-Revision-Date: 2006-01-30 16:44+0800\n"
 "Last-Translator: Jes?s Tramullas <jesus at tramullas.com>\n"
 "Language-Team: es <jesus at tramullas.com>\n"
@@ -29,14 +29,14 @@
 #: UI/GTK2/src/mainWindow.cc:1013 UI/GTK2/src/mainWindow.cc:1069
 #: UI/GTK2/src/mainWindow.cc:1089 UI/GTK2/src/mainWindow.cc:1124
 #: UI/GTK2/src/mainWindow.cc:1714 UI/GTK2/src/PinotSettings.cpp:204
-#: UI/GTK2/src/PinotSettings.cpp:976 UI/GTK2/src/PinotSettings.cpp:1032
+#: UI/GTK2/src/PinotSettings.cpp:970 UI/GTK2/src/PinotSettings.cpp:1026
 msgid "My Documents"
 msgstr "Mis documentos"
 
 #: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:381
 #: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:552
 #: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:205
-#: UI/GTK2/src/PinotSettings.cpp:977 UI/GTK2/src/PinotSettings.cpp:1033
+#: UI/GTK2/src/PinotSettings.cpp:971 UI/GTK2/src/PinotSettings.cpp:1027
 #: UI/GTK2/src/prefsDialog_glade.cc:115
 msgid "My Email"
 msgstr "Mi email"
@@ -263,13 +263,13 @@
 msgid "Import Document(s)"
 msgstr "Importar Documento(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1833 UI/GTK2/src/WorkerThreads.cpp:390
-#: UI/GTK2/src/WorkerThreads.cpp:1112
+#: UI/GTK2/src/mainWindow.cc:1833 UI/GTK2/src/WorkerThreads.cpp:386
+#: UI/GTK2/src/WorkerThreads.cpp:1108
 msgid "Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1837 UI/GTK2/src/WorkerThreads.cpp:394
-#: UI/GTK2/src/WorkerThreads.cpp:1116
+#: UI/GTK2/src/mainWindow.cc:1837 UI/GTK2/src/WorkerThreads.cpp:390
+#: UI/GTK2/src/WorkerThreads.cpp:1112
 msgid "doesn't exist"
 msgstr "no existe"
 
@@ -456,10 +456,6 @@
 msgid "Pinot"
 msgstr "Pinot"
 
-#: UI/GTK2/src/pinot.cc:62
-msgid "Couldn't save configuration file"
-msgstr "No se pudo guardar el fichero de configuraci?n"
-
 #: UI/GTK2/src/pinot.cc:156
 msgid "Danish"
 msgstr "Dan?s"
@@ -516,14 +512,6 @@
 msgid "Couldn't create history database"
 msgstr "No se pudo crear la base de datos del hist?rico"
 
-#: UI/GTK2/src/PinotSettings.cpp:108
-msgid "Couldn't create pinot directory at"
-msgstr "No se pudo crear un directorio pinot en"
-
-#: UI/GTK2/src/PinotSettings.cpp:200
-msgid "Failed to parse configuration file"
-msgstr "Fallo en el fichero de configuraci?n"
-
 #: UI/GTK2/src/PinotSettings.cpp:209
 msgid "Important"
 msgstr "Importante"
@@ -536,11 +524,7 @@
 msgid "Personal"
 msgstr "Personal"
 
-#: UI/GTK2/src/PinotSettings.cpp:346
-msgid "Couldn't parse configuration file"
-msgstr "No se pudo procesar el fichero de configuraci?n"
-
-#: UI/GTK2/src/PinotSettings.cpp:802
+#: UI/GTK2/src/PinotSettings.cpp:799
 msgid "Unclassified"
 msgstr "No clasificado"
 
@@ -708,155 +692,104 @@
 msgid "Query parameters"
 msgstr "Par?metros de b?squeda"
 
-#: UI/GTK2/src/WorkerThreads.cpp:369
+#: UI/GTK2/src/WorkerThreads.cpp:365
 msgid "Stopped browsing"
 msgstr "Exploraci?n detenida"
 
-#: UI/GTK2/src/WorkerThreads.cpp:402 UI/GTK2/src/WorkerThreads.cpp:600
-#: UI/GTK2/src/WorkerThreads.cpp:609 UI/GTK2/src/WorkerThreads.cpp:799
-#: UI/GTK2/src/WorkerThreads.cpp:1005 UI/GTK2/src/WorkerThreads.cpp:1124
+#: UI/GTK2/src/WorkerThreads.cpp:398 UI/GTK2/src/WorkerThreads.cpp:596
+#: UI/GTK2/src/WorkerThreads.cpp:605 UI/GTK2/src/WorkerThreads.cpp:795
+#: UI/GTK2/src/WorkerThreads.cpp:1001 UI/GTK2/src/WorkerThreads.cpp:1120
 msgid "Index error on"
 msgstr "Error en el ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:507
+#: UI/GTK2/src/WorkerThreads.cpp:503
 msgid "Stopped querying"
 msgstr "B?squeda detenida"
 
-#: UI/GTK2/src/WorkerThreads.cpp:519
+#: UI/GTK2/src/WorkerThreads.cpp:515
 msgid "Couldn't create search engine"
 msgstr "No se pudo crear el motor de b?squeda"
 
-#: UI/GTK2/src/WorkerThreads.cpp:530
+#: UI/GTK2/src/WorkerThreads.cpp:526
 msgid "Couldn't run query on search engine"
 msgstr "No se pudo ejecutar la b?squeda contra el motor"
 
-#: UI/GTK2/src/WorkerThreads.cpp:546
+#: UI/GTK2/src/WorkerThreads.cpp:542
 msgid "No title"
 msgstr "Sin t?tulo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:591
+#: UI/GTK2/src/WorkerThreads.cpp:587
 msgid "Stopped querying index labels"
 msgstr "Detenida la b?squeda de etiquetas de ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:668
+#: UI/GTK2/src/WorkerThreads.cpp:664
 msgid "Stopped retrieval of"
 msgstr "Detenida la recuperaci?n de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:702
+#: UI/GTK2/src/WorkerThreads.cpp:698
 msgid "Couldn't obtain downloader for protocol"
 msgstr "No se pudo usar un recuperador para el protocolo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:716 UI/GTK2/src/WorkerThreads.cpp:812
+#: UI/GTK2/src/WorkerThreads.cpp:712 UI/GTK2/src/WorkerThreads.cpp:808
 msgid "Couldn't retrieve"
 msgstr "No se pudo descargar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:784
+#: UI/GTK2/src/WorkerThreads.cpp:780
 msgid "Stopped indexing"
 msgstr "Detenida la indizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:835
+#: UI/GTK2/src/WorkerThreads.cpp:831
 msgid "Cannot index document type"
 msgstr "No se pudo indizar el tipo de documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:839
+#: UI/GTK2/src/WorkerThreads.cpp:835
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:863
+#: UI/GTK2/src/WorkerThreads.cpp:859
 msgid "Couldn't tokenize"
 msgstr "No se pudo extraer cadenas"
 
-#: UI/GTK2/src/WorkerThreads.cpp:883
+#: UI/GTK2/src/WorkerThreads.cpp:879
 msgid "Robots META tag forbids indexing"
 msgstr "La etiqueta META Robots proh?be la indizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:938
+#: UI/GTK2/src/WorkerThreads.cpp:934
 msgid "Couldn't index"
 msgstr "No se pudo indizar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:993
+#: UI/GTK2/src/WorkerThreads.cpp:989
 msgid "Stopped unindexing document(s)"
 msgstr "Detenida la des-indizaci?n de documento(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1012
+#: UI/GTK2/src/WorkerThreads.cpp:1008
 msgid "Couldn't unindex document(s)"
 msgstr "No se pudo des-indizar lo(s) documento(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1097
+#: UI/GTK2/src/WorkerThreads.cpp:1093
 msgid "Stopped document update for"
 msgstr "Detenida la actualizaci?n del documento por"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1132
+#: UI/GTK2/src/WorkerThreads.cpp:1128
 msgid "Couldn't update document"
 msgstr "No se pudo actualizar el documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1182
+#: UI/GTK2/src/WorkerThreads.cpp:1178
 msgid "Stopped monitoring"
 msgstr "Detenida la monitorizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1202
+#: UI/GTK2/src/WorkerThreads.cpp:1198
 msgid "No monitoring handler"
 msgstr "No hay monitorizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1245
+#: UI/GTK2/src/WorkerThreads.cpp:1241
 msgid "Couldn't open FAM connection"
 msgstr "No se pudo abrir la conexi?n FAM"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1448
+#: UI/GTK2/src/WorkerThreads.cpp:1444
 msgid "Stopped scanning"
 msgstr "Detenida la exploraci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1606
+#: UI/GTK2/src/WorkerThreads.cpp:1602
 msgid "Couldn't open directory"
 msgstr "No se pudo abrir el directorio"
-
-#~ msgid "Extract:"
-#~ msgstr "Extraer:"
-
-#~ msgid "Advanced"
-#~ msgstr "Avanzado"
-
-#~ msgid "Couldn't load ui block"
-#~ msgstr "No se pudo cargar el bloque ui"
-
-#~ msgid "Couldn't load extraindex block"
-#~ msgstr "No se pudo cargar el bloque extraindex"
-
-#~ msgid "Couldn't load storedquery block"
-#~ msgstr "No se pudo cargar el bloque storedquery"
-
-#~ msgid "Couldn't load results block"
-#~ msgstr "o se pudo cargar el bloque results"
-
-#~ msgid "Couldn't load label block"
-#~ msgstr "o se pudo cargar el bloque label"
-
-#~ msgid "Couldn't load mailaccount block"
-#~ msgstr "No se pudo cargar el bloque mailaccount"
-
-#~ msgid "Red"
-#~ msgstr "Rojo"
-
-#~ msgid "Blue"
-#~ msgstr "Azul"
-
-#~ msgid "Green"
-#~ msgstr "Verde"
-
-#~ msgid "Colour"
-#~ msgstr "Color"
-
-#~ msgid "No label"
-#~ msgstr "Sin etiqueta"
-
-#~ msgid "matches"
-#~ msgstr "correspondencias"
-
-#~ msgid "document(s)"
-#~ msgstr "documento(s)"
-
-#~ msgid "Stopped listening on"
-#~ msgstr "Detenida la escucha en"
-
-#~ msgid "Couldn't read FIFO at"
-#~ msgstr "No se pudo leer FIFO en"

Modified: trunk/po/fr.po
===================================================================
--- trunk/po/fr.po	2006-05-10 13:07:15 UTC (rev 239)
+++ trunk/po/fr.po	2006-05-10 14:37:34 UTC (rev 240)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.43\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-05-07 13:59+0800\n"
+"POT-Creation-Date: 2006-05-10 10:43+0800\n"
 "PO-Revision-Date: 2006-01-20 19:44+0800\n"
 "Last-Translator: Fabrice Colin <colinf at chez.com>\n"
 "Language-Team: fr <colinf at chez.com>\n"
@@ -29,14 +29,14 @@
 #: UI/GTK2/src/mainWindow.cc:1013 UI/GTK2/src/mainWindow.cc:1069
 #: UI/GTK2/src/mainWindow.cc:1089 UI/GTK2/src/mainWindow.cc:1124
 #: UI/GTK2/src/mainWindow.cc:1714 UI/GTK2/src/PinotSettings.cpp:204
-#: UI/GTK2/src/PinotSettings.cpp:976 UI/GTK2/src/PinotSettings.cpp:1032
+#: UI/GTK2/src/PinotSettings.cpp:970 UI/GTK2/src/PinotSettings.cpp:1026
 msgid "My Documents"
 msgstr "Mes Documents"
 
 #: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:381
 #: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:552
 #: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:205
-#: UI/GTK2/src/PinotSettings.cpp:977 UI/GTK2/src/PinotSettings.cpp:1033
+#: UI/GTK2/src/PinotSettings.cpp:971 UI/GTK2/src/PinotSettings.cpp:1027
 #: UI/GTK2/src/prefsDialog_glade.cc:115
 msgid "My Email"
 msgstr "Mon Courrier"
@@ -263,13 +263,13 @@
 msgid "Import Document(s)"
 msgstr "Import de Document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1833 UI/GTK2/src/WorkerThreads.cpp:390
-#: UI/GTK2/src/WorkerThreads.cpp:1112
+#: UI/GTK2/src/mainWindow.cc:1833 UI/GTK2/src/WorkerThreads.cpp:386
+#: UI/GTK2/src/WorkerThreads.cpp:1108
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:1837 UI/GTK2/src/WorkerThreads.cpp:394
-#: UI/GTK2/src/WorkerThreads.cpp:1116
+#: UI/GTK2/src/mainWindow.cc:1837 UI/GTK2/src/WorkerThreads.cpp:390
+#: UI/GTK2/src/WorkerThreads.cpp:1112
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
@@ -456,10 +456,6 @@
 msgid "Pinot"
 msgstr "Pinot"
 
-#: UI/GTK2/src/pinot.cc:62
-msgid "Couldn't save configuration file"
-msgstr "N'a pas pu sauve le fichier de configuration"
-
 #: UI/GTK2/src/pinot.cc:156
 msgid "Danish"
 msgstr "Danois"
@@ -516,14 +512,6 @@
 msgid "Couldn't create history database"
 msgstr "N'a pas pu creer la base d'historiques"
 
-#: UI/GTK2/src/PinotSettings.cpp:108
-msgid "Couldn't create pinot directory at"
-msgstr "N'a pas pu creer le repertoire a"
-
-#: UI/GTK2/src/PinotSettings.cpp:200
-msgid "Failed to parse configuration file"
-msgstr "N'a pas pu lire le fichier de configuration"
-
 #: UI/GTK2/src/PinotSettings.cpp:209
 msgid "Important"
 msgstr "Important"
@@ -536,11 +524,7 @@
 msgid "Personal"
 msgstr "Personnel"
 
-#: UI/GTK2/src/PinotSettings.cpp:346
-msgid "Couldn't parse configuration file"
-msgstr "N'a pas pu lire le fichier de configuration"
-
-#: UI/GTK2/src/PinotSettings.cpp:802
+#: UI/GTK2/src/PinotSettings.cpp:799
 msgid "Unclassified"
 msgstr "Sans classification"
 
@@ -708,107 +692,104 @@
 msgid "Query parameters"
 msgstr "Parametres de la recherche"
 
-#: UI/GTK2/src/WorkerThreads.cpp:369
+#: UI/GTK2/src/WorkerThreads.cpp:365
 msgid "Stopped browsing"
 msgstr "Arrete de parcourir l'index"
 
-#: UI/GTK2/src/WorkerThreads.cpp:402 UI/GTK2/src/WorkerThreads.cpp:600
-#: UI/GTK2/src/WorkerThreads.cpp:609 UI/GTK2/src/WorkerThreads.cpp:799
-#: UI/GTK2/src/WorkerThreads.cpp:1005 UI/GTK2/src/WorkerThreads.cpp:1124
+#: UI/GTK2/src/WorkerThreads.cpp:398 UI/GTK2/src/WorkerThreads.cpp:596
+#: UI/GTK2/src/WorkerThreads.cpp:605 UI/GTK2/src/WorkerThreads.cpp:795
+#: UI/GTK2/src/WorkerThreads.cpp:1001 UI/GTK2/src/WorkerThreads.cpp:1120
 msgid "Index error on"
 msgstr "Erreur sur l'index"
 
-#: UI/GTK2/src/WorkerThreads.cpp:507
+#: UI/GTK2/src/WorkerThreads.cpp:503
 msgid "Stopped querying"
 msgstr "Arrete la recherche"
 
-#: UI/GTK2/src/WorkerThreads.cpp:519
+#: UI/GTK2/src/WorkerThreads.cpp:515
 msgid "Couldn't create search engine"
 msgstr "N'a pas pu creer le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:530
+#: UI/GTK2/src/WorkerThreads.cpp:526
 msgid "Couldn't run query on search engine"
 msgstr "N'a pas pu lancer la recherche sur le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:546
+#: UI/GTK2/src/WorkerThreads.cpp:542
 msgid "No title"
 msgstr "Pas de titre"
 
-#: UI/GTK2/src/WorkerThreads.cpp:591
+#: UI/GTK2/src/WorkerThreads.cpp:587
 msgid "Stopped querying index labels"
 msgstr "Arrete la recherche d'etiquettes"
 
-#: UI/GTK2/src/WorkerThreads.cpp:668
+#: UI/GTK2/src/WorkerThreads.cpp:664
 msgid "Stopped retrieval of"
 msgstr "Arrete le telechargement de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:702
+#: UI/GTK2/src/WorkerThreads.cpp:698
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N'a pas pu obtenir un brouteur pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:716 UI/GTK2/src/WorkerThreads.cpp:812
+#: UI/GTK2/src/WorkerThreads.cpp:712 UI/GTK2/src/WorkerThreads.cpp:808
 msgid "Couldn't retrieve"
 msgstr "N'a pas pu telecharger"
 
-#: UI/GTK2/src/WorkerThreads.cpp:784
+#: UI/GTK2/src/WorkerThreads.cpp:780
 msgid "Stopped indexing"
 msgstr "Arrete l'indexation"
 
-#: UI/GTK2/src/WorkerThreads.cpp:835
+#: UI/GTK2/src/WorkerThreads.cpp:831
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer ce type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:839
+#: UI/GTK2/src/WorkerThreads.cpp:835
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:863
+#: UI/GTK2/src/WorkerThreads.cpp:859
 msgid "Couldn't tokenize"
 msgstr "N'a pas pu extraire les termes de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:883
+#: UI/GTK2/src/WorkerThreads.cpp:879
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots interdit d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:938
+#: UI/GTK2/src/WorkerThreads.cpp:934
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:993
+#: UI/GTK2/src/WorkerThreads.cpp:989
 msgid "Stopped unindexing document(s)"
 msgstr "Arrete d'indexer les document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1012
+#: UI/GTK2/src/WorkerThreads.cpp:1008
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1097
+#: UI/GTK2/src/WorkerThreads.cpp:1093
 msgid "Stopped document update for"
 msgstr "Arrete la mise a jour pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1132
+#: UI/GTK2/src/WorkerThreads.cpp:1128
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1182
+#: UI/GTK2/src/WorkerThreads.cpp:1178
 msgid "Stopped monitoring"
 msgstr "Arrete la surveillance"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1202
+#: UI/GTK2/src/WorkerThreads.cpp:1198
 msgid "No monitoring handler"
 msgstr "Pas de moniteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1245
+#: UI/GTK2/src/WorkerThreads.cpp:1241
 msgid "Couldn't open FAM connection"
 msgstr "N'a pas pu ouvrir la connection FAM"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1448
+#: UI/GTK2/src/WorkerThreads.cpp:1444
 msgid "Stopped scanning"
 msgstr "Arrete de scanner"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1606
+#: UI/GTK2/src/WorkerThreads.cpp:1602
 msgid "Couldn't open directory"
 msgstr "N'a pas pu ouvrir le repertoire"
-
-#~ msgid "Extract:"
-#~ msgstr "Extrait:"



From fabricecolin at berlios.de  Fri May 12 05:04:13 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 12 May 2006 05:04:13 +0200
Subject: [Pinot-svn] r242 - tags
Message-ID: <200605120304.k4C34Dcx019575@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-12 05:03:45 +0200 (Fri, 12 May 2006)
New Revision: 242

Added:
   tags/version_0_4_7/
Log:
v0.47 release.


Copied: tags/version_0_4_7 (from rev 241, trunk)



From fabricecolin at berlios.de  Fri May 12 05:01:21 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 12 May 2006 05:01:21 +0200
Subject: [Pinot-svn] r241 - trunk
Message-ID: <200605120301.k4C31LOM018913@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-12 05:01:19 +0200 (Fri, 12 May 2006)
New Revision: 241

Modified:
   trunk/NEWS
Log:
Releasing 0.47 today.


Modified: trunk/NEWS
===================================================================
--- trunk/NEWS	2006-05-10 14:37:34 UTC (rev 240)
+++ trunk/NEWS	2006-05-12 03:01:19 UTC (rev 241)
@@ -1,4 +1,4 @@
-??? version_0_4_7
+2006/05/12 version_0_4_7
 General :
  - all programs have man pages and support --help and --version
 Search :
@@ -11,7 +11,7 @@
  - allow editing the language of documents. A subsequent update would use the
   given language to stem terms.
 
-2006/03/22 version_0_4_6
+2006/04/22 version_0_4_6
 Search :
  - resurrected support for the Google API, enabled with "./configure --with-soap=yes".
   This requires the gsoap development toolkit.



From fabricecolin at berlios.de  Mon May 15 16:15:03 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 15 May 2006 16:15:03 +0200
Subject: [Pinot-svn] r243 - trunk/UI/GTK2/src
Message-ID: <200605151415.k4FEF33i023061@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-15 16:15:01 +0200 (Mon, 15 May 2006)
New Revision: 243

Modified:
   trunk/UI/GTK2/src/IndexTree.cpp
   trunk/UI/GTK2/src/IndexTree.h
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
Log:
Fixed menuitem state inconsistencies when switching and closing tabs.
Removed unused methods in Index and ResultsTree classes.


Modified: trunk/UI/GTK2/src/IndexTree.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexTree.cpp	2006-05-12 03:03:45 UTC (rev 242)
+++ trunk/UI/GTK2/src/IndexTree.cpp	2006-05-15 14:15:01 UTC (rev 243)
@@ -86,7 +86,6 @@
 
 	// Enable interactive search
 	set_search_column(m_indexColumns.m_text.index());
-	set_search_equal_func(SigC::slot(*this, &IndexTree::onSearchEqual));
 	// Control which rows can be selected
 	get_selection()->set_select_function(SigC::slot(*this, &IndexTree::onSelectionSelect));
 
@@ -128,11 +127,6 @@
 	m_signalSelectionChanged(m_indexName);
 }
 
-bool IndexTree::onSearchEqual(const RefPtr<TreeModel>& model, int column,
-	const ustring& key, const TreeModel::iterator& iter)
-{
-}
-
 bool IndexTree::onSelectionSelect(const RefPtr<TreeModel>& model,
 		const TreeModel::Path& path, bool path_currently_selected)
 {

Modified: trunk/UI/GTK2/src/IndexTree.h
===================================================================
--- trunk/UI/GTK2/src/IndexTree.h	2006-05-12 03:03:45 UTC (rev 242)
+++ trunk/UI/GTK2/src/IndexTree.h	2006-05-15 14:15:01 UTC (rev 243)
@@ -102,9 +102,6 @@
 
 		void onSelectionChanged(void);
 
-		bool onSearchEqual(const Glib::RefPtr<Gtk::TreeModel>& model, int column,
-			const Glib::ustring& key, const Gtk::TreeModel::iterator& iter);
-
 		bool onSelectionSelect(const Glib::RefPtr<Gtk::TreeModel>& model,
 			const Gtk::TreeModel::Path& path, bool path_currently_selected);
 

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-12 03:03:45 UTC (rev 242)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-15 14:15:01 UTC (rev 243)
@@ -140,7 +140,6 @@
 
 	// Enable interactive search
 	set_search_column(m_resultsColumns.m_text.index());
-	set_search_equal_func(SigC::slot(*this, &ResultsTree::onSearchEqual));
 	// Control which rows can be selected
 	get_selection()->set_select_function(SigC::slot(*this, &ResultsTree::onSelectionSelect));
 	// Listen for style changes
@@ -311,11 +310,6 @@
 	m_signalSelectionChanged(m_queryName);
 }
 
-bool ResultsTree::onSearchEqual(const RefPtr<TreeModel>& model, int column,
-	const ustring& key, const TreeModel::iterator& iter)
-{
-}
-
 bool ResultsTree::onSelectionSelect(const RefPtr<TreeModel>& model,
 		const TreeModel::Path& path, bool path_currently_selected)
 {

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2006-05-12 03:03:45 UTC (rev 242)
+++ trunk/UI/GTK2/src/ResultsTree.h	2006-05-15 14:15:01 UTC (rev 243)
@@ -123,9 +123,6 @@
 
 		void onSelectionChanged(void);
 
-		bool onSearchEqual(const Glib::RefPtr<Gtk::TreeModel>& model, int column,
-			const Glib::ustring& key, const Gtk::TreeModel::iterator& iter);
-
 		bool onSelectionSelect(const Glib::RefPtr<Gtk::TreeModel>& model,
 			const Gtk::TreeModel::Path& path, bool path_currently_selected);
 

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-05-12 03:03:45 UTC (rev 242)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-05-15 14:15:01 UTC (rev 243)
@@ -219,25 +219,14 @@
 	editQueryButton->set_sensitive(false);
 	removeQueryButton->set_sensitive(false);
 	findQueryButton->set_sensitive(false);
-	clearresults1->set_sensitive(false);
-	showextract1->set_sensitive(false);
-	groupresults1->set_sensitive(false);
-	viewresults1->set_sensitive(false);
+	show_global_menuitems(false);
+	show_selectionbased_menuitems(false);
 	// Hide the View Cache menu item ?
 	if ((SearchEngineFactory::isSupported("googleapi") == false) ||
 		(m_settings.m_googleAPIKey.empty() == true))
 	{
 		viewcache1->hide();
 	}
-	else
-	{
-		viewcache1->set_sensitive(false);
-	}
-	indexresults1->set_sensitive(false);
-	viewfromindex1->set_sensitive(false);
-	refreshindex1->set_sensitive(false);
-	unindex1->set_sensitive(false);
-	showfromindex1->set_sensitive(false);
 	//viewstop1->set_sensitive(false);
 	// ...and buttons
 	removeIndexButton->set_sensitive(false);
@@ -675,40 +664,38 @@
 //
 void mainWindow::on_switch_page(GtkNotebookPage *p0, guint p1)
 {
-	// Did the page change ?
-	if (m_state.m_currentPage != p1)
+	bool showResultsMenuitems = false;
+
+	NotebookPageBox *pNotebookPage = dynamic_cast<NotebookPageBox*>(m_pNotebook->get_nth_page(p1));
+	if (pNotebookPage != NULL)
 	{
-		bool showResultsMenuitems = false;
-
-		NotebookPageBox *pNotebookPage = dynamic_cast<NotebookPageBox*>(m_pNotebook->get_nth_page(p1));
-		if (pNotebookPage != NULL)
+		NotebookPageBox::PageType type = pNotebookPage->getType();
+		if (type == NotebookPageBox::RESULTS_PAGE)
 		{
-			NotebookPageBox::PageType type = pNotebookPage->getType();
-			if (type == NotebookPageBox::RESULTS_PAGE)
+			// Show or hide the extract field
+			ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
+			if (pResultsPage != NULL)
 			{
-				showResultsMenuitems = true;
+				ResultsTree *pResultsTree = pResultsPage->getTree();
+				if (pResultsTree != NULL)
+				{
+					pResultsTree->showExtract(showextract1->get_active());
+				}
 			}
+
+			showResultsMenuitems = true;
+		}
 #ifdef DEBUG
-			cout << "mainWindow::on_switch_page: switched to page " << p1
-				<< ", type " << type << endl;
+		cout << "mainWindow::on_switch_page: page " << p1 << " has type " << type << endl;
 #endif
-		}
+	}
 
-		// Results menuitems that depend on the page
-		clearresults1->set_sensitive(showResultsMenuitems);
-		showextract1->set_sensitive(showResultsMenuitems);
-		groupresults1->set_sensitive(showResultsMenuitems);
+	show_global_menuitems(showResultsMenuitems);
 
-		// Results menuitems that depend on selection
-		viewresults1->set_sensitive(false);
-		viewcache1->set_sensitive(false);
-		indexresults1->set_sensitive(false);
-
-		// Index menuitems that depend on selection
-		viewfromindex1->set_sensitive(false);
-		refreshindex1->set_sensitive(false);
-		unindex1->set_sensitive(false);
-		showfromindex1->set_sensitive(false);
+	// Did the page change ?
+	if (m_state.m_currentPage != p1)
+	{
+		show_selectionbased_menuitems(false);
 	}
 	m_state.m_currentPage = (int)p1;
 }
@@ -718,6 +705,8 @@
 //
 void mainWindow::on_close_page(ustring title, NotebookPageBox::PageType type)
 {
+	int pageDecrement = 0;
+
 #ifdef DEBUG
 	cout << "mainWindow::on_close_page: called for tab " << title << endl;
 #endif
@@ -734,6 +723,7 @@
 			if (pPage != NULL)
 			{
 				pPage->hide();
+				pageDecrement = 1;
 			}
 		}
 		else if (m_state.write_lock_lists(2) == true)
@@ -744,6 +734,12 @@
 			m_state.unlock_lists();
 		}
 	}
+
+	if (m_pNotebook->get_n_pages() - pageDecrement <= 0)
+	{
+		show_global_menuitems(false);
+		show_selectionbased_menuitems(false);
+	}
 }
 
 //
@@ -890,6 +886,8 @@
 			// Position the results tree
 			pResultsTree = manage(new ResultsTree(queryName, resultsMenuitem->get_submenu(), m_settings));
 			pResultsPage = manage(new ResultsPage(queryName, pResultsTree, m_pNotebook->get_height(), m_settings));
+			// Show or hide the extract field
+			pResultsTree->showExtract(showextract1->get_active());
 			// Connect to the "changed" signal
 			pResultsTree->getSelectionChangedSignal().connect(
 				SigC::slot(*this, &mainWindow::on_resultsTreeviewSelection_changed));
@@ -2397,6 +2395,34 @@
 }
 
 //
+// Show or hide menuitems.
+//
+void mainWindow::show_global_menuitems(bool showItems)
+{
+	// Results menuitems that depend on the page
+	clearresults1->set_sensitive(showItems);
+	showextract1->set_sensitive(showItems);
+	groupresults1->set_sensitive(showItems);
+}
+
+//
+// Show or hide menuitems.
+//
+void mainWindow::show_selectionbased_menuitems(bool showItems)
+{
+	// Results menuitems that depend on selection
+	viewresults1->set_sensitive(false);
+	viewcache1->set_sensitive(false);
+	indexresults1->set_sensitive(false);
+
+	// Index menuitems that depend on selection
+	viewfromindex1->set_sensitive(false);
+	refreshindex1->set_sensitive(false);
+	unindex1->set_sensitive(false);
+	showfromindex1->set_sensitive(false);
+}
+
+//
 // Returns the current page.
 //
 NotebookPageBox *mainWindow::get_current_page(void)

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2006-05-12 03:03:45 UTC (rev 242)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-05-15 14:15:01 UTC (rev 243)
@@ -118,6 +118,8 @@
 	virtual bool on_mainWindow_delete_event(GdkEventAny *ev);
 
 	// Action methods
+	void show_global_menuitems(bool showItems);
+	void show_selectionbased_menuitems(bool showItems);
 	NotebookPageBox *get_current_page(void);
 	NotebookPageBox *get_page(const Glib::ustring &title,
 		NotebookPageBox::PageType type);



From fabricecolin at berlios.de  Wed May 17 02:05:29 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 17 May 2006 02:05:29 +0200
Subject: [Pinot-svn] r244 - in trunk: . Monitor
Message-ID: <200605170005.k4H05TuJ010830@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-17 02:05:04 +0200 (Wed, 17 May 2006)
New Revision: 244

Added:
   trunk/Monitor/
   trunk/Monitor/INotifyMonitor.cpp
   trunk/Monitor/INotifyMonitor.h
   trunk/Monitor/Makefile.am
   trunk/Monitor/MonitorEvent.cpp
   trunk/Monitor/MonitorEvent.h
   trunk/Monitor/MonitorInterface.h
Modified:
   trunk/Makefile.am
   trunk/configure.in
Log:
First shot at an inotify-based file monitor.


Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2006-05-15 14:15:01 UTC (rev 243)
+++ trunk/Makefile.am	2006-05-17 00:05:04 UTC (rev 244)
@@ -1,7 +1,7 @@
 # generated 2005/12/14 20:48:47 SGT by fabrice at amra.dyndns.org.(none)
 # using glademm V2.6.0
 
-SUBDIRS = po Utils Tokenize SQL Collect @SOAP_SUBDIRS@ Search \
+SUBDIRS = po Utils Tokenize SQL Monitor Collect @SOAP_SUBDIRS@ Search \
 	Index UI/RenderHTML UI/GTK2/src
 
 EXTRA_DIST = ChangeLog NEWS README TODO mkinstalldirs pinot.desktop \

Added: trunk/Monitor/INotifyMonitor.cpp
===================================================================
--- trunk/Monitor/INotifyMonitor.cpp	2006-05-15 14:15:01 UTC (rev 243)
+++ trunk/Monitor/INotifyMonitor.cpp	2006-05-17 00:05:04 UTC (rev 244)
@@ -0,0 +1,189 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <sys/inotify.h>
+#include <iostream>
+
+#include "INotifyMonitor.h"
+
+using std::string;
+using std::map;
+using std::set;
+using std::pair;
+using std::cout;
+using std::cerr;
+using std::endl;
+
+INotifyMonitor::INotifyMonitor() :
+	MonitorInterface()
+{
+	m_monitorFd = inotify_init();
+}
+
+INotifyMonitor::~INotifyMonitor()
+{
+}
+
+/// Starts monitoring a directory.
+bool INotifyMonitor::addDirectory(const string &directory)
+{
+	uint32_t eventsMask = IN_CLOSE_WRITE|IN_MOVE|IN_CREATE|IN_DELETE|IN_DELETE_SELF|IN_MOVE_SELF;
+
+	if ((directory.empty() == true) ||
+		(directory == "/") ||
+		(m_monitorFd < 0))
+	{
+		return false;
+	}
+
+	// FIXME: check the maximum number of watches hasn't been reached (MAX_FILE_WATCHES ?)
+	int dirWd = inotify_add_watch(m_monitorFd, directory.c_str(), eventsMask);
+	if (dirWd >= 0)
+	{
+		m_watches.insert(pair<string, int>(directory, dirWd));
+
+		return true;
+	}
+	cerr << "INotifyMonitor::addDirectory: couldn't monitor " << directory << endl;
+
+	return false;
+}
+
+/// Stops monitoring a directory.
+bool INotifyMonitor::removeDirectory(const string &directory)
+{
+	if ((directory.empty() == true) ||
+		(m_monitorFd < 0))
+	{
+		return false;
+	}
+
+	map<string, int>::iterator watchIter = m_watches.find(directory);
+	if (watchIter != m_watches.end())
+	{
+		inotify_rm_watch(m_monitorFd, watchIter->second);
+		m_watches.erase(watchIter);
+
+		return true;
+	}
+	cerr << "INotifyMonitor::removeDirectory: " << directory << " is not being monitored" << endl;
+
+	return false;
+}
+
+/// Retrieves pending events.
+bool INotifyMonitor::retrievePendingEvents(set<MonitorEvent> &events)
+{
+	char buffer[1024];
+	size_t offset = 0;
+
+	if (m_monitorFd < 0)
+	{
+		return false;
+	}
+
+	int bytesRead = read(m_monitorFd, buffer, 1024); 
+	while (bytesRead - offset > 0)
+	{
+		struct inotify_event *pEvent = (struct inotify_event *)(buffer + offset);
+		size_t eventSize = sizeof(struct inotify_event) + pEvent->len;
+
+		// The length includes the terminating NULL
+		if (pEvent->len > 1)
+		{
+			MonitorEvent monEvent;
+			map<uint32_t, string>::iterator iter = m_movedFrom.end();
+
+			// Get the whole event structure
+			pEvent = (struct inotify_event *)malloc(eventSize);
+			if (pEvent != NULL)
+			{
+				memmove((void *)pEvent, (const void *)(buffer + offset), eventSize);
+				monEvent.m_location = pEvent->name;
+			}
+			if (pEvent->mask & IN_ISDIR)
+			{
+				monEvent.m_isDirectory = true;
+			}
+#ifdef DEBUG
+			cout << "INotifyMonitor::retrievePendingEvents: event on "
+				<< monEvent.m_location << endl;
+#endif
+
+			// What type of event ?
+			switch (pEvent->mask)
+			{
+				case IN_CREATE:
+					// Skip regular files
+					if (monEvent.m_isDirectory == true)
+					{
+						monEvent.m_type = MonitorEvent::CREATED;
+					}
+					break;
+				case IN_CLOSE_WRITE:
+					monEvent.m_type = MonitorEvent::WRITE_CLOSED;
+					break;
+				case IN_MOVED_FROM:
+					// Store this until we receive a IN_MOVED_TO event
+					m_movedFrom.insert(pair<uint32_t, string>(pEvent->cookie, monEvent.m_location));
+					break;
+				case IN_MOVED_TO:
+					// What was the previous location ?
+					iter = m_movedFrom.find(pEvent->cookie);
+					if (iter != m_movedFrom.end())
+					{
+						monEvent.m_previousLocation = iter->second;
+						monEvent.m_type = MonitorEvent::MOVED;
+
+						if (monEvent.m_isDirectory == true)
+						{
+							// We can already stop watching the old directory
+							if (removeDirectory(monEvent.m_previousLocation) == true)
+							{
+								// ...and watch this one instead
+								addDirectory(monEvent.m_location);
+							}
+						}
+						m_movedFrom.erase(iter);
+					}
+#ifdef DEBUG
+					else cout << "INotifyMonitor::retrievePendingEvents: don't know where file was moved from" << endl;
+#endif
+					break;
+				case IN_DELETE_SELF:
+					monEvent.m_type = MonitorEvent::DELETED;
+					break;
+				default:
+#ifdef DEBUG
+					cout << "INotifyMonitor::retrievePendingEvents: ignoring event" << endl;
+#endif
+					break;
+			}
+
+			free(pEvent);
+
+			// Return event ?
+			if (monEvent.m_type != MonitorEvent::UNKNOWN)
+			{
+				events.insert(monEvent);
+			}
+		}
+
+		offset += eventSize;
+	}
+
+	return true;
+}


Property changes on: trunk/Monitor/INotifyMonitor.cpp
___________________________________________________________________
Name: svn:executable
   + *

Added: trunk/Monitor/INotifyMonitor.h
===================================================================
--- trunk/Monitor/INotifyMonitor.h	2006-05-15 14:15:01 UTC (rev 243)
+++ trunk/Monitor/INotifyMonitor.h	2006-05-17 00:05:04 UTC (rev 244)
@@ -0,0 +1,52 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _INOTIFY_MONITOR_H
+#define _INOTIFY_MONITOR_H
+
+#include <string>
+#include <map>
+#include <set>
+
+#include "MonitorEvent.h"
+#include "MonitorInterface.h"
+
+class INotifyMonitor : public MonitorInterface
+{
+	public:
+		INotifyMonitor();
+		virtual ~INotifyMonitor();
+
+		/// Adds a watch for the specified directory.
+		virtual bool addDirectory(const std::string &directory);
+
+		/// Removed the watch for the specified directory.
+		virtual bool removeDirectory(const std::string &directory);
+
+		/// Retrieves pending events.
+		virtual bool retrievePendingEvents(std::set<MonitorEvent> &events);
+
+	protected:
+		std::map<std::string, int> m_watches;
+		std::map<uint32_t, std::string> m_movedFrom;
+
+	private:
+		INotifyMonitor(const INotifyMonitor &other);
+		INotifyMonitor &operator=(const INotifyMonitor &other);
+
+};
+
+#endif // _INOTIFY_MONITOR_H


Property changes on: trunk/Monitor/INotifyMonitor.h
___________________________________________________________________
Name: svn:executable
   + *

Added: trunk/Monitor/Makefile.am
===================================================================
--- trunk/Monitor/Makefile.am	2006-05-15 14:15:01 UTC (rev 243)
+++ trunk/Monitor/Makefile.am	2006-05-17 00:05:04 UTC (rev 244)
@@ -0,0 +1,15 @@
+# Process this file with automake to produce Makefile.in
+
+noinst_HEADERS = \
+	INotifyMonitor.h \
+	MonitorEvent.h \
+	MonitorInterface.h
+
+noinst_LTLIBRARIES = libMonitor.la
+
+libMonitor_la_SOURCES = \
+	INotifyMonitor.cpp \
+	MonitorEvent.cpp
+
+AM_CXXFLAGS = -I../Utils
+

Added: trunk/Monitor/MonitorEvent.cpp
===================================================================
--- trunk/Monitor/MonitorEvent.cpp	2006-05-15 14:15:01 UTC (rev 243)
+++ trunk/Monitor/MonitorEvent.cpp	2006-05-17 00:05:04 UTC (rev 244)
@@ -0,0 +1,58 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include "TimeConverter.h"
+#include "MonitorEvent.h"
+
+using std::string;
+
+MonitorEvent::MonitorEvent() :
+	m_type(UNKNOWN),
+	m_isDirectory(false)
+{
+}
+
+MonitorEvent::MonitorEvent(const MonitorEvent &other)
+{
+	m_location = other.m_location;
+	m_previousLocation = other.m_previousLocation;
+	m_type = other.m_type;
+	m_isDirectory = other.m_isDirectory;
+}
+
+MonitorEvent::~MonitorEvent()
+{
+}
+
+MonitorEvent& MonitorEvent::operator=(const MonitorEvent& other)
+{
+	m_location = other.m_location;
+	m_previousLocation = other.m_previousLocation;
+	m_type = other.m_type;
+	m_isDirectory = other.m_isDirectory;
+
+	return *this;
+}
+
+bool MonitorEvent::operator<(const MonitorEvent& other) const
+{
+	if (m_location < other.m_location)
+	{
+		return true;
+	}
+
+	return false;
+}

Added: trunk/Monitor/MonitorEvent.h
===================================================================
--- trunk/Monitor/MonitorEvent.h	2006-05-15 14:15:01 UTC (rev 243)
+++ trunk/Monitor/MonitorEvent.h	2006-05-17 00:05:04 UTC (rev 244)
@@ -0,0 +1,42 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _MONITOR_EVENT_H
+#define _MONITOR_EVENT_H
+
+#include <string>
+
+class MonitorEvent
+{
+	public:
+		MonitorEvent();
+		MonitorEvent(const MonitorEvent &other);
+		virtual ~MonitorEvent();
+
+		MonitorEvent& operator=(const MonitorEvent& other);
+
+		bool operator<(const MonitorEvent& other) const;
+
+		typedef enum { UNKNOWN = 0, CREATED, WRITE_CLOSED, MOVED, DELETED } EventType;
+
+		std::string m_location;
+		std::string m_previousLocation;
+		EventType m_type;
+		bool m_isDirectory;
+
+};
+
+#endif // _MONITOR_EVENT_H

Added: trunk/Monitor/MonitorInterface.h
===================================================================
--- trunk/Monitor/MonitorInterface.h	2006-05-15 14:15:01 UTC (rev 243)
+++ trunk/Monitor/MonitorInterface.h	2006-05-17 00:05:04 UTC (rev 244)
@@ -0,0 +1,58 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _MONITOR_INTERFACE_H
+#define _MONITOR_INTERFACE_H
+
+#include <string>
+#include <map>
+#include <set>
+
+class MonitorInterface
+{
+	public:
+		virtual ~MonitorInterface();
+
+		/// Returns the file descriptor to poll for events.
+		virtual int getFileDescriptor(void) const
+		{
+			return m_monitorFd;
+		}
+
+		/// Adds a watch for the specified directory.
+		virtual bool addDirectory(const std::string &directory) = 0;
+
+		/// Removed the watch for the specified directory.
+		virtual bool removeDirectory(const std::string &directory) = 0;
+
+		/// Retrieves pending events.
+		virtual bool retrievePendingEvents(std::set<MonitorEvent> &events);
+
+	protected:
+		int m_monitorFd;
+
+		MonitorInterface() :
+			m_monitorFd(-1)
+		{
+		}
+
+	private:
+		MonitorInterface(const MonitorInterface &other);
+		MonitorInterface &operator=(const MonitorInterface &other);
+
+};
+
+#endif // _MONITOR_INTERFACE_H


Property changes on: trunk/Monitor/MonitorInterface.h
___________________________________________________________________
Name: svn:executable
   + *

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2006-05-15 14:15:01 UTC (rev 243)
+++ trunk/configure.in	2006-05-17 00:05:04 UTC (rev 244)
@@ -187,7 +187,7 @@
 AC_CHECK_FUNCS(mmap)
 
 AC_OUTPUT( pinot.spec Makefile Utils/Makefile Tokenize/Makefile )
-AC_OUTPUT( SQL/Makefile po/Makefile.in Collect/Makefile )
+AC_OUTPUT( SQL/Makefile po/Makefile.in Monitor/Makefile Collect/Makefile )
 if test "$SOAP_SUBDIRS" != "" ; then
   AC_OUTPUT( Search/Google/Makefile )
 fi



From fabricecolin at berlios.de  Wed May 17 02:07:36 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 17 May 2006 02:07:36 +0200
Subject: [Pinot-svn] r245 - trunk/Index
Message-ID: <200605170007.k4H07ae4011453@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-17 02:07:20 +0200 (Wed, 17 May 2006)
New Revision: 245

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/Index/XapianIndex.h
Log:
On update, don't attempt to detect the document's language if one is provided.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-05-17 00:05:04 UTC (rev 244)
+++ trunk/Index/XapianIndex.cpp	2006-05-17 00:07:20 UTC (rev 245)
@@ -219,7 +219,7 @@
 	return true;
 }
 
-void XapianIndex::scanDocument(const char *pData, unsigned int dataLength,
+string XapianIndex::scanDocument(const char *pData, unsigned int dataLength,
 	DocumentInfo &info)
 {
 	vector<string> candidates;
@@ -250,23 +250,14 @@
 		language = *langIter;
 		break;
 	}
-	m_stemLanguage = language;
 #ifdef DEBUG
-	cout << "XapianIndex::scanDocument: language now " << m_stemLanguage << endl;
+	cout << "XapianIndex::scanDocument: language " << language << endl;
 #endif
 
 	// Update the document's properties
-	string title = info.getTitle();
-	if (title.empty() == true)
-	{
-		// Remove heading spaces
-		while (isspace(title[0]))
-		{
-			title.erase(0, 1);
-		}
-		info.setTitle(title);
-	}
-	info.setLanguage(m_stemLanguage);
+	info.setLanguage(language);
+
+	return language;
 }
 
 void XapianIndex::setDocumentData(Xapian::Document &doc, const DocumentInfo &info,
@@ -414,7 +405,7 @@
 		docInfo.setTimestamp(pDocument->getTimestamp());
 		docInfo.setLocation(Url::canonicalizeUrl(docInfo.getLocation()));
 
-		scanDocument(pData, dataLength, docInfo);
+		m_stemLanguage = scanDocument(pData, dataLength, docInfo);
 
 		Xapian::Document doc;
 		Xapian::termcount termPos = 0;
@@ -641,7 +632,12 @@
 	docInfo.setTimestamp(pDocument->getTimestamp());
 	docInfo.setLocation(Url::canonicalizeUrl(docInfo.getLocation()));
 
-	scanDocument(pData, dataLength, docInfo);
+	// Don't scan the document if a language is specified
+	m_stemLanguage = pDocument->getLanguage();
+	if (m_stemLanguage.empty() == true)
+	{
+		m_stemLanguage = scanDocument(pData, dataLength, docInfo);
+	}
 
 	try
 	{

Modified: trunk/Index/XapianIndex.h
===================================================================
--- trunk/Index/XapianIndex.h	2006-05-17 00:05:04 UTC (rev 244)
+++ trunk/Index/XapianIndex.h	2006-05-17 00:07:20 UTC (rev 245)
@@ -105,7 +105,7 @@
 		bool prepareDocument(const DocumentInfo &info, Xapian::Document &doc,
 			Xapian::termcount &termPos) const;
 
-		void scanDocument(const char *pData, unsigned int dataLength,
+		std::string scanDocument(const char *pData, unsigned int dataLength,
 			DocumentInfo &info);
 
 		void setDocumentData(Xapian::Document &doc, const DocumentInfo &info,



From fabricecolin at berlios.de  Wed May 17 14:59:39 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 17 May 2006 14:59:39 +0200
Subject: [Pinot-svn] r246 - in trunk: Tokenize Utils
Message-ID: <200605171259.k4HCxdvZ000868@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-17 14:59:37 +0200 (Wed, 17 May 2006)
New Revision: 246

Modified:
   trunk/Tokenize/TokenizerFactory.h
   trunk/Utils/Document.h
   trunk/Utils/DocumentInfo.h
Log:
Cosmetic changes.


Modified: trunk/Tokenize/TokenizerFactory.h
===================================================================
--- trunk/Tokenize/TokenizerFactory.h	2006-05-17 00:07:20 UTC (rev 245)
+++ trunk/Tokenize/TokenizerFactory.h	2006-05-17 12:59:37 UTC (rev 246)
@@ -19,13 +19,10 @@
 
 #include <string>
 #include <map>
+#include <set>
 
 #include "Tokenizer.h"
 
-#include <string>
-#include <map>
-#include <set>
-
 class TokenizerFactory
 {
 	public:

Modified: trunk/Utils/Document.h
===================================================================
--- trunk/Utils/Document.h	2006-05-17 00:07:20 UTC (rev 245)
+++ trunk/Utils/Document.h	2006-05-17 12:59:37 UTC (rev 246)
@@ -54,5 +54,5 @@
 		void freeData(void);
 
 };
-	
+
 #endif // _DOCUMENT_H

Modified: trunk/Utils/DocumentInfo.h
===================================================================
--- trunk/Utils/DocumentInfo.h	2006-05-17 00:07:20 UTC (rev 245)
+++ trunk/Utils/DocumentInfo.h	2006-05-17 12:59:37 UTC (rev 246)
@@ -70,5 +70,5 @@
 		std::string m_timestamp;
 
 };
-	
+
 #endif // _DOCUMENT_INFO_H



From fabricecolin at berlios.de  Wed May 17 16:33:36 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 17 May 2006 16:33:36 +0200
Subject: [Pinot-svn] r247 - trunk/Monitor
Message-ID: <200605171433.k4HEXaIL011987@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-17 16:33:35 +0200 (Wed, 17 May 2006)
New Revision: 247

Added:
   trunk/Monitor/MonitorFactory.cpp
   trunk/Monitor/MonitorFactory.h
Modified:
   trunk/Monitor/INotifyMonitor.cpp
   trunk/Monitor/INotifyMonitor.h
   trunk/Monitor/Makefile.am
   trunk/Monitor/MonitorInterface.h
Log:
Some fixes, new class MonitorFactory.


Modified: trunk/Monitor/INotifyMonitor.cpp
===================================================================
--- trunk/Monitor/INotifyMonitor.cpp	2006-05-17 12:59:37 UTC (rev 246)
+++ trunk/Monitor/INotifyMonitor.cpp	2006-05-17 14:33:35 UTC (rev 247)
@@ -35,10 +35,11 @@
 
 INotifyMonitor::~INotifyMonitor()
 {
+	close(m_monitorFd);
 }
 
-/// Starts monitoring a directory.
-bool INotifyMonitor::addDirectory(const string &directory)
+/// Starts monitoring a location.
+bool INotifyMonitor::addLocation(const string &directory)
 {
 	uint32_t eventsMask = IN_CLOSE_WRITE|IN_MOVE|IN_CREATE|IN_DELETE|IN_DELETE_SELF|IN_MOVE_SELF;
 
@@ -49,6 +50,13 @@
 		return false;
 	}
 
+	map<string, int>::iterator watchIter = m_watches.find(directory);
+	if (watchIter != m_watches.end())
+	{
+		// This is already being monitored
+		return true;
+	}
+
 	// FIXME: check the maximum number of watches hasn't been reached (MAX_FILE_WATCHES ?)
 	int dirWd = inotify_add_watch(m_monitorFd, directory.c_str(), eventsMask);
 	if (dirWd >= 0)
@@ -57,13 +65,13 @@
 
 		return true;
 	}
-	cerr << "INotifyMonitor::addDirectory: couldn't monitor " << directory << endl;
+	cerr << "INotifyMonitor::addLocation: couldn't monitor " << directory << endl;
 
 	return false;
 }
 
-/// Stops monitoring a directory.
-bool INotifyMonitor::removeDirectory(const string &directory)
+/// Stops monitoring a location.
+bool INotifyMonitor::removeLocation(const string &directory)
 {
 	if ((directory.empty() == true) ||
 		(m_monitorFd < 0))
@@ -79,7 +87,7 @@
 
 		return true;
 	}
-	cerr << "INotifyMonitor::removeDirectory: " << directory << " is not being monitored" << endl;
+	cerr << "INotifyMonitor::removeLocation: " << directory << " is not being monitored" << endl;
 
 	return false;
 }
@@ -90,96 +98,103 @@
 	char buffer[1024];
 	size_t offset = 0;
 
+	events.clear();
 	if (m_monitorFd < 0)
 	{
 		return false;
 	}
 
+#ifdef DEBUG
+	cout << "INotifyMonitor::retrievePendingEvents: reading events" << endl;
+#endif
 	int bytesRead = read(m_monitorFd, buffer, 1024); 
 	while (bytesRead - offset > 0)
 	{
-		struct inotify_event *pEvent = (struct inotify_event *)(buffer + offset);
+		struct inotify_event *pEvent = (struct inotify_event *)&buffer[offset];
 		size_t eventSize = sizeof(struct inotify_event) + pEvent->len;
 
 		// The length includes the terminating NULL
-		if (pEvent->len > 1)
+		if (pEvent->len < 1)
 		{
-			MonitorEvent monEvent;
-			map<uint32_t, string>::iterator iter = m_movedFrom.end();
+#ifdef DEBUG
+			cout << "INotifyMonitor::retrievePendingEvents: no name for watch "
+				<< pEvent->wd << endl;
+#endif
+			offset += eventSize;
+			continue;
+		}
+		MonitorEvent monEvent;
+		map<uint32_t, string>::iterator iter = m_movedFrom.end();
 
-			// Get the whole event structure
-			pEvent = (struct inotify_event *)malloc(eventSize);
-			if (pEvent != NULL)
-			{
-				memmove((void *)pEvent, (const void *)(buffer + offset), eventSize);
-				monEvent.m_location = pEvent->name;
-			}
-			if (pEvent->mask & IN_ISDIR)
-			{
-				monEvent.m_isDirectory = true;
-			}
+		// Get the whole event structure
+		if (pEvent->name != NULL)
+		{
 #ifdef DEBUG
 			cout << "INotifyMonitor::retrievePendingEvents: event on "
-				<< monEvent.m_location << endl;
+				<< pEvent->name << endl;
 #endif
+			monEvent.m_location = pEvent->name;
+		}
+		if (pEvent->mask & IN_ISDIR)
+		{
+			monEvent.m_isDirectory = true;
+		}
 
-			// What type of event ?
-			switch (pEvent->mask)
-			{
-				case IN_CREATE:
-					// Skip regular files
+		// What type of event ?
+		switch (pEvent->mask)
+		{
+			case IN_CREATE:
+				// Skip regular files
+				if (monEvent.m_isDirectory == true)
+				{
+					monEvent.m_type = MonitorEvent::CREATED;
+				}
+				break;
+			case IN_CLOSE_WRITE:
+				monEvent.m_type = MonitorEvent::WRITE_CLOSED;
+				break;
+			case IN_MOVED_FROM:
+				// Store this until we receive a IN_MOVED_TO event
+				m_movedFrom.insert(pair<uint32_t, string>(pEvent->cookie, monEvent.m_location));
+				break;
+			case IN_MOVED_TO:
+				// What was the previous location ?
+				iter = m_movedFrom.find(pEvent->cookie);
+				if (iter != m_movedFrom.end())
+				{
+					monEvent.m_previousLocation = iter->second;
+					monEvent.m_type = MonitorEvent::MOVED;
+
 					if (monEvent.m_isDirectory == true)
 					{
-						monEvent.m_type = MonitorEvent::CREATED;
-					}
-					break;
-				case IN_CLOSE_WRITE:
-					monEvent.m_type = MonitorEvent::WRITE_CLOSED;
-					break;
-				case IN_MOVED_FROM:
-					// Store this until we receive a IN_MOVED_TO event
-					m_movedFrom.insert(pair<uint32_t, string>(pEvent->cookie, monEvent.m_location));
-					break;
-				case IN_MOVED_TO:
-					// What was the previous location ?
-					iter = m_movedFrom.find(pEvent->cookie);
-					if (iter != m_movedFrom.end())
-					{
-						monEvent.m_previousLocation = iter->second;
-						monEvent.m_type = MonitorEvent::MOVED;
-
-						if (monEvent.m_isDirectory == true)
+						// We can already stop watching the old directory
+						if (removeLocation(monEvent.m_previousLocation) == true)
 						{
-							// We can already stop watching the old directory
-							if (removeDirectory(monEvent.m_previousLocation) == true)
-							{
-								// ...and watch this one instead
-								addDirectory(monEvent.m_location);
-							}
+							// ...and watch this one instead
+							addLocation(monEvent.m_location);
 						}
-						m_movedFrom.erase(iter);
 					}
+					m_movedFrom.erase(iter);
+				}
 #ifdef DEBUG
-					else cout << "INotifyMonitor::retrievePendingEvents: don't know where file was moved from" << endl;
+				else cout << "INotifyMonitor::retrievePendingEvents: don't know where file was moved from" << endl;
 #endif
-					break;
-				case IN_DELETE_SELF:
-					monEvent.m_type = MonitorEvent::DELETED;
-					break;
-				default:
+				break;
+			case IN_DELETE_SELF:
+				monEvent.m_type = MonitorEvent::DELETED;
+				break;
+			default:
 #ifdef DEBUG
-					cout << "INotifyMonitor::retrievePendingEvents: ignoring event" << endl;
+				cout << "INotifyMonitor::retrievePendingEvents: ignoring event "
+					<< pEvent->mask << endl;
 #endif
-					break;
-			}
+				break;
+		}
 
-			free(pEvent);
-
-			// Return event ?
-			if (monEvent.m_type != MonitorEvent::UNKNOWN)
-			{
-				events.insert(monEvent);
-			}
+		// Return event ?
+		if (monEvent.m_type != MonitorEvent::UNKNOWN)
+		{
+			events.insert(monEvent);
 		}
 
 		offset += eventSize;

Modified: trunk/Monitor/INotifyMonitor.h
===================================================================
--- trunk/Monitor/INotifyMonitor.h	2006-05-17 12:59:37 UTC (rev 246)
+++ trunk/Monitor/INotifyMonitor.h	2006-05-17 14:33:35 UTC (rev 247)
@@ -21,7 +21,6 @@
 #include <map>
 #include <set>
 
-#include "MonitorEvent.h"
 #include "MonitorInterface.h"
 
 class INotifyMonitor : public MonitorInterface
@@ -30,11 +29,11 @@
 		INotifyMonitor();
 		virtual ~INotifyMonitor();
 
-		/// Adds a watch for the specified directory.
-		virtual bool addDirectory(const std::string &directory);
+		/// Adds a watch for the specified location.
+		virtual bool addLocation(const std::string &directory);
 
-		/// Removed the watch for the specified directory.
-		virtual bool removeDirectory(const std::string &directory);
+		/// Removed the watch for the specified location.
+		virtual bool removeLocation(const std::string &directory);
 
 		/// Retrieves pending events.
 		virtual bool retrievePendingEvents(std::set<MonitorEvent> &events);

Modified: trunk/Monitor/Makefile.am
===================================================================
--- trunk/Monitor/Makefile.am	2006-05-17 12:59:37 UTC (rev 246)
+++ trunk/Monitor/Makefile.am	2006-05-17 14:33:35 UTC (rev 247)
@@ -3,13 +3,15 @@
 noinst_HEADERS = \
 	INotifyMonitor.h \
 	MonitorEvent.h \
+	MonitorFactory.h \
 	MonitorInterface.h
 
 noinst_LTLIBRARIES = libMonitor.la
 
 libMonitor_la_SOURCES = \
 	INotifyMonitor.cpp \
-	MonitorEvent.cpp
+	MonitorEvent.cpp \
+	MonitorFactory.cpp
 
 AM_CXXFLAGS = -I../Utils
 

Added: trunk/Monitor/MonitorFactory.cpp
===================================================================
--- trunk/Monitor/MonitorFactory.cpp	2006-05-17 12:59:37 UTC (rev 246)
+++ trunk/Monitor/MonitorFactory.cpp	2006-05-17 14:33:35 UTC (rev 247)
@@ -0,0 +1,32 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include "INotifyMonitor.h"
+#include "MonitorFactory.h"
+
+MonitorFactory::MonitorFactory()
+{
+}
+
+MonitorFactory::~MonitorFactory()
+{
+}
+
+/// Returns a Monitor.
+MonitorInterface *MonitorFactory::getMonitor(void)
+{
+	return new INotifyMonitor();
+}


Property changes on: trunk/Monitor/MonitorFactory.cpp
___________________________________________________________________
Name: svn:executable
   + *

Added: trunk/Monitor/MonitorFactory.h
===================================================================
--- trunk/Monitor/MonitorFactory.h	2006-05-17 12:59:37 UTC (rev 246)
+++ trunk/Monitor/MonitorFactory.h	2006-05-17 14:33:35 UTC (rev 247)
@@ -0,0 +1,39 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _MONITOR_FACTORY_H
+#define _MONITOR_FACTORY_H
+
+#include "MonitorInterface.h"
+
+class MonitorFactory
+{
+	public:
+		virtual ~MonitorFactory();
+
+		/// Returns a Monitor.
+		static MonitorInterface *getMonitor(void);
+
+	protected:
+		MonitorFactory();
+
+	private:
+		MonitorFactory(const MonitorFactory &other);
+		MonitorFactory& operator=(const MonitorFactory& other);
+
+};
+
+#endif // _MONITOR_FACTORY_H


Property changes on: trunk/Monitor/MonitorFactory.h
___________________________________________________________________
Name: svn:executable
   + *

Modified: trunk/Monitor/MonitorInterface.h
===================================================================
--- trunk/Monitor/MonitorInterface.h	2006-05-17 12:59:37 UTC (rev 246)
+++ trunk/Monitor/MonitorInterface.h	2006-05-17 14:33:35 UTC (rev 247)
@@ -21,10 +21,14 @@
 #include <map>
 #include <set>
 
+#include "MonitorEvent.h"
+
 class MonitorInterface
 {
 	public:
-		virtual ~MonitorInterface();
+		virtual ~MonitorInterface()
+		{
+		}
 
 		/// Returns the file descriptor to poll for events.
 		virtual int getFileDescriptor(void) const
@@ -32,14 +36,14 @@
 			return m_monitorFd;
 		}
 
-		/// Adds a watch for the specified directory.
-		virtual bool addDirectory(const std::string &directory) = 0;
+		/// Adds a watch for the specified location.
+		virtual bool addLocation(const std::string &directory) = 0;
 
-		/// Removed the watch for the specified directory.
-		virtual bool removeDirectory(const std::string &directory) = 0;
+		/// Removed the watch for the specified location.
+		virtual bool removeLocation(const std::string &directory) = 0;
 
 		/// Retrieves pending events.
-		virtual bool retrievePendingEvents(std::set<MonitorEvent> &events);
+		virtual bool retrievePendingEvents(std::set<MonitorEvent> &events) = 0;
 
 	protected:
 		int m_monitorFd;



From fabricecolin at berlios.de  Fri May 19 01:37:37 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 19 May 2006 01:37:37 +0200
Subject: [Pinot-svn] r248 - trunk/Monitor
Message-ID: <200605182337.k4INbbYn012733@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-19 01:37:13 +0200 (Fri, 19 May 2006)
New Revision: 248

Modified:
   trunk/Monitor/INotifyMonitor.cpp
   trunk/Monitor/INotifyMonitor.h
   trunk/Monitor/MonitorInterface.h
Log:
Monitoring now functional.


Modified: trunk/Monitor/INotifyMonitor.cpp
===================================================================
--- trunk/Monitor/INotifyMonitor.cpp	2006-05-17 14:33:35 UTC (rev 247)
+++ trunk/Monitor/INotifyMonitor.cpp	2006-05-18 23:37:13 UTC (rev 248)
@@ -14,7 +14,10 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include <sys/ioctl.h>
 #include <sys/inotify.h>
+#include <string.h>
+#include <errno.h>
 #include <iostream>
 
 #include "INotifyMonitor.h"
@@ -41,7 +44,7 @@
 /// Starts monitoring a location.
 bool INotifyMonitor::addLocation(const string &directory)
 {
-	uint32_t eventsMask = IN_CLOSE_WRITE|IN_MOVE|IN_CREATE|IN_DELETE|IN_DELETE_SELF|IN_MOVE_SELF;
+	uint32_t eventsMask = IN_ATTRIB|IN_CLOSE_WRITE|IN_MOVE|IN_CREATE|IN_DELETE|IN_UNMOUNT|IN_MOVE_SELF|IN_DELETE_SELF;
 
 	if ((directory.empty() == true) ||
 		(directory == "/") ||
@@ -50,8 +53,8 @@
 		return false;
 	}
 
-	map<string, int>::iterator watchIter = m_watches.find(directory);
-	if (watchIter != m_watches.end())
+	map<string, int>::iterator locationIter = m_locations.find(directory);
+	if (locationIter != m_locations.end())
 	{
 		// This is already being monitored
 		return true;
@@ -61,12 +64,20 @@
 	int dirWd = inotify_add_watch(m_monitorFd, directory.c_str(), eventsMask);
 	if (dirWd >= 0)
 	{
-		m_watches.insert(pair<string, int>(directory, dirWd));
+		m_watches.insert(pair<int, string>(dirWd, directory));
+		m_locations.insert(pair<string, int>(directory, dirWd));
+#ifdef DEBUG
+		cout << "INotifyMonitor::addLocation: added watch " << dirWd << " " << directory << endl;
+#endif
 
 		return true;
 	}
-	cerr << "INotifyMonitor::addLocation: couldn't monitor " << directory << endl;
 
+	char errBuffer[1024];
+
+	strerror_r(errno, errBuffer, 1024);
+	cerr << "INotifyMonitor::addLocation: couldn't monitor " << directory << ": " << errBuffer << endl;
+
 	return false;
 }
 
@@ -79,11 +90,16 @@
 		return false;
 	}
 
-	map<string, int>::iterator watchIter = m_watches.find(directory);
-	if (watchIter != m_watches.end())
+	map<string, int>::iterator locationIter = m_locations.find(directory);
+	if (locationIter != m_locations.end())
 	{
-		inotify_rm_watch(m_monitorFd, watchIter->second);
-		m_watches.erase(watchIter);
+		inotify_rm_watch(m_monitorFd, locationIter->second);
+		map<int, string>::iterator watchIter = m_watches.find(locationIter->second);
+		if (watchIter != m_watches.end())
+		{
+			m_watches.erase(watchIter);
+		}
+		m_locations.erase(locationIter);
 
 		return true;
 	}
@@ -96,6 +112,7 @@
 bool INotifyMonitor::retrievePendingEvents(set<MonitorEvent> &events)
 {
 	char buffer[1024];
+	unsigned int queueLen;
 	size_t offset = 0;
 
 	events.clear();
@@ -104,42 +121,59 @@
 		return false;
 	}
 
+    if (ioctl (m_monitorFd, FIONREAD, &queueLen) == 0)
+	{
 #ifdef DEBUG
-	cout << "INotifyMonitor::retrievePendingEvents: reading events" << endl;
+		cout << "INotifyMonitor::retrievePendingEvents: "
+			<< queueLen << " bytes to read" << endl;
 #endif
-	int bytesRead = read(m_monitorFd, buffer, 1024); 
+	}
+
+	int bytesRead = read(m_monitorFd, buffer, 1024);
 	while (bytesRead - offset > 0)
 	{
 		struct inotify_event *pEvent = (struct inotify_event *)&buffer[offset];
 		size_t eventSize = sizeof(struct inotify_event) + pEvent->len;
+		bool isOnWatch = true;
 
-		// The length includes the terminating NULL
-		if (pEvent->len < 1)
+#ifdef DEBUG
+		cout << "INotifyMonitor::retrievePendingEvents: read "
+			<< bytesRead << " bytes at offset " << offset << endl;
+#endif
+		// What location is this event for ?
+		map<int, string>::iterator watchIter = m_watches.find(pEvent->wd);
+		if (watchIter == m_watches.end())
 		{
 #ifdef DEBUG
-			cout << "INotifyMonitor::retrievePendingEvents: no name for watch "
+			cout << "INotifyMonitor::retrievePendingEvents: unknown watch "
 				<< pEvent->wd << endl;
 #endif
 			offset += eventSize;
 			continue;
 		}
+
 		MonitorEvent monEvent;
-		map<uint32_t, string>::iterator iter = m_movedFrom.end();
 
-		// Get the whole event structure
-		if (pEvent->name != NULL)
-		{
-#ifdef DEBUG
-			cout << "INotifyMonitor::retrievePendingEvents: event on "
-				<< pEvent->name << endl;
-#endif
-			monEvent.m_location = pEvent->name;
-		}
 		if (pEvent->mask & IN_ISDIR)
 		{
 			monEvent.m_isDirectory = true;
 		}
 
+		monEvent.m_location = watchIter->second;
+		// A name is provided if the target is below a location we match
+		if (pEvent->len >= 1)
+		{
+			monEvent.m_location += "/";
+			monEvent.m_location += pEvent->name;
+			isOnWatch = false;
+		}
+#ifdef DEBUG
+		cout << "INotifyMonitor::retrievePendingEvents: event on "
+			<< monEvent.m_location << endl;
+#endif
+
+		map<uint32_t, string>::iterator movedIter = m_movedFrom.end();
+
 		// What type of event ?
 		switch (pEvent->mask)
 		{
@@ -159,30 +193,39 @@
 				break;
 			case IN_MOVED_TO:
 				// What was the previous location ?
-				iter = m_movedFrom.find(pEvent->cookie);
-				if (iter != m_movedFrom.end())
+				movedIter = m_movedFrom.find(pEvent->cookie);
+				if (movedIter != m_movedFrom.end())
 				{
-					monEvent.m_previousLocation = iter->second;
+					monEvent.m_previousLocation = movedIter->second;
 					monEvent.m_type = MonitorEvent::MOVED;
-
-					if (monEvent.m_isDirectory == true)
-					{
-						// We can already stop watching the old directory
-						if (removeLocation(monEvent.m_previousLocation) == true)
-						{
-							// ...and watch this one instead
-							addLocation(monEvent.m_location);
-						}
-					}
-					m_movedFrom.erase(iter);
+#ifdef DEBUG
+					cout << "INotifyMonitor::retrievePendingEvents: moved from "
+						<< monEvent.m_previousLocation << endl;
+#endif
+					m_movedFrom.erase(movedIter);
 				}
 #ifdef DEBUG
 				else cout << "INotifyMonitor::retrievePendingEvents: don't know where file was moved from" << endl;
 #endif
 				break;
-			case IN_DELETE_SELF:
+			case IN_DELETE:
 				monEvent.m_type = MonitorEvent::DELETED;
 				break;
+			case IN_MOVE_SELF:
+				// FIXME: how do we find out where the watched location was moved to ?
+			case IN_DELETE_SELF:
+#ifdef DEBUG
+				cout << "INotifyMonitor::retrievePendingEvents: watch moved or deleted itself" << endl;
+#endif
+				removeLocation(monEvent.m_location);
+				break;
+			case IN_UNMOUNT:
+				if (isOnWatch == true)
+				{
+					// Watches are removed if the backing filesystem is unmounted
+					removeLocation(monEvent.m_location);
+				}
+				break;
 			default:
 #ifdef DEBUG
 				cout << "INotifyMonitor::retrievePendingEvents: ignoring event "

Modified: trunk/Monitor/INotifyMonitor.h
===================================================================
--- trunk/Monitor/INotifyMonitor.h	2006-05-17 14:33:35 UTC (rev 247)
+++ trunk/Monitor/INotifyMonitor.h	2006-05-18 23:37:13 UTC (rev 248)
@@ -39,7 +39,7 @@
 		virtual bool retrievePendingEvents(std::set<MonitorEvent> &events);
 
 	protected:
-		std::map<std::string, int> m_watches;
+		std::map<std::string, int> m_locations;
 		std::map<uint32_t, std::string> m_movedFrom;
 
 	private:

Modified: trunk/Monitor/MonitorInterface.h
===================================================================
--- trunk/Monitor/MonitorInterface.h	2006-05-17 14:33:35 UTC (rev 247)
+++ trunk/Monitor/MonitorInterface.h	2006-05-18 23:37:13 UTC (rev 248)
@@ -46,6 +46,7 @@
 		virtual bool retrievePendingEvents(std::set<MonitorEvent> &events) = 0;
 
 	protected:
+		std::map<int, std::string> m_watches;
 		int m_monitorFd;
 
 		MonitorInterface() :



From fabricecolin at berlios.de  Sat May 20 06:00:43 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 20 May 2006 06:00:43 +0200
Subject: [Pinot-svn] r249 - in trunk: Monitor UI/GTK2/src
Message-ID: <200605200400.k4K40h6Z008547@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-20 06:00:42 +0200 (Sat, 20 May 2006)
New Revision: 249

Modified:
   trunk/Monitor/INotifyMonitor.cpp
   trunk/Monitor/INotifyMonitor.h
   trunk/Monitor/MonitorInterface.h
   trunk/UI/GTK2/src/MonitorHandler.cpp
   trunk/UI/GTK2/src/MonitorHandler.h
Log:
Redesigned MonitorHandler to better fit with MonitorInterface.


Modified: trunk/Monitor/INotifyMonitor.cpp
===================================================================
--- trunk/Monitor/INotifyMonitor.cpp	2006-05-18 23:37:13 UTC (rev 248)
+++ trunk/Monitor/INotifyMonitor.cpp	2006-05-20 04:00:42 UTC (rev 249)
@@ -24,7 +24,7 @@
 
 using std::string;
 using std::map;
-using std::set;
+using std::queue;
 using std::pair;
 using std::cout;
 using std::cerr;
@@ -109,13 +109,12 @@
 }
 
 /// Retrieves pending events.
-bool INotifyMonitor::retrievePendingEvents(set<MonitorEvent> &events)
+bool INotifyMonitor::retrievePendingEvents(queue<MonitorEvent> &events)
 {
 	char buffer[1024];
 	unsigned int queueLen;
 	size_t offset = 0;
 
-	events.clear();
 	if (m_monitorFd < 0)
 	{
 		return false;
@@ -237,7 +236,7 @@
 		// Return event ?
 		if (monEvent.m_type != MonitorEvent::UNKNOWN)
 		{
-			events.insert(monEvent);
+			events.push(monEvent);
 		}
 
 		offset += eventSize;

Modified: trunk/Monitor/INotifyMonitor.h
===================================================================
--- trunk/Monitor/INotifyMonitor.h	2006-05-18 23:37:13 UTC (rev 248)
+++ trunk/Monitor/INotifyMonitor.h	2006-05-20 04:00:42 UTC (rev 249)
@@ -19,7 +19,7 @@
 
 #include <string>
 #include <map>
-#include <set>
+#include <queue>
 
 #include "MonitorInterface.h"
 
@@ -36,7 +36,7 @@
 		virtual bool removeLocation(const std::string &directory);
 
 		/// Retrieves pending events.
-		virtual bool retrievePendingEvents(std::set<MonitorEvent> &events);
+		virtual bool retrievePendingEvents(std::queue<MonitorEvent> &events);
 
 	protected:
 		std::map<std::string, int> m_locations;

Modified: trunk/Monitor/MonitorInterface.h
===================================================================
--- trunk/Monitor/MonitorInterface.h	2006-05-18 23:37:13 UTC (rev 248)
+++ trunk/Monitor/MonitorInterface.h	2006-05-20 04:00:42 UTC (rev 249)
@@ -19,7 +19,7 @@
 
 #include <string>
 #include <map>
-#include <set>
+#include <queue>
 
 #include "MonitorEvent.h"
 
@@ -43,7 +43,7 @@
 		virtual bool removeLocation(const std::string &directory) = 0;
 
 		/// Retrieves pending events.
-		virtual bool retrievePendingEvents(std::set<MonitorEvent> &events) = 0;
+		virtual bool retrievePendingEvents(std::queue<MonitorEvent> &events) = 0;
 
 	protected:
 		std::map<int, std::string> m_watches;

Modified: trunk/UI/GTK2/src/MonitorHandler.cpp
===================================================================
--- trunk/UI/GTK2/src/MonitorHandler.cpp	2006-05-18 23:37:13 UTC (rev 248)
+++ trunk/UI/GTK2/src/MonitorHandler.cpp	2006-05-20 04:00:42 UTC (rev 249)
@@ -50,10 +50,9 @@
 }
 
 MboxHandler::MboxHandler() :
-	MonitorHandler()
+	MonitorHandler(),
+	m_locationsCount(0)
 {
-	m_locationsCount = 0;
-	m_hasNewLocations = false;
 }
 
 MboxHandler::~MboxHandler()
@@ -256,72 +255,71 @@
 	return unindexedMsgs;
 }
 
-unsigned int MboxHandler::getFileSystemLocations(map<unsigned long, string> &fsLocations)
+bool MboxHandler::getLocations(set<string> &newLocations,
+	set<string> &locationsToRemove)
 {
-	// Reset
-	m_hasNewLocations = false;
+	newLocations.clear();
+	locationsToRemove.clear();
 
-	// Get the map of mail accounts
+	copy(m_locations.begin(), m_locations.end(),
+		inserter(locationsToRemove, locationsToRemove.begin()));
+
+	// Get the mail accounts map
 	set<PinotSettings::MailAccount> &mailAccounts = PinotSettings::getInstance().m_mailAccounts;
-
-	if (fsLocations.empty() == true)
+	for (set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.begin();
+		mailIter != mailAccounts.end(); ++mailIter)
 	{
-		m_hasNewLocations = true;
-	}
-	else
-	{
-		unsigned long fileNum = 0;
-
-		// Do a first pass and look for new accounts
-		for (set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.begin();
-			mailIter != mailAccounts.end(); ++mailIter)
+		// Is this a known location ?
+		set<string>::iterator locationIter = m_locations.find(mailIter->m_name);
+		if (locationIter == m_locations.end())
 		{
-			map<unsigned long, string>::iterator fsIter = fsLocations.find(fileNum);
-			if ((fsIter == fsLocations.end()) ||
-				(fsIter->second != mailIter->m_name))
+			// No, it is new
+			m_locations.insert(mailIter->m_name);
+			newLocations.insert(mailIter->m_name);
+		}
+		else
+		{
+			// Since it's a known location, we'd better not remove it
+			set<string>::iterator removeIter = locationsToRemove.find(mailIter->m_name);
+			if (removeIter != locationsToRemove.end())
 			{
-				// The mail accounts map has changed
-				m_hasNewLocations = true;
+				locationsToRemove.erase(removeIter);
 			}
-
-			++fileNum;
 		}
-
-		fsLocations.clear();
 	}
 
-	// Update the map
-	unsigned long fileNum = 0;
-	for (set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.begin();
-		mailIter != mailAccounts.end(); ++mailIter)
+	// Locations in locationsToRemove have to be removed
+	for (set<string>::iterator removeIter = locationsToRemove.begin();
+		removeIter != locationsToRemove.end(); ++removeIter)
 	{
-		fsLocations[fileNum] = mailIter->m_name;
-
-		++fileNum;
+		set<string>::iterator locationIter = m_locations.find(*removeIter);
+		if (locationIter != m_locations.end())
+		{
+			m_locations.erase(locationIter);
+		}
 	}
 
-	m_locationsCount = fsLocations.size();
+#ifdef DEBUG
+	cout << "MboxHandler::getLocations: " << m_locations.size() << " locations, "
+		<< newLocations.size() << " new, " << locationsToRemove.size() << " to be removed" << endl;
+#endif
 
-	return fileNum;
-}
+	if ((newLocations.empty() == false) ||
+		(locationsToRemove.empty() == false))
+	{
+		return true;
+	}
 
-bool MboxHandler::hasNewLocations(void) const
-{
-	return m_hasNewLocations;
+	return false;
 }
 
-bool MboxHandler::fileExists(const string &fileName, bool end)
+bool MboxHandler::fileExists(const string &fileName)
 {
 	PinotSettings::MailAccount mailAccount;
 	off_t previousSize = 0;
 
-	if (end == true)
-	{
-		return false;
-	}
-
 #ifdef DEBUG
-	cout << "MboxHandler::fileExists: " << fileName << " exists" << endl;
+	cout << "MboxHandler::fileExists: " << fileName << endl;
 #endif
 	if (checkMailAccount(fileName, mailAccount, previousSize) == false)
 	{
@@ -374,18 +372,19 @@
 	return indexedFile;
 }
 
-void MboxHandler::fileCreated(const string &fileName)
+bool MboxHandler::fileCreated(const string &fileName)
 {
-	// FIXME: if monitoring a directory, index this file
+	// Nothing to do here
+	return true;
 }
 
-bool MboxHandler::fileChanged(const string &fileName)
+bool MboxHandler::fileModified(const string &fileName)
 {
 	PinotSettings::MailAccount mailAccount;
 	off_t previousSize = 0, mboxOffset = 0;
 
 #ifdef DEBUG
-	cout << "MboxHandler::fileChanged: " << fileName << " changed" << endl;
+	cout << "MboxHandler::fileModified: " << fileName << " changed" << endl;
 #endif
 	if (checkMailAccount(fileName, mailAccount, previousSize) == false)
 	{
@@ -396,12 +395,12 @@
 	{
 		// Parse the file from the beginning...
 #ifdef DEBUG
-		cout << "MboxHandler::fileChanged: file smaller or same size" << endl;
+		cout << "MboxHandler::fileModified: file smaller or same size" << endl;
 #endif
-		return fileExists(fileName, false);
+		return fileExists(fileName);
 	}
 #ifdef DEBUG
-	else cout << "MboxHandler::fileChanged: file now larger than " << previousSize << endl;
+	else cout << "MboxHandler::fileModified: file now larger than " << previousSize << endl;
 #endif
 
 	// Chances are new messages were added but none removed
@@ -415,7 +414,7 @@
 	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
 	if (index.isGood() == false)
 	{
-		cerr << "MboxHandler::fileChanged: couldn't get mail index" << endl;
+		cerr << "MboxHandler::fileModified: couldn't get mail index" << endl;
 		return false;
 	}
 
@@ -447,6 +446,12 @@
 	return indexedFile;
 }
 
+bool MboxHandler::fileMoved(const string &fileName)
+{
+	// Nothing to do here
+	return true;
+}
+
 bool MboxHandler::fileDeleted(const string &fileName)
 {
 	string sourceLabel = string("mailbox://") + fileName;

Modified: trunk/UI/GTK2/src/MonitorHandler.h
===================================================================
--- trunk/UI/GTK2/src/MonitorHandler.h	2006-05-18 23:37:13 UTC (rev 248)
+++ trunk/UI/GTK2/src/MonitorHandler.h	2006-05-20 04:00:42 UTC (rev 249)
@@ -35,21 +35,22 @@
 		MonitorHandler();
 		virtual ~MonitorHandler();
 
-		/// Returns a map of locations to monitor.
-		virtual unsigned int getFileSystemLocations(std::map<unsigned long, std::string> &fsLocations) = 0;
+		/// Returns locations.
+		virtual bool getLocations(std::set<std::string> &newLocations,
+			std::set<std::string> &locationsToRemove) = 0;
 
-		/// Returns true if the locations map has changed since last time.
-		virtual bool hasNewLocations(void) const = 0;
+		/// Handles file existence events.
+		virtual bool fileExists(const string &fileName) = 0;
 
-		/// Handles file exists events.
-		virtual bool fileExists(const std::string &fileName, bool end = false) = 0;
-
 		/// Handles file creation events.
-		virtual void fileCreated(const std::string &fileName) = 0;
+		virtual bool fileCreated(const std::string &fileName) = 0;
 
-		/// Handles file changed events.
-		virtual bool fileChanged(const std::string &fileName) = 0;
+		/// Handles file modified events.
+		virtual bool fileModified(const std::string &fileName) = 0;
 
+		/// Handles file moved events.
+		virtual bool fileMoved(const std::string &fileName) = 0;
+
 		/// Handles file deleted events.
 		virtual bool fileDeleted(const std::string &fileName) = 0;
 
@@ -70,21 +71,28 @@
 		MboxHandler();
 		virtual ~MboxHandler();
 
-		virtual unsigned int getFileSystemLocations(std::map<unsigned long, std::string> &fsLocations);
+		/// Returns locations.
+		virtual bool getLocations(std::set<std::string> &newLocations,
+			std::set<std::string> &locationsToRemove);
 
-		virtual bool hasNewLocations(void) const;
+		/// Handles file existence events.
+		virtual bool fileExists(const string &fileName);
 
-		virtual bool fileExists(const std::string &fileName, bool end = false);
+		/// Handles file creation events.
+		virtual bool fileCreated(const std::string &fileName);
 
-		virtual void fileCreated(const std::string &fileName);
+		/// Handles file modified events.
+		virtual bool fileModified(const std::string &fileName);
 
-		virtual bool fileChanged(const std::string &fileName);
+		/// Handles file moved events.
+		virtual bool fileMoved(const std::string &fileName);
 
+		/// Handles file deleted events.
 		virtual bool fileDeleted(const std::string &fileName);
 
 	protected:
 		unsigned int m_locationsCount;
-		bool m_hasNewLocations;
+		std::set<std::string> m_locations;
 
 		bool checkMailAccount(const std::string &fileName, PinotSettings::MailAccount &mailAccount,
 			off_t &previousSize);



From fabricecolin at berlios.de  Sat May 20 06:31:02 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 20 May 2006 06:31:02 +0200
Subject: [Pinot-svn] r250 - in trunk: Monitor UI/GTK2/src
Message-ID: <200605200431.k4K4V2jI011522@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-20 06:30:58 +0200 (Sat, 20 May 2006)
New Revision: 250

Added:
   trunk/Monitor/MonitorHandler.cpp
   trunk/Monitor/MonitorHandler.h
   trunk/UI/GTK2/src/MboxHandler.cpp
   trunk/UI/GTK2/src/MboxHandler.h
Removed:
   trunk/UI/GTK2/src/MonitorHandler.cpp
   trunk/UI/GTK2/src/MonitorHandler.h
Modified:
   trunk/Monitor/Makefile.am
   trunk/UI/GTK2/src/Makefile.am
   trunk/UI/GTK2/src/WorkerThreads.cpp
Log:
Split MonitorHandler and MboxHandler. In MonitorThread, replaced calls to FAM
with MonitorInterface.


Modified: trunk/Monitor/Makefile.am
===================================================================
--- trunk/Monitor/Makefile.am	2006-05-20 04:00:42 UTC (rev 249)
+++ trunk/Monitor/Makefile.am	2006-05-20 04:30:58 UTC (rev 250)
@@ -4,6 +4,7 @@
 	INotifyMonitor.h \
 	MonitorEvent.h \
 	MonitorFactory.h \
+	MonitorHandler.h \
 	MonitorInterface.h
 
 noinst_LTLIBRARIES = libMonitor.la
@@ -11,7 +12,9 @@
 libMonitor_la_SOURCES = \
 	INotifyMonitor.cpp \
 	MonitorEvent.cpp \
-	MonitorFactory.cpp
+	MonitorFactory.cpp \
+	MonitorHandler.cpp
 
-AM_CXXFLAGS = -I../Utils
+AM_CXXFLAGS = -I../Utils -I../Tokenize -I../SQL -I../Collect -I../Search -I../Index \
+	@HTTP_CFLAGS@ @XML_CFLAGS@ @INDEX_CFLAGS@ @SOAP_CFLAGS@ @MIME_CFLAGS@ @SIGCPP_CFLAGS@
 

Copied: trunk/Monitor/MonitorHandler.cpp (from rev 249, trunk/UI/GTK2/src/MonitorHandler.cpp)
===================================================================
--- trunk/UI/GTK2/src/MonitorHandler.cpp	2006-05-20 04:00:42 UTC (rev 249)
+++ trunk/Monitor/MonitorHandler.cpp	2006-05-20 04:30:58 UTC (rev 250)
@@ -0,0 +1,33 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include "MonitorHandler.h"
+
+using namespace std;
+using namespace SigC;
+
+MonitorHandler::MonitorHandler()
+{
+}
+
+MonitorHandler::~MonitorHandler()
+{
+}
+
+Signal3<void, IndexedDocument, unsigned int, string>& MonitorHandler::getUpdateSignal(void)
+{
+	return m_signalUpdate;
+}

Copied: trunk/Monitor/MonitorHandler.h (from rev 249, trunk/UI/GTK2/src/MonitorHandler.h)
===================================================================
--- trunk/UI/GTK2/src/MonitorHandler.h	2006-05-20 04:00:42 UTC (rev 249)
+++ trunk/Monitor/MonitorHandler.h	2006-05-20 04:30:58 UTC (rev 250)
@@ -0,0 +1,64 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+ 
+#ifndef _MONITORHANDLER_HH
+#define _MONITORHANDLER_HH
+
+#include <string>
+#include <set>
+#include <map>
+#include <sigc++/compatibility.h>
+#include <sigc++/slot.h>
+
+#include "IndexedDocument.h"
+
+class MonitorHandler
+{
+	public:
+		MonitorHandler();
+		virtual ~MonitorHandler();
+
+		/// Returns locations.
+		virtual bool getLocations(std::set<std::string> &newLocations,
+			std::set<std::string> &locationsToRemove) = 0;
+
+		/// Handles file existence events.
+		virtual bool fileExists(const std::string &fileName) = 0;
+
+		/// Handles file creation events.
+		virtual bool fileCreated(const std::string &fileName) = 0;
+
+		/// Handles file modified events.
+		virtual bool fileModified(const std::string &fileName) = 0;
+
+		/// Handles file moved events.
+		virtual bool fileMoved(const std::string &fileName) = 0;
+
+		/// Handles file deleted events.
+		virtual bool fileDeleted(const std::string &fileName) = 0;
+
+		SigC::Signal3<void, IndexedDocument, unsigned int, std::string>& getUpdateSignal(void);
+
+	protected:
+		SigC::Signal3<void, IndexedDocument, unsigned int, std::string> m_signalUpdate;
+
+	private:
+		MonitorHandler(const MonitorHandler &other);
+		MonitorHandler &operator=(const MonitorHandler &other);
+
+};
+
+#endif	// _MONITORHANDLER_HH

Modified: trunk/UI/GTK2/src/Makefile.am
===================================================================
--- trunk/UI/GTK2/src/Makefile.am	2006-05-20 04:00:42 UTC (rev 249)
+++ trunk/UI/GTK2/src/Makefile.am	2006-05-20 04:30:58 UTC (rev 250)
@@ -21,7 +21,7 @@
 	WorkerThreads.h \
 	HtmlView.h \
 	IndexTree.h \
-	MonitorHandler.h \
+	MboxHandler.cpp \
 	PinotSettings.h \
 	ResultsTree.h
 
@@ -47,18 +47,20 @@
 	WorkerThreads.cpp \
 	HtmlView.cpp \
 	IndexTree.cpp \
-	MonitorHandler.cpp \
+	MboxHandler.cpp \
 	PinotSettings.cpp \
 	ResultsTree.cpp
 
 bin_PROGRAMS = pinot
 
-AM_CXXFLAGS = -I../../../Utils -I../../../Tokenize -I../../../SQL -I../../../Collect \
-	-I../../../Search -I../../../Search/Google -I../../../Index -I../../RenderHTML \
+AM_CXXFLAGS = -I../../../Utils -I../../../Tokenize -I../../../SQL \
+	-I../../../Monitor -I../../../Collect -I../../../Search \
+	-I../../../Search/Google -I../../../Index -I../../RenderHTML \
 	@SQL_CFLAGS@ @HTTP_CFLAGS@ @MIME_CFLAGS@ @XML_CFLAGS@ @SOAP_CFLAGS@ @INDEX_CFLAGS@ @UI_CFLAGS@
 
-pinot_LDADD = -L../../../Utils -L../../../Tokenize -L../../../SQL -L../../../Collect \
-	-L../../../Search -L../../../Search/Google -L../../../Index -L../../RenderHTML \
-	-lHTML -lIndex @SEARCH_LIBS@ -lCollect -lSQL -lTokenize -lUtils \
+pinot_LDADD = -L../../../Utils -L../../../Tokenize -L../../../SQL -L../../../Monitor \
+	-L../../../Collect -L../../../Search -L../../../Search/Google \
+	-L../../../Index -L../../RenderHTML \
+	-lHTML -lIndex @SEARCH_LIBS@ -lMonitor -lCollect -lSQL -lTokenize -lUtils \
 	@LIBS@ @UI_LIBS@ @INDEX_LIBS@ @SOAP_LIBS@ @XML_LIBS@ @MIME_LIBS@ @HTTP_LIBS@ @SQL_LIBS@ @MISC_LIBS@
 

Added: trunk/UI/GTK2/src/MboxHandler.cpp
===================================================================
--- trunk/UI/GTK2/src/MboxHandler.cpp	2006-05-20 04:00:42 UTC (rev 249)
+++ trunk/UI/GTK2/src/MboxHandler.cpp	2006-05-20 04:30:58 UTC (rev 250)
@@ -0,0 +1,465 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <fcntl.h>
+#include <unistd.h>
+#include <iostream>
+#include <fstream>
+
+#include "config.h"
+#include "NLS.h"
+#include "StringManip.h"
+#include "Timer.h"
+#include "TimeConverter.h"
+#include "TokenizerFactory.h"
+#include "FileCollector.h"
+#include "XapianIndex.h"
+#include "XapianEngine.h"
+#include "PinotUtils.h"
+#include "MboxHandler.h"
+
+using namespace std;
+using namespace SigC;
+
+MboxHandler::MboxHandler() :
+	MonitorHandler(),
+	m_locationsCount(0)
+{
+}
+
+MboxHandler::~MboxHandler()
+{
+}
+
+bool MboxHandler::checkMailAccount(const string &fileName, PinotSettings::MailAccount &mailAccount,
+		off_t &previousSize)
+{
+	struct stat fileStat;
+
+	mailAccount.m_name = to_utf8(fileName);
+
+	// Ensure it's one of our mail accounts
+	set<PinotSettings::MailAccount> &mailAccounts = PinotSettings::getInstance().m_mailAccounts;
+	set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.find(mailAccount);
+	if (mailIter == mailAccounts.end())
+	{
+		// It doesn't seem to be
+#ifdef DEBUG
+		cout << "MboxHandler::checkMailAccount: not one of " << mailAccounts.size() << " accounts" << endl;
+#endif
+		return false;
+	}
+
+	// Find out when it was last modified
+	if ((stat(fileName.c_str(), &fileStat) == 0) &&
+		(!S_ISREG(fileStat.st_mode)))
+	{
+		// This is not a file !
+		return false;
+	}
+
+	if (fileStat.st_mtime <= mailIter->m_modTime)
+	{
+		// No change since last time...
+#ifdef DEBUG
+		cout << "MboxHandler::checkMailAccount: not modified since last time ("
+			<< mailIter->m_modTime << ">" << fileStat.st_mtime << ")" << endl;
+#endif
+		return false;
+	}
+#ifdef DEBUG
+	cout << "MboxHandler::checkMailAccount: modified since last time ("
+		<< mailIter->m_modTime << "<" << fileStat.st_mtime << ")" << endl;
+#endif
+
+	// Update this mail account's properties
+	mailAccount = (*mailIter);
+	mailAccount.m_modTime = fileStat.st_mtime;
+	previousSize = mailAccount.m_size;
+	mailAccount.m_size = fileStat.st_size;
+
+	return true;
+}
+
+bool MboxHandler::parseMailAccount(MboxParser &boxParser, IndexInterface *pIndex,
+	time_t &lastMessageTime,
+	const string &tempSourceLabel, const string &sourceLabel)
+{
+	bool indexedFile = false;
+
+	if (pIndex == NULL)
+	{
+		return false;
+	}
+
+	// Parse the mbox file
+#ifdef DEBUG
+	Timer timer;
+	timer.start();
+#endif
+	const Document *pMessage = boxParser.getDocument();
+	unsigned int docNum = 0;
+
+	while (pMessage != NULL)
+	{
+		// Has this message already been indexed ?
+		unsigned int docId = pIndex->hasDocument(pMessage->getLocation());
+		if (docId == 0)
+		{
+			pIndex->setStemmingMode(IndexInterface::STORE_BOTH);
+
+			// Get an ad hoc tokenizer for the message
+			Tokenizer *pTokenizer = TokenizerFactory::getTokenizerByType(pMessage->getType(), pMessage);
+			if (pTokenizer == NULL)
+			{
+#ifdef DEBUG
+				cout << "MboxHandler::parseMailAccount: no tokenizer for message " << docNum << endl;
+#endif
+				break;	
+			}
+
+			set<string> labels;
+			labels.insert(tempSourceLabel);
+
+			unsigned int docId = 0;
+			indexedFile = pIndex->indexDocument(*pTokenizer, labels, docId);
+			if (indexedFile == true)
+			{
+				time_t messageDate = boxParser.getDate();
+
+				if (messageDate > lastMessageTime)
+				{
+					// This is the latest message so far
+					lastMessageTime = messageDate;
+				}
+
+				pIndex->setDocumentLabels(docId, labels);
+
+				IndexedDocument docInfo(pMessage->getTitle(),
+					XapianEngine::buildUrl(PinotSettings::getInstance().m_mailIndexLocation, docId),
+					pMessage->getLocation(), pMessage->getType(), pMessage->getLanguage());
+				docInfo.setTimestamp(TimeConverter::toTimestamp(messageDate));
+
+				// Signal
+				m_signalUpdate(docInfo, docId, _("My Email"));
+			}
+#ifdef DEBUG
+			else cout << "MboxHandler::parseMailAccount: couldn't index message " << docNum << endl;
+#endif
+
+			delete pTokenizer;
+		}
+		else
+		{
+#ifdef DEBUG
+			cout << "MboxHandler::parseMailAccount: already indexed message "
+				<< docNum << ", document ID " << docId << endl;
+#endif
+			if (sourceLabel.empty() == false)
+			{
+				set<string> labels;
+
+				// Get the message's labels
+				pIndex->getDocumentLabels(docId, labels);
+				// The source label must have been applied to the message when originally indexed
+				set<string>::iterator labelIter = labels.find(sourceLabel.c_str());
+				if (labelIter != labels.end())
+				{
+					// Erase it
+					labels.erase(labelIter);
+					// Add the temporary label
+					labels.insert(tempSourceLabel);
+					pIndex->setDocumentLabels(docId, labels);
+				}
+			}
+		}
+
+		// More messages ?
+		if (boxParser.nextMessage() == false)
+		{
+#ifdef DEBUG
+			cout << "MboxHandler::parseMailAccount: no more messages from parser" << endl;
+#endif
+			break;
+		}
+		pMessage = boxParser.getDocument();
+		++docNum;
+	}
+#ifdef DEBUG
+	long microsecs = timer.stop();
+	cout << "MboxHandler::parseMailAccount: parsed " << docNum << " documents in "
+		<< microsecs/1000000 << " seconds (" << microsecs << ")" << endl;
+#endif
+
+	return indexedFile;
+}
+
+bool MboxHandler::deleteMessages(IndexInterface *pIndex, const string &sourceLabel)
+{
+	set<unsigned int> docIdList;
+	bool unindexedMsgs = false;
+
+	if (pIndex == NULL)
+	{
+		return false;
+	}
+
+	// Unindex all documents labeled with this source label
+	if ((pIndex->listDocumentsWithLabel(sourceLabel, docIdList) == true) &&
+		(docIdList.empty() == false))
+	{
+#ifdef DEBUG
+		cout << "MboxHandler::deleteMessages: " << docIdList.size() << " message(s) to unindex" << endl;
+#endif
+		for (set<unsigned int>::iterator docIter = docIdList.begin();
+			docIter != docIdList.end(); ++docIter)
+		{
+#ifdef DEBUG
+			cout << "MboxHandler::deleteMessages: unindexing document ID " << *docIter << endl;
+#endif
+			if (pIndex->unindexDocument(*docIter) == true)
+			{
+				unindexedMsgs = true;
+			}
+		}
+	}
+
+	return unindexedMsgs;
+}
+
+bool MboxHandler::getLocations(set<string> &newLocations,
+	set<string> &locationsToRemove)
+{
+	newLocations.clear();
+	locationsToRemove.clear();
+
+	copy(m_locations.begin(), m_locations.end(),
+		inserter(locationsToRemove, locationsToRemove.begin()));
+
+	// Get the mail accounts map
+	set<PinotSettings::MailAccount> &mailAccounts = PinotSettings::getInstance().m_mailAccounts;
+	for (set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.begin();
+		mailIter != mailAccounts.end(); ++mailIter)
+	{
+		// Is this a known location ?
+		set<string>::iterator locationIter = m_locations.find(mailIter->m_name);
+		if (locationIter == m_locations.end())
+		{
+			// No, it is new
+			m_locations.insert(mailIter->m_name);
+			newLocations.insert(mailIter->m_name);
+		}
+		else
+		{
+			// Since it's a known location, we'd better not remove it
+			set<string>::iterator removeIter = locationsToRemove.find(mailIter->m_name);
+			if (removeIter != locationsToRemove.end())
+			{
+				locationsToRemove.erase(removeIter);
+			}
+		}
+	}
+
+	// Locations in locationsToRemove have to be removed
+	for (set<string>::iterator removeIter = locationsToRemove.begin();
+		removeIter != locationsToRemove.end(); ++removeIter)
+	{
+		set<string>::iterator locationIter = m_locations.find(*removeIter);
+		if (locationIter != m_locations.end())
+		{
+			m_locations.erase(locationIter);
+		}
+	}
+
+#ifdef DEBUG
+	cout << "MboxHandler::getLocations: " << m_locations.size() << " locations, "
+		<< newLocations.size() << " new, " << locationsToRemove.size() << " to be removed" << endl;
+#endif
+
+	if ((newLocations.empty() == false) ||
+		(locationsToRemove.empty() == false))
+	{
+		return true;
+	}
+
+	return false;
+}
+
+bool MboxHandler::fileExists(const string &fileName)
+{
+	PinotSettings::MailAccount mailAccount;
+	off_t previousSize = 0;
+
+#ifdef DEBUG
+	cout << "MboxHandler::fileExists: " << fileName << endl;
+#endif
+	if (checkMailAccount(fileName, mailAccount, previousSize) == false)
+	{
+		return false;
+	}
+
+	// Come up with a label for this mbox file's messages
+	string sourceLabel = "mailbox://";
+	sourceLabel += fileName;
+	string tempSourceLabel = "Temp";
+	tempSourceLabel += sourceLabel;
+
+	// Get the mail index
+	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
+	if (index.isGood() == false)
+	{
+		cerr << "MboxHandler::fileExists: couldn't get mail index" << endl;
+		return false;
+	}
+
+	// Get a parser
+	MboxParser boxParser(fileName);
+
+	bool indexedFile = parseMailAccount(boxParser, &index, 
+		mailAccount.m_lastMessageTime, tempSourceLabel, sourceLabel);
+
+	// Any document still labeled with this source label wasn't found
+	// this time around and should be unindexed
+	if (deleteMessages(&index, sourceLabel) == true)
+	{
+		indexedFile = true;
+	}
+
+	// Rename the temporary label for next time the mbox is parsed
+	index.deleteLabel(sourceLabel);
+	index.renameLabel(tempSourceLabel, sourceLabel);
+
+	// Flush the index
+	index.flush();
+
+	// Update this mail account in the list
+	set<PinotSettings::MailAccount> &mailAccounts = PinotSettings::getInstance().m_mailAccounts;
+	set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.find(mailAccount);
+	if (mailIter != mailAccounts.end())
+	{
+		mailAccounts.erase(mailIter);
+	}
+	mailAccounts.insert(mailAccount);
+
+	return indexedFile;
+}
+
+bool MboxHandler::fileCreated(const string &fileName)
+{
+	// Nothing to do here
+	return true;
+}
+
+bool MboxHandler::fileModified(const string &fileName)
+{
+	PinotSettings::MailAccount mailAccount;
+	off_t previousSize = 0, mboxOffset = 0;
+
+#ifdef DEBUG
+	cout << "MboxHandler::fileModified: " << fileName << " changed" << endl;
+#endif
+	if (checkMailAccount(fileName, mailAccount, previousSize) == false)
+	{
+		return false;
+	}
+
+	if (mailAccount.m_size <= previousSize)
+	{
+		// Parse the file from the beginning...
+#ifdef DEBUG
+		cout << "MboxHandler::fileModified: file smaller or same size" << endl;
+#endif
+		return fileExists(fileName);
+	}
+#ifdef DEBUG
+	else cout << "MboxHandler::fileModified: file now larger than " << previousSize << endl;
+#endif
+
+	// Chances are new messages were added but none removed
+	mboxOffset = previousSize;
+
+	// Come up with a label for this mbox file's messages
+	string sourceLabel = "mailbox://";
+	sourceLabel += fileName;
+
+	// Get the mail index
+	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
+	if (index.isGood() == false)
+	{
+		cerr << "MboxHandler::fileModified: couldn't get mail index" << endl;
+		return false;
+	}
+
+	// Get a parser
+	MboxParser boxParser(fileName, mboxOffset);
+
+	bool indexedFile = parseMailAccount(boxParser, &index,
+		mailAccount.m_lastMessageTime, sourceLabel, "");
+	if (indexedFile == true)
+	{
+		// Do not attempt to find out if some of the messages were removed
+		// Some messages may also be indexed twice now, eg if another message
+		// was inserted and changed offsets
+		// Let the next fileExists() deal with it and clean up the whole thing
+
+		// Flush the index
+		index.flush();
+	}
+
+	// Update this mail account in the list
+	set<PinotSettings::MailAccount> &mailAccounts = PinotSettings::getInstance().m_mailAccounts;
+	set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.find(mailAccount);
+	if (mailIter != mailAccounts.end())
+	{
+		mailAccounts.erase(mailIter);
+	}
+	mailAccounts.insert(mailAccount);
+
+	return indexedFile;
+}
+
+bool MboxHandler::fileMoved(const string &fileName)
+{
+	// Nothing to do here
+	return true;
+}
+
+bool MboxHandler::fileDeleted(const string &fileName)
+{
+	string sourceLabel = string("mailbox://") + fileName;
+	bool unindexedFile = false;
+
+	// Get the mail index
+	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
+	if (index.isGood() == false)
+	{
+		cerr << "MboxHandler::fileDeleted: couldn't get mail index" << endl;
+		return false;
+	}
+
+	// Unindex all documents labeled with this source label
+	if (deleteMessages(&index, sourceLabel) == true)
+	{
+		// Delete the label
+		index.deleteLabel(sourceLabel);
+
+		return true;
+	}
+
+	return false;
+}

Added: trunk/UI/GTK2/src/MboxHandler.h
===================================================================
--- trunk/UI/GTK2/src/MboxHandler.h	2006-05-20 04:00:42 UTC (rev 249)
+++ trunk/UI/GTK2/src/MboxHandler.h	2006-05-20 04:30:58 UTC (rev 250)
@@ -0,0 +1,76 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+ 
+#ifndef _MBOXHANDLER_HH
+#define _MBOXHANDLER_HH
+
+#include <time.h>
+#include <string>
+#include <set>
+#include <map>
+#include <sigc++/slot.h>
+
+#include "IndexedDocument.h"
+#include "MboxParser.h"
+#include "IndexInterface.h"
+#include "MonitorHandler.h"
+#include "PinotSettings.h"
+
+class MboxHandler : public MonitorHandler
+{
+	public:
+		MboxHandler();
+		virtual ~MboxHandler();
+
+		/// Returns locations.
+		virtual bool getLocations(std::set<std::string> &newLocations,
+			std::set<std::string> &locationsToRemove);
+
+		/// Handles file existence events.
+		virtual bool fileExists(const std::string &fileName);
+
+		/// Handles file creation events.
+		virtual bool fileCreated(const std::string &fileName);
+
+		/// Handles file modified events.
+		virtual bool fileModified(const std::string &fileName);
+
+		/// Handles file moved events.
+		virtual bool fileMoved(const std::string &fileName);
+
+		/// Handles file deleted events.
+		virtual bool fileDeleted(const std::string &fileName);
+
+	protected:
+		unsigned int m_locationsCount;
+		std::set<std::string> m_locations;
+
+		bool checkMailAccount(const std::string &fileName, PinotSettings::MailAccount &mailAccount,
+			off_t &previousSize);
+
+		bool parseMailAccount(MboxParser &boxParser, IndexInterface *pIndex,
+			time_t &lastMessageTime, const std::string &tempSourceLabel,
+			const std::string &sourceLabel);
+
+		bool deleteMessages(IndexInterface *pIndex, const std::string &sourceLabel);
+
+	private:
+		MboxHandler(const MboxHandler &other);
+		MboxHandler &operator=(const MboxHandler &other);
+
+};
+
+#endif // _MBOXHANDLER_HH

Deleted: trunk/UI/GTK2/src/MonitorHandler.cpp
===================================================================
--- trunk/UI/GTK2/src/MonitorHandler.cpp	2006-05-20 04:00:42 UTC (rev 249)
+++ trunk/UI/GTK2/src/MonitorHandler.cpp	2006-05-20 04:30:58 UTC (rev 250)
@@ -1,478 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <fcntl.h>
-#include <unistd.h>
-#include <iostream>
-#include <fstream>
-
-#include "config.h"
-#include "NLS.h"
-#include "StringManip.h"
-#include "Timer.h"
-#include "TimeConverter.h"
-#include "TokenizerFactory.h"
-#include "FileCollector.h"
-#include "XapianIndex.h"
-#include "XapianEngine.h"
-#include "PinotUtils.h"
-#include "MonitorHandler.h"
-
-using namespace std;
-using namespace SigC;
-
-MonitorHandler::MonitorHandler()
-{
-}
-
-MonitorHandler::~MonitorHandler()
-{
-}
-
-Signal3<void, IndexedDocument, unsigned int, string>& MonitorHandler::getUpdateSignal(void)
-{
-	return m_signalUpdate;
-}
-
-MboxHandler::MboxHandler() :
-	MonitorHandler(),
-	m_locationsCount(0)
-{
-}
-
-MboxHandler::~MboxHandler()
-{
-}
-
-bool MboxHandler::checkMailAccount(const string &fileName, PinotSettings::MailAccount &mailAccount,
-		off_t &previousSize)
-{
-	struct stat fileStat;
-
-	mailAccount.m_name = to_utf8(fileName);
-
-	// Ensure it's one of our mail accounts
-	set<PinotSettings::MailAccount> &mailAccounts = PinotSettings::getInstance().m_mailAccounts;
-	set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.find(mailAccount);
-	if (mailIter == mailAccounts.end())
-	{
-		// It doesn't seem to be
-#ifdef DEBUG
-		cout << "MboxHandler::checkMailAccount: not one of " << mailAccounts.size() << " accounts" << endl;
-#endif
-		return false;
-	}
-
-	// Find out when it was last modified
-	if ((stat(fileName.c_str(), &fileStat) == 0) &&
-		(!S_ISREG(fileStat.st_mode)))
-	{
-		// This is not a file !
-		return false;
-	}
-
-	if (fileStat.st_mtime <= mailIter->m_modTime)
-	{
-		// No change since last time...
-#ifdef DEBUG
-		cout << "MboxHandler::checkMailAccount: not modified since last time ("
-			<< mailIter->m_modTime << ">" << fileStat.st_mtime << ")" << endl;
-#endif
-		return false;
-	}
-#ifdef DEBUG
-	cout << "MboxHandler::checkMailAccount: modified since last time ("
-		<< mailIter->m_modTime << "<" << fileStat.st_mtime << ")" << endl;
-#endif
-
-	// Update this mail account's properties
-	mailAccount = (*mailIter);
-	mailAccount.m_modTime = fileStat.st_mtime;
-	previousSize = mailAccount.m_size;
-	mailAccount.m_size = fileStat.st_size;
-
-	return true;
-}
-
-bool MboxHandler::parseMailAccount(MboxParser &boxParser, IndexInterface *pIndex,
-	time_t &lastMessageTime,
-	const string &tempSourceLabel, const string &sourceLabel)
-{
-	bool indexedFile = false;
-
-	if (pIndex == NULL)
-	{
-		return false;
-	}
-
-	// Parse the mbox file
-#ifdef DEBUG
-	Timer timer;
-	timer.start();
-#endif
-	const Document *pMessage = boxParser.getDocument();
-	unsigned int docNum = 0;
-
-	while (pMessage != NULL)
-	{
-		// Has this message already been indexed ?
-		unsigned int docId = pIndex->hasDocument(pMessage->getLocation());
-		if (docId == 0)
-		{
-			pIndex->setStemmingMode(IndexInterface::STORE_BOTH);
-
-			// Get an ad hoc tokenizer for the message
-			Tokenizer *pTokenizer = TokenizerFactory::getTokenizerByType(pMessage->getType(), pMessage);
-			if (pTokenizer == NULL)
-			{
-#ifdef DEBUG
-				cout << "MboxHandler::parseMailAccount: no tokenizer for message " << docNum << endl;
-#endif
-				break;	
-			}
-
-			set<string> labels;
-			labels.insert(tempSourceLabel);
-
-			unsigned int docId = 0;
-			indexedFile = pIndex->indexDocument(*pTokenizer, labels, docId);
-			if (indexedFile == true)
-			{
-				time_t messageDate = boxParser.getDate();
-
-				if (messageDate > lastMessageTime)
-				{
-					// This is the latest message so far
-					lastMessageTime = messageDate;
-				}
-
-				pIndex->setDocumentLabels(docId, labels);
-
-				IndexedDocument docInfo(pMessage->getTitle(),
-					XapianEngine::buildUrl(PinotSettings::getInstance().m_mailIndexLocation, docId),
-					pMessage->getLocation(), pMessage->getType(), pMessage->getLanguage());
-				docInfo.setTimestamp(TimeConverter::toTimestamp(messageDate));
-
-				// Signal
-				m_signalUpdate(docInfo, docId, _("My Email"));
-			}
-#ifdef DEBUG
-			else cout << "MboxHandler::parseMailAccount: couldn't index message " << docNum << endl;
-#endif
-
-			delete pTokenizer;
-		}
-		else
-		{
-#ifdef DEBUG
-			cout << "MboxHandler::parseMailAccount: already indexed message "
-				<< docNum << ", document ID " << docId << endl;
-#endif
-			if (sourceLabel.empty() == false)
-			{
-				set<string> labels;
-
-				// Get the message's labels
-				pIndex->getDocumentLabels(docId, labels);
-				// The source label must have been applied to the message when originally indexed
-				set<string>::iterator labelIter = labels.find(sourceLabel.c_str());
-				if (labelIter != labels.end())
-				{
-					// Erase it
-					labels.erase(labelIter);
-					// Add the temporary label
-					labels.insert(tempSourceLabel);
-					pIndex->setDocumentLabels(docId, labels);
-				}
-			}
-		}
-
-		// More messages ?
-		if (boxParser.nextMessage() == false)
-		{
-#ifdef DEBUG
-			cout << "MboxHandler::parseMailAccount: no more messages from parser" << endl;
-#endif
-			break;
-		}
-		pMessage = boxParser.getDocument();
-		++docNum;
-	}
-#ifdef DEBUG
-	long microsecs = timer.stop();
-	cout << "MboxHandler::parseMailAccount: parsed " << docNum << " documents in "
-		<< microsecs/1000000 << " seconds (" << microsecs << ")" << endl;
-#endif
-
-	return indexedFile;
-}
-
-bool MboxHandler::deleteMessages(IndexInterface *pIndex, const string &sourceLabel)
-{
-	set<unsigned int> docIdList;
-	bool unindexedMsgs = false;
-
-	if (pIndex == NULL)
-	{
-		return false;
-	}
-
-	// Unindex all documents labeled with this source label
-	if ((pIndex->listDocumentsWithLabel(sourceLabel, docIdList) == true) &&
-		(docIdList.empty() == false))
-	{
-#ifdef DEBUG
-		cout << "MboxHandler::deleteMessages: " << docIdList.size() << " message(s) to unindex" << endl;
-#endif
-		for (set<unsigned int>::iterator docIter = docIdList.begin();
-			docIter != docIdList.end(); ++docIter)
-		{
-#ifdef DEBUG
-			cout << "MboxHandler::deleteMessages: unindexing document ID " << *docIter << endl;
-#endif
-			if (pIndex->unindexDocument(*docIter) == true)
-			{
-				unindexedMsgs = true;
-			}
-		}
-	}
-
-	return unindexedMsgs;
-}
-
-bool MboxHandler::getLocations(set<string> &newLocations,
-	set<string> &locationsToRemove)
-{
-	newLocations.clear();
-	locationsToRemove.clear();
-
-	copy(m_locations.begin(), m_locations.end(),
-		inserter(locationsToRemove, locationsToRemove.begin()));
-
-	// Get the mail accounts map
-	set<PinotSettings::MailAccount> &mailAccounts = PinotSettings::getInstance().m_mailAccounts;
-	for (set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.begin();
-		mailIter != mailAccounts.end(); ++mailIter)
-	{
-		// Is this a known location ?
-		set<string>::iterator locationIter = m_locations.find(mailIter->m_name);
-		if (locationIter == m_locations.end())
-		{
-			// No, it is new
-			m_locations.insert(mailIter->m_name);
-			newLocations.insert(mailIter->m_name);
-		}
-		else
-		{
-			// Since it's a known location, we'd better not remove it
-			set<string>::iterator removeIter = locationsToRemove.find(mailIter->m_name);
-			if (removeIter != locationsToRemove.end())
-			{
-				locationsToRemove.erase(removeIter);
-			}
-		}
-	}
-
-	// Locations in locationsToRemove have to be removed
-	for (set<string>::iterator removeIter = locationsToRemove.begin();
-		removeIter != locationsToRemove.end(); ++removeIter)
-	{
-		set<string>::iterator locationIter = m_locations.find(*removeIter);
-		if (locationIter != m_locations.end())
-		{
-			m_locations.erase(locationIter);
-		}
-	}
-
-#ifdef DEBUG
-	cout << "MboxHandler::getLocations: " << m_locations.size() << " locations, "
-		<< newLocations.size() << " new, " << locationsToRemove.size() << " to be removed" << endl;
-#endif
-
-	if ((newLocations.empty() == false) ||
-		(locationsToRemove.empty() == false))
-	{
-		return true;
-	}
-
-	return false;
-}
-
-bool MboxHandler::fileExists(const string &fileName)
-{
-	PinotSettings::MailAccount mailAccount;
-	off_t previousSize = 0;
-
-#ifdef DEBUG
-	cout << "MboxHandler::fileExists: " << fileName << endl;
-#endif
-	if (checkMailAccount(fileName, mailAccount, previousSize) == false)
-	{
-		return false;
-	}
-
-	// Come up with a label for this mbox file's messages
-	string sourceLabel = "mailbox://";
-	sourceLabel += fileName;
-	string tempSourceLabel = "Temp";
-	tempSourceLabel += sourceLabel;
-
-	// Get the mail index
-	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
-	if (index.isGood() == false)
-	{
-		cerr << "MboxHandler::fileExists: couldn't get mail index" << endl;
-		return false;
-	}
-
-	// Get a parser
-	MboxParser boxParser(fileName);
-
-	bool indexedFile = parseMailAccount(boxParser, &index, 
-		mailAccount.m_lastMessageTime, tempSourceLabel, sourceLabel);
-
-	// Any document still labeled with this source label wasn't found
-	// this time around and should be unindexed
-	if (deleteMessages(&index, sourceLabel) == true)
-	{
-		indexedFile = true;
-	}
-
-	// Rename the temporary label for next time the mbox is parsed
-	index.deleteLabel(sourceLabel);
-	index.renameLabel(tempSourceLabel, sourceLabel);
-
-	// Flush the index
-	index.flush();
-
-	// Update this mail account in the list
-	set<PinotSettings::MailAccount> &mailAccounts = PinotSettings::getInstance().m_mailAccounts;
-	set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.find(mailAccount);
-	if (mailIter != mailAccounts.end())
-	{
-		mailAccounts.erase(mailIter);
-	}
-	mailAccounts.insert(mailAccount);
-
-	return indexedFile;
-}
-
-bool MboxHandler::fileCreated(const string &fileName)
-{
-	// Nothing to do here
-	return true;
-}
-
-bool MboxHandler::fileModified(const string &fileName)
-{
-	PinotSettings::MailAccount mailAccount;
-	off_t previousSize = 0, mboxOffset = 0;
-
-#ifdef DEBUG
-	cout << "MboxHandler::fileModified: " << fileName << " changed" << endl;
-#endif
-	if (checkMailAccount(fileName, mailAccount, previousSize) == false)
-	{
-		return false;
-	}
-
-	if (mailAccount.m_size <= previousSize)
-	{
-		// Parse the file from the beginning...
-#ifdef DEBUG
-		cout << "MboxHandler::fileModified: file smaller or same size" << endl;
-#endif
-		return fileExists(fileName);
-	}
-#ifdef DEBUG
-	else cout << "MboxHandler::fileModified: file now larger than " << previousSize << endl;
-#endif
-
-	// Chances are new messages were added but none removed
-	mboxOffset = previousSize;
-
-	// Come up with a label for this mbox file's messages
-	string sourceLabel = "mailbox://";
-	sourceLabel += fileName;
-
-	// Get the mail index
-	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
-	if (index.isGood() == false)
-	{
-		cerr << "MboxHandler::fileModified: couldn't get mail index" << endl;
-		return false;
-	}
-
-	// Get a parser
-	MboxParser boxParser(fileName, mboxOffset);
-
-	bool indexedFile = parseMailAccount(boxParser, &index,
-		mailAccount.m_lastMessageTime, sourceLabel, "");
-	if (indexedFile == true)
-	{
-		// Do not attempt to find out if some of the messages were removed
-		// Some messages may also be indexed twice now, eg if another message
-		// was inserted and changed offsets
-		// Let the next fileExists() deal with it and clean up the whole thing
-
-		// Flush the index
-		index.flush();
-	}
-
-	// Update this mail account in the list
-	set<PinotSettings::MailAccount> &mailAccounts = PinotSettings::getInstance().m_mailAccounts;
-	set<PinotSettings::MailAccount>::iterator mailIter = mailAccounts.find(mailAccount);
-	if (mailIter != mailAccounts.end())
-	{
-		mailAccounts.erase(mailIter);
-	}
-	mailAccounts.insert(mailAccount);
-
-	return indexedFile;
-}
-
-bool MboxHandler::fileMoved(const string &fileName)
-{
-	// Nothing to do here
-	return true;
-}
-
-bool MboxHandler::fileDeleted(const string &fileName)
-{
-	string sourceLabel = string("mailbox://") + fileName;
-	bool unindexedFile = false;
-
-	// Get the mail index
-	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);
-	if (index.isGood() == false)
-	{
-		cerr << "MboxHandler::fileDeleted: couldn't get mail index" << endl;
-		return false;
-	}
-
-	// Unindex all documents labeled with this source label
-	if (deleteMessages(&index, sourceLabel) == true)
-	{
-		// Delete the label
-		index.deleteLabel(sourceLabel);
-
-		return true;
-	}
-
-	return false;
-}

Deleted: trunk/UI/GTK2/src/MonitorHandler.h
===================================================================
--- trunk/UI/GTK2/src/MonitorHandler.h	2006-05-20 04:00:42 UTC (rev 249)
+++ trunk/UI/GTK2/src/MonitorHandler.h	2006-05-20 04:30:58 UTC (rev 250)
@@ -1,112 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
- 
-#ifndef _MONITORHANDLER_HH
-#define _MONITORHANDLER_HH
-
-#include <time.h>
-#include <string>
-#include <set>
-#include <map>
-#include <sigc++/slot.h>
-
-#include "DocumentInfo.h"
-#include "IndexedDocument.h"
-#include "MboxParser.h"
-#include "IndexInterface.h"
-#include "PinotSettings.h"
-
-class MonitorHandler
-{
-	public:
-		MonitorHandler();
-		virtual ~MonitorHandler();
-
-		/// Returns locations.
-		virtual bool getLocations(std::set<std::string> &newLocations,
-			std::set<std::string> &locationsToRemove) = 0;
-
-		/// Handles file existence events.
-		virtual bool fileExists(const string &fileName) = 0;
-
-		/// Handles file creation events.
-		virtual bool fileCreated(const std::string &fileName) = 0;
-
-		/// Handles file modified events.
-		virtual bool fileModified(const std::string &fileName) = 0;
-
-		/// Handles file moved events.
-		virtual bool fileMoved(const std::string &fileName) = 0;
-
-		/// Handles file deleted events.
-		virtual bool fileDeleted(const std::string &fileName) = 0;
-
-		SigC::Signal3<void, IndexedDocument, unsigned int, std::string>& getUpdateSignal(void);
-
-	protected:
-		SigC::Signal3<void, IndexedDocument, unsigned int, std::string> m_signalUpdate;
-
-	private:
-		MonitorHandler(const MonitorHandler &other);
-		MonitorHandler &operator=(const MonitorHandler &other);
-
-};
-
-class MboxHandler : public MonitorHandler
-{
-	public:
-		MboxHandler();
-		virtual ~MboxHandler();
-
-		/// Returns locations.
-		virtual bool getLocations(std::set<std::string> &newLocations,
-			std::set<std::string> &locationsToRemove);
-
-		/// Handles file existence events.
-		virtual bool fileExists(const string &fileName);
-
-		/// Handles file creation events.
-		virtual bool fileCreated(const std::string &fileName);
-
-		/// Handles file modified events.
-		virtual bool fileModified(const std::string &fileName);
-
-		/// Handles file moved events.
-		virtual bool fileMoved(const std::string &fileName);
-
-		/// Handles file deleted events.
-		virtual bool fileDeleted(const std::string &fileName);
-
-	protected:
-		unsigned int m_locationsCount;
-		std::set<std::string> m_locations;
-
-		bool checkMailAccount(const std::string &fileName, PinotSettings::MailAccount &mailAccount,
-			off_t &previousSize);
-
-		bool parseMailAccount(MboxParser &boxParser, IndexInterface *pIndex,
-			time_t &lastMessageTime, const std::string &tempSourceLabel,
-			const std::string &sourceLabel);
-
-		bool deleteMessages(IndexInterface *pIndex, const std::string &sourceLabel);
-
-	private:
-		MboxHandler(const MboxHandler &other);
-		MboxHandler &operator=(const MboxHandler &other);
-
-};
-
-#endif	// _MONITORHANDLER_HH

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-20 04:00:42 UTC (rev 249)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-20 04:30:58 UTC (rev 250)
@@ -22,7 +22,7 @@
 #include <fcntl.h>
 #include <string.h>
 #include <signal.h>
-#include <fam.h>
+#include <errno.h>
 #include <exception>
 #include <iostream>
 #include <fstream>
@@ -36,6 +36,7 @@
 #include "Url.h"
 #include "QueryHistory.h"
 #include "IndexedDocument.h"
+#include "MonitorFactory.h"
 #include "DownloaderFactory.h"
 #include "SearchEngineFactory.h"
 #ifdef HAS_GOOGLEAPI
@@ -1185,15 +1186,14 @@
 
 void MonitorThread::doWork(void)
 {
-	FAMConnection famConn;
-	FAMRequest famReq;
-	map<unsigned long, string> fsLocations;
+	MonitorInterface *pMonitor = MonitorFactory::getMonitor();
+	set<string> newLocations;
+	set<string> locationsToRemove;
 	bool setLocationsToMonitor = true;
-	bool firstTime = true;
-	bool closeMonitor = false, resumeMonitor = false;
-	int famStatus = -1;
+	bool resumeMonitor = false;
 
-	if (m_pHandler == NULL)
+	if ((m_pHandler == NULL) ||
+		(pMonitor == NULL))
 	{
 		m_status = _("No monitoring handler");
 		return;
@@ -1204,7 +1204,7 @@
 	{
 		struct timeval selectTimeout;
 		fd_set listenSet;
-		int famFd = -1;
+		int monitorFd = -1;
 
 		selectTimeout.tv_sec = 60;
 		selectTimeout.tv_usec = 0;
@@ -1216,69 +1216,46 @@
 		}
 
 		if ((setLocationsToMonitor == true) &&
-			(m_pHandler->getFileSystemLocations(fsLocations) > 0) &&
-			(m_pHandler->hasNewLocations() == true))
+			(m_pHandler->getLocations(newLocations, locationsToRemove) == true))
 		{
-			// Tell FAM what we want to monitor
+			// Specify what we want to monitor
 #ifdef DEBUG
 			cout << "MonitorThread::doWork: change detected" << endl;
 #endif
-			if (firstTime == false)
-			{
-				// Cancel
-				FAMCancelMonitor(&famConn, &famReq);
-				FAMClose(&famConn);
-			}
-			else
-			{
-				firstTime = false;
-			}
 			resumeMonitor = false;
 
-			// FIXME: opening a new connection every time might be overkill
-			if (FAMOpen(&famConn) != 0)
+			// Add new locations
+			for (set<string>::const_iterator locationIter = newLocations.begin();
+				(locationIter != newLocations.end()) && (m_done == false); ++locationIter)
 			{
-				m_status = _("Couldn't open FAM connection");
-				return;
-			}
-			closeMonitor = true;
-
-			// Go through the locations map
-			for (map<unsigned long, string>::const_iterator fsIter = fsLocations.begin(); fsIter != fsLocations.end(); ++fsIter)
-			{
-				string fsLocation = fsIter->second;
-				struct stat fileStat;
-
-				if (m_done == true)
+				// Monitor this
+				if (pMonitor->addLocation(*locationIter) == true)
 				{
-					break;
+					// Confirm the file exists
+					m_pHandler->fileExists(*locationIter);
 				}
-				if (stat(fsLocation.c_str(), &fileStat) == -1)
-				{
-					continue;
-				}
+			}
 
-				// Is that a file or a directory ?
-				if (S_ISREG(fileStat.st_mode))
-				{
-					famStatus = FAMMonitorFile(&famConn, fsLocation.c_str(), &famReq, NULL);
-				}
-				else if (S_ISDIR(fileStat.st_mode))
-				{
-					// FIXME: FAM works one level deep only: monitor sub-directories if there are any...
-					famStatus = FAMMonitorDirectory(&famConn, fsLocation.c_str(), &famReq, (void*)(fsIter->first + 1));
-				}
-#ifdef DEBUG
-				cout << "MonitorThread::doWork: added " << fsLocation << ", " << famStatus << endl;
-#endif
+			// Remove others
+			for (set<string>::const_iterator locationIter = locationsToRemove.begin();
+				(locationIter != locationsToRemove.end()) && (m_done == false); ++locationIter)
+			{
+				// Stop monitoring this
+				pMonitor->removeLocation(*locationIter);
 			}
 
-			famFd = FAMCONNECTION_GETFD(&famConn);
-			FD_SET(famFd, &listenSet);
+			monitorFd = pMonitor->getFileDescriptor();
+			FD_SET(monitorFd, &listenSet);
 		}
 		setLocationsToMonitor = false;
 
-		int fdCount = select(max(famFd, m_ctrlReadPipe) + 1, &listenSet, NULL, NULL, &selectTimeout);
+		if (monitorFd < 0)
+		{
+			m_status = _("Couldn't initialize file monitor");
+			return;
+		}
+
+		int fdCount = select(max(monitorFd, m_ctrlReadPipe) + 1, &listenSet, NULL, NULL, &selectTimeout);
 		if ((fdCount < 0) &&
 			(errno != EINTR))
 		{
@@ -1287,21 +1264,22 @@
 #endif
 			break;
 		}
-		else if ((famFd >= 0) &&
-			(FD_ISSET(famFd, &listenSet)))
+		else if (FD_ISSET(monitorFd, &listenSet))
 		{
+			queue<MonitorEvent> events;
+
 			// There might be more than one event waiting...
-			int pendingEvents = FAMPending(&famConn);
-			if (pendingEvents < 0)
+			if (pMonitor->retrievePendingEvents(events) == false)
 			{
 #ifdef DEBUG
-				cout << "MonitorThread::doWork: FAMPending() failed" << endl;
+				cout << "MonitorThread::doWork: failed to retrieve pending events" << endl;
 #endif
 				break;
 			}
-			while ((pendingEvents >= 1) &&
-				(m_done == false))
+
+			while ((events.empty() == false) && (m_done == false))
 			{
+				MonitorEvent &event = events.front();
 				double averageLoad[3];
 
 				// Get the load averaged over the last minute
@@ -1312,77 +1290,44 @@
 					{
 						// Ignore pending events if the load has become too high
 #ifdef DEBUG
-						cout << "MonitorThread::doWork: cancelling monitoring because of load (" << averageLoad[0] << ")" << endl;
+						cout << "MonitorThread::doWork: ignoring events because of load ("
+							<< averageLoad[0] << ")" << endl;
 #endif
-						FAMCancelMonitor(&famConn, &famReq);
 						resumeMonitor = true;
 						break;
 					}
 				}
 
-				FAMEvent famEvent;
-				if ((FAMNextEvent(&famConn, &famEvent) == 1) &&
-					(famEvent.filename != NULL) &&
-					(strlen(famEvent.filename) > 0))
+				if ((event.m_location.empty() == true) ||
+					(event.m_type == MonitorEvent::UNKNOWN))
 				{
-					string fileName;
-					bool updatedIndex = false;
+					// Next
+					events.pop();
+					continue;
+				}
 
-#ifdef DEBUG
-					cout << "MonitorThread::doWork: event " << famEvent.code
-						<< " on " << famEvent.filename << endl;
-#endif
-					if (famEvent.code == FAMEndExist)
-					{
-						updatedIndex = m_pHandler->fileExists(famEvent.filename, true);
-						// FIXME: accounts for which we didn't receive a FAMExists should
-						// be removed
-					}
-					else
-					{
-						// Are we monitoring a file or a directory ?
-						if (famEvent.userdata != NULL)
-						{
-							// A directory...
-							if (famEvent.filename[0] == '/')
-							{
-								// Not interested in monitored directories...
-								continue;
-							}
+				bool updatedIndex = false;
 
-							// The event is on a file in that directory
-							map<unsigned long, string>::const_iterator fsIter = fsLocations.find((unsigned long)famEvent.userdata);
-							if (fsIter == fsLocations.end())
-							{
-								continue;
-							}
-							fileName += fsIter->second;
-							fileName += "/";
-						}
-						fileName += famEvent.filename;
-
-						// What's the event code ?
-						if (famEvent.code == FAMExists)
-						{
-							updatedIndex = m_pHandler->fileExists(fileName);
-						}
-						else if (famEvent.code == FAMCreated)
-						{
-							m_pHandler->fileCreated(fileName);
-						}
-						else if (famEvent.code == FAMChanged)
-						{
-							updatedIndex = m_pHandler->fileChanged(fileName);
-						}
-						else if (famEvent.code == FAMDeleted)
-						{
-							updatedIndex = m_pHandler->fileDeleted(fileName);
-						}
-					}
+				// What's the event code ?
+				if (event.m_type == MonitorEvent::CREATED)
+				{
+					m_pHandler->fileCreated(event.m_location);
 				}
+				else if (event.m_type == MonitorEvent::WRITE_CLOSED)
+				{
+					updatedIndex = m_pHandler->fileModified(event.m_location);
+				}
+				else if (event.m_type == MonitorEvent::MOVED)
+				{
+					updatedIndex = m_pHandler->fileMoved(event.m_location);
+				}
+				else if (event.m_type == MonitorEvent::DELETED)
+				{
+					updatedIndex = m_pHandler->fileDeleted(event.m_location);
+				}
 
-				// Anything else pending ?
-				pendingEvents = FAMPending(&famConn);
+				// Next
+				events.pop();
 			}
 		}
 		else
@@ -1393,7 +1338,6 @@
 #ifdef DEBUG
 				cout << "MonitorThread::doWork: resuming monitoring" << endl;
 #endif
-				FAMResumeMonitor(&famConn, &famReq);
 				resumeMonitor = false;
 			}
 
@@ -1403,12 +1347,7 @@
 		}
 	}
 
-	if (closeMonitor == true)
-	{
-		// Stop monitoring and close the connection
-		FAMCancelMonitor(&famConn, &famReq);
-		FAMClose(&famConn);
-	}
+	delete pMonitor;
 }
 
 DirectoryScannerThread::DirectoryScannerThread(const string &dirName,



From fabricecolin at berlios.de  Sat May 20 07:10:36 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 20 May 2006 07:10:36 +0200
Subject: [Pinot-svn] r251 - in trunk/UI/GTK2: . src
Message-ID: <200605200510.k4K5Aael021575@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-20 07:10:25 +0200 (Sat, 20 May 2006)
New Revision: 251

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow_glade.cc
   trunk/UI/GTK2/src/mainWindow_glade.hh
Log:
The Show Extract and Group By menuitems are always visible and have effect
on all results tabs. Up to now, this wasn't very clear.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-05-20 04:30:58 UTC (rev 250)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-05-20 05:10:25 UTC (rev 251)
@@ -140,28 +140,6 @@
 		<widget class="GtkMenu" id="resultsMenuitem_menu">
 
 		  <child>
-		    <widget class="GtkImageMenuItem" id="clearresults1">
-		      <property agent="glademm" name="cxx_visibility">protected</property>
-		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">Clear List</property>
-		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="on_clearresults_activate" last_modification_time="Wed, 03 Mar 2004 19:51:48 GMT"/>
-
-		      <child internal-child="image">
-			<widget class="GtkImage" id="image569">
-			  <property name="visible">True</property>
-			  <property name="stock">gtk-clear</property>
-			  <property name="icon_size">1</property>
-			  <property name="xalign">0.5</property>
-			  <property name="yalign">0.5</property>
-			  <property name="xpad">0</property>
-			  <property name="ypad">0</property>
-			</widget>
-		      </child>
-		    </widget>
-		  </child>
-
-		  <child>
 		    <widget class="GtkCheckMenuItem" id="showextract1">
 		      <property agent="glademm" name="cxx_visibility">protected</property>
 		      <property name="visible">True</property>
@@ -209,6 +187,28 @@
 		  </child>
 
 		  <child>
+		    <widget class="GtkImageMenuItem" id="clearresults1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Clear List</property>
+		      <property name="use_underline">True</property>
+		      <signal name="activate" handler="on_clearresults_activate" last_modification_time="Wed, 03 Mar 2004 19:51:48 GMT"/>
+
+		      <child internal-child="image">
+			<widget class="GtkImage" id="image584">
+			  <property name="visible">True</property>
+			  <property name="stock">gtk-clear</property>
+			  <property name="icon_size">1</property>
+			  <property name="xalign">0.5</property>
+			  <property name="yalign">0.5</property>
+			  <property name="xpad">0</property>
+			  <property name="ypad">0</property>
+			</widget>
+		      </child>
+		    </widget>
+		  </child>
+
+		  <child>
 		    <widget class="GtkSeparatorMenuItem" id="separator1">
 		      <property name="visible">True</property>
 		    </widget>
@@ -276,7 +276,7 @@
 		      <signal name="activate" handler="on_import_activate" last_modification_time="Tue, 02 Mar 2004 22:13:44 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image570">
+			<widget class="GtkImage" id="image585">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-open</property>
 			  <property name="icon_size">1</property>
@@ -314,7 +314,7 @@
 		      <signal name="activate" handler="on_refreshindex_activate" last_modification_time="Fri, 20 Feb 2004 18:57:09 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image571">
+			<widget class="GtkImage" id="image586">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-refresh</property>
 			  <property name="icon_size">1</property>
@@ -336,7 +336,7 @@
 		      <signal name="activate" handler="on_unindex_activate" last_modification_time="Thu, 28 Jul 2005 12:42:23 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image572">
+			<widget class="GtkImage" id="image587">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-delete</property>
 			  <property name="icon_size">1</property>
@@ -358,7 +358,7 @@
 		      <signal name="activate" handler="on_showfromindex_activate" last_modification_time="Sun, 06 Nov 2005 08:43:05 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image573">
+			<widget class="GtkImage" id="image588">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-properties</property>
 			  <property name="icon_size">1</property>

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-20 04:30:58 UTC (rev 250)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-20 05:10:25 UTC (rev 251)
@@ -50,7 +50,8 @@
 	m_settings(settings),
 	m_pExtractScrolledwindow(NULL),
 	m_extractTextview(NULL),
-	m_showExtract(true)
+	m_showExtract(true),
+	m_groupBySearchEngine(true)
 {
 	m_pResultsScrolledwindow = manage(new ScrolledWindow());
 	m_pExtractScrolledwindow = manage(new ScrolledWindow());
@@ -598,15 +599,26 @@
 }
 
 //
-// Groups results.
+// Sets how results are grouped.
 //
-void ResultsTree::regroupResults(bool groupBySearchEngine)
+void ResultsTree::setGroupMode(bool groupBySearchEngine)
 {
 	ResultsModelColumns::ResultType currentType, newType;
 
-#ifdef DEBUG
-	cout << "ResultsTree::regroupResults: called" << endl;
-#endif
+	if (m_groupBySearchEngine == groupBySearchEngine)
+	{
+		// No change
+		return;
+	}
+	m_groupBySearchEngine = groupBySearchEngine;
+
+	// Do we need to update the tree ?
+	TreeModel::Children children = m_refStore->children();
+	if (children.empty() == true)
+	{
+		return;
+	}
+
 	// What's the new grouping criteria ?
 	if (groupBySearchEngine == true)
 	{
@@ -621,13 +633,6 @@
 		newType = ResultsModelColumns::RESULT_HOST;
 	}
 
-	// Go through tree rows
-	TreeModel::Children children = m_refStore->children();
-	if (children.empty() == true)
-	{
-		return;
-	}
-
 	// Clear the map
 	m_resultsGroups.clear();
 

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2006-05-20 04:30:58 UTC (rev 250)
+++ trunk/UI/GTK2/src/ResultsTree.h	2006-05-20 05:10:25 UTC (rev 251)
@@ -59,8 +59,8 @@
 			const std::vector<Result> &resultsList, const std::string &charset,
 			bool groupBySearchEngine);
 
-		/// Groups results.
-		void regroupResults(bool groupBySearchEngine);
+		/// Sets how results are grouped.
+		void setGroupMode(bool groupBySearchEngine);
 
 		/// Determines if results are selected.
 		bool checkSelection(void);
@@ -109,6 +109,7 @@
 		Gtk::TextView *m_extractTextview;
 		std::set<std::string> m_indexNames;
 		bool m_showExtract;
+		bool m_groupBySearchEngine;
 		std::set<std::string> m_queryTerms;
 
 		void renderViewStatus(Gtk::CellRenderer *renderer, const Gtk::TreeModel::iterator &iter);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-05-20 04:30:58 UTC (rev 250)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-05-20 05:10:25 UTC (rev 251)
@@ -45,6 +45,7 @@
 #include "XapianEngine.h"
 #include "config.h"
 #include "NLS.h"
+#include "MboxHandler.h"
 #include "PinotUtils.h"
 #include "mainWindow.hh"
 #include "importDialog.hh"
@@ -679,7 +680,9 @@
 				ResultsTree *pResultsTree = pResultsPage->getTree();
 				if (pResultsTree != NULL)
 				{
+					// Sync the results tree with the menuitems
 					pResultsTree->showExtract(showextract1->get_active());
+					pResultsTree->setGroupMode(searchenginegroup1->get_active());
 				}
 			}
 
@@ -886,8 +889,9 @@
 			// Position the results tree
 			pResultsTree = manage(new ResultsTree(queryName, resultsMenuitem->get_submenu(), m_settings));
 			pResultsPage = manage(new ResultsPage(queryName, pResultsTree, m_pNotebook->get_height(), m_settings));
-			// Show or hide the extract field
+			// Sync the results tree with the menuitems
 			pResultsTree->showExtract(showextract1->get_active());
+			pResultsTree->setGroupMode(searchenginegroup1->get_active());
 			// Connect to the "changed" signal
 			pResultsTree->getSelectionChangedSignal().connect(
 				SigC::slot(*this, &mainWindow::on_resultsTreeviewSelection_changed));
@@ -1582,7 +1586,7 @@
 			ResultsTree *pResultsTree = pResultsPage->getTree();
 			if (pResultsTree != NULL)
 			{
-				pResultsTree->regroupResults(searchenginegroup1->get_active());
+				pResultsTree->setGroupMode(searchenginegroup1->get_active());
 			}
 		}
 	}
@@ -2401,8 +2405,6 @@
 {
 	// Results menuitems that depend on the page
 	clearresults1->set_sensitive(showItems);
-	showextract1->set_sensitive(showItems);
-	groupresults1->set_sensitive(showItems);
 }
 
 //

Modified: trunk/UI/GTK2/src/mainWindow_glade.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.cc	2006-05-20 04:30:58 UTC (rev 250)
+++ trunk/UI/GTK2/src/mainWindow_glade.cc	2006-05-20 05:10:25 UTC (rev 251)
@@ -1,9 +1,9 @@
-// generated 2006/2/20 22:15:34 SGT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0
+// generated 2006/5/17 8:25:37 SGT by fabrice at amra.dyndns.org.(none)
+// using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.6.10 and gtkmm 2.6.2
+// for gtk 2.8.17 and gtkmm 2.8.3
 //
 // Please modify the corresponding derived classes in ./src/mainWindow.cc
 
@@ -25,18 +25,11 @@
 #  else
 #    define N_(String) (String)
 #  endif
-#else
-#  define textdomain(String) (String)
-#  define gettext(String) (String)
-#  define dgettext(Domain,Message) (Message)
-#  define dcgettext(Domain,Message,Type) (Message)
-#  define bindtextdomain(Domain,Directory) (Domain)
-#  define _(String) (String)
-#  define N_(String) (String)
 #endif
 #include <gtkmmconfig.h>
 #if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
 #include <sigc++/compatibility.h>
+#include <sigc++/bind.h>
 #define GMM_GTKMM_22_24(a,b) b
 #else //gtkmm 2.2
 #define GMM_GTKMM_22_24(a,b) a
@@ -54,7 +47,17 @@
 #include <gtkmm/buttonbox.h>
 #include <gtkmm/scrolledwindow.h>
 #include <gtkmm/alignment.h>
+#ifndef ENABLE_NLS
+#  define textdomain(String) (String)
+#  define gettext(String) (String)
+#  define dgettext(Domain,Message) (Message)
+#  define dcgettext(Domain,Message,Type) (Message)
+#  define bindtextdomain(Domain,Directory) (Domain)
+#  define _(String) (String)
+#  define N_(String) (String)
+#endif
 
+
 mainWindow_glade::mainWindow_glade(
 ) : Gtk::Window(Gtk::WINDOW_TOPLEVEL)
 {  mainWindow = this;
@@ -71,14 +74,14 @@
    delete1 = NULL;
    Gtk::Menu *editMenuitem_menu = Gtk::manage(new class Gtk::Menu());
    editMenuitem = NULL;
-   Gtk::Image *image569 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-clear"), Gtk::IconSize(1)));
-   clearresults1 = NULL;
    showextract1 = NULL;
+   Gtk::RadioMenuItem::Group _RadioMIGroup_searchenginegroup1;
    searchenginegroup1 = NULL;
-   Gtk::RadioMenuItem::Group _RadioMIGroup_searchenginegroup1;
    hostnamegroup1 = NULL;
    Gtk::Menu *groupresults1_menu = Gtk::manage(new class Gtk::Menu());
    groupresults1 = NULL;
+   Gtk::Image *image584 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-clear"), Gtk::IconSize(1)));
+   clearresults1 = NULL;
    Gtk::MenuItem *separator1 = NULL;
    viewresults1 = NULL;
    viewcache1 = NULL;
@@ -86,15 +89,15 @@
    Gtk::Menu *resultsMenuitem_menu = Gtk::manage(new class Gtk::Menu());
    resultsMenuitem = NULL;
    list1 = NULL;
-   Gtk::Image *image570 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(1)));
+   Gtk::Image *image585 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(1)));
    import1 = NULL;
    Gtk::MenuItem *separator3 = NULL;
    viewfromindex1 = NULL;
-   Gtk::Image *image571 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-refresh"), Gtk::IconSize(1)));
+   Gtk::Image *image586 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-refresh"), Gtk::IconSize(1)));
    refreshindex1 = NULL;
-   Gtk::Image *image572 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-delete"), Gtk::IconSize(1)));
+   Gtk::Image *image587 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-delete"), Gtk::IconSize(1)));
    unindex1 = NULL;
-   Gtk::Image *image573 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-properties"), Gtk::IconSize(1)));
+   Gtk::Image *image588 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-properties"), Gtk::IconSize(1)));
    showfromindex1 = NULL;
    Gtk::Menu *indexMenuitem_menu = Gtk::manage(new class Gtk::Menu());
    indexMenuitem = NULL;
@@ -134,7 +137,7 @@
    Gtk::VButtonBox *queryVbuttonbox = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
    Gtk::HBox *queryHbox = Gtk::manage(new class Gtk::HBox(false, 0));
    Gtk::Label *queryLabel = Gtk::manage(new class Gtk::Label(_("Stored queries")));
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
    queryExpander = Gtk::manage(new class Gtk::Expander());
 #else //
    queryExpander = Gtk::manage(new class Gtk::HandleBox());
@@ -174,15 +177,15 @@
    groupresults1_menu->items().push_back(Gtk::Menu_Helpers::RadioMenuElem(_RadioMIGroup_searchenginegroup1, _("Host Name")));
    hostnamegroup1 = (Gtk::RadioMenuItem *)&groupresults1_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Clear List"), *image569));
-   clearresults1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
-   
    resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::CheckMenuElem(_("Show Extract")));
    showextract1 = (Gtk::CheckMenuItem *)&resultsMenuitem_menu->items().back();
    
    resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("Group By"), *groupresults1_menu));
    groupresults1 = (Gtk::MenuItem *)&resultsMenuitem_menu->items().back();
    
+   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Clear List"), *image584));
+   clearresults1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
+   
    resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
    separator1 = (Gtk::MenuItem *)&resultsMenuitem_menu->items().back();
    
@@ -198,7 +201,7 @@
    indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("List Contents Of")));
    list1 = (Gtk::MenuItem *)&indexMenuitem_menu->items().back();
    
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Import"), *image570));
+   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Import"), *image585));
    import1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
    
    indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
@@ -207,13 +210,13 @@
    indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("View")));
    viewfromindex1 = (Gtk::MenuItem *)&indexMenuitem_menu->items().back();
    
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Update"), *image571));
+   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Update"), *image586));
    refreshindex1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
    
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Unindex"), *image572));
+   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Unindex"), *image587));
    unindex1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
    
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Properties"), *image573));
+   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Properties"), *image588));
    showfromindex1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
    
    helpMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_About")));
@@ -233,19 +236,19 @@
    
    mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Help"), *helpMenuitem_menu));
    helpMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
-   image569->set_alignment(0.5,0.5);
-   image569->set_padding(0,0);
    showextract1->set_active(true);
    searchenginegroup1->set_active(true);
    hostnamegroup1->set_active(false);
-   image570->set_alignment(0.5,0.5);
-   image570->set_padding(0,0);
-   image571->set_alignment(0.5,0.5);
-   image571->set_padding(0,0);
-   image572->set_alignment(0.5,0.5);
-   image572->set_padding(0,0);
-   image573->set_alignment(0.5,0.5);
-   image573->set_padding(0,0);
+   image584->set_alignment(0.5,0.5);
+   image584->set_padding(0,0);
+   image585->set_alignment(0.5,0.5);
+   image585->set_padding(0,0);
+   image586->set_alignment(0.5,0.5);
+   image586->set_padding(0,0);
+   image587->set_alignment(0.5,0.5);
+   image587->set_padding(0,0);
+   image588->set_alignment(0.5,0.5);
+   image588->set_padding(0,0);
    image439->set_alignment(0.5,0.5);
    image439->set_padding(0,0);
    addIndexButton->set_flags(Gtk::CAN_FOCUS);
@@ -287,6 +290,11 @@
    queryTreeview->set_rules_hint(false);
    queryTreeview->set_reorderable(false);
    queryTreeview->set_enable_search(false);
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=5
+   queryTreeview->set_fixed_height_mode(false);
+   queryTreeview->set_hover_selection(false);
+   queryTreeview->set_hover_expand(false);
+#endif //
    queryScrolledwindow->set_flags(Gtk::CAN_FOCUS);
    queryScrolledwindow->set_shadow_type(Gtk::SHADOW_NONE);
    queryScrolledwindow->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
@@ -333,12 +341,12 @@
    queryLabel->set_use_markup(false);
    queryLabel->set_selectable(false);
    queryExpander->set_flags(Gtk::CAN_FOCUS);
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
    queryExpander->set_expanded(false);
    queryExpander->set_spacing(0);
 #endif //
    queryExpander->add(*queryHbox);
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
    queryExpander->set_label_widget(*queryLabel);
 #endif //
    rightVbox->pack_start(*liveQueryHbox, Gtk::PACK_SHRINK, 0);
@@ -369,27 +377,27 @@
    paste1->show();
    delete1->show();
    editMenuitem->show();
-   image569->show();
-   clearresults1->show();
    showextract1->show();
    searchenginegroup1->show();
    hostnamegroup1->show();
    groupresults1->show();
+   image584->show();
+   clearresults1->show();
    separator1->show();
    viewresults1->show();
    viewcache1->show();
    indexresults1->show();
    resultsMenuitem->show();
    list1->show();
-   image570->show();
+   image585->show();
    import1->show();
    separator3->show();
    viewfromindex1->show();
-   image571->show();
+   image586->show();
    refreshindex1->show();
-   image572->show();
+   image587->show();
    unindex1->show();
-   image573->show();
+   image588->show();
    showfromindex1->show();
    indexMenuitem->show();
    about1->show();
@@ -433,9 +441,9 @@
    copy1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_copy_activate), false);
    paste1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_paste_activate), false);
    delete1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_delete_activate), false);
-   clearresults1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_clearresults_activate), false);
    showextract1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_showextract_activate), false);
    searchenginegroup1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_groupresults_activate), false);
+   clearresults1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_clearresults_activate), false);
    viewresults1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_viewresults_activate), false);
    viewcache1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_viewcache_activate), false);
    indexresults1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_indexresults_activate), false);

Modified: trunk/UI/GTK2/src/mainWindow_glade.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.hh	2006-05-20 04:30:58 UTC (rev 250)
+++ trunk/UI/GTK2/src/mainWindow_glade.hh	2006-05-20 05:10:25 UTC (rev 251)
@@ -1,9 +1,9 @@
-// generated 2006/2/20 22:15:34 SGT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0
+// generated 2006/5/17 8:25:37 SGT by fabrice at amra.dyndns.org.(none)
+// using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.6.10 and gtkmm 2.6.2
+// for gtk 2.8.17 and gtkmm 2.8.3
 //
 // Please modify the corresponding derived classes in ./src/mainWindow.hh and./src/mainWindow.cc
 
@@ -40,10 +40,10 @@
 #include <gtkmm/button.h>
 #include <gtkmm/entry.h>
 #include <gtkmm/treeview.h>
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
+#include <gtkmm/handlebox.h>
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
 #include <gtkmm/expander.h>
 #else //
-#include <gtkmm/handlebox.h>
 #endif //
 #include <gtkmm/paned.h>
 #include <gtkmm/progressbar.h>
@@ -65,11 +65,11 @@
         class Gtk::ImageMenuItem * paste1;
         class Gtk::ImageMenuItem * delete1;
         class Gtk::MenuItem * editMenuitem;
-        class Gtk::ImageMenuItem * clearresults1;
         class Gtk::CheckMenuItem * showextract1;
         class Gtk::RadioMenuItem * searchenginegroup1;
         class Gtk::RadioMenuItem * hostnamegroup1;
         class Gtk::MenuItem * groupresults1;
+        class Gtk::ImageMenuItem * clearresults1;
         class Gtk::MenuItem * viewresults1;
         class Gtk::MenuItem * viewcache1;
         class Gtk::MenuItem * indexresults1;
@@ -93,7 +93,7 @@
         class Gtk::Button * editQueryButton;
         class Gtk::Button * removeQueryButton;
         class Gtk::Button * findQueryButton;
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
         class Gtk::Expander * queryExpander;
 #else //
         class Gtk::HandleBox * queryExpander;
@@ -113,9 +113,9 @@
         virtual void on_copy_activate() = 0;
         virtual void on_paste_activate() = 0;
         virtual void on_delete_activate() = 0;
-        virtual void on_clearresults_activate() = 0;
         virtual void on_showextract_activate() = 0;
         virtual void on_groupresults_activate() = 0;
+        virtual void on_clearresults_activate() = 0;
         virtual void on_viewresults_activate() = 0;
         virtual void on_viewcache_activate() = 0;
         virtual void on_indexresults_activate() = 0;



From fabricecolin at berlios.de  Sat May 20 07:13:27 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 20 May 2006 07:13:27 +0200
Subject: [Pinot-svn] r252 - trunk
Message-ID: <200605200513.k4K5DRkP022108@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-20 07:13:24 +0200 (Sat, 20 May 2006)
New Revision: 252

Modified:
   trunk/Makefile.am
   trunk/configure.in
Log:
Build Monitor right before the UI. Since it requires sigc++-2.0, configure 
checks for it.


Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2006-05-20 05:10:25 UTC (rev 251)
+++ trunk/Makefile.am	2006-05-20 05:13:24 UTC (rev 252)
@@ -1,8 +1,8 @@
 # generated 2005/12/14 20:48:47 SGT by fabrice at amra.dyndns.org.(none)
 # using glademm V2.6.0
 
-SUBDIRS = po Utils Tokenize SQL Monitor Collect @SOAP_SUBDIRS@ Search \
-	Index UI/RenderHTML UI/GTK2/src
+SUBDIRS = po Utils Tokenize SQL Collect @SOAP_SUBDIRS@ Search \
+	Index Monitor UI/RenderHTML UI/GTK2/src
 
 EXTRA_DIST = ChangeLog NEWS README TODO mkinstalldirs pinot.desktop \
 	pinot.spec textcat_conf.txt Search/Plugins/*src Search/Plugins/*.xml \

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2006-05-20 05:10:25 UTC (rev 251)
+++ trunk/configure.in	2006-05-20 05:13:24 UTC (rev 252)
@@ -175,9 +175,12 @@
 INDEX_LIBS="$XAPIAN_LIBS -ltextcat"
 AC_SUBST(INDEX_CFLAGS)
 AC_SUBST(INDEX_LIBS)
+PKG_CHECK_MODULES(SIGCPP, sigc++-2.0 >= 2.0 )
+AC_SUBST(SIGCPP_CFLAGS)
+AC_SUBST(SIGCPP_LIBS)
 PKG_CHECK_MODULES(UI, gtkmm-2.4 >= 2.6 )
 UI_CFLAGS="$MOZILLANS_CFLAGS -D$MOZILLA_NS_DIR $GECKO_CFLAGS $UI_CFLAGS"
-UI_LIBS="-lpthread -lfam -L$MOZILLA_LIB_DIR -Xlinker -rpath -Xlinker $MOZILLA_LIB_DIR $GECKO_LIBS $MOZILLANS_LIBS $UI_LIBS"
+UI_LIBS="-lpthread -L$MOZILLA_LIB_DIR -Xlinker -rpath -Xlinker $MOZILLA_LIB_DIR $GECKO_LIBS $MOZILLANS_LIBS $UI_LIBS"
 AC_SUBST(UI_CFLAGS)
 AC_SUBST(UI_LIBS)
 
@@ -187,9 +190,9 @@
 AC_CHECK_FUNCS(mmap)
 
 AC_OUTPUT( pinot.spec Makefile Utils/Makefile Tokenize/Makefile )
-AC_OUTPUT( SQL/Makefile po/Makefile.in Monitor/Makefile Collect/Makefile )
+AC_OUTPUT( SQL/Makefile po/Makefile.in Collect/Makefile )
 if test "$SOAP_SUBDIRS" != "" ; then
   AC_OUTPUT( Search/Google/Makefile )
 fi
-AC_OUTPUT( Search/Makefile Index/Makefile UI/RenderHTML/Makefile UI/GTK2/src/Makefile )
+AC_OUTPUT( Search/Makefile Index/Makefile Monitor/Makefile UI/RenderHTML/Makefile UI/GTK2/src/Makefile )
 



From fabricecolin at berlios.de  Sat May 20 07:21:03 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 20 May 2006 07:21:03 +0200
Subject: [Pinot-svn] r253 - trunk/po
Message-ID: <200605200521.k4K5L3s2022438@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-20 07:20:38 +0200 (Sat, 20 May 2006)
New Revision: 253

Modified:
   trunk/po/POTFILES.in
Log:
Scan MboxHandler, not MonitorHandler.


Modified: trunk/po/POTFILES.in
===================================================================
--- trunk/po/POTFILES.in	2006-05-20 05:13:24 UTC (rev 252)
+++ trunk/po/POTFILES.in	2006-05-20 05:20:38 UTC (rev 253)
@@ -10,7 +10,7 @@
 UI/GTK2/src/mainWindow.cc
 UI/GTK2/src/mainWindow_glade.cc
 UI/GTK2/src/ModelColumns.cpp
-UI/GTK2/src/MonitorHandler.cpp
+UI/GTK2/src/MboxHandler.cpp
 UI/GTK2/src/Notebook.cpp
 UI/GTK2/src/pinot.cc
 UI/GTK2/src/PinotSettings.cpp



From fabricecolin at berlios.de  Sat May 20 08:21:53 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 20 May 2006 08:21:53 +0200
Subject: [Pinot-svn] r254 - trunk/UI/GTK2/src
Message-ID: <200605200621.k4K6LrWY004313@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-20 08:21:45 +0200 (Sat, 20 May 2006)
New Revision: 254

Modified:
   trunk/UI/GTK2/src/MboxHandler.cpp
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/queryDialog.cc
Log:
Fixed a bunch of warnings.


Modified: trunk/UI/GTK2/src/MboxHandler.cpp
===================================================================
--- trunk/UI/GTK2/src/MboxHandler.cpp	2006-05-20 05:20:38 UTC (rev 253)
+++ trunk/UI/GTK2/src/MboxHandler.cpp	2006-05-20 06:21:45 UTC (rev 254)
@@ -442,7 +442,6 @@
 bool MboxHandler::fileDeleted(const string &fileName)
 {
 	string sourceLabel = string("mailbox://") + fileName;
-	bool unindexedFile = false;
 
 	// Get the mail index
 	XapianIndex index(PinotSettings::getInstance().m_mailIndexLocation);

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2006-05-20 05:20:38 UTC (rev 253)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2006-05-20 06:21:45 UTC (rev 254)
@@ -944,11 +944,11 @@
 		}
 		addChildElement(pElem, "name", mailIter->m_name);
 		addChildElement(pElem, "type", mailIter->m_type);
-		sprintf(numStr, "%d", mailIter->m_modTime);
+		sprintf(numStr, "%ld", mailIter->m_modTime);
 		addChildElement(pElem, "mtime", numStr);
-		sprintf(numStr, "%d", mailIter->m_lastMessageTime);
+		sprintf(numStr, "%ld", mailIter->m_lastMessageTime);
 		addChildElement(pElem, "mindate", numStr);
-		sprintf(numStr, "%d", mailIter->m_size);
+		sprintf(numStr, "%ld", mailIter->m_size);
 		addChildElement(pElem, "size", numStr);
 	}
 

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2006-05-20 05:20:38 UTC (rev 253)
+++ trunk/UI/GTK2/src/queryDialog.cc	2006-05-20 06:21:45 UTC (rev 254)
@@ -177,7 +177,7 @@
 	// Language
 	m_properties.setLanguage("");
 	int chosenLanguage = languageCombobox->get_active_row_number();
-	if (chosenLanguage < Languages::m_count + 1)
+	if (chosenLanguage < (int)Languages::m_count + 1)
 	{
 		if (chosenLanguage > 0)
 		{



From fabricecolin at berlios.de  Sat May 20 08:24:56 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 20 May 2006 08:24:56 +0200
Subject: [Pinot-svn] r255 - in trunk: . UI/GTK2/src
Message-ID: <200605200624.k4K6OuCi005459@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-20 08:24:46 +0200 (Sat, 20 May 2006)
New Revision: 255

Modified:
   trunk/UI/GTK2/src/Makefile.am
   trunk/pinot.spec.in
Log:
Dropped dependency on Gamin/FAM, fixed UI headers list.


Modified: trunk/UI/GTK2/src/Makefile.am
===================================================================
--- trunk/UI/GTK2/src/Makefile.am	2006-05-20 06:21:45 UTC (rev 254)
+++ trunk/UI/GTK2/src/Makefile.am	2006-05-20 06:24:46 UTC (rev 255)
@@ -21,7 +21,7 @@
 	WorkerThreads.h \
 	HtmlView.h \
 	IndexTree.h \
-	MboxHandler.cpp \
+	MboxHandler.h \
 	PinotSettings.h \
 	ResultsTree.h
 

Modified: trunk/pinot.spec.in
===================================================================
--- trunk/pinot.spec.in	2006-05-20 06:21:45 UTC (rev 254)
+++ trunk/pinot.spec.in	2006-05-20 06:24:46 UTC (rev 255)
@@ -11,8 +11,8 @@
 Source: %{name}-%{version}.tar.gz
 URL: http://pinot.berlios.de/
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
-Requires: xapian-core-libs >= 0.9.4, curl >= 7.13, gtkmm24 >= 2.6, libxml++ >= 2.12, mozilla >= %{mozilla_ver}, sqlite >= 3.1.2, libtextcat >= 2.2, fam >= 2.6.10, gmime >= 2.1, shared-mime-info
-BuildRequires: xapian-core-devel >= 0.9.4, curl-devel >= 7.13, gtkmm24-devel >= 2.6, libxml++-devel >= 2.12, mozilla-devel >= %{mozilla_ver}, sqlite-devel >= 3.1.2, libtextcat-devel >= 2.2, fam-devel >= 2.6.10, gmime-devel >= 2.1, taglib-devel >= 1.4, boost-devel >= 1.32, gettext-devel, desktop-file-utils
+Requires: xapian-core-libs >= 0.9.4, curl >= 7.13, gtkmm24 >= 2.6, libxml++ >= 2.12, mozilla >= %{mozilla_ver}, sqlite >= 3.1.2, libtextcat >= 2.2, gmime >= 2.1, shared-mime-info
+BuildRequires: xapian-core-devel >= 0.9.4, curl-devel >= 7.13, gtkmm24-devel >= 2.6, libxml++-devel >= 2.12, mozilla-devel >= %{mozilla_ver}, sqlite-devel >= 3.1.2, libtextcat-devel >= 2.2, gmime-devel >= 2.1, taglib-devel >= 1.4, boost-devel >= 1.32, gettext-devel, desktop-file-utils
 %if 0%{?_with_soap:1}
 BuildRequires: gsoap
 %endif



From fabricecolin at berlios.de  Sat May 20 14:09:25 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 20 May 2006 14:09:25 +0200
Subject: [Pinot-svn] r260 - in trunk: Monitor UI/GTK2/src
Message-ID: <200605201209.k4KC9PTL004155@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-20 14:08:49 +0200 (Sat, 20 May 2006)
New Revision: 260

Modified:
   trunk/Monitor/INotifyMonitor.cpp
   trunk/UI/GTK2/src/WorkerThreads.cpp
Log:
No need to listen for event IN_ATTRIB. Make sure the monitor's file descriptor
is in the set MonitorThread select()'s on !


Modified: trunk/Monitor/INotifyMonitor.cpp
===================================================================
--- trunk/Monitor/INotifyMonitor.cpp	2006-05-20 10:13:58 UTC (rev 259)
+++ trunk/Monitor/INotifyMonitor.cpp	2006-05-20 12:08:49 UTC (rev 260)
@@ -51,7 +51,7 @@
 /// Starts monitoring a location.
 bool INotifyMonitor::addLocation(const string &directory)
 {
-	uint32_t eventsMask = IN_ATTRIB|IN_CLOSE_WRITE|IN_MOVE|IN_CREATE|IN_DELETE|IN_UNMOUNT|IN_MOVE_SELF|IN_DELETE_SELF;
+	uint32_t eventsMask = IN_CLOSE_WRITE|IN_MOVE|IN_CREATE|IN_DELETE|IN_UNMOUNT|IN_MOVE_SELF|IN_DELETE_SELF;
 
 	if ((directory.empty() == true) ||
 		(directory == "/") ||

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-20 10:13:58 UTC (rev 259)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-20 12:08:49 UTC (rev 260)
@@ -1189,8 +1189,6 @@
 	MonitorInterface *pMonitor = MonitorFactory::getMonitor();
 	set<string> newLocations;
 	set<string> locationsToRemove;
-	bool setLocationsToMonitor = true;
-	bool resumeMonitor = false;
 
 	if ((m_pHandler == NULL) ||
 		(pMonitor == NULL))
@@ -1204,7 +1202,6 @@
 	{
 		struct timeval selectTimeout;
 		fd_set listenSet;
-		int monitorFd = -1;
 
 		selectTimeout.tv_sec = 60;
 		selectTimeout.tv_usec = 0;
@@ -1215,44 +1212,37 @@
 			FD_SET(m_ctrlReadPipe, &listenSet);
 		}
 
-		if (setLocationsToMonitor == true)
+		// Did a change occur ?
+		if (m_pHandler->getLocations(newLocations, locationsToRemove) == true)
 		{
-			// Did a change occur ?
-			if (m_pHandler->getLocations(newLocations, locationsToRemove) == true)
-			{
 #ifdef DEBUG
-				cout << "MonitorThread::doWork: change detected" << endl;
+			cout << "MonitorThread::doWork: change detected" << endl;
 #endif
-				resumeMonitor = false;
 
-				// Add new locations
-				for (set<string>::const_iterator locationIter = newLocations.begin();
-					(locationIter != newLocations.end()) && (m_done == false); ++locationIter)
+			// Add new locations
+			for (set<string>::const_iterator locationIter = newLocations.begin();
+				(locationIter != newLocations.end()) && (m_done == false); ++locationIter)
+			{
+				// Monitor this
+				if (pMonitor->addLocation(*locationIter) == true)
 				{
-					// Monitor this
-					if (pMonitor->addLocation(*locationIter) == true)
-					{
-						// Confirm the file exists
-						m_pHandler->fileExists(*locationIter);
-					}
+					// Confirm the file exists
+					m_pHandler->fileExists(*locationIter);
 				}
-
-				// Remove others
-				for (set<string>::const_iterator locationIter = locationsToRemove.begin();
-					(locationIter != locationsToRemove.end()) && (m_done == false); ++locationIter)
-				{
-					// Stop monitoring this
-					pMonitor->removeLocation(*locationIter);
-				}
 			}
 
-			// The file descriptor may change over time so get it when changes occur
-			// rather than just once at the very beginning
-			monitorFd = pMonitor->getFileDescriptor();
-			FD_SET(monitorFd, &listenSet);
+			// Remove others
+			for (set<string>::const_iterator locationIter = locationsToRemove.begin();
+				(locationIter != locationsToRemove.end()) && (m_done == false); ++locationIter)
+			{
+				// Stop monitoring this
+				pMonitor->removeLocation(*locationIter);
+			}
 		}
-		setLocationsToMonitor = false;
 
+		// The file descriptor may change over time
+		int monitorFd = pMonitor->getFileDescriptor();
+		FD_SET(monitorFd, &listenSet);
 		if (monitorFd < 0)
 		{
 			m_status = _("Couldn't initialize file monitor");
@@ -1297,7 +1287,6 @@
 						cout << "MonitorThread::doWork: ignoring events because of load ("
 							<< averageLoad[0] << ")" << endl;
 #endif
-						resumeMonitor = true;
 						break;
 					}
 				}
@@ -1334,21 +1323,6 @@
 				events.pop();
 			}
 		}
-		else
-		{
-			if (resumeMonitor == true)
-			{
-				// Resume
-#ifdef DEBUG
-				cout << "MonitorThread::doWork: resuming monitoring" << endl;
-#endif
-				resumeMonitor = false;
-			}
-
-			// Chances are the timeout expired
-			// See if the locations to monitor have changed
-			setLocationsToMonitor = true;
-		}
 	}
 
 	delete pMonitor;



From fabricecolin at berlios.de  Mon May 22 15:25:10 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 22 May 2006 15:25:10 +0200
Subject: [Pinot-svn] r261 - trunk/UI/GTK2/src
Message-ID: <200605221325.k4MDPAJH001974@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-22 15:25:09 +0200 (Mon, 22 May 2006)
New Revision: 261

Modified:
   trunk/UI/GTK2/src/ResultsTree.cpp
Log:
Before looking for terms to highlight, convert the extract to UTF-8 to avoid
issues with byte/character discrepancies.


Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-20 12:08:49 UTC (rev 260)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-22 13:25:09 UTC (rev 261)
@@ -382,12 +382,14 @@
 			refBuffer->set_text(to_utf8(extract));
 
 			// Highlight the query's terms in the extract
-			string lowerExtract(StringManip::toLowerCase(extract));
+			ustring lowerExtract(StringManip::toLowerCase(to_utf8(extract)));
 			for (set<string>::iterator termIter = m_queryTerms.begin();
 				termIter != m_queryTerms.end(); ++termIter)
 			{
-				string::size_type pos = lowerExtract.find(StringManip::toLowerCase(*termIter));
-				while (pos != string::npos)
+				ustring term(to_utf8(StringManip::toLowerCase(*termIter)));
+
+				ustring::size_type pos = lowerExtract.find(term);
+				while (pos != ustring::npos)
 				{
 					if (((pos > 0) && (isspace(lowerExtract[pos - 1]) != 0)) ||
 						((pos + termIter->length() < lowerExtract.length() - 1) &&
@@ -399,7 +401,7 @@
 					}
 
 					// Next
-					pos = lowerExtract.find(StringManip::toLowerCase(*termIter), pos + 1);
+					pos = lowerExtract.find(term, pos + 1);
 				}
 			}
 



From fabricecolin at berlios.de  Tue May 23 13:11:54 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 23 May 2006 13:11:54 +0200
Subject: [Pinot-svn] r262 - trunk/UI/GTK2/src
Message-ID: <200605231111.k4NBBsIW019990@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-23 13:11:49 +0200 (Tue, 23 May 2006)
New Revision: 262

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/pinot.cc
Log:
Changed threads termination signal handling slightly so that the main window
can process threads that finished while the import dialog was up.


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-22 13:25:09 UTC (rev 261)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-23 11:11:49 UTC (rev 262)
@@ -161,6 +161,7 @@
 }
 
 ThreadsManager::ThreadsManager() :
+	SigC::Object(),
 	m_nextId(1),
 	m_backgroundThreadsCount(0)
 {
@@ -199,7 +200,7 @@
 	pthread_rwlock_unlock(&m_rwLock);
 }
 
-WorkerThread *ThreadsManager::on_thread_end(void)
+WorkerThread *ThreadsManager::get_thread(void)
 {
 	WorkerThread *pWorkerThread = NULL;
 
@@ -219,7 +220,7 @@
 				break;
 			}
 #ifdef DEBUG
-			cout << "ThreadsManager::on_thread_end: thread "
+			cout << "ThreadsManager::get_thread: thread "
 				<< threadIter->first->getId() << " is not done" << endl;
 #endif
 		}
@@ -316,6 +317,29 @@
 	}
 }
 
+void ThreadsManager::connect(void)
+{
+	// The previous manager may have been signalled by our threads
+	WorkerThread *pThread = get_thread();
+	while (pThread != NULL)
+	{
+		m_onThreadEndSignal.emit(pThread);
+
+		// Next
+		pThread = get_thread();
+	}
+#ifdef DEBUG
+	cout << "ThreadsManager::connect: connecting" << endl;
+#endif
+
+	// Connect the dispatcher
+	m_threadsEndConnection = WorkerThread::getDispatcher().connect(
+		SigC::slot(*this, &ThreadsManager::on_thread_end));
+#ifdef DEBUG
+	cout << "ThreadsManager::connect: connected" << endl;
+#endif
+}
+
 void ThreadsManager::disconnect(void)
 {
 	m_threadsEndConnection.block();
@@ -325,6 +349,19 @@
 #endif
 }
 
+void ThreadsManager::on_thread_end()
+{
+	WorkerThread *pThread = get_thread();
+	if (pThread == NULL)
+	{
+#ifdef DEBUG
+		cout << "ThreadsManager::on_thread_end: foreign thread" << endl;
+#endif
+		return;
+	}
+	m_onThreadEndSignal.emit(pThread);
+}
+
 IndexBrowserThread::IndexBrowserThread(const string &indexName,
 	const string &labelName, unsigned int maxDocsCount, unsigned int startDoc) :
 	WorkerThread(),

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-05-22 13:25:09 UTC (rev 261)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-05-23 11:11:49 UTC (rev 262)
@@ -23,6 +23,7 @@
 #include <set>
 #include <map>
 #include <pthread.h>
+#include <sigc++/object.h>
 #include <sigc++/slot.h>
 #include <sigc++/connection.h>
 #include <glibmm/dispatcher.h>
@@ -87,7 +88,7 @@
 
 };
 
-class ThreadsManager
+class ThreadsManager : public SigC::Object
 {
 	public:
 		ThreadsManager();
@@ -95,16 +96,18 @@
 
 		bool start_thread(WorkerThread *pWorkerThread, bool inBackground);
 
-		WorkerThread *on_thread_end(void);
-
 		unsigned int get_threads_count(void);
 
 		bool has_threads(void);
 
 		void stop_threads(void);
 
+		virtual void connect(void);
+
 		virtual void disconnect(void);
 
+		void on_thread_end();
+
 	protected:
 		SigC::Connection m_threadsEndConnection;
 		// Read/write lock
@@ -112,10 +115,12 @@
 		std::map<WorkerThread *, Glib::Thread *> m_threads;
 		unsigned int m_nextId;
 		unsigned int m_backgroundThreadsCount;
+		SigC::Signal1<void, WorkerThread *> m_onThreadEndSignal;
 
 		bool read_lock(void);
 		bool write_lock(void);
 		void unlock(void);
+		WorkerThread *get_thread(void);
 
 	private:
 		ThreadsManager(const ThreadsManager &other);

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-05-22 13:25:09 UTC (rev 261)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-05-23 11:11:49 UTC (rev 262)
@@ -40,28 +40,15 @@
 
 importDialog::InternalState::InternalState(importDialog *pWindow) :
 	ThreadsManager(),
-	m_importing(false),
-	m_pImportWindow(pWindow)
+	m_importing(false)
 {
+	m_onThreadEndSignal.connect(SigC::slot(*pWindow, &importDialog::on_thread_end));
 }
 
 importDialog::InternalState::~InternalState()
 {
 }
 
-void importDialog::InternalState::connect(void)
-{
-	if (m_pImportWindow != NULL)
-	{
-		// Connect the dispatcher
-		m_threadsEndConnection = WorkerThread::getDispatcher().connect(
-			SigC::slot(*m_pImportWindow, &importDialog::on_thread_end));
-#ifdef DEBUG
-		cout << "importDialog::InternalState::connect: connected" << endl;
-#endif
-	}
-}
-
 importDialog::importDialog(const Glib::ustring &title,
 	const set<string> &mimeTypes) :
 	importDialog_glade(),
@@ -123,6 +110,7 @@
 
 importDialog::~importDialog()
 {
+	m_state.disconnect();
 }
 
 void importDialog::populate_comboboxes(bool localOnly)
@@ -268,18 +256,13 @@
 	return askForAnotherFile;
 }
 
-void importDialog::on_thread_end()
+void importDialog::on_thread_end(WorkerThread *pThread)
 {
 	ustring status;
 	bool success = true;
 
-	WorkerThread *pThread = m_state.on_thread_end();
 	if (pThread == NULL)
 	{
-		// It's likely to be a thread that was started by the main window
-#ifdef DEBUG
-		cout << "importDialog::on_thread_end: foreign thread" << endl;
-#endif
 		return;
 	}
 

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2006-05-22 13:25:09 UTC (rev 261)
+++ trunk/UI/GTK2/src/importDialog.hh	2006-05-23 11:11:49 UTC (rev 262)
@@ -51,7 +51,7 @@
 
 	bool on_activity_timeout(void);
 	bool on_import_url(const std::string &location);
-	void on_thread_end(void);
+	void on_thread_end(WorkerThread *pThread);
 
 private:
 	std::set<std::string> m_mimeTypes;
@@ -80,8 +80,6 @@
 			InternalState(importDialog *pWindow);
 			~InternalState();
 
-			void connect(void);
-
 			// Directory scanning
 			bool m_importing;
 			Glib::Mutex m_scanMutex;
@@ -89,9 +87,6 @@
 			// The default directory
 			static std::string m_defaultDirectory;
 
-		protected:
-			importDialog *m_pImportWindow;
-
 	} m_state;
 
 	virtual void on_typeCombobox_changed();

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-05-22 13:25:09 UTC (rev 261)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-05-23 11:11:49 UTC (rev 262)
@@ -67,10 +67,10 @@
 	ThreadsManager(),
 	m_liveQueryLength(0),
 	m_currentPage(0),
-	m_browsingIndex(false),
-	m_pMainWindow(pWindow)
+	m_browsingIndex(false)
 {
 	pthread_rwlock_init(&m_listsLock, NULL);
+	m_onThreadEndSignal.connect(SigC::slot(*pWindow, &mainWindow::on_thread_end));
 }
 
 mainWindow::InternalState::~InternalState()
@@ -112,19 +112,6 @@
 #endif
 }
 
-void mainWindow::InternalState::connect(void)
-{
-	if (m_pMainWindow != NULL)
-	{
-		// Connect the dispatcher
-		m_threadsEndConnection = WorkerThread::getDispatcher().connect(
-			SigC::slot(*m_pMainWindow, &mainWindow::on_thread_end));
-#ifdef DEBUG
-		cout << "mainWindow::InternalState::connect: connected" << endl;
-#endif
-	}
-}
-
 //
 // Constructor
 //
@@ -748,16 +735,12 @@
 //
 // End of worker thread
 //
-void mainWindow::on_thread_end()
+void mainWindow::on_thread_end(WorkerThread *pThread)
 {
 	ustring status;
 
-	WorkerThread *pThread = m_state.on_thread_end();
 	if (pThread == NULL)
 	{
-#ifdef DEBUG
-		cout << "mainWindow::on_thread_end: signalled but couldn't find any thread" << endl;
-#endif
 		return;
 	}
 #ifdef DEBUG

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2006-05-22 13:25:09 UTC (rev 261)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-05-23 11:11:49 UTC (rev 262)
@@ -71,7 +71,7 @@
 	void on_label_changed(Glib::ustring indexName, Glib::ustring labelName);
 	void on_switch_page(GtkNotebookPage *p0, guint p1);
 	void on_close_page(Glib::ustring title, NotebookPageBox::PageType type);
-	void on_thread_end();
+	void on_thread_end(WorkerThread *pThread);
 	void on_editindex(Glib::ustring indexName, Glib::ustring location);
 	void on_message_reception(DocumentInfo docInfo, std::string labelName);
 	void on_message_indexupdate(IndexedDocument docInfo, unsigned int docId, std::string indexName);
@@ -176,7 +176,6 @@
 			bool read_lock_lists(unsigned int where);
 			bool write_lock_lists(unsigned int where);
 			void unlock_lists(void);
-			void connect(void);
 
 			// Query
 			unsigned int m_liveQueryLength;
@@ -190,7 +189,6 @@
 
 		protected:
 			pthread_rwlock_t m_listsLock;
-			mainWindow *m_pMainWindow;
 
 	} m_state;
 	static unsigned int m_maxDocsCount;

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2006-05-22 13:25:09 UTC (rev 261)
+++ trunk/UI/GTK2/src/pinot.cc	2006-05-23 11:11:49 UTC (rev 262)
@@ -232,6 +232,7 @@
 	}
 	catch (...)
 	{
+		cerr << "Unknown exception" << endl;
 		return EXIT_FAILURE;
 	}
 



From fabricecolin at berlios.de  Tue May 23 13:14:28 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 23 May 2006 13:14:28 +0200
Subject: [Pinot-svn] r263 - in trunk: . Collect Search UI/GTK2/src
Message-ID: <200605231114.k4NBESrH021109@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-23 13:14:27 +0200 (Tue, 23 May 2006)
New Revision: 263

Modified:
   trunk/Collect/pinot-collect.1
   trunk/Search/pinot-search.1
   trunk/UI/GTK2/src/pinot.1
   trunk/configure.in
Log:
Preparing for 0.48.


Modified: trunk/Collect/pinot-collect.1
===================================================================
--- trunk/Collect/pinot-collect.1	2006-05-23 11:11:49 UTC (rev 262)
+++ trunk/Collect/pinot-collect.1	2006-05-23 11:14:27 UTC (rev 263)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-COLLECT "1" "May 2006" "pinot-collect - pinot 0.46" "User Commands"
+.TH PINOT-COLLECT "1" "May 2006" "pinot-collect - pinot 0.48" "User Commands"
 .SH NAME
 pinot-collect \- Download an URL from the command-line
 .SH SYNOPSIS

Modified: trunk/Search/pinot-search.1
===================================================================
--- trunk/Search/pinot-search.1	2006-05-23 11:11:49 UTC (rev 262)
+++ trunk/Search/pinot-search.1	2006-05-23 11:14:27 UTC (rev 263)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-SEARCH "1" "May 2006" "pinot-search - pinot 0.46" "User Commands"
+.TH PINOT-SEARCH "1" "May 2006" "pinot-search - pinot 0.48" "User Commands"
 .SH NAME
 pinot-search \- Query search engines from the command-line
 .SH SYNOPSIS

Modified: trunk/UI/GTK2/src/pinot.1
===================================================================
--- trunk/UI/GTK2/src/pinot.1	2006-05-23 11:11:49 UTC (rev 262)
+++ trunk/UI/GTK2/src/pinot.1	2006-05-23 11:14:27 UTC (rev 263)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT "1" "May 2006" "pinot - pinot 0.46" "User Commands"
+.TH PINOT "1" "May 2006" "pinot - pinot 0.48" "User Commands"
 .SH NAME
 pinot \- A metasearch tool for the Free Desktop
 .SH SYNOPSIS

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2006-05-23 11:11:49 UTC (rev 262)
+++ trunk/configure.in	2006-05-23 11:14:27 UTC (rev 263)
@@ -2,7 +2,7 @@
 # using glademm V2.6.0
 
 AC_PREREQ(2.50)
-AC_INIT(pinot, 0.47,[fabricecolin at users.berlios.de])
+AC_INIT(pinot, 0.48,[fabricecolin at users.berlios.de])
 AM_INIT_AUTOMAKE
 AC_CONFIG_HEADERS(config.h)
 



From fabricecolin at berlios.de  Tue May 23 13:20:01 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 23 May 2006 13:20:01 +0200
Subject: [Pinot-svn] r264 - trunk/po
Message-ID: <200605231120.k4NBK1J3023762@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-23 13:19:56 +0200 (Tue, 23 May 2006)
New Revision: 264

Modified:
   trunk/po/es.po
   trunk/po/fr.po
Log:
Updated translations.


Modified: trunk/po/es.po
===================================================================
--- trunk/po/es.po	2006-05-23 11:14:27 UTC (rev 263)
+++ trunk/po/es.po	2006-05-23 11:19:56 UTC (rev 264)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.43\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-05-10 10:43+0800\n"
+"POT-Creation-Date: 2006-05-22 23:36+0800\n"
 "PO-Revision-Date: 2006-01-30 16:44+0800\n"
 "Last-Translator: Jes?s Tramullas <jesus at tramullas.com>\n"
 "Language-Team: es <jesus at tramullas.com>\n"
@@ -24,49 +24,49 @@
 msgid "Current User"
 msgstr "Usuario"
 
-#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:375
-#: UI/GTK2/src/mainWindow.cc:378 UI/GTK2/src/mainWindow.cc:548
-#: UI/GTK2/src/mainWindow.cc:1013 UI/GTK2/src/mainWindow.cc:1069
-#: UI/GTK2/src/mainWindow.cc:1089 UI/GTK2/src/mainWindow.cc:1124
-#: UI/GTK2/src/mainWindow.cc:1714 UI/GTK2/src/PinotSettings.cpp:204
+#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:352
+#: UI/GTK2/src/mainWindow.cc:355 UI/GTK2/src/mainWindow.cc:525
+#: UI/GTK2/src/mainWindow.cc:998 UI/GTK2/src/mainWindow.cc:1054
+#: UI/GTK2/src/mainWindow.cc:1074 UI/GTK2/src/mainWindow.cc:1109
+#: UI/GTK2/src/mainWindow.cc:1699 UI/GTK2/src/PinotSettings.cpp:204
 #: UI/GTK2/src/PinotSettings.cpp:970 UI/GTK2/src/PinotSettings.cpp:1026
 msgid "My Documents"
 msgstr "Mis documentos"
 
-#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:381
-#: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:552
-#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:205
+#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:358
+#: UI/GTK2/src/mainWindow.cc:361 UI/GTK2/src/mainWindow.cc:529
+#: UI/GTK2/src/MboxHandler.cpp:159 UI/GTK2/src/PinotSettings.cpp:205
 #: UI/GTK2/src/PinotSettings.cpp:971 UI/GTK2/src/PinotSettings.cpp:1027
 #: UI/GTK2/src/prefsDialog_glade.cc:115
 msgid "My Email"
 msgstr "Mi email"
 
-#: UI/GTK2/src/importDialog.cc:108
+#: UI/GTK2/src/importDialog.cc:95
 msgid "Enabled"
 msgstr "Activo"
 
-#: UI/GTK2/src/importDialog.cc:109 UI/GTK2/src/prefsDialog.cc:83
+#: UI/GTK2/src/importDialog.cc:96 UI/GTK2/src/prefsDialog.cc:83
 msgid "MIME Type"
 msgstr "Tipo MIME"
 
-#: UI/GTK2/src/importDialog.cc:134
+#: UI/GTK2/src/importDialog.cc:122
 msgid "File"
 msgstr "Fichero"
 
-#: UI/GTK2/src/importDialog.cc:137
+#: UI/GTK2/src/importDialog.cc:125
 msgid "Directory"
 msgstr "Directorio"
 
-#: UI/GTK2/src/importDialog.cc:142 UI/GTK2/src/IndexTree.cpp:69
-#: UI/GTK2/src/ResultsTree.cpp:128
+#: UI/GTK2/src/importDialog.cc:130 UI/GTK2/src/IndexTree.cpp:69
+#: UI/GTK2/src/ResultsTree.cpp:130
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/importDialog.cc:148 UI/GTK2/src/queryDialog.cc:91
+#: UI/GTK2/src/importDialog.cc:136 UI/GTK2/src/queryDialog.cc:91
 msgid "None"
 msgstr "Ninguno"
 
-#: UI/GTK2/src/importDialog.cc:446
+#: UI/GTK2/src/importDialog.cc:429
 msgid "Document To Import"
 msgstr "Documento a importar"
 
@@ -104,7 +104,7 @@
 msgid "Apply label:"
 msgstr "Etiqueta aplicada:"
 
-#: UI/GTK2/src/importDialog_glade.cc:91 UI/GTK2/src/mainWindow_glade.cc:201
+#: UI/GTK2/src/importDialog_glade.cc:91 UI/GTK2/src/mainWindow_glade.cc:204
 msgid "Import"
 msgstr "Importar"
 
@@ -128,7 +128,7 @@
 msgid "External index"
 msgstr "?ndice externo"
 
-#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:119
+#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:121
 msgid "Title"
 msgstr "T?tulo"
 
@@ -148,253 +148,251 @@
 msgid "All labels"
 msgstr "Todas las etiquetas"
 
-#: UI/GTK2/src/mainWindow.cc:179
+#: UI/GTK2/src/mainWindow.cc:167
 msgid "Query Name"
 msgstr "Nombre de la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:172
 msgid "Last Run"
 msgstr "?ltima ejecuci?n"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:173
 msgid "Summary"
 msgstr "Sumario"
 
-#: UI/GTK2/src/mainWindow.cc:246
+#: UI/GTK2/src/mainWindow.cc:223
 msgid "Add index"
 msgstr "A?adir ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:247
+#: UI/GTK2/src/mainWindow.cc:224
 msgid "Remove index"
 msgstr "Borrar ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:263
+#: UI/GTK2/src/mainWindow.cc:240
 msgid "Ready"
 msgstr "Listo"
 
-#: UI/GTK2/src/mainWindow.cc:280 UI/GTK2/src/mainWindow.cc:970
-#: UI/GTK2/src/mainWindow.cc:1307 UI/GTK2/src/mainWindow.cc:2893
-#: UI/GTK2/src/mainWindow_glade.cc:207
+#: UI/GTK2/src/mainWindow.cc:257 UI/GTK2/src/mainWindow.cc:955
+#: UI/GTK2/src/mainWindow.cc:1292 UI/GTK2/src/mainWindow.cc:2904
+#: UI/GTK2/src/mainWindow_glade.cc:210
 msgid "View"
 msgstr "Ver"
 
-#: UI/GTK2/src/mainWindow.cc:312
+#: UI/GTK2/src/mainWindow.cc:289
 msgid "N/A"
 msgstr "Desconocido"
 
-#: UI/GTK2/src/mainWindow.cc:322
+#: UI/GTK2/src/mainWindow.cc:299
 msgid "<undefined>"
 msgstr "<indefinido>"
 
-#: UI/GTK2/src/mainWindow.cc:510
+#: UI/GTK2/src/mainWindow.cc:487
 msgid "Result location is"
 msgstr "La localizaci?n del resultado es"
 
-#: UI/GTK2/src/mainWindow.cc:563
+#: UI/GTK2/src/mainWindow.cc:540
 msgid "Document location is"
 msgstr "La localizaci?n del documento es"
 
-#: UI/GTK2/src/mainWindow.cc:815
+#: UI/GTK2/src/mainWindow.cc:797
 msgid "Showing"
 msgstr "Mostrando"
 
-#: UI/GTK2/src/mainWindow.cc:820
+#: UI/GTK2/src/mainWindow.cc:802
 msgid "off"
 msgstr "desactivado"
 
-#: UI/GTK2/src/mainWindow.cc:825
+#: UI/GTK2/src/mainWindow.cc:807
 msgid "documents, starting at"
 msgstr "documentos comenzando en"
 
-#: UI/GTK2/src/mainWindow.cc:859
+#: UI/GTK2/src/mainWindow.cc:841
 msgid "Query"
 msgstr "B?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:863 UI/GTK2/src/mainWindow.cc:2721
+#: UI/GTK2/src/mainWindow.cc:845 UI/GTK2/src/mainWindow.cc:2732
 msgid "on"
 msgstr "en"
 
-#: UI/GTK2/src/mainWindow.cc:867
+#: UI/GTK2/src/mainWindow.cc:849
 msgid "ended"
 msgstr "finalizado"
 
-#: UI/GTK2/src/mainWindow.cc:945
+#: UI/GTK2/src/mainWindow.cc:930
 msgid "Updated label(s)"
 msgstr "Etiqueta(s) actualizada(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1023 UI/GTK2/src/mainWindow.cc:1135
+#: UI/GTK2/src/mainWindow.cc:1008
 msgid "Updated document"
 msgstr "Documento actualizado"
 
-#: UI/GTK2/src/mainWindow.cc:1038
+#: UI/GTK2/src/mainWindow.cc:1023
 msgid "Indexed"
 msgstr "Indizado"
 
-#: UI/GTK2/src/mainWindow.cc:1090
+#: UI/GTK2/src/mainWindow.cc:1075
 msgid "Unindexed document(s)"
 msgstr "Documento(s) no indizado(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1182
+#: UI/GTK2/src/mainWindow.cc:1120
+msgid "Updated document properties"
+msgstr "Propiedades del documento actualizadas"
+
+#: UI/GTK2/src/mainWindow.cc:1167
 msgid "Couldn't rename index, name"
 msgstr "No se pudo renombrar ?ndice, nombre"
 
-#: UI/GTK2/src/mainWindow.cc:1186 UI/GTK2/src/mainWindow.cc:2058
-#: UI/GTK2/src/mainWindow.cc:2555
+#: UI/GTK2/src/mainWindow.cc:1171 UI/GTK2/src/mainWindow.cc:2043
+#: UI/GTK2/src/mainWindow.cc:2566
 msgid "is already in use"
 msgstr "ya est? en uso"
 
-#: UI/GTK2/src/mainWindow.cc:1199
+#: UI/GTK2/src/mainWindow.cc:1184
 msgid "Couldn't rename index"
 msgstr "No se pudo renombrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1212
+#: UI/GTK2/src/mainWindow.cc:1197
 msgid "Edited index"
 msgstr "?ndice editado"
 
-#: UI/GTK2/src/mainWindow.cc:1653 UI/GTK2/src/mainWindow.cc:1755
+#: UI/GTK2/src/mainWindow.cc:1638 UI/GTK2/src/mainWindow.cc:1740
 msgid "Please set a location for the index first"
 msgstr "Por favor, primero fije una localizaci?n para el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1680
+#: UI/GTK2/src/mainWindow.cc:1665
 msgid "Result location is unknown"
 msgstr "Se desconoce la localizaci?n del resultado"
 
-#: UI/GTK2/src/mainWindow.cc:1704
+#: UI/GTK2/src/mainWindow.cc:1689
 msgid "Import Document(s)"
 msgstr "Importar Documento(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1833 UI/GTK2/src/WorkerThreads.cpp:386
-#: UI/GTK2/src/WorkerThreads.cpp:1108
+#: UI/GTK2/src/mainWindow.cc:1818 UI/GTK2/src/WorkerThreads.cpp:424
+#: UI/GTK2/src/WorkerThreads.cpp:1146
 msgid "Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1837 UI/GTK2/src/WorkerThreads.cpp:390
-#: UI/GTK2/src/WorkerThreads.cpp:1112
+#: UI/GTK2/src/mainWindow.cc:1822 UI/GTK2/src/WorkerThreads.cpp:428
+#: UI/GTK2/src/WorkerThreads.cpp:1150
 msgid "doesn't exist"
 msgstr "no existe"
 
-#: UI/GTK2/src/mainWindow.cc:1938
-#, fuzzy
+#: UI/GTK2/src/mainWindow.cc:1923
 msgid "Remove this document from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:1957
-#, fuzzy
+#: UI/GTK2/src/mainWindow.cc:1942
 msgid "Remove these documents from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:2009
+#: UI/GTK2/src/mainWindow.cc:1994
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Una herramienta metabuscador para el escritorio libre"
 
-#: UI/GTK2/src/mainWindow.cc:2010
+#: UI/GTK2/src/mainWindow.cc:1995
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2054
+#: UI/GTK2/src/mainWindow.cc:2039
 msgid "Index name"
 msgstr "Nombre del ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2069
+#: UI/GTK2/src/mainWindow.cc:2054
 msgid "Couldn't add index"
 msgstr "No se pudo a?adir el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2083
+#: UI/GTK2/src/mainWindow.cc:2068
 msgid "Added new index"
 msgstr "A?adido un nuevo ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2118
+#: UI/GTK2/src/mainWindow.cc:2103
 msgid "Couldn't remove index"
 msgstr "No se pudo borrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2213
+#: UI/GTK2/src/mainWindow.cc:2198
 msgid "Live query"
 msgstr "B?squeda activa"
 
-#: UI/GTK2/src/mainWindow.cc:2370
+#: UI/GTK2/src/mainWindow.cc:2355
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Al menos una tarea no ha finalizado. ?Parar ahora?"
 
-#: UI/GTK2/src/mainWindow.cc:2551
+#: UI/GTK2/src/mainWindow.cc:2562
 msgid "Query name"
 msgstr "Nombre la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2578
+#: UI/GTK2/src/mainWindow.cc:2589
 msgid "Couldn't update query"
 msgstr "No se pudo actualizar la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2586
+#: UI/GTK2/src/mainWindow.cc:2597
 msgid "Edited query"
 msgstr "B?squeda editada"
 
-#: UI/GTK2/src/mainWindow.cc:2593
+#: UI/GTK2/src/mainWindow.cc:2604
 msgid "Couldn't add query"
 msgstr "No se pudo a?adir la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2601
+#: UI/GTK2/src/mainWindow.cc:2612
 msgid "Added new query"
 msgstr "A?adida una nueva b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2615
+#: UI/GTK2/src/mainWindow.cc:2626
 msgid "Query is not set"
 msgstr "B?squeda no definida"
 
-#: UI/GTK2/src/mainWindow.cc:2626
+#: UI/GTK2/src/mainWindow.cc:2637
 msgid "No search engine selected"
 msgstr "Motor de b?squeda no seleccionado"
 
-#: UI/GTK2/src/mainWindow.cc:2708
+#: UI/GTK2/src/mainWindow.cc:2719
 msgid "Please set the Google API key first"
 msgstr "Por favor, primero configure el API de Google"
 
-#: UI/GTK2/src/mainWindow.cc:2717
+#: UI/GTK2/src/mainWindow.cc:2728
 msgid "Running query"
 msgstr "Ejecutando la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2824
+#: UI/GTK2/src/mainWindow.cc:2835
 msgid "is already indexed or is being indexed"
 msgstr "ya ha sido indizado, o se est? indizando"
 
-#: UI/GTK2/src/mainWindow.cc:2851
+#: UI/GTK2/src/mainWindow.cc:2862
 msgid "No URL to browse"
 msgstr "No hay URL que mostrar"
 
-#: UI/GTK2/src/mainWindow.cc:2862
+#: UI/GTK2/src/mainWindow.cc:2873
 msgid "No browser configured to view results"
 msgstr "No ha configurado un navegador para ver los resultados"
 
-#: UI/GTK2/src/mainWindow.cc:2874
+#: UI/GTK2/src/mainWindow.cc:2885
 msgid "Couldn't browse URL:"
 msgstr "No se pudo mostrar el URL:"
 
-#: UI/GTK2/src/mainWindow.cc:2933
+#: UI/GTK2/src/mainWindow.cc:2944
 msgid "Viewing"
 msgstr "Ver"
 
-#: UI/GTK2/src/mainWindow_glade.cc:115
+#: UI/GTK2/src/mainWindow_glade.cc:118
 msgid "Query:"
 msgstr "B?squeda:"
 
-#: UI/GTK2/src/mainWindow_glade.cc:127
+#: UI/GTK2/src/mainWindow_glade.cc:130
 msgid "Edit"
 msgstr "Editar"
 
-#: UI/GTK2/src/mainWindow_glade.cc:136
+#: UI/GTK2/src/mainWindow_glade.cc:139
 msgid "Stored queries"
 msgstr "B?squedas guardadas"
 
-#: UI/GTK2/src/mainWindow_glade.cc:171
+#: UI/GTK2/src/mainWindow_glade.cc:174
 msgid "Search Engine"
 msgstr "Motor de b?squeda"
 
-#: UI/GTK2/src/mainWindow_glade.cc:174
+#: UI/GTK2/src/mainWindow_glade.cc:177
 msgid "Host Name"
 msgstr "Nombre del servidor"
 
-#: UI/GTK2/src/mainWindow_glade.cc:177
-msgid "Clear List"
-msgstr "Limpiar la lista"
-
 #: UI/GTK2/src/mainWindow_glade.cc:180
 msgid "Show Extract"
 msgstr "Mostrar extra?dos"
@@ -403,56 +401,60 @@
 msgid "Group By"
 msgstr "Agrupar por"
 
-#: UI/GTK2/src/mainWindow_glade.cc:189
+#: UI/GTK2/src/mainWindow_glade.cc:186
+msgid "Clear List"
+msgstr "Limpiar la lista"
+
+#: UI/GTK2/src/mainWindow_glade.cc:192
 msgid "Vie_w"
 msgstr "Ver"
 
-#: UI/GTK2/src/mainWindow_glade.cc:192
+#: UI/GTK2/src/mainWindow_glade.cc:195
 msgid "View Cache"
 msgstr "Ver la cache"
 
-#: UI/GTK2/src/mainWindow_glade.cc:195 UI/GTK2/src/mainWindow_glade.cc:231
+#: UI/GTK2/src/mainWindow_glade.cc:198 UI/GTK2/src/mainWindow_glade.cc:234
 msgid "_Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow_glade.cc:198
+#: UI/GTK2/src/mainWindow_glade.cc:201
 msgid "List Contents Of"
 msgstr "Listar el contenido de"
 
-#: UI/GTK2/src/mainWindow_glade.cc:210
+#: UI/GTK2/src/mainWindow_glade.cc:213
 msgid "Update"
 msgstr "Actualizar"
 
-#: UI/GTK2/src/mainWindow_glade.cc:213
+#: UI/GTK2/src/mainWindow_glade.cc:216
 msgid "Unindex"
 msgstr "Des-indizar"
 
-#: UI/GTK2/src/mainWindow_glade.cc:216
+#: UI/GTK2/src/mainWindow_glade.cc:219
 #: UI/GTK2/src/propertiesDialog_glade.cc:146
 msgid "Properties"
 msgstr "Propiedades"
 
-#: UI/GTK2/src/mainWindow_glade.cc:219
+#: UI/GTK2/src/mainWindow_glade.cc:222
 msgid "_About"
 msgstr "Sobre"
 
-#: UI/GTK2/src/mainWindow_glade.cc:222
+#: UI/GTK2/src/mainWindow_glade.cc:225
 msgid "_Session"
 msgstr "Sesi?n"
 
-#: UI/GTK2/src/mainWindow_glade.cc:225
+#: UI/GTK2/src/mainWindow_glade.cc:228
 msgid "_Edit"
 msgstr "Editar"
 
-#: UI/GTK2/src/mainWindow_glade.cc:228
+#: UI/GTK2/src/mainWindow_glade.cc:231
 msgid "_Results"
 msgstr "Resultados"
 
-#: UI/GTK2/src/mainWindow_glade.cc:234
+#: UI/GTK2/src/mainWindow_glade.cc:237
 msgid "_Help"
 msgstr "Ayuda"
 
-#: UI/GTK2/src/mainWindow_glade.cc:356
+#: UI/GTK2/src/mainWindow_glade.cc:364
 msgid "Pinot"
 msgstr "Pinot"
 
@@ -692,104 +694,104 @@
 msgid "Query parameters"
 msgstr "Par?metros de b?squeda"
 
-#: UI/GTK2/src/WorkerThreads.cpp:365
+#: UI/GTK2/src/WorkerThreads.cpp:403
 msgid "Stopped browsing"
 msgstr "Exploraci?n detenida"
 
-#: UI/GTK2/src/WorkerThreads.cpp:398 UI/GTK2/src/WorkerThreads.cpp:596
-#: UI/GTK2/src/WorkerThreads.cpp:605 UI/GTK2/src/WorkerThreads.cpp:795
-#: UI/GTK2/src/WorkerThreads.cpp:1001 UI/GTK2/src/WorkerThreads.cpp:1120
+#: UI/GTK2/src/WorkerThreads.cpp:436 UI/GTK2/src/WorkerThreads.cpp:634
+#: UI/GTK2/src/WorkerThreads.cpp:643 UI/GTK2/src/WorkerThreads.cpp:833
+#: UI/GTK2/src/WorkerThreads.cpp:1039 UI/GTK2/src/WorkerThreads.cpp:1158
 msgid "Index error on"
 msgstr "Error en el ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:503
+#: UI/GTK2/src/WorkerThreads.cpp:541
 msgid "Stopped querying"
 msgstr "B?squeda detenida"
 
-#: UI/GTK2/src/WorkerThreads.cpp:515
+#: UI/GTK2/src/WorkerThreads.cpp:553
 msgid "Couldn't create search engine"
 msgstr "No se pudo crear el motor de b?squeda"
 
-#: UI/GTK2/src/WorkerThreads.cpp:526
+#: UI/GTK2/src/WorkerThreads.cpp:564
 msgid "Couldn't run query on search engine"
 msgstr "No se pudo ejecutar la b?squeda contra el motor"
 
-#: UI/GTK2/src/WorkerThreads.cpp:542
+#: UI/GTK2/src/WorkerThreads.cpp:580
 msgid "No title"
 msgstr "Sin t?tulo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:587
+#: UI/GTK2/src/WorkerThreads.cpp:625
 msgid "Stopped querying index labels"
 msgstr "Detenida la b?squeda de etiquetas de ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:664
+#: UI/GTK2/src/WorkerThreads.cpp:702
 msgid "Stopped retrieval of"
 msgstr "Detenida la recuperaci?n de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:698
+#: UI/GTK2/src/WorkerThreads.cpp:736
 msgid "Couldn't obtain downloader for protocol"
 msgstr "No se pudo usar un recuperador para el protocolo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:712 UI/GTK2/src/WorkerThreads.cpp:808
+#: UI/GTK2/src/WorkerThreads.cpp:750 UI/GTK2/src/WorkerThreads.cpp:846
 msgid "Couldn't retrieve"
 msgstr "No se pudo descargar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:780
+#: UI/GTK2/src/WorkerThreads.cpp:818
 msgid "Stopped indexing"
 msgstr "Detenida la indizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:831
+#: UI/GTK2/src/WorkerThreads.cpp:869
 msgid "Cannot index document type"
 msgstr "No se pudo indizar el tipo de documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:835
+#: UI/GTK2/src/WorkerThreads.cpp:873
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:859
+#: UI/GTK2/src/WorkerThreads.cpp:897
 msgid "Couldn't tokenize"
 msgstr "No se pudo extraer cadenas"
 
-#: UI/GTK2/src/WorkerThreads.cpp:879
+#: UI/GTK2/src/WorkerThreads.cpp:917
 msgid "Robots META tag forbids indexing"
 msgstr "La etiqueta META Robots proh?be la indizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:934
+#: UI/GTK2/src/WorkerThreads.cpp:972
 msgid "Couldn't index"
 msgstr "No se pudo indizar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:989
+#: UI/GTK2/src/WorkerThreads.cpp:1027
 msgid "Stopped unindexing document(s)"
 msgstr "Detenida la des-indizaci?n de documento(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1008
+#: UI/GTK2/src/WorkerThreads.cpp:1046
 msgid "Couldn't unindex document(s)"
 msgstr "No se pudo des-indizar lo(s) documento(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1093
+#: UI/GTK2/src/WorkerThreads.cpp:1131
 msgid "Stopped document update for"
 msgstr "Detenida la actualizaci?n del documento por"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1128
+#: UI/GTK2/src/WorkerThreads.cpp:1166
 msgid "Couldn't update document"
 msgstr "No se pudo actualizar el documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1178
+#: UI/GTK2/src/WorkerThreads.cpp:1216
 msgid "Stopped monitoring"
 msgstr "Detenida la monitorizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1198
+#: UI/GTK2/src/WorkerThreads.cpp:1233
 msgid "No monitoring handler"
 msgstr "No hay monitorizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1241
-msgid "Couldn't open FAM connection"
-msgstr "No se pudo abrir la conexi?n FAM"
+#: UI/GTK2/src/WorkerThreads.cpp:1285
+msgid "Couldn't initialize file monitor"
+msgstr "No se puede inicializar el monitor de archivo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1444
+#: UI/GTK2/src/WorkerThreads.cpp:1398
 msgid "Stopped scanning"
 msgstr "Detenida la exploraci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1602
+#: UI/GTK2/src/WorkerThreads.cpp:1556
 msgid "Couldn't open directory"
 msgstr "No se pudo abrir el directorio"

Modified: trunk/po/fr.po
===================================================================
--- trunk/po/fr.po	2006-05-23 11:14:27 UTC (rev 263)
+++ trunk/po/fr.po	2006-05-23 11:19:56 UTC (rev 264)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.43\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-05-10 10:43+0800\n"
+"POT-Creation-Date: 2006-05-22 23:36+0800\n"
 "PO-Revision-Date: 2006-01-20 19:44+0800\n"
 "Last-Translator: Fabrice Colin <colinf at chez.com>\n"
 "Language-Team: fr <colinf at chez.com>\n"
@@ -24,49 +24,49 @@
 msgid "Current User"
 msgstr "Utilisateur"
 
-#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:375
-#: UI/GTK2/src/mainWindow.cc:378 UI/GTK2/src/mainWindow.cc:548
-#: UI/GTK2/src/mainWindow.cc:1013 UI/GTK2/src/mainWindow.cc:1069
-#: UI/GTK2/src/mainWindow.cc:1089 UI/GTK2/src/mainWindow.cc:1124
-#: UI/GTK2/src/mainWindow.cc:1714 UI/GTK2/src/PinotSettings.cpp:204
+#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:352
+#: UI/GTK2/src/mainWindow.cc:355 UI/GTK2/src/mainWindow.cc:525
+#: UI/GTK2/src/mainWindow.cc:998 UI/GTK2/src/mainWindow.cc:1054
+#: UI/GTK2/src/mainWindow.cc:1074 UI/GTK2/src/mainWindow.cc:1109
+#: UI/GTK2/src/mainWindow.cc:1699 UI/GTK2/src/PinotSettings.cpp:204
 #: UI/GTK2/src/PinotSettings.cpp:970 UI/GTK2/src/PinotSettings.cpp:1026
 msgid "My Documents"
 msgstr "Mes Documents"
 
-#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:381
-#: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:552
-#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:205
+#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:358
+#: UI/GTK2/src/mainWindow.cc:361 UI/GTK2/src/mainWindow.cc:529
+#: UI/GTK2/src/MboxHandler.cpp:159 UI/GTK2/src/PinotSettings.cpp:205
 #: UI/GTK2/src/PinotSettings.cpp:971 UI/GTK2/src/PinotSettings.cpp:1027
 #: UI/GTK2/src/prefsDialog_glade.cc:115
 msgid "My Email"
 msgstr "Mon Courrier"
 
-#: UI/GTK2/src/importDialog.cc:108
+#: UI/GTK2/src/importDialog.cc:95
 msgid "Enabled"
 msgstr "Active"
 
-#: UI/GTK2/src/importDialog.cc:109 UI/GTK2/src/prefsDialog.cc:83
+#: UI/GTK2/src/importDialog.cc:96 UI/GTK2/src/prefsDialog.cc:83
 msgid "MIME Type"
 msgstr "Type MIME"
 
-#: UI/GTK2/src/importDialog.cc:134
+#: UI/GTK2/src/importDialog.cc:122
 msgid "File"
 msgstr "Fichier"
 
-#: UI/GTK2/src/importDialog.cc:137
+#: UI/GTK2/src/importDialog.cc:125
 msgid "Directory"
 msgstr "Repertoire"
 
-#: UI/GTK2/src/importDialog.cc:142 UI/GTK2/src/IndexTree.cpp:69
-#: UI/GTK2/src/ResultsTree.cpp:128
+#: UI/GTK2/src/importDialog.cc:130 UI/GTK2/src/IndexTree.cpp:69
+#: UI/GTK2/src/ResultsTree.cpp:130
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/importDialog.cc:148 UI/GTK2/src/queryDialog.cc:91
+#: UI/GTK2/src/importDialog.cc:136 UI/GTK2/src/queryDialog.cc:91
 msgid "None"
 msgstr "Aucune"
 
-#: UI/GTK2/src/importDialog.cc:446
+#: UI/GTK2/src/importDialog.cc:429
 msgid "Document To Import"
 msgstr "Document A Importer"
 
@@ -104,7 +104,7 @@
 msgid "Apply label:"
 msgstr "Appliquer l'etiquette:"
 
-#: UI/GTK2/src/importDialog_glade.cc:91 UI/GTK2/src/mainWindow_glade.cc:201
+#: UI/GTK2/src/importDialog_glade.cc:91 UI/GTK2/src/mainWindow_glade.cc:204
 msgid "Import"
 msgstr "Importer"
 
@@ -128,7 +128,7 @@
 msgid "External index"
 msgstr "Index externe"
 
-#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:119
+#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:121
 msgid "Title"
 msgstr "Titre"
 
@@ -148,253 +148,251 @@
 msgid "All labels"
 msgstr "Toutes les etiquettes"
 
-#: UI/GTK2/src/mainWindow.cc:179
+#: UI/GTK2/src/mainWindow.cc:167
 msgid "Query Name"
 msgstr "Nom de la Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:172
 msgid "Last Run"
 msgstr "Derniere Utilisation"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:173
 msgid "Summary"
 msgstr "Sommaire"
 
-#: UI/GTK2/src/mainWindow.cc:246
+#: UI/GTK2/src/mainWindow.cc:223
 msgid "Add index"
 msgstr "Ajouter un index"
 
-#: UI/GTK2/src/mainWindow.cc:247
+#: UI/GTK2/src/mainWindow.cc:224
 msgid "Remove index"
 msgstr "Enlever un index"
 
-#: UI/GTK2/src/mainWindow.cc:263
+#: UI/GTK2/src/mainWindow.cc:240
 msgid "Ready"
 msgstr "Pret"
 
-#: UI/GTK2/src/mainWindow.cc:280 UI/GTK2/src/mainWindow.cc:970
-#: UI/GTK2/src/mainWindow.cc:1307 UI/GTK2/src/mainWindow.cc:2893
-#: UI/GTK2/src/mainWindow_glade.cc:207
+#: UI/GTK2/src/mainWindow.cc:257 UI/GTK2/src/mainWindow.cc:955
+#: UI/GTK2/src/mainWindow.cc:1292 UI/GTK2/src/mainWindow.cc:2904
+#: UI/GTK2/src/mainWindow_glade.cc:210
 msgid "View"
 msgstr "Voir"
 
-#: UI/GTK2/src/mainWindow.cc:312
+#: UI/GTK2/src/mainWindow.cc:289
 msgid "N/A"
 msgstr "Inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:322
+#: UI/GTK2/src/mainWindow.cc:299
 msgid "<undefined>"
 msgstr "<inconnu>"
 
-#: UI/GTK2/src/mainWindow.cc:510
+#: UI/GTK2/src/mainWindow.cc:487
 msgid "Result location is"
 msgstr "Le chemin du resultat est"
 
-#: UI/GTK2/src/mainWindow.cc:563
+#: UI/GTK2/src/mainWindow.cc:540
 msgid "Document location is"
 msgstr "Le chemin du document is"
 
-#: UI/GTK2/src/mainWindow.cc:815
+#: UI/GTK2/src/mainWindow.cc:797
 msgid "Showing"
 msgstr "Listant"
 
-#: UI/GTK2/src/mainWindow.cc:820
+#: UI/GTK2/src/mainWindow.cc:802
 msgid "off"
 msgstr "documents,"
 
-#: UI/GTK2/src/mainWindow.cc:825
+#: UI/GTK2/src/mainWindow.cc:807
 msgid "documents, starting at"
 msgstr "au total, a partir de"
 
-#: UI/GTK2/src/mainWindow.cc:859
+#: UI/GTK2/src/mainWindow.cc:841
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:863 UI/GTK2/src/mainWindow.cc:2721
+#: UI/GTK2/src/mainWindow.cc:845 UI/GTK2/src/mainWindow.cc:2732
 msgid "on"
 msgstr "sur"
 
-#: UI/GTK2/src/mainWindow.cc:867
+#: UI/GTK2/src/mainWindow.cc:849
 msgid "ended"
 msgstr "est terminee"
 
-#: UI/GTK2/src/mainWindow.cc:945
+#: UI/GTK2/src/mainWindow.cc:930
 msgid "Updated label(s)"
 msgstr "Mis a jour l(es) etiquette(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1023 UI/GTK2/src/mainWindow.cc:1135
+#: UI/GTK2/src/mainWindow.cc:1008
 msgid "Updated document"
 msgstr "Mis a jour le document"
 
-#: UI/GTK2/src/mainWindow.cc:1038
+#: UI/GTK2/src/mainWindow.cc:1023
 msgid "Indexed"
 msgstr "Indexe"
 
-#: UI/GTK2/src/mainWindow.cc:1090
+#: UI/GTK2/src/mainWindow.cc:1075
 msgid "Unindexed document(s)"
 msgstr "Desindexe le(s) document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1182
+#: UI/GTK2/src/mainWindow.cc:1120
+msgid "Updated document properties"
+msgstr "Mis a jour les proprietes du document"
+
+#: UI/GTK2/src/mainWindow.cc:1167
 msgid "Couldn't rename index, name"
 msgstr "N'a pas pu renommer l'index, le nom"
 
-#: UI/GTK2/src/mainWindow.cc:1186 UI/GTK2/src/mainWindow.cc:2058
-#: UI/GTK2/src/mainWindow.cc:2555
+#: UI/GTK2/src/mainWindow.cc:1171 UI/GTK2/src/mainWindow.cc:2043
+#: UI/GTK2/src/mainWindow.cc:2566
 msgid "is already in use"
 msgstr "est deja utilise"
 
-#: UI/GTK2/src/mainWindow.cc:1199
+#: UI/GTK2/src/mainWindow.cc:1184
 msgid "Couldn't rename index"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1212
+#: UI/GTK2/src/mainWindow.cc:1197
 msgid "Edited index"
 msgstr "Edite l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1653 UI/GTK2/src/mainWindow.cc:1755
+#: UI/GTK2/src/mainWindow.cc:1638 UI/GTK2/src/mainWindow.cc:1740
 msgid "Please set a location for the index first"
 msgstr "Donnez un chemin a l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1680
+#: UI/GTK2/src/mainWindow.cc:1665
 msgid "Result location is unknown"
 msgstr "Le chemin du resultat est inconnu"
 
-#: UI/GTK2/src/mainWindow.cc:1704
+#: UI/GTK2/src/mainWindow.cc:1689
 msgid "Import Document(s)"
 msgstr "Import de Document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1833 UI/GTK2/src/WorkerThreads.cpp:386
-#: UI/GTK2/src/WorkerThreads.cpp:1108
+#: UI/GTK2/src/mainWindow.cc:1818 UI/GTK2/src/WorkerThreads.cpp:424
+#: UI/GTK2/src/WorkerThreads.cpp:1146
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:1837 UI/GTK2/src/WorkerThreads.cpp:390
-#: UI/GTK2/src/WorkerThreads.cpp:1112
+#: UI/GTK2/src/mainWindow.cc:1822 UI/GTK2/src/WorkerThreads.cpp:428
+#: UI/GTK2/src/WorkerThreads.cpp:1150
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
-#: UI/GTK2/src/mainWindow.cc:1938
-#, fuzzy
+#: UI/GTK2/src/mainWindow.cc:1923
 msgid "Remove this document from the index ?"
 msgstr "Enlever ce document de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:1957
-#, fuzzy
+#: UI/GTK2/src/mainWindow.cc:1942
 msgid "Remove these documents from the index ?"
 msgstr "Enlever ces documents de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2009
+#: UI/GTK2/src/mainWindow.cc:1994
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Un outil de recherche pour le Bureau Libre"
 
-#: UI/GTK2/src/mainWindow.cc:2010
+#: UI/GTK2/src/mainWindow.cc:1995
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2054
+#: UI/GTK2/src/mainWindow.cc:2039
 msgid "Index name"
 msgstr "Nom de l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2069
+#: UI/GTK2/src/mainWindow.cc:2054
 msgid "Couldn't add index"
 msgstr "N'a pas pu ajouter l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2083
+#: UI/GTK2/src/mainWindow.cc:2068
 msgid "Added new index"
 msgstr "Ajoute un nouvel index"
 
-#: UI/GTK2/src/mainWindow.cc:2118
+#: UI/GTK2/src/mainWindow.cc:2103
 msgid "Couldn't remove index"
 msgstr "N'a pas pu enlever l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2213
+#: UI/GTK2/src/mainWindow.cc:2198
 msgid "Live query"
 msgstr "Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2370
+#: UI/GTK2/src/mainWindow.cc:2355
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2551
+#: UI/GTK2/src/mainWindow.cc:2562
 msgid "Query name"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2578
+#: UI/GTK2/src/mainWindow.cc:2589
 msgid "Couldn't update query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2586
+#: UI/GTK2/src/mainWindow.cc:2597
 msgid "Edited query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2593
+#: UI/GTK2/src/mainWindow.cc:2604
 msgid "Couldn't add query"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2601
+#: UI/GTK2/src/mainWindow.cc:2612
 msgid "Added new query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2615
+#: UI/GTK2/src/mainWindow.cc:2626
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2626
+#: UI/GTK2/src/mainWindow.cc:2637
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:2708
+#: UI/GTK2/src/mainWindow.cc:2719
 msgid "Please set the Google API key first"
 msgstr "Configurez la clef de l'API Google "
 
-#: UI/GTK2/src/mainWindow.cc:2717
+#: UI/GTK2/src/mainWindow.cc:2728
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:2824
+#: UI/GTK2/src/mainWindow.cc:2835
 msgid "is already indexed or is being indexed"
 msgstr "est deja indexe ou est en cours d'indexation"
 
-#: UI/GTK2/src/mainWindow.cc:2851
+#: UI/GTK2/src/mainWindow.cc:2862
 msgid "No URL to browse"
 msgstr "Pas d'URL a brouter"
 
-#: UI/GTK2/src/mainWindow.cc:2862
+#: UI/GTK2/src/mainWindow.cc:2873
 msgid "No browser configured to view results"
 msgstr "Pas de brouter configure"
 
-#: UI/GTK2/src/mainWindow.cc:2874
+#: UI/GTK2/src/mainWindow.cc:2885
 msgid "Couldn't browse URL:"
 msgstr "N'a pas pu brouter l'URL"
 
-#: UI/GTK2/src/mainWindow.cc:2933
+#: UI/GTK2/src/mainWindow.cc:2944
 msgid "Viewing"
 msgstr "Voir"
 
-#: UI/GTK2/src/mainWindow_glade.cc:115
+#: UI/GTK2/src/mainWindow_glade.cc:118
 msgid "Query:"
 msgstr "Recherche:"
 
-#: UI/GTK2/src/mainWindow_glade.cc:127
+#: UI/GTK2/src/mainWindow_glade.cc:130
 msgid "Edit"
 msgstr "Editer"
 
-#: UI/GTK2/src/mainWindow_glade.cc:136
+#: UI/GTK2/src/mainWindow_glade.cc:139
 msgid "Stored queries"
 msgstr "Recherches sauvegardees"
 
-#: UI/GTK2/src/mainWindow_glade.cc:171
+#: UI/GTK2/src/mainWindow_glade.cc:174
 msgid "Search Engine"
 msgstr "Moteurs"
 
-#: UI/GTK2/src/mainWindow_glade.cc:174
+#: UI/GTK2/src/mainWindow_glade.cc:177
 msgid "Host Name"
 msgstr "Nom de machine"
 
-#: UI/GTK2/src/mainWindow_glade.cc:177
-msgid "Clear List"
-msgstr "Nettoyer la Liste"
-
 #: UI/GTK2/src/mainWindow_glade.cc:180
 msgid "Show Extract"
 msgstr "Montrer l'Extrait"
@@ -403,56 +401,60 @@
 msgid "Group By"
 msgstr "Grouper Par"
 
-#: UI/GTK2/src/mainWindow_glade.cc:189
+#: UI/GTK2/src/mainWindow_glade.cc:186
+msgid "Clear List"
+msgstr "Nettoyer la Liste"
+
+#: UI/GTK2/src/mainWindow_glade.cc:192
 msgid "Vie_w"
 msgstr "Voir"
 
-#: UI/GTK2/src/mainWindow_glade.cc:192
+#: UI/GTK2/src/mainWindow_glade.cc:195
 msgid "View Cache"
 msgstr "Voir le Cache"
 
-#: UI/GTK2/src/mainWindow_glade.cc:195 UI/GTK2/src/mainWindow_glade.cc:231
+#: UI/GTK2/src/mainWindow_glade.cc:198 UI/GTK2/src/mainWindow_glade.cc:234
 msgid "_Index"
 msgstr "Index"
 
-#: UI/GTK2/src/mainWindow_glade.cc:198
+#: UI/GTK2/src/mainWindow_glade.cc:201
 msgid "List Contents Of"
 msgstr "Lister le Contenu de"
 
-#: UI/GTK2/src/mainWindow_glade.cc:210
+#: UI/GTK2/src/mainWindow_glade.cc:213
 msgid "Update"
 msgstr "Mettre a Jour"
 
-#: UI/GTK2/src/mainWindow_glade.cc:213
+#: UI/GTK2/src/mainWindow_glade.cc:216
 msgid "Unindex"
 msgstr "Desindexer"
 
-#: UI/GTK2/src/mainWindow_glade.cc:216
+#: UI/GTK2/src/mainWindow_glade.cc:219
 #: UI/GTK2/src/propertiesDialog_glade.cc:146
 msgid "Properties"
 msgstr "Proprietes"
 
-#: UI/GTK2/src/mainWindow_glade.cc:219
+#: UI/GTK2/src/mainWindow_glade.cc:222
 msgid "_About"
 msgstr "A Propos"
 
-#: UI/GTK2/src/mainWindow_glade.cc:222
+#: UI/GTK2/src/mainWindow_glade.cc:225
 msgid "_Session"
 msgstr "Session"
 
-#: UI/GTK2/src/mainWindow_glade.cc:225
+#: UI/GTK2/src/mainWindow_glade.cc:228
 msgid "_Edit"
 msgstr "Editer"
 
-#: UI/GTK2/src/mainWindow_glade.cc:228
+#: UI/GTK2/src/mainWindow_glade.cc:231
 msgid "_Results"
 msgstr "Resultats"
 
-#: UI/GTK2/src/mainWindow_glade.cc:234
+#: UI/GTK2/src/mainWindow_glade.cc:237
 msgid "_Help"
 msgstr "Aide"
 
-#: UI/GTK2/src/mainWindow_glade.cc:356
+#: UI/GTK2/src/mainWindow_glade.cc:364
 msgid "Pinot"
 msgstr "Pinot"
 
@@ -692,104 +694,104 @@
 msgid "Query parameters"
 msgstr "Parametres de la recherche"
 
-#: UI/GTK2/src/WorkerThreads.cpp:365
+#: UI/GTK2/src/WorkerThreads.cpp:403
 msgid "Stopped browsing"
 msgstr "Arrete de parcourir l'index"
 
-#: UI/GTK2/src/WorkerThreads.cpp:398 UI/GTK2/src/WorkerThreads.cpp:596
-#: UI/GTK2/src/WorkerThreads.cpp:605 UI/GTK2/src/WorkerThreads.cpp:795
-#: UI/GTK2/src/WorkerThreads.cpp:1001 UI/GTK2/src/WorkerThreads.cpp:1120
+#: UI/GTK2/src/WorkerThreads.cpp:436 UI/GTK2/src/WorkerThreads.cpp:634
+#: UI/GTK2/src/WorkerThreads.cpp:643 UI/GTK2/src/WorkerThreads.cpp:833
+#: UI/GTK2/src/WorkerThreads.cpp:1039 UI/GTK2/src/WorkerThreads.cpp:1158
 msgid "Index error on"
 msgstr "Erreur sur l'index"
 
-#: UI/GTK2/src/WorkerThreads.cpp:503
+#: UI/GTK2/src/WorkerThreads.cpp:541
 msgid "Stopped querying"
 msgstr "Arrete la recherche"
 
-#: UI/GTK2/src/WorkerThreads.cpp:515
+#: UI/GTK2/src/WorkerThreads.cpp:553
 msgid "Couldn't create search engine"
 msgstr "N'a pas pu creer le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:526
+#: UI/GTK2/src/WorkerThreads.cpp:564
 msgid "Couldn't run query on search engine"
 msgstr "N'a pas pu lancer la recherche sur le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:542
+#: UI/GTK2/src/WorkerThreads.cpp:580
 msgid "No title"
 msgstr "Pas de titre"
 
-#: UI/GTK2/src/WorkerThreads.cpp:587
+#: UI/GTK2/src/WorkerThreads.cpp:625
 msgid "Stopped querying index labels"
 msgstr "Arrete la recherche d'etiquettes"
 
-#: UI/GTK2/src/WorkerThreads.cpp:664
+#: UI/GTK2/src/WorkerThreads.cpp:702
 msgid "Stopped retrieval of"
 msgstr "Arrete le telechargement de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:698
+#: UI/GTK2/src/WorkerThreads.cpp:736
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N'a pas pu obtenir un brouteur pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:712 UI/GTK2/src/WorkerThreads.cpp:808
+#: UI/GTK2/src/WorkerThreads.cpp:750 UI/GTK2/src/WorkerThreads.cpp:846
 msgid "Couldn't retrieve"
 msgstr "N'a pas pu telecharger"
 
-#: UI/GTK2/src/WorkerThreads.cpp:780
+#: UI/GTK2/src/WorkerThreads.cpp:818
 msgid "Stopped indexing"
 msgstr "Arrete l'indexation"
 
-#: UI/GTK2/src/WorkerThreads.cpp:831
+#: UI/GTK2/src/WorkerThreads.cpp:869
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer ce type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:835
+#: UI/GTK2/src/WorkerThreads.cpp:873
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:859
+#: UI/GTK2/src/WorkerThreads.cpp:897
 msgid "Couldn't tokenize"
 msgstr "N'a pas pu extraire les termes de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:879
+#: UI/GTK2/src/WorkerThreads.cpp:917
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots interdit d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:934
+#: UI/GTK2/src/WorkerThreads.cpp:972
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:989
+#: UI/GTK2/src/WorkerThreads.cpp:1027
 msgid "Stopped unindexing document(s)"
 msgstr "Arrete d'indexer les document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1008
+#: UI/GTK2/src/WorkerThreads.cpp:1046
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1093
+#: UI/GTK2/src/WorkerThreads.cpp:1131
 msgid "Stopped document update for"
 msgstr "Arrete la mise a jour pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1128
+#: UI/GTK2/src/WorkerThreads.cpp:1166
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1178
+#: UI/GTK2/src/WorkerThreads.cpp:1216
 msgid "Stopped monitoring"
 msgstr "Arrete la surveillance"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1198
+#: UI/GTK2/src/WorkerThreads.cpp:1233
 msgid "No monitoring handler"
 msgstr "Pas de moniteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1241
-msgid "Couldn't open FAM connection"
-msgstr "N'a pas pu ouvrir la connection FAM"
+#: UI/GTK2/src/WorkerThreads.cpp:1285
+msgid "Couldn't initialize file monitor"
+msgstr "N'a pas pu initializer le moniteur de fichiers"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1444
+#: UI/GTK2/src/WorkerThreads.cpp:1398
 msgid "Stopped scanning"
 msgstr "Arrete de scanner"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1602
+#: UI/GTK2/src/WorkerThreads.cpp:1556
 msgid "Couldn't open directory"
 msgstr "N'a pas pu ouvrir le repertoire"



From fabricecolin at berlios.de  Tue May 23 14:38:24 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 23 May 2006 14:38:24 +0200
Subject: [Pinot-svn] r265 - trunk
Message-ID: <200605231238.k4NCcOka018825@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-23 14:38:03 +0200 (Tue, 23 May 2006)
New Revision: 265

Modified:
   trunk/NEWS
   trunk/README
Log:
Listed main changes, removed mention of FAM/Gamin.


Modified: trunk/NEWS
===================================================================
--- trunk/NEWS	2006-05-23 11:19:56 UTC (rev 264)
+++ trunk/NEWS	2006-05-23 12:38:03 UTC (rev 265)
@@ -1,3 +1,15 @@
+??? version_0_4_8
+Monitor :
+ - replaced FAM/Gamin with inotify
+Search :
+ - fixed BitTorrent source
+UI :
+ - fixed menuitems inconsitencies
+ - always use user-provided language on update !
+ - all query terms are highlighted in the extract !
+ - threads that finish while the import dialog is up are processed when the
+  dialog box is closed
+
 2006/05/12 version_0_4_7
 General :
  - all programs have man pages and support --help and --version

Modified: trunk/README
===================================================================
--- trunk/README	2006-05-23 11:19:56 UTC (rev 264)
+++ trunk/README	2006-05-23 12:38:03 UTC (rev 265)
@@ -38,12 +38,6 @@
 libtextcat						2.2
 http://software.wise-guys.nl/libtextcat/
 
-fam							2.6.10
-http://oss.sgi.com/projects/fam/
-- OR -
-gamin							0.1.1
-http://www.gnome.org/~veillard/gamin/
-
 gmime							2.1.9
 http://spruce.sourceforge.net/gmime
 
@@ -74,7 +68,7 @@
 TagLib							1.4
 http://ktown.kde.org/~wheeler/taglib/
 
-glademm (5)						2.6.0_cvs-SNAP
+glademm (5)						2.12.0 cvs
 http://home.wtal.de/petig/Gtk/index.html
 
 (1) enabled with "./configure --with-http=neon|curl"



From fabricecolin at berlios.de  Tue May 23 17:22:59 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 23 May 2006 17:22:59 +0200
Subject: [Pinot-svn] r266 - in trunk: . Monitor
Message-ID: <200605231522.k4NFMxw1015429@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-23 17:22:59 +0200 (Tue, 23 May 2006)
New Revision: 266

Added:
   trunk/Monitor/linux-inotify-syscalls.h
Modified:
   trunk/Monitor/INotifyMonitor.cpp
   trunk/configure.in
Log:
Check whether inotify.h is located in linux/ or sys/. If the former, include
linux-inotify-syscalls.h. This header is from Ryan Lortie's (desrt at desrt dot ca)
libinotify project, and is slightly modified.
These changes are required to build on Ubuntu Dapper Drake.


Modified: trunk/Monitor/INotifyMonitor.cpp
===================================================================
--- trunk/Monitor/INotifyMonitor.cpp	2006-05-23 12:38:03 UTC (rev 265)
+++ trunk/Monitor/INotifyMonitor.cpp	2006-05-23 15:22:59 UTC (rev 266)
@@ -14,8 +14,15 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include "config.h"
 #include <sys/ioctl.h>
+#ifdef HAVE_LINUX_INOTIFY
+#include <stdint.h>
+#include <linux/inotify.h>
+#include "linux-inotify-syscalls.h"
+#else
 #include <sys/inotify.h>
+#endif
 #include <string.h>
 #include <errno.h>
 #include <iostream>

Added: trunk/Monitor/linux-inotify-syscalls.h
===================================================================
--- trunk/Monitor/linux-inotify-syscalls.h	2006-05-23 12:38:03 UTC (rev 265)
+++ trunk/Monitor/linux-inotify-syscalls.h	2006-05-23 15:22:59 UTC (rev 266)
@@ -0,0 +1,90 @@
+/*
+ * linux-inotify-syscalls.h - temporary shim for syscalls
+ * Copyright ? 2005 Ryan Lortie <desrt at desrt.ca>
+ *
+ *   This library is free software; you can redistribute it and/or
+ *   modify it under the terms of version 2.1 of the GNU Lesser General
+ *   Public as published by the Free Software Foundation.
+ *
+ *   This library is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ *   Lesser General Public License for more details.
+ *
+ *   You should have received a copy of the GNU Lesser General Public
+ *   License along with this library; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110
+ *
+ *   $Id: linux-inotify-syscalls.h,v 1.2 2005/09/04 15:55:51 ryanl Exp $
+ */
+
+#ifndef _linux_inotify_syscalls_h_
+#define _linux_inotify_syscalls_h_
+
+#include <asm/types.h>
+#include <sys/syscall.h>
+#include <unistd.h>
+
+#if defined(__i386__)
+# define __NR_inotify_init	291
+# define __NR_inotify_add_watch	292
+# define __NR_inotify_rm_watch	293
+#elif defined(__x86_64__)
+# define __NR_inotify_init	253
+# define __NR_inotify_add_watch	254
+# define __NR_inotify_rm_watch	255
+#elif defined(__alpha__)
+# define __NR_inotify_init      444
+# define __NR_inotify_add_watch 445
+# define __NR_inotify_rm_watch  446
+#elif defined(__ppc__) || defined(__powerpc__) || defined(__powerpc64__)
+# define __NR_inotify_init      275
+# define __NR_inotify_add_watch 276
+# define __NR_inotify_rm_watch  277
+#elif defined(__sparc__) || defined (__sparc64__)
+# define __NR_inotify_init      151
+# define __NR_inotify_add_watch 152
+# define __NR_inotify_rm_watch  156
+#elif defined (__ia64__)
+# define __NR_inotify_init  1277
+# define __NR_inotify_add_watch 1278
+# define __NR_inotify_rm_watch  1279
+#elif defined (__s390__) || defined (__s390x__)
+# define __NR_inotify_init  284
+# define __NR_inotify_add_watch 285
+# define __NR_inotify_rm_watch  286
+#elif defined (__arm__)
+# define __NR_inotify_init  316
+# define __NR_inotify_add_watch 317
+# define __NR_inotify_rm_watch  318
+#elif defined (__SH4__)
+# define __NR_inotify_init  290
+# define __NR_inotify_add_watch 291
+# define __NR_inotify_rm_watch  292
+#elif defined (__SH5__)
+# define __NR_inotify_init  318
+# define __NR_inotify_add_watch 319
+# define __NR_inotify_rm_watch  320
+#else
+# error "Unsupported architecture"
+#endif
+
+static inline int
+inotify_init (void)
+{
+  return syscall( __NR_inotify_init );
+}
+
+static inline int
+inotify_add_watch( int fd, const char *name, uint32_t mask )
+{
+  return syscall( __NR_inotify_add_watch, fd, name, mask );
+}
+
+static inline int
+inotify_rm_watch( int fd, uint32_t wd )
+{
+  return syscall( __NR_inotify_rm_watch, fd, wd );
+}
+
+#endif /* _linux_inotify_syscalls_h_ */

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2006-05-23 12:38:03 UTC (rev 265)
+++ trunk/configure.in	2006-05-23 15:22:59 UTC (rev 266)
@@ -150,6 +150,19 @@
 XAPIAN_CFLAGS=`$XAPIAN_CONFIG --cxxflags`
 XAPIAN_LIBS=`$XAPIAN_CONFIG --libs`
 
+dnl inotify
+haslinuxinotifyh="no"
+AM_CONDITIONAL(HAVE_LINUX_INOTIFY, false)
+AC_CHECK_HEADERS([linux/inotify.h],
+   [haslinuxinotifyh="yes"
+    AC_DEFINE(HAVE_LINUX_INOTIFY, [],
+		[Define if linux/inotify.h exists.])
+    AM_CONDITIONAL(HAVE_LINUX_INOTIFY, true)
+   ])
+if test "$haslinuxinotifyh" = "no" ; then
+   AC_CHECK_HEADERS(sys/inotify.h)
+fi
+
 dnl Other libraries
 MISC_LIBS="-lcrypt"
 AC_SUBST(MISC_LIBS)



From fabricecolin at berlios.de  Wed May 24 01:42:17 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 24 May 2006 01:42:17 +0200
Subject: [Pinot-svn] r267 - trunk
Message-ID: <200605232342.k4NNgHlJ028925@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-24 01:42:12 +0200 (Wed, 24 May 2006)
New Revision: 267

Modified:
   trunk/AUTHORS
   trunk/TODO
Log:
Mention one header was borrowed from libinotify.
More items to do...


Modified: trunk/AUTHORS
===================================================================
--- trunk/AUTHORS	2006-05-23 15:22:59 UTC (rev 266)
+++ trunk/AUTHORS	2006-05-23 23:42:12 UTC (rev 267)
@@ -2,6 +2,9 @@
 
 	Fabrice Colin <fabricecolin at users dot berlios dot de>
 
+The file Monitor/linux-inotify-syscalls.h is originally from libinotify
+(Copyright ? 2005 Ryan Lortie <desrt at desrt dot ca>).
+
 Translations provided by :
 
 	Spanish - Jes?s Tramullas <jesus at tramullas dot com>

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2006-05-23 15:22:59 UTC (rev 266)
+++ trunk/TODO	2006-05-23 23:42:12 UTC (rev 267)
@@ -5,33 +5,45 @@
 - Check for leaks with valgrind (eg --tool=memcheck -v --leak-check=yes --show-reachable=yes ...)
 - Don't use system(), fork and exec, especially for the external browser
 - Find out how to determine what application to use for a given MIME type and drop internal browser
-  Does xdgmime allow to consult the applications/types mappings in /usr/share/applications/defaults.list
-  and mimeinfo.cache ?
+  Consult the applications/types mappings in /usr/share/applications/defaults.list mimeinfo.cache
 - MIMEScanner should also return parent types so that we don't filter out types unnecessarily
 - Make sure everything works with URLs/path names that include spaces or unusual characters
+- Distribute pinot.pot
+- Add link to this to explain why FC5 version is linked against mozilla, not firefox
+  https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=149828
 
+Tokenize
+- Allow to cache documents that had to be converted ? eg PDF, MS Word
+- PDF tokenizer with poppler
+- HTML tokenizer with liboil
+- WordPerfect tokenizer with libwpd
+- Spin tokenizers into separate project, a la libextractor
+- Check whether pdftohtml flatens text in PDF documents that have columns.
+  Using "pdftops | ps2ascii" may work (seems to work slightly better than
+  "pdf2ps ..." !)
+
+Monitor
+- Use SQLite for email lists in MboxHandler, and not the index
+
+Collect
+- Comply with robot stuff defined at http://www.robotstxt.org/
+- Harvest mode grabs all pages on a specific site down to a certain depth
+- Make User-Agent string configurable
+- Make download timeout configurable
+- Support for HTML frames
+
 Search
-- Write a Spirit-based parser for extracting results from web pages
+- Write a Spirit or a liboil-based parser for extracting results from web pages
 - Allow to use "extended" INTERPRET tags selectively 
 - With engines that provide a redirection URL for results (eg Acoona), it looks like
   the query hitory is not saved/checked correctly
 - Add http://www.patentcommons.org/commons/patentsearch.php
+- Replace Accona with Baidu ?
 - Implement AutoDiscovery of OpenSearch Description files (http://opensearch.a9.com/spec/1.1/description/)
 - Make sure Description files' SyndicationRight is not private or closed
 - Export search results as OpenSearch Response
 - Support for Google Buttons
 
-Collect
-- Comply with robot stuff defined at http://www.robotstxt.org/
-- Harvest mode grabs all pages on a specific site down to a certain depth
-- Make User-Agent string configurable
-- Make download timeout configurable
-- Support for HTML frames
-- Allow to cache documents that had to be converted ? eg PDF, MS Word
-- Use poppler for the PDF tokenizer
-- WordPerfect tokenizer with libwpd
-- Spin tokenizers into separate project, a la libextractor
-
 Index
 - Get hold of stopwords lists for the languages supported by Xapian's stemmers and don't index stop words
 - Allow to import and use omindex-produced indexes  so that they can be used like pinot's internal indexes
@@ -46,7 +58,7 @@
 - Xapian Query objects will become serializable at some point, this will be useful
   for stored queries
 - Think about indexing archives (parent documents) and their contents (child documents)
-- Add a "more like this" menu to results from an index to get related documents
+- Add a "More Like This" menuitem to results from an index to get related documents
 
 Browser plugin
 - Write Firefox extension that searches Pinot indexes and indexes the cache
@@ -81,14 +93,16 @@
 - Show activity when mail is being indexed
 - Update Last Run after the query has completed
 - Filter documents by language, similarly to how labels are shown
-- Save engines groups state in config file
 - Clean up method names
 - Prefer ustring to string whenever possible
 - Closing when threads are running gives the impression Pinot has crashed; how do we tell the user
   we are waiting for something to finish ?
 - Try sizing the window optimally on the first startup
 - Use libnotify to show a popup when a new result is available ?
-- Replace labels with tags (Leaftag, http://www.chipx86.com/wiki/Leaftag)
-- Enable to import all the documents that match a specific tag
+- Replace labels with tags (Leaftag, http://www.chipx86.com/wiki/Leaftag). Enable to import
+  all the documents that match a specific tag
 - Double click on a word in the extract field adds it to the live query field
+- On update, update documents title if different
+- When switching back and forth between results tabs and another tab, why does the
+  result list get shifted right to the Title column ?
 



From fabricecolin at berlios.de  Wed May 24 15:00:00 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 24 May 2006 15:00:00 +0200
Subject: [Pinot-svn] r268 - trunk/Monitor
Message-ID: <200605241300.k4OD0042016364@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-24 14:59:59 +0200 (Wed, 24 May 2006)
New Revision: 268

Modified:
   trunk/Monitor/INotifyMonitor.cpp
Log:
Check whether there's actually stuff to read !


Modified: trunk/Monitor/INotifyMonitor.cpp
===================================================================
--- trunk/Monitor/INotifyMonitor.cpp	2006-05-23 23:42:12 UTC (rev 267)
+++ trunk/Monitor/INotifyMonitor.cpp	2006-05-24 12:59:59 UTC (rev 268)
@@ -130,16 +130,22 @@
 		return false;
 	}
 
-    if (ioctl (m_monitorFd, FIONREAD, &queueLen) == 0)
+	if (ioctl (m_monitorFd, FIONREAD, &queueLen) == 0)
 	{
 #ifdef DEBUG
 		cout << "INotifyMonitor::retrievePendingEvents: "
 			<< queueLen << " bytes to read" << endl;
 #endif
+		if (queueLen == 0)
+		{
+			// Nothing to read
+			return true;
+		}
 	}
 
 	int bytesRead = read(m_monitorFd, buffer, 1024);
-	while (bytesRead - offset > 0)
+	while ((bytesRead > 0) &&
+		(bytesRead - offset > 0))
 	{
 		struct inotify_event *pEvent = (struct inotify_event *)&buffer[offset];
 		size_t eventSize = sizeof(struct inotify_event) + pEvent->len;



From fabricecolin at berlios.de  Wed May 24 15:54:53 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 24 May 2006 15:54:53 +0200
Subject: [Pinot-svn] r269 - in trunk: Collect UI/GTK2/src Utils
Message-ID: <200605241354.k4ODsrTY019204@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-24 15:54:51 +0200 (Wed, 24 May 2006)
New Revision: 269

Modified:
   trunk/Collect/CurlDownloader.cpp
   trunk/Collect/FileCollector.cpp
   trunk/Collect/MboxCollector.cpp
   trunk/Collect/NeonDownloader.cpp
   trunk/Collect/XapianCollector.cpp
   trunk/UI/GTK2/src/IndexTree.cpp
   trunk/UI/GTK2/src/IndexTree.h
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/Utils/Document.cpp
   trunk/Utils/Document.h
   trunk/Utils/HtmlDocument.cpp
   trunk/Utils/HtmlDocument.h
Log:
Document objects can be built from a DocumentInfo. Use DocumentInfo when
possible so that no information (eg title, language...) is lost.


Modified: trunk/Collect/CurlDownloader.cpp
===================================================================
--- trunk/Collect/CurlDownloader.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/Collect/CurlDownloader.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -177,17 +177,17 @@
 				{
 					if (strstr(pContentType, "html") != NULL)
 					{
-						pDocument = new HtmlDocument(docInfo.getTitle(), url,
-							pContentType, docInfo.getLanguage());
+						pDocument = new HtmlDocument(docInfo);
 					}
 					else
 					{
-						pDocument = new Document(docInfo.getTitle(), url,
-							pContentType, docInfo.getLanguage());
+						pDocument = new Document(docInfo);
 					}
 
 					// ...and copy the content into it
 					pDocument->setData(pContentInfo->m_pContent, pContentInfo->m_contentLen);
+					pDocument->setLocation(url);
+					pDocument->setType(pContentType);
 
 #ifdef DEBUG
 					cout << "CurlDownloader::retrieveUrl: document size is " << pContentInfo->m_contentLen << endl;

Modified: trunk/Collect/FileCollector.cpp
===================================================================
--- trunk/Collect/FileCollector.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/Collect/FileCollector.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -41,7 +41,7 @@
 /// Retrieves the specified document; NULL if error.
 Document *FileCollector::retrieveUrl(const DocumentInfo &docInfo)
 {
-	Document *fileDocument = NULL;
+	Document *pDocument = NULL;
 	Url thisUrl(docInfo.getLocation());
 	string protocol = thisUrl.getProtocol();
 
@@ -62,19 +62,19 @@
 	// Is it an HTML type ?
 	if (fileType.find("html") != string::npos)
 	{
-		fileDocument = new HtmlDocument(docInfo.getTitle(),
-			docInfo.getLocation(), fileType, docInfo.getLanguage());
+		pDocument = new HtmlDocument(docInfo);
 	}
 	else
 	{
-		fileDocument = new Document(docInfo.getTitle(),
-			docInfo.getLocation(), fileType, docInfo.getLanguage());
+		pDocument = new Document(docInfo);
 	}
-	if (fileDocument->setDataFromFile(fileLocation) == false)
+
+	pDocument->setType(fileType);
+	if (pDocument->setDataFromFile(fileLocation) == false)
 	{
-		delete fileDocument;
+		delete pDocument;
 		return NULL;
 	}
 
-	return fileDocument;
+	return pDocument;
 }

Modified: trunk/Collect/MboxCollector.cpp
===================================================================
--- trunk/Collect/MboxCollector.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/Collect/MboxCollector.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -74,7 +74,5 @@
 	}
 
 	// Copy the message
-	Document *fileDocument = new Document(*pMessage);
-
-	return fileDocument;
+	return new Document(*pMessage);
 }

Modified: trunk/Collect/NeonDownloader.cpp
===================================================================
--- trunk/Collect/NeonDownloader.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/Collect/NeonDownloader.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -354,16 +354,17 @@
 			// Is it an HTML type ?
 			if (g_contentTypeHeaderValue.find("html") != string::npos)
 			{
-				pDocument = new HtmlDocument(docInfo.getTitle(), url,
-					g_contentTypeHeaderValue, docInfo.getLanguage());
+				pDocument = new HtmlDocument(docInfo);
 			}
 			else
 			{
-				pDocument = new Document(docInfo.getTitle(), url,
-					g_contentTypeHeaderValue, docInfo.getLanguage());
+				pDocument = new Document(docInfo);
 			}
+
 			// ...and copy the content into it
 			pDocument->setData(pContent, contentLen);
+			pDocument->setLocation(url);
+			pDocument->setType(g_contentTypeHeaderValue);
 #ifdef DEBUG
 			cout << "NeonDownloader::retrieveUrl: document size is " << contentLen << endl;
 #endif

Modified: trunk/Collect/XapianCollector.cpp
===================================================================
--- trunk/Collect/XapianCollector.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/Collect/XapianCollector.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -151,7 +151,7 @@
 		return NULL;
 	}
 
-	IndexedDocument *indexDoc = NULL;
+	IndexedDocument *pIndexedDoc = NULL;
 
 	try
 	{
@@ -173,8 +173,8 @@
 		cout << "XapianCollector::retrieveUrl: " << docId << " was indexed from " << location << " at " << timestamp << endl;
 #endif
 
-		indexDoc = new IndexedDocument(title, url, location, type, language);
-		indexDoc->setTimestamp(timestamp);
+		pIndexedDoc = new IndexedDocument(title, url, location, type, language);
+		pIndexedDoc->setTimestamp(timestamp);
 
 		// Extract document's data ?
 		if (m_getDocData == true)
@@ -184,7 +184,7 @@
 #ifdef DEBUG
 			cout << "XapianCollector::retrieveUrl: found omindex summary " << summary << endl;
 #endif
-			indexDoc->setData(summary.c_str(), summary.length());
+			pIndexedDoc->setData(summary.c_str(), summary.length());
 		}
 	}
 	catch (const Xapian::Error &error)
@@ -192,5 +192,5 @@
 		cerr << "Couldn't retrieve document: " << error.get_msg() << endl;
 	}
 
-	return indexDoc;
+	return pIndexedDoc;
 }

Modified: trunk/UI/GTK2/src/IndexTree.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexTree.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/UI/GTK2/src/IndexTree.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -237,20 +237,25 @@
 }
 
 //
-// Gets the first selected item's URL.
+// Gets the first selected item.
 //
-ustring IndexTree::getFirstSelectionLiveURL(void)
+IndexedDocument IndexTree::getFirstSelection(void)
 {
 	list<TreeModel::Path> selectedItems = get_selection()->get_selected_rows();
 	if (selectedItems.empty() == true)
 	{
-		return "";
+		return IndexedDocument("", "", "", "", "");
 	}
 
 	list<TreeModel::Path>::iterator itemPath = selectedItems.begin();
 	TreeModel::iterator iter = m_refStore->get_iter(*itemPath);
 	TreeModel::Row row = *iter;
-	return row[m_indexColumns.m_liveUrl];
+
+	return IndexedDocument(from_utf8(row[m_indexColumns.m_text]),
+		from_utf8(row[m_indexColumns.m_url]),
+		from_utf8(row[m_indexColumns.m_liveUrl]),
+		from_utf8(row[m_indexColumns.m_type]),
+		from_utf8(row[m_indexColumns.m_language]));
 }
 
 //
@@ -306,6 +311,9 @@
 			row[m_indexColumns.m_type] = to_utf8(docInfo.getType());
 			row[m_indexColumns.m_language] = to_utf8(docInfo.getLanguage());
 			row[m_indexColumns.m_timestamp] = to_utf8(docInfo.getTimestamp());
+#ifdef DEBUG
+			cout << "IndexTree::updateDocumentInfo: language now " << docInfo.getLanguage() << endl;
+#endif
 			break;
 		}
 	}

Modified: trunk/UI/GTK2/src/IndexTree.h
===================================================================
--- trunk/UI/GTK2/src/IndexTree.h	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/UI/GTK2/src/IndexTree.h	2006-05-24 13:54:51 UTC (rev 269)
@@ -54,8 +54,8 @@
 		/// Gets the first selected item's URL.
 		Glib::ustring getFirstSelectionURL(void);
 
-		/// Gets the first selected item's URL.
-		Glib::ustring getFirstSelectionLiveURL(void);
+		/// Gets the first selected item.
+		IndexedDocument getFirstSelection(void);
 
 		/// Gets a list of selected items.
 		bool getSelection(std::vector<IndexedDocument> &documentsList);

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -838,20 +838,22 @@
 }
 
 //
-// Gets the first selected item's URL.
+// Gets the first selected item.
 //
-ustring ResultsTree::getFirstSelectionURL(void)
+Result ResultsTree::getFirstSelection(void)
 {
 	list<TreeModel::Path> selectedItems = get_selection()->get_selected_rows();
 	if (selectedItems.empty() == true)
 	{
-		return "";
+		return Result("", "", "", "");
 	}
 
 	list<TreeModel::Path>::iterator itemPath = selectedItems.begin();
 	TreeModel::iterator iter = m_refStore->get_iter(*itemPath);
 	TreeModel::Row row = *iter;
-	return row[m_resultsColumns.m_url];
+	return Result(from_utf8(row[m_resultsColumns.m_url]),
+		from_utf8(row[m_resultsColumns.m_text]),
+		"", from_utf8(row[m_resultsColumns.m_language]));
 }
 
 //

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/UI/GTK2/src/ResultsTree.h	2006-05-24 13:54:51 UTC (rev 269)
@@ -65,8 +65,8 @@
 		/// Determines if results are selected.
 		bool checkSelection(void);
 
-		/// Gets the first selected item's URL.
-		Glib::ustring getFirstSelectionURL(void);
+		/// Gets the first selected item.
+		Result getFirstSelection(void);
 
 		/// Gets a list of selected items.
 		bool getSelection(std::vector<Result> &resultsList);

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -660,9 +660,9 @@
 	}
 }
 
-DownloadingThread::DownloadingThread(const string url, bool fromCache) :
+DownloadingThread::DownloadingThread(const DocumentInfo &docInfo, bool fromCache) :
 	WorkerThread(),
-	m_url(url),
+	m_docInfo(docInfo),
 	m_fromCache(fromCache),
 	m_pDoc(NULL),
 	m_pDownloader(NULL)
@@ -688,7 +688,7 @@
 
 string DownloadingThread::getURL(void) const
 {
-	return m_url;
+	return m_docInfo.getLocation();
 }
 
 const Document *DownloadingThread::getDocument(void) const
@@ -701,7 +701,7 @@
 	m_done = true;
 	m_status = _("Stopped retrieval of");
 	m_status += " ";
-	m_status += m_url;
+	m_status += m_docInfo.getLocation();
 
 	return true;
 }
@@ -714,14 +714,14 @@
 		m_pDownloader = NULL;
 	}
 
-	Url thisUrl(m_url);
+	Url thisUrl(m_docInfo.getLocation());
 
 	if (m_fromCache == true)
 	{
 #ifdef HAS_GOOGLEAPI
 		GoogleAPIEngine googleApiEngine;
 		googleApiEngine.setKey(PinotSettings::getInstance().m_googleAPIKey);
-		m_pDoc = googleApiEngine.retrieveCachedUrl(m_url);
+		m_pDoc = googleApiEngine.retrieveCachedUrl(m_docInfo.getLocation());
 #endif
 #ifdef DEBUG
 		cout << "DownloadingThread::doWork: got cached page" << endl;
@@ -739,9 +739,7 @@
 		}
 		else if (m_done == false)
 		{
-			DocumentInfo docInfo("", m_url, "", "");
-
-			m_pDoc = m_pDownloader->retrieveUrl(docInfo);
+			m_pDoc = m_pDownloader->retrieveUrl(m_docInfo);
 		}
 	}
 
@@ -749,13 +747,13 @@
 	{
 		m_status = _("Couldn't retrieve");
 		m_status += " ";
-		m_status += m_url;
+		m_status += m_docInfo.getLocation();
 	}
 }
 
 IndexingThread::IndexingThread(const DocumentInfo &docInfo, const string &labelName,
 	unsigned int docId, bool allowAllMIMETypes) :
-	DownloadingThread(docInfo.getLocation(), false),
+	DownloadingThread(docInfo, false),
 	m_docInfo(docInfo),
 	m_labelName(labelName),
 	m_docId(docId),
@@ -817,7 +815,7 @@
 		m_done = true;
 		m_status = _("Stopped indexing");
 		m_status += " ";
-		m_status += m_url;
+		m_status += m_docInfo.getLocation();
 		return true;
 	}
 
@@ -841,14 +839,8 @@
 	cout << "IndexingThread::doWork: downloaded !" << endl;
 #endif
 
-	if (m_pDoc == NULL)
+	if (m_pDoc != NULL)
 	{
-		m_status = _("Couldn't retrieve");
-		m_status += " ";
-		m_status += m_url;
-	}
-	else
-	{
 		string docType = m_pDoc->getType();
 		bool success = false;
 
@@ -872,7 +864,7 @@
 			m_status += " ";
 			m_status += _("at");
 			m_status += " ";
-			m_status += m_url;
+			m_status += m_docInfo.getLocation();
 			return;
 		}
 
@@ -896,7 +888,7 @@
 		{
 			m_status = _("Couldn't tokenize");
 			m_status += " ";
-			m_status += m_url;
+			m_status += m_docInfo.getLocation();
 			return;
 		}
 
@@ -916,7 +908,7 @@
 				delete pTokens;
 				m_status = _("Robots META tag forbids indexing");
 				m_status += " ";
-				m_status += m_url;
+				m_status += m_docInfo.getLocation();
 				return;
 			}
 		}
@@ -971,7 +963,7 @@
 			{
 				m_status = _("Couldn't index");
 				m_status += " ";
-				m_status += m_url;
+				m_status += m_docInfo.getLocation();
 			}
 			else if (m_done == false)
 			{
@@ -1308,7 +1300,8 @@
 				break;
 			}
 
-			while ((events.empty() == false) && (m_done == false))
+			while ((events.empty() == false) &&
+				(m_done == false))
 			{
 				MonitorEvent &event = events.front();
 				double averageLoad[3];

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-05-24 13:54:51 UTC (rev 269)
@@ -222,7 +222,7 @@
 class DownloadingThread : public WorkerThread
 {
 	public:
-		DownloadingThread(const std::string url, bool fromCache);
+		DownloadingThread(const DocumentInfo &docInfo, bool fromCache);
 		virtual ~DownloadingThread();
 
 		virtual std::string getType(void) const;
@@ -234,7 +234,7 @@
 		virtual bool stop(void);
 
 	protected:
-		std::string m_url;
+		DocumentInfo m_docInfo;
 		bool m_fromCache;
 		Document *m_pDoc;
 		DownloaderInterface *m_pDownloader;

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-05-24 13:54:51 UTC (rev 269)
@@ -200,7 +200,9 @@
 		string startPage("file://");
 		startPage += PREFIX;
 		startPage += "/share/pinot/index.html";
-		view_document(startPage, true);
+		DocumentInfo docInfo("", startPage, "", "");
+
+		view_document(docInfo, true);
 	}
 
 	// Gray out menu items
@@ -437,7 +439,7 @@
 //
 void mainWindow::on_resultsTreeviewSelection_changed(ustring queryName)
 {
-	ustring url;
+	string url;
 	bool hasSelection = false;
 
 	NotebookPageBox *pNotebookPage = get_page(queryName, NotebookPageBox::RESULTS_PAGE);
@@ -452,7 +454,8 @@
 				hasSelection = pResultsTree->checkSelection();
 				if (hasSelection == true)
 				{
-					url = pResultsTree->getFirstSelectionURL();
+					Result selectedResult = pResultsTree->getFirstSelection();
+					url = selectedResult.getLocation();
 				}
 			}
 		}
@@ -460,9 +463,9 @@
 
 	if (hasSelection == true)
 	{
+		Url urlObj(url);
 		bool isViewable = true, isIndexable = true, isCached = false;
 
-		Url urlObj(from_utf8(url));
 		string protocol = urlObj.getProtocol();
 		// FIXME: there should be a way to know which protocols can be viewed/indexed
 		if (protocol == "xapian")
@@ -1294,11 +1297,12 @@
 		else
 		{
 			string startPage("file://");
+			startPage += PREFIX;
+			startPage += "/share/pinot/index.html";
+			DocumentInfo docInfo("", startPage, "", "");
 
 			// Reopen the start page
-			startPage += PREFIX;
-			startPage += "/share/pinot/index.html";
-			view_document(startPage, true);
+			view_document(docInfo, true);
 		}
 	}
 
@@ -1589,8 +1593,8 @@
 			ResultsTree *pResultsTree = pResultsPage->getTree();
 			if (pResultsTree != NULL)
 			{
-				ustring url = pResultsTree->getFirstSelectionURL();
-				if (view_document(from_utf8(url)) == true)
+				Result selectedResult = pResultsTree->getFirstSelection();
+				if (view_document(selectedResult) == true)
 				{
 					// We can update the row right now
 					pResultsTree->setFirstSelectionViewedState(true);
@@ -1614,9 +1618,9 @@
 			ResultsTree *pResultsTree = pResultsPage->getTree();
 			if (pResultsTree != NULL)
 			{
-				ustring url = pResultsTree->getFirstSelectionURL();
+				Result selectedResult = pResultsTree->getFirstSelection();
 
-				start_thread(new DownloadingThread(url, true));
+				start_thread(new DownloadingThread(selectedResult, true));
 
 				// Update the row now, even though the cached page may not be retrieved
 				pResultsTree->setFirstSelectionViewedState(true);
@@ -1720,9 +1724,11 @@
 
 		if (pIndexTree != NULL)
 		{
+			IndexedDocument indexedDoc = pIndexTree->getFirstSelection();
+
 			// View the first document, don't bother about the rest
-			ustring url = pIndexTree->getFirstSelectionLiveURL();
-			view_document(from_utf8(url));
+			indexedDoc.setLocation(indexedDoc.getOriginalLocation());
+			view_document(indexedDoc);
 		}
 	}
 }
@@ -1776,6 +1782,7 @@
 		}
 #ifdef DEBUG
 		cout << "mainWindow::on_refreshindex_activate: URL is " << url << endl;
+		cout << "mainWindow::on_refreshindex_activate: language is " << docIter->getLanguage() << endl;
 #endif
 
 		// Add this action to the queue
@@ -2855,8 +2862,10 @@
 //
 // View a document
 //
-bool mainWindow::view_document(const string &url, bool internalViewerOnly)
+bool mainWindow::view_document(const DocumentInfo &docInfo, bool internalViewerOnly)
 {
+	string url(docInfo.getLocation());
+
 	if (url.empty() == true)
 	{
 		set_status(_("No URL to browse"));
@@ -2896,7 +2905,7 @@
 		if (urlObj.getProtocol() == "mailbox")
 		{
 			// Get that message
-			start_thread(new DownloadingThread(url, false));
+			start_thread(new DownloadingThread(docInfo, false));
 		}
 		else
 		{

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-05-24 13:54:51 UTC (rev 269)
@@ -133,7 +133,7 @@
 		const Glib::ustring &labelName, unsigned int startDoc);
 	void index_document(const DocumentInfo &docInfo, const std::string &labelName,
 		unsigned int docId = 0);
-	bool view_document(const std::string &url, bool internalViewerOnly = false);
+	bool view_document(const DocumentInfo &docInfo, bool internalViewerOnly = false);
 	bool append_document(IndexPage *pIndexPage, const Glib::ustring &indexName,
 		const IndexedDocument &docInfo);
 	bool start_thread(WorkerThread *pNewThread, bool inBackground = false);

Modified: trunk/Utils/Document.cpp
===================================================================
--- trunk/Utils/Document.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/Utils/Document.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -48,6 +48,14 @@
 {
 }
 
+Document::Document(const DocumentInfo &info) :
+	DocumentInfo(info),
+	m_pData(NULL),
+	m_dataLength(0),
+	m_isMapped(false)
+{
+}
+
 Document::Document(const Document &other) :
 	DocumentInfo(other),
 	m_pData(NULL),

Modified: trunk/Utils/Document.h
===================================================================
--- trunk/Utils/Document.h	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/Utils/Document.h	2006-05-24 13:54:51 UTC (rev 269)
@@ -27,6 +27,7 @@
 		Document();
 		Document(const std::string &title, const std::string &location,
 			const std::string &type, const std::string &language);
+		Document(const DocumentInfo &info);
 		Document(const Document &other);
 		virtual ~Document();
 

Modified: trunk/Utils/HtmlDocument.cpp
===================================================================
--- trunk/Utils/HtmlDocument.cpp	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/Utils/HtmlDocument.cpp	2006-05-24 13:54:51 UTC (rev 269)
@@ -30,9 +30,8 @@
 using std::string;
 using std::min;
 
-HtmlDocument::HtmlDocument(const string &title, const string &location,
-	const string &type, const string &language) :
-	Document(title, location, type, language)
+HtmlDocument::HtmlDocument(const DocumentInfo &info) :
+	Document(info)
 {
 }
 

Modified: trunk/Utils/HtmlDocument.h
===================================================================
--- trunk/Utils/HtmlDocument.h	2006-05-24 12:59:59 UTC (rev 268)
+++ trunk/Utils/HtmlDocument.h	2006-05-24 13:54:51 UTC (rev 269)
@@ -24,8 +24,7 @@
 class HtmlDocument : public Document
 {
 	public:
-		HtmlDocument(const std::string &title, const std::string &location,
-			const std::string &type, const std::string &language);
+		HtmlDocument(const DocumentInfo &info);
 		HtmlDocument(const HtmlDocument &other);
 		virtual ~HtmlDocument();
 



From fabricecolin at berlios.de  Wed May 24 15:56:48 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 24 May 2006 15:56:48 +0200
Subject: [Pinot-svn] r270 - trunk/Index
Message-ID: <200605241356.k4ODumWh020329@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-24 15:56:48 +0200 (Wed, 24 May 2006)
New Revision: 270

Modified:
   trunk/Index/XapianIndex.cpp
Log:
Forgot to convert language from locale to English in updateDocument().
Lower-case the language name before requesting a stemmer.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-05-24 13:54:51 UTC (rev 269)
+++ trunk/Index/XapianIndex.cpp	2006-05-24 13:56:48 UTC (rev 270)
@@ -117,7 +117,7 @@
 	// Do we know what language to use for stemming ?
 	if (m_stemLanguage.empty() == false)
 	{
-		pStemmer = new Xapian::Stem(m_stemLanguage);
+		pStemmer = new Xapian::Stem(StringManip::toLowerCase(m_stemLanguage));
 	}
 
 	// Get the terms
@@ -633,7 +633,7 @@
 	docInfo.setLocation(Url::canonicalizeUrl(docInfo.getLocation()));
 
 	// Don't scan the document if a language is specified
-	m_stemLanguage = pDocument->getLanguage();
+	m_stemLanguage = Languages::toEnglish(pDocument->getLanguage());
 	if (m_stemLanguage.empty() == true)
 	{
 		m_stemLanguage = scanDocument(pData, dataLength, docInfo);



From fabricecolin at berlios.de  Wed May 24 15:59:02 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 24 May 2006 15:59:02 +0200
Subject: [Pinot-svn] r271 - trunk/po
Message-ID: <200605241359.k4ODx2KK020613@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-24 15:59:01 +0200 (Wed, 24 May 2006)
New Revision: 271

Modified:
   trunk/po/es.po
   trunk/po/fr.po
Log:
Synced with latest source.


Modified: trunk/po/es.po
===================================================================
--- trunk/po/es.po	2006-05-24 13:56:48 UTC (rev 270)
+++ trunk/po/es.po	2006-05-24 13:59:01 UTC (rev 271)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.43\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-05-22 23:36+0800\n"
+"POT-Creation-Date: 2006-05-24 15:04+0800\n"
 "PO-Revision-Date: 2006-01-30 16:44+0800\n"
 "Last-Translator: Jes?s Tramullas <jesus at tramullas.com>\n"
 "Language-Team: es <jesus at tramullas.com>\n"
@@ -24,17 +24,17 @@
 msgid "Current User"
 msgstr "Usuario"
 
-#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:352
-#: UI/GTK2/src/mainWindow.cc:355 UI/GTK2/src/mainWindow.cc:525
-#: UI/GTK2/src/mainWindow.cc:998 UI/GTK2/src/mainWindow.cc:1054
-#: UI/GTK2/src/mainWindow.cc:1074 UI/GTK2/src/mainWindow.cc:1109
-#: UI/GTK2/src/mainWindow.cc:1699 UI/GTK2/src/PinotSettings.cpp:204
+#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:354
+#: UI/GTK2/src/mainWindow.cc:357 UI/GTK2/src/mainWindow.cc:528
+#: UI/GTK2/src/mainWindow.cc:1001 UI/GTK2/src/mainWindow.cc:1057
+#: UI/GTK2/src/mainWindow.cc:1077 UI/GTK2/src/mainWindow.cc:1112
+#: UI/GTK2/src/mainWindow.cc:1703 UI/GTK2/src/PinotSettings.cpp:204
 #: UI/GTK2/src/PinotSettings.cpp:970 UI/GTK2/src/PinotSettings.cpp:1026
 msgid "My Documents"
 msgstr "Mis documentos"
 
-#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:358
-#: UI/GTK2/src/mainWindow.cc:361 UI/GTK2/src/mainWindow.cc:529
+#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:360
+#: UI/GTK2/src/mainWindow.cc:363 UI/GTK2/src/mainWindow.cc:532
 #: UI/GTK2/src/MboxHandler.cpp:159 UI/GTK2/src/PinotSettings.cpp:205
 #: UI/GTK2/src/PinotSettings.cpp:971 UI/GTK2/src/PinotSettings.cpp:1027
 #: UI/GTK2/src/prefsDialog_glade.cc:115
@@ -160,216 +160,216 @@
 msgid "Summary"
 msgstr "Sumario"
 
-#: UI/GTK2/src/mainWindow.cc:223
+#: UI/GTK2/src/mainWindow.cc:225
 msgid "Add index"
 msgstr "A?adir ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:224
+#: UI/GTK2/src/mainWindow.cc:226
 msgid "Remove index"
 msgstr "Borrar ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:240
+#: UI/GTK2/src/mainWindow.cc:242
 msgid "Ready"
 msgstr "Listo"
 
-#: UI/GTK2/src/mainWindow.cc:257 UI/GTK2/src/mainWindow.cc:955
-#: UI/GTK2/src/mainWindow.cc:1292 UI/GTK2/src/mainWindow.cc:2904
+#: UI/GTK2/src/mainWindow.cc:259 UI/GTK2/src/mainWindow.cc:958
+#: UI/GTK2/src/mainWindow.cc:1295 UI/GTK2/src/mainWindow.cc:2913
 #: UI/GTK2/src/mainWindow_glade.cc:210
 msgid "View"
 msgstr "Ver"
 
-#: UI/GTK2/src/mainWindow.cc:289
+#: UI/GTK2/src/mainWindow.cc:291
 msgid "N/A"
 msgstr "Desconocido"
 
-#: UI/GTK2/src/mainWindow.cc:299
+#: UI/GTK2/src/mainWindow.cc:301
 msgid "<undefined>"
 msgstr "<indefinido>"
 
-#: UI/GTK2/src/mainWindow.cc:487
+#: UI/GTK2/src/mainWindow.cc:490
 msgid "Result location is"
 msgstr "La localizaci?n del resultado es"
 
-#: UI/GTK2/src/mainWindow.cc:540
+#: UI/GTK2/src/mainWindow.cc:543
 msgid "Document location is"
 msgstr "La localizaci?n del documento es"
 
-#: UI/GTK2/src/mainWindow.cc:797
+#: UI/GTK2/src/mainWindow.cc:800
 msgid "Showing"
 msgstr "Mostrando"
 
-#: UI/GTK2/src/mainWindow.cc:802
+#: UI/GTK2/src/mainWindow.cc:805
 msgid "off"
 msgstr "desactivado"
 
-#: UI/GTK2/src/mainWindow.cc:807
+#: UI/GTK2/src/mainWindow.cc:810
 msgid "documents, starting at"
 msgstr "documentos comenzando en"
 
-#: UI/GTK2/src/mainWindow.cc:841
+#: UI/GTK2/src/mainWindow.cc:844
 msgid "Query"
 msgstr "B?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:845 UI/GTK2/src/mainWindow.cc:2732
+#: UI/GTK2/src/mainWindow.cc:848 UI/GTK2/src/mainWindow.cc:2739
 msgid "on"
 msgstr "en"
 
-#: UI/GTK2/src/mainWindow.cc:849
+#: UI/GTK2/src/mainWindow.cc:852
 msgid "ended"
 msgstr "finalizado"
 
-#: UI/GTK2/src/mainWindow.cc:930
+#: UI/GTK2/src/mainWindow.cc:933
 msgid "Updated label(s)"
 msgstr "Etiqueta(s) actualizada(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1008
+#: UI/GTK2/src/mainWindow.cc:1011
 msgid "Updated document"
 msgstr "Documento actualizado"
 
-#: UI/GTK2/src/mainWindow.cc:1023
+#: UI/GTK2/src/mainWindow.cc:1026
 msgid "Indexed"
 msgstr "Indizado"
 
-#: UI/GTK2/src/mainWindow.cc:1075
+#: UI/GTK2/src/mainWindow.cc:1078
 msgid "Unindexed document(s)"
 msgstr "Documento(s) no indizado(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1120
+#: UI/GTK2/src/mainWindow.cc:1123
 msgid "Updated document properties"
 msgstr "Propiedades del documento actualizadas"
 
-#: UI/GTK2/src/mainWindow.cc:1167
+#: UI/GTK2/src/mainWindow.cc:1170
 msgid "Couldn't rename index, name"
 msgstr "No se pudo renombrar ?ndice, nombre"
 
-#: UI/GTK2/src/mainWindow.cc:1171 UI/GTK2/src/mainWindow.cc:2043
-#: UI/GTK2/src/mainWindow.cc:2566
+#: UI/GTK2/src/mainWindow.cc:1174 UI/GTK2/src/mainWindow.cc:2050
+#: UI/GTK2/src/mainWindow.cc:2573
 msgid "is already in use"
 msgstr "ya est? en uso"
 
-#: UI/GTK2/src/mainWindow.cc:1184
+#: UI/GTK2/src/mainWindow.cc:1187
 msgid "Couldn't rename index"
 msgstr "No se pudo renombrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1197
+#: UI/GTK2/src/mainWindow.cc:1200
 msgid "Edited index"
 msgstr "?ndice editado"
 
-#: UI/GTK2/src/mainWindow.cc:1638 UI/GTK2/src/mainWindow.cc:1740
+#: UI/GTK2/src/mainWindow.cc:1642 UI/GTK2/src/mainWindow.cc:1746
 msgid "Please set a location for the index first"
 msgstr "Por favor, primero fije una localizaci?n para el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1665
+#: UI/GTK2/src/mainWindow.cc:1669
 msgid "Result location is unknown"
 msgstr "Se desconoce la localizaci?n del resultado"
 
-#: UI/GTK2/src/mainWindow.cc:1689
+#: UI/GTK2/src/mainWindow.cc:1693
 msgid "Import Document(s)"
 msgstr "Importar Documento(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1818 UI/GTK2/src/WorkerThreads.cpp:424
-#: UI/GTK2/src/WorkerThreads.cpp:1146
+#: UI/GTK2/src/mainWindow.cc:1825 UI/GTK2/src/WorkerThreads.cpp:424
+#: UI/GTK2/src/WorkerThreads.cpp:1138
 msgid "Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1822 UI/GTK2/src/WorkerThreads.cpp:428
-#: UI/GTK2/src/WorkerThreads.cpp:1150
+#: UI/GTK2/src/mainWindow.cc:1829 UI/GTK2/src/WorkerThreads.cpp:428
+#: UI/GTK2/src/WorkerThreads.cpp:1142
 msgid "doesn't exist"
 msgstr "no existe"
 
-#: UI/GTK2/src/mainWindow.cc:1923
+#: UI/GTK2/src/mainWindow.cc:1930
 msgid "Remove this document from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:1942
+#: UI/GTK2/src/mainWindow.cc:1949
 msgid "Remove these documents from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:1994
+#: UI/GTK2/src/mainWindow.cc:2001
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Una herramienta metabuscador para el escritorio libre"
 
-#: UI/GTK2/src/mainWindow.cc:1995
+#: UI/GTK2/src/mainWindow.cc:2002
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2039
+#: UI/GTK2/src/mainWindow.cc:2046
 msgid "Index name"
 msgstr "Nombre del ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2054
+#: UI/GTK2/src/mainWindow.cc:2061
 msgid "Couldn't add index"
 msgstr "No se pudo a?adir el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2068
+#: UI/GTK2/src/mainWindow.cc:2075
 msgid "Added new index"
 msgstr "A?adido un nuevo ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2103
+#: UI/GTK2/src/mainWindow.cc:2110
 msgid "Couldn't remove index"
 msgstr "No se pudo borrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2198
+#: UI/GTK2/src/mainWindow.cc:2205
 msgid "Live query"
 msgstr "B?squeda activa"
 
-#: UI/GTK2/src/mainWindow.cc:2355
+#: UI/GTK2/src/mainWindow.cc:2362
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Al menos una tarea no ha finalizado. ?Parar ahora?"
 
-#: UI/GTK2/src/mainWindow.cc:2562
+#: UI/GTK2/src/mainWindow.cc:2569
 msgid "Query name"
 msgstr "Nombre la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2589
+#: UI/GTK2/src/mainWindow.cc:2596
 msgid "Couldn't update query"
 msgstr "No se pudo actualizar la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2597
+#: UI/GTK2/src/mainWindow.cc:2604
 msgid "Edited query"
 msgstr "B?squeda editada"
 
-#: UI/GTK2/src/mainWindow.cc:2604
+#: UI/GTK2/src/mainWindow.cc:2611
 msgid "Couldn't add query"
 msgstr "No se pudo a?adir la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2612
+#: UI/GTK2/src/mainWindow.cc:2619
 msgid "Added new query"
 msgstr "A?adida una nueva b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2626
+#: UI/GTK2/src/mainWindow.cc:2633
 msgid "Query is not set"
 msgstr "B?squeda no definida"
 
-#: UI/GTK2/src/mainWindow.cc:2637
+#: UI/GTK2/src/mainWindow.cc:2644
 msgid "No search engine selected"
 msgstr "Motor de b?squeda no seleccionado"
 
-#: UI/GTK2/src/mainWindow.cc:2719
+#: UI/GTK2/src/mainWindow.cc:2726
 msgid "Please set the Google API key first"
 msgstr "Por favor, primero configure el API de Google"
 
-#: UI/GTK2/src/mainWindow.cc:2728
+#: UI/GTK2/src/mainWindow.cc:2735
 msgid "Running query"
 msgstr "Ejecutando la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2835
+#: UI/GTK2/src/mainWindow.cc:2842
 msgid "is already indexed or is being indexed"
 msgstr "ya ha sido indizado, o se est? indizando"
 
-#: UI/GTK2/src/mainWindow.cc:2862
+#: UI/GTK2/src/mainWindow.cc:2871
 msgid "No URL to browse"
 msgstr "No hay URL que mostrar"
 
-#: UI/GTK2/src/mainWindow.cc:2873
+#: UI/GTK2/src/mainWindow.cc:2882
 msgid "No browser configured to view results"
 msgstr "No ha configurado un navegador para ver los resultados"
 
-#: UI/GTK2/src/mainWindow.cc:2885
+#: UI/GTK2/src/mainWindow.cc:2894
 msgid "Couldn't browse URL:"
 msgstr "No se pudo mostrar el URL:"
 
-#: UI/GTK2/src/mainWindow.cc:2944
+#: UI/GTK2/src/mainWindow.cc:2953
 msgid "Viewing"
 msgstr "Ver"
 
@@ -699,8 +699,8 @@
 msgstr "Exploraci?n detenida"
 
 #: UI/GTK2/src/WorkerThreads.cpp:436 UI/GTK2/src/WorkerThreads.cpp:634
-#: UI/GTK2/src/WorkerThreads.cpp:643 UI/GTK2/src/WorkerThreads.cpp:833
-#: UI/GTK2/src/WorkerThreads.cpp:1039 UI/GTK2/src/WorkerThreads.cpp:1158
+#: UI/GTK2/src/WorkerThreads.cpp:643 UI/GTK2/src/WorkerThreads.cpp:831
+#: UI/GTK2/src/WorkerThreads.cpp:1031 UI/GTK2/src/WorkerThreads.cpp:1150
 msgid "Index error on"
 msgstr "Error en el ?ndice"
 
@@ -732,66 +732,66 @@
 msgid "Couldn't obtain downloader for protocol"
 msgstr "No se pudo usar un recuperador para el protocolo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:750 UI/GTK2/src/WorkerThreads.cpp:846
+#: UI/GTK2/src/WorkerThreads.cpp:748
 msgid "Couldn't retrieve"
 msgstr "No se pudo descargar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:818
+#: UI/GTK2/src/WorkerThreads.cpp:816
 msgid "Stopped indexing"
 msgstr "Detenida la indizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:869
+#: UI/GTK2/src/WorkerThreads.cpp:861
 msgid "Cannot index document type"
 msgstr "No se pudo indizar el tipo de documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:873
+#: UI/GTK2/src/WorkerThreads.cpp:865
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:897
+#: UI/GTK2/src/WorkerThreads.cpp:889
 msgid "Couldn't tokenize"
 msgstr "No se pudo extraer cadenas"
 
-#: UI/GTK2/src/WorkerThreads.cpp:917
+#: UI/GTK2/src/WorkerThreads.cpp:909
 msgid "Robots META tag forbids indexing"
 msgstr "La etiqueta META Robots proh?be la indizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:972
+#: UI/GTK2/src/WorkerThreads.cpp:964
 msgid "Couldn't index"
 msgstr "No se pudo indizar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1027
+#: UI/GTK2/src/WorkerThreads.cpp:1019
 msgid "Stopped unindexing document(s)"
 msgstr "Detenida la des-indizaci?n de documento(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1046
+#: UI/GTK2/src/WorkerThreads.cpp:1038
 msgid "Couldn't unindex document(s)"
 msgstr "No se pudo des-indizar lo(s) documento(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1131
+#: UI/GTK2/src/WorkerThreads.cpp:1123
 msgid "Stopped document update for"
 msgstr "Detenida la actualizaci?n del documento por"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1166
+#: UI/GTK2/src/WorkerThreads.cpp:1158
 msgid "Couldn't update document"
 msgstr "No se pudo actualizar el documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1216
+#: UI/GTK2/src/WorkerThreads.cpp:1208
 msgid "Stopped monitoring"
 msgstr "Detenida la monitorizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1233
+#: UI/GTK2/src/WorkerThreads.cpp:1225
 msgid "No monitoring handler"
 msgstr "No hay monitorizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1285
+#: UI/GTK2/src/WorkerThreads.cpp:1277
 msgid "Couldn't initialize file monitor"
 msgstr "No se puede inicializar el monitor de archivo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1398
+#: UI/GTK2/src/WorkerThreads.cpp:1391
 msgid "Stopped scanning"
 msgstr "Detenida la exploraci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1556
+#: UI/GTK2/src/WorkerThreads.cpp:1549
 msgid "Couldn't open directory"
 msgstr "No se pudo abrir el directorio"

Modified: trunk/po/fr.po
===================================================================
--- trunk/po/fr.po	2006-05-24 13:56:48 UTC (rev 270)
+++ trunk/po/fr.po	2006-05-24 13:59:01 UTC (rev 271)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.43\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-05-22 23:36+0800\n"
+"POT-Creation-Date: 2006-05-24 15:04+0800\n"
 "PO-Revision-Date: 2006-01-20 19:44+0800\n"
 "Last-Translator: Fabrice Colin <colinf at chez.com>\n"
 "Language-Team: fr <colinf at chez.com>\n"
@@ -24,17 +24,17 @@
 msgid "Current User"
 msgstr "Utilisateur"
 
-#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:352
-#: UI/GTK2/src/mainWindow.cc:355 UI/GTK2/src/mainWindow.cc:525
-#: UI/GTK2/src/mainWindow.cc:998 UI/GTK2/src/mainWindow.cc:1054
-#: UI/GTK2/src/mainWindow.cc:1074 UI/GTK2/src/mainWindow.cc:1109
-#: UI/GTK2/src/mainWindow.cc:1699 UI/GTK2/src/PinotSettings.cpp:204
+#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:354
+#: UI/GTK2/src/mainWindow.cc:357 UI/GTK2/src/mainWindow.cc:528
+#: UI/GTK2/src/mainWindow.cc:1001 UI/GTK2/src/mainWindow.cc:1057
+#: UI/GTK2/src/mainWindow.cc:1077 UI/GTK2/src/mainWindow.cc:1112
+#: UI/GTK2/src/mainWindow.cc:1703 UI/GTK2/src/PinotSettings.cpp:204
 #: UI/GTK2/src/PinotSettings.cpp:970 UI/GTK2/src/PinotSettings.cpp:1026
 msgid "My Documents"
 msgstr "Mes Documents"
 
-#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:358
-#: UI/GTK2/src/mainWindow.cc:361 UI/GTK2/src/mainWindow.cc:529
+#: UI/GTK2/src/EnginesTree.cpp:344 UI/GTK2/src/mainWindow.cc:360
+#: UI/GTK2/src/mainWindow.cc:363 UI/GTK2/src/mainWindow.cc:532
 #: UI/GTK2/src/MboxHandler.cpp:159 UI/GTK2/src/PinotSettings.cpp:205
 #: UI/GTK2/src/PinotSettings.cpp:971 UI/GTK2/src/PinotSettings.cpp:1027
 #: UI/GTK2/src/prefsDialog_glade.cc:115
@@ -160,216 +160,216 @@
 msgid "Summary"
 msgstr "Sommaire"
 
-#: UI/GTK2/src/mainWindow.cc:223
+#: UI/GTK2/src/mainWindow.cc:225
 msgid "Add index"
 msgstr "Ajouter un index"
 
-#: UI/GTK2/src/mainWindow.cc:224
+#: UI/GTK2/src/mainWindow.cc:226
 msgid "Remove index"
 msgstr "Enlever un index"
 
-#: UI/GTK2/src/mainWindow.cc:240
+#: UI/GTK2/src/mainWindow.cc:242
 msgid "Ready"
 msgstr "Pret"
 
-#: UI/GTK2/src/mainWindow.cc:257 UI/GTK2/src/mainWindow.cc:955
-#: UI/GTK2/src/mainWindow.cc:1292 UI/GTK2/src/mainWindow.cc:2904
+#: UI/GTK2/src/mainWindow.cc:259 UI/GTK2/src/mainWindow.cc:958
+#: UI/GTK2/src/mainWindow.cc:1295 UI/GTK2/src/mainWindow.cc:2913
 #: UI/GTK2/src/mainWindow_glade.cc:210
 msgid "View"
 msgstr "Voir"
 
-#: UI/GTK2/src/mainWindow.cc:289
+#: UI/GTK2/src/mainWindow.cc:291
 msgid "N/A"
 msgstr "Inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:299
+#: UI/GTK2/src/mainWindow.cc:301
 msgid "<undefined>"
 msgstr "<inconnu>"
 
-#: UI/GTK2/src/mainWindow.cc:487
+#: UI/GTK2/src/mainWindow.cc:490
 msgid "Result location is"
 msgstr "Le chemin du resultat est"
 
-#: UI/GTK2/src/mainWindow.cc:540
+#: UI/GTK2/src/mainWindow.cc:543
 msgid "Document location is"
 msgstr "Le chemin du document is"
 
-#: UI/GTK2/src/mainWindow.cc:797
+#: UI/GTK2/src/mainWindow.cc:800
 msgid "Showing"
 msgstr "Listant"
 
-#: UI/GTK2/src/mainWindow.cc:802
+#: UI/GTK2/src/mainWindow.cc:805
 msgid "off"
 msgstr "documents,"
 
-#: UI/GTK2/src/mainWindow.cc:807
+#: UI/GTK2/src/mainWindow.cc:810
 msgid "documents, starting at"
 msgstr "au total, a partir de"
 
-#: UI/GTK2/src/mainWindow.cc:841
+#: UI/GTK2/src/mainWindow.cc:844
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:845 UI/GTK2/src/mainWindow.cc:2732
+#: UI/GTK2/src/mainWindow.cc:848 UI/GTK2/src/mainWindow.cc:2739
 msgid "on"
 msgstr "sur"
 
-#: UI/GTK2/src/mainWindow.cc:849
+#: UI/GTK2/src/mainWindow.cc:852
 msgid "ended"
 msgstr "est terminee"
 
-#: UI/GTK2/src/mainWindow.cc:930
+#: UI/GTK2/src/mainWindow.cc:933
 msgid "Updated label(s)"
 msgstr "Mis a jour l(es) etiquette(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1008
+#: UI/GTK2/src/mainWindow.cc:1011
 msgid "Updated document"
 msgstr "Mis a jour le document"
 
-#: UI/GTK2/src/mainWindow.cc:1023
+#: UI/GTK2/src/mainWindow.cc:1026
 msgid "Indexed"
 msgstr "Indexe"
 
-#: UI/GTK2/src/mainWindow.cc:1075
+#: UI/GTK2/src/mainWindow.cc:1078
 msgid "Unindexed document(s)"
 msgstr "Desindexe le(s) document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1120
+#: UI/GTK2/src/mainWindow.cc:1123
 msgid "Updated document properties"
 msgstr "Mis a jour les proprietes du document"
 
-#: UI/GTK2/src/mainWindow.cc:1167
+#: UI/GTK2/src/mainWindow.cc:1170
 msgid "Couldn't rename index, name"
 msgstr "N'a pas pu renommer l'index, le nom"
 
-#: UI/GTK2/src/mainWindow.cc:1171 UI/GTK2/src/mainWindow.cc:2043
-#: UI/GTK2/src/mainWindow.cc:2566
+#: UI/GTK2/src/mainWindow.cc:1174 UI/GTK2/src/mainWindow.cc:2050
+#: UI/GTK2/src/mainWindow.cc:2573
 msgid "is already in use"
 msgstr "est deja utilise"
 
-#: UI/GTK2/src/mainWindow.cc:1184
+#: UI/GTK2/src/mainWindow.cc:1187
 msgid "Couldn't rename index"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1197
+#: UI/GTK2/src/mainWindow.cc:1200
 msgid "Edited index"
 msgstr "Edite l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1638 UI/GTK2/src/mainWindow.cc:1740
+#: UI/GTK2/src/mainWindow.cc:1642 UI/GTK2/src/mainWindow.cc:1746
 msgid "Please set a location for the index first"
 msgstr "Donnez un chemin a l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1665
+#: UI/GTK2/src/mainWindow.cc:1669
 msgid "Result location is unknown"
 msgstr "Le chemin du resultat est inconnu"
 
-#: UI/GTK2/src/mainWindow.cc:1689
+#: UI/GTK2/src/mainWindow.cc:1693
 msgid "Import Document(s)"
 msgstr "Import de Document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1818 UI/GTK2/src/WorkerThreads.cpp:424
-#: UI/GTK2/src/WorkerThreads.cpp:1146
+#: UI/GTK2/src/mainWindow.cc:1825 UI/GTK2/src/WorkerThreads.cpp:424
+#: UI/GTK2/src/WorkerThreads.cpp:1138
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:1822 UI/GTK2/src/WorkerThreads.cpp:428
-#: UI/GTK2/src/WorkerThreads.cpp:1150
+#: UI/GTK2/src/mainWindow.cc:1829 UI/GTK2/src/WorkerThreads.cpp:428
+#: UI/GTK2/src/WorkerThreads.cpp:1142
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
-#: UI/GTK2/src/mainWindow.cc:1923
+#: UI/GTK2/src/mainWindow.cc:1930
 msgid "Remove this document from the index ?"
 msgstr "Enlever ce document de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:1942
+#: UI/GTK2/src/mainWindow.cc:1949
 msgid "Remove these documents from the index ?"
 msgstr "Enlever ces documents de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:1994
+#: UI/GTK2/src/mainWindow.cc:2001
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Un outil de recherche pour le Bureau Libre"
 
-#: UI/GTK2/src/mainWindow.cc:1995
+#: UI/GTK2/src/mainWindow.cc:2002
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2039
+#: UI/GTK2/src/mainWindow.cc:2046
 msgid "Index name"
 msgstr "Nom de l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2054
+#: UI/GTK2/src/mainWindow.cc:2061
 msgid "Couldn't add index"
 msgstr "N'a pas pu ajouter l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2068
+#: UI/GTK2/src/mainWindow.cc:2075
 msgid "Added new index"
 msgstr "Ajoute un nouvel index"
 
-#: UI/GTK2/src/mainWindow.cc:2103
+#: UI/GTK2/src/mainWindow.cc:2110
 msgid "Couldn't remove index"
 msgstr "N'a pas pu enlever l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2198
+#: UI/GTK2/src/mainWindow.cc:2205
 msgid "Live query"
 msgstr "Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2355
+#: UI/GTK2/src/mainWindow.cc:2362
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2562
+#: UI/GTK2/src/mainWindow.cc:2569
 msgid "Query name"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2589
+#: UI/GTK2/src/mainWindow.cc:2596
 msgid "Couldn't update query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2597
+#: UI/GTK2/src/mainWindow.cc:2604
 msgid "Edited query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2604
+#: UI/GTK2/src/mainWindow.cc:2611
 msgid "Couldn't add query"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2612
+#: UI/GTK2/src/mainWindow.cc:2619
 msgid "Added new query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2626
+#: UI/GTK2/src/mainWindow.cc:2633
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2637
+#: UI/GTK2/src/mainWindow.cc:2644
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:2719
+#: UI/GTK2/src/mainWindow.cc:2726
 msgid "Please set the Google API key first"
 msgstr "Configurez la clef de l'API Google "
 
-#: UI/GTK2/src/mainWindow.cc:2728
+#: UI/GTK2/src/mainWindow.cc:2735
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:2835
+#: UI/GTK2/src/mainWindow.cc:2842
 msgid "is already indexed or is being indexed"
 msgstr "est deja indexe ou est en cours d'indexation"
 
-#: UI/GTK2/src/mainWindow.cc:2862
+#: UI/GTK2/src/mainWindow.cc:2871
 msgid "No URL to browse"
 msgstr "Pas d'URL a brouter"
 
-#: UI/GTK2/src/mainWindow.cc:2873
+#: UI/GTK2/src/mainWindow.cc:2882
 msgid "No browser configured to view results"
 msgstr "Pas de brouter configure"
 
-#: UI/GTK2/src/mainWindow.cc:2885
+#: UI/GTK2/src/mainWindow.cc:2894
 msgid "Couldn't browse URL:"
 msgstr "N'a pas pu brouter l'URL"
 
-#: UI/GTK2/src/mainWindow.cc:2944
+#: UI/GTK2/src/mainWindow.cc:2953
 msgid "Viewing"
 msgstr "Voir"
 
@@ -699,8 +699,8 @@
 msgstr "Arrete de parcourir l'index"
 
 #: UI/GTK2/src/WorkerThreads.cpp:436 UI/GTK2/src/WorkerThreads.cpp:634
-#: UI/GTK2/src/WorkerThreads.cpp:643 UI/GTK2/src/WorkerThreads.cpp:833
-#: UI/GTK2/src/WorkerThreads.cpp:1039 UI/GTK2/src/WorkerThreads.cpp:1158
+#: UI/GTK2/src/WorkerThreads.cpp:643 UI/GTK2/src/WorkerThreads.cpp:831
+#: UI/GTK2/src/WorkerThreads.cpp:1031 UI/GTK2/src/WorkerThreads.cpp:1150
 msgid "Index error on"
 msgstr "Erreur sur l'index"
 
@@ -732,66 +732,66 @@
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N'a pas pu obtenir un brouteur pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:750 UI/GTK2/src/WorkerThreads.cpp:846
+#: UI/GTK2/src/WorkerThreads.cpp:748
 msgid "Couldn't retrieve"
 msgstr "N'a pas pu telecharger"
 
-#: UI/GTK2/src/WorkerThreads.cpp:818
+#: UI/GTK2/src/WorkerThreads.cpp:816
 msgid "Stopped indexing"
 msgstr "Arrete l'indexation"
 
-#: UI/GTK2/src/WorkerThreads.cpp:869
+#: UI/GTK2/src/WorkerThreads.cpp:861
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer ce type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:873
+#: UI/GTK2/src/WorkerThreads.cpp:865
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:897
+#: UI/GTK2/src/WorkerThreads.cpp:889
 msgid "Couldn't tokenize"
 msgstr "N'a pas pu extraire les termes de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:917
+#: UI/GTK2/src/WorkerThreads.cpp:909
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots interdit d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:972
+#: UI/GTK2/src/WorkerThreads.cpp:964
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1027
+#: UI/GTK2/src/WorkerThreads.cpp:1019
 msgid "Stopped unindexing document(s)"
 msgstr "Arrete d'indexer les document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1046
+#: UI/GTK2/src/WorkerThreads.cpp:1038
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1131
+#: UI/GTK2/src/WorkerThreads.cpp:1123
 msgid "Stopped document update for"
 msgstr "Arrete la mise a jour pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1166
+#: UI/GTK2/src/WorkerThreads.cpp:1158
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1216
+#: UI/GTK2/src/WorkerThreads.cpp:1208
 msgid "Stopped monitoring"
 msgstr "Arrete la surveillance"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1233
+#: UI/GTK2/src/WorkerThreads.cpp:1225
 msgid "No monitoring handler"
 msgstr "Pas de moniteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1285
+#: UI/GTK2/src/WorkerThreads.cpp:1277
 msgid "Couldn't initialize file monitor"
 msgstr "N'a pas pu initializer le moniteur de fichiers"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1398
+#: UI/GTK2/src/WorkerThreads.cpp:1391
 msgid "Stopped scanning"
 msgstr "Arrete de scanner"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1556
+#: UI/GTK2/src/WorkerThreads.cpp:1549
 msgid "Couldn't open directory"
 msgstr "N'a pas pu ouvrir le repertoire"



From fabricecolin at berlios.de  Thu May 25 15:59:32 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 25 May 2006 15:59:32 +0200
Subject: [Pinot-svn] r272 - trunk/Monitor
Message-ID: <200605251359.k4PDxWqg032603@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-25 15:59:15 +0200 (Thu, 25 May 2006)
New Revision: 272

Modified:
   trunk/Monitor/Makefile.am
Log:
Distribute linux-inotify-syscalls.h.


Modified: trunk/Monitor/Makefile.am
===================================================================
--- trunk/Monitor/Makefile.am	2006-05-24 13:59:01 UTC (rev 271)
+++ trunk/Monitor/Makefile.am	2006-05-25 13:59:15 UTC (rev 272)
@@ -5,7 +5,8 @@
 	MonitorEvent.h \
 	MonitorFactory.h \
 	MonitorHandler.h \
-	MonitorInterface.h
+	MonitorInterface.h \
+	linux-inotify-syscalls.h
 
 noinst_LTLIBRARIES = libMonitor.la
 



From fabricecolin at berlios.de  Thu May 25 16:40:08 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 25 May 2006 16:40:08 +0200
Subject: [Pinot-svn] r273 - trunk
Message-ID: <200605251440.k4PEe87p014071@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-25 16:40:08 +0200 (Thu, 25 May 2006)
New Revision: 273

Modified:
   trunk/NEWS
Log:
Releasing 0.48 today.


Modified: trunk/NEWS
===================================================================
--- trunk/NEWS	2006-05-25 13:59:15 UTC (rev 272)
+++ trunk/NEWS	2006-05-25 14:40:08 UTC (rev 273)
@@ -1,4 +1,4 @@
-??? version_0_4_8
+2006/05/25 version_0_4_8
 Monitor :
  - replaced FAM/Gamin with inotify
 Search :



From fabricecolin at berlios.de  Thu May 25 16:41:52 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 25 May 2006 16:41:52 +0200
Subject: [Pinot-svn] r274 - tags
Message-ID: <200605251441.k4PEfqMA014204@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-25 16:41:51 +0200 (Thu, 25 May 2006)
New Revision: 274

Added:
   tags/version_0_4_8/
Log:
v0.48 release.


Copied: tags/version_0_4_8 (from rev 273, trunk)



From fabricecolin at berlios.de  Tue May 30 13:02:44 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 30 May 2006 13:02:44 +0200
Subject: [Pinot-svn] r275 - trunk
Message-ID: <200605301102.k4UB2inp019277@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-30 13:02:43 +0200 (Tue, 30 May 2006)
New Revision: 275

Modified:
   trunk/TODO
Log:
Corrected inaccurracies :-)


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2006-05-25 14:41:51 UTC (rev 274)
+++ trunk/TODO	2006-05-30 11:02:43 UTC (rev 275)
@@ -15,7 +15,7 @@
 Tokenize
 - Allow to cache documents that had to be converted ? eg PDF, MS Word
 - PDF tokenizer with poppler
-- HTML tokenizer with liboil
+- HTML tokenizer with libtidy or libxml2
 - WordPerfect tokenizer with libwpd
 - Spin tokenizers into separate project, a la libextractor
 - Check whether pdftohtml flatens text in PDF documents that have columns.
@@ -33,7 +33,7 @@
 - Support for HTML frames
 
 Search
-- Write a Spirit or a liboil-based parser for extracting results from web pages
+- Write a parser for extracting results from web pages
 - Allow to use "extended" INTERPRET tags selectively 
 - With engines that provide a redirection URL for results (eg Acoona), it looks like
   the query hitory is not saved/checked correctly



From fabricecolin at berlios.de  Tue May 30 14:38:45 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 30 May 2006 14:38:45 +0200
Subject: [Pinot-svn] r276 - trunk/Tokenize
Message-ID: <200605301238.k4UCcjNb029162@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-30 14:38:39 +0200 (Tue, 30 May 2006)
New Revision: 276

Modified:
   trunk/Tokenize/HtmlTokenizer.cpp
   trunk/Tokenize/HtmlTokenizer.h
   trunk/Tokenize/Makefile.am
   trunk/Tokenize/OpenDocumentTokenizer.cpp
   trunk/Tokenize/OpenDocumentTokenizer.h
   trunk/Tokenize/PdfTokenizer.cpp
   trunk/Tokenize/PdfTokenizer.h
   trunk/Tokenize/RtfTokenizer.cpp
   trunk/Tokenize/RtfTokenizer.h
   trunk/Tokenize/XmlTokenizer.cpp
   trunk/Tokenize/XmlTokenizer.h
   trunk/Tokenize/tokenizertest.cpp
Log:
Revisited HTML parser. It now uses libxml2's HTMLparser. This is not yet
wrapped by libxml++ by the way.
Cleaned up other tokenizers.


Modified: trunk/Tokenize/HtmlTokenizer.cpp
===================================================================
--- trunk/Tokenize/HtmlTokenizer.cpp	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/HtmlTokenizer.cpp	2006-05-30 12:38:39 UTC (rev 276)
@@ -17,379 +17,543 @@
 #include <string.h>
 #include <strings.h>
 #include <sys/types.h>
-#include <regex.h>
-#include <stack>
+#include <libxml/xmlerror.h>
+#include <libxml/HTMLparser.h>
 #include <iostream>
-#include <algorithm>
 
 #include "StringManip.h"
+#include "XmlTokenizer.h"
 #include "HtmlTokenizer.h"
 
-//#define DEBUG_TOKENIZER
-
 using std::cout;
+using std::cerr;
 using std::endl;
 using std::string;
 using std::map;
 using std::set;
-using std::stack;
 
-HtmlTokenizer::HtmlTokenizer(const Document *pDocument, unsigned int linksStartAtPos) :
-	Tokenizer(NULL),
-	m_pHtmlDocument(NULL),
-	m_linkPos(linksStartAtPos)
+Link::Link() :
+	m_index(0),
+	m_startPos(0),
+	m_endPos(0)
 {
-	initialize(pDocument);
 }
 
-HtmlTokenizer::HtmlTokenizer() :
-	Tokenizer(NULL),
-	m_pHtmlDocument(NULL),
-	m_linkPos(0)
+Link::Link(const Link &other) :
+	m_url(other.m_url),
+	m_name(other.m_name),
+	m_index(other.m_index),
+	m_startPos(other.m_startPos),
+	m_endPos(other.m_endPos)
 {
 }
 
-HtmlTokenizer::~HtmlTokenizer()
+Link::~Link()
 {
-	if (m_pDocument != NULL)
-	{
-		// This should have been set by setDocument(),
-		// called in initialize()
-		delete m_pDocument;
-	}
 }
 
-void HtmlTokenizer::initialize(const Document *pDocument)
+Link& Link::operator=(const Link& other)
 {
-	unsigned int length = 0;
+	m_url = other.m_url;
+	m_name = other.m_name;
+	m_index = other.m_index;
+	m_startPos = other.m_startPos;
+	m_endPos = other.m_endPos;
 
-	if (pDocument == NULL)
-	{
-		return;
-	}
+	return *this;
+}
 
-	const char *data = pDocument->getData(length);
-	if ((data != NULL) &&
-		(length > 0))
-	{
-		// Remove HTML tags
-		string strippedData = parseHTML(data);
-		// Append META keywords, if any were found
-		strippedData += getMetaTag("keywords");
+bool Link::operator==(const Link &other) const
+{
+	return m_url == other.m_url;
+}
 
-		// Pass the result to the parent class
-		Document *pStrippedDoc = new Document(pDocument->getTitle(),
-			pDocument->getLocation(), pDocument->getType(),
-			pDocument->getLanguage());
-		pStrippedDoc->setData(strippedData.c_str(), strippedData.length());
-		setDocument(pStrippedDoc);
+bool Link::operator<(const Link &other) const
+{
+	return m_index < other.m_index;
+}
 
-		m_pHtmlDocument = pDocument;
-	}
+HtmlTokenizer::ParserState::ParserState() :
+	m_textPos(0),
+	m_inHead(false),
+	m_foundHead(false),
+	m_appendToTitle(false),
+	m_appendToText(false),
+	m_appendToLink(false),
+	m_skip(0)
+{
 }
 
-/// Parses HTML; the string without tags.
-string HtmlTokenizer::parseHTML(const string &str, bool stripAllBlocks)
+HtmlTokenizer::ParserState::~ParserState()
 {
-	stack<string> tagsStack;
-	string stripped, link, linkName;
-	string::size_type startPos = 0, linkOpenPos = 0;
-	regex_t linksRegex, metaRegex;
-	bool isHtml = false, skip = false, catText = stripAllBlocks;
-	bool extractLinks = true, extractMetaTags = true, getLinkName = false;
+}
 
-#ifdef DEBUG_TOKENIZER
-	cout << "HtmlTokenizer::parseHTML: start" << endl;
-#endif
-	// Prepare the regexps
-	if (regcomp(&linksRegex, "a(.*)href=(.*)", REG_EXTENDED|REG_ICASE) != 0)
+static void startHandler(void *pData, const char *pElementName, const char **pAttributes)
+{
+	if ((pData == NULL) ||
+		(pElementName == NULL) ||
+		(strlen(pElementName) == 0))
 	{
-#ifdef DEBUG_TOKENIZER
-		cout << "HtmlTokenizer::parseHTML: couldn't compile links regexp" << endl;
-#endif
-		extractLinks = false;
+		return;
 	}
-	if (regcomp(&metaRegex, "meta name=(.*) content=(.*)", REG_EXTENDED|REG_ICASE) != 0)
+
+	HtmlTokenizer::ParserState *pState = (HtmlTokenizer::ParserState *)pData;
+	if (pState == NULL)
 	{
-#ifdef DEBUG_TOKENIZER
-		cout << "HtmlTokenizer::parseHTML: couldn't compile meta tag regexp" << endl;
-#endif
-		extractMetaTags = false;
+		return;
 	}
 
-	// Tag start
-	string::size_type pos = str.find("<");
-	while (pos != string::npos)
+	// Reset the text hash
+	pState->m_lastHash.clear();
+
+	// What tag is this ?
+	string tagName(StringManip::toLowerCase(pElementName));
+	if ((pState->m_foundHead == false) &&
+		(tagName == "head"))
 	{
-		isHtml = true;
+		// Expect to find META tags and a title
+		pState->m_inHead = true;
+		// One head is enough :-)
+		pState->m_foundHead = true;
+	}
+	else if ((pState->m_inHead == true) &&
+		(tagName == "meta"))
+	{
+		string metaName, metaContent;
 
-		if (skip == false)
+		// Get the META tag's name and content
+		for (unsigned int attrNum = 0;
+			(pAttributes[attrNum] != NULL) && (pAttributes[attrNum + 1]); attrNum += 2)
 		{
-			string text = str.substr(startPos, pos - startPos);
-			if (catText == true)
+			if (strncasecmp(pAttributes[attrNum], "name", 4) == 0)
 			{
-				stripped += StringManip::replaceEntities(text);
-				stripped += " ";
+				metaName = pAttributes[attrNum + 1];
 			}
-
-			// Is this part of the name of the last link we found ?
-			if (getLinkName == true)
+			else if (strncasecmp(pAttributes[attrNum], "content", 7) == 0)
 			{
-				linkName += text;
-#ifdef DEBUG_TOKENIZER
-				cout << "HtmlTokenizer::parseHTML: adding to name " << text << endl;
-#endif
+				metaContent = pAttributes[attrNum + 1];
 			}
+		}
 
-			startPos = pos + 1;
-			// Tag end
-			if (str[pos] == '<')
-			{
-				pos = str.find(">", startPos);
-			}
-			// Skip stuff in the tag
-			skip = true;
+		if ((metaName.empty() == false) &&
+			(metaContent.empty() == false))
+		{
+			// Store this META tag
+			pState->m_metaTags[metaName] = metaContent;
 		}
-		else
+	}
+	else if ((pState->m_inHead == true) &&
+		(tagName == "title"))
+	{
+		// Extract title
+		pState->m_appendToTitle = true;
+	}
+	else if (tagName == "body")
+	{
+		// Index text
+		pState->m_appendToText = true;
+	}
+	else if (tagName == "a")
+	{
+		pState->m_currentLink.m_url.clear();
+		pState->m_currentLink.m_name.clear();
+
+		// Get the href
+		for (unsigned int attrNum = 0;
+			(pAttributes[attrNum] != NULL) && (pAttributes[attrNum + 1]); attrNum += 2)
 		{
-			regmatch_t pLinksMatches[3];
-			regmatch_t pMetaMatches[3];
-			int nLinksMatches = 3, nMetaMatches = 3;
-
-			// Found a tag from startPos to pos
-			string tag(str.substr(startPos, pos - startPos));
-			// Push it onto the stack
-			tagsStack.push(tag);
-#ifdef DEBUG_TOKENIZER
-			cout << "HtmlTokenizer::parseHTML: found " << tag << endl;
-#endif
-
-			if ((extractMetaTags == true) &&
-				(regexec(&metaRegex, tag.c_str(), nMetaMatches, pMetaMatches, 
-					REG_NOTBOL|REG_NOTEOL) == 0) &&
-				(pMetaMatches[nMetaMatches - 1].rm_so != -1))
+			if (strncasecmp(pAttributes[attrNum], "href", 4) == 0)
 			{
-				string tmp, metaName, metaContent;
-
-				// META tag name
-				tmp = tag.substr(pMetaMatches[1].rm_so,
-					pMetaMatches[1].rm_eo - pMetaMatches[1].rm_so);
-				// Remove quotes
-				metaName = StringManip::removeQuotes(tmp);
-
-				// META tag content
-				tmp = tag.substr(pMetaMatches[2].rm_so,
-					pMetaMatches[2].rm_eo - pMetaMatches[2].rm_so);
-				// Remove quotes
-				metaContent = StringManip::removeQuotes(tmp);
-#ifdef DEBUG_TOKENIZER
-				cout << "HtmlTokenizer::parseHTML: found META tag " << metaName << ": " << metaContent << endl;
-#endif
-				m_metaTags[metaName] = metaContent;
+				pState->m_currentLink.m_url = pAttributes[attrNum + 1];
+				break;
 			}
-			// See if this tag is an anchor
-			// pLinksMatches[0] will be something like 'a href="blah"', pLinksMatches[1] will be ' ' and [2] will be '"blah"'
-			else if ((extractLinks == true) &&
-				(regexec(&linksRegex, tag.c_str(), nLinksMatches, pLinksMatches, REG_NOTBOL|REG_NOTEOL) == 0) &&
-				(pLinksMatches[nLinksMatches - 1].rm_so != -1))
-			{
-				string quotedLink = tag.substr(pLinksMatches[2].rm_so,
-					pLinksMatches[2].rm_eo - pLinksMatches[2].rm_so);
+		}
 
-#ifdef DEBUG_TOKENIZER
-				cout << "HtmlTokenizer::parseHTML: found link start " << tag << endl;
+		if (pState->m_currentLink.m_url.empty() == false)
+		{
+			// FIXME: get the NodeInfo to find out the position of this link
+			pState->m_currentLink.m_startPos = pState->m_textPos;
+#ifdef DEBUG
+			cout << "HtmlTokenizer::startHandler: found link to " << pState->m_currentLink.m_url << endl;
 #endif
-				if (link.empty() == false)
-				{
-					// The previous link's anchor's end couldn't be found ?
-					m_links.insert(Link(stripTags(link), linkName, m_linkPos, linkOpenPos, startPos - 1));
-					m_linkPos++;
-					linkName = "";
-#ifdef DEBUG_TOKENIZER
-					cout << "HtmlTokenizer::parseHTML: previous link wasn't closed properly" << endl;
-#endif
-				}
 
-				// Remove quotes
-				link = StringManip::removeQuotes(quotedLink);
-				linkOpenPos = startPos - 1;
+			// Extract link
+			pState->m_appendToLink = true;
+		}
+	}
+	else if (tagName == "frame")
+	{
+		Link frame;
 
-				// Remember to get the name of the link
-				getLinkName = true;
-			}
-			// Maybe it's the anchor's end ?
-			else if ((extractLinks == true) &&
-				(strncasecmp(tag.c_str(), "/a", 2) == 0))
+		// Get the name and source
+		for (unsigned int attrNum = 0;
+			(pAttributes[attrNum] != NULL) && (pAttributes[attrNum + 1]); attrNum += 2)
+		{
+			if (strncasecmp(pAttributes[attrNum], "name", 4) == 0)
 			{
-				if (getLinkName == true)
-				{
-#ifdef DEBUG_TOKENIZER
-					cout << "HtmlTokenizer::parseHTML: " << pos << " link " << m_linkPos << " is " << link << ", name " << linkName << endl;
-#endif
-					// New link
-					m_links.insert(Link(stripTags(link), linkName, m_linkPos, linkOpenPos, pos + 1));
-					m_linkPos++;
-					getLinkName = false;
-					link = linkName = "";
-				}
+				frame.m_name = pAttributes[attrNum + 1];
 			}
-			else if (stripAllBlocks == false)
+			else if (strncasecmp(pAttributes[attrNum], "src", 3) == 0)
 			{
-				if (textBlockStart(tag) == true)
-				{
-					catText = true;
-#ifdef DEBUG_TOKENIZER
-					cout << "HtmlTokenizer::parseHTML: start text cat" << endl;
-#endif
-				}
-				else if (textBlockEnd(tag) == true)
-				{
-					catText = false;
-#ifdef DEBUG_TOKENIZER
-					cout << "HtmlTokenizer::parseHTML: end text cat" << endl;
-#endif
-				}
-				else
-				{
-					string parentTag = tagsStack.top();
-
-					if ((strncasecmp(tag.c_str(), "script", 6) == 0) ||
-						(strncasecmp(tag.c_str(), "style", 5) == 0))
-					{
-#ifdef DEBUG_TOKENIZER
-						cout << "HtmlTokenizer::parseHTML: skip script" << endl;
-#endif
-						catText = false;
-					}
-					else if (((strncasecmp(tag.c_str(), "/script", 7) == 0) ||
-						(strncasecmp(tag.c_str(), "/style", 6) == 0)) &&
-						(textBlockStart(parentTag) == false))
-					{
-#ifdef DEBUG_TOKENIZER
-						cout << "HtmlTokenizer::parseHTML: stop skip script" << endl;
-#endif
-						catText = true;
-					}
-				}
+				frame.m_url = pAttributes[attrNum + 1];
 			}
+		}
 
-			startPos = pos + 1;
-			pos = str.find("<", startPos);
-			skip = false;
+		if (frame.m_url.empty() == false)
+		{
+			// Store this frame
+			pState->m_frames.insert(frame);
 		}
 	}
-	if ((startPos < str.length()) &&
-		(catText == true))
+	else if ((tagName == "frameset") ||
+		(tagName == "script") ||
+		(tagName == "style"))
 	{
-		stripped  += StringManip::replaceEntities(str.substr(startPos));
+		// Skip
+		++pState->m_skip;
 	}
+}
 
-	// Free the compiled regexps
-	regfree(&linksRegex);
-	regfree(&metaRegex);
+static void endHandler(void *pData, const char *pElementName)
+{
+	if ((pData == NULL) ||
+		(pElementName == NULL) ||
+		(strlen(pElementName) == 0))
+	{
+		return;
+	}
 
-	if (isHtml == false)
+	HtmlTokenizer::ParserState *pState = (HtmlTokenizer::ParserState *)pData;
+	if (pState == NULL)
 	{
-		return str;
+		return;
 	}
 
-	return stripped;
+	// Reset state
+	string tagName(StringManip::toLowerCase(pElementName));
+	if (tagName == "head")
+	{
+		pState->m_inHead = false;
+	}
+	else if (tagName == "title")
+	{
+		StringManip::removeCharacters(pState->m_title, "\t\r\n");
+#ifdef DEBUG
+		cout << "HtmlTokenizer::endHandler: title is " << pState->m_title << endl;
+#endif
+		pState->m_appendToTitle = false;
+	}
+	else if (tagName == "body")
+	{
+		pState->m_appendToText = false;
+	}
+	else if (tagName == "a")
+	{
+		if (pState->m_currentLink.m_url.empty() == false)
+		{
+			// FIXME: get the NodeInfo to find out the position of this link
+			pState->m_currentLink.m_endPos = pState->m_textPos;
+
+			// Store this link
+			pState->m_links.insert(pState->m_currentLink);
+			++pState->m_currentLink.m_index;
+#ifdef DEBUG
+			cout << "HtmlTokenizer::endHandler: link was " << pState->m_currentLink.m_name << endl;
+#endif
+		}
+
+		pState->m_appendToLink = false;
+	}
+	else if ((tagName == "frameset") ||
+		(tagName == "script") ||
+		(tagName == "style"))
+	{
+		--pState->m_skip;
+	}
 }
 
-/// Returns true if the tag corresponds to a text block.
-bool HtmlTokenizer::textBlockStart(const string &tag)
+static void charactersHandler(void *pData, const char *pText, int textLen)
 {
-	if ((strncasecmp(tag.c_str(), "body", 4) == 0) ||
-		(strncasecmp(tag.c_str(), "title", 5) == 0))
+	if ((pData == NULL) ||
+		(pText == NULL) ||
+		(textLen == 0))
 	{
-		return true;
+		return;
 	}
 
-	return false;
-}
+	HtmlTokenizer::ParserState *pState = (HtmlTokenizer::ParserState *)pData;
+	if (pState == NULL)
+	{
+		return;
+	}
 
-/// Returns true if the tag corresponds to the end of a text block.
-bool HtmlTokenizer::textBlockEnd(const string &tag)
-{
-	if ((strncasecmp(tag.c_str(), "/body", 5) == 0) ||
-		(strncasecmp(tag.c_str(), "/title", 6) == 0))
+	pState->m_textPos += textLen;
+	if (pState->m_skip > 0)
 	{
-		return true;
+		// Skip this
+		return;
 	}
 
-	return false;
+	string text(pText, textLen);
+
+	// For some reason, this handler might be called twice for the same text !
+	// See http://mail.gnome.org/archives/xml/2002-September/msg00089.html
+	string textHash(StringManip::hashString(text));
+	if (pState->m_lastHash == textHash)
+	{
+		// Ignore this
+#ifdef DEBUG
+		cout << "HtmlTokenizer::charactersHandler: ignoring duplicate text" << endl;
+#endif
+		return;
+	}
+	pState->m_lastHash = textHash;
+
+	// Append current text
+	// FIXME: convert to UTF-8 or Latin 1 ?
+	if (pState->m_appendToTitle == true)
+	{
+		pState->m_title += text;
+	}
+	else
+	{
+		if (pState->m_appendToText == true)
+		{
+			pState->m_text += text;
+		}
+
+		// Appending to text and to link are not mutually exclusive operations
+		if (pState->m_appendToLink == true)
+		{
+			pState->m_currentLink.m_name += text;
+		}
+	}
 }
 
-/// Gets the specified META tag content.
-string HtmlTokenizer::getMetaTag(const string &name)
+static void cDataHandler(void *pData, const char *pText, int textLen)
 {
-	if (name.empty() == true)
+	// Nothing to do
+}
+
+static void whitespaceHandler(void *pData, const xmlChar *pText, int txtLen)
+{
+	if (pData == NULL)
 	{
-		return "";
+		return;
 	}
 
-	map<string, string>::const_iterator iter = m_metaTags.find(name);
-	if (iter != m_metaTags.end())
+	HtmlTokenizer::ParserState *pState = (HtmlTokenizer::ParserState *)pData;
+	if (pState == NULL)
 	{
-		return iter->second;
+		return;
 	}
 
-	return "";
+	if (pState->m_skip > 0)
+	{
+		// Skip this
+		return;
+	}
+
+	// Append a single space
+	if (pState->m_appendToTitle == true)
+	{
+		pState->m_title += " ";
+	}
+	else
+	{
+		if (pState->m_appendToText == true)
+		{
+			pState->m_text += " ";
+		}
+
+		// Appending to text and to link are not mutually exclusive operations
+		if (pState->m_appendToLink == true)
+		{
+			pState->m_currentLink.m_name += " ";
+		}
+	}
 }
 
-/// Gets the links map.
-set<Link> &HtmlTokenizer::getLinks(void)
+static void commentHandler(void *pData, const char *pText)
 {
-	return m_links;
+	// FIXME: take comments into account, eg on terms position ?
 }
 
-/// Utility method that strips HTML tags off; the string without tags.
-string HtmlTokenizer::stripTags(const string &str)
+static void errorHandler(void *pData, const char *pMsg, ...)
 {
-	HtmlTokenizer tokens;
+	va_list args;
+	char pErr[1000];
 
-	return tokens.parseHTML(str, true);
+	va_start(args, pMsg);
+	vsnprintf(pErr, 1000, pMsg, args );
+	va_end(args);
+
+	cerr << "HtmlTokenizer::errorHandler: " << pErr << endl;
+
+	// Be lenient as much as possible
+	xmlResetLastError();
 }
 
-Link::Link(const string &url, const string &name, unsigned int pos, unsigned int openPos, unsigned int closePos) :
-	m_url(url),
-	m_name(name),
-	m_pos(pos),
-	m_open(openPos),
-	m_close(closePos)
+static void warningHandler(void *pData, const char *pMsg, ...)
 {
+	va_list args;
+	char pErr[1000];
+
+	va_start(args, pMsg);
+	vsnprintf(pErr, 1000, pMsg, args );
+	va_end(args);
+
+	cerr << "HtmlTokenizer::warningHandler: " << pErr << endl;
 }
 
-Link::Link(const Link &other) :
-	m_url(other.m_url),
-	m_name(other.m_name),
-	m_pos(other.m_pos),
-	m_open(other.m_open),
-	m_close(other.m_close)
+HtmlTokenizer::HtmlTokenizer(const Document *pDocument, unsigned int linksStartAtPos) :
+	Tokenizer(NULL)
 {
+	if (pDocument != NULL)
+	{
+		unsigned int length = 0;
+		const char *pData = pDocument->getData(length);
+
+		if ((pData != NULL) &&
+			(length > 0) &&
+			(parseHTML(pData) == true))
+		{
+			// Append META keywords, if any were found
+			m_state.m_text += getMetaTag("keywords");
+
+			// Did we find a title ?
+			if (m_state.m_title.empty() == true)
+			{
+				m_state.m_title = pDocument->getTitle();
+			}
+
+			// Pass the result to the parent class
+			Document *pStrippedDoc = new Document(m_state.m_title,
+				pDocument->getLocation(), pDocument->getType(),
+				pDocument->getLanguage());
+			pStrippedDoc->setData(m_state.m_text.c_str(), m_state.m_text.length());
+
+			setDocument(pStrippedDoc);
+		}
+	}
 }
 
-Link::~Link()
+HtmlTokenizer::~HtmlTokenizer()
 {
+	if (m_pDocument != NULL)
+	{
+		// This should have been set by setDocument(),
+		// called in initialize()
+		delete m_pDocument;
+	}
 }
 
-Link& Link::operator=(const Link& other)
+bool HtmlTokenizer::parseHTML(const string &str)
 {
-	m_url = other.m_url;
-	m_name = other.m_name;
-	m_pos = other.m_pos;
-	m_open = other.m_open;
-	m_close = other.m_close;
+	string htmlChunk(str);
+	htmlSAXHandler saxHandler;
 
-	return *this;
+	if (str.empty() == true)
+	{
+#ifdef DEBUG
+		cout << "HtmlTokenizer::parseHTML: no input" << endl;
+#endif
+		return false;
+	}
+
+	xmlInitParser();
+
+	// Setup the SAX handler
+	memset((void*)&saxHandler, 0, sizeof(htmlSAXHandler));
+	saxHandler.startElement = (startElementSAXFunc)&startHandler;
+	saxHandler.endElement = (endElementSAXFunc)&endHandler;
+	saxHandler.characters = (charactersSAXFunc)&charactersHandler;
+	saxHandler.cdataBlock = (charactersSAXFunc)&cDataHandler;
+	saxHandler.ignorableWhitespace = (ignorableWhitespaceSAXFunc)&whitespaceHandler;
+	saxHandler.comment = (commentSAXFunc)&commentHandler;
+	saxHandler.fatalError = (fatalErrorSAXFunc)&errorHandler;
+	saxHandler.error = (errorSAXFunc)&errorHandler;
+	saxHandler.warning = (warningSAXFunc)&warningHandler;
+
+	// Try to cope with pages that have scripts or other rubbish prepended
+	string::size_type htmlPos = htmlChunk.find("<!DOCTYPE");
+	if (htmlPos == string::npos)
+	{
+		htmlPos = htmlChunk.find("<!doctype");
+	}
+	if ((htmlPos != string::npos) &&
+		(htmlPos > 0))
+	{
+		htmlChunk.erase(0, htmlPos);
+#ifdef DEBUG
+		cout << "HtmlTokenizer::parseHTML: removed " << htmlPos << " characters" << endl;
+#endif
+	}
+
+	// Wrap input with a dummy tag to avoid the characters handler being called with twice the same text
+	htmlPos = htmlChunk.find("<HTML");
+	if (htmlPos == string::npos)
+	{
+		htmlPos = htmlChunk.find("<html");
+	}
+	if (htmlPos == string::npos)
+	{
+		string dummyHtml("<html>");
+		dummyHtml += htmlChunk;
+		dummyHtml += "</html>";
+		htmlChunk = dummyHtml;
+#ifdef DEBUG
+		cout << "HtmlTokenizer::parseHTML: wrapped input" << endl;
+#endif
+	}
+
+#ifndef _DONT_USE_PUSH_INTERFACE
+	htmlParserCtxtPtr pContext = htmlCreatePushParserCtxt(&saxHandler, (void*)&m_state,
+		htmlChunk.c_str(), (int)htmlChunk.length(), "", XML_CHAR_ENCODING_NONE);
+	if (pContext != NULL)
+	{
+		// Parse
+		htmlParseChunk(pContext, htmlChunk.c_str(), (int)htmlChunk.length(), 0);
+
+		// Free
+		htmlParseChunk(pContext, NULL, 0, 1);
+		htmlFreeParserCtxt(pContext);
+	}
+#else
+	htmlDocPtr pDoc = htmlSAXParseDoc((xmlChar *)htmlChunk.c_str(), "", &saxHandler, (void*)&m_state);
+	if (pDoc != NULL)
+	{
+		xmlFreeDoc(pDoc);
+	}
+#endif
+	else
+	{
+		cerr << "HtmlTokenizer::parseHTML: couldn't create parser context" << endl;
+	}
+	xmlCleanupParser();
+
+	return true;
 }
 
-bool Link::operator==(const Link &other) const
+/// Gets the specified META tag content.
+string HtmlTokenizer::getMetaTag(const string &name)
 {
-	return m_url == other.m_url;
+	if (name.empty() == true)
+	{
+		return "";
+	}
+
+	map<string, string>::const_iterator iter = m_state.m_metaTags.find(name);
+	if (iter != m_state.m_metaTags.end())
+	{
+		return iter->second;
+	}
+
+	return "";
 }
 
-bool Link::operator<(const Link &other) const
+/// Gets the links map.
+set<Link> &HtmlTokenizer::getLinks(void)
 {
-	return m_pos < other.m_pos;
+	return m_state.m_links;
 }

Modified: trunk/Tokenize/HtmlTokenizer.h
===================================================================
--- trunk/Tokenize/HtmlTokenizer.h	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/HtmlTokenizer.h	2006-05-30 12:38:39 UTC (rev 276)
@@ -28,8 +28,7 @@
 class Link
 {
 	public:
-		Link(const std::string &url, const std::string &name,
-			unsigned int pos, unsigned int openPos, unsigned int closePos);
+		Link();
 		Link(const Link &other);
 		~Link();
 
@@ -39,9 +38,9 @@
 
 		std::string m_url;
 		std::string m_name;
-		unsigned int m_pos;
-		unsigned int m_open;
-		unsigned int m_close;
+		unsigned int m_index;
+		unsigned int m_startPos;
+		unsigned int m_endPos;
 
 };
 
@@ -57,28 +56,33 @@
 		/// Gets the links map.
 		std::set<Link> &getLinks(void);
 
-		/// Utility method that strips HTML tags off; the string without tags.
-		static std::string stripTags(const std::string &str);
+		class ParserState
+		{
+			public:
+				ParserState();
+				~ParserState();
 
+				unsigned int m_textPos;
+				std::string m_lastHash;
+				bool m_inHead;
+				bool m_foundHead;
+				bool m_appendToTitle;
+				bool m_appendToText;
+				bool m_appendToLink;
+				unsigned int m_skip;
+				std::string m_title;
+				std::string m_text;
+				Link m_currentLink;
+				std::set<Link> m_links;
+				std::set<Link> m_frames;
+				std::map<std::string, std::string> m_metaTags;
+		};
+
 	protected:
-		const Document *m_pHtmlDocument;
-		unsigned int m_linkPos;
-		std::map<std::string, std::string> m_metaTags;
-		std::set<Link> m_links;
+		ParserState m_state;
 
-		HtmlTokenizer();
+		bool parseHTML(const std::string &str);
 
-		void initialize(const Document *pDocument);
-
-		/// Parses HTML; the string without tags.
-		std::string parseHTML(const std::string &str, bool stripAllBlocks = false);
-
-		/// Returns true if the tag corresponds to a text block.
-		static bool textBlockStart(const std::string &tag);
-
-		/// Returns true if the tag corresponds to the end of a text block.
-		static bool textBlockEnd(const std::string &tag);
-
 };
 
 #endif // _HTML_TOKENIZER_H

Modified: trunk/Tokenize/Makefile.am
===================================================================
--- trunk/Tokenize/Makefile.am	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/Makefile.am	2006-05-30 12:38:39 UTC (rev 276)
@@ -1,7 +1,6 @@
 # Process this file with automake to produce Makefile.in
 
 UTILS_OBJS = ../Utils/Document.o \
-	../Utils/HtmlDocument.o \
 	../Utils/StringManip.o \
 	../Utils/DocumentInfo.o \
 	../Utils/TimeConverter.o \
@@ -74,5 +73,5 @@
 	UnknownTypeTokenizer.cpp \
 	XmlTokenizer.cpp
 
-AM_CXXFLAGS = -fPIC -I../Utils @TAGLIB_CFLAGS@
+AM_CXXFLAGS = -fPIC -I../Utils @XML_CFLAGS@ @TAGLIB_CFLAGS@
 

Modified: trunk/Tokenize/OpenDocumentTokenizer.cpp
===================================================================
--- trunk/Tokenize/OpenDocumentTokenizer.cpp	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/OpenDocumentTokenizer.cpp	2006-05-30 12:38:39 UTC (rev 276)
@@ -61,23 +61,11 @@
 }
 
 OpenDocumentTokenizer::OpenDocumentTokenizer(const Document *pDocument) :
-	XmlTokenizer(NULL)
+	XmlTokenizer(runHelperProgram(pDocument, "unzip -p", "content.xml"))
 {
 	// FIXME: unzip meta.xml and extract document information
-	// Unip content.xml
-	Document *pOutputDocument = runHelperProgram(pDocument, "unzip -p", "content.xml");
-	if (pOutputDocument != NULL)
-	{
-		// Give the result to the parent class
-		initialize(pOutputDocument);
-	}
 }
 
-OpenDocumentTokenizer::OpenDocumentTokenizer() :
-	XmlTokenizer()
-{
-}
-
 OpenDocumentTokenizer::~OpenDocumentTokenizer()
 {
 }

Modified: trunk/Tokenize/OpenDocumentTokenizer.h
===================================================================
--- trunk/Tokenize/OpenDocumentTokenizer.h	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/OpenDocumentTokenizer.h	2006-05-30 12:38:39 UTC (rev 276)
@@ -34,9 +34,6 @@
 		OpenDocumentTokenizer(const Document *pDocument);
 		virtual ~OpenDocumentTokenizer();
 
-	protected:
-		OpenDocumentTokenizer();
-
 	private:
 		OpenDocumentTokenizer(const OpenDocumentTokenizer &other);
 		OpenDocumentTokenizer& operator=(const OpenDocumentTokenizer& other);

Modified: trunk/Tokenize/PdfTokenizer.cpp
===================================================================
--- trunk/Tokenize/PdfTokenizer.cpp	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/PdfTokenizer.cpp	2006-05-30 12:38:39 UTC (rev 276)
@@ -38,22 +38,10 @@
 }
 
 PdfTokenizer::PdfTokenizer(const Document *pDocument) :
-	HtmlTokenizer(NULL)
+	HtmlTokenizer(runHelperProgram(pDocument, "pdftohtml -stdout"))
 {
-	// Run pdftohtml
-	Document *pOutputDocument = runHelperProgram(pDocument, "pdftohtml -stdout");
-	if (pOutputDocument != NULL)
-	{
-		// Give the result to the parent class
-		initialize(pOutputDocument);
-	}
 }
 
-PdfTokenizer::PdfTokenizer() :
-	HtmlTokenizer()
-{
-}
-
 PdfTokenizer::~PdfTokenizer()
 {
 }

Modified: trunk/Tokenize/PdfTokenizer.h
===================================================================
--- trunk/Tokenize/PdfTokenizer.h	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/PdfTokenizer.h	2006-05-30 12:38:39 UTC (rev 276)
@@ -34,9 +34,6 @@
 		PdfTokenizer(const Document *pDocument);
 		virtual ~PdfTokenizer();
 
-	protected:
-		PdfTokenizer();
-
 	private:
 		PdfTokenizer(const PdfTokenizer &other);
 		PdfTokenizer& operator=(const PdfTokenizer& other);

Modified: trunk/Tokenize/RtfTokenizer.cpp
===================================================================
--- trunk/Tokenize/RtfTokenizer.cpp	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/RtfTokenizer.cpp	2006-05-30 12:38:39 UTC (rev 276)
@@ -39,22 +39,10 @@
 }
 
 RtfTokenizer::RtfTokenizer(const Document *pDocument) :
-	HtmlTokenizer(NULL)
+	HtmlTokenizer(runHelperProgram(pDocument, "unrtf --nopict --html"))
 {
-	// Run unrtf
-	Document *pOutputDocument = runHelperProgram(pDocument, "unrtf --nopict --html");
-	if (pOutputDocument != NULL)
-	{
-		// Give the result to the parent class
-		initialize(pOutputDocument);
-	}
 }
 
-RtfTokenizer::RtfTokenizer() :
-	HtmlTokenizer()
-{
-}
-
 RtfTokenizer::~RtfTokenizer()
 {
 }

Modified: trunk/Tokenize/RtfTokenizer.h
===================================================================
--- trunk/Tokenize/RtfTokenizer.h	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/RtfTokenizer.h	2006-05-30 12:38:39 UTC (rev 276)
@@ -36,8 +36,6 @@
 
 	protected:
 		RtfTokenizer();
-
-	private:
 		RtfTokenizer(const RtfTokenizer &other);
 		RtfTokenizer& operator=(const RtfTokenizer& other);
 

Modified: trunk/Tokenize/XmlTokenizer.cpp
===================================================================
--- trunk/Tokenize/XmlTokenizer.cpp	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/XmlTokenizer.cpp	2006-05-30 12:38:39 UTC (rev 276)
@@ -27,16 +27,27 @@
 using std::string;
 
 XmlTokenizer::XmlTokenizer(const Document *pDocument) :
-	Tokenizer(NULL),
-	m_pXmlDocument(NULL)
+	Tokenizer(NULL)
 {
-	initialize(pDocument);
-}
+	if (pDocument != NULL)
+	{
+		unsigned int length = 0;
+		const char *data = pDocument->getData(length);
 
-XmlTokenizer::XmlTokenizer() :
-	Tokenizer(NULL),
-	m_pXmlDocument(NULL)
-{
+		if ((data != NULL) &&
+			(length > 0))
+		{
+			// Remove XML tags
+			string strippedData = parseXML(data);
+
+			// Pass the result to the parent class
+			Document *pStrippedDoc = new Document(pDocument->getTitle(),
+				pDocument->getLocation(), pDocument->getType(),
+				pDocument->getLanguage());
+			pStrippedDoc->setData(strippedData.c_str(), strippedData.length());
+			setDocument(pStrippedDoc);
+		}
+	}
 }
 
 XmlTokenizer::~XmlTokenizer()
@@ -49,33 +60,6 @@
 	}
 }
 
-void XmlTokenizer::initialize(const Document *pDocument)
-{
-	unsigned int length = 0;
-
-	if (pDocument == NULL)
-	{
-		return;
-	}
-
-	const char *data = pDocument->getData(length);
-	if ((data != NULL) &&
-		(length > 0))
-	{
-		// Remove XML tags
-		string strippedData = parseXML(data);
-
-		// Pass the result to the parent class
-		Document *pStrippedDoc = new Document(pDocument->getTitle(),
-			pDocument->getLocation(), pDocument->getType(),
-			pDocument->getLanguage());
-		pStrippedDoc->setData(strippedData.c_str(), strippedData.length());
-		setDocument(pStrippedDoc);
-
-		m_pXmlDocument = pDocument;
-	}
-}
-
 /// Parses XML; the string without tags.
 string XmlTokenizer::parseXML(const string &str)
 {
@@ -128,7 +112,5 @@
 /// Utility method that strips XML tags off; the string without tags.
 string XmlTokenizer::stripTags(const string &str)
 {
-	XmlTokenizer tokens;
-
-	return tokens.parseXML(str);
+	return parseXML(str);
 }

Modified: trunk/Tokenize/XmlTokenizer.h
===================================================================
--- trunk/Tokenize/XmlTokenizer.h	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/XmlTokenizer.h	2006-05-30 12:38:39 UTC (rev 276)
@@ -32,14 +32,10 @@
 		static std::string stripTags(const std::string &str);
 
 	protected:
-		const Document *m_pXmlDocument;
-
-		XmlTokenizer();
-
 		void initialize(const Document *pDocument);
 
 		/// Parses XML; the string without tags.
-		std::string parseXML(const std::string &str);
+		static std::string parseXML(const std::string &str);
 
 };
 

Modified: trunk/Tokenize/tokenizertest.cpp
===================================================================
--- trunk/Tokenize/tokenizertest.cpp	2006-05-30 11:02:43 UTC (rev 275)
+++ trunk/Tokenize/tokenizertest.cpp	2006-05-30 12:38:39 UTC (rev 276)
@@ -22,6 +22,7 @@
 #include <string>
 
 #include "HtmlTokenizer.h"
+#include "XmlTokenizer.h"
 #include "UnknownTypeTokenizer.h"
 #include "TokenizerFactory.h"
 #include "StringManip.h"
@@ -82,7 +83,7 @@
 		const char *pData = doc.getData(length);
 
 		cout << "Stripped text is :" << endl;
-		cout << HtmlTokenizer::stripTags(string(pData, length)) << endl;
+		cout << XmlTokenizer::stripTags(string(pData, length)) << endl;
 	}
 	else if ((strncmp(argv[2], "LISTLINKS", 9) == 0) &&
 		(pHtmlTokens != NULL))



From fabricecolin at berlios.de  Tue May 30 14:40:13 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 30 May 2006 14:40:13 +0200
Subject: [Pinot-svn] r277 - trunk/Utils
Message-ID: <200605301240.k4UCeDdH030025@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-30 14:39:56 +0200 (Tue, 30 May 2006)
New Revision: 277

Removed:
   trunk/Utils/HtmlDocument.cpp
   trunk/Utils/HtmlDocument.h
Modified:
   trunk/Utils/Makefile.am
   trunk/Utils/StringManip.cpp
Log:
HtmlDocument is no longer necessary. Fixed StringManip::removeCharacters() !


Deleted: trunk/Utils/HtmlDocument.cpp
===================================================================
--- trunk/Utils/HtmlDocument.cpp	2006-05-30 12:38:39 UTC (rev 276)
+++ trunk/Utils/HtmlDocument.cpp	2006-05-30 12:39:56 UTC (rev 277)
@@ -1,162 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#include <stdlib.h>
-#include <string.h>
-#include <sys/types.h>
-#include <regex.h>
-#include <ctype.h>
-#include <iostream>
-#include <utility>
-
-#include "HtmlDocument.h"
-#include "StringManip.h"
-
-using std::cout;
-using std::endl;
-using std::string;
-using std::min;
-
-HtmlDocument::HtmlDocument(const DocumentInfo &info) :
-	Document(info)
-{
-}
-
-HtmlDocument::HtmlDocument(const HtmlDocument &other) :
-	Document(other)
-{
-}
-
-HtmlDocument::~HtmlDocument()
-{
-}
-
-void HtmlDocument::parseHead(void)
-{
-	char *pBodyStart = strstr(m_pData, "<body");
-	if (pBodyStart == NULL)
-	{
-		pBodyStart = strstr(m_pData, "<BODY");
-	}
-	if (pBodyStart != NULL)
-	{
-		string htmlHead(m_pData, pBodyStart - m_pData);
-		regex_t titleRegex, httpEquivRegex;
-		regmatch_t pTitleMatches[3];
-		regmatch_t pHttpEquivMatches[3];
-		int titleMatches = 3, httpEquivMatches = 3;
-
-		// Look for a title
-		if (regcomp(&titleRegex, "<title([^>]*)>([^<>]*)</title", REG_EXTENDED|REG_ICASE) == 0)
-		{
-			if ((regexec(&titleRegex, htmlHead.c_str(), titleMatches,
-					pTitleMatches, REG_NOTBOL|REG_NOTEOL) == 0) &&
-				(pTitleMatches[titleMatches - 1].rm_so != -1))
-			{
-				string title = htmlHead.substr(pTitleMatches[2].rm_so,
-					pTitleMatches[2].rm_eo - pTitleMatches[2].rm_so);
-
-				if (title.empty() == false)
-				{
-					// Override the title
-					m_title = title;
-				}
-			}
-		}
-		// ...and a Content-Type
-		if (regcomp(&httpEquivRegex, "<meta http-equiv=([^>]*) content=([^>]*)>", REG_EXTENDED|REG_ICASE) == 0)
-		{
-			if ((regexec(&httpEquivRegex, htmlHead.c_str(), httpEquivMatches,
-					pHttpEquivMatches, REG_NOTBOL|REG_NOTEOL) == 0) &&
-				(pHttpEquivMatches[httpEquivMatches - 1].rm_so != -1))
-			{
-				string name = StringManip::removeQuotes(
-					htmlHead.substr(pHttpEquivMatches[1].rm_so,
-					pHttpEquivMatches[1].rm_eo - pHttpEquivMatches[1].rm_so));
-				string content = StringManip::removeQuotes(
-					htmlHead.substr(pHttpEquivMatches[2].rm_so,
-					pHttpEquivMatches[2].rm_eo - pHttpEquivMatches[2].rm_so));
-
-				if ((content.empty() == false) &&
-					(strncasecmp(name.c_str(), "Content-Type",
-						min((int)name.length(), 12)) == 0))
-				{
-					// Override the type
-					m_type = content;
-				}
-			}
-		}
-#ifdef DEBUG
-		cout << "HtmlDocument::parseHead: extracted title " << m_title <<
-			", type " << m_type << endl;
-#endif
-
-		regfree(&titleRegex);
-		regfree(&httpEquivRegex);
-	}
-}
-
-/// Copies the given data in the document.
-bool HtmlDocument::setData(const char *data, unsigned int length)
-{
-	if ((data == NULL) ||
-		(length == 0))
-	{
-		return false;
-	}
-
-	// Discard existing data
-	freeData();
-
-	// FIXME: there must be a way of getting rid of this
-	m_pData = (char *)calloc(length + 1, sizeof(char));
-	if (m_pData != NULL)
-	{
-		// Removing non-printable characters, as found in pages from alltheweb sometimes
-		// They prevent us from using strstr() and mess up the regexps
-		for (unsigned int i = 0; i < length; ++i)
-		{
-			if (isprint(data[i]) == 0)
-			{
-				m_pData[i] = ' ';
-			}
-			else
-			{
-				m_pData[i] = data[i];
-			}
-		}
-		m_dataLength = length;
-
-		parseHead();
-
-		return true;
-	}
-
-	return false;
-}
-
-/// Maps the given file.
-bool HtmlDocument::setDataFromFile(const string &fileName)
-{
-	if (Document::setDataFromFile(fileName) == true)
-	{
-		parseHead();
-
-		return true;
-	}
-
-	return false;
-}

Deleted: trunk/Utils/HtmlDocument.h
===================================================================
--- trunk/Utils/HtmlDocument.h	2006-05-30 12:38:39 UTC (rev 276)
+++ trunk/Utils/HtmlDocument.h	2006-05-30 12:39:56 UTC (rev 277)
@@ -1,42 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#ifndef _HTML_DOCUMENT_H
-#define _HTML_DOCUMENT_H
-
-#include <string>
-
-#include "Document.h"
-
-class HtmlDocument : public Document
-{
-	public:
-		HtmlDocument(const DocumentInfo &info);
-		HtmlDocument(const HtmlDocument &other);
-		virtual ~HtmlDocument();
-
-		/// Copies the given data in the document.
-		virtual bool setData(const char *data, unsigned int length);
-
-		/// Maps the given file.
-		virtual bool setDataFromFile(const std::string &fileName);
-
-	protected:
-		void parseHead(void);
-
-};
-	
-#endif // _HTML_DOCUMENT_H

Modified: trunk/Utils/Makefile.am
===================================================================
--- trunk/Utils/Makefile.am	2006-05-30 12:38:39 UTC (rev 276)
+++ trunk/Utils/Makefile.am	2006-05-30 12:39:56 UTC (rev 277)
@@ -2,7 +2,6 @@
 
 noinst_HEADERS = \
 	Document.h \
-	HtmlDocument.h \
 	Languages.h \
 	MIMEScanner.h \
 	NLS.h \
@@ -28,7 +27,6 @@
 
 libUtils_la_SOURCES = \
 	Document.cpp \
-	HtmlDocument.cpp \
 	Languages.cpp \
 	MIMEScanner.cpp \
 	StringManip.cpp \

Modified: trunk/Utils/StringManip.cpp
===================================================================
--- trunk/Utils/StringManip.cpp	2006-05-30 12:38:39 UTC (rev 276)
+++ trunk/Utils/StringManip.cpp	2006-05-30 12:39:56 UTC (rev 277)
@@ -187,7 +187,9 @@
 	while (charPos != string::npos)
 	{
 		str.erase(charPos, 1);
-		charPos = str.find_first_of(characters.c_str(), charPos - 1);
+		++count;
+
+		charPos = str.find_first_of(characters.c_str(), charPos);
 	}
 
 	return count;	



From fabricecolin at berlios.de  Tue May 30 14:41:50 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 30 May 2006 14:41:50 +0200
Subject: [Pinot-svn] r278 - trunk/Collect
Message-ID: <200605301241.k4UCfoLG030339@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-30 14:41:33 +0200 (Tue, 30 May 2006)
New Revision: 278

Modified:
   trunk/Collect/CurlDownloader.cpp
   trunk/Collect/FileCollector.cpp
   trunk/Collect/NeonDownloader.cpp
   trunk/Collect/pinot-collect.cpp
Log:
Dropped HtmlDocument use.


Modified: trunk/Collect/CurlDownloader.cpp
===================================================================
--- trunk/Collect/CurlDownloader.cpp	2006-05-30 12:39:56 UTC (rev 277)
+++ trunk/Collect/CurlDownloader.cpp	2006-05-30 12:41:33 UTC (rev 278)
@@ -22,7 +22,6 @@
 #include <curl/curl.h>
 
 #include "HtmlTokenizer.h"
-#include "HtmlDocument.h"
 #include "Url.h"
 #include "CurlDownloader.h"
 
@@ -170,32 +169,29 @@
 			{
 				char *pContentType = NULL;
 
+				// Copy the document content
+				pDocument = new Document(docInfo);
+				pDocument->setData(pContentInfo->m_pContent, pContentInfo->m_contentLen);
+				pDocument->setLocation(url);
+
 				// What's the Content-Type ?
 				res = curl_easy_getinfo(pCurlHandler, CURLINFO_CONTENT_TYPE, &pContentType);
 				if ((res == CURLE_OK) &&
 					(pContentType != NULL))
 				{
-					if (strstr(pContentType, "html") != NULL)
-					{
-						pDocument = new HtmlDocument(docInfo);
-					}
-					else
-					{
-						pDocument = new Document(docInfo);
-					}
-
-					// ...and copy the content into it
-					pDocument->setData(pContentInfo->m_pContent, pContentInfo->m_contentLen);
-					pDocument->setLocation(url);
 					pDocument->setType(pContentType);
+				}
 
 #ifdef DEBUG
-					cout << "CurlDownloader::retrieveUrl: document size is " << pContentInfo->m_contentLen << endl;
+				cout << "CurlDownloader::retrieveUrl: document size is " << pContentInfo->m_contentLen << endl;
 #endif
-				}
 			}
 		}
 
+		if (pContentInfo->m_pContent != NULL)
+		{
+			free(pContentInfo->m_pContent);
+		}
 		delete pContentInfo;
 
 		// Cleanup

Modified: trunk/Collect/FileCollector.cpp
===================================================================
--- trunk/Collect/FileCollector.cpp	2006-05-30 12:39:56 UTC (rev 277)
+++ trunk/Collect/FileCollector.cpp	2006-05-30 12:41:33 UTC (rev 278)
@@ -17,7 +17,6 @@
 #include <iostream>
 #include <algorithm>
 
-#include "HtmlDocument.h"
 #include "HtmlTokenizer.h"
 #include "MIMEScanner.h"
 #include "Url.h"
@@ -41,7 +40,6 @@
 /// Retrieves the specified document; NULL if error.
 Document *FileCollector::retrieveUrl(const DocumentInfo &docInfo)
 {
-	Document *pDocument = NULL;
 	Url thisUrl(docInfo.getLocation());
 	string protocol = thisUrl.getProtocol();
 
@@ -57,19 +55,10 @@
 	fileLocation += "/";
 	fileLocation += fileName;
 
-	// Determine the file type
-	string fileType = MIMEScanner::scanFile(fileLocation);
-	// Is it an HTML type ?
-	if (fileType.find("html") != string::npos)
-	{
-		pDocument = new HtmlDocument(docInfo);
-	}
-	else
-	{
-		pDocument = new Document(docInfo);
-	}
+	Document *pDocument = new Document(docInfo);
 
-	pDocument->setType(fileType);
+	// Determine the file type
+	pDocument->setType(MIMEScanner::scanFile(fileLocation));
 	if (pDocument->setDataFromFile(fileLocation) == false)
 	{
 		delete pDocument;

Modified: trunk/Collect/NeonDownloader.cpp
===================================================================
--- trunk/Collect/NeonDownloader.cpp	2006-05-30 12:39:56 UTC (rev 277)
+++ trunk/Collect/NeonDownloader.cpp	2006-05-30 12:41:33 UTC (rev 278)
@@ -25,7 +25,6 @@
 #include <neon/ne_request.h>
 
 #include "HtmlTokenizer.h"
-#include "HtmlDocument.h"
 #include "Url.h"
 #include "NeonDownloader.h"
 
@@ -351,17 +350,8 @@
 	{
 		if (statusCode < 400)
 		{
-			// Is it an HTML type ?
-			if (g_contentTypeHeaderValue.find("html") != string::npos)
-			{
-				pDocument = new HtmlDocument(docInfo);
-			}
-			else
-			{
-				pDocument = new Document(docInfo);
-			}
-
-			// ...and copy the content into it
+			// Copy the document content
+			pDocument = new Document(docInfo);
 			pDocument->setData(pContent, contentLen);
 			pDocument->setLocation(url);
 			pDocument->setType(g_contentTypeHeaderValue);

Modified: trunk/Collect/pinot-collect.cpp
===================================================================
--- trunk/Collect/pinot-collect.cpp	2006-05-30 12:39:56 UTC (rev 277)
+++ trunk/Collect/pinot-collect.cpp	2006-05-30 12:41:33 UTC (rev 278)
@@ -99,23 +99,23 @@
 	unsigned int urlContentLen;
 	string contentType;
 	DocumentInfo docInfo("Test", url, "", "");
-	Document *urlDoc = myDownloader->retrieveUrl(docInfo);
-	if (urlDoc == NULL)
+	Document *pDoc = myDownloader->retrieveUrl(docInfo);
+	if (pDoc == NULL)
 	{
 		cerr << "Download operation failed !" << endl;
 	}
 	else
 	{
-		cout << "Document type is " << urlDoc->getType() << endl;
+		cout << "Type: " << pDoc->getType() << endl;
 
-		unsigned int urlContentLen;
-		const char *urlContent = urlDoc->getData(urlContentLen);
+		unsigned int contentLen;
+		const char *pContent = pDoc->getData(contentLen);
 
-		if ((urlContent != NULL) &&
-			(urlContentLen > 0))
+		if ((pContent != NULL) &&
+			(contentLen > 0))
 		{
-			// Save the content to a file
-			string fileName = thisUrl.getFile();
+			string fileName(thisUrl.getFile());
+
 			if (fileName.empty() == true)
 			{
 				fileName = "index.html";
@@ -123,8 +123,9 @@
 
 			cout << "Saving " << urlContentLen << " bytes to " << fileName << endl;
 
+			// Save the content to a file
 			ofstream outputFile(fileName.c_str());
-			outputFile.write(urlContent, urlContentLen);
+			outputFile.write(pContent, contentLen);
 			outputFile.close();
 		}
 		else
@@ -132,7 +133,7 @@
 			cout << "Document is empty" << endl;
 		}
 
-		delete urlDoc;
+		delete pDoc;
 	}
 
 	delete myDownloader;



From fabricecolin at berlios.de  Tue May 30 14:42:59 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 30 May 2006 14:42:59 +0200
Subject: [Pinot-svn] r279 - trunk/Search
Message-ID: <200605301242.k4UCgxPp030810@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-30 14:42:56 +0200 (Tue, 30 May 2006)
New Revision: 279

Modified:
   trunk/Search/SherlockParser.cpp
   trunk/Search/pinot-search.cpp
Log:
Synced with changes to Htmltokenizer and Link classes.
The stripTags method is now in XmlTokenizer.


Modified: trunk/Search/SherlockParser.cpp
===================================================================
--- trunk/Search/SherlockParser.cpp	2006-05-30 12:41:33 UTC (rev 278)
+++ trunk/Search/SherlockParser.cpp	2006-05-30 12:42:56 UTC (rev 279)
@@ -24,6 +24,7 @@
 #include "StringManip.h"
 #include "Url.h"
 #include "HtmlTokenizer.h"
+#include "XmlTokenizer.h"
 #include "FileCollector.h"
 #include "SherlockParser.h"
 
@@ -329,7 +330,10 @@
 			// The result's URL and title should be given by the first link
 			for (set<Link>::iterator linkIter = chunkLinks.begin(); linkIter != chunkLinks.end(); ++linkIter)
 			{
-				if (linkIter->m_pos == 0)
+#ifdef DEBUG
+				cout << "SherlockResponseParser::parse: checking link " << linkIter->m_index << endl;
+#endif
+				if (linkIter->m_index == 0)
 				{
 					url = linkIter->m_url;
 					name = linkIter->m_name;
@@ -337,21 +341,29 @@
 					cout << "SherlockResponseParser::parse: first link in chunk is "
 						<< url << endl;
 #endif
-					endOfFirstLink = linkIter->m_close;
+					endOfFirstLink = linkIter->m_endPos;
 				}
-				else if (linkIter->m_pos == 1)
+				else if (linkIter->m_index == 1)
 				{
-					startOfSecondLink = linkIter->m_open;
-					endOfSecondLink = linkIter->m_close;
+					startOfSecondLink = linkIter->m_startPos;
+					endOfSecondLink = linkIter->m_endPos;
 				}
-				else if (linkIter->m_pos == 2)
+				else if (linkIter->m_index == 2)
 				{
-					startOfThirdLink = linkIter->m_open;
+					startOfThirdLink = linkIter->m_startPos;
 				}
 			}
 
+			// Positions apply to text only
+			resultItem = XmlTokenizer::stripTags(resultItem);
+#ifdef DEBUG
+			cout << "SherlockResponseParser::parse: tag-less chunk is \""
+				<< resultItem << "\"" << endl;
+#endif
+
 			// Chances are the extract is between the first two links
-			if (endOfFirstLink > 0)
+			if ((endOfFirstLink > 0) &&
+				(endOfFirstLink < resultItem.length()))
 			{
 				string extractWithMarkup1, extractWithMarkup2;
 				string extractCandidate1, extractCandidate2;
@@ -365,10 +377,11 @@
 				{
 					extractWithMarkup1 = resultItem.substr(endOfFirstLink);
 				}
-				extractCandidate1 = HtmlTokenizer::stripTags(extractWithMarkup1);
+				extractCandidate1 = XmlTokenizer::stripTags(extractWithMarkup1);
 
 				// ... or between the second and third link :-)
-				if (endOfSecondLink > 0)
+				if ((endOfSecondLink > 0) &&
+					(endOfSecondLink < resultItem.length()))
 				{
 					if (startOfThirdLink > 0)
 					{
@@ -379,9 +392,9 @@
 						extractWithMarkup2 = resultItem.substr(endOfSecondLink);
 					}
 				}
-				extractCandidate2 = HtmlTokenizer::stripTags(extractWithMarkup2);
+				extractCandidate2 = XmlTokenizer::stripTags(extractWithMarkup2);
 
-				// It seems we can rely on length to determine which is the right one
+				// It seems we can rely on length to determine which is the best one
 				if (extractCandidate1.length() > extractCandidate2.length())
 				{
 					extract = extractCandidate1;
@@ -405,7 +418,7 @@
 
 				if (isBlank == true)
 				{
-					extract = HtmlTokenizer::stripTags(resultItem);
+					extract = resultItem;
 				}
 			}
 		}

Modified: trunk/Search/pinot-search.cpp
===================================================================
--- trunk/Search/pinot-search.cpp	2006-05-30 12:41:33 UTC (rev 278)
+++ trunk/Search/pinot-search.cpp	2006-05-30 12:42:56 UTC (rev 279)
@@ -24,7 +24,6 @@
 #include "SearchEngineFactory.h"
 #include "DownloaderFactory.h"
 #include "Url.h"
-#include "HtmlTokenizer.h"
 #include "config.h"
 
 using namespace std;
@@ -121,16 +120,16 @@
 			vector<Result>::const_iterator resultIter = resultsList.begin();
 			while (resultIter != resultsList.end())
 			{
-				string rawUrl = (*resultIter).getLocation();
+				string rawUrl(resultIter->getLocation());
 				Url thisUrl(rawUrl);
 
 				cout << count << " Raw URL  : '" << rawUrl << "'"<< endl;
 				cout << count << " Protocol : " << thisUrl.getProtocol() << endl;
 				cout << count << " Host     : " << thisUrl.getHost() << endl;
 				cout << count << " Location : " << thisUrl.getLocation() << "/" << thisUrl.getFile() << endl;
-				cout << count << " Title    : " << HtmlTokenizer::stripTags((*resultIter).getTitle()) << endl;
-				cout << count << " Extract  : " << HtmlTokenizer::stripTags((*resultIter).getExtract()) << endl;
-				cout << count << " Score    : " << (*resultIter).getScore() << endl;
+				cout << count << " Title    : " << resultIter->getTitle() << endl;
+				cout << count << " Extract  : " << resultIter->getExtract() << endl;
+				cout << count << " Score    : " << resultIter->getScore() << endl;
 				count++;
 
 				// Next



From fabricecolin at berlios.de  Tue May 30 14:44:56 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 30 May 2006 14:44:56 +0200
Subject: [Pinot-svn] r280 - in trunk/UI/GTK2: . src
Message-ID: <200605301244.k4UCiuDv031508@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-30 14:44:50 +0200 (Tue, 30 May 2006)
New Revision: 280

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/UI/GTK2/src/importDialog_glade.cc
   trunk/UI/GTK2/src/importDialog_glade.hh
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Removed not so useful MIME type filtering in importDialog.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-05-30 12:42:56 UTC (rev 279)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-05-30 12:44:50 UTC (rev 280)
@@ -3659,37 +3659,6 @@
 	  </child>
 
 	  <child>
-	    <widget class="GtkScrolledWindow" id="mimeScrolledwindow">
-	      <property name="visible">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="hscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
-	      <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
-	      <property name="shadow_type">GTK_SHADOW_IN</property>
-	      <property name="window_placement">GTK_CORNER_TOP_LEFT</property>
-
-	      <child>
-		<widget class="GtkTreeView" id="mimeTreeview">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="headers_visible">True</property>
-		  <property name="rules_hint">False</property>
-		  <property name="reorderable">False</property>
-		  <property name="enable_search">True</property>
-		  <property name="fixed_height_mode">False</property>
-		  <property name="hover_selection">False</property>
-		  <property name="hover_expand">False</property>
-		</widget>
-	      </child>
-	    </widget>
-	    <packing>
-	      <property name="padding">4</property>
-	      <property name="expand">True</property>
-	      <property name="fill">True</property>
-	    </packing>
-	  </child>
-
-	  <child>
 	    <widget class="GtkHBox" id="importHbox">
 	      <property name="visible">True</property>
 	      <property name="homogeneous">False</property>
@@ -3793,7 +3762,7 @@
 	      </child>
 	    </widget>
 	    <packing>
-	      <property name="padding">0</property>
+	      <property name="padding">4</property>
 	      <property name="expand">False</property>
 	      <property name="fill">True</property>
 	    </packing>

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-05-30 12:42:56 UTC (rev 279)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-05-30 12:44:50 UTC (rev 280)
@@ -49,8 +49,7 @@
 {
 }
 
-importDialog::importDialog(const Glib::ustring &title,
-	const set<string> &mimeTypes) :
+importDialog::importDialog(const Glib::ustring &title) :
 	importDialog_glade(),
 	m_docsCount(0),
 	m_importDirectory(false),
@@ -59,10 +58,6 @@
 {
 	set_title(title);
 
-	// Copy the list of authorized MIME types
-	copy(mimeTypes.begin(), mimeTypes.end(),
-		inserter(m_mimeTypes, m_mimeTypes.begin()));
-
 	// Initialize the default directory
 	if (m_state.m_defaultDirectory.empty() == true)
 	{
@@ -89,16 +84,6 @@
 	depthSpinbutton->set_sensitive(false);
 	depthSpinbutton->set_value(1);
 
-	// Associate the columns model to the MIME types tree
-	m_refMimeTypeList = ListStore::create(m_mimeTypeColumns);
-	mimeTreeview->set_model(m_refMimeTypeList);
-	mimeTreeview->append_column_editable(_("Enabled"), m_mimeTypeColumns.m_enabled);
-	mimeTreeview->append_column(_("MIME Type"), m_mimeTypeColumns.m_type);
-	// Allow only single selection
-	mimeTreeview->get_selection()->set_mode(SELECTION_SINGLE);
-	// Populate
-	populate_mimeTreeview();
-
 	// Connect to threads' finished signal
 	m_state.connect();
 
@@ -148,20 +133,6 @@
 	}
 }
 
-void importDialog::populate_mimeTreeview(void)
-{
-	// Add all MIME types
-	for (set<string>::const_iterator typeIter = m_mimeTypes.begin();
-		typeIter != m_mimeTypes.end(); ++typeIter)
-	{
-		TreeModel::iterator iter = m_refMimeTypeList->append();
-		TreeModel::Row row = *iter;
-
-		row[m_mimeTypeColumns.m_enabled] = true;
-		row[m_mimeTypeColumns.m_type] = to_utf8(*typeIter);
-	}
-}
-
 bool importDialog::start_thread(WorkerThread *pNewThread)
 {
 	if (m_state.start_thread(pNewThread, false) == false)
@@ -198,62 +169,42 @@
 bool importDialog::on_import_url(const string &location)
 {
 	Url urlObj(location);
-	string mimeType(MIMEScanner::scanUrl(urlObj));
-	bool askForAnotherFile = false;
 
-#ifdef DEBUG
-	cout << "importDialog::on_import_url: file type is " << mimeType << endl;
-#endif
-	// Check the MIME type
-	if ((m_mimeTypesBlackList.find(mimeType) != m_mimeTypesBlackList.end()) ||
-		((m_mimeTypes.find(mimeType) == m_mimeTypes.end()) &&
-		((strncasecmp(mimeType.c_str(), "text/x-", 7) == 0) ||
-		(strncasecmp(mimeType.c_str(), "text", 4) != 0))))
+	XapianIndex index(PinotSettings::getInstance().m_indexLocation);
+	IndexingThread *pThread = NULL;
+	string title = from_utf8(m_title);
+	unsigned int docId = 0;
+
+	if (index.isGood() == true)
 	{
-#ifdef DEBUG
-		cout << "importDialog::on_import_url: filtering out" << endl;
-#endif
-		// It's black-listed, or not authorized and not plain-ish text
-		askForAnotherFile = true;
+		docId = index.hasDocument(location);
 	}
-	else
-	{
-		XapianIndex index(PinotSettings::getInstance().m_indexLocation);
-		IndexingThread *pThread = NULL;
-		string title = from_utf8(m_title);
-		unsigned int docId = 0;
 
-		if (index.isGood() == true)
+	if (m_importDirectory == true)
+	{
+		if (title.empty() == false)
 		{
-			docId = index.hasDocument(location);
+			title += " ";
 		}
+		title += urlObj.getFile();
+	}
+	DocumentInfo docInfo(title, location, MIMEScanner::scanUrl(urlObj), "");
 
-		if (m_importDirectory == true)
-		{
-			if (title.empty() == false)
-			{
-				title += " ";
-			}
-			title += urlObj.getFile();
-		}
-		DocumentInfo docInfo(title, location, mimeType, "");
-
-		if (docId > 0)
-		{
-			// This document needs updating
-			index.getDocumentInfo(docId, docInfo);
-			pThread = new IndexingThread(docInfo, m_labelName, docId);
-		}
-		else
-		{
-			pThread = new IndexingThread(docInfo, m_labelName);
-		}
-
-		// Launch the new thread
-		start_thread(pThread);
+	if (docId > 0)
+	{
+		// This document needs updating
+		index.getDocumentInfo(docId, docInfo);
+		pThread = new IndexingThread(docInfo, m_labelName, docId);
 	}
+	else
+	{
+		pThread = new IndexingThread(docInfo, m_labelName);
+	}
 
-	return askForAnotherFile;
+	// Launch the new thread
+	start_thread(pThread);
+
+	return false;
 }
 
 void importDialog::on_thread_end(WorkerThread *pThread)
@@ -331,25 +282,6 @@
 	}
 }
 
-void importDialog::setHeight(int maxHeight)
-{
-	// FIXME: there must be a better way to determine how high the tree should be
-	// for all rows to be visible !
-	int rowsCount = m_refTypeList->children().size();
-	// By default, the tree is high enough for one row
-	if (rowsCount > 1)
-	{
-		int width, height;
-
-		// What's the current size ?
-		get_size(width, height);
-		// Add enough room for the rows we need to show
-		height += get_column_height(mimeTreeview) * (rowsCount - 1);
-		// Resize
-		resize(width, min(maxHeight, height));
-	}
-}
-
 unsigned int importDialog::getDocumentsCount(void)
 {
 	return m_docsCount;
@@ -462,34 +394,6 @@
 	// Disable the import button
 	importButton->set_sensitive(false);
 
-	// Update the list of MIME types, based on list selection
-	m_mimeTypes.clear();
-	m_mimeTypesBlackList.clear();
-	TreeModel::Children children = m_refMimeTypeList->children();
-	if (children.empty() == false)
-	{
-		for (TreeModel::Children::iterator iter = children.begin();
-			iter != children.end(); ++iter)
-		{
-			TreeModel::Row row = *iter;
-			string mimeType(from_utf8(row[m_mimeTypeColumns.m_type]));
-			bool enabled = row[m_mimeTypeColumns.m_enabled];
-
-			if (enabled == true)
-			{
-				m_mimeTypes.insert(mimeType);
-			}
-			else
-			{
-				m_mimeTypesBlackList.insert(mimeType);
-			}
-		}
-	}
-#ifdef DEBUG
-	cout << "importDialog::on_importButton_clicked: " << m_mimeTypes.size()
-		<< " types, " << m_mimeTypesBlackList.size() << " in blacklist" << endl;
-#endif
-
 	m_timeoutConnection = Glib::signal_timeout().connect(SigC::slot(*this,
 		&importDialog::on_activity_timeout), 1000);
 

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2006-05-30 12:42:56 UTC (rev 279)
+++ trunk/UI/GTK2/src/importDialog.hh	2006-05-30 12:44:50 UTC (rev 280)
@@ -35,8 +35,7 @@
 {  
 public:
 	/// Open the dialog box in import mode.
-	importDialog(const Glib::ustring &title,
-		const std::set<std::string> &mimeTypes);
+	importDialog(const Glib::ustring &title);
 	virtual ~importDialog();
 
 	void setHeight(int maxHeight);
@@ -45,7 +44,6 @@
 
 protected:
 	void populate_comboboxes(bool localOnly);
-	void populate_mimeTreeview(void);
 	bool start_thread(WorkerThread *pNewThread);
 	void signal_scanner(void);
 
@@ -54,8 +52,6 @@
 	void on_thread_end(WorkerThread *pThread);
 
 private:
-	std::set<std::string> m_mimeTypes;
-	std::set<std::string> m_mimeTypesBlackList;
 	// Type
 	ComboModelColumns m_typeColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refTypeList;
@@ -66,9 +62,6 @@
 	std::string m_labelName;
 	unsigned int m_docsCount;
 	bool m_importDirectory;
-	// MIME types
-	TypeModelColumns m_mimeTypeColumns;
-	Glib::RefPtr<Gtk::ListStore> m_refMimeTypeList;
 	// Directory scanner
 	DirectoryScannerThread *m_pScannerThread;
 	// Activity timeout

Modified: trunk/UI/GTK2/src/importDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.cc	2006-05-30 12:42:56 UTC (rev 279)
+++ trunk/UI/GTK2/src/importDialog_glade.cc	2006-05-30 12:44:50 UTC (rev 280)
@@ -1,9 +1,9 @@
-// generated 2006/1/20 22:51:42 SGT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0
+// generated 2006/5/27 14:34:17 SGT by fabrice at amra.dyndns.org.(none)
+// using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.6.10 and gtkmm 2.6.2
+// for gtk 2.8.17 and gtkmm 2.8.3
 //
 // Please modify the corresponding derived classes in ./src/importDialog.cc
 
@@ -25,18 +25,11 @@
 #  else
 #    define N_(String) (String)
 #  endif
-#else
-#  define textdomain(String) (String)
-#  define gettext(String) (String)
-#  define dgettext(Domain,Message) (Message)
-#  define dcgettext(Domain,Message,Type) (Message)
-#  define bindtextdomain(Domain,Directory) (Domain)
-#  define _(String) (String)
-#  define N_(String) (String)
 #endif
 #include <gtkmmconfig.h>
 #if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
 #include <sigc++/compatibility.h>
+#include <sigc++/bind.h>
 #define GMM_GTKMM_22_24(a,b) b
 #else //gtkmm 2.2
 #define GMM_GTKMM_22_24(a,b) a
@@ -49,10 +42,19 @@
 #include <gtkmm/label.h>
 #include <gtkmm/box.h>
 #include <gtkmm/adjustment.h>
-#include <gtkmm/scrolledwindow.h>
 #include <gtkmm/image.h>
 #include <gtkmm/alignment.h>
+#ifndef ENABLE_NLS
+#  define textdomain(String) (String)
+#  define gettext(String) (String)
+#  define dgettext(Domain,Message) (Message)
+#  define dcgettext(Domain,Message,Type) (Message)
+#  define bindtextdomain(Domain,Directory) (Domain)
+#  define _(String) (String)
+#  define N_(String) (String)
+#endif
 
+
 importDialog_glade::importDialog_glade(
 )
 {  
@@ -82,9 +84,6 @@
    
    Gtk::Label *labelNameLabel = Gtk::manage(new class Gtk::Label(_("Apply label:")));
    docTable = Gtk::manage(new class Gtk::Table(2, 2, false));
-   mimeTreeview = Gtk::manage(new class Gtk::TreeView());
-   
-   Gtk::ScrolledWindow *mimeScrolledwindow = Gtk::manage(new class Gtk::ScrolledWindow());
    importProgressbar = Gtk::manage(new class Gtk::ProgressBar());
    
    Gtk::Image *image575 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(4)));
@@ -175,16 +174,6 @@
    docTable->attach(*linksCheckbutton, 1, 2, 4, 5, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable->attach(*labelNameCombobox, 1, 2, 5, 6, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable->attach(*labelNameLabel, 0, 1, 5, 6, Gtk::FILL, Gtk::AttachOptions(), 0, 0);
-   mimeTreeview->set_flags(Gtk::CAN_FOCUS);
-   mimeTreeview->set_headers_visible(true);
-   mimeTreeview->set_rules_hint(false);
-   mimeTreeview->set_reorderable(false);
-   mimeTreeview->set_enable_search(true);
-   mimeScrolledwindow->set_flags(Gtk::CAN_FOCUS);
-   mimeScrolledwindow->set_shadow_type(Gtk::SHADOW_IN);
-   mimeScrolledwindow->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
-   mimeScrolledwindow->property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
-   mimeScrolledwindow->add(*mimeTreeview);
    image575->set_alignment(0.5,0.5);
    image575->set_padding(0,0);
    label55->set_alignment(0.5,0.5);
@@ -203,8 +192,7 @@
    importHbox->pack_start(*importProgressbar);
    importHbox->pack_start(*importButton, Gtk::PACK_SHRINK, 0);
    importVbox->pack_start(*docTable, Gtk::PACK_SHRINK, 0);
-   importVbox->pack_start(*mimeScrolledwindow, Gtk::PACK_EXPAND_WIDGET, 4);
-   importVbox->pack_start(*importHbox, Gtk::PACK_SHRINK, 0);
+   importVbox->pack_start(*importHbox, Gtk::PACK_SHRINK, 4);
    importDialog->get_vbox()->set_homogeneous(false);
    importDialog->get_vbox()->set_spacing(0);
    importDialog->get_vbox()->pack_start(*importVbox);
@@ -231,8 +219,6 @@
    labelNameCombobox->show();
    labelNameLabel->show();
    docTable->show();
-   mimeTreeview->show();
-   mimeScrolledwindow->show();
    importProgressbar->show();
    image575->show();
    label55->show();

Modified: trunk/UI/GTK2/src/importDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.hh	2006-05-30 12:42:56 UTC (rev 279)
+++ trunk/UI/GTK2/src/importDialog_glade.hh	2006-05-30 12:44:50 UTC (rev 280)
@@ -1,9 +1,9 @@
-// generated 2006/1/20 22:51:42 SGT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0
+// generated 2006/5/27 14:34:17 SGT by fabrice at amra.dyndns.org.(none)
+// using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.6.10 and gtkmm 2.6.2
+// for gtk 2.8.17 and gtkmm 2.8.3
 //
 // Please modify the corresponding derived classes in ./src/importDialog.hh and./src/importDialog.cc
 
@@ -39,7 +39,6 @@
 #include <gtkmm/spinbutton.h>
 #include <gtkmm/checkbutton.h>
 #include <gtkmm/table.h>
-#include <gtkmm/treeview.h>
 #include <gtkmm/progressbar.h>
 
 class importDialog_glade : public Gtk::Dialog
@@ -56,7 +55,6 @@
         class Gtk::CheckButton * linksCheckbutton;
         class Gtk::ComboBox * labelNameCombobox;
         class Gtk::Table * docTable;
-        class Gtk::TreeView * mimeTreeview;
         class Gtk::ProgressBar * importProgressbar;
         class Gtk::Button * importButton;
         

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-05-30 12:42:56 UTC (rev 279)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-05-30 12:44:50 UTC (rev 280)
@@ -1682,16 +1682,9 @@
 //
 void mainWindow::on_import_activate()
 {
-	set<string> mimeTypes;
-	int width, height;
-
-	TokenizerFactory::getSupportedTypes(mimeTypes);
-	get_size(width, height);
-
 	m_state.disconnect();
 
-	importDialog importBox(_("Import Document(s)"), mimeTypes);
-	importBox.setHeight(height / 2);
+	importDialog importBox(_("Import Document(s)"));
 	importBox.show();
 	importBox.run();
 



From fabricecolin at berlios.de  Tue May 30 14:46:44 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 30 May 2006 14:46:44 +0200
Subject: [Pinot-svn] r281 - trunk/UI/GTK2/src
Message-ID: <200605301246.k4UCkiuF032451@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-30 14:46:42 +0200 (Tue, 30 May 2006)
New Revision: 281

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
Log:
XmlTokenizer::stripTags() replaces HtmlTokenizer::stripTags().


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-30 12:44:50 UTC (rev 280)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-05-30 12:46:42 UTC (rev 281)
@@ -29,6 +29,7 @@
 #include <sigc++/class_slot.h>
 
 #include "HtmlTokenizer.h"
+#include "XmlTokenizer.h"
 #include "MIMEScanner.h"
 #include "TokenizerFactory.h"
 #include "StringManip.h"
@@ -578,14 +579,17 @@
 			resultIter != resultsList.end(); ++resultIter)
 		{
 			string title(_("No title"));
-			string extract(HtmlTokenizer::stripTags(resultIter->getExtract()));
+			string extract(XmlTokenizer::stripTags(resultIter->getExtract()));
 			string language(resultIter->getLanguage());
 
 			// The title may contain formatting
 			if (resultIter->getTitle().empty() == false)
 			{
-				title = HtmlTokenizer::stripTags(resultIter->getTitle());
+				title = XmlTokenizer::stripTags(resultIter->getTitle());
 			}
+#ifdef DEBUG
+			cout << "QueryingThread::doWork: title is " << title << endl;
+#endif
 
 			// Use the query's language if the result's is unknown
 			if (language.empty() == true)



From fabricecolin at berlios.de  Wed May 31 16:56:31 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 31 May 2006 16:56:31 +0200
Subject: [Pinot-svn] r282 - in trunk: Collect Search Utils
Message-ID: <200605311456.k4VEuVp2023756@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-31 16:56:30 +0200 (Wed, 31 May 2006)
New Revision: 282

Modified:
   trunk/Collect/CurlDownloader.cpp
   trunk/Search/SearchEngineInterface.cpp
   trunk/Utils/StringManip.cpp
   trunk/Utils/StringManip.h
Log:
Less verbose CurlDownloader. Added StringManip::trimSpaces().


Modified: trunk/Collect/CurlDownloader.cpp
===================================================================
--- trunk/Collect/CurlDownloader.cpp	2006-05-30 12:46:42 UTC (rev 281)
+++ trunk/Collect/CurlDownloader.cpp	2006-05-31 14:56:30 UTC (rev 282)
@@ -66,9 +66,6 @@
 	memcpy(pInfo->m_pContent + pInfo->m_contentLen, pData, totalSize);
 	pInfo->m_contentLen += totalSize;
 	pInfo->m_pContent[pInfo->m_contentLen] = '\0';
-#ifdef DEBUG
-	cout << "writeCallback: copied " << totalSize << " bytes into buffer" << endl;
-#endif
 
 	return totalSize;
 }

Modified: trunk/Search/SearchEngineInterface.cpp
===================================================================
--- trunk/Search/SearchEngineInterface.cpp	2006-05-30 12:46:42 UTC (rev 281)
+++ trunk/Search/SearchEngineInterface.cpp	2006-05-31 14:56:30 UTC (rev 282)
@@ -16,6 +16,7 @@
 
 #include <iostream>
 
+#include "StringManip.h"
 #include "Url.h"
 #include "SearchEngineInterface.h"
 
@@ -165,25 +166,11 @@
 #endif
 	}
 
-	// Remove trailing spaces at the end of the URL
+	// Trim spaces
 	string trimmedUrl(resultUrl);
-	string::size_type pos = trimmedUrl.find_last_of(" ");
-	while (pos != string::npos)
-	{
-		int len = trimmedUrl.length();
-#ifdef DEBUG
-		cout << "SearchEngineInterface::processResult: trimming space at " << pos << endl;
-#endif
-		if (pos == len - 1)
-		{
-			trimmedUrl.resize(pos);
-			pos = trimmedUrl.find_last_of(" ");
-		}
-		else
-		{
-			break;
-		}
-	}
+	StringManip::trimSpaces(trimmedUrl);
+
+	// Return a canonical form
 	resultUrl = Url::canonicalizeUrl(trimmedUrl);
 
 	return true;

Modified: trunk/Utils/StringManip.cpp
===================================================================
--- trunk/Utils/StringManip.cpp	2006-05-30 12:46:42 UTC (rev 281)
+++ trunk/Utils/StringManip.cpp	2006-05-31 14:56:30 UTC (rev 282)
@@ -195,6 +195,38 @@
 	return count;	
 }
 
+/// Trims spaces at the start and end of a string.
+unsigned int StringManip::trimSpaces(string &str)
+{
+	unsigned int count = 0;
+
+	for (unsigned int pos = 0;
+		(str.empty() == false) && (pos < str.length()); ++pos)
+	{
+		if (isspace(str[pos]) == 0)
+		{
+			break;
+		}
+
+		str.erase(pos);
+		++count;
+	}
+
+	for (unsigned int pos = str.length() - 1;
+		(str.empty() == false) && (pos >= 0); --pos)
+	{
+		if (isspace(str[pos]) == 0)
+		{
+			break;
+		}
+
+		str.erase(pos);
+		++count;
+	}
+
+	return count;
+}
+
 /// Removes double and single quotes in links or any other attribute.
 string StringManip::removeQuotes(const string &str)
 {

Modified: trunk/Utils/StringManip.h
===================================================================
--- trunk/Utils/StringManip.h	2006-05-30 12:46:42 UTC (rev 281)
+++ trunk/Utils/StringManip.h	2006-05-31 14:56:30 UTC (rev 282)
@@ -46,6 +46,9 @@
 		/// Removes double and single quotes.
 		static std::string removeQuotes(const std::string &str);
 
+		/// Trims spaces at the start and end of a string.
+		static unsigned int trimSpaces(std::string &str);
+
 		/// Hashes a string.
 		static std::string hashString(const std::string &str);
 



From fabricecolin at berlios.de  Wed May 31 18:11:25 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 31 May 2006 18:11:25 +0200
Subject: [Pinot-svn] r283 - in trunk: Search Tokenize
Message-ID: <200605311611.k4VGBPZB011628@sheep.berlios.de>

Author: fabricecolin
Date: 2006-05-31 18:11:24 +0200 (Wed, 31 May 2006)
New Revision: 283

Modified:
   trunk/Search/SherlockParser.cpp
   trunk/Tokenize/HtmlTokenizer.cpp
   trunk/Tokenize/HtmlTokenizer.h
   trunk/Tokenize/XmlTokenizer.cpp
Log:
HtmlTokenizer can attempt to find an abstract, basically the text between links.
Some other changes.


Modified: trunk/Search/SherlockParser.cpp
===================================================================
--- trunk/Search/SherlockParser.cpp	2006-05-31 14:56:30 UTC (rev 282)
+++ trunk/Search/SherlockParser.cpp	2006-05-31 16:11:24 UTC (rev 283)
@@ -323,16 +323,13 @@
 		{
 			Document chunkDoc("", "", contentType, "");
 			chunkDoc.setData(resultItem.c_str(), resultItem.length());
-			HtmlTokenizer chunkTokens(&chunkDoc);
+			HtmlTokenizer chunkTokens(&chunkDoc, true);
 			set<Link> &chunkLinks = chunkTokens.getLinks();
 			unsigned int endOfFirstLink = 0, startOfSecondLink = 0, endOfSecondLink = 0, startOfThirdLink = 0;
 
 			// The result's URL and title should be given by the first link
 			for (set<Link>::iterator linkIter = chunkLinks.begin(); linkIter != chunkLinks.end(); ++linkIter)
 			{
-#ifdef DEBUG
-				cout << "SherlockResponseParser::parse: checking link " << linkIter->m_index << endl;
-#endif
 				if (linkIter->m_index == 0)
 				{
 					url = linkIter->m_url;
@@ -354,72 +351,11 @@
 				}
 			}
 
-			// Positions apply to text only
-			resultItem = XmlTokenizer::stripTags(resultItem);
-#ifdef DEBUG
-			cout << "SherlockResponseParser::parse: tag-less chunk is \""
-				<< resultItem << "\"" << endl;
-#endif
-
-			// Chances are the extract is between the first two links
-			if ((endOfFirstLink > 0) &&
-				(endOfFirstLink < resultItem.length()))
+			extract = chunkTokens.getAbstract();
+			if (extract.empty() == true)
 			{
-				string extractWithMarkup1, extractWithMarkup2;
-				string extractCandidate1, extractCandidate2;
-				bool isBlank = true;
-
-				if (startOfSecondLink > 0)
-				{
-					extractWithMarkup1 = resultItem.substr(endOfFirstLink, startOfSecondLink - endOfFirstLink);
-				}
-				else
-				{
-					extractWithMarkup1 = resultItem.substr(endOfFirstLink);
-				}
-				extractCandidate1 = XmlTokenizer::stripTags(extractWithMarkup1);
-
-				// ... or between the second and third link :-)
-				if ((endOfSecondLink > 0) &&
-					(endOfSecondLink < resultItem.length()))
-				{
-					if (startOfThirdLink > 0)
-					{
-						extractWithMarkup2 = resultItem.substr(endOfSecondLink, startOfThirdLink - endOfSecondLink);
-					}
-					else
-					{
-						extractWithMarkup2 = resultItem.substr(endOfSecondLink);
-					}
-				}
-				extractCandidate2 = XmlTokenizer::stripTags(extractWithMarkup2);
-
-				// It seems we can rely on length to determine which is the best one
-				if (extractCandidate1.length() > extractCandidate2.length())
-				{
-					extract = extractCandidate1;
-				}
-				else
-				{
-					extract = extractCandidate2;
-				}
-#ifdef DEBUG
-				cout << "SherlockResponseParser::parse: extract is \""
-					<< extract << "\"" << endl;
-#endif
-				for (string::size_type pos = 0; pos < extract.length(); ++pos)
-				{
-					if (isspace(extract[pos]) == 0)
-					{
-						isBlank = false;
-						break;
-					}
-				}
-
-				if (isBlank == true)
-				{
-					extract = resultItem;
-				}
+				extract = XmlTokenizer::stripTags(resultItem);
+				StringManip::trimSpaces(extract);
 			}
 		}
 		else

Modified: trunk/Tokenize/HtmlTokenizer.cpp
===================================================================
--- trunk/Tokenize/HtmlTokenizer.cpp	2006-05-31 14:56:30 UTC (rev 282)
+++ trunk/Tokenize/HtmlTokenizer.cpp	2006-05-31 16:11:24 UTC (rev 283)
@@ -32,60 +32,55 @@
 using std::map;
 using std::set;
 
-Link::Link() :
-	m_index(0),
-	m_startPos(0),
-	m_endPos(0)
+static bool getInBetweenLinksText(HtmlTokenizer::ParserState *pState,
+	unsigned int currentLinkIndex)
 {
-}
+	if (pState == NULL)
+	{
+		return false;
+	}
 
-Link::Link(const Link &other) :
-	m_url(other.m_url),
-	m_name(other.m_name),
-	m_index(other.m_index),
-	m_startPos(other.m_startPos),
-	m_endPos(other.m_endPos)
-{
-}
+	if ((pState->m_links.empty() == true) ||
+		(pState->m_currentLink.m_index == 0))
+	{
+		pState->m_abstract = pState->m_text;
 
-Link::~Link()
-{
-}
+		return true;
+	}
 
-Link& Link::operator=(const Link& other)
-{
-	m_url = other.m_url;
-	m_name = other.m_name;
-	m_index = other.m_index;
-	m_startPos = other.m_startPos;
-	m_endPos = other.m_endPos;
+	// Get the text between the current link and the previous one
+	for (set<Link>::const_iterator linkIter = pState->m_links.begin();
+		linkIter != pState->m_links.end(); ++linkIter)
+	{
+		// Is this the previous link ?
+		if (linkIter->m_index == currentLinkIndex - 1)
+		{
+			// Is there text in between ?
+			if (linkIter->m_endPos + 1 < pState->m_textPos)
+			{
+				unsigned int abstractLen = pState->m_textPos - linkIter->m_endPos - 1;
+				string abstract(pState->m_text.substr(linkIter->m_endPos, abstractLen));
 
-	return *this;
-}
+				StringManip::trimSpaces(abstract);
 
-bool Link::operator==(const Link &other) const
-{
-	return m_url == other.m_url;
-}
+				// The longer, the better
+				if (abstract.length() > pState->m_abstract.length())
+				{
+					pState->m_abstract = abstract;
+#ifdef DEBUG
+					cout << "HtmlTokenizer::getInBetweenLinksText: abstract after link "
+						<< linkIter->m_index << endl;
+#endif
 
-bool Link::operator<(const Link &other) const
-{
-	return m_index < other.m_index;
-}
+					return true;
+				}
+			}
 
-HtmlTokenizer::ParserState::ParserState() :
-	m_textPos(0),
-	m_inHead(false),
-	m_foundHead(false),
-	m_appendToTitle(false),
-	m_appendToText(false),
-	m_appendToLink(false),
-	m_skip(0)
-{
-}
+			break;
+		}
+	}
 
-HtmlTokenizer::ParserState::~ParserState()
-{
+	return false;
 }
 
 static void startHandler(void *pData, const char *pElementName, const char **pAttributes)
@@ -174,9 +169,15 @@
 			// FIXME: get the NodeInfo to find out the position of this link
 			pState->m_currentLink.m_startPos = pState->m_textPos;
 #ifdef DEBUG
-			cout << "HtmlTokenizer::startHandler: found link to " << pState->m_currentLink.m_url << endl;
+			cout << "HtmlTokenizer::parseHTML: link starts at position " << pState->m_textPos << endl;
 #endif
 
+			// Find abstract ?
+			if (pState->m_findAbstract == true)
+			{
+				getInBetweenLinksText(pState, pState->m_currentLink.m_index);
+			}
+
 			// Extract link
 			pState->m_appendToLink = true;
 		}
@@ -253,13 +254,13 @@
 		{
 			// FIXME: get the NodeInfo to find out the position of this link
 			pState->m_currentLink.m_endPos = pState->m_textPos;
-
+#ifdef DEBUG
+			cout << "HtmlTokenizer::parseHTML: link ends at position " << pState->m_textPos << endl;
+#endif
+				
 			// Store this link
 			pState->m_links.insert(pState->m_currentLink);
 			++pState->m_currentLink.m_index;
-#ifdef DEBUG
-			cout << "HtmlTokenizer::endHandler: link was " << pState->m_currentLink.m_name << endl;
-#endif
 		}
 
 		pState->m_appendToLink = false;
@@ -287,7 +288,6 @@
 		return;
 	}
 
-	pState->m_textPos += textLen;
 	if (pState->m_skip > 0)
 	{
 		// Skip this
@@ -302,9 +302,6 @@
 	if (pState->m_lastHash == textHash)
 	{
 		// Ignore this
-#ifdef DEBUG
-		cout << "HtmlTokenizer::charactersHandler: ignoring duplicate text" << endl;
-#endif
 		return;
 	}
 	pState->m_lastHash = textHash;
@@ -320,6 +317,7 @@
 		if (pState->m_appendToText == true)
 		{
 			pState->m_text += text;
+			pState->m_textPos += textLen;
 		}
 
 		// Appending to text and to link are not mutually exclusive operations
@@ -406,7 +404,64 @@
 	cerr << "HtmlTokenizer::warningHandler: " << pErr << endl;
 }
 
-HtmlTokenizer::HtmlTokenizer(const Document *pDocument, unsigned int linksStartAtPos) :
+Link::Link() :
+	m_index(0),
+	m_startPos(0),
+	m_endPos(0)
+{
+}
+
+Link::Link(const Link &other) :
+	m_url(other.m_url),
+	m_name(other.m_name),
+	m_index(other.m_index),
+	m_startPos(other.m_startPos),
+	m_endPos(other.m_endPos)
+{
+}
+
+Link::~Link()
+{
+}
+
+Link& Link::operator=(const Link& other)
+{
+	m_url = other.m_url;
+	m_name = other.m_name;
+	m_index = other.m_index;
+	m_startPos = other.m_startPos;
+	m_endPos = other.m_endPos;
+
+	return *this;
+}
+
+bool Link::operator==(const Link &other) const
+{
+	return m_url == other.m_url;
+}
+
+bool Link::operator<(const Link &other) const
+{
+	return m_index < other.m_index;
+}
+
+HtmlTokenizer::ParserState::ParserState() :
+	m_findAbstract(false),
+	m_textPos(0),
+	m_inHead(false),
+	m_foundHead(false),
+	m_appendToTitle(false),
+	m_appendToText(false),
+	m_appendToLink(false),
+	m_skip(0)
+{
+}
+
+HtmlTokenizer::ParserState::~ParserState()
+{
+}
+
+HtmlTokenizer::HtmlTokenizer(const Document *pDocument, bool findAbstract) :
 	Tokenizer(NULL)
 {
 	if (pDocument != NULL)
@@ -414,6 +469,9 @@
 		unsigned int length = 0;
 		const char *pData = pDocument->getData(length);
 
+		// Attempt to find an abstract ?
+		m_state.m_findAbstract = findAbstract;
+
 		if ((pData != NULL) &&
 			(length > 0) &&
 			(parseHTML(pData) == true))
@@ -427,6 +485,12 @@
 				m_state.m_title = pDocument->getTitle();
 			}
 
+			// The text after the last link might make a good abstract
+			if (m_state.m_findAbstract == true)
+			{
+				getInBetweenLinksText(&m_state, m_state.m_currentLink.m_index);
+			}
+
 			// Pass the result to the parent class
 			Document *pStrippedDoc = new Document(m_state.m_title,
 				pDocument->getLocation(), pDocument->getType(),
@@ -502,9 +566,6 @@
 		dummyHtml += htmlChunk;
 		dummyHtml += "</html>";
 		htmlChunk = dummyHtml;
-#ifdef DEBUG
-		cout << "HtmlTokenizer::parseHTML: wrapped input" << endl;
-#endif
 	}
 
 #ifndef _DONT_USE_PUSH_INTERFACE
@@ -536,7 +597,7 @@
 }
 
 /// Gets the specified META tag content.
-string HtmlTokenizer::getMetaTag(const string &name)
+string HtmlTokenizer::getMetaTag(const string &name) const
 {
 	if (name.empty() == true)
 	{
@@ -557,3 +618,9 @@
 {
 	return m_state.m_links;
 }
+
+/// Gets the abstract.
+std::string HtmlTokenizer::getAbstract(void) const
+{
+	return m_state.m_abstract;
+}

Modified: trunk/Tokenize/HtmlTokenizer.h
===================================================================
--- trunk/Tokenize/HtmlTokenizer.h	2006-05-31 14:56:30 UTC (rev 282)
+++ trunk/Tokenize/HtmlTokenizer.h	2006-05-31 16:11:24 UTC (rev 283)
@@ -47,21 +47,25 @@
 class HtmlTokenizer : public Tokenizer
 {
 	public:
-		HtmlTokenizer(const Document *pDocument, unsigned int linksStartAtPos = 0);
+		HtmlTokenizer(const Document *pDocument, bool findAbstract = false);
 		virtual ~HtmlTokenizer();
 
 		/// Gets the specified META tag content; an empty string if it wasn't found.
-		std::string getMetaTag(const std::string &name);
+		std::string getMetaTag(const std::string &name) const;
 
 		/// Gets the links map.
 		std::set<Link> &getLinks(void);
 
+		/// Gets the abstract.
+		std::string getAbstract(void) const;
+
 		class ParserState
 		{
 			public:
 				ParserState();
 				~ParserState();
 
+				bool m_findAbstract;
 				unsigned int m_textPos;
 				std::string m_lastHash;
 				bool m_inHead;
@@ -72,6 +76,7 @@
 				unsigned int m_skip;
 				std::string m_title;
 				std::string m_text;
+				std::string m_abstract;
 				Link m_currentLink;
 				std::set<Link> m_links;
 				std::set<Link> m_frames;

Modified: trunk/Tokenize/XmlTokenizer.cpp
===================================================================
--- trunk/Tokenize/XmlTokenizer.cpp	2006-05-31 14:56:30 UTC (rev 282)
+++ trunk/Tokenize/XmlTokenizer.cpp	2006-05-31 16:11:24 UTC (rev 283)
@@ -63,47 +63,37 @@
 /// Parses XML; the string without tags.
 string XmlTokenizer::parseXML(const string &str)
 {
-	string stripped;
-	string::size_type startPos = 0;
-	bool isXml = false, skip = false;
+	if (str.empty() == true)
+	{
+		return "";
+	}
 
+	string stripped(StringManip::replaceEntities(str));
+
 	// Tag start
-	string::size_type pos = str.find("<");
-	while (pos != string::npos)
+	string::size_type startPos = stripped.find("<");
+	while (startPos != string::npos)
 	{
-		isXml = true;
-
-		if (skip == false)
+		string::size_type endPos = stripped.find(">", startPos);
+		if (endPos != string::npos)
 		{
-			string text = str.substr(startPos, pos - startPos);
-
-			stripped += StringManip::replaceEntities(text);
-			stripped += " ";
-
-			startPos = pos + 1;
-			// Tag end
-			if (str[pos] == '<')
-			{
-				pos = str.find(">", startPos);
-			}
-			// Skip stuff in the tag
-			skip = true;
+			stripped.erase(startPos, endPos - startPos + 1);
 		}
-		else
-		{
-			startPos = pos + 1;
-			pos = str.find("<", startPos);
-			skip = false;
-		}
+
+		// Next
+		startPos = stripped.find("<");
 	}
-	if (startPos < str.length())
+
+	// The input may contain partial tags, eg "a>...</a><b>...</b>...<c"
+	string::size_type pos = stripped.find(">");
+	if (pos != string::npos)
 	{
-		stripped  += StringManip::replaceEntities(str.substr(startPos));
+		stripped.erase(0, pos + 1);
 	}
-
-	if (isXml == false)
+	pos = stripped.find("<");
+	if (pos != string::npos)
 	{
-		return str;
+		stripped.erase(pos);
 	}
 
 	return stripped;



