From fabricecolin at berlios.de  Sun Jan  1 19:13:12 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sun, 1 Jan 2006 19:13:12 +0100
Subject: [Pinot-svn] r44 - in trunk: Index Search UI/GTK2 UI/GTK2/src
Message-ID: <200601011813.k01IDCj0012731@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-01 19:13:07 +0100 (Sun, 01 Jan 2006)
New Revision: 44

Modified:
   trunk/Index/IndexInterface.h
   trunk/Index/XapianIndex.cpp
   trunk/Index/XapianIndex.h
   trunk/Search/XapianEngine.cpp
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/mainWindow_glade.cc
   trunk/UI/GTK2/src/mainWindow_glade.hh
Log:
Enabled completion on the query field, based on terms present in the documents
index.


Modified: trunk/Index/IndexInterface.h
===================================================================
--- trunk/Index/IndexInterface.h	2005-12-31 16:08:45 UTC (rev 43)
+++ trunk/Index/IndexInterface.h	2006-01-01 18:13:07 UTC (rev 44)
@@ -75,6 +75,9 @@
 		/// Unindexes documents with the given label.
 		virtual bool unindexDocuments(const std::string &labelName) = 0;
 
+		/// Suggests terms.
+		virtual unsigned int getCloseTerms(const std::string &term, std::set<std::string> &suggestions) = 0;
+
 		/// Renames a label.
 		virtual bool renameLabel(const std::string &name, const std::string &newName) = 0;
 

Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2005-12-31 16:08:45 UTC (rev 43)
+++ trunk/Index/XapianIndex.cpp	2006-01-01 18:13:07 UTC (rev 44)
@@ -837,6 +837,63 @@
 	return unindexed;
 }
 
+/// Suggests terms.
+unsigned int XapianIndex::getCloseTerms(const string &term, set<string> &suggestions)
+{
+	XapianDatabase *pDatabase = XapianDatabaseFactory::getDatabase(m_databaseName, false);
+	if (pDatabase == NULL)
+	{
+		cerr << "Bad index " << m_databaseName << endl;
+		return 0;
+	}
+
+	suggestions.clear();
+	try
+	{
+		Xapian::Database *pIndex = pDatabase->readLock();
+		if (pIndex != NULL)
+		{
+			Xapian::TermIterator termIter = pIndex->allterms_begin();
+
+			if (termIter != pIndex->allterms_end())
+			{
+				string baseTerm(StringManip::toLowerCase(term));
+				unsigned int count = 0;
+
+				// Get the next 10 terms
+				termIter.skip_to(baseTerm);
+				while ((termIter != pIndex->allterms_end()) &&
+					(count < 10))
+				{
+					string suggestedTerm(*termIter);
+
+					if (suggestedTerm.find(baseTerm) != 0)
+					{
+						// This term doesn't have the same root
+						break;
+					}
+					suggestions.insert(*termIter);
+
+					// Next
+					++count;
+					++termIter;
+				}
+			}
+		}
+		pDatabase->unlock();
+	}
+	catch (const Xapian::Error &error)
+	{
+		cerr << "Couldn't get terms: " << error.get_msg() << endl;
+	}
+	catch (...)
+	{
+		cerr << "Couldn't get terms, unknown exception occured" << endl;
+	}
+
+	return suggestions.size();
+}
+
 /// Renames a label.
 bool XapianIndex::renameLabel(const string &name, const string &newName)
 {

Modified: trunk/Index/XapianIndex.h
===================================================================
--- trunk/Index/XapianIndex.h	2005-12-31 16:08:45 UTC (rev 43)
+++ trunk/Index/XapianIndex.h	2006-01-01 18:13:07 UTC (rev 44)
@@ -69,6 +69,9 @@
 		/// Unindexes documents with the given label.
 		virtual bool unindexDocuments(const std::string &labelName);
 
+		/// Suggests terms.
+		virtual unsigned int getCloseTerms(const std::string &term, std::set<std::string> &suggestions);
+
 		/// Renames a label.
 		virtual bool renameLabel(const std::string &name, const std::string &newName);
 

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2005-12-31 16:08:45 UTC (rev 43)
+++ trunk/Search/XapianEngine.cpp	2006-01-01 18:13:07 UTC (rev 44)
@@ -124,17 +124,17 @@
 			// Give the query object to the enquire session
 			enquire.set_query(query);
 
-			// Get the top N results of the query
+			// Get the top results of the query
 			Xapian::MSet matches = enquire.get_mset(0, m_maxResultsCount);
 
 			// Get the results
 #ifdef DEBUG
 			cout << "XapianEngine::queryDatabase: " << matches.get_matches_estimated() << "/" << m_maxResultsCount << " results found" << endl;
 #endif
-			for (Xapian::MSetIterator i = matches.begin(); i != matches.end(); ++i)
+			for (Xapian::MSetIterator mIter = matches.begin(); mIter != matches.end(); ++mIter)
 			{
 				// Get the document data
-				string record = i.get_document().get_data();
+				string record = mIter.get_document().get_data();
 
 				// Get the title
 				string title = StringManip::extractField(record, "caption=", "\n");
@@ -147,7 +147,7 @@
 				{
 					// Hmmm this shouldn't be empty...
 					// Use this instead, even though the document isn't cached in the index
-					url = buildUrl(m_databaseName, *i);
+					url = buildUrl(m_databaseName, *mIter);
 				}
 				else
 				{
@@ -167,7 +167,7 @@
 				string language = StringManip::extractField(record, "language=", "\n");
 
 				// Add this result
-				Result thisResult(url, title, summary, language, (float)i.get_percent());
+				Result thisResult(url, title, summary, language, (float)mIter.get_percent());
 				m_resultsList.push_back(thisResult);
 			}
 

Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2005-12-31 16:08:45 UTC (rev 43)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-01-01 18:13:07 UTC (rev 44)
@@ -562,6 +562,7 @@
 		      <property name="has_frame">True</property>
 		      <property name="invisible_char">*</property>
 		      <property name="activates_default">False</property>
+		      <signal name="changed" handler="on_liveQueryEntry_changed" last_modification_time="Sun, 01 Jan 2006 00:46:09 GMT"/>
 		    </widget>
 		    <packing>
 		      <property name="padding">4</property>

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2005-12-31 16:08:45 UTC (rev 43)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-01 18:13:07 UTC (rev 44)
@@ -149,18 +149,29 @@
 		mainHpaned->set_position(m_settings.m_panePos);
 	}
 
+	// Set an icon for this and other windows
+	set_icon_from_file("/usr/share/icons/hicolor/48x48/apps/pinot.png");
+	set_default_icon_from_file("/usr/share/icons/hicolor/48x48/apps/pinot.png");
+
 	// Position the engine tree
 	m_pEnginesTree = manage(new EnginesTree(enginesVbox, m_settings));
 	// Connect to the "changed" signal
-	m_pEnginesTree->get_selection()->signal_changed().connect(SigC::slot(*this,
-		&mainWindow::on_enginesTreeviewSelection_changed));
+	m_pEnginesTree->get_selection()->signal_changed().connect(
+		SigC::slot(*this, &mainWindow::on_enginesTreeviewSelection_changed));
 	// Connect to the edit index signal
-	m_pEnginesTree->getEditIndexSignal().connect(SigC::slot(*this,
-		&mainWindow::on_editindex));
+	m_pEnginesTree->getEditIndexSignal().connect(
+		SigC::slot(*this, &mainWindow::on_editindex));
 
-	// Set an icon for this and other windows
-	set_icon_from_file("/usr/share/icons/hicolor/48x48/apps/pinot.png");
-	set_default_icon_from_file("/usr/share/icons/hicolor/48x48/apps/pinot.png");
+	// Enable completion on the live query field
+	m_refLiveQueryList = ListStore::create(m_liveQueryColumns);
+	m_refLiveQueryCompletion = EntryCompletion::create();
+	m_refLiveQueryCompletion->set_model(m_refLiveQueryList);
+	m_refLiveQueryCompletion->set_text_column(m_liveQueryColumns.m_name);
+	m_refLiveQueryCompletion->set_minimum_key_length(3);
+	m_refLiveQueryCompletion->set_popup_completion(true);
+	m_refLiveQueryCompletion->set_match_func(
+		SigC::slot(*this, &mainWindow::on_queryCompletion_match));
+	liveQueryEntry->set_completion(m_refLiveQueryCompletion);
 
 	// Associate the columns model to the query tree
 	m_refQueryTree = ListStore::create(m_queryColumns);
@@ -175,8 +186,8 @@
 	// Allow only single selection
 	queryTreeview->get_selection()->set_mode(SELECTION_SINGLE);
 	// Connect to the "changed" signal
-	queryTreeview->get_selection()->signal_changed().connect(SigC::slot(*this, 
-		&mainWindow::on_queryTreeviewSelection_changed));
+	queryTreeview->get_selection()->signal_changed().connect(
+		SigC::slot(*this, &mainWindow::on_queryTreeviewSelection_changed));
 	// Populate
 	populate_queryTreeview();
 
@@ -227,9 +238,6 @@
 	// ...and buttons
 	removeIndexButton->set_sensitive(false);
 
-	// Set focus on the query entry field
-	set_focus(*liveQueryEntry);
-
 	// Set tooltips
 	m_tooltips.set_tip(*addIndexButton, _("Add index"));
 	m_tooltips.set_tip(*removeIndexButton, _("Remove index"));
@@ -238,15 +246,15 @@
 	// Fire up a listener thread
 	ListenerThread *pListenThread = new ListenerThread(PinotSettings::getConfigurationDirectory() + string("/fifo"));
 	// Connect to its reception signal
-	pListenThread->getReceptionSignal().connect(SigC::slot(*this,
-		&mainWindow::on_message_reception));
+	pListenThread->getReceptionSignal().connect(
+		SigC::slot(*this, &mainWindow::on_message_reception));
 	start_thread(pListenThread, true);
 
 	// Fire up the mail monitor thread
 	MboxHandler *pMbox = new MboxHandler();
 	// Connect to its update signal
-	pMbox->getUpdateSignal().connect(SigC::slot(*this,
-		&mainWindow::on_message_indexupdate));
+	pMbox->getUpdateSignal().connect(
+		SigC::slot(*this, &mainWindow::on_message_indexupdate));
 	MonitorThread *pMonitorThread = new MonitorThread(pMbox);
 	start_thread(pMonitorThread, true);
 	// The handler object will be deleted when the thread terminates
@@ -405,6 +413,18 @@
 	}
 }
 
+bool mainWindow::on_queryCompletion_match(const ustring &key, const TreeModel::const_iterator &iter)
+{
+	TreeModel::Row row = *iter;
+
+	ustring match = row[m_liveQueryColumns.m_name];
+#ifdef DEBUG
+	cout << "mainWindow::on_queryCompletion_match: " << key << ", " << match << endl;
+#endif
+
+	return true;
+}
+
 //
 // Engines tree selection changed
 //
@@ -424,7 +444,6 @@
 	}
 
 	TreeModel::iterator engineIter = m_pEnginesTree->getIter(*enginePath);
-	TreeModel::Row engineRow = *engineIter;
 	bool enableRemoveIndex = false;
 
 	// Make sure it's a leaf node
@@ -2238,6 +2257,64 @@
 }
 
 //
+// Live query entry change
+//
+void mainWindow::on_liveQueryEntry_changed()
+{
+	ustring liveQuery = liveQueryEntry->get_text();
+
+	// Reset the list
+	m_refLiveQueryList->clear();
+
+	if (m_refLiveQueryCompletion->get_minimum_key_length() > liveQuery.length())
+	{
+#ifdef DEBUG
+		cout << "mainWindow::on_liveQueryEntry_changed: too short" << endl;
+#endif
+		return;
+	}
+
+	// FIXME: relying on other indices may also be useful
+	XapianIndex docsIndex(m_settings.m_indexLocation);
+	if (docsIndex.isGood() == true)
+	{
+		ustring prefix, term = liveQuery;
+
+		// Get the last term from the entry field
+		ustring::size_type pos = liveQuery.find_last_of(" ");
+		if (pos != ustring::npos)
+		{
+			prefix = liveQuery.substr(0, pos);
+			prefix += " ";
+			term = liveQuery.substr(pos + 1);
+		}
+
+		if (term.empty() == false)
+		{
+			set<string> suggestedTerms;
+			int termIndex = 0;
+
+			// Get a list of suggestions
+			docsIndex.getCloseTerms(locale_from_utf8(term), suggestedTerms);
+
+			// Populate the list
+			for (set<string>::iterator termIter = suggestedTerms.begin();
+				termIter != suggestedTerms.end(); ++termIter)
+			{
+				TreeModel::iterator iter = m_refLiveQueryList->append();
+				TreeModel::Row row = *iter;
+
+				row[m_liveQueryColumns.m_name] = prefix + to_utf8(*termIter);
+				++termIndex;
+			}
+#ifdef DEBUG
+			cout << "mainWindow::on_liveQueryEntry_changed: " << termIndex << " suggestions" << endl;
+#endif
+		}
+	}
+}
+
+//
 // Find button click
 //
 void mainWindow::on_findButton_clicked()

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2005-12-31 16:08:45 UTC (rev 43)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-01-01 18:13:07 UTC (rev 44)
@@ -24,6 +24,7 @@
 #include <glibmm/refptr.h>
 #include <gdkmm/pixbuf.h>
 #include <gdkmm/color.h>
+#include <gtkmm/entrycompletion.h>
 #include <gtkmm/rc.h>
 #include <gtkmm/notebook.h>
 #include <gtkmm/liststore.h>
@@ -59,6 +60,7 @@
 	void populate_indexMenu();
 
 	// Handlers
+	bool on_queryCompletion_match(const Glib::ustring &key, const Gtk::TreeModel::const_iterator &iter);
 	void on_enginesTreeviewSelection_changed();
 	void on_queryTreeviewSelection_changed();
 	void on_resultsTreeviewSelection_changed(Glib::ustring queryName);
@@ -100,6 +102,7 @@
 	virtual void on_addIndexButton_clicked();
 	virtual void on_removeIndexButton_clicked();
 
+	virtual void on_liveQueryEntry_changed();
 	virtual void on_findButton_clicked();
 	virtual void on_addQueryButton_clicked();
 	virtual void on_editQueryButton_clicked();
@@ -144,6 +147,9 @@
 	// Engine
 	EnginesTree *m_pEnginesTree;
 	// Query
+	ComboModelColumns m_liveQueryColumns;
+	Glib::RefPtr<Gtk::ListStore> m_refLiveQueryList;
+	Glib::RefPtr<Gtk::EntryCompletion> m_refLiveQueryCompletion;
 	QueryModelColumns m_queryColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refQueryTree;
 	// Notebook

Modified: trunk/UI/GTK2/src/mainWindow_glade.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.cc	2005-12-31 16:08:45 UTC (rev 43)
+++ trunk/UI/GTK2/src/mainWindow_glade.cc	2006-01-01 18:13:07 UTC (rev 44)
@@ -1,4 +1,4 @@
-// generated 2005/12/29 5:49:01 SGT by fabrice at thorgrim.dyndns.org.(none)
+// generated 2006/1/1 8:46:21 SGT by fabrice at thorgrim.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -448,6 +448,7 @@
    about1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_about_activate), false);
    addIndexButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_addIndexButton_clicked), false);
    removeIndexButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_removeIndexButton_clicked), false);
+   liveQueryEntry->signal_changed().connect(SigC::slot(*this, &mainWindow_glade::on_liveQueryEntry_changed), false);
    findButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_findButton_clicked), false);
    queryTreeview->signal_button_press_event().connect(SigC::slot(*this, &mainWindow_glade::on_queryTreeview_button_press_event), false);
    addQueryButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_addQueryButton_clicked), false);

Modified: trunk/UI/GTK2/src/mainWindow_glade.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.hh	2005-12-31 16:08:45 UTC (rev 43)
+++ trunk/UI/GTK2/src/mainWindow_glade.hh	2006-01-01 18:13:07 UTC (rev 44)
@@ -1,4 +1,4 @@
-// generated 2005/12/29 5:49:01 SGT by fabrice at thorgrim.dyndns.org.(none)
+// generated 2006/1/1 8:46:21 SGT by fabrice at thorgrim.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -127,6 +127,7 @@
         virtual void on_about_activate() = 0;
         virtual void on_addIndexButton_clicked() = 0;
         virtual void on_removeIndexButton_clicked() = 0;
+        virtual void on_liveQueryEntry_changed() = 0;
         virtual void on_findButton_clicked() = 0;
         virtual bool on_queryTreeview_button_press_event(GdkEventButton *ev) = 0;
         virtual void on_addQueryButton_clicked() = 0;



From fabricecolin at berlios.de  Sun Jan  1 22:45:57 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sun, 1 Jan 2006 22:45:57 +0100
Subject: [Pinot-svn] r45 - in trunk: . UI/GTK2 UI/GTK2/src po
Message-ID: <200601012145.k01Ljv0c007452@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-01 22:45:56 +0100 (Sun, 01 Jan 2006)
New Revision: 45

Removed:
   trunk/UI/GTK2/src/aboutDialog.cc
   trunk/UI/GTK2/src/aboutDialog.hh
   trunk/UI/GTK2/src/aboutDialog_glade.cc
   trunk/UI/GTK2/src/aboutDialog_glade.hh
Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/Makefile
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/pinot.spec
   trunk/po/POTFILES
Log:
Dropped aboutDialog.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-01-01 18:13:07 UTC (rev 44)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-01-01 21:45:56 UTC (rev 45)
@@ -881,180 +881,6 @@
   </child>
 </widget>
 
-<widget class="GtkDialog" id="aboutDialog">
-  <property agent="glademm" name="cxx_visibility">public</property>
-  <property name="visible">True</property>
-  <property name="title" translatable="yes">About Pinot</property>
-  <property name="type">GTK_WINDOW_TOPLEVEL</property>
-  <property name="window_position">GTK_WIN_POS_NONE</property>
-  <property name="modal">False</property>
-  <property name="resizable">False</property>
-  <property name="destroy_with_parent">False</property>
-  <property name="decorated">True</property>
-  <property name="skip_taskbar_hint">False</property>
-  <property name="skip_pager_hint">False</property>
-  <property name="type_hint">GDK_WINDOW_TYPE_HINT_NORMAL</property>
-  <property name="gravity">GDK_GRAVITY_NORTH_WEST</property>
-  <property name="focus_on_map">True</property>
-  <property name="has_separator">True</property>
-
-  <child internal-child="vbox">
-    <widget class="GtkVBox" id="dialog-vbox1">
-      <property name="visible">True</property>
-      <property name="homogeneous">False</property>
-      <property name="spacing">0</property>
-
-      <child internal-child="action_area">
-	<widget class="GtkHButtonBox" id="dialog-action_area1">
-	  <property name="visible">True</property>
-	  <property name="layout_style">GTK_BUTTONBOX_END</property>
-
-	  <child>
-	    <widget class="GtkButton" id="closebutton1">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="can_default">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="label">gtk-close</property>
-	      <property name="use_stock">True</property>
-	      <property name="relief">GTK_RELIEF_NORMAL</property>
-	      <property name="focus_on_click">True</property>
-	      <property name="response_id">-7</property>
-	    </widget>
-	  </child>
-	</widget>
-	<packing>
-	  <property name="padding">0</property>
-	  <property name="expand">False</property>
-	  <property name="fill">True</property>
-	  <property name="pack_type">GTK_PACK_END</property>
-	</packing>
-      </child>
-
-      <child>
-	<widget class="GtkVBox" id="aboutVbox">
-	  <property name="visible">True</property>
-	  <property name="homogeneous">False</property>
-	  <property name="spacing">0</property>
-
-	  <child>
-	    <widget class="GtkImage" id="pinotImage">
-	      <property name="visible">True</property>
-	      <property name="pixbuf">pinot.png</property>
-	      <property name="xalign">0.5</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">0</property>
-	      <property name="ypad">0</property>
-	    </widget>
-	    <packing>
-	      <property name="padding">0</property>
-	      <property name="expand">True</property>
-	      <property name="fill">True</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="nameLabel">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Pinot</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0.5</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="padding">0</property>
-	      <property name="expand">False</property>
-	      <property name="fill">False</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="descriptionLabel">
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">A metasearch tool for the Free Desktop.</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_CENTER</property>
-	      <property name="wrap">True</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0.5</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="padding">0</property>
-	      <property name="expand">False</property>
-	      <property name="fill">False</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="copyrightLabel">
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Copyright (C) 2005 Fabrice Colin</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_CENTER</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0.5</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="padding">0</property>
-	      <property name="expand">False</property>
-	      <property name="fill">False</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkImage" id="xapianImage">
-	      <property name="visible">True</property>
-	      <property name="pixbuf">xapian-powered.png</property>
-	      <property name="xalign">0.5</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">0</property>
-	      <property name="ypad">0</property>
-	    </widget>
-	    <packing>
-	      <property name="padding">0</property>
-	      <property name="expand">True</property>
-	      <property name="fill">True</property>
-	    </packing>
-	  </child>
-	</widget>
-	<packing>
-	  <property name="padding">0</property>
-	  <property name="expand">False</property>
-	  <property name="fill">True</property>
-	</packing>
-      </child>
-    </widget>
-  </child>
-</widget>
-
 <widget class="GtkDialog" id="prefsDialog">
   <property agent="glademm" name="cxx_visibility">public</property>
   <property name="visible">True</property>

Modified: trunk/UI/GTK2/src/Makefile
===================================================================
--- trunk/UI/GTK2/src/Makefile	2006-01-01 18:13:07 UTC (rev 44)
+++ trunk/UI/GTK2/src/Makefile	2006-01-01 21:45:56 UTC (rev 45)
@@ -6,8 +6,7 @@
 
 LIBS += ${LIBXML_LIBS} ${GTKMOZ_LIBS} ${GTKMM_LIBS} -lgthread-2.0 -lfam
 
-UI_GTK2_SRCS = aboutDialog.cc aboutDialog_glade.cc \
-	importDialog.cc importDialog_glade.cc \
+UI_GTK2_SRCS = importDialog.cc importDialog_glade.cc \
 	indexDialog.cc indexDialog_glade.cc \
 	prefsDialog.cc prefsDialog_glade.cc \
 	propertiesDialog.cc propertiesDialog_glade.cc \

Deleted: trunk/UI/GTK2/src/aboutDialog.cc
===================================================================
--- trunk/UI/GTK2/src/aboutDialog.cc	2006-01-01 18:13:07 UTC (rev 44)
+++ trunk/UI/GTK2/src/aboutDialog.cc	2006-01-01 21:45:56 UTC (rev 45)
@@ -1,28 +0,0 @@
-// generated 2003/5/18 11:20:09 BST by fabrice at amra.dyndns.org.(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to aboutDialog.cc_new
-
-// This file is for your program, I won't touch it again!
-
-#include <glibmm/ustring.h>
-
-#include "config.h"
-#include "NLS.h"
-#include "aboutDialog.hh"
-
-using namespace Glib;
-
-aboutDialog::aboutDialog()
-{
-#ifdef VERSION
-	ustring name = nameLabel->get_text();
-	name += " v";
-	name += VERSION;
-	nameLabel->set_text(name);
-#endif
-}
-
-aboutDialog::~aboutDialog()
-{
-}

Deleted: trunk/UI/GTK2/src/aboutDialog.hh
===================================================================
--- trunk/UI/GTK2/src/aboutDialog.hh	2006-01-01 18:13:07 UTC (rev 44)
+++ trunk/UI/GTK2/src/aboutDialog.hh	2006-01-01 21:45:56 UTC (rev 45)
@@ -1,22 +0,0 @@
-// generated 2003/5/18 11:20:09 BST by fabrice at amra.dyndns.org.(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to aboutDialog.hh_new
-
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
-#ifndef _ABOUTDIALOG_HH
-#  include "aboutDialog_glade.hh"
-#  define _ABOUTDIALOG_HH
-class aboutDialog : public aboutDialog_glade
-{
-public:
-	aboutDialog();
-	virtual ~aboutDialog();
-
-};
-#endif

Deleted: trunk/UI/GTK2/src/aboutDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/aboutDialog_glade.cc	2006-01-01 18:13:07 UTC (rev 44)
+++ trunk/UI/GTK2/src/aboutDialog_glade.cc	2006-01-01 21:45:56 UTC (rev 45)
@@ -1,407 +0,0 @@
-// generated 2005/12/1 23:54:57 SGT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0
-//
-// DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/metase/UI/GTK2/metase-gtk2.glade
-// for gtk 2.6.10 and gtkmm 2.6.2
-//
-// Please modify the corresponding derived classes in ./src/aboutDialog.cc
-
-
-#if defined __GNUC__ && __GNUC__ < 3
-#error This program will crash if compiled with g++ 2.x
-// see the dynamic_cast bug in the gtkmm FAQ
-#endif //
-#include "config.h"
-/*
- * Standard gettext macros.
- */
-#ifdef ENABLE_NLS
-#  include <libintl.h>
-#  undef _
-#  define _(String) dgettext (GETTEXT_PACKAGE, String)
-#  ifdef gettext_noop
-#    define N_(String) gettext_noop (String)
-#  else
-#    define N_(String) (String)
-#  endif
-#else
-#  define textdomain(String) (String)
-#  define gettext(String) (String)
-#  define dgettext(Domain,Message) (Message)
-#  define dcgettext(Domain,Message,Type) (Message)
-#  define bindtextdomain(Domain,Directory) (Domain)
-#  define _(String) (String)
-#  define N_(String) (String)
-#endif
-#include <gtkmmconfig.h>
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
-#include <sigc++/compatibility.h>
-#define GMM_GTKMM_22_24(a,b) b
-#else //gtkmm 2.2
-#define GMM_GTKMM_22_24(a,b) a
-#endif //
-#include "aboutDialog_glade.hh"
-#include <gdk/gdkkeysyms.h>
-#include <gtkmm/accelgroup.h>
-#include <gtkmm/buttonbox.h>
-#include <gtkmm/image.h>
-#include <gdkmm/pixbufloader.h>
-
-static const unsigned char pinot_png_data[] = 
-{       	137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,
-	0,0,0,48,0,0,0,48,8,6,0,0,0,87,2,249,
-	135,0,0,0,6,98,75,71,68,0,255,0,255,0,255,160,
-	189,167,147,0,0,0,9,112,72,89,115,0,0,11,19,0,
-	0,11,19,1,0,154,156,24,0,0,0,7,116,73,77,69,
-	7,213,2,11,16,54,2,88,210,160,116,0,0,7,95,73,
-	68,65,84,104,222,237,153,107,108,20,215,21,199,127,243,216,
-	245,218,222,101,109,99,131,29,136,13,133,64,168,11,196,6,
-	213,41,52,136,66,77,243,52,16,68,40,9,81,212,70,137,
-	72,138,210,32,62,244,173,86,106,66,63,68,170,170,180,169,
-	20,169,106,161,161,84,74,210,36,53,45,15,5,66,11,229,
-	17,234,212,70,24,240,3,140,95,187,241,99,119,189,175,217,
-	217,157,217,153,233,7,108,176,193,27,239,218,86,104,37,31,
-	105,62,220,253,159,185,115,254,115,207,252,239,57,119,97,202,
-	166,108,202,166,108,202,166,236,255,216,132,76,156,107,115,16,
-	128,16,224,26,195,53,6,248,129,6,224,16,240,86,77,140,
-	232,255,2,129,5,64,115,166,15,73,88,68,34,22,207,124,
-	59,206,251,147,77,64,204,208,191,98,248,192,180,192,184,229,
-	50,173,219,111,202,18,112,229,9,188,247,45,27,223,155,108,
-	2,242,68,8,188,146,128,58,19,19,24,17,246,52,16,238,
-	147,16,159,180,193,93,131,175,72,22,160,74,226,23,251,117,
-	234,18,112,236,78,173,64,229,240,65,219,245,176,107,6,95,
-	196,141,43,12,242,9,131,25,175,38,120,190,199,68,31,242,
-	191,75,68,88,44,178,7,144,238,248,10,132,44,8,92,39,
-	208,48,138,159,5,244,119,89,236,253,143,96,171,124,24,125,
-	251,16,48,95,100,118,157,96,255,25,134,246,115,128,108,151,
-	123,227,252,170,117,155,165,156,194,47,5,21,131,80,175,167,
-	49,212,122,226,29,51,17,249,123,182,203,253,72,10,236,125,
-	64,203,136,64,109,14,179,129,194,161,241,53,19,128,126,192,
-	147,226,150,210,7,54,172,223,51,111,243,51,171,120,238,241,
-	27,63,22,8,224,94,244,232,15,212,222,182,175,46,175,154,
-	109,175,121,126,103,213,236,5,21,146,79,137,211,242,169,68,
-	227,21,107,97,219,241,183,215,207,80,14,135,158,120,105,87,
-	222,173,88,231,185,143,106,122,254,241,235,163,113,207,153,231,
-	0,143,60,222,252,31,36,112,62,133,175,115,197,227,15,253,
-	233,251,175,238,88,233,206,113,10,129,225,57,43,128,40,137,
-	82,249,138,37,171,127,184,123,27,249,121,211,80,141,139,40,
-	122,27,179,138,20,122,252,85,36,156,205,242,79,118,191,60,
-	253,86,204,175,172,33,52,239,203,182,88,248,197,7,245,184,
-	254,123,195,95,247,152,56,238,252,55,83,166,15,121,37,101,
-	79,63,244,236,119,191,82,88,48,93,112,196,212,17,88,216,
-	2,35,236,97,195,179,91,41,154,94,72,142,205,78,220,80,
-	176,139,160,91,6,253,13,135,121,228,155,143,141,138,217,179,
-	20,236,217,14,108,206,2,65,44,249,198,90,100,215,54,113,
-	130,43,48,42,129,178,229,15,110,43,43,115,72,150,149,36,
-	214,120,105,4,214,107,129,35,75,102,238,220,108,44,43,137,
-	102,104,228,202,14,166,217,93,8,166,130,22,140,49,103,142,
-	99,84,44,161,135,177,76,19,203,178,16,178,102,74,66,222,
-	242,45,227,74,33,205,130,110,43,117,10,37,109,249,203,18,
-	70,63,97,45,15,253,224,161,17,216,121,3,36,135,147,33,
-	28,64,77,170,116,6,7,80,226,171,137,134,15,164,196,18,
-	234,60,226,138,31,61,166,34,103,217,48,178,75,42,229,52,
-	63,224,2,160,116,104,220,105,129,9,113,160,105,52,255,112,
-	84,151,154,188,65,28,237,45,184,222,59,114,67,171,175,154,
-	208,99,65,73,238,44,154,188,65,108,114,12,127,4,52,67,
-	193,167,44,195,31,93,74,56,242,110,74,172,175,55,136,226,
-	235,39,30,10,33,231,218,209,68,187,67,158,64,254,95,4,
-	146,163,22,66,193,64,107,203,17,115,81,213,7,175,33,234,
-	55,93,246,105,144,85,180,16,205,112,112,170,190,20,217,126,
-	142,128,50,151,96,176,15,213,240,227,243,117,17,87,141,148,
-	152,191,115,128,176,215,67,82,75,144,147,151,143,97,36,154,
-	228,201,202,255,218,28,68,160,0,168,104,188,248,103,117,225,
-	165,183,176,153,55,131,63,168,195,39,38,184,230,60,74,164,
-	215,67,247,5,133,99,177,34,230,150,255,139,206,222,92,148,
-	240,105,162,129,38,98,3,129,148,88,164,163,8,165,63,76,
-	110,177,11,93,21,77,203,127,242,29,33,205,20,218,15,108,
-	29,94,3,9,96,10,194,136,18,66,76,85,28,30,77,194,
-	111,52,112,84,185,177,47,89,130,216,115,63,177,150,110,178,
-	75,171,177,79,83,112,221,251,33,148,116,161,132,21,148,139,
-	249,104,117,119,147,93,250,240,109,152,122,109,38,114,168,26,
-	193,156,143,255,220,223,154,204,206,253,43,211,218,210,183,218,
-	120,101,248,38,38,8,32,8,8,131,65,139,169,130,247,154,
-	240,166,6,111,39,193,94,145,69,193,122,55,238,233,58,134,
-	120,9,169,91,39,25,236,34,28,186,27,221,125,129,164,163,
-	21,25,139,188,153,6,201,228,53,162,13,62,98,241,210,17,
-	152,187,64,67,55,234,241,159,104,236,51,59,14,213,0,237,
-	66,26,111,63,23,8,127,86,221,100,89,160,2,138,117,93,
-	38,91,76,104,48,160,193,4,4,41,104,43,203,117,74,247,
-	104,178,36,200,56,77,39,107,151,173,101,205,134,53,92,252,
-	180,133,3,127,12,226,233,253,8,203,217,133,36,200,24,1,
-	129,45,213,155,184,127,101,21,181,31,124,204,217,214,163,168,
-	118,31,146,32,163,13,100,99,4,238,195,12,68,254,201,192,
-	217,213,233,150,18,75,135,7,127,88,135,223,234,163,243,0,
-	162,64,16,184,6,124,12,28,197,50,62,92,80,249,162,250,
-	242,79,151,201,101,249,55,165,177,45,208,143,45,127,35,229,
-	155,230,225,184,236,167,183,241,2,138,207,71,118,252,28,79,
-	189,240,36,106,82,101,93,241,3,44,142,108,167,185,123,30,
-	87,135,124,108,62,18,218,201,114,99,224,108,218,197,92,197,
-	40,21,232,155,192,246,116,55,144,33,89,77,75,26,253,34,
-	23,188,222,49,229,51,147,106,52,237,29,56,101,127,25,12,
-	180,158,170,47,93,148,142,52,230,22,153,52,245,73,99,202,
-	103,38,4,42,135,171,79,251,56,8,132,91,142,255,197,211,
-	88,243,163,99,177,34,97,12,105,196,145,99,16,84,198,150,
-	207,161,185,165,49,62,96,27,240,171,33,63,175,5,127,77,
-	98,2,59,1,61,93,2,102,60,120,57,17,85,55,69,213,
-	242,252,238,171,121,24,206,127,147,44,174,67,205,58,131,150,
-	108,198,225,40,65,20,11,137,54,214,98,185,170,240,180,207,
-	72,233,19,58,127,160,217,242,159,218,193,117,221,248,108,2,
-	91,109,44,1,190,51,188,142,57,109,208,10,252,50,195,70,
-	40,106,132,219,235,52,69,93,19,215,202,220,186,251,130,48,
-	92,26,147,102,61,182,43,94,190,182,222,198,149,186,46,34,
-	161,226,219,228,51,105,214,91,129,147,151,219,140,246,131,155,
-	129,246,116,83,104,68,254,143,39,125,110,46,67,226,148,217,
-	115,104,181,25,109,219,149,176,69,118,36,58,20,65,18,18,
-	104,134,206,170,138,85,44,249,241,10,148,172,21,68,11,236,
-	124,242,238,62,162,245,237,36,58,20,36,33,65,143,175,215,
-	107,116,39,247,210,119,245,117,160,39,147,150,114,180,26,232,
-	252,4,90,216,14,162,205,47,21,21,236,122,225,137,157,247,
-	202,139,75,237,35,85,105,96,41,81,35,136,187,124,35,122,
-	243,23,17,16,136,53,159,140,26,29,123,102,141,183,39,30,
-	169,64,214,4,86,96,156,170,52,92,113,50,58,149,24,60,
-	133,91,154,102,19,79,230,170,20,179,142,29,47,26,84,156,
-	8,237,109,167,233,105,63,64,224,90,51,74,191,159,156,25,
-	183,43,78,166,43,112,15,224,28,165,137,247,78,148,128,30,
-	108,127,163,239,204,31,158,138,246,111,152,219,117,185,252,70,
-	193,150,200,86,48,180,153,56,115,170,17,204,124,162,245,181,
-	45,168,221,191,27,47,129,76,154,248,76,173,39,209,113,228,
-	105,93,213,247,137,51,191,94,22,207,15,11,246,236,78,236,
-	130,131,194,47,244,18,245,236,181,124,135,138,219,204,206,83,
-	91,128,192,68,30,180,101,176,198,25,186,94,155,228,147,193,
-	50,156,11,95,183,85,228,123,29,213,14,43,119,157,211,146,
-	42,101,15,51,216,13,20,127,222,167,220,2,119,192,196,73,
-	156,203,118,39,72,76,22,1,107,48,120,241,243,38,33,77,
-	242,124,214,212,127,70,83,54,101,83,150,145,253,23,118,236,
-	95,208,24,43,190,110,0,0,0,0,73,69,78,68,174,66,
-	96,130,
-
-};
-
-#include <gtkmm/label.h>
-
-static const unsigned char xapian_powered_png_data[] = 
-{       	137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,
-	0,0,0,208,0,0,0,30,8,3,0,0,0,106,152,96,
-	130,0,0,0,4,103,65,77,65,0,0,175,200,55,5,138,
-	233,0,0,0,25,116,69,88,116,83,111,102,116,119,97,114,
-	101,0,65,100,111,98,101,32,73,109,97,103,101,82,101,97,
-	100,121,113,201,101,60,0,0,1,128,80,76,84,69,205,205,
-	205,226,124,52,255,56,7,51,51,177,255,115,101,166,230,102,
-	250,213,180,171,171,171,71,71,157,255,102,82,233,130,54,255,
-	153,56,51,51,202,185,243,102,250,174,121,147,217,102,190,190,
-	190,255,181,115,148,148,214,255,245,22,255,245,179,255,210,118,
-	201,254,102,255,86,56,255,74,39,255,154,155,255,217,56,218,
-	116,51,255,199,85,150,214,124,197,251,102,255,137,134,255,223,
-	46,255,185,104,255,210,146,236,183,148,52,52,154,255,66,24,
-	148,147,183,216,218,228,255,215,213,255,166,133,255,236,233,250,
-	148,74,203,101,51,204,255,103,255,165,167,241,139,55,138,211,
-	102,255,250,245,255,211,69,255,226,220,176,237,102,251,149,66,
-	202,202,218,255,152,66,255,246,236,255,128,122,210,108,51,233,
-	189,165,255,179,172,255,197,197,255,252,250,68,68,191,255,252,
-	13,243,141,66,255,238,28,255,233,34,172,229,124,210,211,218,
-	255,94,68,255,167,156,255,251,248,255,80,43,160,221,124,255,
-	245,244,157,224,102,255,204,78,255,255,255,130,206,102,255,228,
-	39,237,135,62,102,102,102,178,178,178,217,217,217,153,153,153,
-	236,236,236,159,159,159,140,140,140,197,197,197,229,229,229,245,
-	245,245,249,249,249,226,226,226,111,111,111,165,165,165,223,223,
-	223,242,242,242,121,121,121,185,185,185,210,210,210,130,130,130,
-	254,255,254,149,149,149,183,237,124,255,150,139,255,190,182,255,
-	255,250,255,255,254,255,226,65,255,255,157,178,177,198,253,151,
-	73,242,182,134,191,247,102,255,249,218,196,249,103,255,191,96,
-	255,216,95,255,236,42,124,202,102,255,175,175,255,255,127,75,
-	75,130,255,143,143,255,255,193,247,145,60,247,145,71,7,225,
-	45,180,0,0,6,205,73,68,65,84,120,218,98,240,27,102,
-	0,32,128,24,232,105,153,51,16,56,57,9,11,11,59,0,
-	65,30,109,236,0,8,32,26,123,72,23,6,196,74,120,253,
-	252,2,20,20,2,2,160,94,170,202,166,141,141,0,1,68,
-	39,15,137,201,21,153,248,249,41,72,73,73,1,253,4,242,
-	82,94,142,29,109,108,4,8,32,250,120,72,12,24,65,64,
-	15,201,24,1,1,208,79,1,229,181,126,118,130,180,177,17,
-	32,128,104,237,33,49,8,144,43,226,101,245,243,43,149,145,
-	145,241,5,122,41,183,54,219,80,144,59,135,38,54,2,4,
-	16,205,61,36,7,2,37,69,188,38,172,126,57,130,165,165,
-	64,63,249,150,21,251,121,8,114,115,211,198,70,128,0,162,
-	181,135,74,74,138,138,138,120,121,129,254,241,241,243,19,84,
-	4,130,82,81,139,28,67,65,115,90,121,8,32,128,104,237,
-	33,176,103,128,128,213,135,31,24,67,32,32,106,232,7,244,
-	143,185,57,141,60,4,16,64,52,246,80,6,208,55,172,64,
-	224,227,195,111,224,231,167,201,199,199,167,148,3,244,79,65,
-	65,129,185,57,109,108,4,8,32,90,123,8,24,53,64,192,
-	207,207,111,224,15,246,16,155,159,159,29,95,189,54,237,60,
-	4,16,64,52,247,16,196,55,6,6,254,21,64,15,105,178,
-	249,229,120,240,57,214,107,131,124,148,70,19,27,1,2,136,
-	214,30,202,112,113,241,2,2,89,32,240,203,209,20,241,75,
-	179,227,11,12,4,249,200,212,20,162,34,141,61,40,34,34,
-	34,41,60,54,14,68,197,197,226,55,47,154,160,141,0,1,
-	68,99,15,229,164,229,0,65,26,4,128,4,236,248,184,184,
-	64,62,50,53,173,131,42,137,140,8,10,10,138,96,15,139,
-	72,10,10,74,74,199,239,226,72,66,30,246,243,3,8,32,
-	186,54,78,253,114,98,248,184,24,25,65,62,170,171,171,131,
-	139,198,38,5,5,3,3,63,41,40,156,80,4,16,225,33,
-	128,0,162,169,135,132,64,64,13,10,242,65,45,3,187,66,
-	70,70,144,143,244,129,0,161,46,54,46,40,196,47,61,40,
-	28,150,174,34,131,131,131,195,32,50,33,33,209,97,193,17,
-	193,33,96,94,72,72,8,134,138,232,144,144,48,191,216,224,
-	96,152,71,0,2,136,34,15,37,6,7,39,160,50,80,1,
-	15,15,51,16,168,64,128,43,36,142,148,25,165,129,62,226,
-	66,241,144,31,67,80,28,123,80,42,52,126,194,226,130,146,
-	82,131,130,64,113,17,29,7,76,134,64,28,20,20,9,86,
-	21,20,36,0,86,145,4,86,1,246,93,56,80,69,56,72,
-	5,84,59,64,0,81,22,67,41,161,80,253,33,161,12,184,
-	60,4,241,14,71,8,48,130,140,179,188,129,62,146,150,6,
-	123,137,11,185,45,23,28,20,4,79,77,193,65,236,105,126,
-	145,208,248,138,13,2,37,196,144,56,136,235,5,64,105,19,
-	170,130,1,170,34,4,168,53,196,47,58,60,72,0,156,73,
-	1,2,8,230,142,196,168,132,152,20,6,80,44,2,41,134,
-	68,32,25,149,16,21,147,0,162,128,97,31,2,18,242,139,
-	10,137,9,97,136,1,170,101,96,0,25,31,3,20,100,135,
-	233,15,102,136,98,72,137,241,75,72,0,170,79,72,128,68,
-	87,14,15,15,200,75,32,255,84,171,3,249,198,54,54,54,
-	222,126,126,202,86,96,47,49,34,123,61,44,40,40,29,158,
-	0,131,216,129,113,19,20,1,225,5,197,129,51,15,196,245,
-	33,16,15,197,198,33,171,136,0,71,95,24,148,11,16,128,
-	138,50,214,65,16,138,161,104,55,86,86,255,128,201,15,240,
-	7,28,76,186,148,114,237,139,166,194,195,73,126,128,248,243,
-	60,177,16,157,154,52,119,184,39,61,233,86,104,132,186,137,
-	38,238,225,36,72,93,165,78,89,31,162,48,174,97,130,174,
-	23,245,26,153,147,102,43,203,155,59,57,118,32,23,131,148,
-	36,168,133,218,118,161,144,238,221,190,38,110,230,249,120,56,
-	95,166,66,116,250,48,253,126,227,103,88,245,37,186,147,12,
-	59,208,58,163,125,0,253,39,174,171,157,17,228,69,0,193,
-	83,74,8,208,51,126,193,201,126,145,241,192,56,72,78,246,
-	243,99,143,244,11,15,13,73,4,10,135,129,164,216,5,252,
-	98,128,190,97,79,6,75,134,132,2,147,91,12,80,4,238,
-	33,160,77,81,161,97,64,137,24,191,120,6,63,132,135,64,
-	81,196,1,138,31,13,61,61,201,204,26,249,76,45,63,59,
-	107,43,29,160,151,144,60,20,30,20,17,11,201,53,32,39,
-	37,129,114,4,170,135,252,80,60,132,170,34,34,8,89,33,
-	64,0,193,61,20,21,10,226,197,251,5,131,2,42,1,200,
-	73,97,15,11,141,20,8,137,7,73,129,64,36,40,93,249,
-	69,198,0,189,9,4,225,126,12,193,224,148,6,79,114,64,
-	2,148,145,194,67,194,128,126,66,241,16,135,58,176,187,173,
-	33,41,89,35,47,111,201,194,98,169,229,151,99,173,163,163,
-	99,133,104,41,68,6,197,69,3,243,71,18,36,91,199,197,
-	69,198,130,220,23,29,140,43,134,96,42,252,130,49,61,4,
-	16,64,104,30,98,135,120,8,24,1,192,120,73,9,78,136,
-	143,20,0,73,69,69,69,1,11,71,168,243,227,5,128,92,
-	6,172,30,74,1,230,219,96,129,100,63,100,15,241,128,227,
-	199,22,232,25,160,111,56,57,221,220,88,180,114,210,64,62,
-	130,251,39,4,18,57,233,144,130,10,226,104,96,150,8,1,
-	59,52,40,9,212,156,16,0,229,43,152,92,44,170,10,84,
-	15,1,4,16,146,135,162,128,217,66,0,152,153,128,41,137,
-	29,228,166,240,248,200,196,80,118,96,246,79,4,58,20,148,
-	253,65,210,64,144,12,52,59,37,30,232,233,48,160,72,50,
-	82,146,3,137,0,195,33,60,4,197,67,246,160,242,218,22,
-	234,27,113,113,79,79,9,78,173,108,63,107,184,135,66,216,
-	129,5,111,72,180,95,172,0,144,6,22,75,209,65,169,192,
-	148,155,26,20,23,14,241,80,80,120,24,176,66,13,2,149,
-	87,177,193,65,225,32,175,163,168,136,12,10,2,86,73,209,
-	193,96,67,252,252,0,2,8,201,67,225,193,241,241,192,226,
-	141,29,72,135,131,180,3,139,4,191,248,208,68,144,158,208,
-	224,80,129,152,68,246,208,80,144,251,195,194,227,227,227,129,
-	229,88,112,40,80,97,40,212,71,193,225,236,64,53,224,8,
-	12,247,67,246,16,216,63,89,16,223,0,61,35,33,161,170,
-	170,234,102,236,231,103,109,5,143,30,16,96,143,6,87,55,
-	65,169,160,198,29,16,196,1,253,144,4,41,229,32,92,184,
-	210,96,36,21,113,160,120,5,177,253,64,165,10,56,142,0,
-	2,8,238,161,132,208,152,144,4,112,226,143,98,128,208,137,
-	192,162,32,17,82,29,135,165,128,252,5,76,105,96,46,80,
-	33,36,12,66,98,18,33,34,64,133,49,137,9,64,102,100,
-	88,76,120,36,178,135,192,254,177,1,165,52,160,111,84,193,
-	128,137,137,73,28,232,35,54,72,227,14,220,24,0,34,191,
-	176,144,48,16,19,228,240,224,224,72,96,140,65,154,2,65,
-	17,97,2,32,46,180,165,0,105,43,32,169,136,6,137,133,
-	1,117,131,41,63,63,128,0,130,121,8,88,76,39,135,81,
-	220,214,9,11,77,102,15,143,65,242,16,200,63,57,238,226,
-	192,148,6,142,26,38,24,240,52,78,35,178,247,0,43,203,
-	136,5,0,1,4,243,80,20,3,3,67,2,229,173,183,148,
-	96,129,68,164,150,130,189,25,144,212,148,64,245,12,196,71,
-	26,68,13,52,178,167,130,90,226,164,244,156,0,2,136,166,
-	141,83,176,127,208,129,93,14,8,102,19,53,136,149,198,30,
-	17,28,28,193,78,138,157,0,1,68,223,238,3,29,0,64,
-	128,1,0,130,19,32,31,170,173,135,150,0,0,0,0,73,
-	69,78,68,174,66,96,130,
-
-};
-
-#include <gtkmm/box.h>
-
-aboutDialog_glade::aboutDialog_glade(
-)
-{  aboutDialog = this;
-   gmm_data = new GlademmData(get_accel_group());
-   closebutton1 = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-close")));
-   
-   Glib::RefPtr<Gdk::PixbufLoader> _pinotImage_loader=Gdk::PixbufLoader::create();
-   _pinotImage_loader->write(pinot_png_data, sizeof pinot_png_data);
-   _pinotImage_loader->close();
-   
-   Gtk::Image *pinotImage = Gtk::manage(new class Gtk::Image(_pinotImage_loader->get_pixbuf()));
-   _pinotImage_loader=Glib::RefPtr<Gdk::PixbufLoader>();
-   nameLabel = Gtk::manage(new class Gtk::Label(_("Pinot")));
-   
-   Gtk::Label *descriptionLabel = Gtk::manage(new class Gtk::Label(_("A metasearch tool for the Free Desktop.")));
-   Gtk::Label *copyrightLabel = Gtk::manage(new class Gtk::Label(_("Copyright (C) 2005 Fabrice Colin")));
-   Glib::RefPtr<Gdk::PixbufLoader> _xapianImage_loader=Gdk::PixbufLoader::create();
-   _xapianImage_loader->write(xapian_powered_png_data, sizeof xapian_powered_png_data);
-   _xapianImage_loader->close();
-   
-   Gtk::Image *xapianImage = Gtk::manage(new class Gtk::Image(_xapianImage_loader->get_pixbuf()));
-   _xapianImage_loader=Glib::RefPtr<Gdk::PixbufLoader>();
-   
-   Gtk::VBox *aboutVbox = Gtk::manage(new class Gtk::VBox(false, 0));
-   closebutton1->set_flags(Gtk::CAN_FOCUS);
-   closebutton1->set_flags(Gtk::CAN_DEFAULT);
-   closebutton1->set_relief(Gtk::RELIEF_NORMAL);
-   aboutDialog->get_action_area()->property_layout_style().set_value(Gtk::BUTTONBOX_END);
-   pinotImage->set_alignment(0.5,0.5);
-   pinotImage->set_padding(0,0);
-   nameLabel->set_alignment(0.5,0.5);
-   nameLabel->set_padding(4,4);
-   nameLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   nameLabel->set_line_wrap(false);
-   nameLabel->set_use_markup(false);
-   nameLabel->set_selectable(false);
-   descriptionLabel->set_alignment(0.5,0.5);
-   descriptionLabel->set_padding(4,4);
-   descriptionLabel->set_justify(Gtk::JUSTIFY_CENTER);
-   descriptionLabel->set_line_wrap(true);
-   descriptionLabel->set_use_markup(false);
-   descriptionLabel->set_selectable(false);
-   copyrightLabel->set_alignment(0.5,0.5);
-   copyrightLabel->set_padding(4,4);
-   copyrightLabel->set_justify(Gtk::JUSTIFY_CENTER);
-   copyrightLabel->set_line_wrap(false);
-   copyrightLabel->set_use_markup(false);
-   copyrightLabel->set_selectable(false);
-   xapianImage->set_alignment(0.5,0.5);
-   xapianImage->set_padding(0,0);
-   aboutVbox->pack_start(*pinotImage);
-   aboutVbox->pack_start(*nameLabel, Gtk::PACK_SHRINK, 0);
-   aboutVbox->pack_start(*descriptionLabel, Gtk::PACK_SHRINK, 0);
-   aboutVbox->pack_start(*copyrightLabel, Gtk::PACK_SHRINK, 0);
-   aboutVbox->pack_start(*xapianImage);
-   aboutDialog->get_vbox()->set_homogeneous(false);
-   aboutDialog->get_vbox()->set_spacing(0);
-   aboutDialog->get_vbox()->pack_start(*aboutVbox, Gtk::PACK_SHRINK, 0);
-   aboutDialog->set_title(_("About Pinot"));
-   aboutDialog->set_modal(false);
-   aboutDialog->property_window_position().set_value(Gtk::WIN_POS_NONE);
-   aboutDialog->set_resizable(false);
-   aboutDialog->property_destroy_with_parent().set_value(false);
-   aboutDialog->set_has_separator(true);
-   aboutDialog->add_action_widget(*closebutton1, -7);
-   closebutton1->show();
-   pinotImage->show();
-   nameLabel->show();
-   descriptionLabel->show();
-   copyrightLabel->show();
-   xapianImage->show();
-   aboutVbox->show();
-   aboutDialog->show();
-}
-
-aboutDialog_glade::~aboutDialog_glade()
-{  delete gmm_data;
-}

Deleted: trunk/UI/GTK2/src/aboutDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/aboutDialog_glade.hh	2006-01-01 18:13:07 UTC (rev 44)
+++ trunk/UI/GTK2/src/aboutDialog_glade.hh	2006-01-01 21:45:56 UTC (rev 45)
@@ -1,52 +0,0 @@
-// generated 2004/7/24 17:45:26 BST by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0_cvs
-//
-// DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/metase/UI/GTK2/metase-gtk2.glade
-// for gtk 2.4.0 and gtkmm 2.2.12
-//
-// Please modify the corresponding derived classes in ./src/aboutDialog.hh and./src/aboutDialog.cc
-
-#ifndef _ABOUTDIALOG_GLADE_HH
-#  define _ABOUTDIALOG_GLADE_HH
-
-
-#if !defined(GLADEMM_DATA)
-#define GLADEMM_DATA 
-#include <gtkmm/accelgroup.h>
-
-class GlademmData
-{  
-        
-        Glib::RefPtr<Gtk::AccelGroup> accgrp;
-public:
-        
-        GlademmData(Glib::RefPtr<Gtk::AccelGroup> ag) : accgrp(ag)
-        {  
-        }
-        
-        Glib::RefPtr<Gtk::AccelGroup>  getAccelGroup()
-        {  return accgrp;
-        }
-};
-#endif //GLADEMM_DATA
-
-#include <gtkmm/dialog.h>
-#include <gtkmm/button.h>
-#include <gtkmm/label.h>
-
-class aboutDialog_glade : public Gtk::Dialog
-{  
-        
-        GlademmData *gmm_data;
-public:
-        class Gtk::Dialog * aboutDialog;
-protected:
-        class Gtk::Button * closebutton1;
-        class Gtk::Label * nameLabel;
-        
-        aboutDialog_glade();
-        
-        ~aboutDialog_glade();
-};
-#endif

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-01 18:13:07 UTC (rev 44)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-01 21:45:56 UTC (rev 45)
@@ -25,6 +25,7 @@
 #include <glibmm/stringutils.h>
 #include <glibmm/convert.h>
 #include <glibmm/thread.h>
+#include <gtkmm/aboutdialog.h>
 #include <gtkmm/stock.h>
 #include <gtkmm/messagedialog.h>
 #include <gtkmm/scrolledwindow.h>
@@ -47,7 +48,6 @@
 #include "IndexPage.h"
 #include "PinotUtils.h"
 #include "mainWindow.hh"
-#include "aboutDialog.hh"
 #include "importDialog.hh"
 #include "indexDialog.hh"
 #include "propertiesDialog.hh"
@@ -2135,7 +2135,14 @@
 //
 void mainWindow::on_about_activate()
 {
-	aboutDialog aboutBox;
+	AboutDialog aboutBox;
+
+	aboutBox.set_comments(_("A metasearch tool for the Free Desktop"));
+	aboutBox.set_copyright(_("(C) 2005-2006 Fabrice Colin"));
+	aboutBox.set_name("Pinot");
+	aboutBox.set_version(VERSION);
+	aboutBox.set_website("http://pinot.berlios.de/");
+	aboutBox.set_website_label("http://pinot.berlios.de/");
 	aboutBox.show();
 	aboutBox.run();
 }

Modified: trunk/pinot.spec
===================================================================
--- trunk/pinot.spec	2006-01-01 18:13:07 UTC (rev 44)
+++ trunk/pinot.spec	2006-01-01 21:45:56 UTC (rev 45)
@@ -11,8 +11,8 @@
 Patch0: libxmlpp026.patch
 URL: http://pinot.berlios.de/
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
-Requires: xapian-core-libs >= 0.9.0, neon >= 0.24, gtkmm24 >= 2.4.12, mozilla >= %{mozilla_ver}, sqlite >= 3.1.2, ots >= 0.4.2, libtextcat >= 2.2, fam >= 2.6.10, gmime >= 2.1, file
-BuildRequires: xapian-core-devel >= 0.9.0, neon-devel >= 0.24, gtkmm24-devel >= 2.4.12, mozilla-devel >= %{mozilla_ver}, sqlite-devel >= 3.1.2, ots-devel >= 0.4.2, libtextcat-devel >= 2.2, fam-devel >= 2.6.10, gmime-devel >= 2.1, file, boost-devel >= 1.32, desktop-file-utils
+Requires: xapian-core-libs >= 0.9.0, neon >= 0.24, gtkmm24 >= 2.6, mozilla >= %{mozilla_ver}, sqlite >= 3.1.2, ots >= 0.4.2, libtextcat >= 2.2, fam >= 2.6.10, gmime >= 2.1, file
+BuildRequires: xapian-core-devel >= 0.9.0, neon-devel >= 0.24, gtkmm24-devel >= 2.6, mozilla-devel >= %{mozilla_ver}, sqlite-devel >= 3.1.2, ots-devel >= 0.4.2, libtextcat-devel >= 2.2, fam-devel >= 2.6.10, gmime-devel >= 2.1, file, boost-devel >= 1.32, desktop-file-utils
 %if 0%{?_with_libxmlpp026:1}
 Requires: libxml++ >= 0.26
 BuildRequires: libxml++-devel >= 0.26

Modified: trunk/po/POTFILES
===================================================================
--- trunk/po/POTFILES	2006-01-01 18:13:07 UTC (rev 44)
+++ trunk/po/POTFILES	2006-01-01 21:45:56 UTC (rev 45)
@@ -1,5 +1,3 @@
-UI/GTK2/src/aboutDialog.cc
-UI/GTK2/src/aboutDialog_glade.cc
 UI/GTK2/src/EnginesTree.cpp
 UI/GTK2/src/HtmlView.cpp
 UI/GTK2/src/importDialog.cc



From fabricecolin at berlios.de  Mon Jan  2 20:30:59 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 2 Jan 2006 20:30:59 +0100
Subject: [Pinot-svn] r46 - trunk/Index
Message-ID: <200601021930.k02JUxDQ028251@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-02 20:30:57 +0100 (Mon, 02 Jan 2006)
New Revision: 46

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/Index/XapianIndex.h
Log:
Limit the length of terms. Make sure the database is unlocked even when
an exception is caught.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-01-01 21:45:56 UTC (rev 45)
+++ trunk/Index/XapianIndex.cpp	2006-01-02 19:30:57 UTC (rev 46)
@@ -61,6 +61,16 @@
 {
 }
 
+string XapianIndex::limitTermLength(const string &term)
+{
+	if (term.length() > XapianIndex::m_maxTermLength)
+	{
+		return term.substr(0, XapianIndex::m_maxTermLength);
+	}
+
+	return term;
+}
+
 void XapianIndex::addTermsToDocument(Tokenizer &tokens, Xapian::Document &doc,
 	const string &prefix, Xapian::termcount &termPos, StemmingMode mode) const
 {
@@ -87,22 +97,22 @@
 		if ((mode == STORE_UNSTEM) ||
 			(pStemmer == NULL))
 		{
-			doc.add_posting(prefix + term,  termPos++);
+			doc.add_posting(limitTermLength(prefix + term), termPos++);
 		}
 		else if (mode == STORE_STEM)
 		{
 			string stemmedTerm = pStemmer->stem_word(term);
 
-			doc.add_posting(prefix + stemmedTerm,  termPos++);
+			doc.add_posting(limitTermLength(prefix + stemmedTerm), termPos++);
 		}
 		else if (mode == STORE_BOTH)
 		{
 			string stemmedTerm = pStemmer->stem_word(term);
 
 			// Add both
-			doc.add_posting(prefix + term,  termPos);
+			doc.add_posting(limitTermLength(prefix + term), termPos);
 			// ...at the same position
-			doc.add_posting(prefix + stemmedTerm,  termPos++);
+			doc.add_posting(limitTermLength(prefix + stemmedTerm), termPos++);
 		}
 	}
 #ifdef DEBUG
@@ -137,15 +147,15 @@
 	Url urlObj(location);
 
 	// Index the full URL with prefix U
-	doc.add_term(string("U") + location);
+	doc.add_term(limitTermLength(string("U") + location));
 	// ...the host name with prefix H
 	string hostName = urlObj.getHost();
-	doc.add_term(string("H") + StringManip::toLowerCase(hostName));
+	doc.add_term(limitTermLength(string("H") + StringManip::toLowerCase(hostName)));
 	// ...and the file name with prefix F
 	string fileName = urlObj.getFile();
-	doc.add_term(string("F") + StringManip::toLowerCase(fileName));
+	doc.add_term(limitTermLength(string("F") + StringManip::toLowerCase(fileName)));
 	// Finally, add the language with prefix L
-	doc.add_term(string("L") + StringManip::toLowerCase(m_stemLanguage));
+	doc.add_term(limitTermLength(string("L") + StringManip::toLowerCase(m_stemLanguage)));
 
 	setDocumentData(doc, info, summary, m_stemLanguage);
 
@@ -261,7 +271,7 @@
 
 /// Indexes the given data.
 bool XapianIndex::indexDocument(Tokenizer &tokens, const std::set<std::string> &labels,
-			unsigned int &docId)
+	unsigned int &docId)
 {
 	unsigned int dataLength = 0;
 	bool indexed = false;
@@ -312,7 +322,7 @@
 		for (set<string>::const_iterator labelIter = labels.begin(); labelIter != labels.end();
 			++labelIter)
 		{
-			doc.add_term(string("C") + *labelIter);
+			doc.add_term(limitTermLength(string("C") + *labelIter));
 		}
 		if (prepareDocument(docInfo, doc, termPos, summary) == true)
 		{
@@ -323,7 +333,6 @@
 				docId = pIndex->add_document(doc);
 				indexed = true;
 			}
-			pDatabase->unlock();
 		}
 	}
 	catch (const Xapian::Error &error)
@@ -334,6 +343,7 @@
 	{
 		cerr << "Couldn't index document, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return indexed;
 }
@@ -380,7 +390,6 @@
 				foundDocument = true;
 			}
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -390,6 +399,7 @@
 	{
 		cerr << "Couldn't get document properties, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return foundDocument;
 }
@@ -428,7 +438,6 @@
 				}
 			}
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -438,6 +447,7 @@
 	{
 		cerr << "Couldn't check document labels, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return foundLabel;
 }
@@ -471,7 +481,6 @@
 			}
 			gotLabels = true;
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -481,6 +490,7 @@
 	{
 		cerr << "Couldn't get document's labels, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return gotLabels;
 }
@@ -516,7 +526,6 @@
 			}
 			lookedForLabel = true;
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -526,6 +535,7 @@
 	{
 		cerr << "Couldn't get documents, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return lookedForLabel;
 }
@@ -569,7 +579,7 @@
 		Xapian::termcount termPos = 0;
 
 		// Add the tokenizer's terms to the document
-		 addTermsToDocument(tokens, doc, "", termPos, m_stemMode);
+		addTermsToDocument(tokens, doc, "", termPos, m_stemMode);
 		// Get the document's labels
 		if (getDocumentLabels(docId, labels) == true)
 		{
@@ -577,7 +587,7 @@
 			for (set<string>::const_iterator labelIter = labels.begin(); labelIter != labels.end();
 				++labelIter)
 			{
-				doc.add_term(string("C") + *labelIter);
+				doc.add_term(limitTermLength(string("C") + *labelIter));
 			}
 		}
 		if (prepareDocument(docInfo, doc, termPos, summary) == true)
@@ -590,7 +600,6 @@
 				// FIXME: if the document information has changed, we need to update the history too
 				updated = true;
 			}
-			pDatabase->unlock();
 		}
 	}
 	catch (const Xapian::Error &error)
@@ -601,6 +610,7 @@
 	{
 		cerr << "Couldn't update document, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return updated;
 }
@@ -639,7 +649,6 @@
 			pIndex->replace_document(docId, doc);
 			updated = true;
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -649,6 +658,7 @@
 	{
 		cerr << "Couldn't update document properties, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return updated;
 }
@@ -691,13 +701,12 @@
 			for (set<string>::const_iterator labelIter = labels.begin(); labelIter != labels.end();
 				++labelIter)
 			{
-				doc.add_term(string("C") + *labelIter);
+				doc.add_term(limitTermLength(string("C") + *labelIter));
 			}
 
 			pIndex->replace_document(docId, doc);
 			updatedLabels = true;
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -707,6 +716,7 @@
 	{
 		cerr << "Couldn't update document's labels, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return updatedLabels;
 }
@@ -740,7 +750,6 @@
 			}
 			// FIXME: what if the term exist in more than one document ?
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -750,6 +759,7 @@
 	{
 		cerr << "Couldn't delete label, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return docId;
 }
@@ -780,7 +790,6 @@
 			pIndex->delete_document(docId);
 			unindexed = true;
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -790,6 +799,7 @@
 	{
 		cerr << "Couldn't unindex document, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return unindexed;
 }
@@ -823,7 +833,6 @@
 			pIndex->delete_document(term);
 			unindexed = true;
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -833,6 +842,7 @@
 	{
 		cerr << "Couldn't unindex documents, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return unindexed;
 }
@@ -880,7 +890,6 @@
 				}
 			}
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -890,6 +899,7 @@
 	{
 		cerr << "Couldn't get terms, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return suggestions.size();
 }
@@ -925,14 +935,13 @@
 				// Remove the term
 				doc.remove_term(term);
 				// ...add the new one
-				doc.add_term(string("C") + newName);
+				doc.add_term(limitTermLength(string("C") + newName));
 				// ...and update the document
 				pIndex->replace_document(docId, doc);
 			}
 
 			renamedLabel = true;
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -942,6 +951,7 @@
 	{
 		cerr << "Couldn't delete label, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return renamedLabel;
 }
@@ -981,7 +991,6 @@
 			}
 			deletedLabel = true;
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -991,6 +1000,7 @@
 	{
 		cerr << "Couldn't delete label, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return deletedLabel;
 }
@@ -1018,7 +1028,6 @@
 			pIndex->flush();
 			flushed = true;
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -1028,6 +1037,7 @@
 	{
 		cerr << "Couldn't flush database, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return flushed;
 }
@@ -1051,7 +1061,6 @@
 		{
 			docCount = pIndex->get_doccount();
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -1061,6 +1070,7 @@
 	{
 		cerr << "Couldn't count documents, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return docCount;
 }
@@ -1099,7 +1109,6 @@
 				++docCount;
 			}
 		}
-		pDatabase->unlock();
 	}
 	catch (const Xapian::Error &error)
 	{
@@ -1109,6 +1118,7 @@
 	{
 		cerr << "Couldn't get document list, unknown exception occured" << endl;
 	}
+	pDatabase->unlock();
 
 	return docIds.size();
 }

Modified: trunk/Index/XapianIndex.h
===================================================================
--- trunk/Index/XapianIndex.h	2006-01-01 21:45:56 UTC (rev 45)
+++ trunk/Index/XapianIndex.h	2006-01-02 19:30:57 UTC (rev 46)
@@ -94,6 +94,8 @@
 		std::string m_databaseName;
 		std::string m_stemLanguage;
 
+		static std::string limitTermLength(const std::string &term);
+
 		void addTermsToDocument(Tokenizer &tokens, Xapian::Document &doc,
 			const std::string &prefix, Xapian::termcount &termPos, StemmingMode mode) const;
 



From fabricecolin at berlios.de  Mon Jan  2 20:35:23 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 2 Jan 2006 20:35:23 +0100
Subject: [Pinot-svn] r48 - trunk
Message-ID: <200601021935.k02JZN7I030206@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-02 20:35:21 +0100 (Mon, 02 Jan 2006)
New Revision: 48

Modified:
   trunk/TODO
Log:
-1 +1 item.


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2006-01-02 19:34:26 UTC (rev 47)
+++ trunk/TODO	2006-01-02 19:35:21 UTC (rev 48)
@@ -42,7 +42,6 @@
 - Write a pseudo-filesystem for indexes with FUSE (http://fuse.sourceforge.net/) or gnome-vfs ?
 - Interface with libtranslate (http://www.nongnu.org/libtranslate/) ? :-)
 - Xapian lock files can be deleted at startup if no other instance is running
-- Make sure terms are not longer than btree:max_key_len bytes
 - Play around with the XAPIAN_FLUSH_THRESHOLD env var
 - Catch DatabaseModifiedError exceptions, call reopen()
 - Sort index/database back-end, don't replicate what's in the configuration file, etc...
@@ -99,4 +98,4 @@
 - Enable to save live queries
 - Clean up method names
 - Prefer ustring to string whenever possible
-
+- Extend query completion based on a dictionary (use libsexymm's SpellEntry ?)



From fabricecolin at berlios.de  Mon Jan  2 20:34:29 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 2 Jan 2006 20:34:29 +0100
Subject: [Pinot-svn] r47 - in trunk/UI/GTK2: . src
Message-ID: <200601021934.k02JYTI8029990@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-02 20:34:26 +0100 (Mon, 02 Jan 2006)
New Revision: 47

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/IndexTree.cpp
   trunk/UI/GTK2/src/IndexTree.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/UI/GTK2/src/importDialog_glade.cc
   trunk/UI/GTK2/src/importDialog_glade.hh
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/mainWindow_glade.cc
Log:
Update all properties after a document update. Don't attempt completion when
characters are deleted off the live query field. Started reworking importDialog.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-01-02 19:34:26 UTC (rev 47)
@@ -5,7 +5,6 @@
 
 <widget class="GtkWindow" id="mainWindow">
   <property agent="glademm" name="cxx_visibility">public</property>
-  <property name="visible">True</property>
   <property name="events">GDK_BUTTON_PRESS_MASK</property>
   <property name="title" translatable="yes">Pinot</property>
   <property name="type">GTK_WINDOW_TOPLEVEL</property>
@@ -2610,390 +2609,6 @@
   </child>
 </widget>
 
-<widget class="GtkDialog" id="importDialog">
-  <property agent="glademm" name="cxx_visibility">public</property>
-  <property name="visible">True</property>
-  <property name="title" translatable="yes">Import document</property>
-  <property name="type">GTK_WINDOW_TOPLEVEL</property>
-  <property name="window_position">GTK_WIN_POS_NONE</property>
-  <property name="modal">False</property>
-  <property name="resizable">True</property>
-  <property name="destroy_with_parent">False</property>
-  <property name="decorated">True</property>
-  <property name="skip_taskbar_hint">False</property>
-  <property name="skip_pager_hint">False</property>
-  <property name="type_hint">GDK_WINDOW_TYPE_HINT_NORMAL</property>
-  <property name="gravity">GDK_GRAVITY_NORTH_WEST</property>
-  <property name="focus_on_map">True</property>
-  <property name="has_separator">True</property>
-
-  <child internal-child="vbox">
-    <widget class="GtkVBox" id="dialog-vbox4">
-      <property name="visible">True</property>
-      <property name="homogeneous">False</property>
-      <property name="spacing">0</property>
-
-      <child internal-child="action_area">
-	<widget class="GtkHButtonBox" id="dialog-action_area4">
-	  <property name="visible">True</property>
-	  <property name="layout_style">GTK_BUTTONBOX_END</property>
-
-	  <child>
-	    <widget class="GtkButton" id="cancelbutton1">
-	      <property name="visible">True</property>
-	      <property name="can_default">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="label">gtk-cancel</property>
-	      <property name="use_stock">True</property>
-	      <property name="relief">GTK_RELIEF_NORMAL</property>
-	      <property name="focus_on_click">True</property>
-	      <property name="response_id">-6</property>
-	    </widget>
-	  </child>
-
-	  <child>
-	    <widget class="GtkButton" id="importOkButton">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="can_default">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="label">gtk-ok</property>
-	      <property name="use_stock">True</property>
-	      <property name="relief">GTK_RELIEF_NORMAL</property>
-	      <property name="focus_on_click">True</property>
-	      <property name="response_id">-5</property>
-	      <signal name="clicked" handler="on_importOkButton_clicked" last_modification_time="Sun, 18 Sep 2005 05:13:29 GMT"/>
-	    </widget>
-	  </child>
-	</widget>
-	<packing>
-	  <property name="padding">0</property>
-	  <property name="expand">False</property>
-	  <property name="fill">True</property>
-	  <property name="pack_type">GTK_PACK_END</property>
-	</packing>
-      </child>
-
-      <child>
-	<widget class="GtkTable" id="docTable">
-	  <property agent="glademm" name="cxx_visibility">protected</property>
-	  <property name="visible">True</property>
-	  <property name="n_rows">4</property>
-	  <property name="n_columns">3</property>
-	  <property name="homogeneous">False</property>
-	  <property name="row_spacing">0</property>
-	  <property name="column_spacing">0</property>
-
-	  <child>
-	    <widget class="GtkHButtonBox" id="hbuttonbox3">
-	      <property name="visible">True</property>
-	      <property name="layout_style">GTK_BUTTONBOX_DEFAULT_STYLE</property>
-	      <property name="spacing">0</property>
-
-	      <child>
-		<widget class="GtkButton" id="selectButton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_default">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="relief">GTK_RELIEF_NORMAL</property>
-		  <property name="focus_on_click">True</property>
-		  <signal name="clicked" handler="on_selectButton_clicked" last_modification_time="Tue, 09 Mar 2004 19:27:45 GMT"/>
-
-		  <child>
-		    <widget class="GtkAlignment" id="alignment9">
-		      <property name="visible">True</property>
-		      <property name="xalign">0.5</property>
-		      <property name="yalign">0.5</property>
-		      <property name="xscale">0</property>
-		      <property name="yscale">0</property>
-		      <property name="top_padding">0</property>
-		      <property name="bottom_padding">0</property>
-		      <property name="left_padding">0</property>
-		      <property name="right_padding">0</property>
-
-		      <child>
-			<widget class="GtkHBox" id="hbox14">
-			  <property name="visible">True</property>
-			  <property name="homogeneous">False</property>
-			  <property name="spacing">2</property>
-
-			  <child>
-			    <widget class="GtkImage" id="image180">
-			      <property name="visible">True</property>
-			      <property name="stock">gtk-open</property>
-			      <property name="icon_size">4</property>
-			      <property name="xalign">0.5</property>
-			      <property name="yalign">0.5</property>
-			      <property name="xpad">0</property>
-			      <property name="ypad">0</property>
-			    </widget>
-			    <packing>
-			      <property name="padding">0</property>
-			      <property name="expand">False</property>
-			      <property name="fill">False</property>
-			    </packing>
-			  </child>
-
-			  <child>
-			    <widget class="GtkLabel" id="label17">
-			      <property name="visible">True</property>
-			      <property name="label" translatable="yes">Select</property>
-			      <property name="use_underline">True</property>
-			      <property name="use_markup">False</property>
-			      <property name="justify">GTK_JUSTIFY_LEFT</property>
-			      <property name="wrap">False</property>
-			      <property name="selectable">False</property>
-			      <property name="xalign">0.5</property>
-			      <property name="yalign">0.5</property>
-			      <property name="xpad">0</property>
-			      <property name="ypad">0</property>
-			      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-			      <property name="width_chars">-1</property>
-			      <property name="single_line_mode">False</property>
-			      <property name="angle">0</property>
-			    </widget>
-			    <packing>
-			      <property name="padding">0</property>
-			      <property name="expand">False</property>
-			      <property name="fill">False</property>
-			    </packing>
-			  </child>
-			</widget>
-		      </child>
-		    </widget>
-		  </child>
-		</widget>
-	      </child>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">2</property>
-	      <property name="right_attach">3</property>
-	      <property name="top_attach">3</property>
-	      <property name="bottom_attach">4</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkEntry" id="locationEntry">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="editable">True</property>
-	      <property name="visibility">True</property>
-	      <property name="max_length">0</property>
-	      <property name="text" translatable="yes"></property>
-	      <property name="has_frame">True</property>
-	      <property name="invisible_char">*</property>
-	      <property name="activates_default">False</property>
-	      <signal name="changed" handler="on_locationEntry_changed" last_modification_time="Sun, 18 Sep 2005 03:55:37 GMT"/>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">1</property>
-	      <property name="right_attach">2</property>
-	      <property name="top_attach">3</property>
-	      <property name="bottom_attach">4</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkEntry" id="titleEntry">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="editable">True</property>
-	      <property name="visibility">True</property>
-	      <property name="max_length">0</property>
-	      <property name="text" translatable="yes"></property>
-	      <property name="has_frame">True</property>
-	      <property name="invisible_char">*</property>
-	      <property name="activates_default">False</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">1</property>
-	      <property name="right_attach">2</property>
-	      <property name="top_attach">1</property>
-	      <property name="bottom_attach">2</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="locationLabel">
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Location:</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">0</property>
-	      <property name="right_attach">1</property>
-	      <property name="top_attach">3</property>
-	      <property name="bottom_attach">4</property>
-	      <property name="x_options">fill</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="titleLabel">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Title:</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">0</property>
-	      <property name="right_attach">1</property>
-	      <property name="top_attach">1</property>
-	      <property name="bottom_attach">2</property>
-	      <property name="x_options">fill</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="depthLabel">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Maximum depth:</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">0</property>
-	      <property name="right_attach">1</property>
-	      <property name="top_attach">2</property>
-	      <property name="bottom_attach">3</property>
-	      <property name="x_options">fill</property>
-	      <property name="y_options"></property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkSpinButton" id="depthSpinbutton">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="climb_rate">1</property>
-	      <property name="digits">0</property>
-	      <property name="numeric">False</property>
-	      <property name="update_policy">GTK_UPDATE_ALWAYS</property>
-	      <property name="snap_to_ticks">False</property>
-	      <property name="wrap">False</property>
-	      <property name="adjustment">0 0 100 1 5 5</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">1</property>
-	      <property name="right_attach">2</property>
-	      <property name="top_attach">2</property>
-	      <property name="bottom_attach">3</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkComboBox" id="typeCombobox">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="items" translatable="yes"></property>
-	      <property name="add_tearoffs">False</property>
-	      <property name="focus_on_click">True</property>
-	      <signal name="changed" handler="on_typeCombobox_changed" last_modification_time="Sun, 18 Sep 2005 04:09:29 GMT"/>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">1</property>
-	      <property name="right_attach">2</property>
-	      <property name="top_attach">0</property>
-	      <property name="bottom_attach">1</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="typeLabel">
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Type:</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">0</property>
-	      <property name="right_attach">1</property>
-	      <property name="top_attach">0</property>
-	      <property name="bottom_attach">1</property>
-	      <property name="x_options">fill</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-	</widget>
-	<packing>
-	  <property name="padding">0</property>
-	  <property name="expand">True</property>
-	  <property name="fill">True</property>
-	</packing>
-      </child>
-    </widget>
-  </child>
-</widget>
-
 <widget class="GtkDialog" id="propertiesDialog">
   <property agent="glademm" name="cxx_visibility">public</property>
   <property name="visible">True</property>
@@ -3682,4 +3297,387 @@
   </child>
 </widget>
 
+<widget class="GtkDialog" id="importDialog">
+  <property name="visible">True</property>
+  <property name="title" translatable="yes">Import document</property>
+  <property name="type">GTK_WINDOW_TOPLEVEL</property>
+  <property name="window_position">GTK_WIN_POS_NONE</property>
+  <property name="modal">False</property>
+  <property name="resizable">True</property>
+  <property name="destroy_with_parent">False</property>
+  <property name="decorated">True</property>
+  <property name="skip_taskbar_hint">False</property>
+  <property name="skip_pager_hint">False</property>
+  <property name="type_hint">GDK_WINDOW_TYPE_HINT_DIALOG</property>
+  <property name="gravity">GDK_GRAVITY_NORTH_WEST</property>
+  <property name="focus_on_map">True</property>
+  <property name="has_separator">True</property>
+
+  <child internal-child="vbox">
+    <widget class="GtkVBox" id="dialog-vbox7">
+      <property name="visible">True</property>
+      <property name="homogeneous">False</property>
+      <property name="spacing">0</property>
+
+      <child internal-child="action_area">
+	<widget class="GtkHButtonBox" id="dialog-action_area7">
+	  <property name="visible">True</property>
+	  <property name="layout_style">GTK_BUTTONBOX_END</property>
+
+	  <child>
+	    <widget class="GtkButton" id="importButton">
+	      <property agent="glademm" name="cxx_visibility">protected</property>
+	      <property name="visible">True</property>
+	      <property name="can_default">True</property>
+	      <property name="can_focus">True</property>
+	      <property name="label" translatable="yes">Import</property>
+	      <property name="use_underline">True</property>
+	      <property name="relief">GTK_RELIEF_NORMAL</property>
+	      <property name="focus_on_click">True</property>
+	      <property name="response_id">0</property>
+	      <signal name="clicked" handler="on_importButton_clicked" last_modification_time="Mon, 02 Jan 2006 02:49:48 GMT"/>
+	    </widget>
+	  </child>
+
+	  <child>
+	    <widget class="GtkButton" id="closeButton">
+	      <property name="visible">True</property>
+	      <property name="can_default">True</property>
+	      <property name="can_focus">True</property>
+	      <property name="label">gtk-close</property>
+	      <property name="use_stock">True</property>
+	      <property name="relief">GTK_RELIEF_NORMAL</property>
+	      <property name="focus_on_click">True</property>
+	      <property name="response_id">-7</property>
+	    </widget>
+	  </child>
+	</widget>
+	<packing>
+	  <property name="padding">0</property>
+	  <property name="expand">False</property>
+	  <property name="fill">True</property>
+	  <property name="pack_type">GTK_PACK_END</property>
+	</packing>
+      </child>
+
+      <child>
+	<widget class="GtkTable" id="docTable">
+	  <property agent="glademm" name="cxx_visibility">protected</property>
+	  <property name="visible">True</property>
+	  <property name="n_rows">4</property>
+	  <property name="n_columns">3</property>
+	  <property name="homogeneous">False</property>
+	  <property name="row_spacing">0</property>
+	  <property name="column_spacing">0</property>
+
+	  <child>
+	    <widget class="GtkHButtonBox" id="hbuttonbox4">
+	      <property name="visible">True</property>
+	      <property name="layout_style">GTK_BUTTONBOX_DEFAULT_STYLE</property>
+	      <property name="spacing">0</property>
+
+	      <child>
+		<widget class="GtkButton" id="selectButton">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_default">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="relief">GTK_RELIEF_NORMAL</property>
+		  <property name="focus_on_click">True</property>
+		  <signal name="clicked" handler="on_selectButton_clicked" last_modification_time="Tue, 09 Mar 2004 19:27:45 GMT"/>
+
+		  <child>
+		    <widget class="GtkAlignment" id="alignment29">
+		      <property name="visible">True</property>
+		      <property name="xalign">0.5</property>
+		      <property name="yalign">0.5</property>
+		      <property name="xscale">0</property>
+		      <property name="yscale">0</property>
+		      <property name="top_padding">0</property>
+		      <property name="bottom_padding">0</property>
+		      <property name="left_padding">0</property>
+		      <property name="right_padding">0</property>
+
+		      <child>
+			<widget class="GtkHBox" id="hbox43">
+			  <property name="visible">True</property>
+			  <property name="homogeneous">False</property>
+			  <property name="spacing">2</property>
+
+			  <child>
+			    <widget class="GtkImage" id="image551">
+			      <property name="visible">True</property>
+			      <property name="stock">gtk-open</property>
+			      <property name="icon_size">4</property>
+			      <property name="xalign">0.5</property>
+			      <property name="yalign">0.5</property>
+			      <property name="xpad">0</property>
+			      <property name="ypad">0</property>
+			    </widget>
+			    <packing>
+			      <property name="padding">0</property>
+			      <property name="expand">False</property>
+			      <property name="fill">False</property>
+			    </packing>
+			  </child>
+
+			  <child>
+			    <widget class="GtkLabel" id="label50">
+			      <property name="visible">True</property>
+			      <property name="label" translatable="yes">Select</property>
+			      <property name="use_underline">True</property>
+			      <property name="use_markup">False</property>
+			      <property name="justify">GTK_JUSTIFY_LEFT</property>
+			      <property name="wrap">False</property>
+			      <property name="selectable">False</property>
+			      <property name="xalign">0.5</property>
+			      <property name="yalign">0.5</property>
+			      <property name="xpad">0</property>
+			      <property name="ypad">0</property>
+			      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+			      <property name="width_chars">-1</property>
+			      <property name="single_line_mode">False</property>
+			      <property name="angle">0</property>
+			    </widget>
+			    <packing>
+			      <property name="padding">0</property>
+			      <property name="expand">False</property>
+			      <property name="fill">False</property>
+			    </packing>
+			  </child>
+			</widget>
+		      </child>
+		    </widget>
+		  </child>
+		</widget>
+	      </child>
+	    </widget>
+	    <packing>
+	      <property name="left_attach">2</property>
+	      <property name="right_attach">3</property>
+	      <property name="top_attach">3</property>
+	      <property name="bottom_attach">4</property>
+	      <property name="x_padding">4</property>
+	      <property name="y_padding">4</property>
+	      <property name="y_options">fill</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkEntry" id="locationEntry">
+	      <property agent="glademm" name="cxx_visibility">protected</property>
+	      <property name="visible">True</property>
+	      <property name="can_focus">True</property>
+	      <property name="editable">True</property>
+	      <property name="visibility">True</property>
+	      <property name="max_length">0</property>
+	      <property name="text" translatable="yes"></property>
+	      <property name="has_frame">True</property>
+	      <property name="invisible_char">*</property>
+	      <property name="activates_default">False</property>
+	      <signal name="changed" handler="on_locationEntry_changed" last_modification_time="Sun, 18 Sep 2005 03:55:37 GMT"/>
+	    </widget>
+	    <packing>
+	      <property name="left_attach">1</property>
+	      <property name="right_attach">2</property>
+	      <property name="top_attach">3</property>
+	      <property name="bottom_attach">4</property>
+	      <property name="x_padding">4</property>
+	      <property name="y_padding">4</property>
+	      <property name="y_options">fill</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkEntry" id="titleEntry">
+	      <property agent="glademm" name="cxx_visibility">protected</property>
+	      <property name="visible">True</property>
+	      <property name="can_focus">True</property>
+	      <property name="editable">True</property>
+	      <property name="visibility">True</property>
+	      <property name="max_length">0</property>
+	      <property name="text" translatable="yes"></property>
+	      <property name="has_frame">True</property>
+	      <property name="invisible_char">*</property>
+	      <property name="activates_default">False</property>
+	    </widget>
+	    <packing>
+	      <property name="left_attach">1</property>
+	      <property name="right_attach">2</property>
+	      <property name="top_attach">1</property>
+	      <property name="bottom_attach">2</property>
+	      <property name="x_padding">4</property>
+	      <property name="y_padding">4</property>
+	      <property name="y_options">fill</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkLabel" id="locationLabel">
+	      <property name="visible">True</property>
+	      <property name="label" translatable="yes">Location:</property>
+	      <property name="use_underline">False</property>
+	      <property name="use_markup">False</property>
+	      <property name="justify">GTK_JUSTIFY_LEFT</property>
+	      <property name="wrap">False</property>
+	      <property name="selectable">False</property>
+	      <property name="xalign">0</property>
+	      <property name="yalign">0.5</property>
+	      <property name="xpad">4</property>
+	      <property name="ypad">4</property>
+	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+	      <property name="width_chars">-1</property>
+	      <property name="single_line_mode">False</property>
+	      <property name="angle">0</property>
+	    </widget>
+	    <packing>
+	      <property name="left_attach">0</property>
+	      <property name="right_attach">1</property>
+	      <property name="top_attach">3</property>
+	      <property name="bottom_attach">4</property>
+	      <property name="x_options">fill</property>
+	      <property name="y_options">fill</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkLabel" id="titleLabel">
+	      <property agent="glademm" name="cxx_visibility">protected</property>
+	      <property name="visible">True</property>
+	      <property name="label" translatable="yes">Title:</property>
+	      <property name="use_underline">False</property>
+	      <property name="use_markup">False</property>
+	      <property name="justify">GTK_JUSTIFY_LEFT</property>
+	      <property name="wrap">False</property>
+	      <property name="selectable">False</property>
+	      <property name="xalign">0</property>
+	      <property name="yalign">0.5</property>
+	      <property name="xpad">4</property>
+	      <property name="ypad">4</property>
+	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+	      <property name="width_chars">-1</property>
+	      <property name="single_line_mode">False</property>
+	      <property name="angle">0</property>
+	    </widget>
+	    <packing>
+	      <property name="left_attach">0</property>
+	      <property name="right_attach">1</property>
+	      <property name="top_attach">1</property>
+	      <property name="bottom_attach">2</property>
+	      <property name="x_options">fill</property>
+	      <property name="y_options">fill</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkLabel" id="depthLabel">
+	      <property agent="glademm" name="cxx_visibility">protected</property>
+	      <property name="visible">True</property>
+	      <property name="label" translatable="yes">Maximum depth:</property>
+	      <property name="use_underline">False</property>
+	      <property name="use_markup">False</property>
+	      <property name="justify">GTK_JUSTIFY_LEFT</property>
+	      <property name="wrap">False</property>
+	      <property name="selectable">False</property>
+	      <property name="xalign">0</property>
+	      <property name="yalign">0.5</property>
+	      <property name="xpad">4</property>
+	      <property name="ypad">4</property>
+	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+	      <property name="width_chars">-1</property>
+	      <property name="single_line_mode">False</property>
+	      <property name="angle">0</property>
+	    </widget>
+	    <packing>
+	      <property name="left_attach">0</property>
+	      <property name="right_attach">1</property>
+	      <property name="top_attach">2</property>
+	      <property name="bottom_attach">3</property>
+	      <property name="x_options">fill</property>
+	      <property name="y_options"></property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkSpinButton" id="depthSpinbutton">
+	      <property agent="glademm" name="cxx_visibility">protected</property>
+	      <property name="visible">True</property>
+	      <property name="can_focus">True</property>
+	      <property name="climb_rate">1</property>
+	      <property name="digits">0</property>
+	      <property name="numeric">False</property>
+	      <property name="update_policy">GTK_UPDATE_ALWAYS</property>
+	      <property name="snap_to_ticks">False</property>
+	      <property name="wrap">False</property>
+	      <property name="adjustment">0 0 100 1 5 5</property>
+	    </widget>
+	    <packing>
+	      <property name="left_attach">1</property>
+	      <property name="right_attach">2</property>
+	      <property name="top_attach">2</property>
+	      <property name="bottom_attach">3</property>
+	      <property name="x_padding">4</property>
+	      <property name="y_padding">4</property>
+	      <property name="y_options">fill</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkComboBox" id="typeCombobox">
+	      <property agent="glademm" name="cxx_visibility">protected</property>
+	      <property name="visible">True</property>
+	      <property name="items" translatable="yes"></property>
+	      <property name="add_tearoffs">False</property>
+	      <property name="focus_on_click">True</property>
+	      <signal name="changed" handler="on_typeCombobox_changed" last_modification_time="Sun, 18 Sep 2005 04:09:29 GMT"/>
+	    </widget>
+	    <packing>
+	      <property name="left_attach">1</property>
+	      <property name="right_attach">2</property>
+	      <property name="top_attach">0</property>
+	      <property name="bottom_attach">1</property>
+	      <property name="x_padding">4</property>
+	      <property name="y_padding">4</property>
+	      <property name="y_options">fill</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkLabel" id="typeLabel">
+	      <property name="visible">True</property>
+	      <property name="label" translatable="yes">Type:</property>
+	      <property name="use_underline">False</property>
+	      <property name="use_markup">False</property>
+	      <property name="justify">GTK_JUSTIFY_LEFT</property>
+	      <property name="wrap">False</property>
+	      <property name="selectable">False</property>
+	      <property name="xalign">0</property>
+	      <property name="yalign">0.5</property>
+	      <property name="xpad">4</property>
+	      <property name="ypad">4</property>
+	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+	      <property name="width_chars">-1</property>
+	      <property name="single_line_mode">False</property>
+	      <property name="angle">0</property>
+	    </widget>
+	    <packing>
+	      <property name="left_attach">0</property>
+	      <property name="right_attach">1</property>
+	      <property name="top_attach">0</property>
+	      <property name="bottom_attach">1</property>
+	      <property name="x_options">fill</property>
+	      <property name="y_options">fill</property>
+	    </packing>
+	  </child>
+	</widget>
+	<packing>
+	  <property name="padding">0</property>
+	  <property name="expand">True</property>
+	  <property name="fill">True</property>
+	</packing>
+      </child>
+    </widget>
+  </child>
+</widget>
+
 </glade-interface>

Modified: trunk/UI/GTK2/src/IndexTree.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexTree.cpp	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/IndexTree.cpp	2006-01-02 19:34:26 UTC (rev 47)
@@ -374,9 +374,9 @@
 }
 
 //
-// Sets a document's title.
+// Updates a document's properties.
 //
-void IndexTree::setDocumentTitle(unsigned int docId, const string &text)
+void IndexTree::updateDocumentInfo(unsigned int docId, const DocumentInfo &docInfo)
 {
 	if (docId == 0)
 	{
@@ -391,10 +391,10 @@
 
 		if (docId == row[m_indexColumns.m_id])
 		{
-#ifdef DEBUG
-			cout << "IndexTree::setLabel: updating title of document " << docId << endl;
-#endif
-			row[m_indexColumns.m_text] = to_utf8(text);
+			row[m_indexColumns.m_text] = to_utf8(docInfo.getTitle());
+			row[m_indexColumns.m_type] = to_utf8(docInfo.getType());
+			row[m_indexColumns.m_language] = to_utf8(docInfo.getLanguage());
+			row[m_indexColumns.m_timestamp] = to_utf8(docInfo.getTimestamp());
 			break;
 		}
 	}

Modified: trunk/UI/GTK2/src/IndexTree.h
===================================================================
--- trunk/UI/GTK2/src/IndexTree.h	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/IndexTree.h	2006-01-02 19:34:26 UTC (rev 47)
@@ -67,8 +67,8 @@
 		/// Sets the documents that match the current label.
 		void setLabel(const std::set<unsigned int> &documentsList);
 
-		/// Sets a document's title.
-		void setDocumentTitle(unsigned int docId, const std::string &text);
+		/// Updates a document's properties.
+		void updateDocumentInfo(unsigned int docId, const DocumentInfo &docInfo);
 
 		/// Marks a document as labeled.
 		void setDocumentLabeledState(unsigned int docId, bool labeled);

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-02 19:34:26 UTC (rev 47)
@@ -852,6 +852,9 @@
 			{
 				// Flush the index
 				index.flush();
+
+				// The document properties may have changed
+				index.getDocumentInfo(m_docId, m_docInfo);
 			}
 		}
 

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-02 19:34:26 UTC (rev 47)
@@ -24,7 +24,6 @@
 using namespace std;
 using namespace SigC;
 using namespace Glib;
-using namespace Gdk;
 using namespace Gtk;
 
 string importDialog::m_directory = "";
@@ -74,9 +73,9 @@
 		depthSpinbutton->set_value(m_maxDirLevel);
 	}
 
-	// Disable the OK button as long the location entry field is empty
+	// Disable this button as long the location entry field is empty
 	// The title field may remain empty
-	importOkButton->set_sensitive(false);
+	importButton->set_sensitive(false);
 }
 
 importDialog::~importDialog()
@@ -149,7 +148,10 @@
 			if (pEntryName != NULL)
 			{
 				string location = fileName;
-				location += "/";
+				if (fileName[fileName.length() - 1] != '/')
+				{
+					location += "/";
+				}
 				location += pEntryName;
 
 				// Scan this entry
@@ -170,10 +172,8 @@
 		}
 		closedir(pDir);
 	}
-	else	if (S_ISREG(fileStat.st_mode))
+	else if (S_ISREG(fileStat.st_mode))
 	{
-		// Get the MIME type
-		string mimeType = MIMEScanner::scanFile(fileName);
 		// Build a valid URL
 		string location = "file://";
 		location += fileName;
@@ -185,12 +185,21 @@
 			title += urlObj.getFile();
 		}
 
-		// Fire up the signal
-		m_signalImportFile(DocumentInfo(title, location, mimeType, ""));
-		++m_docsCount;
+		DocumentInfo docInfo(title, location,
+			MIMEScanner::scanFile(fileName), "");
+
+		import_file(urlObj.getFile(), docInfo);
 	}
 }
 
+void importDialog::import_file(const string &fileName,
+	const DocumentInfo &docInfo)
+{
+	// Fire up the signal
+	m_signalImportFile(docInfo);
+	++m_docsCount;
+}
+
 ustring importDialog::getDocumentTitle(void)
 {
 	return m_title;
@@ -206,11 +215,13 @@
 	return m_signalImportFile;
 }
 
-void importDialog::on_importOkButton_clicked()
+void importDialog::on_importButton_clicked()
 {
 	string location = locale_from_utf8(locationEntry->get_text());
 	unsigned int level = 0;
 
+	importButton->set_sensitive(false);
+
 	// Title
 	m_title = titleEntry->get_text();
 	// Type
@@ -222,7 +233,7 @@
 			// Update m_directory
 			m_directory = location.substr(0, pos + 1);
 #ifdef DEBUG
-			cout << "importDialog::on_importOkButton_clicked: directory now " << m_directory << endl;
+			cout << "importDialog::on_importButton_clicked: directory now " << m_directory << endl;
 #endif
 		}
 
@@ -234,11 +245,10 @@
 	else
 	{
 		Url urlObj(location);
+		DocumentInfo docInfo(locale_from_utf8(m_title), location,
+			MIMEScanner::scanUrl(urlObj), "");
 
-		// Signal now
-		m_signalImportFile(DocumentInfo(locale_from_utf8(m_title), location,
-			MIMEScanner::scanUrl(urlObj), ""));
-		++m_docsCount;
+		import_file(urlObj.getFile(), docInfo);
 	}
 }
 
@@ -299,7 +309,7 @@
 		enableOk = false;
 	}
 
-	importOkButton->set_sensitive(enableOk);
+	importButton->set_sensitive(enableOk);
 }
 
 void importDialog::on_typeCombobox_changed()

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/importDialog.hh	2006-01-02 19:34:26 UTC (rev 47)
@@ -17,6 +17,7 @@
 #include <sigc++/slot.h>
 #include <glibmm/refptr.h>
 #include <glibmm/ustring.h>
+#include <gtkmm/button.h>
 #include <gtkmm/liststore.h>
 
 #include "DocumentInfo.h"
@@ -42,6 +43,8 @@
 protected:
 	void populate_combobox(bool allowLocalOnly);
 	void scan_file(const std::string &fileName, unsigned int &level);
+	void import_file(const std::string &fileName,
+		const DocumentInfo &docInfo);
 
 private:
 	ComboModelColumns m_typeColumns;
@@ -53,7 +56,7 @@
 	SigC::Signal1<void, DocumentInfo> m_signalImportFile;
 	static std::string m_directory;
 
-	virtual void on_importOkButton_clicked();
+	virtual void on_importButton_clicked();
 	virtual void on_selectButton_clicked();
 	virtual void on_locationEntry_changed();
 	virtual void on_typeCombobox_changed();

Modified: trunk/UI/GTK2/src/importDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-02 19:34:26 UTC (rev 47)
@@ -1,8 +1,8 @@
-// generated 2005/11/6 16:43:41 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/1/2 11:20:27 SGT by fabrice at thorgrim.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/metase/UI/GTK2/metase-gtk2.glade
+// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
 // for gtk 2.6.10 and gtkmm 2.6.2
 //
 // Please modify the corresponding derived classes in ./src/importDialog.cc
@@ -54,19 +54,20 @@
 
 importDialog_glade::importDialog_glade(
 )
-{  importDialog = this;
+{  
+   
+   Gtk::Dialog *importDialog = this;
    gmm_data = new GlademmData(get_accel_group());
+   importButton = Gtk::manage(new class Gtk::Button(_("Import")));
    
-   Gtk::Button *cancelbutton1 = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-cancel")));
-   importOkButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-ok")));
-   
-   Gtk::Image *image180 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(4)));
-   Gtk::Label *label17 = Gtk::manage(new class Gtk::Label(_("Select")));
-   Gtk::HBox *hbox14 = Gtk::manage(new class Gtk::HBox(false, 2));
-   Gtk::Alignment *alignment9 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
+   Gtk::Button *closeButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-close")));
+   Gtk::Image *image551 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(4)));
+   Gtk::Label *label50 = Gtk::manage(new class Gtk::Label(_("Select")));
+   Gtk::HBox *hbox43 = Gtk::manage(new class Gtk::HBox(false, 2));
+   Gtk::Alignment *alignment29 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
    selectButton = Gtk::manage(new class Gtk::Button());
    
-   Gtk::HButtonBox *hbuttonbox3 = Gtk::manage(new class Gtk::HButtonBox(Gtk::BUTTONBOX_DEFAULT_STYLE, 0));
+   Gtk::HButtonBox *hbuttonbox4 = Gtk::manage(new class Gtk::HButtonBox(Gtk::BUTTONBOX_DEFAULT_STYLE, 0));
    locationEntry = Gtk::manage(new class Gtk::Entry());
    titleEntry = Gtk::manage(new class Gtk::Entry());
    
@@ -80,39 +81,41 @@
    
    Gtk::Label *typeLabel = Gtk::manage(new class Gtk::Label(_("Type:")));
    docTable = Gtk::manage(new class Gtk::Table(2, 2, false));
-   cancelbutton1->set_flags(Gtk::CAN_FOCUS);
-   cancelbutton1->set_flags(Gtk::CAN_DEFAULT);
-   cancelbutton1->set_relief(Gtk::RELIEF_NORMAL);
-   importOkButton->set_flags(Gtk::CAN_FOCUS);
-   importOkButton->set_flags(Gtk::CAN_DEFAULT);
-   importOkButton->set_relief(Gtk::RELIEF_NORMAL);
+   importButton->set_flags(Gtk::CAN_FOCUS);
+   importButton->set_flags(Gtk::CAN_DEFAULT);
+   importButton->set_relief(Gtk::RELIEF_NORMAL);
+   closeButton->set_flags(Gtk::CAN_FOCUS);
+   closeButton->set_flags(Gtk::CAN_DEFAULT);
+   closeButton->set_relief(Gtk::RELIEF_NORMAL);
    importDialog->get_action_area()->property_layout_style().set_value(Gtk::BUTTONBOX_END);
-   image180->set_alignment(0.5,0.5);
-   image180->set_padding(0,0);
-   label17->set_alignment(0.5,0.5);
-   label17->set_padding(0,0);
-   label17->set_justify(Gtk::JUSTIFY_LEFT);
-   label17->set_line_wrap(false);
-   label17->set_use_markup(false);
-   label17->set_selectable(false);
-   hbox14->pack_start(*image180, Gtk::PACK_SHRINK, 0);
-   hbox14->pack_start(*label17, Gtk::PACK_SHRINK, 0);
-   alignment9->add(*hbox14);
+   image551->set_alignment(0.5,0.5);
+   image551->set_padding(0,0);
+   label50->set_alignment(0.5,0.5);
+   label50->set_padding(0,0);
+   label50->set_justify(Gtk::JUSTIFY_LEFT);
+   label50->set_line_wrap(false);
+   label50->set_use_markup(false);
+   label50->set_selectable(false);
+   hbox43->pack_start(*image551, Gtk::PACK_SHRINK, 0);
+   hbox43->pack_start(*label50, Gtk::PACK_SHRINK, 0);
+   alignment29->add(*hbox43);
    selectButton->set_flags(Gtk::CAN_FOCUS);
    selectButton->set_flags(Gtk::CAN_DEFAULT);
    selectButton->set_relief(Gtk::RELIEF_NORMAL);
-   selectButton->add(*alignment9);
-   hbuttonbox3->pack_start(*selectButton);
+   selectButton->add(*alignment29);
+   hbuttonbox4->pack_start(*selectButton);
    locationEntry->set_flags(Gtk::CAN_FOCUS);
    locationEntry->set_visibility(true);
    locationEntry->set_editable(true);
    locationEntry->set_max_length(0);
+   locationEntry->set_text(_(""));
    locationEntry->set_has_frame(true);
    locationEntry->set_activates_default(false);
    titleEntry->set_flags(Gtk::CAN_FOCUS);
    titleEntry->set_visibility(true);
    titleEntry->set_editable(true);
    titleEntry->set_max_length(0);
+   titleEntry->set_text(_(""));
    titleEntry->set_has_frame(true);
    titleEntry->set_activates_default(false);
    locationLabel->set_alignment(0,0.5);
@@ -146,7 +149,7 @@
    typeLabel->set_selectable(false);
    docTable->set_row_spacings(0);
    docTable->set_col_spacings(0);
-   docTable->attach(*hbuttonbox3, 2, 3, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   docTable->attach(*hbuttonbox4, 2, 3, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable->attach(*locationEntry, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable->attach(*titleEntry, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable->attach(*locationLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 0, 0);
@@ -164,16 +167,16 @@
    importDialog->set_resizable(true);
    importDialog->property_destroy_with_parent().set_value(false);
    importDialog->set_has_separator(true);
-   importDialog->add_action_widget(*cancelbutton1, -6);
-   importDialog->add_action_widget(*importOkButton, -5);
-   cancelbutton1->show();
-   importOkButton->show();
-   image180->show();
-   label17->show();
-   hbox14->show();
-   alignment9->show();
+   importDialog->add_action_widget(*importButton, 0);
+   importDialog->add_action_widget(*closeButton, -7);
+   importButton->show();
+   closeButton->show();
+   image551->show();
+   label50->show();
+   hbox43->show();
+   alignment29->show();
    selectButton->show();
-   hbuttonbox3->show();
+   hbuttonbox4->show();
    locationEntry->show();
    titleEntry->show();
    locationLabel->show();
@@ -184,7 +187,7 @@
    typeLabel->show();
    docTable->show();
    importDialog->show();
-   importOkButton->signal_clicked().connect(SigC::slot(*this, &importDialog_glade::on_importOkButton_clicked), false);
+   importButton->signal_clicked().connect(SigC::slot(*this, &importDialog_glade::on_importButton_clicked), false);
    selectButton->signal_clicked().connect(SigC::slot(*this, &importDialog_glade::on_selectButton_clicked), false);
    locationEntry->signal_changed().connect(SigC::slot(*this, &importDialog_glade::on_locationEntry_changed), false);
    typeCombobox->signal_changed().connect(SigC::slot(*this, &importDialog_glade::on_typeCombobox_changed), false);

Modified: trunk/UI/GTK2/src/importDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-02 19:34:26 UTC (rev 47)
@@ -1,8 +1,8 @@
-// generated 2005/11/6 16:25:47 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/1/2 11:20:27 SGT by fabrice at thorgrim.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/metase/UI/GTK2/metase-gtk2.glade
+// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
 // for gtk 2.6.10 and gtkmm 2.6.2
 //
 // Please modify the corresponding derived classes in ./src/importDialog.hh and./src/importDialog.cc
@@ -43,10 +43,8 @@
 {  
         
         GlademmData *gmm_data;
-public:
-        class Gtk::Dialog * importDialog;
 protected:
-        class Gtk::Button * importOkButton;
+        class Gtk::Button * importButton;
         class Gtk::Button * selectButton;
         class Gtk::Entry * locationEntry;
         class Gtk::Entry * titleEntry;
@@ -60,7 +58,7 @@
         
         ~importDialog_glade();
 private:
-        virtual void on_importOkButton_clicked() = 0;
+        virtual void on_importButton_clicked() = 0;
         virtual void on_selectButton_clicked() = 0;
         virtual void on_locationEntry_changed() = 0;
         virtual void on_typeCombobox_changed() = 0;

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-02 19:34:26 UTC (rev 47)
@@ -74,6 +74,7 @@
 unsigned int mainWindow::m_maxThreads = 2;
 
 mainWindow::InternalState::InternalState() :
+	m_liveQueryLength(0),
 	m_currentPage(0),
 	m_backgroundThreads(0),
 	m_browsingIndex(false)
@@ -1125,7 +1126,7 @@
 			if (pIndexTree != NULL)
 			{
 				// Update the index tree
-				pIndexTree->setDocumentTitle(docId, docInfo.getTitle());
+				pIndexTree->updateDocumentInfo(docId, docInfo);
 			}
 		}
 		else
@@ -1209,8 +1210,8 @@
 			IndexTree *pIndexTree = pIndexPage->getTree();
 			if (pIndexTree != NULL)
 			{
-				pIndexTree->setDocumentTitle(pUpdateThread->getDocumentID(),
-					pUpdateThread->getDocumentInfo().getTitle());
+				pIndexTree->updateDocumentInfo(pUpdateThread->getDocumentID(),
+					pUpdateThread->getDocumentInfo());
 			}
 		}
 
@@ -2260,7 +2261,6 @@
 			m_pEnginesTree->populate();
 		}
 	}
-
 }
 
 //
@@ -2269,17 +2269,20 @@
 void mainWindow::on_liveQueryEntry_changed()
 {
 	ustring liveQuery = liveQueryEntry->get_text();
+	unsigned int liveQueryLength = liveQuery.length();
 
 	// Reset the list
 	m_refLiveQueryList->clear();
 
-	if (m_refLiveQueryCompletion->get_minimum_key_length() > liveQuery.length())
+	// If characters are being deleted or if the string is too short, don't
+	// attempt to offer suggestions
+	if ((m_state.m_liveQueryLength > liveQueryLength) ||
+		(m_refLiveQueryCompletion->get_minimum_key_length() > liveQueryLength))
 	{
-#ifdef DEBUG
-		cout << "mainWindow::on_liveQueryEntry_changed: too short" << endl;
-#endif
+		m_state.m_liveQueryLength = liveQueryLength;
 		return;
 	}
+	m_state.m_liveQueryLength = liveQueryLength;
 
 	// FIXME: relying on other indices may also be useful
 	XapianIndex docsIndex(m_settings.m_indexLocation);

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-01-02 19:34:26 UTC (rev 47)
@@ -176,6 +176,8 @@
 			bool writeLock(unsigned int where);
 			void unlock(void);
 
+			// Query
+			unsigned int m_liveQueryLength;
 			// Notebook pages
 			int m_currentPage;
 			// Worker threads

Modified: trunk/UI/GTK2/src/mainWindow_glade.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.cc	2006-01-02 19:30:57 UTC (rev 46)
+++ trunk/UI/GTK2/src/mainWindow_glade.cc	2006-01-02 19:34:26 UTC (rev 47)
@@ -1,4 +1,4 @@
-// generated 2006/1/1 8:46:21 SGT by fabrice at thorgrim.dyndns.org.(none)
+// generated 2006/1/2 11:20:25 SGT by fabrice at thorgrim.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -427,7 +427,6 @@
    mainStatusbar->show();
    mainHbox->show();
    vbox1->show();
-   mainWindow->show();
    configure1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_configure_activate), false);
    quit1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_quit_activate), false);
    cut1->signal_activate().connect(SigC::slot(*this, &mainWindow_glade::on_cut_activate), false);



From fabricecolin at berlios.de  Tue Jan  3 14:12:16 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 3 Jan 2006 14:12:16 +0100
Subject: [Pinot-svn] r49 - in trunk: SQL UI/GTK2/src Utils
Message-ID: <200601031312.k03DCGoV025999@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-03 14:12:11 +0100 (Tue, 03 Jan 2006)
New Revision: 49

Removed:
   trunk/SQL/ActionHistory.cpp
   trunk/SQL/ActionHistory.h
Modified:
   trunk/SQL/Makefile
   trunk/SQL/historytest.cpp
   trunk/UI/GTK2/src/IndexPage.cpp
   trunk/UI/GTK2/src/IndexPage.h
   trunk/UI/GTK2/src/PinotUtils.cpp
   trunk/UI/GTK2/src/PinotUtils.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/pinot.cc
   trunk/Utils/DocumentInfo.cpp
   trunk/Utils/IndexedDocument.cpp
Log:
Dropped ActionHistory. Fixed issue with threads' end signaling. Don't append
to the index tree unless the last documents page is being shown and is not
empty.


Deleted: trunk/SQL/ActionHistory.cpp
===================================================================
--- trunk/SQL/ActionHistory.cpp	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/SQL/ActionHistory.cpp	2006-01-03 13:12:11 UTC (rev 49)
@@ -1,127 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <unistd.h>
-#include <iostream>
-
-#include "Url.h"
-#include "TimeConverter.h"
-#include "ActionHistory.h"
-
-ActionHistory::ActionHistory(const string &database) :
-	SQLiteBase(database)
-{
-}
-
-ActionHistory::~ActionHistory()
-{
-}
-
-/// Creates the ActionHistory table in the database.
-bool ActionHistory::create(const string &database)
-{
-	bool success = true;
-
-	// The specified path must be a file
-	if (SQLiteBase::check(database) == false)
-	{
-		return false;
-	}
-
-	SQLiteBase db(database);
-
-	// Does ActionHistory exist ?
-	if (db.executeSimpleStatement("SELECT * FROM ActionHistory LIMIT 1;") == false)
-	{
-#ifdef DEBUG
-		cout << "ActionHistory::create: ActionHistory doesn't exist" << endl;
-#endif
-		// Create the table
-		if (db.executeSimpleStatement("CREATE TABLE ActionHistory (Type UNSIGNED INT NOT NULL, Date TIMESTAMP, Option TEXT, PRIMARY KEY(Type, Option));") == false)
-		{
-			success = false;
-		}
-	}
-
-	return success;
-}
-
-/// Inserts an item.
-bool ActionHistory::insertItem(ActionType type, const string &option)
-{
-	string date = TimeConverter::toTimestamp(time(NULL));
-	bool success = false;
-
-	SQLiteResults *results = executeStatement("INSERT INTO ActionHistory \
-		VALUES(%u, '%q', '%q');", (unsigned int)type, date.c_str(), option.c_str());
-	if (results != NULL)
-	{
-		success = true;
-		delete results;
-	}
-
-	return success;
-}
-
-/// Gets and deletes the oldest item.
-bool ActionHistory::deleteOldestItem(ActionType &type, string &option)
-{
-	string date;
-	bool success = false;
-
-	if (getOldestItem(type, date, option) == false)
-	{
-		return false;
-	}
-
-	// Delete from ActionHistory
-	SQLiteResults *results = executeStatement("DELETE FROM ActionHistory \
-		WHERE Type=%u AND Option='%q';", (unsigned int)type, option.c_str());
-	if (results != NULL)
-	{
-		success = true;
-		delete results;
-	}
-
-	return success;
-}
-
-bool ActionHistory::getOldestItem(ActionType &type, string &date, string &option) const
-{
-	bool success = false;
-
-	SQLiteResults *results = executeStatement("SELECT Type, Date, Option \
-		FROM ActionHistory ORDER BY %s DESC LIMIT 1", "Date");
-	if (results != NULL)
-	{
-		SQLiteRow *row = results->nextRow();
-		if (row != NULL)
-		{
-			type = (ActionType)atoi(row->getColumn(0).c_str());
-			date = row->getColumn(1);
-			option = row->getColumn(2);
-			success = true;
-
-			delete row;
-		}
-
-		delete results;
-	}
-
-	return success;
-}

Deleted: trunk/SQL/ActionHistory.h
===================================================================
--- trunk/SQL/ActionHistory.h	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/SQL/ActionHistory.h	2006-01-03 13:12:11 UTC (rev 49)
@@ -1,52 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#ifndef _ACTION_HISTORY_H
-#define _ACTION_HISTORY_H
-
-#include <string>
-
-#include "SQLiteBase.h"
-
-using namespace std;
-
-class ActionHistory : public SQLiteBase
-{
-	public:
-		ActionHistory(const string &database);
-		virtual ~ActionHistory();
-
-		/// Creates the ActionHistory table in the database.
-		static bool create(const string &database);
-
-		typedef enum { ACTION_INDEX = 0, ACTION_UPDATE, ACTION_UNINDEX } ActionType;
-
-		/// Inserts an item.
-		bool insertItem(ActionType type, const string &option);
-
-		/// Gets and deletes the oldest item.
-		bool deleteOldestItem(ActionType &type, string &option);
-
-	protected:
-		bool getOldestItem(ActionType &type, string &date, string &option) const;
-
-	private:
-		ActionHistory(const ActionHistory &other);
-		ActionHistory &operator=(const ActionHistory &other);
-
-};
-
-#endif // _ACTION_HISTORY_H

Modified: trunk/SQL/Makefile
===================================================================
--- trunk/SQL/Makefile	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/SQL/Makefile	2006-01-03 13:12:11 UTC (rev 49)
@@ -2,7 +2,7 @@
 ROOT_DIR = ..
 include ${ROOT_DIR}/variables.mk
 
-SQL_SRCS = SQLiteBase.cpp ActionHistory.cpp QueryHistory.cpp ViewHistory.cpp
+SQL_SRCS = SQLiteBase.cpp QueryHistory.cpp ViewHistory.cpp
 SQL_OBJS := $(patsubst %.cpp,${OBJ_DIR}/%.o,${SQL_SRCS})
 SQL_TEST = ${BIN_DIR}/historytest
 

Modified: trunk/SQL/historytest.cpp
===================================================================
--- trunk/SQL/historytest.cpp	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/SQL/historytest.cpp	2006-01-03 13:12:11 UTC (rev 49)
@@ -16,7 +16,6 @@
 
 #include <iostream>
 
-#include "ActionHistory.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
 
@@ -26,14 +25,13 @@
 {
 	if (argc < 3)
 	{
-		cerr << "Usage: " << argv[0] << " <database> CREATE|LISTACTIONS=<max>" << endl;
+		cerr << "Usage: " << argv[0] << " <database> CREATE" << endl;
 		return EXIT_FAILURE;
 	}
 
 	if (strncmp(argv[2], "CREATE", 6) == 0)
 	{
-		if ((ActionHistory::create(argv[1]) == true) &&
-			(QueryHistory::create(argv[1]) == true) &&
+		if ((QueryHistory::create(argv[1]) == true) &&
 			(ViewHistory::create(argv[1]) == true))
 		{
 			cout << "Created database " << argv[1] << " and its tables" << endl;
@@ -43,33 +41,6 @@
 			cout << "Couldn't create database " << argv[1] << endl;
 		}
 	}
-	else if (strncmp(argv[2], "LISTACTIONS=", 12) == 0)
-	{
-		ActionHistory actions(argv[1]);
-		SQLiteResults *results = actions.executeStatement("SELECT Option, Date FROM ActionHistory ORDER BY %s DESC LIMIT %s;", "Date", argv[2] + 12);
-		if (results != NULL)
-		{
-			while (results->hasMoreRows() == true)
-			{
-				SQLiteRow *row = results->nextRow();
-				if (row == NULL)
-				{
-					break;
-				}
 
-				for (int i = 0; i < row->getColumnsCount(); ++i)
-				{
-					cout << results->getColumnName(i) << ": " << row->getColumn(i) << endl;
-				}
-				delete row;
-			}
-			delete results;
-		}
-		else
-		{
-			cout << "Couldn't list actions in database " << argv[1] << endl;
-		}
-	}
-
 	return EXIT_SUCCESS;
 }

Modified: trunk/UI/GTK2/src/IndexPage.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexPage.cpp	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/UI/GTK2/src/IndexPage.cpp	2006-01-03 13:12:11 UTC (rev 49)
@@ -220,8 +220,11 @@
 //
 // Updates the state of the index buttons.
 //
-void IndexPage::updateButtons(unsigned int maxDocsCount)
+void IndexPage::updateButtonsState(unsigned int maxDocsCount)
 {
+#ifdef DEBUG
+	cout << "IndexPage::updateButtonsState: " << m_firstDoc << " " << m_docsCount << endl;
+#endif
 	if (m_firstDoc >= maxDocsCount)
 	{
 		m_pBackButton->set_sensitive(true);

Modified: trunk/UI/GTK2/src/IndexPage.h
===================================================================
--- trunk/UI/GTK2/src/IndexPage.h	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/UI/GTK2/src/IndexPage.h	2006-01-03 13:12:11 UTC (rev 49)
@@ -56,7 +56,7 @@
 		void populateLabelCombobox(void);
 
 		/// Updates the state of the index buttons.
-		void updateButtons(unsigned int maxDocsCount);
+		void updateButtonsState(unsigned int maxDocsCount);
 
 		/// Gets the number of documents.
 		unsigned int getDocumentsCount(void) const;

Modified: trunk/UI/GTK2/src/PinotUtils.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotUtils.cpp	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/UI/GTK2/src/PinotUtils.cpp	2006-01-03 13:12:11 UTC (rev 49)
@@ -30,7 +30,7 @@
 bool select_file_name(Window &parentWindow, const ustring &title,
 	ustring &location, bool openOrCreate, bool directoriesOnly)
 {
-	FileChooserAction chooserAction = FILE_CHOOSER_ACTION_OPEN;
+	FileChooserDialog fileChooser(title);
 	StockID okButtonStockId = Stock::OPEN;
 
 	if (title.empty() == true)
@@ -38,6 +38,42 @@
 		return false;
 	}
 
+	if (openOrCreate == false)
+	{
+		okButtonStockId = Stock::SAVE;
+	}
+
+	prepare_chooser(&fileChooser, location, openOrCreate, directoriesOnly);
+	fileChooser.add_button(Stock::CANCEL, RESPONSE_CANCEL);
+	fileChooser.add_button(okButtonStockId, RESPONSE_OK);
+	// FIXME: add FileFilter's
+	fileChooser.set_title(title);
+	fileChooser.show();
+
+	int result = fileChooser.run();
+	if (result == RESPONSE_OK)
+	{
+		// Retrieve the chosen location
+		if (directoriesOnly == false)
+		{
+			location = filename_to_utf8(fileChooser.get_filename());
+		}
+		else
+		{
+			location = filename_to_utf8(fileChooser.get_current_folder());
+		}
+
+		return true;
+	}
+
+	return false;
+}
+
+bool prepare_chooser(FileChooser *pChooser, ustring &location,
+	bool openOrCreate, bool directoriesOnly)
+{
+	FileChooserAction chooserAction = FILE_CHOOSER_ACTION_OPEN;
+
 	// Have we been provided with an initial location ?
 	if (location.empty() == true)
 	{
@@ -59,7 +95,6 @@
 		else
 		{
 			chooserAction = FILE_CHOOSER_ACTION_SAVE;
-			okButtonStockId = Stock::SAVE;
 		}
 	}
 	else
@@ -71,36 +106,15 @@
 		else
 		{
 			chooserAction = FILE_CHOOSER_ACTION_CREATE_FOLDER;
-			okButtonStockId = Stock::SAVE;
 		}
 	}
 
-	FileChooserDialog fileChooser(title, chooserAction);
-	fileChooser.set_filename(filename_from_utf8(location));
-	fileChooser.set_local_only();
-	fileChooser.set_select_multiple(false);
-	fileChooser.set_transient_for(parentWindow);
-	// Add response buttons
-	fileChooser.add_button(Stock::CANCEL, RESPONSE_CANCEL);
-	fileChooser.add_button(okButtonStockId, RESPONSE_OK);
+	pChooser->set_action(chooserAction);
+	pChooser->set_filename(filename_from_utf8(location));
+	pChooser->set_local_only();
+	pChooser->set_select_multiple(false);
 	// FIXME: add FileFilter's
-	fileChooser.show();
-	int result = fileChooser.run();
-	if (result == RESPONSE_OK)
-	{
-		// Retrieve the chosen location
-		if (directoriesOnly == false)
-		{
-			location = filename_to_utf8(fileChooser.get_filename());
-		}
-		else
-		{
-			location = filename_to_utf8(fileChooser.get_current_folder());
-		}
 
-		return true;
-	}
-
 	return false;
 }
 

Modified: trunk/UI/GTK2/src/PinotUtils.h
===================================================================
--- trunk/UI/GTK2/src/PinotUtils.h	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/UI/GTK2/src/PinotUtils.h	2006-01-03 13:12:11 UTC (rev 49)
@@ -24,13 +24,18 @@
 #endif
 #include <glibmm/ustring.h>
 #include <gtkmm/window.h>
+#include <gtkmm/filechooserdialog.h>
 #include <gtkmm/treeview.h>
 #include <gtkmm/treemodel.h>
 
-/// Open a FileSelector and request a file. Location can be initialized.
+/// Open a FileChooserDialog.
 bool select_file_name(Gtk::Window &parentWindow, const Glib::ustring &title,
 	Glib::ustring &location, bool openOrCreate = true, bool directoriesOnly = false);
 
+/// Prepare a FileChooser.
+bool prepare_chooser(Gtk::FileChooser *pChooser, Glib::ustring &location,
+	bool openOrCreate = true, bool directoriesOnly = false);
+
 /// Create a resizable text column.
 Gtk::TreeViewColumn *create_resizable_column(const Glib::ustring &title,
 	const Gtk::TreeModelColumnBase& modelColumn);

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-03 13:12:11 UTC (rev 49)
@@ -116,7 +116,7 @@
 	cout << "WorkerThread::emitSignal: end of thread " << m_id << endl;
 #endif
 	m_done = true;
-	m_signalFinished();
+	m_signalFinished.emit();
 }
 
 IndexBrowserThread::IndexBrowserThread(const string &indexName,

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-03 13:12:11 UTC (rev 49)
@@ -114,6 +114,12 @@
 		return;
 	}
 
+	// Skip dotfiles
+	if (urlObj.getFile()[0] == '.')
+	{
+		return;
+	}
+
 #ifdef DEBUG
 	cout << "importDialog::scan_file: " << fileName << endl;
 #endif

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-03 13:12:11 UTC (rev 49)
@@ -36,7 +36,6 @@
 #include "IndexedDocument.h"
 #include "TimeConverter.h"
 #include "Url.h"
-#include "ActionHistory.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
 #include "DownloaderFactory.h"
@@ -243,6 +242,10 @@
 	m_tooltips.set_tip(*addIndexButton, _("Add index"));
 	m_tooltips.set_tip(*removeIndexButton, _("Remove index"));
 
+	// Connect to threads' finished signal
+	m_threadsEndConnection = WorkerThread::getFinishedSignal().connect(
+		SigC::slot(*this, &mainWindow::on_thread_end));
+
 	// FIXME: delete all "ignored" threads when exiting !!!
 	// Fire up a listener thread
 	ListenerThread *pListenThread = new ListenerThread(PinotSettings::getConfigurationDirectory() + string("/fifo"));
@@ -260,9 +263,6 @@
 	start_thread(pMonitorThread, true);
 	// The handler object will be deleted when the thread terminates
 
-	// There might be queued actions
-	check_queue();
-
 	// Now we are ready
 	set_status(_("Ready"));
 	m_pNotebook->show();
@@ -827,7 +827,6 @@
 	else if (type == "IndexBrowserThread")
 	{
 		char docsCountStr[64];
-		unsigned int count = 0;
 
 		IndexBrowserThread *pBrowseThread = dynamic_cast<IndexBrowserThread *>(pThread);
 		if (pBrowseThread == NULL)
@@ -854,11 +853,10 @@
 		}
 
 		pIndexPage->setDocumentsCount(pBrowseThread->getDocumentsCount());
-		count = pIndexTree->getRowsCount();
 
 		status = _("Showing");
 		status += " ";
-		snprintf(docsCountStr, 64, "%u", count);
+		snprintf(docsCountStr, 64, "%u", pIndexTree->getRowsCount());
 		status += docsCountStr;
 		status += " ";
 		status += _("off");
@@ -876,7 +874,7 @@
 			// Refresh the tree
 			pIndexTree->refresh();
 		}
-		pIndexPage->updateButtons(m_maxDocsCount);
+		pIndexPage->updateButtonsState(m_maxDocsCount);
 		m_state.m_browsingIndex = false;
 	}
 	else if (type == "QueryingThread")
@@ -1163,13 +1161,22 @@
 
 			if (pIndexTree != NULL)
 			{
-				// Append to the index tree
-				IndexedDocument indexedDoc(docInfo.getTitle(),
-					XapianEngine::buildUrl(m_settings.m_indexLocation, docId),
-					docInfo.getLocation(), docInfo.getType(),
-					docInfo.getLanguage());
-				indexedDoc.setTimestamp(docInfo.getTimestamp());
-				pIndexTree->appendDocument(indexedDoc, labeled);
+				unsigned int rowsCount = pIndexTree->getRowsCount();
+
+				// Ensure the last page is being displayed and is not full
+				if ((pIndexPage->getFirstDocument() + rowsCount == pIndexPage->getDocumentsCount()) &&
+					(rowsCount < m_maxDocsCount))
+				{
+					// Add a row to the index tree
+					IndexedDocument indexedDoc(docInfo.getTitle(),
+						XapianEngine::buildUrl(m_settings.m_indexLocation, docId),
+						docInfo.getLocation(), docInfo.getType(),
+						docInfo.getLanguage());
+					indexedDoc.setTimestamp(docInfo.getTimestamp());
+					pIndexTree->appendDocument(indexedDoc, labeled);
+				}
+				pIndexPage->setDocumentsCount(pIndexPage->getDocumentsCount() + 1);
+				pIndexPage->updateButtonsState(m_maxDocsCount);
 			}
 		}
 
@@ -1346,15 +1353,17 @@
 	{
 		return;
 	}
+	unsigned int rowsCount = pIndexTree->getRowsCount();
 
-	// Is the last page being displayed ?
-	if (pIndexPage->getFirstDocument() + m_maxDocsCount < pIndexPage->getDocumentsCount())
+	// Ensure the last page is being displayed and is not full
+	if ((pIndexPage->getFirstDocument() + rowsCount < pIndexPage->getDocumentsCount()) ||
+		(rowsCount >= m_maxDocsCount))
 	{
 		// No, so we can't add a new entry for that document
 		// Increment the count
 		pIndexPage->setDocumentsCount(pIndexPage->getDocumentsCount() + 1);
-		// ...and make sure the user can display that last page
-		pIndexPage->updateButtons(m_maxDocsCount);
+		// ...and update the buttons
+		pIndexPage->updateButtonsState(m_maxDocsCount);
 		return;
 	}
 
@@ -2507,6 +2516,10 @@
 		}
 	}
 
+	// Disconnect the threads' finished signal
+	m_threadsEndConnection.block();
+	m_threadsEndConnection.disconnect();
+
 	// Save the window's position and dimensions now
 	// Don't worry about the gravity, it hasn't been changed
 	get_position(m_settings.m_xPos, m_settings.m_yPos);
@@ -2618,41 +2631,19 @@
 bool mainWindow::queue_index(const DocumentInfo &docInfo,
 	const string &labelName, unsigned int docId)
 {
-	ActionHistory::ActionType type = ActionHistory::ACTION_INDEX;
-
-	if (docId > 0)
-	{
-		// This is an update
-		type = ActionHistory::ACTION_UPDATE;
-	}
-
 	if (get_threads_count() >= m_maxThreads)
 	{
-		ActionHistory history(m_settings.m_historyDatabase);
-
-		string option = docInfo.getTitle();
-		option += "|";
-		option += Url::escapeUrl(docInfo.getLocation());
-		option += "|";
-		option += docInfo.getType();
-		option += "|";
-		option += labelName;
-		if (type == ActionHistory::ACTION_UPDATE)
+		if (m_state.writeLock(50) == true)
 		{
-			option += "|";
-			char docIdStr[64];
-			snprintf(docIdStr, 64, "%d", docId);
-			option += docIdStr;
+			m_state.m_indexQueue[docInfo] = labelName;
+
+			m_state.unlock();
 		}
-#ifdef DEBUG
-		cout << "mainWindow::queue_index: " << option << endl;
-#endif
 
-		// Add this to ActionHistory and return
-		return history.insertItem(type, option);
+		return true;
 	}
 
-	if (type == ActionHistory::ACTION_UPDATE)
+	if (docId > 0)
 	{
 		// Update the document
 		index_document(docInfo, labelName, docId);
@@ -2905,6 +2896,7 @@
 			pIndexTree->clear();
 		}
 		// Reset variables
+		pIndexPage->setFirstDocument(0);
 		pIndexPage->setDocumentsCount(0);
 
 		// Switch to that index page
@@ -3112,10 +3104,6 @@
 	}
 
 	pNewThread->setId(nextId);
-	// Connect to the finished signal
-	pNewThread->getFinishedSignal().connect(SigC::slot(*this,
-		&mainWindow::on_thread_end));
-
 	if (m_state.writeLock(11) == true)
 	{
 		pair<set<WorkerThread *>::iterator, bool> insertPair = m_state.m_pThreads.insert(pNewThread);
@@ -3166,9 +3154,6 @@
 //
 bool mainWindow::check_queue(void)
 {
-#ifdef DEBUG
-	cout << "mainWindow::check_queue: called" << endl;
-#endif
 	if (get_threads_count() >= m_maxThreads)
 	{
 #ifdef DEBUG
@@ -3177,81 +3162,49 @@
 		return false;
 	}
 
-	ActionHistory history(m_settings.m_historyDatabase);
-	ActionHistory::ActionType type;
-	string option;
+	DocumentInfo docInfo;
+	string labelName;
 
-	if (history.deleteOldestItem(type, option) == false)
+	if (m_state.writeLock(12) == true)
 	{
-#ifdef DEBUG
-		cout << "mainWindow::check_queue: found no action" << endl;
-#endif
-		return false;
-	}
-
-	if (type == ActionHistory::ACTION_INDEX)
-	{
-		string::size_type lastPos = 0, pos = option.find_first_of("|");
-		if (pos != string::npos)
+		if (m_state.m_indexQueue.empty() == false)
 		{
-			string title = option.substr(lastPos, pos - lastPos);
-
-			lastPos = pos + 1;
-			pos = option.find_first_of("|", lastPos);
-			if (pos != string::npos)
+			// Get the first item
+			std::map<DocumentInfo, string>::iterator queueIter = m_state.m_indexQueue.begin();
+			if (queueIter != m_state.m_indexQueue.end())
 			{
-				string url = option.substr(lastPos, pos - lastPos);
+				docInfo = queueIter->first;
+				labelName = queueIter->second;
 
-				lastPos = pos + 1;
-				pos = option.find_first_of("|", lastPos);
-				if (pos != string::npos)
-				{
-					string type = option.substr(lastPos, pos - lastPos);
-
-					string labelName = option.substr(pos + 1);
-
-					// Index the document
-					index_document(DocumentInfo(title, Url::unescapeUrl(url), type, ""),
-						labelName);
-				}
+				m_state.m_indexQueue.erase(queueIter);
 			}
 		}
+
+		m_state.unlock();
 	}
-	else if (type == ActionHistory::ACTION_UPDATE)
+
+	string location = docInfo.getLocation();
+	if (location.empty() == true)
 	{
-		string::size_type lastPos = 0, pos = option.find_first_of("|");
-		if (pos != string::npos)
-		{
-			string title = option.substr(lastPos, pos - lastPos);
+		// Nothing to do
+#ifdef DEBUG
+		cout << "mainWindow::check_queue: empty queue" << endl;
+#endif
+		return false;
+	}
 
-			lastPos = pos + 1;
-			pos = option.find_first_of("|", lastPos);
-			if (pos != string::npos)
-			{
-				string url = option.substr(lastPos, pos - lastPos);
-
-				lastPos = pos + 1;
-				pos = option.find_first_of("|", lastPos);
-				if (pos != string::npos)
-				{
-					string type = option.substr(lastPos, pos - lastPos);
-
-					lastPos = pos + 1;
-					pos = option.find_first_of("|", lastPos);
-					if (pos != string::npos)
-					{
-						string labelName = option.substr(lastPos, pos - lastPos);
-
-						unsigned int docId = (unsigned int)atoi(option.substr(pos + 1).c_str());
-
-						// Update the document
-						index_document(DocumentInfo(title, Url::unescapeUrl(url), type, ""),
-							labelName, docId);
-					}
-				}
-			}
-		}
+	// Is it an update ?
+	XapianIndex docsIndex(m_settings.m_indexLocation);
+	unsigned int docId = docsIndex.hasDocument(location);
+	if (docId > 0)
+	{
+		// Yes, it is
+		index_document(docInfo, labelName, docId);
 	}
+	else
+	{
+		index_document(docInfo, labelName);
+	}
 
 	return true;
 }
@@ -3263,7 +3216,7 @@
 {
 	int count = 0;
 
-	if (m_state.readLock(12) == true)
+	if (m_state.readLock(13) == true)
 	{
 		count = m_state.m_pThreads.size() - m_state.m_backgroundThreads;
 		m_state.unlock();
@@ -3292,7 +3245,7 @@
 		snprintf(countStr, 64, "%d", threads);
 		text = countStr;
 		text += " ";
-		text += _("thread(s)");
+		text += _("task(s) running");
 		text += " - ";
 		m_threadStatusText = text;
 	}

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-01-03 13:12:11 UTC (rev 49)
@@ -21,6 +21,7 @@
 #include <map>
 #include <set>
 #include <pthread.h>
+#include <sigc++/connection.h>
 #include <glibmm/refptr.h>
 #include <gdkmm/pixbuf.h>
 #include <gdkmm/color.h>
@@ -36,7 +37,6 @@
 
 #include "DocumentInfo.h"
 #include "IndexedDocument.h"
-#include "ActionHistory.h"
 #include "QueryProperties.h"
 #include "EnginesTree.h"
 #include "HtmlView.h"
@@ -140,7 +140,8 @@
 	void set_status(const Glib::ustring &text, bool canBeSkipped = false);
 
 private:
-	// Threads status text
+	// Threads
+	SigC::Connection m_threadsEndConnection;
 	Glib::ustring m_threadStatusText;
 	// Global settings
 	PinotSettings &m_settings;
@@ -186,6 +187,8 @@
 			// In-progress actions
 			std::set<std::string> m_beingIndexed;
 			bool m_browsingIndex;
+			// Action queue
+			std::map<DocumentInfo, string> m_indexQueue;
 
 		protected:
 			// Read/write lock

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/UI/GTK2/src/pinot.cc	2006-01-03 13:12:11 UTC (rev 49)
@@ -30,7 +30,6 @@
 #include "Languages.h"
 #include "XapianDatabase.h"
 #include "XapianDatabaseFactory.h"
-#include "ActionHistory.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
 #include "NeonDownloader.h"
@@ -157,7 +156,6 @@
 
 	// Do the same for the history database
 	if ((settings.m_historyDatabase.empty() == true) ||
-		(ActionHistory::create(settings.m_historyDatabase) == false) ||
 		(QueryHistory::create(settings.m_historyDatabase) == false) ||
 		(ViewHistory::create(settings.m_historyDatabase) == false))
 	{

Modified: trunk/Utils/DocumentInfo.cpp
===================================================================
--- trunk/Utils/DocumentInfo.cpp	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/Utils/DocumentInfo.cpp	2006-01-03 13:12:11 UTC (rev 49)
@@ -60,7 +60,7 @@
 
 bool DocumentInfo::operator<(const DocumentInfo& other) const
 {
-	if (m_title < other.m_title)
+	if (m_location < other.m_location)
 	{
 		return true;
 	}

Modified: trunk/Utils/IndexedDocument.cpp
===================================================================
--- trunk/Utils/IndexedDocument.cpp	2006-01-02 19:35:21 UTC (rev 48)
+++ trunk/Utils/IndexedDocument.cpp	2006-01-03 13:12:11 UTC (rev 49)
@@ -38,6 +38,7 @@
 
 IndexedDocument& IndexedDocument::operator=(const IndexedDocument& other)
 {
+	Document::operator=(other);
 	m_originalLocation = other.m_originalLocation;
 }
 



From fabricecolin at berlios.de  Tue Jan  3 17:27:03 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 3 Jan 2006 17:27:03 +0100
Subject: [Pinot-svn] r50 - trunk/UI/GTK2/src
Message-ID: <200601031627.k03GR3dX000962@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-03 17:27:03 +0100 (Tue, 03 Jan 2006)
New Revision: 50

Modified:
   trunk/UI/GTK2/src/IndexPage.cpp
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Follow-up to previous check-in.


Modified: trunk/UI/GTK2/src/IndexPage.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexPage.cpp	2006-01-03 13:12:11 UTC (rev 49)
+++ trunk/UI/GTK2/src/IndexPage.cpp	2006-01-03 16:27:03 UTC (rev 50)
@@ -223,7 +223,8 @@
 void IndexPage::updateButtonsState(unsigned int maxDocsCount)
 {
 #ifdef DEBUG
-	cout << "IndexPage::updateButtonsState: " << m_firstDoc << " " << m_docsCount << endl;
+	cout << "IndexPage::updateButtonsState: counts " << m_firstDoc
+		<< " " << m_docsCount << endl;
 #endif
 	if (m_firstDoc >= maxDocsCount)
 	{

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-03 13:12:11 UTC (rev 49)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-03 16:27:03 UTC (rev 50)
@@ -607,8 +607,6 @@
 		{
 			pIndexTree->clear();
 		}
-		pIndexPage->setFirstDocument(0);
-		pIndexPage->setDocumentsCount(0);
 		foundPage = true;
 	}
 
@@ -853,6 +851,7 @@
 		}
 
 		pIndexPage->setDocumentsCount(pBrowseThread->getDocumentsCount());
+		pIndexPage->updateButtonsState(m_maxDocsCount);
 
 		status = _("Showing");
 		status += " ";
@@ -864,9 +863,10 @@
 		snprintf(docsCountStr, 64, "%u", pIndexPage->getDocumentsCount());
 		status += docsCountStr;
 		status += " ";
-		status += _("documents from");
+		status += _("documents, starting at");
 		status += " ";
-		status += indexName;
+		snprintf(docsCountStr, 64, "%u", pIndexPage->getFirstDocument());
+		status += docsCountStr;
 		set_status(status);
 
 		if (pIndexPage->getDocumentsCount() > 0)
@@ -874,7 +874,6 @@
 			// Refresh the tree
 			pIndexTree->refresh();
 		}
-		pIndexPage->updateButtonsState(m_maxDocsCount);
 		m_state.m_browsingIndex = false;
 	}
 	else if (type == "QueryingThread")
@@ -1239,18 +1238,12 @@
 	// Any threads left to return ?
 	if (get_threads_count() == 0)
 	{
-#ifdef DEBUG
-		cout << "mainWindow::on_thread_end: disconnecting timeout" << endl;
-#endif
 		if (m_timeoutConnection.connected() == true)
 		{
 			m_timeoutConnection.block();
 			m_timeoutConnection.disconnect();
 			mainProgressbar->set_fraction(0.0);
 		}
-#ifdef DEBUG
-		else cout << "mainWindow::on_thread_end: not connected" << endl;
-#endif
 	}
 }
 
@@ -1355,18 +1348,6 @@
 	}
 	unsigned int rowsCount = pIndexTree->getRowsCount();
 
-	// Ensure the last page is being displayed and is not full
-	if ((pIndexPage->getFirstDocument() + rowsCount < pIndexPage->getDocumentsCount()) ||
-		(rowsCount >= m_maxDocsCount))
-	{
-		// No, so we can't add a new entry for that document
-		// Increment the count
-		pIndexPage->setDocumentsCount(pIndexPage->getDocumentsCount() + 1);
-		// ...and update the buttons
-		pIndexPage->updateButtonsState(m_maxDocsCount);
-		return;
-	}
-
 	// Does that document have the current label ?
 	ustring labelName = pIndexPage->getLabelName();
 	if (labelName.empty() == false)
@@ -1385,13 +1366,7 @@
 	}
 
 	// Add a row
-	if (pIndexTree->appendDocument(docInfo, hasLabel) == true)
-	{
-#ifdef DEBUG
-		cout << "mainWindow::on_message_indexupdate: added document to index list" << endl;
-#endif
-		pIndexPage->setDocumentsCount(pIndexPage->getDocumentsCount() + 1);
-	}
+	pIndexTree->appendDocument(docInfo, hasLabel);
 }
 
 //
@@ -2437,8 +2412,7 @@
 	{
 		if (pIndexPage->getFirstDocument() >= m_maxDocsCount)
 		{
-			pIndexPage->setFirstDocument(pIndexPage->getFirstDocument() - m_maxDocsCount);
-			browse_index(indexName, pIndexPage->getFirstDocument());
+			browse_index(indexName, pIndexPage->getFirstDocument() - m_maxDocsCount);
 		}
 	}
 }
@@ -2453,14 +2427,22 @@
 	{
 		if (pIndexPage->getDocumentsCount() == 0)
 		{
-			pIndexPage->setFirstDocument(0);
+#ifdef DEBUG
+			cout << "mainWindow::on_indexForwardButton_clicked: first" << endl;
+#endif
 			browse_index(indexName, 0);
 		}
 		else if (pIndexPage->getDocumentsCount() >= pIndexPage->getFirstDocument() + m_maxDocsCount)
 		{
-			pIndexPage->setFirstDocument(pIndexPage->getFirstDocument() + m_maxDocsCount);
-			browse_index(indexName, pIndexPage->getFirstDocument());
+#ifdef DEBUG
+			cout << "mainWindow::on_indexForwardButton_clicked: next" << endl;
+#endif
+			browse_index(indexName, pIndexPage->getFirstDocument() + m_maxDocsCount);
 		}
+#ifdef DEBUG
+		cout << "mainWindow::on_indexForwardButton_clicked: counts "
+			<< pIndexPage->getFirstDocument() << " " << pIndexPage->getDocumentsCount() << endl;
+#endif
 	}
 }
 
@@ -2502,7 +2484,8 @@
 				threadIter != m_state.m_pThreads.end(); ++threadIter)
 			{
 #ifdef DEBUG
-				cout << "mainWindow::on_mainWindow_delete_event: stopping thread" << endl;
+				cout << "mainWindow::on_mainWindow_delete_event: stopping thread "
+					<< (*threadIter)->getId() << endl;
 #endif
 				// Stop all non-background threads
 				if ((*threadIter)->isBackground() == false)
@@ -2525,6 +2508,9 @@
 	get_position(m_settings.m_xPos, m_settings.m_yPos);
 	get_size(m_settings.m_width, m_settings.m_height);
 	m_settings.m_panePos = mainHpaned->get_position();
+#ifdef DEBUG
+	cout << "mainWindow::on_mainWindow_delete_event: quitting" << endl;
+#endif
 
 	Main::quit();
 	return false;
@@ -2895,9 +2881,7 @@
 			// Remove existing rows in the index tree
 			pIndexTree->clear();
 		}
-		// Reset variables
-		pIndexPage->setFirstDocument(0);
-		pIndexPage->setDocumentsCount(0);
+		pIndexPage->setFirstDocument(startDoc);
 
 		// Switch to that index page
 		m_pNotebook->set_current_page(get_page_number(indexName, NotebookPageBox::INDEX_PAGE));



From fabricecolin at berlios.de  Tue Jan  3 20:18:40 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 3 Jan 2006 20:18:40 +0100
Subject: [Pinot-svn] r51 - trunk/UI/GTK2/src
Message-ID: <200601031918.k03JIeqt011472@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-03 20:18:38 +0100 (Tue, 03 Jan 2006)
New Revision: 51

Modified:
   trunk/UI/GTK2/src/importDialog_glade.cc
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Minor tweaks.


Modified: trunk/UI/GTK2/src/importDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-03 16:27:03 UTC (rev 50)
+++ trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-03 19:18:38 UTC (rev 51)
@@ -108,14 +108,12 @@
    locationEntry->set_visibility(true);
    locationEntry->set_editable(true);
    locationEntry->set_max_length(0);
-   locationEntry->set_text(_(""));
    locationEntry->set_has_frame(true);
    locationEntry->set_activates_default(false);
    titleEntry->set_flags(Gtk::CAN_FOCUS);
    titleEntry->set_visibility(true);
    titleEntry->set_editable(true);
    titleEntry->set_max_length(0);
-   titleEntry->set_text(_(""));
    titleEntry->set_has_frame(true);
    titleEntry->set_activates_default(false);
    locationLabel->set_alignment(0,0.5);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-03 16:27:03 UTC (rev 50)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-03 19:18:38 UTC (rev 51)
@@ -2252,16 +2252,27 @@
 //
 void mainWindow::on_liveQueryEntry_changed()
 {
-	ustring liveQuery = liveQueryEntry->get_text();
-	unsigned int liveQueryLength = liveQuery.length();
+	ustring prefix, term = liveQueryEntry->get_text();
+	unsigned int liveQueryLength = term.length();
 
 	// Reset the list
 	m_refLiveQueryList->clear();
+	// Get the last term from the entry field
+	ustring::size_type pos = term.find_last_of(" ");
+	if (pos != ustring::npos)
+	{
+		ustring liveQuery(term);
 
-	// If characters are being deleted or if the string is too short, don't
+		prefix = liveQuery.substr(0, pos);
+		prefix += " ";
+		term = liveQuery.substr(pos + 1);
+	}
+
+	// If characters are being deleted or if the term is too short, don't
 	// attempt to offer suggestions
 	if ((m_state.m_liveQueryLength > liveQueryLength) ||
-		(m_refLiveQueryCompletion->get_minimum_key_length() > liveQueryLength))
+		(term.empty() == true) ||
+		(m_refLiveQueryCompletion->get_minimum_key_length() > term.length()))
 	{
 		m_state.m_liveQueryLength = liveQueryLength;
 		return;
@@ -2272,39 +2283,25 @@
 	XapianIndex docsIndex(m_settings.m_indexLocation);
 	if (docsIndex.isGood() == true)
 	{
-		ustring prefix, term = liveQuery;
+		set<string> suggestedTerms;
+		int termIndex = 0;
 
-		// Get the last term from the entry field
-		ustring::size_type pos = liveQuery.find_last_of(" ");
-		if (pos != ustring::npos)
-		{
-			prefix = liveQuery.substr(0, pos);
-			prefix += " ";
-			term = liveQuery.substr(pos + 1);
-		}
+		// Get a list of suggestions
+		docsIndex.getCloseTerms(locale_from_utf8(term), suggestedTerms);
 
-		if (term.empty() == false)
+		// Populate the list
+		for (set<string>::iterator termIter = suggestedTerms.begin();
+			termIter != suggestedTerms.end(); ++termIter)
 		{
-			set<string> suggestedTerms;
-			int termIndex = 0;
+			TreeModel::iterator iter = m_refLiveQueryList->append();
+			TreeModel::Row row = *iter;
 
-			// Get a list of suggestions
-			docsIndex.getCloseTerms(locale_from_utf8(term), suggestedTerms);
-
-			// Populate the list
-			for (set<string>::iterator termIter = suggestedTerms.begin();
-				termIter != suggestedTerms.end(); ++termIter)
-			{
-				TreeModel::iterator iter = m_refLiveQueryList->append();
-				TreeModel::Row row = *iter;
-
-				row[m_liveQueryColumns.m_name] = prefix + to_utf8(*termIter);
-				++termIndex;
-			}
+			row[m_liveQueryColumns.m_name] = prefix + to_utf8(*termIter);
+			++termIndex;
+		}
 #ifdef DEBUG
-			cout << "mainWindow::on_liveQueryEntry_changed: " << termIndex << " suggestions" << endl;
+		cout << "mainWindow::on_liveQueryEntry_changed: " << termIndex << " suggestions" << endl;
 #endif
-		}
 	}
 }
 



From fabricecolin at berlios.de  Tue Jan  3 20:20:01 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 3 Jan 2006 20:20:01 +0100
Subject: [Pinot-svn] r52 - trunk/po
Message-ID: <200601031920.k03JK184012471@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-03 20:19:59 +0100 (Tue, 03 Jan 2006)
New Revision: 52

Modified:
   trunk/po/en_GB.po
   trunk/po/fr_FR.po
Log:
Synced po files with source.


Modified: trunk/po/en_GB.po
===================================================================
--- trunk/po/en_GB.po	2006-01-03 19:18:38 UTC (rev 51)
+++ trunk/po/en_GB.po	2006-01-03 19:19:59 UTC (rev 52)
@@ -3,17 +3,6 @@
 # This file is distributed under the same license as the pinot package.
 # Fabrice Colin <colinf at chez.com>, 2005.
 #
-#: UI/GTK2/src/importDialog_glade.cc:110 UI/GTK2/src/importDialog_glade.cc:117
-#: UI/GTK2/src/indexDialog_glade.cc:94 UI/GTK2/src/indexDialog_glade.cc:124
-#: UI/GTK2/src/mainWindow_glade.cc:302 UI/GTK2/src/prefsDialog_glade.cc:153
-#: UI/GTK2/src/prefsDialog_glade.cc:164
-#: UI/GTK2/src/propertiesDialog_glade.cc:89
-#: UI/GTK2/src/propertiesDialog_glade.cc:130
-#: UI/GTK2/src/propertiesDialog_glade.cc:143
-#: UI/GTK2/src/queryDialog_glade.cc:115 UI/GTK2/src/queryDialog_glade.cc:126
-#: UI/GTK2/src/queryDialog_glade.cc:133 UI/GTK2/src/queryDialog_glade.cc:140
-#: UI/GTK2/src/queryDialog_glade.cc:205 UI/GTK2/src/queryDialog_glade.cc:212
-#: UI/GTK2/src/queryDialog_glade.cc:237
 #, fuzzy
 msgid ""
 msgstr ""
@@ -27,22 +16,6 @@
 "Content-Type: text/plain; charset=utf-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: UI/GTK2/src/aboutDialog_glade.cc:342 UI/GTK2/src/mainWindow_glade.cc:357
-msgid "Pinot"
-msgstr ""
-
-#: UI/GTK2/src/aboutDialog_glade.cc:344
-msgid "A metasearch tool for the Free Desktop."
-msgstr ""
-
-#: UI/GTK2/src/aboutDialog_glade.cc:345
-msgid "Copyright (C) 2005 Fabrice Colin"
-msgstr ""
-
-#: UI/GTK2/src/aboutDialog_glade.cc:388
-msgid "About Pinot"
-msgstr ""
-
 #: UI/GTK2/src/EnginesTree.cpp:67
 msgid "Search Engines"
 msgstr ""
@@ -51,62 +24,66 @@
 msgid "Current User"
 msgstr ""
 
-#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:372
-#: UI/GTK2/src/mainWindow.cc:375 UI/GTK2/src/mainWindow.cc:537
-#: UI/GTK2/src/mainWindow.cc:1116 UI/GTK2/src/mainWindow.cc:1187
-#: UI/GTK2/src/PinotSettings.cpp:198 UI/GTK2/src/PinotSettings.cpp:864
-#: UI/GTK2/src/PinotSettings.cpp:920
+#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:381
+#: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:557
+#: UI/GTK2/src/mainWindow.cc:1111 UI/GTK2/src/mainWindow.cc:1213
+#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:865
+#: UI/GTK2/src/PinotSettings.cpp:921
 msgid "My Documents"
 msgstr ""
 
-#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:378
-#: UI/GTK2/src/mainWindow.cc:381 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/MonitorHandler.cpp:174 UI/GTK2/src/PinotSettings.cpp:199
-#: UI/GTK2/src/PinotSettings.cpp:865 UI/GTK2/src/PinotSettings.cpp:921
+#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:387
+#: UI/GTK2/src/mainWindow.cc:390 UI/GTK2/src/mainWindow.cc:561
+#: UI/GTK2/src/MonitorHandler.cpp:174 UI/GTK2/src/PinotSettings.cpp:200
+#: UI/GTK2/src/PinotSettings.cpp:866 UI/GTK2/src/PinotSettings.cpp:922
 #: UI/GTK2/src/prefsDialog_glade.cc:116
 msgid "My Email"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:92
+#: UI/GTK2/src/importDialog.cc:91
 msgid "Single file"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:95
+#: UI/GTK2/src/importDialog.cc:94
 msgid "Whole directory"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:100 UI/GTK2/src/IndexTree.cpp:71
+#: UI/GTK2/src/importDialog.cc:99 UI/GTK2/src/IndexTree.cpp:71
 #: UI/GTK2/src/ResultsTree.cpp:114
 msgid "URL"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:249
+#: UI/GTK2/src/importDialog.cc:265
 msgid "Document To Import"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:64
+#: UI/GTK2/src/importDialog_glade.cc:61 UI/GTK2/src/mainWindow_glade.cc:201
+msgid "Import"
+msgstr ""
+
+#: UI/GTK2/src/importDialog_glade.cc:65
 msgid "Select"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:73 UI/GTK2/src/indexDialog_glade.cc:68
+#: UI/GTK2/src/importDialog_glade.cc:74 UI/GTK2/src/indexDialog_glade.cc:68
 msgid "Location:"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:74
+#: UI/GTK2/src/importDialog_glade.cc:75
 #: UI/GTK2/src/propertiesDialog_glade.cc:64
 msgid "Title:"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:75
+#: UI/GTK2/src/importDialog_glade.cc:76
 msgid "Maximum depth:"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:81 UI/GTK2/src/indexDialog_glade.cc:67
+#: UI/GTK2/src/importDialog_glade.cc:82 UI/GTK2/src/indexDialog_glade.cc:67
 #: UI/GTK2/src/propertiesDialog_glade.cc:68
 msgid "Type:"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:163
+#: UI/GTK2/src/importDialog_glade.cc:162
 msgid "Import document"
 msgstr ""
 
@@ -126,7 +103,7 @@
 msgid "Port:"
 msgstr ""
 
-#: UI/GTK2/src/indexDialog_glade.cc:145
+#: UI/GTK2/src/indexDialog_glade.cc:143
 msgid "External index"
 msgstr ""
 
@@ -138,7 +115,7 @@
 msgid "Timestamp"
 msgstr ""
 
-#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:340
+#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:347
 msgid "No title"
 msgstr ""
 
@@ -151,234 +128,242 @@
 msgstr ""
 
 #: UI/GTK2/src/IndexPage.cpp:159 UI/GTK2/src/IndexPage.cpp:205
-#: UI/GTK2/src/queryDialog.cc:81
+#: UI/GTK2/src/queryDialog.cc:82
 msgid "None"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:168
+#: UI/GTK2/src/mainWindow.cc:179
 msgid "Query Name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:173
+#: UI/GTK2/src/mainWindow.cc:184
 msgid "Last Run"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:174
+#: UI/GTK2/src/mainWindow.cc:185
 msgid "Summary"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:234
+#: UI/GTK2/src/mainWindow.cc:242
 msgid "Add index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:235
+#: UI/GTK2/src/mainWindow.cc:243
 msgid "Remove index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:258
+#: UI/GTK2/src/mainWindow.cc:267
 msgid "Ready"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:277 UI/GTK2/src/mainWindow.cc:1056
-#: UI/GTK2/src/mainWindow.cc:1433 UI/GTK2/src/mainWindow.cc:2959
+#: UI/GTK2/src/mainWindow.cc:286 UI/GTK2/src/mainWindow.cc:1075
+#: UI/GTK2/src/mainWindow.cc:1437 UI/GTK2/src/mainWindow.cc:3020
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:309
+#: UI/GTK2/src/mainWindow.cc:318
 msgid "N/A"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:319
+#: UI/GTK2/src/mainWindow.cc:328
 msgid "<undefined>"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:499
+#: UI/GTK2/src/mainWindow.cc:519
 msgid "Result location is"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:552
+#: UI/GTK2/src/mainWindow.cc:572
 msgid "Document location is"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:663
+#: UI/GTK2/src/mainWindow.cc:681
 msgid "No label"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:839
+#: UI/GTK2/src/mainWindow.cc:856
 msgid "Showing"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:844
+#: UI/GTK2/src/mainWindow.cc:861
 msgid "off"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:849
-msgid "documents from"
+#: UI/GTK2/src/mainWindow.cc:866
+msgid "documents, starting at"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:882
+#: UI/GTK2/src/mainWindow.cc:900
 msgid "Query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:886 UI/GTK2/src/mainWindow.cc:2788
+#: UI/GTK2/src/mainWindow.cc:904 UI/GTK2/src/mainWindow.cc:2850
 msgid "on"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:890
+#: UI/GTK2/src/mainWindow.cc:908
 msgid "ended"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:990 UI/GTK2/src/propertiesDialog.cc:34
+#: UI/GTK2/src/mainWindow.cc:1009 UI/GTK2/src/propertiesDialog.cc:34
 msgid "Label"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:994
+#: UI/GTK2/src/mainWindow.cc:1013
 msgid "matches"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:999
+#: UI/GTK2/src/mainWindow.cc:1018
 msgid "document(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1031
+#: UI/GTK2/src/mainWindow.cc:1050
 msgid "Updated label(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1092 UI/GTK2/src/mainWindow.cc:1198
+#: UI/GTK2/src/mainWindow.cc:1121 UI/GTK2/src/mainWindow.cc:1224
 msgid "Updated document"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1099
+#: UI/GTK2/src/mainWindow.cc:1134
 msgid "Indexed"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1169
+#: UI/GTK2/src/mainWindow.cc:1195
 msgid "Unindexed document(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1255
+#: UI/GTK2/src/mainWindow.cc:1275
 msgid "Couldn't rename index, name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1259 UI/GTK2/src/mainWindow.cc:2163
-#: UI/GTK2/src/mainWindow.cc:2622
+#: UI/GTK2/src/mainWindow.cc:1279 UI/GTK2/src/mainWindow.cc:2174
+#: UI/GTK2/src/mainWindow.cc:2684
 msgid "is already in use"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1272
+#: UI/GTK2/src/mainWindow.cc:1292
 msgid "Couldn't rename index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1285
+#: UI/GTK2/src/mainWindow.cc:1305
 msgid "Edited index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1775 UI/GTK2/src/mainWindow.cc:1856
+#: UI/GTK2/src/mainWindow.cc:1779 UI/GTK2/src/mainWindow.cc:1860
 msgid "Please set a location for the index first"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1802
+#: UI/GTK2/src/mainWindow.cc:1806
 msgid "Result location is unknown"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1818
+#: UI/GTK2/src/mainWindow.cc:1822
 msgid "Import Document(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1934 UI/GTK2/src/pinot.cc:135
-#: UI/GTK2/src/pinot.cc:140 UI/GTK2/src/WorkerThreads.cpp:183
-#: UI/GTK2/src/WorkerThreads.cpp:421 UI/GTK2/src/WorkerThreads.cpp:1034
+#: UI/GTK2/src/mainWindow.cc:1938 UI/GTK2/src/pinot.cc:148
+#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:183
+#: UI/GTK2/src/WorkerThreads.cpp:428 UI/GTK2/src/WorkerThreads.cpp:1045
 msgid "Index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1938 UI/GTK2/src/WorkerThreads.cpp:187
-#: UI/GTK2/src/WorkerThreads.cpp:425 UI/GTK2/src/WorkerThreads.cpp:1038
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/WorkerThreads.cpp:187
+#: UI/GTK2/src/WorkerThreads.cpp:432 UI/GTK2/src/WorkerThreads.cpp:1049
 msgid "doesn't exist"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2050
+#: UI/GTK2/src/mainWindow.cc:2054
 msgid "Delete this document from the index ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2069
+#: UI/GTK2/src/mainWindow.cc:2073
 msgid "Delete these documents from the index ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2159
+#: UI/GTK2/src/mainWindow.cc:2125
+msgid "A metasearch tool for the Free Desktop"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:2126
+msgid "(C) 2005-2006 Fabrice Colin"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:2170
 msgid "Index name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2174
+#: UI/GTK2/src/mainWindow.cc:2185
 msgid "Couldn't add index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2188
+#: UI/GTK2/src/mainWindow.cc:2199
 msgid "Added new index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2223
+#: UI/GTK2/src/mainWindow.cc:2234
 msgid "Couldn't remove index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2393
+#: UI/GTK2/src/mainWindow.cc:2469
 msgid "At least one background task hasn't been completed yet. Quit now ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2618
+#: UI/GTK2/src/mainWindow.cc:2680
 msgid "Query name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2645
+#: UI/GTK2/src/mainWindow.cc:2707
 msgid "Couldn't update query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2653
+#: UI/GTK2/src/mainWindow.cc:2715
 msgid "Edited query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2660
+#: UI/GTK2/src/mainWindow.cc:2722
 msgid "Couldn't add query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2668
+#: UI/GTK2/src/mainWindow.cc:2730
 msgid "Added new query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2682
+#: UI/GTK2/src/mainWindow.cc:2744
 msgid "Query is not set"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2693
+#: UI/GTK2/src/mainWindow.cc:2755
 msgid "No search engine selected"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2775
+#: UI/GTK2/src/mainWindow.cc:2837
 msgid "Please set the Google API key first"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2784
+#: UI/GTK2/src/mainWindow.cc:2846
 msgid "Running query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2890
+#: UI/GTK2/src/mainWindow.cc:2951
 msgid "is already indexed or is being indexed"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "No URL to browse"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:2989
 msgid "No browser configured to view results"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2940
+#: UI/GTK2/src/mainWindow.cc:3001
 msgid "Couldn't browse URL:"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:3208
-msgid "thread(s)"
+#: UI/GTK2/src/mainWindow.cc:3230
+msgid "task(s) running"
 msgstr ""
 
 #: UI/GTK2/src/mainWindow_glade.cc:115
@@ -429,10 +414,6 @@
 msgid "List Contents Of"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow_glade.cc:201
-msgid "Import"
-msgstr ""
-
 #: UI/GTK2/src/mainWindow_glade.cc:210
 msgid "Update"
 msgstr ""
@@ -442,7 +423,7 @@
 msgstr ""
 
 #: UI/GTK2/src/mainWindow_glade.cc:216
-#: UI/GTK2/src/propertiesDialog_glade.cc:174
+#: UI/GTK2/src/propertiesDialog_glade.cc:171
 #: UI/GTK2/src/queryDialog_glade.cc:83
 msgid "Properties"
 msgstr ""
@@ -467,115 +448,119 @@
 msgid "_Help"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:57
-msgid "Couldn't save configuration file"
+#: UI/GTK2/src/mainWindow_glade.cc:356
+msgid "Pinot"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:136 UI/GTK2/src/pinot.cc:141
-msgid "is not valid, please check"
+#: UI/GTK2/src/pinot.cc:56
+msgid "Couldn't save configuration file"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:150
-msgid "History database"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:151
-msgid "couldn't be created"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:157
+#: UI/GTK2/src/pinot.cc:117
 msgid "Danish"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:158
+#: UI/GTK2/src/pinot.cc:118
 msgid "Dutch"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:159
+#: UI/GTK2/src/pinot.cc:119
 msgid "English"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:160
+#: UI/GTK2/src/pinot.cc:120
 msgid "Finnish"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:161
+#: UI/GTK2/src/pinot.cc:121
 msgid "French"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:162
+#: UI/GTK2/src/pinot.cc:122
 msgid "German"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:163
+#: UI/GTK2/src/pinot.cc:123
 msgid "Italian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:164
+#: UI/GTK2/src/pinot.cc:124
 msgid "Norwegian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:165
+#: UI/GTK2/src/pinot.cc:125
 msgid "Portuguese"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:166
+#: UI/GTK2/src/pinot.cc:126
 msgid "Russian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:167
+#: UI/GTK2/src/pinot.cc:127
 msgid "Spanish"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:168
+#: UI/GTK2/src/pinot.cc:128
 msgid "Swedish"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:105
+#: UI/GTK2/src/pinot.cc:149 UI/GTK2/src/pinot.cc:154
+msgid "is not valid, please check"
+msgstr ""
+
+#: UI/GTK2/src/pinot.cc:162
+msgid "History database"
+msgstr ""
+
+#: UI/GTK2/src/pinot.cc:163
+msgid "couldn't be created"
+msgstr ""
+
+#: UI/GTK2/src/PinotSettings.cpp:106
 msgid "Couldn't create pinot directory at"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:194
+#: UI/GTK2/src/PinotSettings.cpp:195
 msgid "Failed to parse configuration file"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:203
+#: UI/GTK2/src/PinotSettings.cpp:204
 msgid "Red"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:205
+#: UI/GTK2/src/PinotSettings.cpp:206
 msgid "Blue"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:207
+#: UI/GTK2/src/PinotSettings.cpp:208
 msgid "Green"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:279
+#: UI/GTK2/src/PinotSettings.cpp:280
 msgid "Couldn't load ui block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:286
+#: UI/GTK2/src/PinotSettings.cpp:287
 msgid "Couldn't load extraindex block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:293
+#: UI/GTK2/src/PinotSettings.cpp:294
 msgid "Couldn't load storedquery block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:300
+#: UI/GTK2/src/PinotSettings.cpp:301
 msgid "Couldn't load results block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:307
+#: UI/GTK2/src/PinotSettings.cpp:308
 msgid "Couldn't load label block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:325
+#: UI/GTK2/src/PinotSettings.cpp:326
 msgid "Couldn't load mailaccount block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:715
+#: UI/GTK2/src/PinotSettings.cpp:716
 msgid "Unclassified"
 msgstr ""
 
@@ -663,7 +648,7 @@
 msgid "Mail boxes of type mbox can be monitored and indexed:"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog_glade.cc:334
+#: UI/GTK2/src/prefsDialog_glade.cc:332
 msgid "Preferences"
 msgstr ""
 
@@ -679,7 +664,7 @@
 msgid "Language:"
 msgstr ""
 
-#: UI/GTK2/src/queryDialog.cc:86 UI/GTK2/src/queryDialog.cc:115
+#: UI/GTK2/src/queryDialog.cc:87 UI/GTK2/src/queryDialog.cc:116
 msgid "Any"
 msgstr ""
 
@@ -731,7 +716,7 @@
 msgid "Advanced"
 msgstr ""
 
-#: UI/GTK2/src/queryDialog_glade.cc:290
+#: UI/GTK2/src/queryDialog_glade.cc:283
 msgid "Query properties"
 msgstr ""
 
@@ -739,97 +724,97 @@
 msgid "Stopped browsing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:196 UI/GTK2/src/WorkerThreads.cpp:433
-#: UI/GTK2/src/WorkerThreads.cpp:481 UI/GTK2/src/WorkerThreads.cpp:491
-#: UI/GTK2/src/WorkerThreads.cpp:715 UI/GTK2/src/WorkerThreads.cpp:916
-#: UI/GTK2/src/WorkerThreads.cpp:1047
+#: UI/GTK2/src/WorkerThreads.cpp:196 UI/GTK2/src/WorkerThreads.cpp:440
+#: UI/GTK2/src/WorkerThreads.cpp:488 UI/GTK2/src/WorkerThreads.cpp:498
+#: UI/GTK2/src/WorkerThreads.cpp:722 UI/GTK2/src/WorkerThreads.cpp:927
+#: UI/GTK2/src/WorkerThreads.cpp:1058
 msgid "Index error on"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:302
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Stopped querying"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:314
+#: UI/GTK2/src/WorkerThreads.cpp:319
 msgid "Couldn't create search engine"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:326
+#: UI/GTK2/src/WorkerThreads.cpp:331
 msgid "Couldn't run query on search engine"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:405 UI/GTK2/src/WorkerThreads.cpp:472
+#: UI/GTK2/src/WorkerThreads.cpp:412 UI/GTK2/src/WorkerThreads.cpp:479
 msgid "Stopped querying index labels"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:565
+#: UI/GTK2/src/WorkerThreads.cpp:572
 msgid "Stopped retrieval of"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:601
+#: UI/GTK2/src/WorkerThreads.cpp:608
 msgid "Couldn't obtain downloader for protocol"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:615 UI/GTK2/src/WorkerThreads.cpp:729
+#: UI/GTK2/src/WorkerThreads.cpp:622 UI/GTK2/src/WorkerThreads.cpp:736
 msgid "Couldn't retrieve"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:700
+#: UI/GTK2/src/WorkerThreads.cpp:707
 msgid "Stopped indexing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:754
+#: UI/GTK2/src/WorkerThreads.cpp:761
 msgid "Cannot index document type"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:758
+#: UI/GTK2/src/WorkerThreads.cpp:765
 msgid "at"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:776
+#: UI/GTK2/src/WorkerThreads.cpp:790
 msgid "Couln't tokenize"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:797
+#: UI/GTK2/src/WorkerThreads.cpp:811
 msgid "Robots META tag forbids indexing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:839
+#: UI/GTK2/src/WorkerThreads.cpp:847
 msgid "Couldn't index"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:904
+#: UI/GTK2/src/WorkerThreads.cpp:915
 msgid "Stopped unindexing document(s)"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:924
+#: UI/GTK2/src/WorkerThreads.cpp:935
 msgid "Couldn't unindex document(s)"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1019
+#: UI/GTK2/src/WorkerThreads.cpp:1030
 msgid "Stopped document update for "
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1056
+#: UI/GTK2/src/WorkerThreads.cpp:1067
 msgid "Couldn't update document"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1096
+#: UI/GTK2/src/WorkerThreads.cpp:1107
 msgid "Stopped listening on"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1194
+#: UI/GTK2/src/WorkerThreads.cpp:1205
 msgid "Couldn't read FIFO at"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1234
+#: UI/GTK2/src/WorkerThreads.cpp:1245
 msgid "Stopped monitoring"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1252
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "No monitoring handler"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1286
+#: UI/GTK2/src/WorkerThreads.cpp:1297
 msgid "Couldn't open FAM connection"
 msgstr ""

Modified: trunk/po/fr_FR.po
===================================================================
--- trunk/po/fr_FR.po	2006-01-03 19:18:38 UTC (rev 51)
+++ trunk/po/fr_FR.po	2006-01-03 19:19:59 UTC (rev 52)
@@ -3,17 +3,6 @@
 # This file is distributed under the same license as the pinot package.
 # Fabrice Colin <colinf at chez.com>, 2005.
 #
-#: UI/GTK2/src/importDialog_glade.cc:110 UI/GTK2/src/importDialog_glade.cc:117
-#: UI/GTK2/src/indexDialog_glade.cc:94 UI/GTK2/src/indexDialog_glade.cc:124
-#: UI/GTK2/src/mainWindow_glade.cc:302 UI/GTK2/src/prefsDialog_glade.cc:153
-#: UI/GTK2/src/prefsDialog_glade.cc:164
-#: UI/GTK2/src/propertiesDialog_glade.cc:89
-#: UI/GTK2/src/propertiesDialog_glade.cc:130
-#: UI/GTK2/src/propertiesDialog_glade.cc:143
-#: UI/GTK2/src/queryDialog_glade.cc:115 UI/GTK2/src/queryDialog_glade.cc:126
-#: UI/GTK2/src/queryDialog_glade.cc:133 UI/GTK2/src/queryDialog_glade.cc:140
-#: UI/GTK2/src/queryDialog_glade.cc:205 UI/GTK2/src/queryDialog_glade.cc:212
-#: UI/GTK2/src/queryDialog_glade.cc:237
 #, fuzzy
 msgid ""
 msgstr ""
@@ -27,22 +16,6 @@
 "Content-Type: text/plain; charset=utf-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: UI/GTK2/src/aboutDialog_glade.cc:342 UI/GTK2/src/mainWindow_glade.cc:357
-msgid "Pinot"
-msgstr "Pinot"
-
-#: UI/GTK2/src/aboutDialog_glade.cc:344
-msgid "A metasearch tool for the Free Desktop."
-msgstr "Un outil de recherche pour le Bureau Libre"
-
-#: UI/GTK2/src/aboutDialog_glade.cc:345
-msgid "Copyright (C) 2005 Fabrice Colin"
-msgstr "Copyright (C) 2005 Fabrice Colin"
-
-#: UI/GTK2/src/aboutDialog_glade.cc:388
-msgid "About Pinot"
-msgstr "A Propos de Pinot"
-
 #: UI/GTK2/src/EnginesTree.cpp:67
 msgid "Search Engines"
 msgstr "Moteurs"
@@ -51,62 +24,66 @@
 msgid "Current User"
 msgstr "Utilisateur"
 
-#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:372
-#: UI/GTK2/src/mainWindow.cc:375 UI/GTK2/src/mainWindow.cc:537
-#: UI/GTK2/src/mainWindow.cc:1116 UI/GTK2/src/mainWindow.cc:1187
-#: UI/GTK2/src/PinotSettings.cpp:198 UI/GTK2/src/PinotSettings.cpp:864
-#: UI/GTK2/src/PinotSettings.cpp:920
+#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:381
+#: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:557
+#: UI/GTK2/src/mainWindow.cc:1111 UI/GTK2/src/mainWindow.cc:1213
+#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:865
+#: UI/GTK2/src/PinotSettings.cpp:921
 msgid "My Documents"
 msgstr "Mes Documents"
 
-#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:378
-#: UI/GTK2/src/mainWindow.cc:381 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/MonitorHandler.cpp:174 UI/GTK2/src/PinotSettings.cpp:199
-#: UI/GTK2/src/PinotSettings.cpp:865 UI/GTK2/src/PinotSettings.cpp:921
+#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:387
+#: UI/GTK2/src/mainWindow.cc:390 UI/GTK2/src/mainWindow.cc:561
+#: UI/GTK2/src/MonitorHandler.cpp:174 UI/GTK2/src/PinotSettings.cpp:200
+#: UI/GTK2/src/PinotSettings.cpp:866 UI/GTK2/src/PinotSettings.cpp:922
 #: UI/GTK2/src/prefsDialog_glade.cc:116
 msgid "My Email"
 msgstr "Mon Courrier"
 
-#: UI/GTK2/src/importDialog.cc:92
+#: UI/GTK2/src/importDialog.cc:91
 msgid "Single file"
 msgstr "Un fichier"
 
-#: UI/GTK2/src/importDialog.cc:95
+#: UI/GTK2/src/importDialog.cc:94
 msgid "Whole directory"
 msgstr "Un repertoire"
 
-#: UI/GTK2/src/importDialog.cc:100 UI/GTK2/src/IndexTree.cpp:71
+#: UI/GTK2/src/importDialog.cc:99 UI/GTK2/src/IndexTree.cpp:71
 #: UI/GTK2/src/ResultsTree.cpp:114
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/importDialog.cc:249
+#: UI/GTK2/src/importDialog.cc:265
 msgid "Document To Import"
 msgstr "Document A Importer"
 
-#: UI/GTK2/src/importDialog_glade.cc:64
+#: UI/GTK2/src/importDialog_glade.cc:61 UI/GTK2/src/mainWindow_glade.cc:201
+msgid "Import"
+msgstr "Importer"
+
+#: UI/GTK2/src/importDialog_glade.cc:65
 msgid "Select"
 msgstr "Selectionner"
 
-#: UI/GTK2/src/importDialog_glade.cc:73 UI/GTK2/src/indexDialog_glade.cc:68
+#: UI/GTK2/src/importDialog_glade.cc:74 UI/GTK2/src/indexDialog_glade.cc:68
 msgid "Location:"
 msgstr "Location:"
 
-#: UI/GTK2/src/importDialog_glade.cc:74
+#: UI/GTK2/src/importDialog_glade.cc:75
 #: UI/GTK2/src/propertiesDialog_glade.cc:64
 msgid "Title:"
 msgstr "Titre:"
 
-#: UI/GTK2/src/importDialog_glade.cc:75
+#: UI/GTK2/src/importDialog_glade.cc:76
 msgid "Maximum depth:"
 msgstr "Profondeur maximum:"
 
-#: UI/GTK2/src/importDialog_glade.cc:81 UI/GTK2/src/indexDialog_glade.cc:67
+#: UI/GTK2/src/importDialog_glade.cc:82 UI/GTK2/src/indexDialog_glade.cc:67
 #: UI/GTK2/src/propertiesDialog_glade.cc:68
 msgid "Type:"
 msgstr "Type:"
 
-#: UI/GTK2/src/importDialog_glade.cc:163
+#: UI/GTK2/src/importDialog_glade.cc:162
 msgid "Import document"
 msgstr "Importation de document"
 
@@ -126,7 +103,7 @@
 msgid "Port:"
 msgstr "Port:"
 
-#: UI/GTK2/src/indexDialog_glade.cc:145
+#: UI/GTK2/src/indexDialog_glade.cc:143
 msgid "External index"
 msgstr "Index externe"
 
@@ -138,7 +115,7 @@
 msgid "Timestamp"
 msgstr "Date"
 
-#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:340
+#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:347
 msgid "No title"
 msgstr "Pas de titre"
 
@@ -151,234 +128,242 @@
 msgstr "Suivants"
 
 #: UI/GTK2/src/IndexPage.cpp:159 UI/GTK2/src/IndexPage.cpp:205
-#: UI/GTK2/src/queryDialog.cc:81
+#: UI/GTK2/src/queryDialog.cc:82
 msgid "None"
 msgstr "Aucune"
 
-#: UI/GTK2/src/mainWindow.cc:168
+#: UI/GTK2/src/mainWindow.cc:179
 msgid "Query Name"
 msgstr "Nom de la Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:173
+#: UI/GTK2/src/mainWindow.cc:184
 msgid "Last Run"
 msgstr "Derniere Utilisation"
 
-#: UI/GTK2/src/mainWindow.cc:174
+#: UI/GTK2/src/mainWindow.cc:185
 msgid "Summary"
 msgstr "Sommaire"
 
-#: UI/GTK2/src/mainWindow.cc:234
+#: UI/GTK2/src/mainWindow.cc:242
 msgid "Add index"
 msgstr "Ajouter un index"
 
-#: UI/GTK2/src/mainWindow.cc:235
+#: UI/GTK2/src/mainWindow.cc:243
 msgid "Remove index"
 msgstr "Enlever un index"
 
-#: UI/GTK2/src/mainWindow.cc:258
+#: UI/GTK2/src/mainWindow.cc:267
 msgid "Ready"
 msgstr "Pret"
 
-#: UI/GTK2/src/mainWindow.cc:277 UI/GTK2/src/mainWindow.cc:1056
-#: UI/GTK2/src/mainWindow.cc:1433 UI/GTK2/src/mainWindow.cc:2959
+#: UI/GTK2/src/mainWindow.cc:286 UI/GTK2/src/mainWindow.cc:1075
+#: UI/GTK2/src/mainWindow.cc:1437 UI/GTK2/src/mainWindow.cc:3020
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr "Voir"
 
-#: UI/GTK2/src/mainWindow.cc:309
+#: UI/GTK2/src/mainWindow.cc:318
 msgid "N/A"
 msgstr "Inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:319
+#: UI/GTK2/src/mainWindow.cc:328
 msgid "<undefined>"
 msgstr "<inconnu>"
 
-#: UI/GTK2/src/mainWindow.cc:499
+#: UI/GTK2/src/mainWindow.cc:519
 msgid "Result location is"
 msgstr "La location du resultat est"
 
-#: UI/GTK2/src/mainWindow.cc:552
+#: UI/GTK2/src/mainWindow.cc:572
 msgid "Document location is"
 msgstr "La location du document is"
 
-#: UI/GTK2/src/mainWindow.cc:663
+#: UI/GTK2/src/mainWindow.cc:681
 msgid "No label"
 msgstr "Pas d'etiquette"
 
-#: UI/GTK2/src/mainWindow.cc:839
+#: UI/GTK2/src/mainWindow.cc:856
 msgid "Showing"
 msgstr "Listant"
 
-#: UI/GTK2/src/mainWindow.cc:844
+#: UI/GTK2/src/mainWindow.cc:861
 msgid "off"
 msgstr "de"
 
-#: UI/GTK2/src/mainWindow.cc:849
-msgid "documents from"
+#: UI/GTK2/src/mainWindow.cc:866
+msgid "documents, starting at"
 msgstr "documents venant de"
 
-#: UI/GTK2/src/mainWindow.cc:882
+#: UI/GTK2/src/mainWindow.cc:900
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:886 UI/GTK2/src/mainWindow.cc:2788
+#: UI/GTK2/src/mainWindow.cc:904 UI/GTK2/src/mainWindow.cc:2850
 msgid "on"
 msgstr "sur"
 
-#: UI/GTK2/src/mainWindow.cc:890
+#: UI/GTK2/src/mainWindow.cc:908
 msgid "ended"
 msgstr "est terminee"
 
-#: UI/GTK2/src/mainWindow.cc:990 UI/GTK2/src/propertiesDialog.cc:34
+#: UI/GTK2/src/mainWindow.cc:1009 UI/GTK2/src/propertiesDialog.cc:34
 msgid "Label"
 msgstr "L'etiquette"
 
-#: UI/GTK2/src/mainWindow.cc:994
+#: UI/GTK2/src/mainWindow.cc:1013
 msgid "matches"
 msgstr "correspond a"
 
-#: UI/GTK2/src/mainWindow.cc:999
+#: UI/GTK2/src/mainWindow.cc:1018
 msgid "document(s)"
 msgstr "document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1031
+#: UI/GTK2/src/mainWindow.cc:1050
 msgid "Updated label(s)"
 msgstr "Mis a jour l(es) etiquette(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1092 UI/GTK2/src/mainWindow.cc:1198
+#: UI/GTK2/src/mainWindow.cc:1121 UI/GTK2/src/mainWindow.cc:1224
 msgid "Updated document"
 msgstr "Mis a jour le document"
 
-#: UI/GTK2/src/mainWindow.cc:1099
+#: UI/GTK2/src/mainWindow.cc:1134
 msgid "Indexed"
 msgstr "Indexe"
 
-#: UI/GTK2/src/mainWindow.cc:1169
+#: UI/GTK2/src/mainWindow.cc:1195
 msgid "Unindexed document(s)"
 msgstr "Desindexe le(s) document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1255
+#: UI/GTK2/src/mainWindow.cc:1275
 msgid "Couldn't rename index, name"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1259 UI/GTK2/src/mainWindow.cc:2163
-#: UI/GTK2/src/mainWindow.cc:2622
+#: UI/GTK2/src/mainWindow.cc:1279 UI/GTK2/src/mainWindow.cc:2174
+#: UI/GTK2/src/mainWindow.cc:2684
 msgid "is already in use"
 msgstr "est deja utilise"
 
-#: UI/GTK2/src/mainWindow.cc:1272
+#: UI/GTK2/src/mainWindow.cc:1292
 msgid "Couldn't rename index"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1285
+#: UI/GTK2/src/mainWindow.cc:1305
 msgid "Edited index"
 msgstr "Edite l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1775 UI/GTK2/src/mainWindow.cc:1856
+#: UI/GTK2/src/mainWindow.cc:1779 UI/GTK2/src/mainWindow.cc:1860
 msgid "Please set a location for the index first"
 msgstr "Donnez une location a l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1802
+#: UI/GTK2/src/mainWindow.cc:1806
 msgid "Result location is unknown"
 msgstr "La location du resultat est inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:1818
+#: UI/GTK2/src/mainWindow.cc:1822
 msgid "Import Document(s)"
 msgstr "Importation de Document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1934 UI/GTK2/src/pinot.cc:135
-#: UI/GTK2/src/pinot.cc:140 UI/GTK2/src/WorkerThreads.cpp:183
-#: UI/GTK2/src/WorkerThreads.cpp:421 UI/GTK2/src/WorkerThreads.cpp:1034
+#: UI/GTK2/src/mainWindow.cc:1938 UI/GTK2/src/pinot.cc:148
+#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:183
+#: UI/GTK2/src/WorkerThreads.cpp:428 UI/GTK2/src/WorkerThreads.cpp:1045
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:1938 UI/GTK2/src/WorkerThreads.cpp:187
-#: UI/GTK2/src/WorkerThreads.cpp:425 UI/GTK2/src/WorkerThreads.cpp:1038
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/WorkerThreads.cpp:187
+#: UI/GTK2/src/WorkerThreads.cpp:432 UI/GTK2/src/WorkerThreads.cpp:1049
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
-#: UI/GTK2/src/mainWindow.cc:2050
+#: UI/GTK2/src/mainWindow.cc:2054
 msgid "Delete this document from the index ?"
 msgstr "Enlever ce document de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2069
+#: UI/GTK2/src/mainWindow.cc:2073
 msgid "Delete these documents from the index ?"
 msgstr "Enlever ces documents de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2159
+#: UI/GTK2/src/mainWindow.cc:2125
+msgid "A metasearch tool for the Free Desktop"
+msgstr "Un outil de recherche pour le Bureau Libre"
+
+#: UI/GTK2/src/mainWindow.cc:2126
+msgid "(C) 2005-2006 Fabrice Colin"
+msgstr "(C) 2005-2006 Fabrice Colin"
+
+#: UI/GTK2/src/mainWindow.cc:2170
 msgid "Index name"
 msgstr "Nom de l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2174
+#: UI/GTK2/src/mainWindow.cc:2185
 msgid "Couldn't add index"
 msgstr "N'a pas pu ajouter l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2188
+#: UI/GTK2/src/mainWindow.cc:2199
 msgid "Added new index"
 msgstr "Ajouter un nouvel index"
 
-#: UI/GTK2/src/mainWindow.cc:2223
+#: UI/GTK2/src/mainWindow.cc:2234
 msgid "Couldn't remove index"
 msgstr "N'a pas pu enlever l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2393
+#: UI/GTK2/src/mainWindow.cc:2469
 msgid "At least one background task hasn't been completed yet. Quit now ?"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2618
+#: UI/GTK2/src/mainWindow.cc:2680
 msgid "Query name"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2645
+#: UI/GTK2/src/mainWindow.cc:2707
 msgid "Couldn't update query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2653
+#: UI/GTK2/src/mainWindow.cc:2715
 msgid "Edited query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2660
+#: UI/GTK2/src/mainWindow.cc:2722
 msgid "Couldn't add query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2668
+#: UI/GTK2/src/mainWindow.cc:2730
 msgid "Added new query"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2682
+#: UI/GTK2/src/mainWindow.cc:2744
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2693
+#: UI/GTK2/src/mainWindow.cc:2755
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:2775
+#: UI/GTK2/src/mainWindow.cc:2837
 msgid "Please set the Google API key first"
 msgstr "Configurez la clef de l'API Google "
 
-#: UI/GTK2/src/mainWindow.cc:2784
+#: UI/GTK2/src/mainWindow.cc:2846
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:2890
+#: UI/GTK2/src/mainWindow.cc:2951
 msgid "is already indexed or is being indexed"
 msgstr "est deja indexe ou est en cours d'indexation"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "No URL to browse"
 msgstr "Pas d'URL a brouter"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:2989
 msgid "No browser configured to view results"
 msgstr "Pas de brouter configure"
 
-#: UI/GTK2/src/mainWindow.cc:2940
+#: UI/GTK2/src/mainWindow.cc:3001
 msgid "Couldn't browse URL:"
 msgstr "N'a pas pu brouter l'URL"
 
-#: UI/GTK2/src/mainWindow.cc:3208
-msgid "thread(s)"
+#: UI/GTK2/src/mainWindow.cc:3230
+msgid "task(s) running"
 msgstr "tache(s)"
 
 #: UI/GTK2/src/mainWindow_glade.cc:115
@@ -429,10 +414,6 @@
 msgid "List Contents Of"
 msgstr "Lister le Contenu de"
 
-#: UI/GTK2/src/mainWindow_glade.cc:201
-msgid "Import"
-msgstr "Importer"
-
 #: UI/GTK2/src/mainWindow_glade.cc:210
 msgid "Update"
 msgstr "Mettre a Jour"
@@ -442,7 +423,7 @@
 msgstr "Desindexer"
 
 #: UI/GTK2/src/mainWindow_glade.cc:216
-#: UI/GTK2/src/propertiesDialog_glade.cc:174
+#: UI/GTK2/src/propertiesDialog_glade.cc:171
 #: UI/GTK2/src/queryDialog_glade.cc:83
 msgid "Properties"
 msgstr "Proprietes"
@@ -467,115 +448,119 @@
 msgid "_Help"
 msgstr "Aide"
 
-#: UI/GTK2/src/pinot.cc:57
-msgid "Couldn't save configuration file"
-msgstr "N'a pas pu sauver la configuration"
-
-#: UI/GTK2/src/pinot.cc:136 UI/GTK2/src/pinot.cc:141
-msgid "is not valid, please check"
-msgstr "n'est pas valide, veuillez verifier"
-
-#: UI/GTK2/src/pinot.cc:150
-msgid "History database"
+#: UI/GTK2/src/mainWindow_glade.cc:356
+msgid "Pinot"
 msgstr "La base des historiques"
 
-#: UI/GTK2/src/pinot.cc:151
-msgid "couldn't be created"
+#: UI/GTK2/src/pinot.cc:56
+msgid "Couldn't save configuration file"
 msgstr "n'a pas pu etre creee"
 
-#: UI/GTK2/src/pinot.cc:157
+#: UI/GTK2/src/pinot.cc:117
 msgid "Danish"
 msgstr "Danois"
 
-#: UI/GTK2/src/pinot.cc:158
+#: UI/GTK2/src/pinot.cc:118
 msgid "Dutch"
 msgstr "Hollandais"
 
-#: UI/GTK2/src/pinot.cc:159
+#: UI/GTK2/src/pinot.cc:119
 msgid "English"
 msgstr "Anglais"
 
-#: UI/GTK2/src/pinot.cc:160
+#: UI/GTK2/src/pinot.cc:120
 msgid "Finnish"
 msgstr "Finlandais"
 
-#: UI/GTK2/src/pinot.cc:161
+#: UI/GTK2/src/pinot.cc:121
 msgid "French"
 msgstr "Francais"
 
-#: UI/GTK2/src/pinot.cc:162
+#: UI/GTK2/src/pinot.cc:122
 msgid "German"
 msgstr "Allemand"
 
-#: UI/GTK2/src/pinot.cc:163
+#: UI/GTK2/src/pinot.cc:123
 msgid "Italian"
 msgstr "Italien"
 
-#: UI/GTK2/src/pinot.cc:164
+#: UI/GTK2/src/pinot.cc:124
 msgid "Norwegian"
 msgstr "Norvegien"
 
-#: UI/GTK2/src/pinot.cc:165
+#: UI/GTK2/src/pinot.cc:125
 msgid "Portuguese"
 msgstr "Portugais"
 
-#: UI/GTK2/src/pinot.cc:166
+#: UI/GTK2/src/pinot.cc:126
 msgid "Russian"
 msgstr "Russe"
 
-#: UI/GTK2/src/pinot.cc:167
+#: UI/GTK2/src/pinot.cc:127
 msgid "Spanish"
 msgstr "Espagnol"
 
-#: UI/GTK2/src/pinot.cc:168
+#: UI/GTK2/src/pinot.cc:128
 msgid "Swedish"
 msgstr "Suedois"
 
-#: UI/GTK2/src/PinotSettings.cpp:105
+#: UI/GTK2/src/pinot.cc:149 UI/GTK2/src/pinot.cc:154
+msgid "is not valid, please check"
+msgstr "n'est pas valide, veuillez verifier"
+
+#: UI/GTK2/src/pinot.cc:162
+msgid "History database"
+msgstr "La base des historiques"
+
+#: UI/GTK2/src/pinot.cc:163
+msgid "couldn't be created"
+msgstr "n'a pas pu etre creee"
+
+#: UI/GTK2/src/PinotSettings.cpp:106
 msgid "Couldn't create pinot directory at"
 msgstr "N'a pas pu creer le repertoire a"
 
-#: UI/GTK2/src/PinotSettings.cpp:194
+#: UI/GTK2/src/PinotSettings.cpp:195
 msgid "Failed to parse configuration file"
 msgstr "N'a pas pu lire le fichier de configuration"
 
-#: UI/GTK2/src/PinotSettings.cpp:203
+#: UI/GTK2/src/PinotSettings.cpp:204
 msgid "Red"
 msgstr "Rouge"
 
-#: UI/GTK2/src/PinotSettings.cpp:205
+#: UI/GTK2/src/PinotSettings.cpp:206
 msgid "Blue"
 msgstr "Bleu"
 
-#: UI/GTK2/src/PinotSettings.cpp:207
+#: UI/GTK2/src/PinotSettings.cpp:208
 msgid "Green"
 msgstr "Vert"
 
-#: UI/GTK2/src/PinotSettings.cpp:279
+#: UI/GTK2/src/PinotSettings.cpp:280
 msgid "Couldn't load ui block"
 msgstr "N'a pas pu charger le bloc ui"
 
-#: UI/GTK2/src/PinotSettings.cpp:286
+#: UI/GTK2/src/PinotSettings.cpp:287
 msgid "Couldn't load extraindex block"
 msgstr "N'a pas pu charger le bloc extraindex"
 
-#: UI/GTK2/src/PinotSettings.cpp:293
+#: UI/GTK2/src/PinotSettings.cpp:294
 msgid "Couldn't load storedquery block"
 msgstr "N'a pas pu charger le bloc storedquery"
 
-#: UI/GTK2/src/PinotSettings.cpp:300
+#: UI/GTK2/src/PinotSettings.cpp:301
 msgid "Couldn't load results block"
 msgstr "N'a pas pu charger le bloc results"
 
-#: UI/GTK2/src/PinotSettings.cpp:307
+#: UI/GTK2/src/PinotSettings.cpp:308
 msgid "Couldn't load label block"
 msgstr "N'a pas pu charger le bloc label"
 
-#: UI/GTK2/src/PinotSettings.cpp:325
+#: UI/GTK2/src/PinotSettings.cpp:326
 msgid "Couldn't load mailaccount block"
 msgstr "N'a pas pu charger le bloc mailaccount"
 
-#: UI/GTK2/src/PinotSettings.cpp:715
+#: UI/GTK2/src/PinotSettings.cpp:716
 msgid "Unclassified"
 msgstr "Non classifie"
 
@@ -663,7 +648,7 @@
 msgid "Mail boxes of type mbox can be monitored and indexed:"
 msgstr "Les boites de type mbox peuvent etre indexees"
 
-#: UI/GTK2/src/prefsDialog_glade.cc:334
+#: UI/GTK2/src/prefsDialog_glade.cc:332
 msgid "Preferences"
 msgstr "Preferences"
 
@@ -679,7 +664,7 @@
 msgid "Language:"
 msgstr "Langue:"
 
-#: UI/GTK2/src/queryDialog.cc:86 UI/GTK2/src/queryDialog.cc:115
+#: UI/GTK2/src/queryDialog.cc:87 UI/GTK2/src/queryDialog.cc:116
 msgid "Any"
 msgstr "N'importe"
 
@@ -731,7 +716,7 @@
 msgid "Advanced"
 msgstr "Avance"
 
-#: UI/GTK2/src/queryDialog_glade.cc:290
+#: UI/GTK2/src/queryDialog_glade.cc:283
 msgid "Query properties"
 msgstr "Proprietes de la recherche"
 
@@ -739,97 +724,97 @@
 msgid "Stopped browsing"
 msgstr "Arrete le brouteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:196 UI/GTK2/src/WorkerThreads.cpp:433
-#: UI/GTK2/src/WorkerThreads.cpp:481 UI/GTK2/src/WorkerThreads.cpp:491
-#: UI/GTK2/src/WorkerThreads.cpp:715 UI/GTK2/src/WorkerThreads.cpp:916
-#: UI/GTK2/src/WorkerThreads.cpp:1047
+#: UI/GTK2/src/WorkerThreads.cpp:196 UI/GTK2/src/WorkerThreads.cpp:440
+#: UI/GTK2/src/WorkerThreads.cpp:488 UI/GTK2/src/WorkerThreads.cpp:498
+#: UI/GTK2/src/WorkerThreads.cpp:722 UI/GTK2/src/WorkerThreads.cpp:927
+#: UI/GTK2/src/WorkerThreads.cpp:1058
 msgid "Index error on"
 msgstr "Erreur d'index sur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:302
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Stopped querying"
 msgstr "Arrete la recherche"
 
-#: UI/GTK2/src/WorkerThreads.cpp:314
+#: UI/GTK2/src/WorkerThreads.cpp:319
 msgid "Couldn't create search engine"
 msgstr "N'a pas pu creer le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:326
+#: UI/GTK2/src/WorkerThreads.cpp:331
 msgid "Couldn't run query on search engine"
 msgstr "N'a pas pu lancer la recherche sur le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:405 UI/GTK2/src/WorkerThreads.cpp:472
+#: UI/GTK2/src/WorkerThreads.cpp:412 UI/GTK2/src/WorkerThreads.cpp:479
 msgid "Stopped querying index labels"
 msgstr "Arrete la recherche d'etiquettes"
 
-#: UI/GTK2/src/WorkerThreads.cpp:565
+#: UI/GTK2/src/WorkerThreads.cpp:572
 msgid "Stopped retrieval of"
 msgstr "Arrete le telechargement de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:601
+#: UI/GTK2/src/WorkerThreads.cpp:608
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N'a pas pu obtenir un brouteur pour ="
 
-#: UI/GTK2/src/WorkerThreads.cpp:615 UI/GTK2/src/WorkerThreads.cpp:729
+#: UI/GTK2/src/WorkerThreads.cpp:622 UI/GTK2/src/WorkerThreads.cpp:736
 msgid "Couldn't retrieve"
 msgstr "N'a pas pu telecharger"
 
-#: UI/GTK2/src/WorkerThreads.cpp:700
+#: UI/GTK2/src/WorkerThreads.cpp:707
 msgid "Stopped indexing"
 msgstr "Arrete l'indexation"
 
-#: UI/GTK2/src/WorkerThreads.cpp:754
+#: UI/GTK2/src/WorkerThreads.cpp:761
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer de type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:758
+#: UI/GTK2/src/WorkerThreads.cpp:765
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:776
+#: UI/GTK2/src/WorkerThreads.cpp:790
 msgid "Couln't tokenize"
 msgstr "N'a pas pu tokenise"
 
-#: UI/GTK2/src/WorkerThreads.cpp:797
+#: UI/GTK2/src/WorkerThreads.cpp:811
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots empeche d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:839
+#: UI/GTK2/src/WorkerThreads.cpp:847
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:904
+#: UI/GTK2/src/WorkerThreads.cpp:915
 msgid "Stopped unindexing document(s)"
 msgstr "Arrete d'indexer les document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:924
+#: UI/GTK2/src/WorkerThreads.cpp:935
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1019
+#: UI/GTK2/src/WorkerThreads.cpp:1030
 msgid "Stopped document update for "
 msgstr "Arrete la mise a jour pour "
 
-#: UI/GTK2/src/WorkerThreads.cpp:1056
+#: UI/GTK2/src/WorkerThreads.cpp:1067
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1096
+#: UI/GTK2/src/WorkerThreads.cpp:1107
 msgid "Stopped listening on"
 msgstr "Arrete l'ecoute sur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1194
+#: UI/GTK2/src/WorkerThreads.cpp:1205
 msgid "Couldn't read FIFO at"
 msgstr "N'a pas pu lire la FIFO a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1234
+#: UI/GTK2/src/WorkerThreads.cpp:1245
 msgid "Stopped monitoring"
 msgstr "Arrete la surveillance"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1252
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "No monitoring handler"
 msgstr "Pas de moniteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1286
+#: UI/GTK2/src/WorkerThreads.cpp:1297
 msgid "Couldn't open FAM connection"
 msgstr "N'a pas pu ouvrir la connection FAM"



From fabricecolin at berlios.de  Tue Jan 10 10:46:30 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 10 Jan 2006 10:46:30 +0100
Subject: [Pinot-svn] r53 - in trunk: Index Tokenize UI/GTK2 UI/GTK2/src
Message-ID: <200601100946.k0A9kUh2024771@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-10 10:46:28 +0100 (Tue, 10 Jan 2006)
New Revision: 53

Modified:
   trunk/Index/LanguageDetector.cpp
   trunk/Index/Summarizer.cpp
   trunk/Tokenize/TokenizerFactory.cpp
   trunk/Tokenize/TokenizerFactory.h
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/ModelColumns.cpp
   trunk/UI/GTK2/src/ModelColumns.h
   trunk/UI/GTK2/src/PinotUtils.cpp
   trunk/UI/GTK2/src/PinotUtils.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/UI/GTK2/src/importDialog_glade.cc
   trunk/UI/GTK2/src/importDialog_glade.hh
   trunk/UI/GTK2/src/indexDialog.cc
   trunk/UI/GTK2/src/indexDialog.hh
   trunk/UI/GTK2/src/indexDialog_glade.cc
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/prefsDialog.cc
   trunk/UI/GTK2/src/prefsDialog.hh
   trunk/UI/GTK2/src/prefsDialog_glade.cc
   trunk/UI/GTK2/src/propertiesDialog.cc
   trunk/UI/GTK2/src/propertiesDialog.hh
   trunk/UI/GTK2/src/propertiesDialog_glade.cc
   trunk/UI/GTK2/src/queryDialog.cc
   trunk/UI/GTK2/src/queryDialog.hh
   trunk/UI/GTK2/src/queryDialog_glade.cc
Log:
Tweaked user interface. Redone importDialog; documents are now imported
directly and not handled by the main window.


Modified: trunk/Index/LanguageDetector.cpp
===================================================================
--- trunk/Index/LanguageDetector.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/Index/LanguageDetector.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -137,7 +137,7 @@
 #endif
 #ifdef DEBUG
 	cout << "LanguageDetector::guessLanguage: language guessing with "
-		<< textcat_Version() << " took " << timer.stop() << " us" << endl;
+		<< textcat_Version() << " took " << timer.stop()/1000 << " ms" << endl;
 #endif
 
 	// Close the descriptor

Modified: trunk/Index/Summarizer.cpp
===================================================================
--- trunk/Index/Summarizer.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/Index/Summarizer.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -91,7 +91,7 @@
 			pSummary = ots_get_doc_text(pArticle, &outputLen);
 #ifdef DEBUG
 			cout << "Summarizer::summarize: summarized to " << outputLen << " bytes in "
-				<< timer.stop() << " us " << endl;
+				<< timer.stop()/1000 << " ms" << endl;
 #endif
 
 			// Get the title before freeing the article

Modified: trunk/Tokenize/TokenizerFactory.cpp
===================================================================
--- trunk/Tokenize/TokenizerFactory.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/Tokenize/TokenizerFactory.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -148,7 +148,7 @@
 				if ((stat(fileName.c_str(), &fileStat) == 0) &&
 					(S_ISREG(fileStat.st_mode)))
 				{
-					void *pHandle = dlopen(fileName.c_str(), RTLD_LAZY);
+					void *pHandle = dlopen(fileName.c_str(), RTLD_LAZY|RTLD_LOCAL);
 					if (pHandle != NULL)
 					{
 						// What type does this support ?
@@ -177,6 +177,9 @@
 						else cout << "TokenizerFactory::loadTokenizers: couldn't find export getTokenizerType" << endl;
 #endif
 					}
+#ifdef DEBUG
+					else cout << "TokenizerFactory::loadTokenizers: couldn't open " << fileName << endl;
+#endif
 				}
 #ifdef DEBUG
 				else cout << "TokenizerFactory::loadTokenizers: "
@@ -262,6 +265,19 @@
 	return pTokenizer;
 }
 
+void TokenizerFactory::getSupportedTypes(set<string> &types)
+{
+	types.clear();
+
+	// List supported types
+	types.insert("text/plain");
+	types.insert("text/html");
+	for (map<string, string>::iterator iter = m_types.begin(); iter != m_types.end(); ++iter)
+	{
+		types.insert(iter->first);
+	}
+}
+
 bool TokenizerFactory::isSupportedType(const string &type)
 {
 	string typeOnly = type;
@@ -292,4 +308,3 @@
 
 	return false;
 }
-

Modified: trunk/Tokenize/TokenizerFactory.h
===================================================================
--- trunk/Tokenize/TokenizerFactory.h	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/Tokenize/TokenizerFactory.h	2006-01-10 09:46:28 UTC (rev 53)
@@ -24,6 +24,7 @@
 
 #include <string>
 #include <map>
+#include <set>
 
 class TokenizerFactory
 {
@@ -47,6 +48,9 @@
 		/// Returns a Tokenizer that handles the given MIME type; NULL if unavailable.
 		static Tokenizer *getTokenizerByType(const string &type, const Document *pDocument);
 
+		/// Returns all supported MIME types.
+		static void getSupportedTypes(set<string> &types);
+
 		/// Indicates whether a MIME type is supported or not.
 		static bool isSupportedType(const string &type);
 

Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-01-10 09:46:28 UTC (rev 53)
@@ -145,7 +145,7 @@
 		      <signal name="activate" handler="on_clearresults_activate" last_modification_time="Wed, 03 Mar 2004 19:51:48 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image546">
+			<widget class="GtkImage" id="image569">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-clear</property>
 			  <property name="icon_size">1</property>
@@ -273,7 +273,7 @@
 		      <signal name="activate" handler="on_import_activate" last_modification_time="Tue, 02 Mar 2004 22:13:44 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image547">
+			<widget class="GtkImage" id="image570">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-open</property>
 			  <property name="icon_size">1</property>
@@ -311,7 +311,7 @@
 		      <signal name="activate" handler="on_refreshindex_activate" last_modification_time="Fri, 20 Feb 2004 18:57:09 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image548">
+			<widget class="GtkImage" id="image571">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-refresh</property>
 			  <property name="icon_size">1</property>
@@ -333,7 +333,7 @@
 		      <signal name="activate" handler="on_unindex_activate" last_modification_time="Thu, 28 Jul 2005 12:42:23 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image549">
+			<widget class="GtkImage" id="image572">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-delete</property>
 			  <property name="icon_size">1</property>
@@ -355,7 +355,7 @@
 		      <signal name="activate" handler="on_showfromindex_activate" last_modification_time="Sun, 06 Nov 2005 08:43:05 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image550">
+			<widget class="GtkImage" id="image573">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-properties</property>
 			  <property name="icon_size">1</property>
@@ -609,7 +609,7 @@
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
 		  <property name="can_focus">True</property>
-		  <property name="expanded">False</property>
+		  <property name="expanded">True</property>
 		  <property name="spacing">0</property>
 
 		  <child>
@@ -1149,7 +1149,7 @@
 		<widget class="GtkHBox" id="browserHbox">
 		  <property name="visible">True</property>
 		  <property name="homogeneous">False</property>
-		  <property name="spacing">0</property>
+		  <property name="spacing">4</property>
 
 		  <child>
 		    <widget class="GtkEntry" id="browserEntry">
@@ -1184,7 +1184,7 @@
 		      <signal name="clicked" handler="on_browserButton_clicked" last_modification_time="Sun, 10 Aug 2003 10:20:18 GMT"/>
 		    </widget>
 		    <packing>
-		      <property name="padding">4</property>
+		      <property name="padding">0</property>
 		      <property name="expand">False</property>
 		      <property name="fill">False</property>
 		    </packing>
@@ -2611,7 +2611,6 @@
 
 <widget class="GtkDialog" id="propertiesDialog">
   <property agent="glademm" name="cxx_visibility">public</property>
-  <property name="visible">True</property>
   <property name="title" translatable="yes">Properties</property>
   <property name="type">GTK_WINDOW_TOPLEVEL</property>
   <property name="window_position">GTK_WIN_POS_NONE</property>
@@ -3080,7 +3079,7 @@
 	    <widget class="GtkHBox" id="locationHbox">
 	      <property name="visible">True</property>
 	      <property name="homogeneous">False</property>
-	      <property name="spacing">0</property>
+	      <property name="spacing">4</property>
 
 	      <child>
 		<widget class="GtkEntry" id="locationEntry">
@@ -3116,7 +3115,7 @@
 		  <signal name="clicked" handler="on_locationButton_clicked" last_modification_time="Tue, 15 Feb 2005 18:12:48 GMT"/>
 		</widget>
 		<packing>
-		  <property name="padding">4</property>
+		  <property name="padding">0</property>
 		  <property name="expand">False</property>
 		  <property name="fill">False</property>
 		</packing>
@@ -3298,7 +3297,6 @@
 </widget>
 
 <widget class="GtkDialog" id="importDialog">
-  <property name="visible">True</property>
   <property name="title" translatable="yes">Import document</property>
   <property name="type">GTK_WINDOW_TOPLEVEL</property>
   <property name="window_position">GTK_WIN_POS_NONE</property>
@@ -3312,6 +3310,7 @@
   <property name="gravity">GDK_GRAVITY_NORTH_WEST</property>
   <property name="focus_on_map">True</property>
   <property name="has_separator">True</property>
+  <signal name="response" handler="on_importDialog_response" last_modification_time="Tue, 10 Jan 2006 05:41:42 GMT"/>
 
   <child internal-child="vbox">
     <widget class="GtkVBox" id="dialog-vbox7">
@@ -3325,21 +3324,6 @@
 	  <property name="layout_style">GTK_BUTTONBOX_END</property>
 
 	  <child>
-	    <widget class="GtkButton" id="importButton">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="can_default">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="label" translatable="yes">Import</property>
-	      <property name="use_underline">True</property>
-	      <property name="relief">GTK_RELIEF_NORMAL</property>
-	      <property name="focus_on_click">True</property>
-	      <property name="response_id">0</property>
-	      <signal name="clicked" handler="on_importButton_clicked" last_modification_time="Mon, 02 Jan 2006 02:49:48 GMT"/>
-	    </widget>
-	  </child>
-
-	  <child>
 	    <widget class="GtkButton" id="closeButton">
 	      <property name="visible">True</property>
 	      <property name="can_default">True</property>
@@ -3348,7 +3332,7 @@
 	      <property name="use_stock">True</property>
 	      <property name="relief">GTK_RELIEF_NORMAL</property>
 	      <property name="focus_on_click">True</property>
-	      <property name="response_id">-7</property>
+	      <property name="response_id">-5</property>
 	    </widget>
 	  </child>
 	</widget>
@@ -3361,33 +3345,333 @@
       </child>
 
       <child>
-	<widget class="GtkTable" id="docTable">
-	  <property agent="glademm" name="cxx_visibility">protected</property>
+	<widget class="GtkVBox" id="importVbox">
 	  <property name="visible">True</property>
-	  <property name="n_rows">4</property>
-	  <property name="n_columns">3</property>
 	  <property name="homogeneous">False</property>
-	  <property name="row_spacing">0</property>
-	  <property name="column_spacing">0</property>
+	  <property name="spacing">0</property>
 
 	  <child>
-	    <widget class="GtkHButtonBox" id="hbuttonbox4">
+	    <widget class="GtkTable" id="docTable">
+	      <property agent="glademm" name="cxx_visibility">protected</property>
 	      <property name="visible">True</property>
-	      <property name="layout_style">GTK_BUTTONBOX_DEFAULT_STYLE</property>
-	      <property name="spacing">0</property>
+	      <property name="n_rows">4</property>
+	      <property name="n_columns">2</property>
+	      <property name="homogeneous">False</property>
+	      <property name="row_spacing">0</property>
+	      <property name="column_spacing">0</property>
 
 	      <child>
-		<widget class="GtkButton" id="selectButton">
+		<widget class="GtkEntry" id="titleEntry">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="editable">True</property>
+		  <property name="visibility">True</property>
+		  <property name="max_length">0</property>
+		  <property name="text" translatable="yes"></property>
+		  <property name="has_frame">True</property>
+		  <property name="invisible_char">*</property>
+		  <property name="activates_default">False</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="locationLabel">
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Location:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">2</property>
+		  <property name="bottom_attach">3</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="titleLabel">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Title:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkComboBox" id="typeCombobox">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="items" translatable="yes"></property>
+		  <property name="add_tearoffs">False</property>
+		  <property name="focus_on_click">True</property>
+		  <signal name="changed" handler="on_typeCombobox_changed" last_modification_time="Sun, 18 Sep 2005 04:09:29 GMT"/>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">0</property>
+		  <property name="bottom_attach">1</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="typeLabel">
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Type:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">0</property>
+		  <property name="bottom_attach">1</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkHBox" id="locationHbox">
+		  <property name="visible">True</property>
+		  <property name="homogeneous">False</property>
+		  <property name="spacing">4</property>
+
+		  <child>
+		    <widget class="GtkEntry" id="locationEntry">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="can_focus">True</property>
+		      <property name="editable">True</property>
+		      <property name="visibility">True</property>
+		      <property name="max_length">0</property>
+		      <property name="text" translatable="yes"></property>
+		      <property name="has_frame">True</property>
+		      <property name="invisible_char">*</property>
+		      <property name="activates_default">False</property>
+		      <signal name="changed" handler="on_locationEntry_changed" last_modification_time="Sun, 18 Sep 2005 03:55:37 GMT"/>
+		    </widget>
+		    <packing>
+		      <property name="padding">0</property>
+		      <property name="expand">True</property>
+		      <property name="fill">True</property>
+		    </packing>
+		  </child>
+
+		  <child>
+		    <widget class="GtkButton" id="locationButton">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="can_default">True</property>
+		      <property name="can_focus">True</property>
+		      <property name="label" translatable="yes">...</property>
+		      <property name="use_underline">True</property>
+		      <property name="relief">GTK_RELIEF_NORMAL</property>
+		      <property name="focus_on_click">True</property>
+		      <signal name="clicked" handler="on_locationButton_clicked" last_modification_time="Wed, 04 Jan 2006 20:22:51 GMT"/>
+		    </widget>
+		    <packing>
+		      <property name="padding">0</property>
+		      <property name="expand">False</property>
+		      <property name="fill">False</property>
+		    </packing>
+		  </child>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">2</property>
+		  <property name="bottom_attach">3</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="depthLabel">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Depth:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">3</property>
+		  <property name="bottom_attach">4</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options"></property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkSpinButton" id="depthSpinbutton">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="climb_rate">1</property>
+		  <property name="digits">0</property>
+		  <property name="numeric">False</property>
+		  <property name="update_policy">GTK_UPDATE_ALWAYS</property>
+		  <property name="snap_to_ticks">False</property>
+		  <property name="wrap">False</property>
+		  <property name="adjustment">0 0 100 1 5 5</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">3</property>
+		  <property name="bottom_attach">4</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+	    </widget>
+	    <packing>
+	      <property name="padding">0</property>
+	      <property name="expand">False</property>
+	      <property name="fill">True</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkScrolledWindow" id="mimeScrolledwindow">
+	      <property name="visible">True</property>
+	      <property name="can_focus">True</property>
+	      <property name="hscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+	      <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+	      <property name="shadow_type">GTK_SHADOW_IN</property>
+	      <property name="window_placement">GTK_CORNER_TOP_LEFT</property>
+
+	      <child>
+		<widget class="GtkTreeView" id="mimeTreeview">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="headers_visible">True</property>
+		  <property name="rules_hint">False</property>
+		  <property name="reorderable">False</property>
+		  <property name="enable_search">True</property>
+		  <property name="fixed_height_mode">False</property>
+		  <property name="hover_selection">False</property>
+		  <property name="hover_expand">False</property>
+		</widget>
+	      </child>
+	    </widget>
+	    <packing>
+	      <property name="padding">4</property>
+	      <property name="expand">True</property>
+	      <property name="fill">True</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkHBox" id="importHbox">
+	      <property name="visible">True</property>
+	      <property name="homogeneous">False</property>
+	      <property name="spacing">4</property>
+
+	      <child>
+		<widget class="GtkProgressBar" id="importProgressbar">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="orientation">GTK_PROGRESS_LEFT_TO_RIGHT</property>
+		  <property name="fraction">0</property>
+		  <property name="pulse_step">0.10000000149</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+		</widget>
+		<packing>
+		  <property name="padding">0</property>
+		  <property name="expand">True</property>
+		  <property name="fill">True</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkButton" id="importButton">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
 		  <property name="can_default">True</property>
 		  <property name="can_focus">True</property>
 		  <property name="relief">GTK_RELIEF_NORMAL</property>
 		  <property name="focus_on_click">True</property>
-		  <signal name="clicked" handler="on_selectButton_clicked" last_modification_time="Tue, 09 Mar 2004 19:27:45 GMT"/>
+		  <signal name="clicked" handler="on_importButton_clicked" last_modification_time="Wed, 04 Jan 2006 23:11:30 GMT"/>
 
 		  <child>
-		    <widget class="GtkAlignment" id="alignment29">
+		    <widget class="GtkAlignment" id="alignment34">
 		      <property name="visible">True</property>
 		      <property name="xalign">0.5</property>
 		      <property name="yalign">0.5</property>
@@ -3399,13 +3683,13 @@
 		      <property name="right_padding">0</property>
 
 		      <child>
-			<widget class="GtkHBox" id="hbox43">
+			<widget class="GtkHBox" id="hbox52">
 			  <property name="visible">True</property>
 			  <property name="homogeneous">False</property>
 			  <property name="spacing">2</property>
 
 			  <child>
-			    <widget class="GtkImage" id="image551">
+			    <widget class="GtkImage" id="image575">
 			      <property name="visible">True</property>
 			      <property name="stock">gtk-open</property>
 			      <property name="icon_size">4</property>
@@ -3422,9 +3706,9 @@
 			  </child>
 
 			  <child>
-			    <widget class="GtkLabel" id="label50">
+			    <widget class="GtkLabel" id="label55">
 			      <property name="visible">True</property>
-			      <property name="label" translatable="yes">Select</property>
+			      <property name="label">Import</property>
 			      <property name="use_underline">True</property>
 			      <property name="use_markup">False</property>
 			      <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -3450,225 +3734,19 @@
 		    </widget>
 		  </child>
 		</widget>
+		<packing>
+		  <property name="padding">0</property>
+		  <property name="expand">False</property>
+		  <property name="fill">True</property>
+		</packing>
 	      </child>
 	    </widget>
 	    <packing>
-	      <property name="left_attach">2</property>
-	      <property name="right_attach">3</property>
-	      <property name="top_attach">3</property>
-	      <property name="bottom_attach">4</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
+	      <property name="padding">0</property>
+	      <property name="expand">False</property>
+	      <property name="fill">True</property>
 	    </packing>
 	  </child>
-
-	  <child>
-	    <widget class="GtkEntry" id="locationEntry">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="editable">True</property>
-	      <property name="visibility">True</property>
-	      <property name="max_length">0</property>
-	      <property name="text" translatable="yes"></property>
-	      <property name="has_frame">True</property>
-	      <property name="invisible_char">*</property>
-	      <property name="activates_default">False</property>
-	      <signal name="changed" handler="on_locationEntry_changed" last_modification_time="Sun, 18 Sep 2005 03:55:37 GMT"/>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">1</property>
-	      <property name="right_attach">2</property>
-	      <property name="top_attach">3</property>
-	      <property name="bottom_attach">4</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkEntry" id="titleEntry">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="editable">True</property>
-	      <property name="visibility">True</property>
-	      <property name="max_length">0</property>
-	      <property name="text" translatable="yes"></property>
-	      <property name="has_frame">True</property>
-	      <property name="invisible_char">*</property>
-	      <property name="activates_default">False</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">1</property>
-	      <property name="right_attach">2</property>
-	      <property name="top_attach">1</property>
-	      <property name="bottom_attach">2</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="locationLabel">
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Location:</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">0</property>
-	      <property name="right_attach">1</property>
-	      <property name="top_attach">3</property>
-	      <property name="bottom_attach">4</property>
-	      <property name="x_options">fill</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="titleLabel">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Title:</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">0</property>
-	      <property name="right_attach">1</property>
-	      <property name="top_attach">1</property>
-	      <property name="bottom_attach">2</property>
-	      <property name="x_options">fill</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="depthLabel">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Maximum depth:</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">0</property>
-	      <property name="right_attach">1</property>
-	      <property name="top_attach">2</property>
-	      <property name="bottom_attach">3</property>
-	      <property name="x_options">fill</property>
-	      <property name="y_options"></property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkSpinButton" id="depthSpinbutton">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="climb_rate">1</property>
-	      <property name="digits">0</property>
-	      <property name="numeric">False</property>
-	      <property name="update_policy">GTK_UPDATE_ALWAYS</property>
-	      <property name="snap_to_ticks">False</property>
-	      <property name="wrap">False</property>
-	      <property name="adjustment">0 0 100 1 5 5</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">1</property>
-	      <property name="right_attach">2</property>
-	      <property name="top_attach">2</property>
-	      <property name="bottom_attach">3</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkComboBox" id="typeCombobox">
-	      <property agent="glademm" name="cxx_visibility">protected</property>
-	      <property name="visible">True</property>
-	      <property name="items" translatable="yes"></property>
-	      <property name="add_tearoffs">False</property>
-	      <property name="focus_on_click">True</property>
-	      <signal name="changed" handler="on_typeCombobox_changed" last_modification_time="Sun, 18 Sep 2005 04:09:29 GMT"/>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">1</property>
-	      <property name="right_attach">2</property>
-	      <property name="top_attach">0</property>
-	      <property name="bottom_attach">1</property>
-	      <property name="x_padding">4</property>
-	      <property name="y_padding">4</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
-
-	  <child>
-	    <widget class="GtkLabel" id="typeLabel">
-	      <property name="visible">True</property>
-	      <property name="label" translatable="yes">Type:</property>
-	      <property name="use_underline">False</property>
-	      <property name="use_markup">False</property>
-	      <property name="justify">GTK_JUSTIFY_LEFT</property>
-	      <property name="wrap">False</property>
-	      <property name="selectable">False</property>
-	      <property name="xalign">0</property>
-	      <property name="yalign">0.5</property>
-	      <property name="xpad">4</property>
-	      <property name="ypad">4</property>
-	      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-	      <property name="width_chars">-1</property>
-	      <property name="single_line_mode">False</property>
-	      <property name="angle">0</property>
-	    </widget>
-	    <packing>
-	      <property name="left_attach">0</property>
-	      <property name="right_attach">1</property>
-	      <property name="top_attach">0</property>
-	      <property name="bottom_attach">1</property>
-	      <property name="x_options">fill</property>
-	      <property name="y_options">fill</property>
-	    </packing>
-	  </child>
 	</widget>
 	<packing>
 	  <property name="padding">0</property>

Modified: trunk/UI/GTK2/src/ModelColumns.cpp
===================================================================
--- trunk/UI/GTK2/src/ModelColumns.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/ModelColumns.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -119,3 +119,13 @@
 MailAccountModelColumns::~MailAccountModelColumns()
 {
 }
+
+TypeModelColumns::TypeModelColumns()
+{
+	add(m_enabled);
+	add(m_type);
+}
+
+TypeModelColumns::~TypeModelColumns()
+{
+}

Modified: trunk/UI/GTK2/src/ModelColumns.h
===================================================================
--- trunk/UI/GTK2/src/ModelColumns.h	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/ModelColumns.h	2006-01-10 09:46:28 UTC (rev 53)
@@ -150,4 +150,16 @@
 
 };
 
+/// Import window, model column for the types tree.
+class TypeModelColumns : public Gtk::TreeModel::ColumnRecord
+{
+public:
+	TypeModelColumns();
+	virtual ~TypeModelColumns();
+
+	Gtk::TreeModelColumn<bool> m_enabled;
+	Gtk::TreeModelColumn<Glib::ustring> m_type;
+
+};
+
 #endif // _MODELCOLUMNS_HH

Modified: trunk/UI/GTK2/src/PinotUtils.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotUtils.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/PinotUtils.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -15,6 +15,8 @@
  */
 
 #include <iostream>
+#include <pangomm/font.h>
+#include <gtkmm/rc.h>
 #include <gtkmm/stock.h>
 #include <gtkmm/filechooserdialog.h>
 
@@ -27,6 +29,7 @@
 using namespace Glib;
 using namespace Gtk;
 
+/// Open a FileChooserDialog.
 bool select_file_name(Window &parentWindow, const ustring &title,
 	ustring &location, bool openOrCreate, bool directoriesOnly)
 {
@@ -69,6 +72,7 @@
 	return false;
 }
 
+/// Prepare a FileChooser.
 bool prepare_chooser(FileChooser *pChooser, ustring &location,
 	bool openOrCreate, bool directoriesOnly)
 {
@@ -118,6 +122,40 @@
 	return false;
 }
 
+/// Get a column height.
+int get_column_height(TreeView *pTree)
+{
+	if (pTree == NULL)
+	{
+		return 0;
+	}
+
+	RefPtr<Style> refRCStyle = RC::get_style(*pTree);
+	int fontSize = refRCStyle->get_font().get_size();
+	int height = fontSize / Pango::SCALE;
+#ifdef DEBUG
+	cout << "get_column_height: font " << height << ", " << fontSize << endl;
+#endif
+
+	TreeViewColumn *pColumn = pTree->get_column(1);
+	if (pColumn != NULL)
+	{
+		Gdk::Rectangle cellArea;
+		int xOffset, yOffset, cellWidth, cellHeight;
+
+		pColumn->cell_get_size(cellArea, xOffset, yOffset, cellWidth, cellHeight);
+		height += cellHeight;
+#ifdef DEBUG
+		cout << "get_column_height: cell " << cellHeight << " " << yOffset << endl;
+#endif
+	}
+#ifdef DEBUG
+	cout << "get_column_height: " << height << endl;
+#endif
+
+	return height;
+}
+
 /// Create a resizable text column.
 TreeViewColumn *create_resizable_column(const ustring &title, const TreeModelColumnBase& modelColumn)
 {

Modified: trunk/UI/GTK2/src/PinotUtils.h
===================================================================
--- trunk/UI/GTK2/src/PinotUtils.h	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/PinotUtils.h	2006-01-10 09:46:28 UTC (rev 53)
@@ -18,7 +18,6 @@
 #define _PINOTUTILS_HH
 
 #include <string>
-#include <vector>
 #if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
 #include <sigc++/compatibility.h>
 #endif
@@ -36,6 +35,9 @@
 bool prepare_chooser(Gtk::FileChooser *pChooser, Glib::ustring &location,
 	bool openOrCreate = true, bool directoriesOnly = false);
 
+/// Get a column height.
+int get_column_height(Gtk::TreeView *pTree);
+
 /// Create a resizable text column.
 Gtk::TreeViewColumn *create_resizable_column(const Glib::ustring &title,
 	const Gtk::TreeModelColumnBase& modelColumn);

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -15,6 +15,7 @@
  */
 
 #include <sys/types.h>
+#include <dirent.h>
 #include <sys/stat.h>
 #include <unistd.h>
 #include <stdlib.h>
@@ -51,16 +52,30 @@
 using namespace Glib;
 using namespace std;
 
-// The Dispatcher object used to signal the UI thread
-Dispatcher WorkerThread::m_signalFinished;
+// A function object to delete pointers from a set with for_each()
+struct DeleteSetPointer
+{
+	template<typename T>
+	void operator()(const T *ptr) const
+	{
+		delete ptr;
+	}
+};
 
-WorkerThread::WorkerThread()
+Dispatcher WorkerThread::m_dispatcher;
+
+Dispatcher &WorkerThread::getDispatcher(void)
 {
-	m_id = 0;
-	m_background = m_done = false;
-	m_status = "";
+	return m_dispatcher;
 }
 
+WorkerThread::WorkerThread() :
+	m_id(0),
+	m_background(false),
+	m_done(false)
+{
+}
+
 WorkerThread::~WorkerThread()
 {
 }
@@ -90,11 +105,6 @@
 	return m_id < other.m_id;
 }
 
-Dispatcher& WorkerThread::getFinishedSignal()
-{
-	return m_signalFinished;
-}
-
 bool WorkerThread::isDone(void) const
 {
 	return m_done;
@@ -116,9 +126,195 @@
 	cout << "WorkerThread::emitSignal: end of thread " << m_id << endl;
 #endif
 	m_done = true;
-	m_signalFinished.emit();
+	m_dispatcher.emit();
 }
 
+ThreadsManager::ThreadsManager() :
+	m_nextId(1),
+	m_backgroundThreadsCount(0)
+{
+	pthread_rwlock_init(&m_rwLock, NULL);
+}
+
+ThreadsManager::~ThreadsManager()
+{
+	if (m_threads.empty() == false)
+	{
+		for_each(m_threads.begin(), m_threads.end(), DeleteSetPointer());
+	}
+	// Destroy the read/write lock
+	pthread_rwlock_destroy(&m_rwLock);
+}
+
+bool ThreadsManager::read_lock(unsigned int where)
+{
+	if (pthread_rwlock_rdlock(&m_rwLock) == 0)
+	{
+#ifdef DEBUG
+		cout << "ThreadsManager::read_lock " << where << endl;
+#endif
+		return true;
+	}
+
+	return false;
+}
+
+bool ThreadsManager::write_lock(unsigned int where)
+{
+	if (pthread_rwlock_wrlock(&m_rwLock) == 0)
+	{
+#ifdef DEBUG
+		cout << "ThreadsManager::write_lock " << where << endl;
+#endif
+		return true;
+	}
+
+	return false;
+}
+
+void ThreadsManager::unlock(void)
+{
+#ifdef DEBUG
+	cout << "ThreadsManager::unlock" << endl;
+#endif
+	pthread_rwlock_unlock(&m_rwLock);
+}
+
+WorkerThread *ThreadsManager::on_thread_end(void)
+{
+	WorkerThread *pThread = NULL;
+
+	// Get the first thread that's finished
+	if (read_lock(1) == true)
+	{
+		for (set<WorkerThread *>::iterator threadIter = m_threads.begin();
+			threadIter != m_threads.end(); ++threadIter)
+		{
+			if ((*threadIter)->isDone() == true)
+			{
+				// This one will do...
+				pThread = (*threadIter);
+				// Remove it
+				m_threads.erase(threadIter);
+				break;
+			}
+#ifdef DEBUG
+			cout << "ThreadsManager::on_thread_end: thread "
+				<< (*threadIter)->getId() << " is not done" << endl;
+#endif
+		}
+
+		unlock();
+	}
+
+	if (pThread == NULL)
+	{
+		return NULL;
+	}
+
+	if (pThread->isBackground() == true)
+	{
+		--m_backgroundThreadsCount;
+	}
+
+	return pThread;
+}
+
+bool ThreadsManager::start_thread(WorkerThread *pNewThread, bool inBackground)
+{
+	bool insertedThread = false;
+
+	if (pNewThread == NULL)
+	{
+		return false;
+	}
+
+	pNewThread->setId(m_nextId);
+	if (write_lock(2) == true)
+	{
+		pair<set<WorkerThread *>::iterator, bool> insertPair = m_threads.insert(pNewThread);
+		insertedThread = insertPair.second;
+
+		unlock();
+	}
+
+	// Was it inserted ?
+	if (insertedThread == false)
+	{
+		// No, it wasn't
+#ifdef DEBUG
+		cout << "ThreadsManager::start_thread: couldn't start "
+			<< pNewThread->getType() << endl;
+#endif
+		return false;
+	}
+
+	// Start the thread
+	if (inBackground == true)
+	{
+		pNewThread->inBackground();
+		++m_backgroundThreadsCount;
+	}
+	pNewThread->start();
+	++m_nextId;
+
+	return true;
+}
+
+unsigned int ThreadsManager::get_threads_count(void)
+{
+	int count = 0;
+
+	if (read_lock(3) == true)
+	{
+		count = m_threads.size() - m_backgroundThreadsCount;
+
+		unlock();
+	}
+#ifdef DEBUG
+	cout << "ThreadsManager::get_threads_count: " << count << " threads left" << endl;
+#endif
+
+	// A negative count would mean that a background thread
+	// exited without signaling
+	return (unsigned int)max(count , 0);
+}
+
+bool ThreadsManager::has_threads(void)
+{
+	if (m_threads.empty() == true)
+	{
+		return false;
+	}
+
+	return true;
+}
+
+void ThreadsManager::stop_threads(void)
+{
+	if (read_lock(4) == true)
+	{
+		for (set<WorkerThread *>::iterator threadIter = m_threads.begin();
+			threadIter != m_threads.end(); ++threadIter)
+		{
+			// Stop all threads
+			// FIXME: what if one thread doesn't stop ?
+			(*threadIter)->stop();
+		}
+
+		unlock();
+	}
+}
+
+void ThreadsManager::disconnect(void)
+{
+	m_threadsEndConnection.block();
+	m_threadsEndConnection.disconnect();
+#ifdef DEBUG
+	cout << "ThreadsManager::disconnect: disconnected" << endl;
+#endif
+}
+
 IndexBrowserThread::IndexBrowserThread(const string &indexName,
 	unsigned int maxDocsCount, unsigned int startDoc) :
 	WorkerThread()
@@ -240,9 +436,7 @@
 			IndexedDocument indexedDoc(docInfo.getTitle(), url, docInfo.getLocation(),
 				type, docInfo.getLanguage());
 			indexedDoc.setTimestamp(date);
-#ifdef DEBUG
-			cout << "IndexBrowserThread::do_browsing: timestamp for " << docId << " is " << date << endl;
-#endif
+
 			// Signal
 			m_signalUpdate(indexedDoc, docId, m_indexName);
 			++numDocs;
@@ -1157,10 +1351,11 @@
 		while (m_done == false)
 		{
 			int fdCount = select(fd + 1, &listenSet, NULL, NULL, NULL);
-			if (fdCount < 0)
+			if ((fdCount < 0) &&
+				(errno != EINTR))
 			{
 #ifdef DEBUG
-				perror("ListenerThread::do_listening: select() failed");
+				cout << "ListenerThread::do_listening: select() failed" << endl;
 #endif
 				break;
 			}
@@ -1338,24 +1533,22 @@
 		selectTimeout.tv_usec = 0;
 
 		int fdCount = select(fd + 1, &listenSet, NULL, NULL, &selectTimeout);
-		if (fdCount < 0)
+		if ((fdCount < 0) &&
+			(errno != EINTR))
 		{
 #ifdef DEBUG
-			perror("MonitorThread::do_monitoring: select() failed");
+			cout << "MonitorThread::do_monitoring: select() failed" << endl;
 #endif
 			break;
 		}
 		else if (FD_ISSET(fd, &listenSet))
 		{
-#ifdef DEBUG
-			cout << "MonitorThread::do_monitoring: select() returned" << endl;
-#endif
 			// There might be more than one event waiting...
 			int pendingEvents = FAMPending(&famConn);
 			if (pendingEvents < 0)
 			{
 #ifdef DEBUG
-				perror("MonitorThread::do_monitoring: FAMPending() failed");
+				cout << "MonitorThread::do_monitoring: FAMPending() failed" << endl;
 #endif
 				break;
 			}
@@ -1462,9 +1655,6 @@
 			setLocationsToMonitor = true;
 		}
 	}
-#ifdef DEBUG
-	cout << "MonitorThread::do_monitoring: quitting..." << endl;
-#endif
 
 	// Stop monitoring and close the connection
 	FAMCancelMonitor(&famConn, &famReq);
@@ -1472,3 +1662,173 @@
 
 	emitSignal();
 }
+
+DirectoryScannerThread::DirectoryScannerThread(const std::string &dirName,
+			unsigned int maxLevel, pthread_mutex_t *pMutex,
+			pthread_cond_t *pCondVar) :
+	WorkerThread(),
+	m_dirName(dirName),
+	m_maxLevel(maxLevel),
+	m_pMutex(pMutex),
+	m_pCondVar(pCondVar)
+{
+}
+
+DirectoryScannerThread::~DirectoryScannerThread()
+{
+}
+
+bool DirectoryScannerThread::start(void)
+{
+	// Create a non-joinable thread
+	Thread::create(slot_class(*this, &DirectoryScannerThread::do_scanning), false);
+
+	return true;
+}
+
+string DirectoryScannerThread::getType(void) const
+{
+	return "DirectoryScannerThread";
+}
+
+bool DirectoryScannerThread::stop(void)
+{
+	m_done = true;
+	m_status = _("Stopped scanning ");
+	m_status += " ";
+	m_status += m_dirName;
+
+	return true;
+}
+
+Signal1<bool, const string&>& DirectoryScannerThread::getFileFoundSignal(void)
+{
+	return m_signalFileFound;
+}
+
+void DirectoryScannerThread::found_file(const string &fileName)
+{
+	if (fileName.empty() == true)
+	{
+		return;
+	}
+
+	if ((m_pMutex != NULL) &&
+		(m_pCondVar != NULL) &&
+		(pthread_mutex_lock(m_pMutex) == 0))
+	{
+		if (m_signalFileFound(fileName) == true)
+		{
+			// Another file is needed right now
+			pthread_mutex_unlock(m_pMutex);
+		}
+		else
+		{
+#ifdef DEBUG
+			cout << "DirectoryScannerThread::found_file: waiting" << endl;
+#endif
+			// Don't resume until signaled
+			pthread_cond_wait(m_pCondVar, m_pMutex);
+			pthread_mutex_unlock(m_pMutex);
+#ifdef DEBUG
+			cout << "DirectoryScannerThread::found_file: signaled" << endl;
+#endif
+		}
+	}
+}
+
+void DirectoryScannerThread::do_scanning()
+{
+	struct stat fileStat;
+
+	if ((m_dirName.empty() == true) ||
+		(lstat(m_dirName.c_str(), &fileStat) == -1))
+	{
+#ifdef DEBUG
+		cout << "DirectoryScannerThread::do_scanning: stat failed" << endl;
+#endif
+		return;
+	}
+
+	// Is it a file or a directory ?
+	if (S_ISLNK(fileStat.st_mode))
+	{
+		// Don't follow
+#ifdef DEBUG
+		cout << "DirectoryScannerThread::do_scanning: skipping symlink" << endl;
+#endif
+		return;
+	}
+	else if (S_ISREG(fileStat.st_mode))
+	{
+		// It's actually a file
+		found_file(m_dirName);
+	}
+	else if (S_ISDIR(fileStat.st_mode))
+	{
+		// A directory : scan it
+		DIR *pDir = opendir(m_dirName.c_str());
+		if (pDir == NULL)
+		{
+			return;
+		}
+#ifdef DEBUG
+		cout << "DirectoryScannerThread::do_scanning: entering " << m_dirName << endl;
+#endif
+
+		// Iterate through this directory's entries
+		struct dirent *pDirEntry = readdir(pDir);
+		while ((m_done == false) &&
+			(pDirEntry != NULL))
+		{
+			char *pEntryName = pDirEntry->d_name;
+			if (pEntryName != NULL)
+			{
+				string entryName = m_dirName;
+				if (m_dirName[m_dirName.length() - 1] != '/')
+				{
+					entryName += "/";
+				}
+				entryName += pEntryName;
+
+				// Skip . .. and dotfiles
+				Url urlObj("file://" + entryName);
+				if ((urlObj.getFile() == ".") ||
+					(urlObj.getFile() == "..") ||
+					(urlObj.getFile()[0] == '.') ||
+					(lstat(entryName.c_str(), &fileStat) == -1))
+				{
+					// Next entry
+					pDirEntry = readdir(pDir);
+					continue;
+				}
+
+#ifdef DEBUG
+				cout << "DirectoryScannerThread::do_scanning: stat'ing " << entryName << endl;
+#endif
+				// File or directory
+				if (S_ISREG(fileStat.st_mode))
+				{
+					found_file(entryName);
+				}
+				else if (S_ISDIR(fileStat.st_mode))
+				{
+					// Can we scan this directory ?
+					if (m_currentLevel + 1 < m_maxLevel)
+					{
+						++m_currentLevel;
+						m_dirName = entryName;
+						do_scanning();
+						--m_currentLevel;
+					}
+				}
+			}
+
+			// Next entry
+			pDirEntry = readdir(pDir);
+		}
+		closedir(pDir);
+	}
+
+	emitSignal();
+}

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-01-10 09:46:28 UTC (rev 53)
@@ -22,7 +22,9 @@
 #include <vector>
 #include <set>
 #include <map>
+#include <pthread.h>
 #include <sigc++/slot.h>
+#include <sigc++/connection.h>
 #include <glibmm/dispatcher.h>
 #include <glibmm/ustring.h>
 
@@ -39,6 +41,8 @@
 		WorkerThread();
 		virtual ~WorkerThread();
 
+		static Glib::Dispatcher &getDispatcher(void);
+
 		void setId(unsigned int id);
 
 		unsigned int getId(void);
@@ -55,9 +59,6 @@
 
 		virtual bool stop(void) = 0;
 
-		/// Only one thread (the GUI thread) should connect to this, before calling start().
-		static Glib::Dispatcher& getFinishedSignal();
-
 		bool isDone(void) const;
 
 		void reset(void);
@@ -65,8 +66,8 @@
 		std::string getStatus(void) const;
 
 	protected:
-		/// Use a Dispatcher, not a Signal, for thread safety
-		static Glib::Dispatcher m_signalFinished;
+		/// Use a Dispatcher for thread safety
+		static Glib::Dispatcher m_dispatcher;
 		unsigned int m_id;
 		bool m_background;
 		bool m_done;
@@ -80,6 +81,42 @@
 
 };
 
+class ThreadsManager
+{
+	public:
+		ThreadsManager();
+		virtual ~ThreadsManager();
+
+		bool read_lock(unsigned int where);
+		bool write_lock(unsigned int where);
+		void unlock(void);
+
+		bool start_thread(WorkerThread *pNewThread, bool inBackground);
+
+		WorkerThread *on_thread_end(void);
+
+		unsigned int get_threads_count(void);
+
+		bool has_threads(void);
+
+		void stop_threads(void);
+
+		virtual void disconnect(void);
+
+	protected:
+		SigC::Connection m_threadsEndConnection;
+		// Read/write lock
+		pthread_rwlock_t m_rwLock;
+		std::set<WorkerThread *> m_threads;
+		unsigned int m_nextId;
+		unsigned int m_backgroundThreadsCount;
+
+	private:
+		ThreadsManager(const ThreadsManager &other);
+		ThreadsManager &operator=(const ThreadsManager &other);
+
+};
+
 class IndexBrowserThread : public WorkerThread
 {
 	public:
@@ -387,4 +424,37 @@
 
 };
 
+class DirectoryScannerThread : public WorkerThread
+{
+	public:
+		DirectoryScannerThread(const std::string &dirName,
+			unsigned int maxLevel, pthread_mutex_t *pMutex,
+			pthread_cond_t *pCondVar);
+		virtual ~DirectoryScannerThread();
+
+		virtual bool start(void);
+
+		virtual std::string getType(void) const;
+
+		virtual bool stop(void);
+
+		SigC::Signal1<bool, const std::string&>& getFileFoundSignal(void);
+
+	protected:
+		std::string m_dirName;
+		unsigned int m_maxLevel;
+		pthread_mutex_t *m_pMutex;
+		pthread_cond_t *m_pCondVar;
+		unsigned int m_currentLevel;
+		SigC::Signal1<bool, const std::string&> m_signalFileFound;
+
+		void found_file(const std::string &fileName);
+		void do_scanning();
+
+	private:
+		DirectoryScannerThread(const DirectoryScannerThread &other);
+		DirectoryScannerThread &operator=(const DirectoryScannerThread &other);
+
+};
+
 #endif // _WORKERTHREADS_HH

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,22 +1,34 @@
-// generated 2004/3/6 14:15:21 GMT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to importDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include <stdlib.h>
-#include <sys/types.h>
-#include <dirent.h>
-#include <sys/stat.h>
-#include <unistd.h>
+#include <strings.h>
 #include <iostream>
+#include <algorithm>
+#include <utility>
+#include <sigc++/class_slot.h>
 #include <glibmm/convert.h>
+#include <gtkmm/stock.h>
+#include <gtkmm/main.h>
 
 #include "config.h"
 #include "MIMEScanner.h"
 #include "NLS.h"
 #include "Url.h"
+#include "XapianIndex.h"
 #include "PinotSettings.h"
 #include "PinotUtils.h"
 #include "importDialog.hh"
@@ -26,63 +38,96 @@
 using namespace Glib;
 using namespace Gtk;
 
-string importDialog::m_directory = "";
+string importDialog::InternalState::m_defaultDirectory = "";
 
+importDialog::InternalState::InternalState(importDialog *pWindow) :
+	ThreadsManager(),
+	m_importing(false),
+	m_pImportWindow(pWindow)
+{
+	pthread_mutex_init(&m_scanMutex, NULL);
+	pthread_cond_init(&m_scanCondVar, NULL);
+}
+
+importDialog::InternalState::~InternalState()
+{
+	pthread_cond_destroy(&m_scanCondVar);
+	pthread_mutex_destroy(&m_scanMutex);
+}
+
+void importDialog::InternalState::connect(void)
+{
+	if (m_pImportWindow != NULL)
+	{
+		// Connect the dispatcher
+		m_threadsEndConnection = WorkerThread::getDispatcher().connect(
+			SigC::slot(*m_pImportWindow, &importDialog::on_thread_end));
+#ifdef DEBUG
+		cout << "importDialog::InternalState::connect: connected" << endl;
+#endif
+	}
+}
+
 importDialog::importDialog(const Glib::ustring &title,
-	bool selectTitle, bool selectDepth, bool allowLocalOnly) :
+	const set<string> &mimeTypes) :
 	importDialog_glade(),
 	m_docsCount(0),
 	m_importDirectory(false),
-	m_maxDirLevel(1)
+	m_state(this)
 {
-	// Associate the columns model to the type combo
-	m_refTypeList = ListStore::create(m_typeColumns);
-	typeCombobox->set_model(m_refTypeList);
-	typeCombobox->pack_start(m_typeColumns.m_name);
-	// Populate
-	populate_combobox(allowLocalOnly);
+	set_title(title);
 
+	// Copy the list of authorized MIME types
+	copy(mimeTypes.begin(), mimeTypes.end(), inserter(m_mimeTypes, m_mimeTypes.begin()));
+	// FIXME: populate the list
+
 	// Initialize the default directory
-	if (m_directory.empty() == true)
+	if (m_state.m_defaultDirectory.empty() == true)
 	{
 		char *homeDir = getenv("HOME");
 		if (homeDir != NULL)
 		{
-			m_directory = homeDir + string("/");
+			m_state.m_defaultDirectory = homeDir + string("/");
 		}
 	}
 
-	set_title(title);
+	// Associate the columns model to the type combo
+	m_refTypeList = ListStore::create(m_typeColumns);
+	typeCombobox->set_model(m_refTypeList);
+	typeCombobox->pack_start(m_typeColumns.m_name);
+	// Populate
+	populate_typeCombobox(false);
 
-	if (selectTitle == false)
-	{
-		titleLabel->hide();
-		titleEntry->hide();
-	}
+	// The default type is not directory
+	// FIXME: this could also apply to URLs !
+	depthSpinbutton->set_sensitive(false);
+	depthSpinbutton->set_value(1);
 
-	if (selectDepth == false)
-	{
-		depthLabel->hide();
-		depthSpinbutton->hide();
-	}
-	else
-	{
-		// The default type is not directory
-		// FIXME: this could also apply to URLs !
-		depthSpinbutton->set_sensitive(false);
-		depthSpinbutton->set_value(m_maxDirLevel);
-	}
+	// Associate the columns model to the MIME types tree
+	m_refMimeTypeList = ListStore::create(m_mimeTypeColumns);
+	mimeTreeview->set_model(m_refMimeTypeList);
+	mimeTreeview->append_column_editable(_("Enabled"), m_mimeTypeColumns.m_enabled);
+	mimeTreeview->append_column(_("MIME Type"), m_mimeTypeColumns.m_type);
+	// Allow only single selection
+	mimeTreeview->get_selection()->set_mode(SELECTION_SINGLE);
+	// Populate
+	populate_mimeTreeview();
 
+	// Connect to threads' finished signal
+	m_state.connect();
+
 	// Disable this button as long the location entry field is empty
 	// The title field may remain empty
 	importButton->set_sensitive(false);
+	importProgressbar->set_pulse_step(0.10);
+	importProgressbar->set_text(_("Waiting..."));
 }
 
 importDialog::~importDialog()
 {
 }
 
-void importDialog::populate_combobox(bool allowLocalOnly)
+void importDialog::populate_typeCombobox(bool localOnly)
 {
 	bool foundLanguage = false;
 
@@ -92,7 +137,7 @@
 	iter = m_refTypeList->append();
 	row = *iter;
 	row[m_typeColumns.m_name] = _("Whole directory");
-	if (allowLocalOnly == false)
+	if (localOnly == false)
 	{
 		iter = m_refTypeList->append();
 		row = *iter;
@@ -102,113 +147,179 @@
 	typeCombobox->set_active(0);
 }
 
-void importDialog::scan_file(const string &fileName, unsigned int &level)
+void importDialog::populate_mimeTreeview(void)
 {
-	struct stat fileStat;
-	Url urlObj("file://" + fileName);
+	// Add all MIME types
+	for (set<string>::const_iterator typeIter = m_mimeTypes.begin();
+		typeIter != m_mimeTypes.end(); ++typeIter)
+	{
+		TreeModel::iterator iter = m_refMimeTypeList->append();
+		TreeModel::Row row = *iter;
 
-	if ((fileName.empty() == true) ||
-		(urlObj.getFile() == ".") ||
-		(urlObj.getFile() == ".."))
-	{
-		return;
+		row[m_mimeTypeColumns.m_enabled] = true;
+		row[m_mimeTypeColumns.m_type] = to_utf8(*typeIter);
 	}
+}
 
-	// Skip dotfiles
-	if (urlObj.getFile()[0] == '.')
+bool importDialog::start_thread(WorkerThread *pNewThread)
+{
+	if (m_state.start_thread(pNewThread, false) == false)
 	{
-		return;
+		// Delete the object
+		delete pNewThread;
+		return false;
 	}
-
 #ifdef DEBUG
-	cout << "importDialog::scan_file: " << fileName << endl;
+	cout << "importDialog::start_thread: started thread " << pNewThread->getId() << endl;
 #endif
-	if (lstat(fileName.c_str(), &fileStat) == -1)
+
+	return true;
+}
+
+bool importDialog::on_import_file(const string &fileName)
+{
+	string mimeType = MIMEScanner::scanFile(fileName);
+	bool askForAnotherFile = false;
+
+	// Check the MIME type
+	if ((m_mimeTypesBlackList.find(mimeType) != m_mimeTypesBlackList.end()) ||
+		((m_mimeTypes.find(mimeType) == m_mimeTypes.end()) &&
+		(strncasecmp(mimeType.c_str(), "text", 4) != 0)))
 	{
 #ifdef DEBUG
-		cout << "importDialog::scan_file: stat failed" << endl;
+		cout << "importDialog::on_import_file: filtering out type " << mimeType << endl;
 #endif
-		return;
+		// It's black-listed, or not authorized and not text
+		askForAnotherFile = true;
 	}
+	else
+	{
+		XapianIndex index(PinotSettings::getInstance().m_indexLocation);
+		IndexingThread *pThread = NULL;
+		string url("file://" + fileName);
+		string title = locale_from_utf8(m_title);
+		unsigned int docId = 0;
 
-	// Is it a file or a directory ?
-	if (S_ISLNK(fileStat.st_mode))
-	{
-		cout << "importDialog::scan_file: skipping symlink" << endl;
-		return;
-	}
-	else if (S_ISDIR(fileStat.st_mode))
-	{
-		// A directory : scan it
-		DIR *pDir = opendir(fileName.c_str());
-		if (pDir == NULL)
+		importProgressbar->pulse();
+		importProgressbar->set_text(to_utf8(fileName));
+
+		if (index.isGood() == true)
 		{
-			return;
+			docId = index.hasDocument(url);
 		}
 
-		// Iterate through this directory's entries
-		struct dirent *pDirEntry = readdir(pDir);
-		while (pDirEntry != NULL)
+		if (m_importDirectory == true)
 		{
-			char *pEntryName = pDirEntry->d_name;
-			if (pEntryName != NULL)
+			Url urlObj(url);
+
+			if (title.empty() == false)
 			{
-				string location = fileName;
-				if (fileName[fileName.length() - 1] != '/')
-				{
-					location += "/";
-				}
-				location += pEntryName;
+				title += " ";
+			}
+			title += urlObj.getFile();
+		}
+		DocumentInfo docInfo(title, url, mimeType, "");
 
-				// Scan this entry
-				if ((m_maxDirLevel == 0) ||
-					(level < m_maxDirLevel))
-				{
-					++level;
-					scan_file(location, level);
-					--level;
-				}
+		if (docId > 0)
+		{
+			// This document needs updating
+			index.getDocumentInfo(docId, docInfo);
+			pThread = new IndexingThread(docInfo, docId);
+		}
+		else
+		{
+			pThread = new IndexingThread(docInfo, "");
+		}
+
+		// Launch the new thread
+		start_thread(pThread);
+	}
+
+	return askForAnotherFile;
+}
+
+void importDialog::on_thread_end()
+{
+	ustring status;
+
+	WorkerThread *pThread = m_state.on_thread_end();
+	if (pThread == NULL)
+	{
+		// It's likely to be a thread that was started by the main window
 #ifdef DEBUG
-				else cout << "importDialog::scan_file: not going deeper than level " << level << endl;
+		cout << "importDialog::on_thread_end: foreign thread" << endl;
 #endif
-			}
+		return;
+	}
 
-			// Next entry
-			pDirEntry = readdir(pDir);
-		}
-		closedir(pDir);
+	// Any thread still running ?
+	if (m_state.has_threads() == false)
+	{
+#ifdef DEBUG
+		cout << "importDialog::on_thread_end: imported all" << endl;
+#endif
+		m_state.m_importing = false;
 	}
-	else if (S_ISREG(fileStat.st_mode))
+
+	// What type of thread was it ?
+	string type = pThread->getType();
+	if (type == "IndexingThread")
 	{
-		// Build a valid URL
-		string location = "file://";
-		location += fileName;
-		string title = locale_from_utf8(m_title);
+		// Did it succeed ?
+		if (pThread->getStatus().empty() == true)
+		{
+			// Yes, it did
+			++m_docsCount;
+		}
 
-		if (m_importDirectory == true)
+		if (m_state.m_importing == true)
 		{
-			title += " ";
-			title += urlObj.getFile();
+			// Ask the scanner for another file
+			pthread_mutex_lock(&m_state.m_scanMutex);
+			pthread_cond_signal(&m_state.m_scanCondVar);
+			pthread_mutex_unlock(&m_state.m_scanMutex);
+#ifdef DEBUG
+			cout << "importDialog::on_thread_end: signaled DirectoryScannerThread" << endl;
+#endif
 		}
+	}
 
-		DocumentInfo docInfo(title, location,
-			MIMEScanner::scanFile(fileName), "");
+	// Delete the thread
+	delete pThread;
 
-		import_file(urlObj.getFile(), docInfo);
+	do
+	{
+#ifdef DEBUG
+		cout << "importDialog::on_thread_end: UI event" << endl;
+#endif
+		Main::iteration(false);
+	} while(Main::events_pending() == true);
+
+	if (m_state.m_importing == false)
+	{
+		importProgressbar->set_text(_("Done"));
+		importProgressbar->set_fraction(1.0);
+		importButton->set_sensitive(true);
 	}
 }
 
-void importDialog::import_file(const string &fileName,
-	const DocumentInfo &docInfo)
+void importDialog::setHeight(int maxHeight)
 {
-	// Fire up the signal
-	m_signalImportFile(docInfo);
-	++m_docsCount;
-}
+	// FIXME: there must be a better way to determine how high the tree should be
+	// for all rows to be visible !
+	int rowsCount = m_refTypeList->children().size();
+	// By default, the tree is high enough for one row
+	if (rowsCount > 1)
+	{
+		int width, height;
 
-ustring importDialog::getDocumentTitle(void)
-{
-	return m_title;
+		// What's the current size ?
+		get_size(width, height);
+		// Add enough room for the rows we need to show
+		height += get_column_height(mimeTreeview) * (rowsCount - 1);
+		// Resize
+		resize(width, min(maxHeight, height));
+	}
 }
 
 unsigned int importDialog::getDocumentsCount(void)
@@ -216,125 +327,166 @@
 	return m_docsCount;
 }
 
-Signal1<void, DocumentInfo> &importDialog::getImportFileSignal(void)
+void importDialog::on_typeCombobox_changed()
 {
-	return m_signalImportFile;
+	unsigned int type = typeCombobox->get_active_row_number();
+	bool selectLocation = true;
+
+	m_importDirectory = false;
+	if (type == 1)
+	{
+		m_importDirectory = true;
+	}
+	else if (type > 1)
+	{
+		// Disable the select button only if type is URL
+		selectLocation = false;
+	}
+
+	// See whether import should be enabled
+	on_locationEntry_changed();
+
+	// FIXME: this could also apply to URLs !
+	depthSpinbutton->set_sensitive(m_importDirectory);
+	locationButton->set_sensitive(selectLocation);
 }
 
-void importDialog::on_importButton_clicked()
+void importDialog::on_locationEntry_changed()
 {
-	string location = locale_from_utf8(locationEntry->get_text());
-	unsigned int level = 0;
+	ustring fileName = locationEntry->get_text();
+	bool enableImport = true;
 
-	importButton->set_sensitive(false);
+	if (fileName.empty() == false)
+	{
+		unsigned int type = typeCombobox->get_active_row_number();
 
-	// Title
-	m_title = titleEntry->get_text();
-	// Type
-	if (typeCombobox->get_active_row_number() <= 1)
-	{
-		string::size_type pos = location.find_last_of("/");
-		if (pos != string::npos)
+		// Check the entry makes sense
+		if (type <= 1)
 		{
-			// Update m_directory
-			m_directory = location.substr(0, pos + 1);
-#ifdef DEBUG
-			cout << "importDialog::on_importButton_clicked: directory now " << m_directory << endl;
-#endif
+			if (fileName[0] != '/')
+			{
+				enableImport = false;
+			}
 		}
+		else
+		{
+			Url urlObj(locale_from_utf8(fileName));
 
-		// Maximum depth
-		m_maxDirLevel = (unsigned int)depthSpinbutton->get_value();
-
-		scan_file(location, level);
+			// Check the URL is valid
+			if (urlObj.getProtocol().empty() == true)
+			{
+				enableImport = false;
+			}
+			// FIXME: be more thorough
+		}
 	}
 	else
 	{
-		Url urlObj(location);
-		DocumentInfo docInfo(locale_from_utf8(m_title), location,
-			MIMEScanner::scanUrl(urlObj), "");
+		enableImport = false;
+	}
 
-		import_file(urlObj.getFile(), docInfo);
+	// Keep the button disabled as lon as we are importing
+	if (m_state.m_importing == true)
+	{
+		enableImport = false;
 	}
+	importButton->set_sensitive(enableImport);
 }
 
-void importDialog::on_selectButton_clicked()
+void importDialog::on_locationButton_clicked()
 {
-	ustring fileName = to_utf8(m_directory);
+	ustring fileName = to_utf8(m_state.m_defaultDirectory);
 
 	if (select_file_name(*this, _("Document To Import"), fileName, true, m_importDirectory) == true)
 	{
 		// Update the location
 #ifdef DEBUG
-		cout << "importDialog::on_selectButton_clicked: location is " << fileName << endl;
+		cout << "importDialog::on_locationButton_clicked: location is " << fileName << endl;
 #endif
 		locationEntry->set_text(fileName);
 		ustring::size_type pos = fileName.find_last_of("/");
 		if (pos != string::npos)
 		{
-			// Update m_directory
-			m_directory = locale_from_utf8(fileName.substr(0, pos + 1));
+			// Update the default directory
+			m_state.m_defaultDirectory = locale_from_utf8(fileName.substr(0, pos + 1));
 #ifdef DEBUG
-			cout << "importDialog::on_selectButton_clicked: directory now " << m_directory << endl;
+			cout << "importDialog::on_locationButton_clicked: directory now "
+				<< m_state.m_defaultDirectory << endl;
 #endif
 		}
 	}
 }
 
-void importDialog::on_locationEntry_changed()
+void importDialog::on_importButton_clicked()
 {
-	ustring fileName = locationEntry->get_text();
-	bool enableOk = true;
+	string location = locale_from_utf8(locationEntry->get_text());
+	unsigned int level = 0;
 
-	if (fileName.empty() == false)
+	// Rudimentary lock
+	if (m_state.m_importing == true)
 	{
-		unsigned int type = typeCombobox->get_active_row_number();
+		return;
+	}
+	m_state.m_importing = true;
 
-		// Check the entry makes sense
-		if (type <= 1)
+	importProgressbar->set_fraction(0.0);
+	// Disable the import button
+	importButton->set_sensitive(false);
+
+	// Update the list of MIME types, based on list selection
+	m_mimeTypes.clear();
+	m_mimeTypesBlackList.clear();
+	TreeModel::Children children = m_refMimeTypeList->children();
+	if (children.empty() == false)
+	{
+		for (TreeModel::Children::iterator iter = children.begin();
+			iter != children.end(); ++iter)
 		{
-			if (fileName[0] != '/')
+			TreeModel::Row row = *iter;
+			string mimeType(locale_from_utf8(row[m_mimeTypeColumns.m_type]));
+			bool enabled = row[m_mimeTypeColumns.m_enabled];
+
+			if (enabled == true)
 			{
-				enableOk = false;
+				m_mimeTypes.insert(mimeType);
 			}
-		}
-		else
-		{
-			Url urlObj(locale_from_utf8(fileName));
-
-			// Check the URL is valid
-			if (urlObj.getProtocol().empty() == true)
+			else
 			{
-				enableOk = false;
+				m_mimeTypesBlackList.insert(mimeType);
 			}
-			// FIXME: be more thorough
 		}
 	}
+#ifdef DEBUG
+	cout << "importDialog::on_importButton_clicked: " << m_mimeTypes.size()
+		<< " types, " << m_mimeTypesBlackList.size() << " in blacklist" << endl;
+#endif
+
+	// Title
+	m_title = titleEntry->get_text();
+	// Type
+	if (typeCombobox->get_active_row_number() <= 1)
+	{
+		// Maximum depth
+		unsigned int maxDirLevel = (unsigned int)depthSpinbutton->get_value();
+
+		// Scan the directory and import all its files
+		DirectoryScannerThread *pThread = new DirectoryScannerThread(location,
+			maxDirLevel, &m_state.m_scanMutex, &m_state.m_scanCondVar);
+		pThread->getFileFoundSignal().connect(SigC::slot(*this, &importDialog::on_import_file));
+		start_thread(pThread);
+	}
 	else
 	{
-		enableOk = false;
+		on_import_file(location);
 	}
-
-	importButton->set_sensitive(enableOk);
+#ifdef DEBUG
+	cout << "importDialog::on_importButton_clicked: done" << endl;
+#endif
 }
 
-void importDialog::on_typeCombobox_changed()
+void importDialog::on_importDialog_response(int response_id)
 {
-	unsigned int type = typeCombobox->get_active_row_number();
-	bool selectLocation = true;
-
-	m_importDirectory = false;
-	if (type == 1)
-	{
-		m_importDirectory = true;
-	}
-	else if (type > 1)
-	{
-		// Disable the select button only if type is URL
-		selectLocation = false;
-	}
-
-	// FIXME: this could also apply to URLs !
-	depthSpinbutton->set_sensitive(m_importDirectory);
-	selectButton->set_sensitive(selectLocation);
+	// Closing the window should stop everything
+	m_state.stop_threads();
+	m_state.disconnect();
 }

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/importDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,19 +1,25 @@
-// generated 2004/3/6 14:15:21 GMT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to importDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _IMPORTDIALOG_HH
 #define _IMPORTDIALOG_HH
 
 #include <string>
-#include <vector>
+#include <set>
+#include <pthread.h>
 #include <sigc++/slot.h>
 #include <glibmm/refptr.h>
 #include <glibmm/ustring.h>
@@ -22,6 +28,7 @@
 
 #include "DocumentInfo.h"
 #include "ModelColumns.h"
+#include "WorkerThreads.h"
 #include "importDialog_glade.hh"
 
 class importDialog : public importDialog_glade
@@ -29,37 +36,57 @@
 public:
 	/// Open the dialog box in import mode.
 	importDialog(const Glib::ustring &title,
-		bool selectTitle = true, bool selectDepth = true,
-		bool allowLocalOnly = false);
+		const std::set<std::string> &mimeTypes);
 	virtual ~importDialog();
 
-	Glib::ustring getDocumentTitle(void);
+	void setHeight(int maxHeight);
 
 	unsigned int getDocumentsCount(void);
 
-	/// Returns the import file signal.
-	SigC::Signal1<void, DocumentInfo>& getImportFileSignal(void);
-
 protected:
-	void populate_combobox(bool allowLocalOnly);
-	void scan_file(const std::string &fileName, unsigned int &level);
-	void import_file(const std::string &fileName,
-		const DocumentInfo &docInfo);
+	void populate_typeCombobox(bool localOnly);
+	void populate_mimeTreeview(void);
+	bool start_thread(WorkerThread *pNewThread);
 
+	bool on_import_file(const std::string &fileName);
+	void on_thread_end(void);
+
 private:
+	std::set<std::string> m_mimeTypes;
+	std::set<std::string> m_mimeTypesBlackList;
 	ComboModelColumns m_typeColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refTypeList;
 	Glib::ustring m_title;
 	unsigned int m_docsCount;
 	bool m_importDirectory;
-	unsigned int m_maxDirLevel;
-	SigC::Signal1<void, DocumentInfo> m_signalImportFile;
-	static std::string m_directory;
+	TypeModelColumns m_mimeTypeColumns;
+	Glib::RefPtr<Gtk::ListStore> m_refMimeTypeList;
+	// Internal state
+	class InternalState : public ThreadsManager
+	{
+		public:
+			InternalState(importDialog *pWindow);
+			~InternalState();
 
+			void connect(void);
+
+			// Directory scanning
+			bool m_importing;
+			pthread_mutex_t m_scanMutex;
+			pthread_cond_t m_scanCondVar;
+			// The default directory
+			static std::string m_defaultDirectory;
+
+		protected:
+			importDialog *m_pImportWindow;
+
+	} m_state;
+
+	virtual void on_typeCombobox_changed();
+	virtual void on_locationEntry_changed();
+	virtual void on_locationButton_clicked();
 	virtual void on_importButton_clicked();
-	virtual void on_selectButton_clicked();
-	virtual void on_locationEntry_changed();
-	virtual void on_typeCombobox_changed();
+	virtual void on_importDialog_response(int response_id);
 
 };
 

Modified: trunk/UI/GTK2/src/importDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2006/1/2 11:20:27 SGT by fabrice at thorgrim.dyndns.org.(none)
+// generated 2006/1/10 13:41:10 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -46,11 +46,12 @@
 #include <gtkmm/accelgroup.h>
 #include <gtkmm/button.h>
 #include <gtkmm/buttonbox.h>
-#include <gtkmm/image.h>
 #include <gtkmm/label.h>
 #include <gtkmm/box.h>
+#include <gtkmm/adjustment.h>
+#include <gtkmm/scrolledwindow.h>
+#include <gtkmm/image.h>
 #include <gtkmm/alignment.h>
-#include <gtkmm/adjustment.h>
 
 importDialog_glade::importDialog_glade(
 )
@@ -58,62 +59,46 @@
    
    Gtk::Dialog *importDialog = this;
    gmm_data = new GlademmData(get_accel_group());
-   importButton = Gtk::manage(new class Gtk::Button(_("Import")));
    
    Gtk::Button *closeButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-close")));
-   Gtk::Image *image551 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(4)));
-   Gtk::Label *label50 = Gtk::manage(new class Gtk::Label(_("Select")));
-   Gtk::HBox *hbox43 = Gtk::manage(new class Gtk::HBox(false, 2));
-   Gtk::Alignment *alignment29 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
-   selectButton = Gtk::manage(new class Gtk::Button());
-   
-   Gtk::HButtonBox *hbuttonbox4 = Gtk::manage(new class Gtk::HButtonBox(Gtk::BUTTONBOX_DEFAULT_STYLE, 0));
-   locationEntry = Gtk::manage(new class Gtk::Entry());
    titleEntry = Gtk::manage(new class Gtk::Entry());
    
    Gtk::Label *locationLabel = Gtk::manage(new class Gtk::Label(_("Location:")));
    titleLabel = Gtk::manage(new class Gtk::Label(_("Title:")));
-   depthLabel = Gtk::manage(new class Gtk::Label(_("Maximum depth:")));
+   typeCombobox = Gtk::manage(new class Gtk::ComboBox());
    
+   Gtk::Label *typeLabel = Gtk::manage(new class Gtk::Label(_("Type:")));
+   locationEntry = Gtk::manage(new class Gtk::Entry());
+   locationButton = Gtk::manage(new class Gtk::Button(_("...")));
+   
+   Gtk::HBox *locationHbox = Gtk::manage(new class Gtk::HBox(false, 4));
+   depthLabel = Gtk::manage(new class Gtk::Label(_("Depth:")));
+   
    Gtk::Adjustment *depthSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(0, 0, 100, 1, 5, 5));
    depthSpinbutton = Gtk::manage(new class Gtk::SpinButton(*depthSpinbutton_adj, 1, 0));
-   typeCombobox = Gtk::manage(new class Gtk::ComboBox());
+   docTable = Gtk::manage(new class Gtk::Table(2, 2, false));
+   mimeTreeview = Gtk::manage(new class Gtk::TreeView());
    
-   Gtk::Label *typeLabel = Gtk::manage(new class Gtk::Label(_("Type:")));
-   docTable = Gtk::manage(new class Gtk::Table(2, 2, false));
-   importButton->set_flags(Gtk::CAN_FOCUS);
-   importButton->set_flags(Gtk::CAN_DEFAULT);
-   importButton->set_relief(Gtk::RELIEF_NORMAL);
+   Gtk::ScrolledWindow *mimeScrolledwindow = Gtk::manage(new class Gtk::ScrolledWindow());
+   importProgressbar = Gtk::manage(new class Gtk::ProgressBar());
+   
+   Gtk::Image *image575 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(4)));
+   Gtk::Label *label55 = Gtk::manage(new class Gtk::Label(_("Import")));
+   Gtk::HBox *hbox52 = Gtk::manage(new class Gtk::HBox(false, 2));
+   Gtk::Alignment *alignment34 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
+   importButton = Gtk::manage(new class Gtk::Button());
+   
+   Gtk::HBox *importHbox = Gtk::manage(new class Gtk::HBox(false, 4));
+   Gtk::VBox *importVbox = Gtk::manage(new class Gtk::VBox(false, 0));
    closeButton->set_flags(Gtk::CAN_FOCUS);
    closeButton->set_flags(Gtk::CAN_DEFAULT);
    closeButton->set_relief(Gtk::RELIEF_NORMAL);
    importDialog->get_action_area()->property_layout_style().set_value(Gtk::BUTTONBOX_END);
-   image551->set_alignment(0.5,0.5);
-   image551->set_padding(0,0);
-   label50->set_alignment(0.5,0.5);
-   label50->set_padding(0,0);
-   label50->set_justify(Gtk::JUSTIFY_LEFT);
-   label50->set_line_wrap(false);
-   label50->set_use_markup(false);
-   label50->set_selectable(false);
-   hbox43->pack_start(*image551, Gtk::PACK_SHRINK, 0);
-   hbox43->pack_start(*label50, Gtk::PACK_SHRINK, 0);
-   alignment29->add(*hbox43);
-   selectButton->set_flags(Gtk::CAN_FOCUS);
-   selectButton->set_flags(Gtk::CAN_DEFAULT);
-   selectButton->set_relief(Gtk::RELIEF_NORMAL);
-   selectButton->add(*alignment29);
-   hbuttonbox4->pack_start(*selectButton);
-   locationEntry->set_flags(Gtk::CAN_FOCUS);
-   locationEntry->set_visibility(true);
-   locationEntry->set_editable(true);
-   locationEntry->set_max_length(0);
-   locationEntry->set_has_frame(true);
-   locationEntry->set_activates_default(false);
    titleEntry->set_flags(Gtk::CAN_FOCUS);
    titleEntry->set_visibility(true);
    titleEntry->set_editable(true);
    titleEntry->set_max_length(0);
+   titleEntry->set_text(_(""));
    titleEntry->set_has_frame(true);
    titleEntry->set_activates_default(false);
    locationLabel->set_alignment(0,0.5);
@@ -128,6 +113,24 @@
    titleLabel->set_line_wrap(false);
    titleLabel->set_use_markup(false);
    titleLabel->set_selectable(false);
+   typeLabel->set_alignment(0,0.5);
+   typeLabel->set_padding(4,4);
+   typeLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   typeLabel->set_line_wrap(false);
+   typeLabel->set_use_markup(false);
+   typeLabel->set_selectable(false);
+   locationEntry->set_flags(Gtk::CAN_FOCUS);
+   locationEntry->set_visibility(true);
+   locationEntry->set_editable(true);
+   locationEntry->set_max_length(0);
+   locationEntry->set_text(_(""));
+   locationEntry->set_has_frame(true);
+   locationEntry->set_activates_default(false);
+   locationButton->set_flags(Gtk::CAN_FOCUS);
+   locationButton->set_flags(Gtk::CAN_DEFAULT);
+   locationButton->set_relief(Gtk::RELIEF_NORMAL);
+   locationHbox->pack_start(*locationEntry);
+   locationHbox->pack_start(*locationButton, Gtk::PACK_SHRINK, 0);
    depthLabel->set_alignment(0,0.5);
    depthLabel->set_padding(4,4);
    depthLabel->set_justify(Gtk::JUSTIFY_LEFT);
@@ -139,56 +142,83 @@
    depthSpinbutton->set_numeric(false);
    depthSpinbutton->set_digits(0);
    depthSpinbutton->set_wrap(false);
-   typeLabel->set_alignment(0,0.5);
-   typeLabel->set_padding(4,4);
-   typeLabel->set_justify(Gtk::JUSTIFY_LEFT);
-   typeLabel->set_line_wrap(false);
-   typeLabel->set_use_markup(false);
-   typeLabel->set_selectable(false);
    docTable->set_row_spacings(0);
    docTable->set_col_spacings(0);
-   docTable->attach(*hbuttonbox4, 2, 3, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   docTable->attach(*locationEntry, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable->attach(*titleEntry, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   docTable->attach(*locationLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 0, 0);
+   docTable->attach(*locationLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 0, 0);
    docTable->attach(*titleLabel, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 0, 0);
-   docTable->attach(*depthLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::AttachOptions(), 0, 0);
-   docTable->attach(*depthSpinbutton, 1, 2, 2, 3, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable->attach(*typeCombobox, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable->attach(*typeLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 0, 0);
+   docTable->attach(*locationHbox, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL, 4, 4);
+   docTable->attach(*depthLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::AttachOptions(), 0, 0);
+   docTable->attach(*depthSpinbutton, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   mimeTreeview->set_flags(Gtk::CAN_FOCUS);
+   mimeTreeview->set_headers_visible(true);
+   mimeTreeview->set_rules_hint(false);
+   mimeTreeview->set_reorderable(false);
+   mimeTreeview->set_enable_search(true);
+   mimeScrolledwindow->set_flags(Gtk::CAN_FOCUS);
+   mimeScrolledwindow->set_shadow_type(Gtk::SHADOW_IN);
+   mimeScrolledwindow->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
+   mimeScrolledwindow->property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
+   mimeScrolledwindow->add(*mimeTreeview);
+   image575->set_alignment(0.5,0.5);
+   image575->set_padding(0,0);
+   label55->set_alignment(0.5,0.5);
+   label55->set_padding(0,0);
+   label55->set_justify(Gtk::JUSTIFY_LEFT);
+   label55->set_line_wrap(false);
+   label55->set_use_markup(false);
+   label55->set_selectable(false);
+   hbox52->pack_start(*image575, Gtk::PACK_SHRINK, 0);
+   hbox52->pack_start(*label55, Gtk::PACK_SHRINK, 0);
+   alignment34->add(*hbox52);
+   importButton->set_flags(Gtk::CAN_FOCUS);
+   importButton->set_flags(Gtk::CAN_DEFAULT);
+   importButton->set_relief(Gtk::RELIEF_NORMAL);
+   importButton->add(*alignment34);
+   importHbox->pack_start(*importProgressbar);
+   importHbox->pack_start(*importButton, Gtk::PACK_SHRINK, 0);
+   importVbox->pack_start(*docTable, Gtk::PACK_SHRINK, 0);
+   importVbox->pack_start(*mimeScrolledwindow, Gtk::PACK_EXPAND_WIDGET, 4);
+   importVbox->pack_start(*importHbox, Gtk::PACK_SHRINK, 0);
    importDialog->get_vbox()->set_homogeneous(false);
    importDialog->get_vbox()->set_spacing(0);
-   importDialog->get_vbox()->pack_start(*docTable);
+   importDialog->get_vbox()->pack_start(*importVbox);
    importDialog->set_title(_("Import document"));
    importDialog->set_modal(false);
    importDialog->property_window_position().set_value(Gtk::WIN_POS_NONE);
    importDialog->set_resizable(true);
    importDialog->property_destroy_with_parent().set_value(false);
    importDialog->set_has_separator(true);
-   importDialog->add_action_widget(*importButton, 0);
-   importDialog->add_action_widget(*closeButton, -7);
-   importButton->show();
+   importDialog->add_action_widget(*closeButton, -5);
    closeButton->show();
-   image551->show();
-   label50->show();
-   hbox43->show();
-   alignment29->show();
-   selectButton->show();
-   hbuttonbox4->show();
-   locationEntry->show();
    titleEntry->show();
    locationLabel->show();
    titleLabel->show();
+   typeCombobox->show();
+   typeLabel->show();
+   locationEntry->show();
+   locationButton->show();
+   locationHbox->show();
    depthLabel->show();
    depthSpinbutton->show();
-   typeCombobox->show();
-   typeLabel->show();
    docTable->show();
-   importDialog->show();
+   mimeTreeview->show();
+   mimeScrolledwindow->show();
+   importProgressbar->show();
+   image575->show();
+   label55->show();
+   hbox52->show();
+   alignment34->show();
+   importButton->show();
+   importHbox->show();
+   importVbox->show();
+   typeCombobox->signal_changed().connect(SigC::slot(*this, &importDialog_glade::on_typeCombobox_changed), false);
+   locationEntry->signal_changed().connect(SigC::slot(*this, &importDialog_glade::on_locationEntry_changed), false);
+   locationButton->signal_clicked().connect(SigC::slot(*this, &importDialog_glade::on_locationButton_clicked), false);
    importButton->signal_clicked().connect(SigC::slot(*this, &importDialog_glade::on_importButton_clicked), false);
-   selectButton->signal_clicked().connect(SigC::slot(*this, &importDialog_glade::on_selectButton_clicked), false);
-   locationEntry->signal_changed().connect(SigC::slot(*this, &importDialog_glade::on_locationEntry_changed), false);
-   typeCombobox->signal_changed().connect(SigC::slot(*this, &importDialog_glade::on_typeCombobox_changed), false);
+   importDialog->signal_response().connect(SigC::slot(*this, &importDialog_glade::on_importDialog_response), false);
 }
 
 importDialog_glade::~importDialog_glade()

Modified: trunk/UI/GTK2/src/importDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2006/1/2 11:20:27 SGT by fabrice at thorgrim.dyndns.org.(none)
+// generated 2006/1/10 13:34:08 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -32,35 +32,40 @@
 #endif //GLADEMM_DATA
 
 #include <gtkmm/dialog.h>
-#include <gtkmm/button.h>
 #include <gtkmm/entry.h>
 #include <gtkmm/label.h>
+#include <gtkmm/combobox.h>
+#include <gtkmm/button.h>
 #include <gtkmm/spinbutton.h>
-#include <gtkmm/combobox.h>
 #include <gtkmm/table.h>
+#include <gtkmm/treeview.h>
+#include <gtkmm/progressbar.h>
 
 class importDialog_glade : public Gtk::Dialog
 {  
         
         GlademmData *gmm_data;
 protected:
-        class Gtk::Button * importButton;
-        class Gtk::Button * selectButton;
-        class Gtk::Entry * locationEntry;
         class Gtk::Entry * titleEntry;
         class Gtk::Label * titleLabel;
+        class Gtk::ComboBox * typeCombobox;
+        class Gtk::Entry * locationEntry;
+        class Gtk::Button * locationButton;
         class Gtk::Label * depthLabel;
         class Gtk::SpinButton * depthSpinbutton;
-        class Gtk::ComboBox * typeCombobox;
         class Gtk::Table * docTable;
+        class Gtk::TreeView * mimeTreeview;
+        class Gtk::ProgressBar * importProgressbar;
+        class Gtk::Button * importButton;
         
         importDialog_glade();
         
         ~importDialog_glade();
 private:
+        virtual void on_typeCombobox_changed() = 0;
+        virtual void on_locationEntry_changed() = 0;
+        virtual void on_locationButton_clicked() = 0;
         virtual void on_importButton_clicked() = 0;
-        virtual void on_selectButton_clicked() = 0;
-        virtual void on_locationEntry_changed() = 0;
-        virtual void on_typeCombobox_changed() = 0;
+        virtual void on_importDialog_response(int response_id) = 0;
 };
 #endif

Modified: trunk/UI/GTK2/src/indexDialog.cc
===================================================================
--- trunk/UI/GTK2/src/indexDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/indexDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,10 +1,19 @@
-// generated 2005/2/14 18:45:02 GMT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0
-//
-// newer (non customized) versions of this file go to indexDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include <iostream>
 
 #include "config.h"

Modified: trunk/UI/GTK2/src/indexDialog.hh
===================================================================
--- trunk/UI/GTK2/src/indexDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/indexDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,19 @@
-// generated 2005/2/14 18:45:02 GMT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0
-//
-// newer (non customized) versions of this file go to indexDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _INDEXDIALOG_HH
 #define _INDEXDIALOG_HH
 

Modified: trunk/UI/GTK2/src/indexDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/indexDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/indexDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,9 +1,9 @@
-// generated 2005/4/17 5:19:13 BST by fabrice at thorgrim.dyndns.org.(none)
+// generated 2006/1/5 9:17:19 SGT by fabrice at thorgrim.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/metase/UI/GTK2/metase-gtk2.glade
-// for gtk 2.4.0 and gtkmm 2.4.8
+// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
+// for gtk 2.6.10 and gtkmm 2.6.2
 //
 // Please modify the corresponding derived classes in ./src/indexDialog.cc
 
@@ -63,7 +63,7 @@
    locationEntry = Gtk::manage(new class Gtk::Entry());
    locationButton = Gtk::manage(new class Gtk::Button(_("...")));
    
-   Gtk::HBox *locationHbox = Gtk::manage(new class Gtk::HBox(false, 0));
+   Gtk::HBox *locationHbox = Gtk::manage(new class Gtk::HBox(false, 4));
    Gtk::Label *typeLabel = Gtk::manage(new class Gtk::Label(_("Type:")));
    Gtk::Label *locationLabel = Gtk::manage(new class Gtk::Label(_("Location:")));
    Gtk::Label *portLabel = Gtk::manage(new class Gtk::Label(_("Port:")));
@@ -97,7 +97,7 @@
    locationButton->set_flags(Gtk::CAN_DEFAULT);
    locationButton->set_relief(Gtk::RELIEF_NORMAL);
    locationHbox->pack_start(*locationEntry);
-   locationHbox->pack_start(*locationButton, Gtk::PACK_SHRINK, 4);
+   locationHbox->pack_start(*locationButton, Gtk::PACK_SHRINK, 0);
    typeLabel->set_alignment(0,0.5);
    typeLabel->set_padding(4,4);
    typeLabel->set_justify(Gtk::JUSTIFY_LEFT);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -36,6 +36,7 @@
 #include "IndexedDocument.h"
 #include "TimeConverter.h"
 #include "Url.h"
+#include "TokenizerFactory.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
 #include "DownloaderFactory.h"
@@ -58,69 +59,36 @@
 using namespace Gdk;
 using namespace Gtk;
 
-// A function object to delete pointers from a set with for_each()
-struct DeleteSetPointer
-{
-	template<typename T>
-	void operator()(const T *ptr) const
-	{
-		delete ptr;
-	}
-};
-
 // FIXME: this ought to be configurable
 unsigned int mainWindow::m_maxDocsCount = 100;
 unsigned int mainWindow::m_maxThreads = 2;
 
-mainWindow::InternalState::InternalState() :
+mainWindow::InternalState::InternalState(mainWindow *pWindow) :
+	ThreadsManager(),
 	m_liveQueryLength(0),
 	m_currentPage(0),
-	m_backgroundThreads(0),
-	m_browsingIndex(false)
+	m_browsingIndex(false),
+	m_pMainWindow(pWindow)
 {
-	pthread_rwlock_init(&m_rwLock, NULL);
 }
 
 mainWindow::InternalState::~InternalState()
 {
-	// Destroy the read/write lock
-	pthread_rwlock_destroy(&m_rwLock);
 }
 
-bool mainWindow::InternalState::readLock(unsigned int where)
+void mainWindow::InternalState::connect(void)
 {
-	if (pthread_rwlock_rdlock(&m_rwLock) == 0)
+	if (m_pMainWindow != NULL)
 	{
+		// Connect the dispatcher
+		m_threadsEndConnection = WorkerThread::getDispatcher().connect(
+			SigC::slot(*m_pMainWindow, &mainWindow::on_thread_end));
 #ifdef DEBUG
-		cout << "mainWindow::InternalState::readLock " << where << endl;
+		cout << "mainWindow::InternalState::connect: connected" << endl;
 #endif
-		return true;
 	}
-
-	return false;
 }
 
-bool mainWindow::InternalState::writeLock(unsigned int where)
-{
-	if (pthread_rwlock_wrlock(&m_rwLock) == 0)
-	{
-#ifdef DEBUG
-		cout << "mainWindow::InternalState::writeLock " << where << endl;
-#endif
-		return true;
-	}
-
-	return false;
-}
-
-void mainWindow::InternalState::unlock(void)
-{
-#ifdef DEBUG
-	cout << "mainWindow::InternalState::unlock" << endl;
-#endif
-	pthread_rwlock_unlock(&m_rwLock);
-}
-
 //
 // Constructor
 //
@@ -130,7 +98,8 @@
 	m_pNotebook(NULL),
 	m_pIndexMenu(NULL),
 	m_pLabelsMenu(NULL),
-	m_pHtmlView(NULL)
+	m_pHtmlView(NULL),
+	m_state(this)
 {
 	// Reposition and resize the window
 	// Make sure the coordinates and sizes make sense
@@ -243,8 +212,7 @@
 	m_tooltips.set_tip(*removeIndexButton, _("Remove index"));
 
 	// Connect to threads' finished signal
-	m_threadsEndConnection = WorkerThread::getFinishedSignal().connect(
-		SigC::slot(*this, &mainWindow::on_thread_end));
+	m_state.connect();
 
 	// FIXME: delete all "ignored" threads when exiting !!!
 	// Fire up a listener thread
@@ -277,11 +245,6 @@
 	// Save queries
 	save_queryTreeview();
 
-	if (m_state.m_pThreads.empty() == false)
-	{
-		for_each(m_state.m_pThreads.begin(), m_state.m_pThreads.end(), DeleteSetPointer());
-	}
-
 	// Stop in case we were loading a page
 	NotebookPageBox *pNotebookPage = get_page(_("View"), NotebookPageBox::VIEW_PAGE);
 	if (pNotebookPage != NULL)
@@ -636,7 +599,7 @@
 			SigC::slot(*this, &mainWindow::on_indexForwardButton_clicked));
 
 		// Append the page
-		if (m_state.writeLock(1) == true)
+		if (m_state.write_lock(1) == true)
 		{
 			int pageNum = m_pNotebook->append_page(*pIndexPage, *pTab);
 			m_pNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
@@ -752,7 +715,7 @@
 				pPage->hide();
 			}
 		}
-		else if (m_state.writeLock(2) == true)
+		else if (m_state.write_lock(2) == true)
 		{
 			// Remove the page
 			m_pNotebook->remove_page(pageNum);
@@ -767,30 +730,9 @@
 //
 void mainWindow::on_thread_end()
 {
-	WorkerThread *pThread = NULL;
 	ustring status;
 
-	// Get the first thread that's finished
-	if (m_state.readLock(3) == true)
-	{
-		for (set<WorkerThread *>::iterator threadIter = m_state.m_pThreads.begin();
-			threadIter != m_state.m_pThreads.end(); ++threadIter)
-		{
-#ifdef DEBUG
-			cout << "mainWindow::on_thread_end: looking for thread" << endl;
-#endif
-			if ((*threadIter)->isDone() == true)
-			{
-				// This one will do...
-				pThread = (*threadIter);
-				// Remove it
-				m_state.m_pThreads.erase(threadIter);
-				break;
-			}
-		}
-
-		m_state.unlock();
-	}
+	WorkerThread *pThread = m_state.on_thread_end();
 	if (pThread == NULL)
 	{
 #ifdef DEBUG
@@ -801,14 +743,9 @@
 #ifdef DEBUG
 	cout << "mainWindow::on_thread_end: end of thread " << pThread->getId() << endl;
 #endif
-	update_threads_status();
 
 	// What type of thread was it ?
 	string type = pThread->getType();
-	if (pThread->isBackground() == true)
-	{
-		m_state.m_backgroundThreads--;
-	}
 	// Did the thread fail for some reason ?
 	string threadStatus = pThread->getStatus();
 	if (threadStatus.empty() == false)
@@ -936,7 +873,7 @@
 				SigC::slot(*this, &mainWindow::on_resultsTreeviewSelection_changed));
 
 			// Append the page
-			if (m_state.writeLock(1) == true)
+			if (m_state.write_lock(3) == true)
 			{
 				pageNum = m_pNotebook->append_page(*pResultsPage, *pTab);
 				m_pNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
@@ -1136,7 +1073,7 @@
 			status += to_utf8(url);
 
 			// Update the in-progress list
-			if (m_state.writeLock(4) == true)
+			if (m_state.write_lock(4) == true)
 			{
 				set<string>::iterator urlIter = m_state.m_beingIndexed.find(url);
 				if (urlIter != m_state.m_beingIndexed.end())
@@ -1236,7 +1173,7 @@
 	check_queue();
 
 	// Any threads left to return ?
-	if (get_threads_count() == 0)
+	if (m_state.get_threads_count() == 0)
 	{
 		if (m_timeoutConnection.connected() == true)
 		{
@@ -1370,20 +1307,6 @@
 }
 
 //
-// Message reception from importDialog
-//
-void mainWindow::on_message_import(DocumentInfo docInfo)
-{
-	string location = docInfo.getLocation();
-
-	if (location.empty() == false)
-	{
-		// Index the selected file
-		queue_index(docInfo, "");
-	}
-}
-
-//
 // Session > Configure menu selected
 //
 void mainWindow::on_configure_activate()
@@ -1403,7 +1326,7 @@
 	// FIXME: if mail accounts are configured, make sure the MonitorThread
 	// is running and knows about the new accounts
 
-	if (m_state.readLock(5) == true)
+	if (m_state.read_lock(2) == true)
 	{
 		for (int pageNum = 0; pageNum < m_pNotebook->get_n_pages(); ++pageNum)
 		{
@@ -1819,13 +1742,35 @@
 //
 void mainWindow::on_import_activate()
 {
-	importDialog importBox(_("Import Document(s)"));
+	set<string> mimeTypes;
+	int width, height;
 
-	importBox.getImportFileSignal().connect(SigC::slot(*this,
-		&mainWindow::on_message_import));
+	TokenizerFactory::getSupportedTypes(mimeTypes);
+	get_size(width, height);
+
+	m_state.disconnect();
+
+	importDialog importBox(_("Import Document(s)"), mimeTypes);
+	importBox.setHeight(height / 2);
 	importBox.show();
 	importBox.run();
-	// Let the signal handler deal with importing stuff
+
+	m_state.connect();
+
+	// Was anything imported ?
+	if (importBox.getDocumentsCount() > 0)
+	{
+		ustring indexName(_("My Documents"));
+
+		// Is the index still being shown ?
+		IndexTree *pIndexTree = NULL;
+		NotebookPageBox *pPage = get_page(indexName, NotebookPageBox::INDEX_PAGE);
+		if (pPage != NULL)
+		{
+			// Refresh
+			browse_index(indexName, 0);
+		}
+	}
 }
 
 //
@@ -2463,9 +2408,9 @@
 bool mainWindow::on_mainWindow_delete_event(GdkEventAny *ev)
 {
 	// Any thread still running ?
-	if (get_threads_count() > 0)
+	if (m_state.get_threads_count() > 0)
 	{
-		ustring boxTitle = _("At least one background task hasn't been completed yet. Quit now ?");
+		ustring boxTitle = _("At least one task hasn't completed yet. Quit now ?");
 		MessageDialog msgDialog(boxTitle, false, MESSAGE_QUESTION, BUTTONS_YES_NO);
 		msgDialog.set_transient_for(*this);
 		msgDialog.show();
@@ -2475,30 +2420,10 @@
 			return true;
 		}
 
-		if (m_state.readLock(6) == true)
-		{
-			for (set<WorkerThread *>::iterator threadIter = m_state.m_pThreads.begin();
-				threadIter != m_state.m_pThreads.end(); ++threadIter)
-			{
-#ifdef DEBUG
-				cout << "mainWindow::on_mainWindow_delete_event: stopping thread "
-					<< (*threadIter)->getId() << endl;
-#endif
-				// Stop all non-background threads
-				if ((*threadIter)->isBackground() == false)
-				{
-					// FIXME: what if one thread doesn't stop ? can it corrupt anything ?
-					(*threadIter)->stop();
-				}
-			}
-
-			m_state.unlock();
-		}
+		m_state.stop_threads();
 	}
-
 	// Disconnect the threads' finished signal
-	m_threadsEndConnection.block();
-	m_threadsEndConnection.disconnect();
+	m_state.disconnect();
 
 	// Save the window's position and dimensions now
 	// Don't worry about the gravity, it hasn't been changed
@@ -2520,7 +2445,7 @@
 {
 	NotebookPageBox *pNotebookPage = NULL;
 
-	if (m_state.readLock(7) == true)
+	if (m_state.read_lock(4) == true)
 	{
 		Widget *pPage = m_pNotebook->get_nth_page(m_pNotebook->get_current_page());
 		if (pPage != NULL)
@@ -2541,7 +2466,7 @@
 {
 	NotebookPageBox *pNotebookPage = NULL;
 
-	if (m_state.readLock(8) == true)
+	if (m_state.read_lock(5) == true)
 	{
 		for (int pageNum = 0; pageNum < m_pNotebook->get_n_pages(); ++pageNum)
 		{
@@ -2578,7 +2503,7 @@
 {
 	int pageNumber = -1;
 
-	if (m_state.readLock(9) == true)
+	if (m_state.read_lock(6) == true)
 	{
 		for (int pageNum = 0; pageNum < m_pNotebook->get_n_pages(); ++pageNum)
 		{
@@ -2614,9 +2539,9 @@
 bool mainWindow::queue_index(const DocumentInfo &docInfo,
 	const string &labelName, unsigned int docId)
 {
-	if (get_threads_count() >= m_maxThreads)
+	if (m_state.get_threads_count() >= m_maxThreads)
 	{
-		if (m_state.writeLock(50) == true)
+		if (m_state.write_lock(5) == true)
 		{
 			m_state.m_indexQueue[docInfo] = labelName;
 
@@ -2927,7 +2852,7 @@
 			docId = index.hasDocument(url);
 		}
 		if ((docId == 0) &&
-			(m_state.writeLock(10) == true))
+			(m_state.write_lock(6) == true))
 		{
 			if (m_state.m_beingIndexed.find(url) == m_state.m_beingIndexed.end())
 			{
@@ -3039,7 +2964,7 @@
 				pViewPage = manage(new ViewPage(viewName, m_pHtmlView, m_settings));
 
 				// Append the page
-				if (m_state.writeLock(1) == true)
+				if (m_state.write_lock(7) == true)
 				{
 					pageNum = m_pNotebook->append_page(*pViewPage, *pTab);
 					m_pNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
@@ -3074,48 +2999,15 @@
 //
 // Start of worker thread
 //
-void mainWindow::start_thread(WorkerThread *pNewThread, bool inBackground)
+bool mainWindow::start_thread(WorkerThread *pNewThread, bool inBackground)
 {
-	static unsigned int nextId = 1;
-	bool insertedThread = false;
-
-	if (pNewThread == NULL)
+	if (m_state.start_thread(pNewThread, inBackground) == false)
 	{
-		return;
-	}
-
-	pNewThread->setId(nextId);
-	if (m_state.writeLock(11) == true)
-	{
-		pair<set<WorkerThread *>::iterator, bool> insertPair = m_state.m_pThreads.insert(pNewThread);
-		insertedThread = insertPair.second;
-
-		m_state.unlock();
-	}
-
-	// Was it inserted ?
-	if (insertedThread == false)
-	{
-		// No, it wasn't : delete the object and return
-		cerr << "mainWindow::start_thread: couldn't start "
-			<< pNewThread->getType() << " " << pNewThread->getId() << endl;
+		// Delete the object
 		delete pNewThread;
-
-		return;
+		return false;
 	}
 
-	// Start the thread
-#ifdef DEBUG
-	cout << "mainWindow::start_thread: start of " << pNewThread->getType()
-		<< " " << pNewThread->getId() << endl;
-#endif
-	if (inBackground == true)
-	{
-		pNewThread->inBackground();
-		++m_state.m_backgroundThreads;
-	}
-	pNewThread->start();
-
 	if (inBackground == false)
 	{
 		// Enable the activity progress bar
@@ -3124,10 +3016,9 @@
 		m_timeoutConnection = Glib::signal_timeout().connect(SigC::slot(*this,
 			&mainWindow::on_activity_timeout), 1000);
 		m_timeoutConnection.unblock();
-		// Update the status
-		update_threads_status();
 	}
-	++nextId;
+
+	return true;
 }
 
 //
@@ -3135,7 +3026,7 @@
 //
 bool mainWindow::check_queue(void)
 {
-	if (get_threads_count() >= m_maxThreads)
+	if (m_state.get_threads_count() >= m_maxThreads)
 	{
 #ifdef DEBUG
 		cout << "mainWindow::check_queue: too many threads" << endl;
@@ -3146,7 +3037,7 @@
 	DocumentInfo docInfo;
 	string labelName;
 
-	if (m_state.writeLock(12) == true)
+	if (m_state.write_lock(9) == true)
 	{
 		if (m_state.m_indexQueue.empty() == false)
 		{
@@ -3191,52 +3082,6 @@
 }
 
 //
-// Returns the number of non-background threads.
-//
-unsigned int mainWindow::get_threads_count(void)
-{
-	int count = 0;
-
-	if (m_state.readLock(13) == true)
-	{
-		count = m_state.m_pThreads.size() - m_state.m_backgroundThreads;
-		m_state.unlock();
-	}
-#ifdef DEBUG
-	cout << "mainWindow::get_threads_count: " << count << " threads left" << endl;
-#endif
-
-	// A negative count would mean that a background thread returned
-	// without the main thread knowing about it
-	return (unsigned int)max(count , 0);
-}
-
-//
-// Updates the threads status text.
-//
-void mainWindow::update_threads_status(void)
-{
-	ustring text;
-	unsigned int threads = get_threads_count();
-
-	// Update the threads status text for the next call to set_status()
-	if (threads > 0)
-	{
-		char countStr[64];
-		snprintf(countStr, 64, "%d", threads);
-		text = countStr;
-		text += " ";
-		text += _("task(s) running");
-		text += " - ";
-		m_threadStatusText = text;
-	}
-	else
-	{
-		m_threadStatusText = "";
-	}
-}
-
-//
 // Sets the status bar text.
 //
 void mainWindow::set_status(const ustring &text, bool canBeSkipped)
@@ -3252,11 +3097,22 @@
 	}
 	lastTime = now;
 	
+	unsigned int threadsCount = m_state.get_threads_count();
+	if (threadsCount > 0)
+	{
+		char threadsCountStr[64];
+
+		snprintf(threadsCountStr, 64, "%u", threadsCount);
+		// Display the number of threads
+		mainProgressbar->set_text(threadsCountStr);
+	}
+	else
+	{
+		// Reset
+		mainProgressbar->set_text("");
+	}
 	// Pop the previous message
 	mainStatusbar->pop();
-	// Append the new message to the threads status text
-	ustring newText = m_threadStatusText;
-	newText += text;
 	// Push
-	mainStatusbar->push(newText);
+	mainStatusbar->push(text);
 }

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -20,7 +20,6 @@
 #include <string>
 #include <map>
 #include <set>
-#include <pthread.h>
 #include <sigc++/connection.h>
 #include <glibmm/refptr.h>
 #include <gdkmm/pixbuf.h>
@@ -73,7 +72,6 @@
 	void on_editindex(Glib::ustring indexName, Glib::ustring location);
 	void on_message_reception(DocumentInfo docInfo, std::string labelName);
 	void on_message_indexupdate(IndexedDocument docInfo, unsigned int docId, std::string indexName);
-	void on_message_import(DocumentInfo docInfo);
 
 	// Handlers inherited from the base class
 	virtual void on_configure_activate();
@@ -130,19 +128,14 @@
 	void index_document(const DocumentInfo &docInfo, const std::string &labelName,
 		unsigned int docId = 0);
 	bool view_document(const std::string &url, bool internalViewerOnly = false);
-	void start_thread(WorkerThread *pNewThread, bool inBackground = false);
+	bool start_thread(WorkerThread *pNewThread, bool inBackground = false);
 	bool check_queue(void);
 
 	// Status methods
 	bool on_activity_timeout(void);
-	unsigned int get_threads_count(void);
-	void update_threads_status(void);
 	void set_status(const Glib::ustring &text, bool canBeSkipped = false);
 
 private:
-	// Threads
-	SigC::Connection m_threadsEndConnection;
-	Glib::ustring m_threadStatusText;
 	// Global settings
 	PinotSettings &m_settings;
 	// Engine
@@ -167,23 +160,18 @@
 	// Activity timeout
 	SigC::Connection m_timeoutConnection;
 	// Internal state
-	struct InternalState
+	class InternalState : public ThreadsManager
 	{
 		public:
-			InternalState();
+			InternalState(mainWindow *pWindow);
 			~InternalState();
 
-			bool readLock(unsigned int where);
-			bool writeLock(unsigned int where);
-			void unlock(void);
+			void connect(void);
 
 			// Query
 			unsigned int m_liveQueryLength;
 			// Notebook pages
 			int m_currentPage;
-			// Worker threads
-			std::set<WorkerThread *> m_pThreads;
-			unsigned int m_backgroundThreads;
 			// In-progress actions
 			std::set<std::string> m_beingIndexed;
 			bool m_browsingIndex;
@@ -191,8 +179,7 @@
 			std::map<DocumentInfo, string> m_indexQueue;
 
 		protected:
-			// Read/write lock
-			pthread_rwlock_t m_rwLock;
+			mainWindow *m_pMainWindow;
 
 	} m_state;
 	static unsigned int m_maxDocsCount;

Modified: trunk/UI/GTK2/src/prefsDialog.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/prefsDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,10 +1,19 @@
-// generated 2003/5/18 21:15:37 BST by fabrice at amra.dyndns.org.(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to prefsDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include <stdlib.h>
 #include <iostream>
 #include <glibmm/convert.h>
@@ -20,7 +29,6 @@
 #include "config.h"
 #include "NLS.h"
 #include "PinotUtils.h"
-#include "importDialog.hh"
 #include "prefsDialog.hh"
 
 using namespace std;
@@ -281,33 +289,6 @@
 	return true;
 }
 
-void prefsDialog::on_message_import(DocumentInfo docInfo)
-{
-	Url urlObj(docInfo.getLocation());
-	string mimeType = docInfo.getType();
-
-	if ((urlObj.getProtocol() == "file") &&
-		(mimeType == "text/x-mail"))
-	{
-		string fileName = urlObj.getLocation();
-		fileName += "/";
-		fileName += urlObj.getFile();
-
-		// Create a new entry in the mail accounts list
-		TreeModel::iterator iter = m_refMailTree->append();
-		TreeModel::Row row = *iter;
-
-		row[m_mailColumns.m_location] = to_utf8(fileName);
-		row[m_mailColumns.m_type] = to_utf8(mimeType);
-		row[m_mailColumns.m_mTime] = 0;
-		row[m_mailColumns.m_minDate] = 0;
-	}
-
-	// Enable these buttons
-	editAccountButton->set_sensitive(true);
-	removeAccountButton->set_sensitive(true);
-}
-
 void prefsDialog::on_prefsOkbutton_clicked()
 {
 	// Synchronise widgets with settings
@@ -448,13 +429,34 @@
 
 void prefsDialog::on_addAccountButton_clicked()
 {
-	importDialog importBox(_("Import Mail Box(es)"), false, true, true);
+	ustring fileName;
 
-	importBox.getImportFileSignal().connect(SigC::slot(*this,
-		&prefsDialog::on_message_import));
-	importBox.show();
-	importBox.run();
-	// Let the signal handler deal with importing mail accounts
+	TreeModel::Children children = m_refMailTree->children();
+	bool wasEmpty = children.empty();
+
+	if (select_file_name(*this, _("Mbox File Location"), fileName, true) == true)
+	{
+		string mimeType = MIMEScanner::scanFile(fileName);
+
+		if (mimeType == "text/x-mail")
+		{
+			// Create a new entry in the mail accounts list
+			TreeModel::iterator iter = m_refMailTree->append();
+			TreeModel::Row row = *iter;
+	
+			row[m_mailColumns.m_location] = to_utf8(fileName);
+			row[m_mailColumns.m_type] = to_utf8(mimeType);
+			row[m_mailColumns.m_mTime] = 0;
+			row[m_mailColumns.m_minDate] = 0;
+
+			if (wasEmpty == true)
+			{
+				// Enable these buttons
+				editAccountButton->set_sensitive(true);
+				removeAccountButton->set_sensitive(true);
+			}
+		}
+	}
 }
 
 void prefsDialog::on_editAccountButton_clicked()

Modified: trunk/UI/GTK2/src/prefsDialog.hh
===================================================================
--- trunk/UI/GTK2/src/prefsDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/prefsDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,19 @@
-// generated 2003/5/18 21:15:37 BST by fabrice at amra.dyndns.org.(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to prefsDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _PREFSDIALOG_HH
 #define _PREFSDIALOG_HH
 
@@ -52,7 +57,6 @@
 	bool save_labelsTreeview();
 	void populate_mailTreeview();
 	bool save_mailTreeview();
-	void on_message_import(DocumentInfo docInfo);
 
 private:
 	PinotSettings &m_settings;

Modified: trunk/UI/GTK2/src/prefsDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/prefsDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2005/12/1 23:54:57 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/1/5 9:17:18 SGT by fabrice at thorgrim.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -69,7 +69,7 @@
    browserEntry = Gtk::manage(new class Gtk::Entry());
    browserButton = Gtk::manage(new class Gtk::Button(_("...")));
    
-   Gtk::HBox *browserHbox = Gtk::manage(new class Gtk::HBox(false, 0));
+   Gtk::HBox *browserHbox = Gtk::manage(new class Gtk::HBox(false, 4));
    Gtk::Table *generalTable = Gtk::manage(new class Gtk::Table(2, 2, false));
    Gtk::Label *generalLabel = Gtk::manage(new class Gtk::Label(_("General")));
    Gtk::Label *indexLabelsLabel = Gtk::manage(new class Gtk::Label(_("Labels are used to classify indexed documents:")));
@@ -166,7 +166,7 @@
    browserButton->set_flags(Gtk::CAN_DEFAULT);
    browserButton->set_relief(Gtk::RELIEF_NORMAL);
    browserHbox->pack_start(*browserEntry);
-   browserHbox->pack_start(*browserButton, Gtk::PACK_SHRINK, 4);
+   browserHbox->pack_start(*browserButton, Gtk::PACK_SHRINK, 0);
    generalTable->set_row_spacings(0);
    generalTable->set_col_spacings(0);
    generalTable->attach(*robotsLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 0, 0);

Modified: trunk/UI/GTK2/src/propertiesDialog.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/propertiesDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,21 @@
-// generated 2004/8/13 22:59:43 BST by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0_cvs
-//
-// newer (non customized) versions of this file go to propertiesDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include <iostream>
-#include <glibmm/convert.h>
-#include <pangomm/font.h>
-#include <gtkmm/rc.h>
+#include <utility>
 
 #include "config.h"
 #include "NLS.h"
@@ -18,7 +25,6 @@
 
 using namespace std;
 using namespace Glib;
-using namespace Gdk;
 using namespace Gtk;
 
 propertiesDialog::propertiesDialog(const std::set<std::string> &docLabels,
@@ -100,41 +106,18 @@
 {
 	// FIXME: there must be a better way to determine how high the tree should be
 	// for all rows to be visible !
-	int labelsCount = m_refLabelsTree->children().size();
-	// By default, the tree is high enough for two rows to be visible
-	if (labelsCount > 2)
+	int rowsCount = m_refLabelsTree->children().size();
+	// By default, the tree is high enough for two rows
+	if (rowsCount > 2)
 	{
 		int width, height;
-		get_size(width, height);
 
-		RefPtr<Style> refRCStyle = RC::get_style(*labelsTreeview);
-		int fontSize = refRCStyle->get_font().get_size() / Pango::SCALE;
-#ifdef DEBUG
-		cout << "propertiesDialog::setHeight: max " << maxHeight << ", dialog " << height
-			<< ", font " << fontSize << " " << refRCStyle->get_font().get_size() << endl;
-#endif
-		height += fontSize * (labelsCount - 2);
-
-		TreeViewColumn *pColumn = labelsTreeview->get_column(1);
-		if (pColumn != NULL)
-		{
-			Rectangle cell_area;
-			int x_offset, y_offset, cellWidth, cellHeight;
-			pColumn->cell_get_size(cell_area, x_offset, y_offset, cellWidth, cellHeight);
-#ifdef DEBUG
-			cout << "propertiesDialog::setHeight: cell " << cellHeight << " " << y_offset << endl;
-#endif
-			height += cellHeight * (labelsCount - 2);
-		}
-#ifdef DEBUG
-		cout << "propertiesDialog::setHeight: dialog " << height << endl;
-#endif
-
-		if (height > maxHeight)
-		{
-			height = maxHeight;
-		}
-		resize(width, height);
+		// What's the current size ?
+		get_size(width, height);
+		// Add enough room for the rows we need to show
+		height += get_column_height(labelsTreeview) * (rowsCount - 2);
+		// Resize
+		resize(width, min(maxHeight, height));
 	}
 }
 

Modified: trunk/UI/GTK2/src/propertiesDialog.hh
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/propertiesDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,19 @@
-// generated 2004/8/13 22:59:43 BST by fabrice at amra.dyndns.org.(none)
-// using glademm V2.6.0_cvs
-//
-// newer (non customized) versions of this file go to propertiesDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _LABELDIALOG_HH
 #define _LABELDIALOG_HH
 

Modified: trunk/UI/GTK2/src/propertiesDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2005/11/26 18:15:06 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/1/5 9:17:19 SGT by fabrice at thorgrim.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -192,7 +192,6 @@
    viewport1->show();
    labelsScrolledwindow->show();
    propertiesVbox->show();
-   propertiesDialog->show();
    labelOkButton->signal_clicked().connect(SigC::slot(*this, &propertiesDialog_glade::on_labelOkButton_clicked), false);
 }
 

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/queryDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,10 +1,19 @@
-// generated 2003/6/13 20:26:49 BST by fabrice at amra.dyndns.org.(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to queryDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include <iostream>
 #include <glibmm/ustring.h>
 #include <glibmm/convert.h>

Modified: trunk/UI/GTK2/src/queryDialog.hh
===================================================================
--- trunk/UI/GTK2/src/queryDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/queryDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,19 @@
-// generated 2003/6/13 20:26:49 BST by fabrice at amra.dyndns.org.(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to queryDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _QUERYDIALOG_HH
 #define _QUERYDIALOG_HH
 

Modified: trunk/UI/GTK2/src/queryDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/queryDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2005/12/15 22:39:14 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/1/9 22:33:43 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -116,6 +116,7 @@
    nameEntry->set_visibility(true);
    nameEntry->set_editable(true);
    nameEntry->set_max_length(0);
+   nameEntry->set_text(_(""));
    nameEntry->set_has_frame(true);
    nameEntry->set_activates_default(false);
    table1->set_row_spacings(0);
@@ -126,18 +127,21 @@
    anyEntry->set_visibility(true);
    anyEntry->set_editable(true);
    anyEntry->set_max_length(0);
+   anyEntry->set_text(_(""));
    anyEntry->set_has_frame(true);
    anyEntry->set_activates_default(false);
    hostNameEntry->set_flags(Gtk::CAN_FOCUS);
    hostNameEntry->set_visibility(true);
    hostNameEntry->set_editable(true);
    hostNameEntry->set_max_length(0);
+   hostNameEntry->set_text(_(""));
    hostNameEntry->set_has_frame(true);
    hostNameEntry->set_activates_default(false);
    fileNameEntry->set_flags(Gtk::CAN_FOCUS);
    fileNameEntry->set_visibility(true);
    fileNameEntry->set_editable(true);
    fileNameEntry->set_max_length(0);
+   fileNameEntry->set_text(_(""));
    fileNameEntry->set_has_frame(true);
    fileNameEntry->set_activates_default(false);
    resultsCountSpinbutton->set_flags(Gtk::CAN_FOCUS);
@@ -183,6 +187,7 @@
    notEntry->set_visibility(true);
    notEntry->set_editable(true);
    notEntry->set_max_length(0);
+   notEntry->set_text(_(""));
    notEntry->set_has_frame(true);
    notEntry->set_activates_default(false);
    tersmTable->set_row_spacings(0);
@@ -216,6 +221,7 @@
    phraseEntry->set_visibility(true);
    phraseEntry->set_editable(true);
    phraseEntry->set_max_length(0);
+   phraseEntry->set_text(_(""));
    phraseEntry->set_has_frame(true);
    phraseEntry->set_activates_default(false);
    phraseLabel->set_alignment(0,0.5);
@@ -234,6 +240,7 @@
    andEntry->set_visibility(true);
    andEntry->set_editable(true);
    andEntry->set_max_length(0);
+   andEntry->set_text(_(""));
    andEntry->set_has_frame(true);
    andEntry->set_activates_default(false);
    andLabel->set_alignment(0,0.5);



From fabricecolin at berlios.de  Tue Jan 10 14:04:19 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 10 Jan 2006 14:04:19 +0100
Subject: [Pinot-svn] r54 - trunk/UI/GTK2/src
Message-ID: <200601101304.k0AD4JTx025868@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-10 14:04:16 +0100 (Tue, 10 Jan 2006)
New Revision: 54

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/UI/GTK2/src/importDialog_glade.cc
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/queryDialog_glade.cc
Log:
Fixes for the previous check-in.


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-10 09:46:28 UTC (rev 53)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-10 13:04:16 UTC (rev 54)
@@ -805,7 +805,7 @@
 		}
 		else if (m_done == false)
 		{
-			DocumentInfo docInfo("Document", m_url, "", "");
+			DocumentInfo docInfo("", m_url, "", "");
 
 			m_pDoc = m_downloader->retrieveUrl(docInfo);
 		}
@@ -1670,7 +1670,8 @@
 	m_dirName(dirName),
 	m_maxLevel(maxLevel),
 	m_pMutex(pMutex),
-	m_pCondVar(pCondVar)
+	m_pCondVar(pCondVar),
+	m_currentLevel(0)
 {
 }
 
@@ -1737,43 +1738,36 @@
 	}
 }
 
-void DirectoryScannerThread::do_scanning()
+bool DirectoryScannerThread::scan_directory(const string &dirName)
 {
 	struct stat fileStat;
 
-	if ((m_dirName.empty() == true) ||
-		(lstat(m_dirName.c_str(), &fileStat) == -1))
+	if ((dirName.empty() == true) ||
+		(lstat(dirName.c_str(), &fileStat) == -1))
 	{
-#ifdef DEBUG
-		cout << "DirectoryScannerThread::do_scanning: stat failed" << endl;
-#endif
-		return;
+		return false;
 	}
 
 	// Is it a file or a directory ?
 	if (S_ISLNK(fileStat.st_mode))
 	{
-		// Don't follow
-#ifdef DEBUG
-		cout << "DirectoryScannerThread::do_scanning: skipping symlink" << endl;
-#endif
-		return;
+		return false;
 	}
 	else if (S_ISREG(fileStat.st_mode))
 	{
 		// It's actually a file
-		found_file(m_dirName);
+		found_file(dirName);
 	}
 	else if (S_ISDIR(fileStat.st_mode))
 	{
 		// A directory : scan it
-		DIR *pDir = opendir(m_dirName.c_str());
+		DIR *pDir = opendir(dirName.c_str());
 		if (pDir == NULL)
 		{
-			return;
+			return false;
 		}
 #ifdef DEBUG
-		cout << "DirectoryScannerThread::do_scanning: entering " << m_dirName << endl;
+		cout << "DirectoryScannerThread::scan_directory: entering " << dirName << endl;
 #endif
 
 		// Iterate through this directory's entries
@@ -1784,8 +1778,8 @@
 			char *pEntryName = pDirEntry->d_name;
 			if (pEntryName != NULL)
 			{
-				string entryName = m_dirName;
-				if (m_dirName[m_dirName.length() - 1] != '/')
+				string entryName = dirName;
+				if (dirName[dirName.length() - 1] != '/')
 				{
 					entryName += "/";
 				}
@@ -1804,7 +1798,7 @@
 				}
 
 #ifdef DEBUG
-				cout << "DirectoryScannerThread::do_scanning: stat'ing " << entryName << endl;
+				cout << "DirectoryScannerThread::scan_directory: stat'ing " << entryName << endl;
 #endif
 				// File or directory
 				if (S_ISREG(fileStat.st_mode))
@@ -1814,11 +1808,15 @@
 				else if (S_ISDIR(fileStat.st_mode))
 				{
 					// Can we scan this directory ?
-					if (m_currentLevel + 1 < m_maxLevel)
+					if ((m_maxLevel == 0) ||
+						(m_currentLevel + 1 < m_maxLevel))
 					{
 						++m_currentLevel;
-						m_dirName = entryName;
-						do_scanning();
+						scan_directory(entryName);
+#ifdef DEBUG
+						cout << "DirectoryScannerThread::scan_directory: done at level "
+							<< m_currentLevel << endl;
+#endif
 						--m_currentLevel;
 					}
 				}
@@ -1830,5 +1828,15 @@
 		closedir(pDir);
 	}
 
+	return true;
+}
+
+void DirectoryScannerThread::do_scanning()
+{
+	if (scan_directory(m_dirName) == false)
+	{
+		m_status = _("Couldn't open directory ");
+		m_status += m_dirName;
+	}
 	emitSignal();
 }

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-01-10 09:46:28 UTC (rev 53)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-01-10 13:04:16 UTC (rev 54)
@@ -449,6 +449,7 @@
 		SigC::Signal1<bool, const std::string&> m_signalFileFound;
 
 		void found_file(const std::string &fileName);
+		bool scan_directory(const std::string &dirName);
 		void do_scanning();
 
 	private:

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-10 13:04:16 UTC (rev 54)
@@ -22,7 +22,6 @@
 #include <sigc++/class_slot.h>
 #include <glibmm/convert.h>
 #include <gtkmm/stock.h>
-#include <gtkmm/main.h>
 
 #include "config.h"
 #include "MIMEScanner.h"
@@ -34,7 +33,6 @@
 #include "importDialog.hh"
 
 using namespace std;
-using namespace SigC;
 using namespace Glib;
 using namespace Gtk;
 
@@ -120,7 +118,6 @@
 	// The title field may remain empty
 	importButton->set_sensitive(false);
 	importProgressbar->set_pulse_step(0.10);
-	importProgressbar->set_text(_("Waiting..."));
 }
 
 importDialog::~importDialog()
@@ -133,10 +130,10 @@
 
 	TreeModel::iterator iter = m_refTypeList->append();
 	TreeModel::Row row = *iter;
-	row[m_typeColumns.m_name] = _("Single file");
+	row[m_typeColumns.m_name] = _("File");
 	iter = m_refTypeList->append();
 	row = *iter;
-	row[m_typeColumns.m_name] = _("Whole directory");
+	row[m_typeColumns.m_name] = _("Directory");
 	if (localOnly == false)
 	{
 		iter = m_refTypeList->append();
@@ -176,6 +173,13 @@
 	return true;
 }
 
+bool importDialog::on_activity_timeout()
+{
+	importProgressbar->pulse();
+
+	return true;
+}
+
 bool importDialog::on_import_file(const string &fileName)
 {
 	string mimeType = MIMEScanner::scanFile(fileName);
@@ -200,9 +204,6 @@
 		string title = locale_from_utf8(m_title);
 		unsigned int docId = 0;
 
-		importProgressbar->pulse();
-		importProgressbar->set_text(to_utf8(fileName));
-
 		if (index.isGood() == true)
 		{
 			docId = index.hasDocument(url);
@@ -241,6 +242,7 @@
 void importDialog::on_thread_end()
 {
 	ustring status;
+	bool success = true;
 
 	WorkerThread *pThread = m_state.on_thread_end();
 	if (pThread == NULL)
@@ -261,12 +263,21 @@
 		m_state.m_importing = false;
 	}
 
+	// Did the thread fail ?
+	if (pThread->getStatus().empty() == false)
+	{
+#ifdef DEBUG
+		cout << "importDialog::on_thread_end: " << pThread->getStatus() << endl;
+#endif
+		success = false;
+	}
+
 	// What type of thread was it ?
 	string type = pThread->getType();
 	if (type == "IndexingThread")
 	{
 		// Did it succeed ?
-		if (pThread->getStatus().empty() == true)
+		if (success == true)
 		{
 			// Yes, it did
 			++m_docsCount;
@@ -287,17 +298,11 @@
 	// Delete the thread
 	delete pThread;
 
-	do
+	if (m_state.m_importing == false)
 	{
-#ifdef DEBUG
-		cout << "importDialog::on_thread_end: UI event" << endl;
-#endif
-		Main::iteration(false);
-	} while(Main::events_pending() == true);
+		m_timeoutConnection.block();
+		m_timeoutConnection.disconnect();
 
-	if (m_state.m_importing == false)
-	{
-		importProgressbar->set_text(_("Done"));
 		importProgressbar->set_fraction(1.0);
 		importButton->set_sensitive(true);
 	}
@@ -469,6 +474,9 @@
 		// Maximum depth
 		unsigned int maxDirLevel = (unsigned int)depthSpinbutton->get_value();
 
+		m_timeoutConnection = Glib::signal_timeout().connect(SigC::slot(*this,
+			&importDialog::on_activity_timeout), 1000);
+
 		// Scan the directory and import all its files
 		DirectoryScannerThread *pThread = new DirectoryScannerThread(location,
 			maxDirLevel, &m_state.m_scanMutex, &m_state.m_scanCondVar);
@@ -486,6 +494,12 @@
 
 void importDialog::on_importDialog_response(int response_id)
 {
+	if (m_timeoutConnection.connected() == true)
+	{
+		m_timeoutConnection.block();
+		m_timeoutConnection.disconnect();
+	}
+
 	// Closing the window should stop everything
 	m_state.stop_threads();
 	m_state.disconnect();

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
+++ trunk/UI/GTK2/src/importDialog.hh	2006-01-10 13:04:16 UTC (rev 54)
@@ -21,6 +21,7 @@
 #include <set>
 #include <pthread.h>
 #include <sigc++/slot.h>
+#include <sigc++/connection.h>
 #include <glibmm/refptr.h>
 #include <glibmm/ustring.h>
 #include <gtkmm/button.h>
@@ -48,19 +49,24 @@
 	void populate_mimeTreeview(void);
 	bool start_thread(WorkerThread *pNewThread);
 
+	bool on_activity_timeout();
 	bool on_import_file(const std::string &fileName);
 	void on_thread_end(void);
 
 private:
 	std::set<std::string> m_mimeTypes;
 	std::set<std::string> m_mimeTypesBlackList;
+	// Type
 	ComboModelColumns m_typeColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refTypeList;
 	Glib::ustring m_title;
 	unsigned int m_docsCount;
 	bool m_importDirectory;
+	// MIME types
 	TypeModelColumns m_mimeTypeColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refMimeTypeList;
+	// Activity timeout
+	SigC::Connection m_timeoutConnection;
 	// Internal state
 	class InternalState : public ThreadsManager
 	{

Modified: trunk/UI/GTK2/src/importDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
+++ trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-10 13:04:16 UTC (rev 54)
@@ -98,7 +98,6 @@
    titleEntry->set_visibility(true);
    titleEntry->set_editable(true);
    titleEntry->set_max_length(0);
-   titleEntry->set_text(_(""));
    titleEntry->set_has_frame(true);
    titleEntry->set_activates_default(false);
    locationLabel->set_alignment(0,0.5);
@@ -123,7 +122,6 @@
    locationEntry->set_visibility(true);
    locationEntry->set_editable(true);
    locationEntry->set_max_length(0);
-   locationEntry->set_text(_(""));
    locationEntry->set_has_frame(true);
    locationEntry->set_activates_default(false);
    locationButton->set_flags(Gtk::CAN_FOCUS);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-10 09:46:28 UTC (rev 53)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-10 13:04:16 UTC (rev 54)
@@ -1326,7 +1326,7 @@
 	// FIXME: if mail accounts are configured, make sure the MonitorThread
 	// is running and knows about the new accounts
 
-	if (m_state.read_lock(2) == true)
+	if (m_state.read_lock(5) == true)
 	{
 		for (int pageNum = 0; pageNum < m_pNotebook->get_n_pages(); ++pageNum)
 		{
@@ -2445,7 +2445,7 @@
 {
 	NotebookPageBox *pNotebookPage = NULL;
 
-	if (m_state.read_lock(4) == true)
+	if (m_state.read_lock(6) == true)
 	{
 		Widget *pPage = m_pNotebook->get_nth_page(m_pNotebook->get_current_page());
 		if (pPage != NULL)
@@ -2466,7 +2466,7 @@
 {
 	NotebookPageBox *pNotebookPage = NULL;
 
-	if (m_state.read_lock(5) == true)
+	if (m_state.read_lock(7) == true)
 	{
 		for (int pageNum = 0; pageNum < m_pNotebook->get_n_pages(); ++pageNum)
 		{
@@ -2503,7 +2503,7 @@
 {
 	int pageNumber = -1;
 
-	if (m_state.read_lock(6) == true)
+	if (m_state.read_lock(8) == true)
 	{
 		for (int pageNum = 0; pageNum < m_pNotebook->get_n_pages(); ++pageNum)
 		{
@@ -2541,7 +2541,7 @@
 {
 	if (m_state.get_threads_count() >= m_maxThreads)
 	{
-		if (m_state.write_lock(5) == true)
+		if (m_state.write_lock(9) == true)
 		{
 			m_state.m_indexQueue[docInfo] = labelName;
 
@@ -2852,7 +2852,7 @@
 			docId = index.hasDocument(url);
 		}
 		if ((docId == 0) &&
-			(m_state.write_lock(6) == true))
+			(m_state.write_lock(10) == true))
 		{
 			if (m_state.m_beingIndexed.find(url) == m_state.m_beingIndexed.end())
 			{
@@ -2964,7 +2964,7 @@
 				pViewPage = manage(new ViewPage(viewName, m_pHtmlView, m_settings));
 
 				// Append the page
-				if (m_state.write_lock(7) == true)
+				if (m_state.write_lock(11) == true)
 				{
 					pageNum = m_pNotebook->append_page(*pViewPage, *pTab);
 					m_pNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
@@ -3037,7 +3037,7 @@
 	DocumentInfo docInfo;
 	string labelName;
 
-	if (m_state.write_lock(9) == true)
+	if (m_state.write_lock(12) == true)
 	{
 		if (m_state.m_indexQueue.empty() == false)
 		{

Modified: trunk/UI/GTK2/src/queryDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
+++ trunk/UI/GTK2/src/queryDialog_glade.cc	2006-01-10 13:04:16 UTC (rev 54)
@@ -116,7 +116,6 @@
    nameEntry->set_visibility(true);
    nameEntry->set_editable(true);
    nameEntry->set_max_length(0);
-   nameEntry->set_text(_(""));
    nameEntry->set_has_frame(true);
    nameEntry->set_activates_default(false);
    table1->set_row_spacings(0);
@@ -127,21 +126,18 @@
    anyEntry->set_visibility(true);
    anyEntry->set_editable(true);
    anyEntry->set_max_length(0);
-   anyEntry->set_text(_(""));
    anyEntry->set_has_frame(true);
    anyEntry->set_activates_default(false);
    hostNameEntry->set_flags(Gtk::CAN_FOCUS);
    hostNameEntry->set_visibility(true);
    hostNameEntry->set_editable(true);
    hostNameEntry->set_max_length(0);
-   hostNameEntry->set_text(_(""));
    hostNameEntry->set_has_frame(true);
    hostNameEntry->set_activates_default(false);
    fileNameEntry->set_flags(Gtk::CAN_FOCUS);
    fileNameEntry->set_visibility(true);
    fileNameEntry->set_editable(true);
    fileNameEntry->set_max_length(0);
-   fileNameEntry->set_text(_(""));
    fileNameEntry->set_has_frame(true);
    fileNameEntry->set_activates_default(false);
    resultsCountSpinbutton->set_flags(Gtk::CAN_FOCUS);
@@ -187,7 +183,6 @@
    notEntry->set_visibility(true);
    notEntry->set_editable(true);
    notEntry->set_max_length(0);
-   notEntry->set_text(_(""));
    notEntry->set_has_frame(true);
    notEntry->set_activates_default(false);
    tersmTable->set_row_spacings(0);
@@ -221,7 +216,6 @@
    phraseEntry->set_visibility(true);
    phraseEntry->set_editable(true);
    phraseEntry->set_max_length(0);
-   phraseEntry->set_text(_(""));
    phraseEntry->set_has_frame(true);
    phraseEntry->set_activates_default(false);
    phraseLabel->set_alignment(0,0.5);
@@ -240,7 +234,6 @@
    andEntry->set_visibility(true);
    andEntry->set_editable(true);
    andEntry->set_max_length(0);
-   andEntry->set_text(_(""));
    andEntry->set_has_frame(true);
    andEntry->set_activates_default(false);
    andLabel->set_alignment(0,0.5);



From fabricecolin at berlios.de  Tue Jan 10 16:58:57 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 10 Jan 2006 16:58:57 +0100
Subject: [Pinot-svn] r55 - trunk/UI/GTK2/src
Message-ID: <200601101558.k0AFwvm0031050@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-10 16:58:56 +0100 (Tue, 10 Jan 2006)
New Revision: 55

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Clean threads termination at last ! Some other minor changes.


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-10 13:04:16 UTC (rev 54)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-10 15:58:56 UTC (rev 55)
@@ -26,7 +26,6 @@
 #include <iostream>
 #include <fstream>
 #include <sigc++/class_slot.h>
-#include <glibmm/thread.h>
 
 #include "HtmlTokenizer.h"
 #include "MIMEScanner.h"
@@ -52,13 +51,18 @@
 using namespace Glib;
 using namespace std;
 
-// A function object to delete pointers from a set with for_each()
-struct DeleteSetPointer
+// A function object to stop and delete threads with for_each()
+struct DeleteMapPointer
 {
-	template<typename T>
-	void operator()(const T *ptr) const
+public:
+	void operator()(map<WorkerThread *, Thread *>::value_type &p)
 	{
-		delete ptr;
+		p.first->stop();
+#ifdef DEBUG
+		cout << "DeleteMapPointer: waiting for thread " << p.first->getId() << endl;
+#endif
+		p.second->join();
+		delete p.first;
 	}
 };
 
@@ -70,6 +74,7 @@
 }
 
 WorkerThread::WorkerThread() :
+	m_joinable(true),
 	m_id(0),
 	m_background(false),
 	m_done(false)
@@ -138,10 +143,7 @@
 
 ThreadsManager::~ThreadsManager()
 {
-	if (m_threads.empty() == false)
-	{
-		for_each(m_threads.begin(), m_threads.end(), DeleteSetPointer());
-	}
+	stop_threads();
 	// Destroy the read/write lock
 	pthread_rwlock_destroy(&m_rwLock);
 }
@@ -182,80 +184,75 @@
 
 WorkerThread *ThreadsManager::on_thread_end(void)
 {
-	WorkerThread *pThread = NULL;
+	WorkerThread *pWorkerThread = NULL;
 
 	// Get the first thread that's finished
 	if (read_lock(1) == true)
 	{
-		for (set<WorkerThread *>::iterator threadIter = m_threads.begin();
+		for (map<WorkerThread *, Thread *>::iterator threadIter = m_threads.begin();
 			threadIter != m_threads.end(); ++threadIter)
 		{
-			if ((*threadIter)->isDone() == true)
+			if (threadIter->first->isDone() == true)
 			{
 				// This one will do...
-				pThread = (*threadIter);
+				pWorkerThread = threadIter->first;
+				threadIter->second->join();
 				// Remove it
 				m_threads.erase(threadIter);
 				break;
 			}
 #ifdef DEBUG
 			cout << "ThreadsManager::on_thread_end: thread "
-				<< (*threadIter)->getId() << " is not done" << endl;
+				<< threadIter->first->getId() << " is not done" << endl;
 #endif
 		}
 
 		unlock();
 	}
 
-	if (pThread == NULL)
+	if (pWorkerThread == NULL)
 	{
 		return NULL;
 	}
 
-	if (pThread->isBackground() == true)
+	if (pWorkerThread->isBackground() == true)
 	{
 		--m_backgroundThreadsCount;
 	}
 
-	return pThread;
+	return pWorkerThread;
 }
 
-bool ThreadsManager::start_thread(WorkerThread *pNewThread, bool inBackground)
+bool ThreadsManager::start_thread(WorkerThread *pWorkerThread, bool inBackground)
 {
 	bool insertedThread = false;
 
-	if (pNewThread == NULL)
+	if (pWorkerThread == NULL)
 	{
 		return false;
 	}
 
-	pNewThread->setId(m_nextId);
-	if (write_lock(2) == true)
+	pWorkerThread->setId(m_nextId);
+	if (inBackground == true)
 	{
-		pair<set<WorkerThread *>::iterator, bool> insertPair = m_threads.insert(pNewThread);
-		insertedThread = insertPair.second;
-
-		unlock();
+		pWorkerThread->inBackground();
+		++m_backgroundThreadsCount;
 	}
 
-	// Was it inserted ?
-	if (insertedThread == false)
+	// Start the thread
+	Thread *pThread = pWorkerThread->start();
+	if (pThread == NULL)
 	{
-		// No, it wasn't
-#ifdef DEBUG
-		cout << "ThreadsManager::start_thread: couldn't start "
-			<< pNewThread->getType() << endl;
-#endif
 		return false;
 	}
 
-	// Start the thread
-	if (inBackground == true)
+	// Insert
+	if (write_lock(2) == true)
 	{
-		pNewThread->inBackground();
-		++m_backgroundThreadsCount;
+		m_threads[pWorkerThread] = pThread;
+
+		unlock();
 	}
-	pNewThread->start();
 	++m_nextId;
 
 	return true;
@@ -292,17 +289,15 @@
 
 void ThreadsManager::stop_threads(void)
 {
-	if (read_lock(4) == true)
+	if (m_threads.empty() == false)
 	{
-		for (set<WorkerThread *>::iterator threadIter = m_threads.begin();
-			threadIter != m_threads.end(); ++threadIter)
+		if (read_lock(4) == true)
 		{
-			// Stop all threads
-			// FIXME: what if one thread doesn't stop ?
-			(*threadIter)->stop();
-		}
+			for_each(m_threads.begin(), m_threads.end(), DeleteMapPointer());
+			m_threads.clear();
 
-		unlock();
+			unlock();
+		}
 	}
 }
 
@@ -329,12 +324,9 @@
 {
 }
 
-bool IndexBrowserThread::start(void)
+Thread *IndexBrowserThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &IndexBrowserThread::do_browsing), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &IndexBrowserThread::do_browsing), m_joinable);
 }
 
 string IndexBrowserThread::getType(void) const
@@ -462,12 +454,9 @@
 {
 }
 
-bool QueryingThread::start(void)
+Thread  *QueryingThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &QueryingThread::do_querying), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &QueryingThread::do_querying), m_joinable);
 }
 
 string QueryingThread::getType(void) const
@@ -577,12 +566,9 @@
 {
 }
 
-bool LabelQueryThread::start(void)
+Thread *LabelQueryThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &LabelQueryThread::do_querying), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &LabelQueryThread::do_querying), m_joinable);
 }
 
 string LabelQueryThread::getType(void) const
@@ -654,12 +640,9 @@
 {
 }
 
-bool LabelUpdateThread::start(void)
+Thread *LabelUpdateThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &LabelUpdateThread::do_update), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &LabelUpdateThread::do_update), m_joinable);
 }
 
 string LabelUpdateThread::getType(void) const
@@ -735,12 +718,9 @@
 	}
 }
 
-bool DownloadingThread::start(void)
+Thread *DownloadingThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &DownloadingThread::do_downloading), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &DownloadingThread::do_downloading), m_joinable);
 }
 
 string DownloadingThread::getType(void) const
@@ -855,12 +835,9 @@
 {
 }
 
-bool IndexingThread::start(void)
+Thread *IndexingThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &IndexingThread::do_indexing), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &IndexingThread::do_indexing), m_joinable);
 }
 
 string IndexingThread::getType(void) const
@@ -1042,7 +1019,7 @@
 				m_status += " ";
 				m_status += m_url;
 			}
-			else
+			else if (m_done == false)
 			{
 				// Flush the index
 				index.flush();
@@ -1085,12 +1062,9 @@
 {
 }
 
-bool UnindexingThread::start(void)
+Thread *UnindexingThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &UnindexingThread::do_unindexing), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &UnindexingThread::do_unindexing), m_joinable);
 }
 
 string UnindexingThread::getType(void) const
@@ -1195,12 +1169,9 @@
 {
 }
 
-bool UpdateDocumentThread::start(void)
+Thread *UpdateDocumentThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &UpdateDocumentThread::do_update), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &UpdateDocumentThread::do_update), m_joinable);
 }
 
 string UpdateDocumentThread::getType(void) const
@@ -1275,19 +1246,26 @@
 ListenerThread::ListenerThread(const string &fifoFileName) :
 	WorkerThread()
 {
+	int pipeFds[2];
+
+	if (pipe(pipeFds) == 0)
+	{
+		// This pipe will allow to stop select()
+		m_ctrlReadPipe = pipeFds[0];
+		m_ctrlWritePipe = pipeFds[1];
+	}
 	m_fifoFileName = fifoFileName;
 }
 
 ListenerThread::~ListenerThread()
 {
+	close(m_ctrlReadPipe);
+	close(m_ctrlWritePipe);
 }
 
-bool ListenerThread::start(void)
+Thread *ListenerThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &ListenerThread::do_listening), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &ListenerThread::do_listening), m_joinable);
 }
 
 string ListenerThread::getType(void) const
@@ -1298,6 +1276,7 @@
 bool ListenerThread::stop(void)
 {
 	m_done = true;
+	write(m_ctrlWritePipe, "Stop", 4);
 	m_status = _("Stopped listening on");
 	m_status += " ";
 	m_status += m_fifoFileName;
@@ -1346,6 +1325,7 @@
 		fd_set listenSet;
 		FD_ZERO(&listenSet);
 		FD_SET(fd, &listenSet);
+		FD_SET(m_ctrlReadPipe, &listenSet);
 
 		// Listen and wait for something to read
 		while (m_done == false)
@@ -1408,6 +1388,14 @@
 MonitorThread::MonitorThread(MonitorHandler *pHandler) :
 	WorkerThread()
 {
+	int pipeFds[2];
+
+	if (pipe(pipeFds) == 0)
+	{
+		// This pipe will allow to stop select()
+		m_ctrlReadPipe = pipeFds[0];
+		m_ctrlWritePipe = pipeFds[1];
+	}
 	m_pHandler = pHandler;
 	m_numCPUs = sysconf(_SC_NPROCESSORS_ONLN);
 }
@@ -1419,14 +1407,13 @@
 	{
 		delete m_pHandler;
 	}
+	close(m_ctrlReadPipe);
+	close(m_ctrlWritePipe);
 }
 
-bool MonitorThread::start(void)
+Thread *MonitorThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &MonitorThread::do_monitoring), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &MonitorThread::do_monitoring), m_joinable);
 }
 
 string MonitorThread::getType(void) const
@@ -1437,6 +1424,7 @@
 bool MonitorThread::stop(void)
 {
 	m_done = true;
+	write(m_ctrlWritePipe, "Stop", 4);
 	m_status = _("Stopped monitoring");
 
 	return true;
@@ -1527,6 +1515,7 @@
 		fd_set listenSet;
 		FD_ZERO(&listenSet);
 		FD_SET(fd, &listenSet);
+		FD_SET(m_ctrlReadPipe, &listenSet);
 
 		struct timeval selectTimeout;
 		selectTimeout.tv_sec = 60;
@@ -1663,9 +1652,8 @@
 	emitSignal();
 }
 
-DirectoryScannerThread::DirectoryScannerThread(const std::string &dirName,
-			unsigned int maxLevel, pthread_mutex_t *pMutex,
-			pthread_cond_t *pCondVar) :
+DirectoryScannerThread::DirectoryScannerThread(const string &dirName,
+			unsigned int maxLevel, Mutex *pMutex, Cond *pCondVar) :
 	WorkerThread(),
 	m_dirName(dirName),
 	m_maxLevel(maxLevel),
@@ -1679,12 +1667,9 @@
 {
 }
 
-bool DirectoryScannerThread::start(void)
+Thread *DirectoryScannerThread::start(void)
 {
-	// Create a non-joinable thread
-	Thread::create(slot_class(*this, &DirectoryScannerThread::do_scanning), false);
-
-	return true;
+	return Thread::create(slot_class(*this, &DirectoryScannerThread::do_scanning), m_joinable);
 }
 
 string DirectoryScannerThread::getType(void) const
@@ -1695,7 +1680,7 @@
 bool DirectoryScannerThread::stop(void)
 {
 	m_done = true;
-	m_status = _("Stopped scanning ");
+	m_status = _("Stopped scanning");
 	m_status += " ";
 	m_status += m_dirName;
 
@@ -1715,13 +1700,13 @@
 	}
 
 	if ((m_pMutex != NULL) &&
-		(m_pCondVar != NULL) &&
-		(pthread_mutex_lock(m_pMutex) == 0))
+		(m_pCondVar != NULL))
 	{
+		m_pMutex->lock();
 		if (m_signalFileFound(fileName) == true)
 		{
 			// Another file is needed right now
-			pthread_mutex_unlock(m_pMutex);
+			m_pMutex->unlock();
 		}
 		else
 		{
@@ -1729,8 +1714,8 @@
 			cout << "DirectoryScannerThread::found_file: waiting" << endl;
 #endif
 			// Don't resume until signaled
-			pthread_cond_wait(m_pCondVar, m_pMutex);
-			pthread_mutex_unlock(m_pMutex);
+			m_pCondVar->wait(*m_pMutex);
+			m_pMutex->unlock();
 #ifdef DEBUG
 			cout << "DirectoryScannerThread::found_file: signaled" << endl;
 #endif
@@ -1835,7 +1820,8 @@
 {
 	if (scan_directory(m_dirName) == false)
 	{
-		m_status = _("Couldn't open directory ");
+		m_status = _("Couldn't open directory");
+		m_status += " ";
 		m_status += m_dirName;
 	}
 	emitSignal();

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-01-10 13:04:16 UTC (rev 54)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-01-10 15:58:56 UTC (rev 55)
@@ -26,6 +26,7 @@
 #include <sigc++/slot.h>
 #include <sigc++/connection.h>
 #include <glibmm/dispatcher.h>
+#include <glibmm/thread.h>
 #include <glibmm/ustring.h>
 
 #include "Document.h"
@@ -53,7 +54,7 @@
 
 		bool operator<(const WorkerThread &other) const;
 
-		virtual bool start(void) = 0;
+		virtual Glib::Thread *start(void) = 0;
 
 		virtual std::string getType(void) const = 0;
 
@@ -68,6 +69,7 @@
 	protected:
 		/// Use a Dispatcher for thread safety
 		static Glib::Dispatcher m_dispatcher;
+		bool m_joinable;
 		unsigned int m_id;
 		bool m_background;
 		bool m_done;
@@ -91,7 +93,7 @@
 		bool write_lock(unsigned int where);
 		void unlock(void);
 
-		bool start_thread(WorkerThread *pNewThread, bool inBackground);
+		bool start_thread(WorkerThread *pWorkerThread, bool inBackground);
 
 		WorkerThread *on_thread_end(void);
 
@@ -107,7 +109,7 @@
 		SigC::Connection m_threadsEndConnection;
 		// Read/write lock
 		pthread_rwlock_t m_rwLock;
-		std::set<WorkerThread *> m_threads;
+		std::map<WorkerThread *, Glib::Thread *> m_threads;
 		unsigned int m_nextId;
 		unsigned int m_backgroundThreadsCount;
 
@@ -124,7 +126,7 @@
 			unsigned int maxDocsCount = 0, unsigned int startDoc = 0);
 		~IndexBrowserThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		std::string getType(void) const;
 
@@ -158,7 +160,7 @@
 			const std::string &engineOption, const QueryProperties &queryProps);
 		virtual ~QueryingThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
@@ -192,7 +194,7 @@
 		LabelQueryThread(const std::string &indexName, const std::string &labelName);
 		virtual ~LabelQueryThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
@@ -224,7 +226,7 @@
 			const std::map<std::string, std::string> &labelsToRename);
 		virtual ~LabelUpdateThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
@@ -248,7 +250,7 @@
 		DownloadingThread(const std::string url, bool fromCache);
 		virtual ~DownloadingThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
@@ -277,12 +279,12 @@
 {
 	public:
 		/// Index a document.
-		IndexingThread(const DocumentInfo &docInfo, const std::string &labelName);
+		IndexingThread(const DocumentInfo &docInfo, const std::string &labelName = "");
 		/// Update a document.
 		IndexingThread(const DocumentInfo &docInfo, unsigned int docId);
 		virtual ~IndexingThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
@@ -321,7 +323,7 @@
 		UnindexingThread(const std::set<std::string> &labelNames, const std::string &indexLocation);
 		virtual ~UnindexingThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
@@ -351,7 +353,7 @@
 			unsigned int docId, const DocumentInfo &docInfo);
 		virtual ~UpdateDocumentThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
@@ -380,7 +382,7 @@
 		ListenerThread(const std::string &fifoFileName);
 		virtual ~ListenerThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
@@ -389,6 +391,8 @@
 		SigC::Signal2<void, DocumentInfo, std::string>& getReceptionSignal(void);
 
 	protected:
+		int m_ctrlReadPipe;
+		int m_ctrlWritePipe;
 		std::string m_fifoFileName;
 		SigC::Signal2<void, DocumentInfo, std::string> m_signalReception;
 
@@ -406,13 +410,15 @@
 		MonitorThread(MonitorHandler *pHandler);
 		virtual ~MonitorThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
 		virtual bool stop(void);
 
 	protected:
+		int m_ctrlReadPipe;
+		int m_ctrlWritePipe;
 		MonitorHandler *m_pHandler;
 		long m_numCPUs;
 
@@ -428,11 +434,11 @@
 {
 	public:
 		DirectoryScannerThread(const std::string &dirName,
-			unsigned int maxLevel, pthread_mutex_t *pMutex,
-			pthread_cond_t *pCondVar);
+			unsigned int maxLevel, Glib::Mutex *pMutex,
+			Glib::Cond *pCondVar);
 		virtual ~DirectoryScannerThread();
 
-		virtual bool start(void);
+		virtual Glib::Thread *start(void);
 
 		virtual std::string getType(void) const;
 
@@ -443,8 +449,8 @@
 	protected:
 		std::string m_dirName;
 		unsigned int m_maxLevel;
-		pthread_mutex_t *m_pMutex;
-		pthread_cond_t *m_pCondVar;
+		Glib::Mutex *m_pMutex;
+		Glib::Cond *m_pCondVar;
 		unsigned int m_currentLevel;
 		SigC::Signal1<bool, const std::string&> m_signalFileFound;
 

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-10 13:04:16 UTC (rev 54)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-10 15:58:56 UTC (rev 55)
@@ -43,14 +43,10 @@
 	m_importing(false),
 	m_pImportWindow(pWindow)
 {
-	pthread_mutex_init(&m_scanMutex, NULL);
-	pthread_cond_init(&m_scanCondVar, NULL);
 }
 
 importDialog::InternalState::~InternalState()
 {
-	pthread_cond_destroy(&m_scanCondVar);
-	pthread_mutex_destroy(&m_scanMutex);
 }
 
 void importDialog::InternalState::connect(void)
@@ -71,6 +67,7 @@
 	importDialog_glade(),
 	m_docsCount(0),
 	m_importDirectory(false),
+	m_pScannerThread(NULL),
 	m_state(this)
 {
 	set_title(title);
@@ -173,8 +170,19 @@
 	return true;
 }
 
-bool importDialog::on_activity_timeout()
+void importDialog::signal_scanner(void)
 {
+	// Ask the scanner for another file
+	m_state.m_scanMutex.lock();
+	m_state.m_scanCondVar.signal();
+	m_state.m_scanMutex.unlock();
+#ifdef DEBUG
+	cout << "importDialog::signal_scanner: signaled" << endl;
+#endif
+}
+
+bool importDialog::on_activity_timeout(void)
+{
 	importProgressbar->pulse();
 
 	return true;
@@ -229,7 +237,7 @@
 		}
 		else
 		{
-			pThread = new IndexingThread(docInfo, "");
+			pThread = new IndexingThread(docInfo);
 		}
 
 		// Launch the new thread
@@ -274,8 +282,18 @@
 
 	// What type of thread was it ?
 	string type = pThread->getType();
-	if (type == "IndexingThread")
+	if (type == "DirectoryScannerThread")
 	{
+		if (m_pScannerThread == dynamic_cast<DirectoryScannerThread *>(pThread))
+		{
+#ifdef DEBUG
+			cout << "importDialog::on_thread_end: reset scanner" << endl;
+#endif
+			m_pScannerThread = NULL;
+		}
+	}
+	else if (type == "IndexingThread")
+	{
 		// Did it succeed ?
 		if (success == true)
 		{
@@ -285,13 +303,7 @@
 
 		if (m_state.m_importing == true)
 		{
-			// Ask the scanner for another file
-			pthread_mutex_lock(&m_state.m_scanMutex);
-			pthread_cond_signal(&m_state.m_scanCondVar);
-			pthread_mutex_unlock(&m_state.m_scanMutex);
-#ifdef DEBUG
-			cout << "importDialog::on_thread_end: signaled DirectoryScannerThread" << endl;
-#endif
+			signal_scanner();
 		}
 	}
 
@@ -478,10 +490,10 @@
 			&importDialog::on_activity_timeout), 1000);
 
 		// Scan the directory and import all its files
-		DirectoryScannerThread *pThread = new DirectoryScannerThread(location,
+		m_pScannerThread = new DirectoryScannerThread(location,
 			maxDirLevel, &m_state.m_scanMutex, &m_state.m_scanCondVar);
-		pThread->getFileFoundSignal().connect(SigC::slot(*this, &importDialog::on_import_file));
-		start_thread(pThread);
+		m_pScannerThread->getFileFoundSignal().connect(SigC::slot(*this, &importDialog::on_import_file));
+		start_thread(m_pScannerThread);
 	}
 	else
 	{
@@ -501,6 +513,11 @@
 	}
 
 	// Closing the window should stop everything
+	m_state.disconnect();
+	if (m_pScannerThread != NULL)
+	{
+		m_pScannerThread->stop();
+		signal_scanner();
+	}
 	m_state.stop_threads();
-	m_state.disconnect();
 }

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2006-01-10 13:04:16 UTC (rev 54)
+++ trunk/UI/GTK2/src/importDialog.hh	2006-01-10 15:58:56 UTC (rev 55)
@@ -19,7 +19,6 @@
 
 #include <string>
 #include <set>
-#include <pthread.h>
 #include <sigc++/slot.h>
 #include <sigc++/connection.h>
 #include <glibmm/refptr.h>
@@ -48,8 +47,9 @@
 	void populate_typeCombobox(bool localOnly);
 	void populate_mimeTreeview(void);
 	bool start_thread(WorkerThread *pNewThread);
+	void signal_scanner(void);
 
-	bool on_activity_timeout();
+	bool on_activity_timeout(void);
 	bool on_import_file(const std::string &fileName);
 	void on_thread_end(void);
 
@@ -65,6 +65,8 @@
 	// MIME types
 	TypeModelColumns m_mimeTypeColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refMimeTypeList;
+	// Directory scanner
+	DirectoryScannerThread *m_pScannerThread;
 	// Activity timeout
 	SigC::Connection m_timeoutConnection;
 	// Internal state
@@ -78,8 +80,8 @@
 
 			// Directory scanning
 			bool m_importing;
-			pthread_mutex_t m_scanMutex;
-			pthread_cond_t m_scanCondVar;
+			Glib::Mutex m_scanMutex;
+			Glib::Cond m_scanCondVar;
 			// The default directory
 			static std::string m_defaultDirectory;
 

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-10 13:04:16 UTC (rev 54)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-10 15:58:56 UTC (rev 55)
@@ -2420,6 +2420,7 @@
 			return true;
 		}
 
+		m_state.disconnect();
 		m_state.stop_threads();
 	}
 	// Disconnect the threads' finished signal



From fabricecolin at berlios.de  Tue Jan 10 17:01:04 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 10 Jan 2006 17:01:04 +0100
Subject: [Pinot-svn] r56 - trunk/po
Message-ID: <200601101601.k0AG14NU031452@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-10 17:01:00 +0100 (Tue, 10 Jan 2006)
New Revision: 56

Modified:
   trunk/po/en_GB.po
   trunk/po/fr_FR.po
Log:
Synced po files with latest source.


Modified: trunk/po/en_GB.po
===================================================================
--- trunk/po/en_GB.po	2006-01-10 15:58:56 UTC (rev 55)
+++ trunk/po/en_GB.po	2006-01-10 16:01:00 UTC (rev 56)
@@ -1,15 +1,15 @@
 # en_GB PO file for pinot.
-# Copyright (C) 2005 Fabrice Colin
+# Copyright (C) 2005-2006 Fabrice Colin
 # This file is distributed under the same license as the pinot package.
-# Fabrice Colin <colinf at chez.com>, 2005.
+# Fabrice Colin <colinf at chez.com>, 2005-2006.
 #
 #, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.35\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2005-12-30 17:20+0800\n"
-"PO-Revision-Date: 2005-12-30 17:20+0800\n"
+"POT-Creation-Date: 2006-01-10 21:12+0800\n"
+"PO-Revision-Date: 2006-01-10 21:12+0800\n"
 "Last-Translator: Fabrice Colin <colinf at chez.com>\n"
 "Language-Team: en_GB <colinf at chez.com>\n"
 "MIME-Version: 1.0\n"
@@ -24,70 +24,79 @@
 msgid "Current User"
 msgstr ""
 
-#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:381
-#: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:557
-#: UI/GTK2/src/mainWindow.cc:1111 UI/GTK2/src/mainWindow.cc:1213
-#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:865
-#: UI/GTK2/src/PinotSettings.cpp:921
+#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:344
+#: UI/GTK2/src/mainWindow.cc:347 UI/GTK2/src/mainWindow.cc:520
+#: UI/GTK2/src/mainWindow.cc:1048 UI/GTK2/src/mainWindow.cc:1150
+#: UI/GTK2/src/mainWindow.cc:1763 UI/GTK2/src/PinotSettings.cpp:199
+#: UI/GTK2/src/PinotSettings.cpp:865 UI/GTK2/src/PinotSettings.cpp:921
 msgid "My Documents"
 msgstr ""
 
-#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:387
-#: UI/GTK2/src/mainWindow.cc:390 UI/GTK2/src/mainWindow.cc:561
+#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:350
+#: UI/GTK2/src/mainWindow.cc:353 UI/GTK2/src/mainWindow.cc:524
 #: UI/GTK2/src/MonitorHandler.cpp:174 UI/GTK2/src/PinotSettings.cpp:200
 #: UI/GTK2/src/PinotSettings.cpp:866 UI/GTK2/src/PinotSettings.cpp:922
 #: UI/GTK2/src/prefsDialog_glade.cc:116
 msgid "My Email"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:91
-msgid "Single file"
+#: UI/GTK2/src/importDialog.cc:104
+msgid "Enabled"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:94
-msgid "Whole directory"
+#: UI/GTK2/src/importDialog.cc:105 UI/GTK2/src/prefsDialog.cc:79
+msgid "MIME Type"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:99 UI/GTK2/src/IndexTree.cpp:71
-#: UI/GTK2/src/ResultsTree.cpp:114
-msgid "URL"
+#: UI/GTK2/src/importDialog.cc:130
+msgid "File"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:265
-msgid "Document To Import"
+#: UI/GTK2/src/importDialog.cc:133
+msgid "Directory"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:61 UI/GTK2/src/mainWindow_glade.cc:201
-msgid "Import"
+#: UI/GTK2/src/importDialog.cc:138 UI/GTK2/src/IndexTree.cpp:71
+#: UI/GTK2/src/ResultsTree.cpp:114
+msgid "URL"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:65
-msgid "Select"
+#: UI/GTK2/src/importDialog.cc:417
+msgid "Document To Import"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:74 UI/GTK2/src/indexDialog_glade.cc:68
+#: UI/GTK2/src/importDialog_glade.cc:66 UI/GTK2/src/indexDialog_glade.cc:68
 msgid "Location:"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:75
+#: UI/GTK2/src/importDialog_glade.cc:67
 #: UI/GTK2/src/propertiesDialog_glade.cc:64
 msgid "Title:"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:76
-msgid "Maximum depth:"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:82 UI/GTK2/src/indexDialog_glade.cc:67
+#: UI/GTK2/src/importDialog_glade.cc:70 UI/GTK2/src/indexDialog_glade.cc:67
 #: UI/GTK2/src/propertiesDialog_glade.cc:68
 msgid "Type:"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:162
+#: UI/GTK2/src/importDialog_glade.cc:72 UI/GTK2/src/indexDialog_glade.cc:64
+#: UI/GTK2/src/prefsDialog_glade.cc:70
+msgid "..."
+msgstr ""
+
+#: UI/GTK2/src/importDialog_glade.cc:75
+msgid "Depth:"
+msgstr ""
+
+#: UI/GTK2/src/importDialog_glade.cc:86 UI/GTK2/src/mainWindow_glade.cc:201
+msgid "Import"
+msgstr ""
+
+#: UI/GTK2/src/importDialog_glade.cc:186
 msgid "Import document"
 msgstr ""
 
-#: UI/GTK2/src/indexDialog.cc:202
+#: UI/GTK2/src/indexDialog.cc:211
 msgid "Index location"
 msgstr ""
 
@@ -95,10 +104,6 @@
 msgid "Name:"
 msgstr ""
 
-#: UI/GTK2/src/indexDialog_glade.cc:64 UI/GTK2/src/prefsDialog_glade.cc:70
-msgid "..."
-msgstr ""
-
 #: UI/GTK2/src/indexDialog_glade.cc:69
 msgid "Port:"
 msgstr ""
@@ -115,7 +120,7 @@
 msgid "Timestamp"
 msgstr ""
 
-#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:347
+#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:530
 msgid "No title"
 msgstr ""
 
@@ -128,244 +133,240 @@
 msgstr ""
 
 #: UI/GTK2/src/IndexPage.cpp:159 UI/GTK2/src/IndexPage.cpp:205
-#: UI/GTK2/src/queryDialog.cc:82
+#: UI/GTK2/src/queryDialog.cc:91
 msgid "None"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:179
+#: UI/GTK2/src/mainWindow.cc:148
 msgid "Query Name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:153
 msgid "Last Run"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:154
 msgid "Summary"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Add index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:243
+#: UI/GTK2/src/mainWindow.cc:212
 msgid "Remove index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:267
+#: UI/GTK2/src/mainWindow.cc:235
 msgid "Ready"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:286 UI/GTK2/src/mainWindow.cc:1075
-#: UI/GTK2/src/mainWindow.cc:1437 UI/GTK2/src/mainWindow.cc:3020
+#: UI/GTK2/src/mainWindow.cc:249 UI/GTK2/src/mainWindow.cc:1012
+#: UI/GTK2/src/mainWindow.cc:1360 UI/GTK2/src/mainWindow.cc:2945
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:318
+#: UI/GTK2/src/mainWindow.cc:281
 msgid "N/A"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:328
+#: UI/GTK2/src/mainWindow.cc:291
 msgid "<undefined>"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:519
+#: UI/GTK2/src/mainWindow.cc:482
 msgid "Result location is"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:572
+#: UI/GTK2/src/mainWindow.cc:535
 msgid "Document location is"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:681
+#: UI/GTK2/src/mainWindow.cc:644
 msgid "No label"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:856
+#: UI/GTK2/src/mainWindow.cc:793
 msgid "Showing"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:861
+#: UI/GTK2/src/mainWindow.cc:798
 msgid "off"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:866
+#: UI/GTK2/src/mainWindow.cc:803
 msgid "documents, starting at"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:900
+#: UI/GTK2/src/mainWindow.cc:837
 msgid "Query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:904 UI/GTK2/src/mainWindow.cc:2850
+#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2775
 msgid "on"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:908
+#: UI/GTK2/src/mainWindow.cc:845
 msgid "ended"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1009 UI/GTK2/src/propertiesDialog.cc:34
+#: UI/GTK2/src/mainWindow.cc:946 UI/GTK2/src/propertiesDialog.cc:40
 msgid "Label"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1013
+#: UI/GTK2/src/mainWindow.cc:950
 msgid "matches"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1018
+#: UI/GTK2/src/mainWindow.cc:955
 msgid "document(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1050
+#: UI/GTK2/src/mainWindow.cc:987
 msgid "Updated label(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1121 UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1058 UI/GTK2/src/mainWindow.cc:1161
 msgid "Updated document"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1134
+#: UI/GTK2/src/mainWindow.cc:1071
 msgid "Indexed"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1195
+#: UI/GTK2/src/mainWindow.cc:1132
 msgid "Unindexed document(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1275
+#: UI/GTK2/src/mainWindow.cc:1212
 msgid "Couldn't rename index, name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1279 UI/GTK2/src/mainWindow.cc:2174
-#: UI/GTK2/src/mainWindow.cc:2684
+#: UI/GTK2/src/mainWindow.cc:1216 UI/GTK2/src/mainWindow.cc:2119
+#: UI/GTK2/src/mainWindow.cc:2609
 msgid "is already in use"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1292
+#: UI/GTK2/src/mainWindow.cc:1229
 msgid "Couldn't rename index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1305
+#: UI/GTK2/src/mainWindow.cc:1242
 msgid "Edited index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1779 UI/GTK2/src/mainWindow.cc:1860
+#: UI/GTK2/src/mainWindow.cc:1702 UI/GTK2/src/mainWindow.cc:1805
 msgid "Please set a location for the index first"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1806
+#: UI/GTK2/src/mainWindow.cc:1729
 msgid "Result location is unknown"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1822
+#: UI/GTK2/src/mainWindow.cc:1753
 msgid "Import Document(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1938 UI/GTK2/src/pinot.cc:148
-#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:183
-#: UI/GTK2/src/WorkerThreads.cpp:428 UI/GTK2/src/WorkerThreads.cpp:1045
+#: UI/GTK2/src/mainWindow.cc:1883 UI/GTK2/src/pinot.cc:148
+#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:371
+#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1210
 msgid "Index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/WorkerThreads.cpp:187
-#: UI/GTK2/src/WorkerThreads.cpp:432 UI/GTK2/src/WorkerThreads.cpp:1049
+#: UI/GTK2/src/mainWindow.cc:1887 UI/GTK2/src/WorkerThreads.cpp:375
+#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1214
 msgid "doesn't exist"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2054
+#: UI/GTK2/src/mainWindow.cc:1999
 msgid "Delete this document from the index ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2073
+#: UI/GTK2/src/mainWindow.cc:2018
 msgid "Delete these documents from the index ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2125
+#: UI/GTK2/src/mainWindow.cc:2070
 msgid "A metasearch tool for the Free Desktop"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2126
+#: UI/GTK2/src/mainWindow.cc:2071
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2170
+#: UI/GTK2/src/mainWindow.cc:2115
 msgid "Index name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2185
+#: UI/GTK2/src/mainWindow.cc:2130
 msgid "Couldn't add index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2199
+#: UI/GTK2/src/mainWindow.cc:2144
 msgid "Added new index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2234
+#: UI/GTK2/src/mainWindow.cc:2179
 msgid "Couldn't remove index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2469
-msgid "At least one background task hasn't been completed yet. Quit now ?"
+#: UI/GTK2/src/mainWindow.cc:2413
+msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2680
+#: UI/GTK2/src/mainWindow.cc:2605
 msgid "Query name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2707
+#: UI/GTK2/src/mainWindow.cc:2632
 msgid "Couldn't update query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2715
+#: UI/GTK2/src/mainWindow.cc:2640
 msgid "Edited query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2722
+#: UI/GTK2/src/mainWindow.cc:2647
 msgid "Couldn't add query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2730
+#: UI/GTK2/src/mainWindow.cc:2655
 msgid "Added new query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2744
+#: UI/GTK2/src/mainWindow.cc:2669
 msgid "Query is not set"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2755
+#: UI/GTK2/src/mainWindow.cc:2680
 msgid "No search engine selected"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2837
+#: UI/GTK2/src/mainWindow.cc:2762
 msgid "Please set the Google API key first"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2846
+#: UI/GTK2/src/mainWindow.cc:2771
 msgid "Running query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2951
+#: UI/GTK2/src/mainWindow.cc:2876
 msgid "is already indexed or is being indexed"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2978
+#: UI/GTK2/src/mainWindow.cc:2903
 msgid "No URL to browse"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2989
+#: UI/GTK2/src/mainWindow.cc:2914
 msgid "No browser configured to view results"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:3001
+#: UI/GTK2/src/mainWindow.cc:2926
 msgid "Couldn't browse URL:"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:3230
-msgid "task(s) running"
-msgstr ""
-
 #: UI/GTK2/src/mainWindow_glade.cc:115
 msgid "Query:"
 msgstr ""
@@ -564,43 +565,35 @@
 msgid "Unclassified"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:62
+#: UI/GTK2/src/prefsDialog.cc:70
 msgid "Name"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:70
+#: UI/GTK2/src/prefsDialog.cc:78
 msgid "Location"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:71
-msgid "MIME Type"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:107
+#: UI/GTK2/src/prefsDialog.cc:115
 msgid "In internal viewer"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:110
+#: UI/GTK2/src/prefsDialog.cc:118
 msgid "In browser"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:352
+#: UI/GTK2/src/prefsDialog.cc:333
 msgid "Browser location"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:363
+#: UI/GTK2/src/prefsDialog.cc:344
 msgid "New Label"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:385
+#: UI/GTK2/src/prefsDialog.cc:366
 msgid "Colour"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:451
-msgid "Import Mail Box(es)"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:469
+#: UI/GTK2/src/prefsDialog.cc:437 UI/GTK2/src/prefsDialog.cc:471
 msgid "Mbox File Location"
 msgstr ""
 
@@ -652,7 +645,7 @@
 msgid "Preferences"
 msgstr ""
 
-#: UI/GTK2/src/propertiesDialog.cc:45
+#: UI/GTK2/src/propertiesDialog.cc:51
 msgid "Unknown"
 msgstr ""
 
@@ -664,7 +657,7 @@
 msgid "Language:"
 msgstr ""
 
-#: UI/GTK2/src/queryDialog.cc:87 UI/GTK2/src/queryDialog.cc:116
+#: UI/GTK2/src/queryDialog.cc:96 UI/GTK2/src/queryDialog.cc:125
 msgid "Any"
 msgstr ""
 
@@ -720,101 +713,109 @@
 msgid "Query properties"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:162
+#: UI/GTK2/src/WorkerThreads.cpp:350
 msgid "Stopped browsing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:196 UI/GTK2/src/WorkerThreads.cpp:440
-#: UI/GTK2/src/WorkerThreads.cpp:488 UI/GTK2/src/WorkerThreads.cpp:498
-#: UI/GTK2/src/WorkerThreads.cpp:722 UI/GTK2/src/WorkerThreads.cpp:927
-#: UI/GTK2/src/WorkerThreads.cpp:1058
+#: UI/GTK2/src/WorkerThreads.cpp:384 UI/GTK2/src/WorkerThreads.cpp:620
+#: UI/GTK2/src/WorkerThreads.cpp:665 UI/GTK2/src/WorkerThreads.cpp:675
+#: UI/GTK2/src/WorkerThreads.cpp:893 UI/GTK2/src/WorkerThreads.cpp:1095
+#: UI/GTK2/src/WorkerThreads.cpp:1223
 msgid "Index error on"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:307
+#: UI/GTK2/src/WorkerThreads.cpp:490
 msgid "Stopped querying"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:319
+#: UI/GTK2/src/WorkerThreads.cpp:502
 msgid "Couldn't create search engine"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:331
+#: UI/GTK2/src/WorkerThreads.cpp:514
 msgid "Couldn't run query on search engine"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:412 UI/GTK2/src/WorkerThreads.cpp:479
+#: UI/GTK2/src/WorkerThreads.cpp:592 UI/GTK2/src/WorkerThreads.cpp:656
 msgid "Stopped querying index labels"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:572
+#: UI/GTK2/src/WorkerThreads.cpp:746
 msgid "Stopped retrieval of"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:608
+#: UI/GTK2/src/WorkerThreads.cpp:782
 msgid "Couldn't obtain downloader for protocol"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:622 UI/GTK2/src/WorkerThreads.cpp:736
+#: UI/GTK2/src/WorkerThreads.cpp:796 UI/GTK2/src/WorkerThreads.cpp:907
 msgid "Couldn't retrieve"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:707
+#: UI/GTK2/src/WorkerThreads.cpp:878
 msgid "Stopped indexing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:761
+#: UI/GTK2/src/WorkerThreads.cpp:932
 msgid "Cannot index document type"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:765
+#: UI/GTK2/src/WorkerThreads.cpp:936
 msgid "at"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:790
+#: UI/GTK2/src/WorkerThreads.cpp:961
 msgid "Couln't tokenize"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:811
+#: UI/GTK2/src/WorkerThreads.cpp:982
 msgid "Robots META tag forbids indexing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:847
+#: UI/GTK2/src/WorkerThreads.cpp:1018
 msgid "Couldn't index"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:915
+#: UI/GTK2/src/WorkerThreads.cpp:1083
 msgid "Stopped unindexing document(s)"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:935
+#: UI/GTK2/src/WorkerThreads.cpp:1103
 msgid "Couldn't unindex document(s)"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1030
+#: UI/GTK2/src/WorkerThreads.cpp:1195
 msgid "Stopped document update for "
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1067
+#: UI/GTK2/src/WorkerThreads.cpp:1232
 msgid "Couldn't update document"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1107
+#: UI/GTK2/src/WorkerThreads.cpp:1280
 msgid "Stopped listening on"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1205
+#: UI/GTK2/src/WorkerThreads.cpp:1380
 msgid "Couldn't read FIFO at"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1245
+#: UI/GTK2/src/WorkerThreads.cpp:1428
 msgid "Stopped monitoring"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1263
+#: UI/GTK2/src/WorkerThreads.cpp:1446
 msgid "No monitoring handler"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1297
+#: UI/GTK2/src/WorkerThreads.cpp:1480
 msgid "Couldn't open FAM connection"
 msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:1683
+msgid "Stopped scanning"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:1823
+msgid "Couldn't open directory"
+msgstr ""

Modified: trunk/po/fr_FR.po
===================================================================
--- trunk/po/fr_FR.po	2006-01-10 15:58:56 UTC (rev 55)
+++ trunk/po/fr_FR.po	2006-01-10 16:01:00 UTC (rev 56)
@@ -24,70 +24,79 @@
 msgid "Current User"
 msgstr "Utilisateur"
 
-#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:381
-#: UI/GTK2/src/mainWindow.cc:384 UI/GTK2/src/mainWindow.cc:557
-#: UI/GTK2/src/mainWindow.cc:1111 UI/GTK2/src/mainWindow.cc:1213
-#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:865
-#: UI/GTK2/src/PinotSettings.cpp:921
+#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:344
+#: UI/GTK2/src/mainWindow.cc:347 UI/GTK2/src/mainWindow.cc:520
+#: UI/GTK2/src/mainWindow.cc:1048 UI/GTK2/src/mainWindow.cc:1150
+#: UI/GTK2/src/mainWindow.cc:1763 UI/GTK2/src/PinotSettings.cpp:199
+#: UI/GTK2/src/PinotSettings.cpp:865 UI/GTK2/src/PinotSettings.cpp:921
 msgid "My Documents"
 msgstr "Mes Documents"
 
-#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:387
-#: UI/GTK2/src/mainWindow.cc:390 UI/GTK2/src/mainWindow.cc:561
+#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:350
+#: UI/GTK2/src/mainWindow.cc:353 UI/GTK2/src/mainWindow.cc:524
 #: UI/GTK2/src/MonitorHandler.cpp:174 UI/GTK2/src/PinotSettings.cpp:200
 #: UI/GTK2/src/PinotSettings.cpp:866 UI/GTK2/src/PinotSettings.cpp:922
 #: UI/GTK2/src/prefsDialog_glade.cc:116
 msgid "My Email"
 msgstr "Mon Courrier"
 
-#: UI/GTK2/src/importDialog.cc:91
-msgid "Single file"
+#: UI/GTK2/src/importDialog.cc:104
+msgid "Enabled"
 msgstr "Un fichier"
 
-#: UI/GTK2/src/importDialog.cc:94
-msgid "Whole directory"
+#: UI/GTK2/src/importDialog.cc:105 UI/GTK2/src/prefsDialog.cc:79
+msgid "MIME Type"
 msgstr "Un repertoire"
 
-#: UI/GTK2/src/importDialog.cc:99 UI/GTK2/src/IndexTree.cpp:71
-#: UI/GTK2/src/ResultsTree.cpp:114
-msgid "URL"
+#: UI/GTK2/src/importDialog.cc:130
+msgid "File"
 msgstr "URL"
 
-#: UI/GTK2/src/importDialog.cc:265
-msgid "Document To Import"
+#: UI/GTK2/src/importDialog.cc:133
+msgid "Directory"
 msgstr "Document A Importer"
 
-#: UI/GTK2/src/importDialog_glade.cc:61 UI/GTK2/src/mainWindow_glade.cc:201
-msgid "Import"
+#: UI/GTK2/src/importDialog.cc:138 UI/GTK2/src/IndexTree.cpp:71
+#: UI/GTK2/src/ResultsTree.cpp:114
+msgid "URL"
 msgstr "Importer"
 
-#: UI/GTK2/src/importDialog_glade.cc:65
-msgid "Select"
+#: UI/GTK2/src/importDialog.cc:417
+msgid "Document To Import"
 msgstr "Selectionner"
 
-#: UI/GTK2/src/importDialog_glade.cc:74 UI/GTK2/src/indexDialog_glade.cc:68
+#: UI/GTK2/src/importDialog_glade.cc:66 UI/GTK2/src/indexDialog_glade.cc:68
 msgid "Location:"
 msgstr "Location:"
 
-#: UI/GTK2/src/importDialog_glade.cc:75
+#: UI/GTK2/src/importDialog_glade.cc:67
 #: UI/GTK2/src/propertiesDialog_glade.cc:64
 msgid "Title:"
 msgstr "Titre:"
 
-#: UI/GTK2/src/importDialog_glade.cc:76
-msgid "Maximum depth:"
-msgstr "Profondeur maximum:"
-
-#: UI/GTK2/src/importDialog_glade.cc:82 UI/GTK2/src/indexDialog_glade.cc:67
+#: UI/GTK2/src/importDialog_glade.cc:70 UI/GTK2/src/indexDialog_glade.cc:67
 #: UI/GTK2/src/propertiesDialog_glade.cc:68
 msgid "Type:"
 msgstr "Type:"
 
-#: UI/GTK2/src/importDialog_glade.cc:162
+#: UI/GTK2/src/importDialog_glade.cc:72 UI/GTK2/src/indexDialog_glade.cc:64
+#: UI/GTK2/src/prefsDialog_glade.cc:70
+msgid "..."
+msgstr "..."
+
+#: UI/GTK2/src/importDialog_glade.cc:75
+msgid "Depth:"
+msgstr "Profondeur:"
+
+#: UI/GTK2/src/importDialog_glade.cc:86 UI/GTK2/src/mainWindow_glade.cc:201
+msgid "Import"
+msgstr "Importer"
+
+#: UI/GTK2/src/importDialog_glade.cc:186
 msgid "Import document"
 msgstr "Importation de document"
 
-#: UI/GTK2/src/indexDialog.cc:202
+#: UI/GTK2/src/indexDialog.cc:211
 msgid "Index location"
 msgstr "Location de l'index"
 
@@ -95,10 +104,6 @@
 msgid "Name:"
 msgstr "Nom:"
 
-#: UI/GTK2/src/indexDialog_glade.cc:64 UI/GTK2/src/prefsDialog_glade.cc:70
-msgid "..."
-msgstr "..."
-
 #: UI/GTK2/src/indexDialog_glade.cc:69
 msgid "Port:"
 msgstr "Port:"
@@ -115,7 +120,7 @@
 msgid "Timestamp"
 msgstr "Date"
 
-#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:347
+#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:530
 msgid "No title"
 msgstr "Pas de titre"
 
@@ -128,244 +133,240 @@
 msgstr "Suivants"
 
 #: UI/GTK2/src/IndexPage.cpp:159 UI/GTK2/src/IndexPage.cpp:205
-#: UI/GTK2/src/queryDialog.cc:82
+#: UI/GTK2/src/queryDialog.cc:91
 msgid "None"
 msgstr "Aucune"
 
-#: UI/GTK2/src/mainWindow.cc:179
+#: UI/GTK2/src/mainWindow.cc:148
 msgid "Query Name"
 msgstr "Nom de la Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:153
 msgid "Last Run"
 msgstr "Derniere Utilisation"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:154
 msgid "Summary"
 msgstr "Sommaire"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Add index"
 msgstr "Ajouter un index"
 
-#: UI/GTK2/src/mainWindow.cc:243
+#: UI/GTK2/src/mainWindow.cc:212
 msgid "Remove index"
 msgstr "Enlever un index"
 
-#: UI/GTK2/src/mainWindow.cc:267
+#: UI/GTK2/src/mainWindow.cc:235
 msgid "Ready"
 msgstr "Pret"
 
-#: UI/GTK2/src/mainWindow.cc:286 UI/GTK2/src/mainWindow.cc:1075
-#: UI/GTK2/src/mainWindow.cc:1437 UI/GTK2/src/mainWindow.cc:3020
+#: UI/GTK2/src/mainWindow.cc:249 UI/GTK2/src/mainWindow.cc:1012
+#: UI/GTK2/src/mainWindow.cc:1360 UI/GTK2/src/mainWindow.cc:2945
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr "Voir"
 
-#: UI/GTK2/src/mainWindow.cc:318
+#: UI/GTK2/src/mainWindow.cc:281
 msgid "N/A"
 msgstr "Inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:328
+#: UI/GTK2/src/mainWindow.cc:291
 msgid "<undefined>"
 msgstr "<inconnu>"
 
-#: UI/GTK2/src/mainWindow.cc:519
+#: UI/GTK2/src/mainWindow.cc:482
 msgid "Result location is"
 msgstr "La location du resultat est"
 
-#: UI/GTK2/src/mainWindow.cc:572
+#: UI/GTK2/src/mainWindow.cc:535
 msgid "Document location is"
 msgstr "La location du document is"
 
-#: UI/GTK2/src/mainWindow.cc:681
+#: UI/GTK2/src/mainWindow.cc:644
 msgid "No label"
 msgstr "Pas d'etiquette"
 
-#: UI/GTK2/src/mainWindow.cc:856
+#: UI/GTK2/src/mainWindow.cc:793
 msgid "Showing"
 msgstr "Listant"
 
-#: UI/GTK2/src/mainWindow.cc:861
+#: UI/GTK2/src/mainWindow.cc:798
 msgid "off"
 msgstr "de"
 
-#: UI/GTK2/src/mainWindow.cc:866
+#: UI/GTK2/src/mainWindow.cc:803
 msgid "documents, starting at"
 msgstr "documents venant de"
 
-#: UI/GTK2/src/mainWindow.cc:900
+#: UI/GTK2/src/mainWindow.cc:837
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:904 UI/GTK2/src/mainWindow.cc:2850
+#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2775
 msgid "on"
 msgstr "sur"
 
-#: UI/GTK2/src/mainWindow.cc:908
+#: UI/GTK2/src/mainWindow.cc:845
 msgid "ended"
 msgstr "est terminee"
 
-#: UI/GTK2/src/mainWindow.cc:1009 UI/GTK2/src/propertiesDialog.cc:34
+#: UI/GTK2/src/mainWindow.cc:946 UI/GTK2/src/propertiesDialog.cc:40
 msgid "Label"
 msgstr "L'etiquette"
 
-#: UI/GTK2/src/mainWindow.cc:1013
+#: UI/GTK2/src/mainWindow.cc:950
 msgid "matches"
 msgstr "correspond a"
 
-#: UI/GTK2/src/mainWindow.cc:1018
+#: UI/GTK2/src/mainWindow.cc:955
 msgid "document(s)"
 msgstr "document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1050
+#: UI/GTK2/src/mainWindow.cc:987
 msgid "Updated label(s)"
 msgstr "Mis a jour l(es) etiquette(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1121 UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1058 UI/GTK2/src/mainWindow.cc:1161
 msgid "Updated document"
 msgstr "Mis a jour le document"
 
-#: UI/GTK2/src/mainWindow.cc:1134
+#: UI/GTK2/src/mainWindow.cc:1071
 msgid "Indexed"
 msgstr "Indexe"
 
-#: UI/GTK2/src/mainWindow.cc:1195
+#: UI/GTK2/src/mainWindow.cc:1132
 msgid "Unindexed document(s)"
 msgstr "Desindexe le(s) document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1275
+#: UI/GTK2/src/mainWindow.cc:1212
 msgid "Couldn't rename index, name"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1279 UI/GTK2/src/mainWindow.cc:2174
-#: UI/GTK2/src/mainWindow.cc:2684
+#: UI/GTK2/src/mainWindow.cc:1216 UI/GTK2/src/mainWindow.cc:2119
+#: UI/GTK2/src/mainWindow.cc:2609
 msgid "is already in use"
 msgstr "est deja utilise"
 
-#: UI/GTK2/src/mainWindow.cc:1292
+#: UI/GTK2/src/mainWindow.cc:1229
 msgid "Couldn't rename index"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1305
+#: UI/GTK2/src/mainWindow.cc:1242
 msgid "Edited index"
 msgstr "Edite l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1779 UI/GTK2/src/mainWindow.cc:1860
+#: UI/GTK2/src/mainWindow.cc:1702 UI/GTK2/src/mainWindow.cc:1805
 msgid "Please set a location for the index first"
 msgstr "Donnez une location a l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1806
+#: UI/GTK2/src/mainWindow.cc:1729
 msgid "Result location is unknown"
 msgstr "La location du resultat est inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:1822
+#: UI/GTK2/src/mainWindow.cc:1753
 msgid "Import Document(s)"
 msgstr "Importation de Document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1938 UI/GTK2/src/pinot.cc:148
-#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:183
-#: UI/GTK2/src/WorkerThreads.cpp:428 UI/GTK2/src/WorkerThreads.cpp:1045
+#: UI/GTK2/src/mainWindow.cc:1883 UI/GTK2/src/pinot.cc:148
+#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:371
+#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1210
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/WorkerThreads.cpp:187
-#: UI/GTK2/src/WorkerThreads.cpp:432 UI/GTK2/src/WorkerThreads.cpp:1049
+#: UI/GTK2/src/mainWindow.cc:1887 UI/GTK2/src/WorkerThreads.cpp:375
+#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1214
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
-#: UI/GTK2/src/mainWindow.cc:2054
+#: UI/GTK2/src/mainWindow.cc:1999
 msgid "Delete this document from the index ?"
 msgstr "Enlever ce document de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2073
+#: UI/GTK2/src/mainWindow.cc:2018
 msgid "Delete these documents from the index ?"
 msgstr "Enlever ces documents de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2125
+#: UI/GTK2/src/mainWindow.cc:2070
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Un outil de recherche pour le Bureau Libre"
 
-#: UI/GTK2/src/mainWindow.cc:2126
+#: UI/GTK2/src/mainWindow.cc:2071
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2170
+#: UI/GTK2/src/mainWindow.cc:2115
 msgid "Index name"
 msgstr "Nom de l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2185
+#: UI/GTK2/src/mainWindow.cc:2130
 msgid "Couldn't add index"
 msgstr "N'a pas pu ajouter l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2199
+#: UI/GTK2/src/mainWindow.cc:2144
 msgid "Added new index"
 msgstr "Ajouter un nouvel index"
 
-#: UI/GTK2/src/mainWindow.cc:2234
+#: UI/GTK2/src/mainWindow.cc:2179
 msgid "Couldn't remove index"
 msgstr "N'a pas pu enlever l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2469
-msgid "At least one background task hasn't been completed yet. Quit now ?"
+#: UI/GTK2/src/mainWindow.cc:2413
+msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2680
+#: UI/GTK2/src/mainWindow.cc:2605
 msgid "Query name"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2707
+#: UI/GTK2/src/mainWindow.cc:2632
 msgid "Couldn't update query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2715
+#: UI/GTK2/src/mainWindow.cc:2640
 msgid "Edited query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2722
+#: UI/GTK2/src/mainWindow.cc:2647
 msgid "Couldn't add query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2730
+#: UI/GTK2/src/mainWindow.cc:2655
 msgid "Added new query"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2744
+#: UI/GTK2/src/mainWindow.cc:2669
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2755
+#: UI/GTK2/src/mainWindow.cc:2680
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:2837
+#: UI/GTK2/src/mainWindow.cc:2762
 msgid "Please set the Google API key first"
 msgstr "Configurez la clef de l'API Google "
 
-#: UI/GTK2/src/mainWindow.cc:2846
+#: UI/GTK2/src/mainWindow.cc:2771
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:2951
+#: UI/GTK2/src/mainWindow.cc:2876
 msgid "is already indexed or is being indexed"
 msgstr "est deja indexe ou est en cours d'indexation"
 
-#: UI/GTK2/src/mainWindow.cc:2978
+#: UI/GTK2/src/mainWindow.cc:2903
 msgid "No URL to browse"
 msgstr "Pas d'URL a brouter"
 
-#: UI/GTK2/src/mainWindow.cc:2989
+#: UI/GTK2/src/mainWindow.cc:2914
 msgid "No browser configured to view results"
 msgstr "Pas de brouter configure"
 
-#: UI/GTK2/src/mainWindow.cc:3001
+#: UI/GTK2/src/mainWindow.cc:2926
 msgid "Couldn't browse URL:"
 msgstr "N'a pas pu brouter l'URL"
 
-#: UI/GTK2/src/mainWindow.cc:3230
-msgid "task(s) running"
-msgstr "tache(s)"
-
 #: UI/GTK2/src/mainWindow_glade.cc:115
 msgid "Query:"
 msgstr "Recherche:"
@@ -564,43 +565,35 @@
 msgid "Unclassified"
 msgstr "Non classifie"
 
-#: UI/GTK2/src/prefsDialog.cc:62
+#: UI/GTK2/src/prefsDialog.cc:70
 msgid "Name"
 msgstr "Nom"
 
-#: UI/GTK2/src/prefsDialog.cc:70
+#: UI/GTK2/src/prefsDialog.cc:78
 msgid "Location"
 msgstr "Location"
 
-#: UI/GTK2/src/prefsDialog.cc:71
-msgid "MIME Type"
-msgstr "Type MIME"
-
-#: UI/GTK2/src/prefsDialog.cc:107
+#: UI/GTK2/src/prefsDialog.cc:115
 msgid "In internal viewer"
 msgstr "Dans le brouteur interne"
 
-#: UI/GTK2/src/prefsDialog.cc:110
+#: UI/GTK2/src/prefsDialog.cc:118
 msgid "In browser"
 msgstr "Dans le brouteur"
 
-#: UI/GTK2/src/prefsDialog.cc:352
+#: UI/GTK2/src/prefsDialog.cc:333
 msgid "Browser location"
 msgstr "Brouter la location"
 
-#: UI/GTK2/src/prefsDialog.cc:363
+#: UI/GTK2/src/prefsDialog.cc:344
 msgid "New Label"
 msgstr "Nouvelle Etiquette"
 
-#: UI/GTK2/src/prefsDialog.cc:385
+#: UI/GTK2/src/prefsDialog.cc:366
 msgid "Colour"
 msgstr "Couleur"
 
-#: UI/GTK2/src/prefsDialog.cc:451
-msgid "Import Mail Box(es)"
-msgstr "Impoter des Boites de Courrier"
-
-#: UI/GTK2/src/prefsDialog.cc:469
+#: UI/GTK2/src/prefsDialog.cc:437 UI/GTK2/src/prefsDialog.cc:471
 msgid "Mbox File Location"
 msgstr "Location du Fichier mbox"
 
@@ -652,7 +645,7 @@
 msgid "Preferences"
 msgstr "Preferences"
 
-#: UI/GTK2/src/propertiesDialog.cc:45
+#: UI/GTK2/src/propertiesDialog.cc:51
 msgid "Unknown"
 msgstr "Inconnu"
 
@@ -664,7 +657,7 @@
 msgid "Language:"
 msgstr "Langue:"
 
-#: UI/GTK2/src/queryDialog.cc:87 UI/GTK2/src/queryDialog.cc:116
+#: UI/GTK2/src/queryDialog.cc:96 UI/GTK2/src/queryDialog.cc:125
 msgid "Any"
 msgstr "N'importe"
 
@@ -720,101 +713,109 @@
 msgid "Query properties"
 msgstr "Proprietes de la recherche"
 
-#: UI/GTK2/src/WorkerThreads.cpp:162
+#: UI/GTK2/src/WorkerThreads.cpp:350
 msgid "Stopped browsing"
 msgstr "Arrete le brouteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:196 UI/GTK2/src/WorkerThreads.cpp:440
-#: UI/GTK2/src/WorkerThreads.cpp:488 UI/GTK2/src/WorkerThreads.cpp:498
-#: UI/GTK2/src/WorkerThreads.cpp:722 UI/GTK2/src/WorkerThreads.cpp:927
-#: UI/GTK2/src/WorkerThreads.cpp:1058
+#: UI/GTK2/src/WorkerThreads.cpp:384 UI/GTK2/src/WorkerThreads.cpp:620
+#: UI/GTK2/src/WorkerThreads.cpp:665 UI/GTK2/src/WorkerThreads.cpp:675
+#: UI/GTK2/src/WorkerThreads.cpp:893 UI/GTK2/src/WorkerThreads.cpp:1095
+#: UI/GTK2/src/WorkerThreads.cpp:1223
 msgid "Index error on"
 msgstr "Erreur d'index sur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:307
+#: UI/GTK2/src/WorkerThreads.cpp:490
 msgid "Stopped querying"
 msgstr "Arrete la recherche"
 
-#: UI/GTK2/src/WorkerThreads.cpp:319
+#: UI/GTK2/src/WorkerThreads.cpp:502
 msgid "Couldn't create search engine"
 msgstr "N'a pas pu creer le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:331
+#: UI/GTK2/src/WorkerThreads.cpp:514
 msgid "Couldn't run query on search engine"
 msgstr "N'a pas pu lancer la recherche sur le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:412 UI/GTK2/src/WorkerThreads.cpp:479
+#: UI/GTK2/src/WorkerThreads.cpp:592 UI/GTK2/src/WorkerThreads.cpp:656
 msgid "Stopped querying index labels"
 msgstr "Arrete la recherche d'etiquettes"
 
-#: UI/GTK2/src/WorkerThreads.cpp:572
+#: UI/GTK2/src/WorkerThreads.cpp:746
 msgid "Stopped retrieval of"
 msgstr "Arrete le telechargement de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:608
+#: UI/GTK2/src/WorkerThreads.cpp:782
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N'a pas pu obtenir un brouteur pour ="
 
-#: UI/GTK2/src/WorkerThreads.cpp:622 UI/GTK2/src/WorkerThreads.cpp:736
+#: UI/GTK2/src/WorkerThreads.cpp:796 UI/GTK2/src/WorkerThreads.cpp:907
 msgid "Couldn't retrieve"
 msgstr "N'a pas pu telecharger"
 
-#: UI/GTK2/src/WorkerThreads.cpp:707
+#: UI/GTK2/src/WorkerThreads.cpp:878
 msgid "Stopped indexing"
 msgstr "Arrete l'indexation"
 
-#: UI/GTK2/src/WorkerThreads.cpp:761
+#: UI/GTK2/src/WorkerThreads.cpp:932
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer de type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:765
+#: UI/GTK2/src/WorkerThreads.cpp:936
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:790
+#: UI/GTK2/src/WorkerThreads.cpp:961
 msgid "Couln't tokenize"
 msgstr "N'a pas pu tokenise"
 
-#: UI/GTK2/src/WorkerThreads.cpp:811
+#: UI/GTK2/src/WorkerThreads.cpp:982
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots empeche d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:847
+#: UI/GTK2/src/WorkerThreads.cpp:1018
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:915
+#: UI/GTK2/src/WorkerThreads.cpp:1083
 msgid "Stopped unindexing document(s)"
 msgstr "Arrete d'indexer les document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:935
+#: UI/GTK2/src/WorkerThreads.cpp:1103
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1030
+#: UI/GTK2/src/WorkerThreads.cpp:1195
 msgid "Stopped document update for "
 msgstr "Arrete la mise a jour pour "
 
-#: UI/GTK2/src/WorkerThreads.cpp:1067
+#: UI/GTK2/src/WorkerThreads.cpp:1232
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1107
+#: UI/GTK2/src/WorkerThreads.cpp:1280
 msgid "Stopped listening on"
 msgstr "Arrete l'ecoute sur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1205
+#: UI/GTK2/src/WorkerThreads.cpp:1380
 msgid "Couldn't read FIFO at"
 msgstr "N'a pas pu lire la FIFO a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1245
+#: UI/GTK2/src/WorkerThreads.cpp:1428
 msgid "Stopped monitoring"
 msgstr "Arrete la surveillance"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1263
+#: UI/GTK2/src/WorkerThreads.cpp:1446
 msgid "No monitoring handler"
 msgstr "Pas de moniteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1297
+#: UI/GTK2/src/WorkerThreads.cpp:1480
 msgid "Couldn't open FAM connection"
 msgstr "N'a pas pu ouvrir la connection FAM"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1683
+msgid "Stopped scanning"
+msgstr "Arrete de scanner"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1823
+msgid "Couldn't open directory"
+msgstr "N'a pas pu ovrir le repertoire"



From fabricecolin at berlios.de  Wed Jan 11 14:26:23 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 11 Jan 2006 14:26:23 +0100
Subject: [Pinot-svn] r57 - in trunk: Index UI/GTK2/src Utils
Message-ID: <200601111326.k0BDQN3N023126@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-11 14:26:19 +0100 (Wed, 11 Jan 2006)
New Revision: 57

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/Index/indextest.cpp
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/Utils/MIMEScanner.cpp
Log:
Fixed XapianIndex::hasDocument() and the importing of URLs.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-01-10 16:01:00 UTC (rev 56)
+++ trunk/Index/XapianIndex.cpp	2006-01-11 13:26:19 UTC (rev 57)
@@ -147,7 +147,7 @@
 	Url urlObj(location);
 
 	// Index the full URL with prefix U
-	doc.add_term(limitTermLength(string("U") + location));
+	doc.add_term(limitTermLength(string("U") + StringManip::toLowerCase(location)));
 	// ...the host name with prefix H
 	string hostName = urlObj.getHost();
 	doc.add_term(limitTermLength(string("H") + StringManip::toLowerCase(hostName)));
@@ -738,26 +738,29 @@
 		Xapian::Database *pIndex = pDatabase->readLock();
 		if (pIndex != NULL)
 		{
-			string term("U");
+			string term(string("U") + StringManip::toLowerCase(url));
 
 			// Get documents that have this term
-			term += url;
 			Xapian::PostingIterator postingIter = pIndex->postlist_begin(term);
 			if (postingIter != pIndex->postlist_end(term))
 			{
 				// This URL was indexed
 				docId = *postingIter;
+#ifdef DEBUG
+				cout << "XapianIndex::hasDocument: " << term << " in document "
+					<< docId << " " << postingIter.get_wdf() << " time(s)" << endl;
+#endif
 			}
-			// FIXME: what if the term exist in more than one document ?
+			// FIXME: what if the term exists in more than one document ?
 		}
 	}
 	catch (const Xapian::Error &error)
 	{
-		cerr << "Couldn't delete label: " << error.get_msg() << endl;
+		cerr << "Couldn't look for document: " << error.get_msg() << endl;
 	}
 	catch (...)
 	{
-		cerr << "Couldn't delete label, unknown exception occured" << endl;
+		cerr << "Couldn't look for document, unknown exception occured" << endl;
 	}
 	pDatabase->unlock();
 

Modified: trunk/Index/indextest.cpp
===================================================================
--- trunk/Index/indextest.cpp	2006-01-10 16:01:00 UTC (rev 56)
+++ trunk/Index/indextest.cpp	2006-01-11 13:26:19 UTC (rev 57)
@@ -33,90 +33,94 @@
 
 int main(int argc, char **argv)
 {
-	if (argc < 4)
+	bool success = false;
+
+	if (argc < 3)
 	{
-		cerr << "Usage: " << argv[0] << " <index type> <database name> <file name>|CHECK|CREATE" << endl;
+		cerr << "Usage: " << argv[0] << " <index type> <database name> CHECK|CREATE|HASURL=<url>|INDEX=<file name>" << endl;
 		return EXIT_FAILURE;
 	}
 
 	// Check database ?
 	if (strncasecmp(argv[3], "CHECK", 5) == 0)
 	{
-		if (XapianDatabaseFactory::getDatabase(argv[2], true) != NULL)
+		XapianIndex index(argv[2]);
+
+		if (index.isGood() == true)
 		{
-			XapianIndex index(argv[2]);
 			cout << "Index has " << index.getDocumentsCount() << " document(s)" << endl;
-
-			return EXIT_SUCCESS;
+			success = true;
 		}
-
-		return EXIT_FAILURE;
 	}
 	// Create database ?
 	else if (strncasecmp(argv[3], "CREATE", 6) == 0)
 	{
 		if (XapianDatabaseFactory::getDatabase(argv[2], false) != NULL)
 		{
-			return EXIT_SUCCESS;
+			success = true;
 		}
-
-		return EXIT_FAILURE;
 	}
+	// Look for an URL ?
+	else if (strncasecmp(argv[3], "HASURL", 6) == 0)
+	{
+		XapianIndex index(argv[2]);
 
-	struct stat fileStat;
-	if ((stat(argv[3], &fileStat) == 0) &&
-		(S_ISREG(fileStat.st_mode)))
-	{
-		char *buffer = new char[fileStat.st_size + 1];
-		int fd = open(argv[3], O_RDONLY);
-		// Read the file
-		ssize_t readBytes = read(fd, buffer, fileStat.st_size);
-		if (readBytes == -1)
+		if ((index.isGood() == true) &&
+			(index.hasDocument(argv[3] + 7) > 0))
 		{
-			cerr << "Couldn't read " << argv[3] << " !" << endl;
-			return EXIT_FAILURE;
+			success = true;
 		}
+	}
+	// Index a file ?
+	else if (strncasecmp(argv[3], "INDEX", 5) == 0)
+	{
+		struct stat fileStat;
+		string fileName(argv[3] + 6);
 
-		// Assume file is HTML...
-		Document doc(argv[3], argv[3], "text/html", "");
-		doc.setData(buffer, readBytes);
-		if (doc.isBinary() == true)
+		if ((stat(fileName.c_str(), &fileStat) == 0) &&
+			(S_ISREG(fileStat.st_mode)))
 		{
-			cerr << argv[3] << " is binary !" << endl;
-		}
-		else
-		{
-			set<string> labels;
-			unsigned int docId = 0;
-
-			Tokenizer *pTokens = TokenizerFactory::getTokenizer(argv[3], &doc);
-			if (pTokens == NULL)
+			char *buffer = new char[fileStat.st_size + 1];
+			int fd = open(fileName.c_str(), O_RDONLY);
+			// Read the file
+			ssize_t readBytes = read(fd, buffer, fileStat.st_size);
+			if (readBytes > 0)
 			{
-				cerr << "Couldn't obtain tokenizer for " << argv[3] << " !" << endl;
-				return EXIT_FAILURE;
-			}
+				// Assume file is HTML...
+				Document doc(fileName, fileName, "text/html", "");
+				doc.setData(buffer, readBytes);
+				if (doc.isBinary() == false)
+				{
+					set<string> labels;
+					unsigned int docId = 0;
 
-			// Ignore index type, use a XapianIndex
-			XapianIndex index(argv[2]);
-			index.setStemmingMode(IndexInterface::STORE_BOTH);
-			if (index.indexDocument(*pTokens, labels, docId) == false)
-			{
-				cerr << "Couldn't index " << argv[3] << " !" << endl;
+					Tokenizer *pTokens = TokenizerFactory::getTokenizer(fileName, &doc);
+					if (pTokens != NULL)
+					{
+						// Ignore index type, use a XapianIndex
+						XapianIndex index(argv[2]);
+						index.setStemmingMode(IndexInterface::STORE_BOTH);
+						if (index.indexDocument(*pTokens, labels, docId) == true)
+						{
+							cout << "Added " << fileName << " to index, document" << docId << endl;
+							success = true;
+						}
+
+						delete pTokens;
+					}
+				}
+
+				delete[] buffer;
 			}
-			else
-			{
-				cout << "Added " << argv[3] << " to index, document" << docId << endl;
-			}
-
-			delete pTokens;
 		}
+	}
 
-		delete[] buffer;
-	}
-	else
+	XapianDatabaseFactory::closeAll();
+
+	if (success == true)
 	{
-		cerr << "Couldn't stat " << argv[3] << " !" << endl;
+		return EXIT_SUCCESS;
 	}
 
-	return EXIT_SUCCESS;
+	return EXIT_FAILURE;
 }

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-10 16:01:00 UTC (rev 56)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-11 13:26:19 UTC (rev 57)
@@ -1702,8 +1702,10 @@
 	if ((m_pMutex != NULL) &&
 		(m_pCondVar != NULL))
 	{
+		string url(string("file://") + fileName);
+
 		m_pMutex->lock();
-		if (m_signalFileFound(fileName) == true)
+		if (m_signalFileFound(url) == true)
 		{
 			// Another file is needed right now
 			m_pMutex->unlock();

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-10 16:01:00 UTC (rev 56)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-11 13:26:19 UTC (rev 57)
@@ -188,18 +188,22 @@
 	return true;
 }
 
-bool importDialog::on_import_file(const string &fileName)
+bool importDialog::on_import_url(const string &location)
 {
-	string mimeType = MIMEScanner::scanFile(fileName);
+	Url urlObj(location);
+	string mimeType(MIMEScanner::scanUrl(location));
 	bool askForAnotherFile = false;
 
+#ifdef DEBUG
+	cout << "importDialog::on_import_url: file type is " << mimeType << endl;
+#endif
 	// Check the MIME type
 	if ((m_mimeTypesBlackList.find(mimeType) != m_mimeTypesBlackList.end()) ||
 		((m_mimeTypes.find(mimeType) == m_mimeTypes.end()) &&
 		(strncasecmp(mimeType.c_str(), "text", 4) != 0)))
 	{
 #ifdef DEBUG
-		cout << "importDialog::on_import_file: filtering out type " << mimeType << endl;
+		cout << "importDialog::on_import_url: filtering out" << endl;
 #endif
 		// It's black-listed, or not authorized and not text
 		askForAnotherFile = true;
@@ -208,26 +212,23 @@
 	{
 		XapianIndex index(PinotSettings::getInstance().m_indexLocation);
 		IndexingThread *pThread = NULL;
-		string url("file://" + fileName);
 		string title = locale_from_utf8(m_title);
 		unsigned int docId = 0;
 
 		if (index.isGood() == true)
 		{
-			docId = index.hasDocument(url);
+			docId = index.hasDocument(location);
 		}
 
 		if (m_importDirectory == true)
 		{
-			Url urlObj(url);
-
 			if (title.empty() == false)
 			{
 				title += " ";
 			}
 			title += urlObj.getFile();
 		}
-		DocumentInfo docInfo(title, url, mimeType, "");
+		DocumentInfo docInfo(title, location, mimeType, "");
 
 		if (docId > 0)
 		{
@@ -312,10 +313,17 @@
 
 	if (m_state.m_importing == false)
 	{
+		double fractionFilled = 1.0;
+
 		m_timeoutConnection.block();
 		m_timeoutConnection.disconnect();
 
-		importProgressbar->set_fraction(1.0);
+		if (success == false)
+		{
+			// FIXME: there are better ways to show what happened :-)
+			fractionFilled = 0.0;
+		}
+		importProgressbar->set_fraction(fractionFilled);
 		importButton->set_sensitive(true);
 	}
 }
@@ -492,12 +500,20 @@
 		// Scan the directory and import all its files
 		m_pScannerThread = new DirectoryScannerThread(location,
 			maxDirLevel, &m_state.m_scanMutex, &m_state.m_scanCondVar);
-		m_pScannerThread->getFileFoundSignal().connect(SigC::slot(*this, &importDialog::on_import_file));
+		m_pScannerThread->getFileFoundSignal().connect(SigC::slot(*this, &importDialog::on_import_url));
 		start_thread(m_pScannerThread);
 	}
 	else
 	{
-		on_import_file(location);
+		if (on_import_url(location) == true)
+		{
+			// It's asking for another file, so this one couldn't be indexed
+			m_timeoutConnection.block();
+			m_timeoutConnection.disconnect();
+
+			importProgressbar->set_fraction(0.0);
+			importButton->set_sensitive(true);
+		}
 	}
 #ifdef DEBUG
 	cout << "importDialog::on_importButton_clicked: done" << endl;

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2006-01-10 16:01:00 UTC (rev 56)
+++ trunk/UI/GTK2/src/importDialog.hh	2006-01-11 13:26:19 UTC (rev 57)
@@ -50,7 +50,7 @@
 	void signal_scanner(void);
 
 	bool on_activity_timeout(void);
-	bool on_import_file(const std::string &fileName);
+	bool on_import_url(const std::string &location);
 	void on_thread_end(void);
 
 private:

Modified: trunk/Utils/MIMEScanner.cpp
===================================================================
--- trunk/Utils/MIMEScanner.cpp	2006-01-10 16:01:00 UTC (rev 56)
+++ trunk/Utils/MIMEScanner.cpp	2006-01-11 13:26:19 UTC (rev 57)
@@ -26,7 +26,7 @@
 {
 }
 
-string MIMEScanner::scanFileType(const std::string &fileName)
+string MIMEScanner::scanFileType(const string &fileName)
 {
 	string::size_type fileExtPos = fileName.find_last_of(".");
 	if (fileExtPos != string::npos)
@@ -108,9 +108,17 @@
 /// Finds out the given URL's MIME type.
 string MIMEScanner::scanUrl(const Url &urlObj)
 {
-	string fileName = urlObj.getFile();
+	// Is it a local file ?
+	if (urlObj.getProtocol() == "file")
+	{
+		string fileName = urlObj.getLocation();
+		fileName += "/";
+		fileName += urlObj.getFile();
 
-	string mimeType = scanFileType(fileName);
+		return scanFile(fileName);
+	}
+
+	string mimeType = scanFileType(urlObj.getFile());
 	if (mimeType.empty() == true)
 	{
 		mimeType = "text/plain";



From fabricecolin at berlios.de  Fri Jan 13 17:36:17 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 13 Jan 2006 17:36:17 +0100
Subject: [Pinot-svn] r58 - in trunk: Collect Index UI/GTK2 UI/GTK2/src Utils
Message-ID: <200601131636.k0DGaHjt031612@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-13 17:36:15 +0100 (Fri, 13 Jan 2006)
New Revision: 58

Modified:
   trunk/Collect/DownloaderInterface.cpp
   trunk/Collect/NeonDownloader.cpp
   trunk/Index/LanguageDetector.cpp
   trunk/Index/LanguageDetector.h
   trunk/Index/Summarizer.cpp
   trunk/Index/XapianIndex.cpp
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/IndexPage.cpp
   trunk/UI/GTK2/src/IndexTree.cpp
   trunk/UI/GTK2/src/MonitorHandler.cpp
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog_glade.cc
   trunk/UI/GTK2/src/importDialog_glade.hh
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/prefsDialog.cc
   trunk/Utils/HtmlDocument.cpp
   trunk/Utils/Url.cpp
   trunk/Utils/Url.h
Log:
Mutexes for safe multi-threading with OpenSSL are type ERRORCHECK. Limit the
amount of text parsed by language guessing and summarization. Use canonical
URLs to "key" documents. The importer can follow symlinks. Several other
tweaks and fixes.


Modified: trunk/Collect/DownloaderInterface.cpp
===================================================================
--- trunk/Collect/DownloaderInterface.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/Collect/DownloaderInterface.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -19,9 +19,9 @@
 
 using namespace std;
 
-DownloaderInterface::DownloaderInterface()
+DownloaderInterface::DownloaderInterface() :
+	m_timeout(60)
 {
-	m_timeout = 15000;
 }
 
 DownloaderInterface::~DownloaderInterface()

Modified: trunk/Collect/NeonDownloader.cpp
===================================================================
--- trunk/Collect/NeonDownloader.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/Collect/NeonDownloader.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -73,16 +73,27 @@
 // OpenSSL locking functiom
 static void lockingCallback(int mode, int n, const char *file, int line)
 {
+	int status = 0;
+
+	if (mode & CRYPTO_LOCK)
+	{
+		status = pthread_mutex_lock(&(locksTable[n]));
 #ifdef DEBUG
-	cout << "lockingCallback: called for mutex " << n << endl;
+		if (status != 0)
+		{
+			cout << "lockingCallback: failed to lock mutex " << n << endl;
+		}
 #endif
-	if (mode & CRYPTO_LOCK)
-	{
-		pthread_mutex_lock(&(locksTable[n]));
 	}
 	else
 	{
-		pthread_mutex_unlock(&(locksTable[n]));
+		status = pthread_mutex_unlock(&(locksTable[n]));
+#ifdef DEBUG
+		if (status != 0)
+		{
+			cout << "lockingCallback: failed to unlock mutex " << n << endl;
+		}
+#endif
 	}
 }
 
@@ -96,10 +107,15 @@
 void NeonDownloader::initialize(void)
 {
 #ifdef NE_SSL_H
+	pthread_mutexattr_t mutexAttr;
+
+	pthread_mutexattr_init(&mutexAttr);
+	pthread_mutexattr_settype(&mutexAttr, PTHREAD_MUTEX_ERRORCHECK);
+
 	// Initialize the OpenSSL mutexes
 	for (unsigned int lockNum = 0; lockNum < CRYPTO_NUM_LOCKS; ++lockNum)
 	{
-		pthread_mutex_init(&(locksTable[lockNum]), NULL);
+		pthread_mutex_init(&(locksTable[lockNum]), &mutexAttr);
 	}
 	// Set the callbacks
 	CRYPTO_set_locking_callback(lockingCallback);
@@ -123,7 +139,9 @@
 }
 
 NeonDownloader::NeonDownloader() :
-	m_pSession(NULL), m_pRequest(NULL), DownloaderInterface()
+	DownloaderInterface(),
+	m_pSession(NULL),
+	m_pRequest(NULL)
 {
 	// Pretend to be Mozilla
 	m_userAgent = "Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.3) Gecko/20041020";

Modified: trunk/Index/LanguageDetector.cpp
===================================================================
--- trunk/Index/LanguageDetector.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/Index/LanguageDetector.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -16,6 +16,7 @@
 
 #include <sys/time.h>
 #include <iostream>
+#include <utility>
 
 extern "C"
 {
@@ -31,7 +32,10 @@
 using std::endl;
 using std::string;
 using std::vector;
+using std::min;
 
+unsigned int LanguageDetector::m_maxTextSize = 10000;
+
 LanguageDetector::LanguageDetector()
 {
 }
@@ -64,9 +68,11 @@
 #ifdef DEBUG
 	Timer timer;
 	timer.start();
+	cout << "LanguageDetector::guessLanguage: starting" << endl;
 #endif
 #ifdef HAVE_TEXTCAT_CAT
-	unsigned int resultNum = textcat_Cat(td, pData, dataLength, catResults, 10);
+	unsigned int resultNum = textcat_Cat(td, pData,
+		min(dataLength, m_maxTextSize), catResults, 10);
 	if (resultNum == 0 )
 	{
 		candidates.push_back("unknown");
@@ -90,7 +96,8 @@
 		}
 	}
 #else
-	const char *languages = textcat_Classify(td, pData, dataLength);
+	const char *languages = textcat_Classify(td, pData,
+		min(dataLength, m_maxTextSize));
 	if (languages == NULL)
 	{
 		candidates.push_back("unknown");

Modified: trunk/Index/LanguageDetector.h
===================================================================
--- trunk/Index/LanguageDetector.h	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/Index/LanguageDetector.h	2006-01-13 16:36:15 UTC (rev 58)
@@ -33,6 +33,9 @@
 		void guessLanguage(const char *pData, unsigned int dataLength,
 			std::vector<std::string> &candidates);
 
+	protected:
+		static unsigned int m_maxTextSize;
+
 	private:
 		LanguageDetector(const LanguageDetector &other);
 		LanguageDetector &operator=(const LanguageDetector &other);

Modified: trunk/Index/Summarizer.cpp
===================================================================
--- trunk/Index/Summarizer.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/Index/Summarizer.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -34,7 +34,7 @@
 using std::map;
 using std::min;
 
-unsigned int Summarizer::m_maxTextSize = 500000;
+unsigned int Summarizer::m_maxTextSize = 50000;
 
 Summarizer::Summarizer(const std::string &language, unsigned int wordsCount) :
 	m_wordsCount(wordsCount),
@@ -59,6 +59,9 @@
 /// Attempts to summarize the document in wordsCount words.
 string Summarizer::summarize(const char *pText, unsigned int textLen)
 {
+	unsigned char *pSummary = NULL;
+	size_t outputLen = 0;
+
 	if ((pText == NULL) ||
 		(textLen == 0))
 	{
@@ -67,56 +70,45 @@
 
 	m_title.clear();
 
-	// OTS may take too much time with long documents
-	if (textLen < m_maxTextSize)
-	{
-		unsigned char *pSummary = NULL;
-		size_t outputLen = 0;
 #ifdef DEBUG
-		Timer timer;
-		timer.start();
+	Timer timer;
+	timer.start();
+	cout << "Summarizer::summarize: starting" << endl;
 #endif
+	// Create a new article
+	OtsArticle *pArticle = ots_new_article();
+	if ((pArticle != NULL) &&
+		(ots_load_xml_dictionary(pArticle, m_dictionaryCode.c_str())))
+	{
+		// OTS may take too much time with long documents
+		ots_parse_stream((const unsigned char*)pText,
+			min(textLen, m_maxTextSize), pArticle);
 
-		// Create a new article
-		OtsArticle *pArticle = ots_new_article();
-		if ((pArticle != NULL) &&
-			(ots_load_xml_dictionary(pArticle, m_dictionaryCode.c_str())))
-		{
-			ots_parse_stream((const unsigned char*)pText, textLen, pArticle);
+		ots_grade_doc(pArticle);
+		ots_highlight_doc_words(pArticle, m_wordsCount);
 
-			ots_grade_doc(pArticle);
-			ots_highlight_doc_words(pArticle, m_wordsCount);
-
-			// Summarize
-			pSummary = ots_get_doc_text(pArticle, &outputLen);
+		// Summarize
+		pSummary = ots_get_doc_text(pArticle, &outputLen);
 #ifdef DEBUG
-			cout << "Summarizer::summarize: summarized to " << outputLen << " bytes in "
-				<< timer.stop()/1000 << " ms" << endl;
+		cout << "Summarizer::summarize: summarized to " << outputLen << " bytes in "
+			<< timer.stop()/1000 << " ms" << endl;
 #endif
 
-			// Get the title before freeing the article
-			if (pArticle->title != NULL)
-			{
-				m_title = pArticle->title;
-			}
-			ots_free_article(pArticle);
-		}
-
-		if (pSummary != NULL)
+		// Get the title before freeing the article
+		if (pArticle->title != NULL)
 		{
-			string sum((const char *)pSummary, outputLen);
-
-			free(pSummary);
-
-			return sum;
+			m_title = pArticle->title;
 		}
+		ots_free_article(pArticle);
 	}
-	else
+
+	if (pSummary != NULL)
 	{
-		unsigned int arbitraryLen = min(5 * m_wordsCount, m_maxTextSize / 1000);
+		string sum((const char *)pSummary, outputLen);
 
-		// This is totally arbitray
-		return string(pText, arbitraryLen);
+		free(pSummary);
+
+		return sum;
 	}
 
 	return "";

Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/Index/XapianIndex.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -147,7 +147,7 @@
 	Url urlObj(location);
 
 	// Index the full URL with prefix U
-	doc.add_term(limitTermLength(string("U") + StringManip::toLowerCase(location)));
+	doc.add_term(limitTermLength(string("U") + Url::canonicalizeUrl(location)));
 	// ...the host name with prefix H
 	string hostName = urlObj.getHost();
 	doc.add_term(limitTermLength(string("H") + StringManip::toLowerCase(hostName)));
@@ -738,7 +738,7 @@
 		Xapian::Database *pIndex = pDatabase->readLock();
 		if (pIndex != NULL)
 		{
-			string term(string("U") + StringManip::toLowerCase(url));
+			string term(string("U") + Url::canonicalizeUrl(url));
 
 			// Get documents that have this term
 			Xapian::PostingIterator postingIter = pIndex->postlist_begin(term);

Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-01-13 16:36:15 UTC (rev 58)
@@ -3354,7 +3354,7 @@
 	    <widget class="GtkTable" id="docTable">
 	      <property agent="glademm" name="cxx_visibility">protected</property>
 	      <property name="visible">True</property>
-	      <property name="n_rows">4</property>
+	      <property name="n_rows">5</property>
 	      <property name="n_columns">2</property>
 	      <property name="homogeneous">False</property>
 	      <property name="row_spacing">0</property>
@@ -3548,9 +3548,32 @@
 	      </child>
 
 	      <child>
-		<widget class="GtkLabel" id="depthLabel">
+		<widget class="GtkSpinButton" id="depthSpinbutton">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="climb_rate">1</property>
+		  <property name="digits">0</property>
+		  <property name="numeric">False</property>
+		  <property name="update_policy">GTK_UPDATE_ALWAYS</property>
+		  <property name="snap_to_ticks">False</property>
+		  <property name="wrap">False</property>
+		  <property name="adjustment">0 0 100 1 5 5</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">3</property>
+		  <property name="bottom_attach">4</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="depthLabel">
+		  <property name="visible">True</property>
 		  <property name="label" translatable="yes">Depth:</property>
 		  <property name="use_underline">False</property>
 		  <property name="use_markup">False</property>
@@ -3572,28 +3595,56 @@
 		  <property name="top_attach">3</property>
 		  <property name="bottom_attach">4</property>
 		  <property name="x_options">fill</property>
-		  <property name="y_options"></property>
+		  <property name="y_options">fill</property>
 		</packing>
 	      </child>
 
 	      <child>
-		<widget class="GtkSpinButton" id="depthSpinbutton">
+		<widget class="GtkLabel" id="linksLabel">
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Symlinks:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">4</property>
+		  <property name="bottom_attach">5</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkCheckButton" id="linksCheckbutton">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
 		  <property name="can_focus">True</property>
-		  <property name="climb_rate">1</property>
-		  <property name="digits">0</property>
-		  <property name="numeric">False</property>
-		  <property name="update_policy">GTK_UPDATE_ALWAYS</property>
-		  <property name="snap_to_ticks">False</property>
-		  <property name="wrap">False</property>
-		  <property name="adjustment">0 0 100 1 5 5</property>
+		  <property name="label" translatable="yes">Follow symlinks</property>
+		  <property name="use_underline">True</property>
+		  <property name="relief">GTK_RELIEF_NORMAL</property>
+		  <property name="focus_on_click">True</property>
+		  <property name="active">False</property>
+		  <property name="inconsistent">False</property>
+		  <property name="draw_indicator">True</property>
 		</widget>
 		<packing>
 		  <property name="left_attach">1</property>
 		  <property name="right_attach">2</property>
-		  <property name="top_attach">3</property>
-		  <property name="bottom_attach">4</property>
+		  <property name="top_attach">4</property>
+		  <property name="bottom_attach">5</property>
 		  <property name="x_padding">4</property>
 		  <property name="y_padding">4</property>
 		  <property name="y_options">fill</property>

Modified: trunk/UI/GTK2/src/IndexPage.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexPage.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/IndexPage.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -21,7 +21,6 @@
 #include <gtkmm/textbuffer.h>
 
 #include "HtmlTokenizer.h"
-#include "Url.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
 #include "config.h"

Modified: trunk/UI/GTK2/src/IndexTree.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexTree.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/IndexTree.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -19,7 +19,6 @@
 #include <gtkmm/textbuffer.h>
 
 #include "HtmlTokenizer.h"
-#include "Url.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
 #include "config.h"
@@ -207,12 +206,8 @@
 	TreeModel::Row childRow = *newRowIter;
 	string title = docInfo.getTitle();
 
-	if (title.empty() == true)
+	if (title.length() > 50)
 	{
-		title = _("No title");
-	}
-	else if (title.length() > 50)
-	{
 		string truncatedTitle = title.substr(0, 47);
 		truncatedTitle += "...";
 		title = truncatedTitle;

Modified: trunk/UI/GTK2/src/MonitorHandler.cpp
===================================================================
--- trunk/UI/GTK2/src/MonitorHandler.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/MonitorHandler.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -27,7 +27,6 @@
 #include "Timer.h"
 #include "TimeConverter.h"
 #include "TokenizerFactory.h"
-#include "Url.h"
 #include "FileCollector.h"
 #include "XapianIndex.h"
 #include "XapianEngine.h"

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -910,7 +910,6 @@
 	}
 	else
 	{
-		Url urlObj(m_url);
 		unsigned int urlContentLen;
 		string docType = m_pDoc->getType();
 		const char *urlContent = m_pDoc->getData(urlContentLen);
@@ -1488,6 +1487,10 @@
 				string fsLocation = fsIter->second;
 				struct stat fileStat;
 
+				if (m_done == true)
+				{
+					break;
+				}
 				if (stat(fsLocation.c_str(), &fileStat) == -1)
 				{
 					continue;
@@ -1653,14 +1656,21 @@
 }
 
 DirectoryScannerThread::DirectoryScannerThread(const string &dirName,
-			unsigned int maxLevel, Mutex *pMutex, Cond *pCondVar) :
+	unsigned int maxLevel, bool followSymLinks, Mutex *pMutex, Cond *pCondVar) :
 	WorkerThread(),
 	m_dirName(dirName),
 	m_maxLevel(maxLevel),
+	m_followSymLinks(followSymLinks),
 	m_pMutex(pMutex),
 	m_pCondVar(pCondVar),
 	m_currentLevel(0)
 {
+#ifdef DEBUG
+	if (m_followSymLinks == true)
+	{
+		cout << "DirectoryScannerThread: following symlinks" << endl;
+	}
+#endif
 }
 
 DirectoryScannerThread::~DirectoryScannerThread()
@@ -1728,16 +1738,32 @@
 bool DirectoryScannerThread::scan_directory(const string &dirName)
 {
 	struct stat fileStat;
+	int statSuccess = 0;
 
-	if ((dirName.empty() == true) ||
-		(lstat(dirName.c_str(), &fileStat) == -1))
+	if (dirName.empty() == true)
 	{
 		return false;
 	}
 
+	if (m_followSymLinks == false)
+	{
+		statSuccess = lstat(dirName.c_str(), &fileStat);
+	}
+	else
+	{
+		// Stat the files pointed to by symlinks
+		statSuccess = stat(dirName.c_str(), &fileStat);
+	}
+
+	if (statSuccess == -1)
+	{
+		return false;
+	}
+
 	// Is it a file or a directory ?
 	if (S_ISLNK(fileStat.st_mode))
 	{
+		// This won't happen when m_followSymLinks is true
 		return false;
 	}
 	else if (S_ISREG(fileStat.st_mode))

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-01-13 16:36:15 UTC (rev 58)
@@ -434,8 +434,8 @@
 {
 	public:
 		DirectoryScannerThread(const std::string &dirName,
-			unsigned int maxLevel, Glib::Mutex *pMutex,
-			Glib::Cond *pCondVar);
+			unsigned int maxLevel, bool followSymLinks,
+			Glib::Mutex *pMutex, Glib::Cond *pCondVar);
 		virtual ~DirectoryScannerThread();
 
 		virtual Glib::Thread *start(void);
@@ -449,6 +449,7 @@
 	protected:
 		std::string m_dirName;
 		unsigned int m_maxLevel;
+		bool m_followSymLinks;
 		Glib::Mutex *m_pMutex;
 		Glib::Cond *m_pCondVar;
 		unsigned int m_currentLevel;

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-13 16:36:15 UTC (rev 58)
@@ -191,7 +191,7 @@
 bool importDialog::on_import_url(const string &location)
 {
 	Url urlObj(location);
-	string mimeType(MIMEScanner::scanUrl(location));
+	string mimeType(MIMEScanner::scanUrl(urlObj));
 	bool askForAnotherFile = false;
 
 #ifdef DEBUG
@@ -200,12 +200,13 @@
 	// Check the MIME type
 	if ((m_mimeTypesBlackList.find(mimeType) != m_mimeTypesBlackList.end()) ||
 		((m_mimeTypes.find(mimeType) == m_mimeTypes.end()) &&
-		(strncasecmp(mimeType.c_str(), "text", 4) != 0)))
+		((strncasecmp(mimeType.c_str(), "text/x-", 7) == 0) ||
+		(strncasecmp(mimeType.c_str(), "text", 4) != 0))))
 	{
 #ifdef DEBUG
 		cout << "importDialog::on_import_url: filtering out" << endl;
 #endif
-		// It's black-listed, or not authorized and not text
+		// It's black-listed, or not authorized and not plain-ish text
 		askForAnotherFile = true;
 	}
 	else
@@ -486,6 +487,9 @@
 		<< " types, " << m_mimeTypesBlackList.size() << " in blacklist" << endl;
 #endif
 
+	m_timeoutConnection = Glib::signal_timeout().connect(SigC::slot(*this,
+		&importDialog::on_activity_timeout), 1000);
+
 	// Title
 	m_title = titleEntry->get_text();
 	// Type
@@ -494,12 +498,10 @@
 		// Maximum depth
 		unsigned int maxDirLevel = (unsigned int)depthSpinbutton->get_value();
 
-		m_timeoutConnection = Glib::signal_timeout().connect(SigC::slot(*this,
-			&importDialog::on_activity_timeout), 1000);
-
 		// Scan the directory and import all its files
 		m_pScannerThread = new DirectoryScannerThread(location,
-			maxDirLevel, &m_state.m_scanMutex, &m_state.m_scanCondVar);
+			maxDirLevel, linksCheckbutton->get_active(),
+			&m_state.m_scanMutex, &m_state.m_scanCondVar);
 		m_pScannerThread->getFileFoundSignal().connect(SigC::slot(*this, &importDialog::on_import_url));
 		start_thread(m_pScannerThread);
 	}

Modified: trunk/UI/GTK2/src/importDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-13 16:36:15 UTC (rev 58)
@@ -1,4 +1,4 @@
-// generated 2006/1/10 13:41:10 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/1/13 22:05:22 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -72,10 +72,12 @@
    locationButton = Gtk::manage(new class Gtk::Button(_("...")));
    
    Gtk::HBox *locationHbox = Gtk::manage(new class Gtk::HBox(false, 4));
-   depthLabel = Gtk::manage(new class Gtk::Label(_("Depth:")));
-   
    Gtk::Adjustment *depthSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(0, 0, 100, 1, 5, 5));
    depthSpinbutton = Gtk::manage(new class Gtk::SpinButton(*depthSpinbutton_adj, 1, 0));
+   
+   Gtk::Label *depthLabel = Gtk::manage(new class Gtk::Label(_("Depth:")));
+   Gtk::Label *linksLabel = Gtk::manage(new class Gtk::Label(_("Symlinks:")));
+   linksCheckbutton = Gtk::manage(new class Gtk::CheckButton(_("Follow symlinks")));
    docTable = Gtk::manage(new class Gtk::Table(2, 2, false));
    mimeTreeview = Gtk::manage(new class Gtk::TreeView());
    
@@ -129,17 +131,27 @@
    locationButton->set_relief(Gtk::RELIEF_NORMAL);
    locationHbox->pack_start(*locationEntry);
    locationHbox->pack_start(*locationButton, Gtk::PACK_SHRINK, 0);
+   depthSpinbutton->set_flags(Gtk::CAN_FOCUS);
+   depthSpinbutton->set_update_policy(Gtk::UPDATE_ALWAYS);
+   depthSpinbutton->set_numeric(false);
+   depthSpinbutton->set_digits(0);
+   depthSpinbutton->set_wrap(false);
    depthLabel->set_alignment(0,0.5);
    depthLabel->set_padding(4,4);
    depthLabel->set_justify(Gtk::JUSTIFY_LEFT);
    depthLabel->set_line_wrap(false);
    depthLabel->set_use_markup(false);
    depthLabel->set_selectable(false);
-   depthSpinbutton->set_flags(Gtk::CAN_FOCUS);
-   depthSpinbutton->set_update_policy(Gtk::UPDATE_ALWAYS);
-   depthSpinbutton->set_numeric(false);
-   depthSpinbutton->set_digits(0);
-   depthSpinbutton->set_wrap(false);
+   linksLabel->set_alignment(0,0.5);
+   linksLabel->set_padding(4,4);
+   linksLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   linksLabel->set_line_wrap(false);
+   linksLabel->set_use_markup(false);
+   linksLabel->set_selectable(false);
+   linksCheckbutton->set_flags(Gtk::CAN_FOCUS);
+   linksCheckbutton->set_relief(Gtk::RELIEF_NORMAL);
+   linksCheckbutton->set_mode(true);
+   linksCheckbutton->set_active(false);
    docTable->set_row_spacings(0);
    docTable->set_col_spacings(0);
    docTable->attach(*titleEntry, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
@@ -148,8 +160,10 @@
    docTable->attach(*typeCombobox, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable->attach(*typeLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 0, 0);
    docTable->attach(*locationHbox, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL, 4, 4);
-   docTable->attach(*depthLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::AttachOptions(), 0, 0);
    docTable->attach(*depthSpinbutton, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   docTable->attach(*depthLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 0, 0);
+   docTable->attach(*linksLabel, 0, 1, 4, 5, Gtk::FILL, Gtk::FILL, 0, 0);
+   docTable->attach(*linksCheckbutton, 1, 2, 4, 5, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    mimeTreeview->set_flags(Gtk::CAN_FOCUS);
    mimeTreeview->set_headers_visible(true);
    mimeTreeview->set_rules_hint(false);
@@ -199,8 +213,10 @@
    locationEntry->show();
    locationButton->show();
    locationHbox->show();
+   depthSpinbutton->show();
    depthLabel->show();
-   depthSpinbutton->show();
+   linksLabel->show();
+   linksCheckbutton->show();
    docTable->show();
    mimeTreeview->show();
    mimeScrolledwindow->show();

Modified: trunk/UI/GTK2/src/importDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-13 16:36:15 UTC (rev 58)
@@ -1,4 +1,4 @@
-// generated 2006/1/10 13:34:08 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/1/13 22:05:22 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -37,6 +37,7 @@
 #include <gtkmm/combobox.h>
 #include <gtkmm/button.h>
 #include <gtkmm/spinbutton.h>
+#include <gtkmm/checkbutton.h>
 #include <gtkmm/table.h>
 #include <gtkmm/treeview.h>
 #include <gtkmm/progressbar.h>
@@ -51,8 +52,8 @@
         class Gtk::ComboBox * typeCombobox;
         class Gtk::Entry * locationEntry;
         class Gtk::Button * locationButton;
-        class Gtk::Label * depthLabel;
         class Gtk::SpinButton * depthSpinbutton;
+        class Gtk::CheckButton * linksCheckbutton;
         class Gtk::Table * docTable;
         class Gtk::TreeView * mimeTreeview;
         class Gtk::ProgressBar * importProgressbar;

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-13 16:36:15 UTC (rev 58)
@@ -1906,11 +1906,13 @@
 		vector<IndexedDocument>::const_iterator docIter = documentsList.begin();
 
 		// Get the document ID
-		Url urlObj(docIter->getLocation());
-		docId = (unsigned int)atoi(urlObj.getFile().c_str());
+		docId = docIter->getID();
 
 		if (index.isGood() == true)
 		{
+			// Get the properties from the index because they have been altered
+			// by the tree for display purposes
+			index.getDocumentInfo(docId, docInfo);
 			index.getDocumentLabels(docId, docLabels);
 
 			// Does it match the current label ?
@@ -1920,10 +1922,6 @@
 				matchedLabel = true;
 			}
 		}
-
-		docInfo = DocumentInfo(docIter->getTitle(), docIter->getOriginalLocation(),
-			docIter->getType(), docIter->getLanguage());
-		docInfo.setTimestamp(docIter->getTimestamp());
 		editTitle = true;
 	}
 	// Else, start with a blank list

Modified: trunk/UI/GTK2/src/prefsDialog.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog.cc	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/UI/GTK2/src/prefsDialog.cc	2006-01-13 16:36:15 UTC (rev 58)
@@ -25,7 +25,6 @@
 #include "MIMEScanner.h"
 #include "SearchEngineFactory.h"
 #include "QueryHistory.h"
-#include "Url.h"
 #include "config.h"
 #include "NLS.h"
 #include "PinotUtils.h"

Modified: trunk/Utils/HtmlDocument.cpp
===================================================================
--- trunk/Utils/HtmlDocument.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/Utils/HtmlDocument.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -61,7 +61,7 @@
 		int titleMatches = 3, httpEquivMatches = 3;
 
 		// Look for a title
-		if (regcomp(&titleRegex, "<title([^>]*)>(.*)</title", REG_EXTENDED|REG_ICASE) == 0)
+		if (regcomp(&titleRegex, "<title([^>]*)>([^<>]*)</title", REG_EXTENDED|REG_ICASE) == 0)
 		{
 			if ((regexec(&titleRegex, htmlHead.c_str(), titleMatches,
 					pTitleMatches, REG_NOTBOL|REG_NOTEOL) == 0) &&

Modified: trunk/Utils/Url.cpp
===================================================================
--- trunk/Utils/Url.cpp	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/Utils/Url.cpp	2006-01-13 16:36:15 UTC (rev 58)
@@ -16,8 +16,11 @@
 
 #include <neon/ne_uri.h>
 
+#include "StringManip.h"
 #include "Url.h"
 
+using std::string;
+
 Url::Url(const string &url)
 {
 	parse(url);
@@ -38,19 +41,6 @@
 {
 }
 
-Url& Url::operator=(const Url& other)
-{
-	m_protocol = other.m_protocol;
-	m_user = other.m_user;
-	m_password = other.m_password;
-	m_host = other.m_host;
-	m_location = other.m_location;
-	m_file = other.m_file;
-	m_parameters = other.m_parameters;
-
-	return *this;
-}
-
 void Url::parse(const string &url)
 {
 	string::size_type pos1 =0, pos2 = 0;
@@ -70,8 +60,7 @@
 		m_protocol = url.substr(0, pos1);
 		pos1 += 3;
 
-		if ((m_protocol == "file") ||
-			(m_protocol == "mailbox"))
+		if (isLocal(m_protocol) == true)
 		{
 			hasHostName = false;
 		}
@@ -170,41 +159,18 @@
 	}
 }
 
-string Url::getProtocol(void) const
+bool Url::isLocal(const string &protocol) const
 {
-	return m_protocol;
-}
+	if ((protocol == "file") ||
+		(protocol == "mailbox") ||
+		(protocol == "xapian"))
+	{
+		return true;
+	}
 
-string Url::getUser(void) const
-{
-	return m_user;
+	return false;
 }
 
-string Url::getPassword(void) const
-{
-	return m_password;
-}
-
-string Url::getHost(void) const
-{
-	return m_host;
-}
-
-string Url::getLocation(void) const
-{
-	return m_location;
-}
-
-string Url::getFile(void) const
-{
-	return m_file;
-}
-
-string Url::getParameters(void) const
-{
-	return m_parameters;
-}
-
 /// Canonicalizes an URL.
 string Url::canonicalizeUrl(const string &url)
 {
@@ -214,18 +180,25 @@
 	}
 
 	Url urlObj(url);
+	string canonicalUrl(url);
 	string location = urlObj.getLocation();
 	string file = urlObj.getFile();
 
+	if (urlObj.isLocal() == false)
+	{
+		// Lower-case it all
+		canonicalUrl = StringManip::toLowerCase(url);
+	}
+
 	// Get rid of the last directory's slash
 	if ((file.empty() == true) &&
 		(location.empty() == false) &&
-		(url[url.length() - 1] == '/'))
+		(canonicalUrl[canonicalUrl.length() - 1] == '/'))
 	{
-		return url.substr(0, url.length() - 1);
+		return canonicalUrl.substr(0, url.length() - 1);
 	}
 
-	return url;
+	return canonicalUrl;
 }
 
 /// Truncates an URL to the given length by discarding characters in the middle.
@@ -328,3 +301,56 @@
 
 	return unescapedUrlStr;
 }
+
+string Url::getProtocol(void) const
+{
+	return m_protocol;
+}
+
+string Url::getUser(void) const
+{
+	return m_user;
+}
+
+string Url::getPassword(void) const
+{
+	return m_password;
+}
+
+string Url::getHost(void) const
+{
+	return m_host;
+}
+
+string Url::getLocation(void) const
+{
+	return m_location;
+}
+
+string Url::getFile(void) const
+{
+	return m_file;
+}
+
+string Url::getParameters(void) const
+{
+	return m_parameters;
+}
+
+bool Url::isLocal(void) const
+{
+	return isLocal(m_protocol);
+}
+
+Url& Url::operator=(const Url& other)
+{
+	m_protocol = other.m_protocol;
+	m_user = other.m_user;
+	m_password = other.m_password;
+	m_host = other.m_host;
+	m_location = other.m_location;
+	m_file = other.m_file;
+	m_parameters = other.m_parameters;
+
+	return *this;
+}

Modified: trunk/Utils/Url.h
===================================================================
--- trunk/Utils/Url.h	2006-01-11 13:26:19 UTC (rev 57)
+++ trunk/Utils/Url.h	2006-01-13 16:36:15 UTC (rev 58)
@@ -19,48 +19,49 @@
 
 #include <string>
 
-using std::string;
-
 class Url
 {
 	public:
-		Url(const string &url);
+		Url(const std::string &url);
 		Url(const Url &other);
 		virtual ~Url();
 
-		Url& operator=(const Url& other);
-
-		string getProtocol(void) const;
-		string getUser(void) const;
-		string getPassword(void) const;
-		string getHost(void) const;
-		string getLocation(void) const;
-		string getFile(void) const;
-		string getParameters(void) const;
-
 		/// Canonicalizes an URL.
-		static string canonicalizeUrl(const string &url);
+		static std::string canonicalizeUrl(const std::string &url);
 
 		/// Truncates an URL to the given length by discarding characters in the middle.
-		static string prettifyUrl(const string &url, unsigned int maxLen);
+		static std::string prettifyUrl(const std::string &url, unsigned int maxLen);
 
 		/// Escapes an URL.
-		static string escapeUrl(const string &url);
+		static std::string escapeUrl(const std::string &url);
 
 		/// Unescapes an URL.
-		static string unescapeUrl(const string &escapedUrl);
+		static std::string unescapeUrl(const std::string &escapedUrl);
 
+		std::string getProtocol(void) const;
+		std::string getUser(void) const;
+		std::string getPassword(void) const;
+		std::string getHost(void) const;
+		std::string getLocation(void) const;
+		std::string getFile(void) const;
+		std::string getParameters(void) const;
+		bool isLocal(void) const ;
+
+		Url& operator=(const Url& other);
+
 	protected:
-		string m_protocol;
-		string m_user;
-		string m_password;
-		string m_host;
-		string m_location;
-		string m_file;
-		string m_parameters;
+		std::string m_protocol;
+		std::string m_user;
+		std::string m_password;
+		std::string m_host;
+		std::string m_location;
+		std::string m_file;
+		std::string m_parameters;
 
-		void parse(const string &url);
+		void parse(const std::string &url);
 
+		bool isLocal(const std::string &protocol) const;
+
 };
 
 #endif // _URL_H



From fabricecolin at berlios.de  Sat Jan 14 07:46:16 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 14 Jan 2006 07:46:16 +0100
Subject: [Pinot-svn] r59 - in trunk: Collect Index UI/GTK2/src
Message-ID: <200601140646.k0E6kG36001168@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-14 07:45:15 +0100 (Sat, 14 Jan 2006)
New Revision: 59

Modified:
   trunk/Collect/NeonDownloader.cpp
   trunk/Collect/NeonDownloader.h
   trunk/Collect/dloadtest.cpp
   trunk/Index/Summarizer.cpp
   trunk/Index/Summarizer.h
   trunk/Index/XapianIndex.cpp
   trunk/Index/XapianIndex.h
   trunk/UI/GTK2/src/IndexTree.cpp
   trunk/UI/GTK2/src/IndexTree.h
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Minor fix and change to NeonDownloader initialization. Capped length of
summary and added sanity checks on extract and title, which means that they
may be modified before being saved when updating a document's properties.


Modified: trunk/Collect/NeonDownloader.cpp
===================================================================
--- trunk/Collect/NeonDownloader.cpp	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/Collect/NeonDownloader.cpp	2006-01-14 06:45:15 UTC (rev 59)
@@ -64,8 +64,6 @@
 	}
 }
 
-bool NeonDownloader::m_initialized = false;
-
 #ifdef NE_SSL_H
 // OpenSSL multi-thread support, required by Neon
 static pthread_mutex_t locksTable[CRYPTO_NUM_LOCKS];
@@ -120,7 +118,10 @@
 	// Set the callbacks
 	CRYPTO_set_locking_callback(lockingCallback);
 	CRYPTO_set_id_callback(idCallback);
+
+	pthread_mutexattr_destroy(&mutexAttr);
 #endif	// NE_SSL_H
+	ne_sock_init();
 }
 
 /// Shutdown the downloader.
@@ -136,6 +137,7 @@
 		pthread_mutex_destroy(&(locksTable[lockNum]));
 	}
 #endif	// NE_SSL_H
+	ne_sock_exit();
 }
 
 NeonDownloader::NeonDownloader() :
@@ -145,11 +147,6 @@
 {
 	// Pretend to be Mozilla
 	m_userAgent = "Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.3) Gecko/20041020";
-	if (m_initialized == false)
-	{
-		ne_sock_init();
-		m_initialized = true;
-	}
 }
 
 NeonDownloader::~NeonDownloader()

Modified: trunk/Collect/NeonDownloader.h
===================================================================
--- trunk/Collect/NeonDownloader.h	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/Collect/NeonDownloader.h	2006-01-14 06:45:15 UTC (rev 59)
@@ -47,7 +47,6 @@
 		virtual bool stop(void);
 
 	protected:
-		static bool m_initialized;
 		std::string m_userAgent;
 		ne_session *m_pSession;
 		ne_request *m_pRequest;

Modified: trunk/Collect/dloadtest.cpp
===================================================================
--- trunk/Collect/dloadtest.cpp	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/Collect/dloadtest.cpp	2006-01-14 06:45:15 UTC (rev 59)
@@ -23,6 +23,7 @@
 #include "HtmlTokenizer.h"
 #include "Url.h"
 #include "DownloaderFactory.h"
+#include "NeonDownloader.h"
 
 using namespace std;
 
@@ -34,6 +35,8 @@
 		return EXIT_FAILURE;
 	}
 
+	NeonDownloader::initialize();
+
 	string downloaderName = argv[1];
 	
 	Url thisUrl(argv[2]);
@@ -45,17 +48,12 @@
 	cout << "File: " << thisUrl.getFile() << endl;
 	cout << "Parameters: " << thisUrl.getParameters() << endl;
 
-	if (downloaderName == "-")
-	{
-		// Don't go further
-		return EXIT_SUCCESS;
-	}
-
 	// Which Downloader ?
 	DownloaderInterface *myDownloader = DownloaderFactory::getDownloader(thisUrl.getProtocol(),
 		downloaderName);
 	if (myDownloader == NULL)
 	{
+		NeonDownloader::shutdown();
 		cerr << "Couldn't obtain downloader instance (" << thisUrl.getProtocol() << "," << downloaderName << ")" << endl;
 		return EXIT_FAILURE;
 	}
@@ -111,5 +109,7 @@
 
 	delete myDownloader;
 
+	NeonDownloader::shutdown();
+
 	return EXIT_SUCCESS;
 }

Modified: trunk/Index/Summarizer.cpp
===================================================================
--- trunk/Index/Summarizer.cpp	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/Index/Summarizer.cpp	2006-01-14 06:45:15 UTC (rev 59)
@@ -35,6 +35,7 @@
 using std::min;
 
 unsigned int Summarizer::m_maxTextSize = 50000;
+unsigned int Summarizer::m_maxSummarySize = 1000;
 
 Summarizer::Summarizer(const std::string &language, unsigned int wordsCount) :
 	m_wordsCount(wordsCount),
@@ -80,7 +81,7 @@
 	if ((pArticle != NULL) &&
 		(ots_load_xml_dictionary(pArticle, m_dictionaryCode.c_str())))
 	{
-		// OTS may take too much time with long documents
+		// OTS may take too long with long documents
 		ots_parse_stream((const unsigned char*)pText,
 			min(textLen, m_maxTextSize), pArticle);
 
@@ -104,7 +105,8 @@
 
 	if (pSummary != NULL)
 	{
-		string sum((const char *)pSummary, outputLen);
+		string sum((const char *)pSummary,
+			min(outputLen, m_maxSummarySize));
 
 		free(pSummary);
 

Modified: trunk/Index/Summarizer.h
===================================================================
--- trunk/Index/Summarizer.h	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/Index/Summarizer.h	2006-01-14 06:45:15 UTC (rev 59)
@@ -33,6 +33,7 @@
 
 	protected:
 		static unsigned int m_maxTextSize;
+		static unsigned int m_maxSummarySize;
 		unsigned int m_wordsCount;
 		std::string m_dictionaryCode;
 		std::string m_title;

Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/Index/XapianIndex.cpp	2006-01-14 06:45:15 UTC (rev 59)
@@ -21,6 +21,7 @@
 #include <stdio.h>
 #include <stdarg.h>
 #include <time.h>
+#include <regex.h>
 #include <iostream>
 #include <fstream>
 #include <algorithm>
@@ -71,6 +72,28 @@
 	return term;
 }
 
+bool XapianIndex::badField(const string &field)
+{
+	regex_t fieldRegex;
+	regmatch_t pFieldMatches[1];
+	bool isBadField = false;
+
+	// A bad field is one that includes one of our field delimiters
+	if (regcomp(&fieldRegex,
+		"(url|sample|caption|type|timestamp|language)=",
+		REG_EXTENDED|REG_ICASE) == 0)
+	{
+		if (regexec(&fieldRegex, field.c_str(), 1,
+			pFieldMatches, REG_NOTBOL|REG_NOTEOL) == 0)
+		{
+			isBadField = true;
+		}
+	}
+	regfree(&fieldRegex);
+
+	return isBadField;
+}
+
 void XapianIndex::addTermsToDocument(Tokenizer &tokens, Xapian::Document &doc,
 	const string &prefix, Xapian::termcount &termPos, StemmingMode mode) const
 {
@@ -207,7 +230,7 @@
 		// Fall back on English
 		language = "english";
 	}
-	Summarizer sum(language, 100);
+	Summarizer sum(language, 50);
 	summary = sum.summarize(pData, dataLength);
 
 	// Update the document's properties
@@ -231,16 +254,37 @@
 void XapianIndex::setDocumentData(Xapian::Document &doc, const DocumentInfo &info, const string &extract,
 	const string &language) const
 {
+	string title(info.getTitle());
+	string timestamp(info.getTimestamp());
 	char timeStr[64];
-	string timestamp = info.getTimestamp();
 
 	// Set the document data omindex-style
 	string record = "url=";
 	record += info.getLocation();
 	record += "\nsample=";
-	record += extract;
+	// Ignore the extract if it contains any of our field delimiters
+	if (badField(extract) == false)
+	{
+		record += extract;
+	}
+#ifdef DEBUG
+	else cout << "XapianIndex::setDocumentData: bad extract" << endl;
+#endif
 	record += "\ncaption=";
-	record += info.getTitle();
+	if (badField(title) == true)
+	{
+		// Modify the title if necessary
+		string::size_type pos = title.find("=");
+		while (pos != string::npos)
+		{
+			title[pos] = ' ';
+			pos = title.find("=", pos + 1);
+		}
+#ifdef DEBUG
+		cout << "XapianIndex::setDocumentData: modified title" << endl;
+#endif
+	}
+	record += title;
 	record += "\ntype=";
 	record += info.getType();
 	// Append a timestamp
@@ -310,12 +354,12 @@
 
 		string summary = scanDocument(pData, dataLength, docInfo);
 
+		Xapian::Document doc;
+		Xapian::termcount termPos = 0;
+
 #ifdef DEBUG
 		cout << "XapianIndex::indexDocument: adding terms" << endl;
 #endif
-		Xapian::Document doc;
-		Xapian::termcount termPos = 0;
-
 		// Add the tokenizer's terms to the Xapian document
 		addTermsToDocument(tokens, doc, "", termPos, m_stemMode);
 		// Add labels

Modified: trunk/Index/XapianIndex.h
===================================================================
--- trunk/Index/XapianIndex.h	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/Index/XapianIndex.h	2006-01-14 06:45:15 UTC (rev 59)
@@ -96,6 +96,8 @@
 
 		static std::string limitTermLength(const std::string &term);
 
+		static bool badField(const std::string &field);
+
 		void addTermsToDocument(Tokenizer &tokens, Xapian::Document &doc,
 			const std::string &prefix, Xapian::termcount &termPos, StemmingMode mode) const;
 

Modified: trunk/UI/GTK2/src/IndexTree.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexTree.cpp	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/UI/GTK2/src/IndexTree.cpp	2006-01-14 06:45:15 UTC (rev 59)
@@ -453,7 +453,7 @@
 		empty = true;
 	}
 
-	columns_autosize();
+	refresh();
 
 	return empty;
 }
@@ -495,7 +495,7 @@
 }
 
 //
-// Clear the tree.
+// Clears the tree.
 //
 void IndexTree::clear(void)
 {

Modified: trunk/UI/GTK2/src/IndexTree.h
===================================================================
--- trunk/UI/GTK2/src/IndexTree.h	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/UI/GTK2/src/IndexTree.h	2006-01-14 06:45:15 UTC (rev 59)
@@ -88,7 +88,7 @@
 		/// Returns true if the tree is empty.
 		bool isEmpty(void);
 
-		/// Clear the tree.
+		/// Clears the tree.
 		void clear(void);
 
 		/// Returns the document edit signal.

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-01-14 06:45:15 UTC (rev 59)
@@ -893,14 +893,23 @@
 	TreeModel::Children children = m_refStore->children();
 	empty = children.empty();
 
-	columns_autosize();
+	refresh();
 
 	return empty;
 }
 
 //
-// Clear the tree.
+// Refreshes the tree.
 //
+void ResultsTree::refresh(void)
+{
+	// FIXME: not sure why, but this helps with refreshing the tree
+	columns_autosize();
+}
+
+//
+// Clears the tree.
+//
 void ResultsTree::clear(void)
 {
 	// Unselect results

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/UI/GTK2/src/ResultsTree.h	2006-01-14 06:45:15 UTC (rev 59)
@@ -80,7 +80,10 @@
 		  */
 		bool deleteSelection(void);
 
-		/// Clear the tree.
+		/// Refreshes the tree.
+		void refresh(void);
+
+		/// Clears the tree.
 		void clear(void);
 
 		/// Shows or hides the extract field.

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-14 06:45:15 UTC (rev 59)
@@ -1232,10 +1232,10 @@
 		}
 		else
 		{
-			// OK
-			m_status = "";
 			// Flush the index
 			index.flush();
+			// The document properties may have changed
+			index.getDocumentInfo(m_docId, m_docInfo);
 		}
 	}
 

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-13 16:36:15 UTC (rev 58)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-14 06:45:15 UTC (rev 59)
@@ -1155,6 +1155,8 @@
 			{
 				pIndexTree->updateDocumentInfo(pUpdateThread->getDocumentID(),
 					pUpdateThread->getDocumentInfo());
+				// Refresh the tree
+				pIndexTree->refresh();
 			}
 		}
 
@@ -1485,7 +1487,7 @@
 					}
 					text += docIter->getTitle();
 					text += " ";
-					text += docIter->getLocation();
+					text += docIter->getOriginalLocation();
 					firstItem = false;
 				}
 			}



From fabricecolin at berlios.de  Sat Jan 14 09:59:50 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 14 Jan 2006 09:59:50 +0100
Subject: [Pinot-svn] r60 - trunk/UI/GTK2/src
Message-ID: <200601140859.k0E8xoxe013489@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-14 09:59:50 +0100 (Sat, 14 Jan 2006)
New Revision: 60

Modified:
   trunk/UI/GTK2/src/IndexPage.cpp
   trunk/UI/GTK2/src/IndexTree.cpp
   trunk/UI/GTK2/src/PinotUtils.cpp
   trunk/UI/GTK2/src/PinotUtils.h
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/indexDialog.cc
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/prefsDialog.cc
   trunk/UI/GTK2/src/propertiesDialog.cc
   trunk/UI/GTK2/src/queryDialog.cc
Log:
Added from_utf8(), that catches conversion errors. Sorted out some niggling
issues with IndexPage and Tree.


Modified: trunk/UI/GTK2/src/IndexPage.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexPage.cpp	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/IndexPage.cpp	2006-01-14 08:59:50 UTC (rev 60)
@@ -233,7 +233,7 @@
 	{
 		m_pBackButton->set_sensitive(false);
 	}
-	if (m_docsCount >= m_firstDoc + maxDocsCount)
+	if (m_docsCount > m_firstDoc + maxDocsCount)
 	{
 		m_pForwardButton->set_sensitive(true);
 	}

Modified: trunk/UI/GTK2/src/IndexTree.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexTree.cpp	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/IndexTree.cpp	2006-01-14 08:59:50 UTC (rev 60)
@@ -313,11 +313,11 @@
 		TreeModel::iterator iter = m_refStore->get_iter(*itemPath);
 		TreeModel::Row row = *iter;
 
-		documentsList.push_back(IndexedDocument(locale_from_utf8(row[m_indexColumns.m_text]),
-			locale_from_utf8(row[m_indexColumns.m_url]),
-			locale_from_utf8(row[m_indexColumns.m_liveUrl]),
-			locale_from_utf8(row[m_indexColumns.m_type]),
-			locale_from_utf8(row[m_indexColumns.m_language])));
+		documentsList.push_back(IndexedDocument(from_utf8(row[m_indexColumns.m_text]),
+			from_utf8(row[m_indexColumns.m_url]),
+			from_utf8(row[m_indexColumns.m_liveUrl]),
+			from_utf8(row[m_indexColumns.m_type]),
+			from_utf8(row[m_indexColumns.m_language])));
 	}
 #ifdef DEBUG
 	cout << "IndexTree::getSelection: " << documentsList.size() << " documents selected" << endl;
@@ -453,8 +453,6 @@
 		empty = true;
 	}
 
-	refresh();
-
 	return empty;
 }
 

Modified: trunk/UI/GTK2/src/PinotUtils.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotUtils.cpp	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/PinotUtils.cpp	2006-01-14 08:59:50 UTC (rev 60)
@@ -228,3 +228,17 @@
 
 	return "";
 }
+
+/// Converts from UTF-8.
+string from_utf8(const ustring &text)
+{
+	try
+	{
+		return locale_from_utf8(text);
+	}
+	catch (ConvertError &ce)
+	{
+	}
+
+	return "";
+}

Modified: trunk/UI/GTK2/src/PinotUtils.h
===================================================================
--- trunk/UI/GTK2/src/PinotUtils.h	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/PinotUtils.h	2006-01-14 08:59:50 UTC (rev 60)
@@ -53,4 +53,7 @@
 /// Converts from the given charset to UTF-8.
 Glib::ustring to_utf8(const std::string &text, const std::string &charset);
 
+/// Converts from UTF-8.
+std::string from_utf8(const Glib::ustring &text);
+
 #endif // _PINOTUTILS_HH

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-01-14 08:59:50 UTC (rev 60)
@@ -309,7 +309,7 @@
 			string extract;
 
 			// m_queryName and row[m_resultsColumns.m_queryName] should be equal
-			string url = locale_from_utf8(row[m_resultsColumns.m_url]);
+			string url = from_utf8(row[m_resultsColumns.m_url]);
 			unsigned int engineIds = row[m_resultsColumns.m_engines];
 			unsigned int indexIds = row[m_resultsColumns.m_indexes];
 
@@ -343,7 +343,7 @@
 #ifdef DEBUG
 				cout << "ResultsTree::onSelectionSelect: first engine for " << url << " was " << engineName << endl;
 #endif
-				extract = history.getItemExtract(locale_from_utf8(m_queryName), engineName, url);
+				extract = history.getItemExtract(from_utf8(m_queryName), engineName, url);
 			}
 
 			RefPtr<TextBuffer> refBuffer = m_extractTextview->get_buffer();
@@ -615,7 +615,7 @@
 				bool success = false;
 
 				// We will need the URL and engines columns in all cases
-				string url = locale_from_utf8(childRow[m_resultsColumns.m_url]);
+				string url = from_utf8(childRow[m_resultsColumns.m_url]);
 				unsigned int engineIds = childRow[m_resultsColumns.m_engines];
 				unsigned int indexIds = childRow[m_resultsColumns.m_indexes];
 
@@ -633,10 +633,10 @@
 						// Add result
 						success = appendResult(childRow[m_resultsColumns.m_text],
 							childRow[m_resultsColumns.m_url],
-							(float)atof(locale_from_utf8(childRow[m_resultsColumns.m_score]).c_str()),
-							locale_from_utf8(childRow[m_resultsColumns.m_language]),
+							(float)atof(from_utf8(childRow[m_resultsColumns.m_score]).c_str()),
+							from_utf8(childRow[m_resultsColumns.m_language]),
 							childRow[m_resultsColumns.m_rankDiff],
-							locale_from_utf8(childRow[m_resultsColumns.m_queryName]),
+							from_utf8(childRow[m_resultsColumns.m_queryName]),
 							engineIds, indexIds, newIter, &(*groupIter), true);
 					}
 				}
@@ -693,10 +693,10 @@
 								// Add result
 								appendResult(childRow[m_resultsColumns.m_text],
 									childRow[m_resultsColumns.m_url],
-									(float)atof(locale_from_utf8(childRow[m_resultsColumns.m_score]).c_str()),
-									locale_from_utf8(childRow[m_resultsColumns.m_language]),
+									(float)atof(from_utf8(childRow[m_resultsColumns.m_score]).c_str()),
+									from_utf8(childRow[m_resultsColumns.m_language]),
 									childRow[m_resultsColumns.m_rankDiff],
-									locale_from_utf8(childRow[m_resultsColumns.m_queryName]),
+									from_utf8(childRow[m_resultsColumns.m_queryName]),
 									engineId, indexId,
 									newIter, &(*groupIter), true);
 #ifdef DEBUG
@@ -810,9 +810,9 @@
 		TreeModel::iterator iter = m_refStore->get_iter(*itemPath);
 		TreeModel::Row row = *iter;
 
-		resultsList.push_back(Result(locale_from_utf8(row[m_resultsColumns.m_url]),
-			locale_from_utf8(row[m_resultsColumns.m_text]),
-			"", locale_from_utf8(row[m_resultsColumns.m_language])));
+		resultsList.push_back(Result(from_utf8(row[m_resultsColumns.m_url]),
+			from_utf8(row[m_resultsColumns.m_text]),
+			"", from_utf8(row[m_resultsColumns.m_language])));
 	}
 #ifdef DEBUG
 	cout << "ResultsTree::getSelection: " << resultsList.size() << " results selected" << endl;
@@ -858,7 +858,7 @@
 		// This could be a group that's in the map and should be removed first
 		if (row[m_resultsColumns.m_type] != ResultsModelColumns::RESULT_TITLE)
 		{
-			string groupName = locale_from_utf8(row[m_resultsColumns.m_text]);
+			string groupName = from_utf8(row[m_resultsColumns.m_text]);
 			std::map<string, TreeModel::iterator>::iterator mapIter = m_resultsGroups.find(groupName);
 			if (mapIter != m_resultsGroups.end())
 			{

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-14 08:59:50 UTC (rev 60)
@@ -213,7 +213,7 @@
 	{
 		XapianIndex index(PinotSettings::getInstance().m_indexLocation);
 		IndexingThread *pThread = NULL;
-		string title = locale_from_utf8(m_title);
+		string title = from_utf8(m_title);
 		unsigned int docId = 0;
 
 		if (index.isGood() == true)
@@ -396,7 +396,7 @@
 		}
 		else
 		{
-			Url urlObj(locale_from_utf8(fileName));
+			Url urlObj(from_utf8(fileName));
 
 			// Check the URL is valid
 			if (urlObj.getProtocol().empty() == true)
@@ -434,7 +434,7 @@
 		if (pos != string::npos)
 		{
 			// Update the default directory
-			m_state.m_defaultDirectory = locale_from_utf8(fileName.substr(0, pos + 1));
+			m_state.m_defaultDirectory = from_utf8(fileName.substr(0, pos + 1));
 #ifdef DEBUG
 			cout << "importDialog::on_locationButton_clicked: directory now "
 				<< m_state.m_defaultDirectory << endl;
@@ -445,7 +445,7 @@
 
 void importDialog::on_importButton_clicked()
 {
-	string location = locale_from_utf8(locationEntry->get_text());
+	string location = from_utf8(locationEntry->get_text());
 	unsigned int level = 0;
 
 	// Rudimentary lock
@@ -469,7 +469,7 @@
 			iter != children.end(); ++iter)
 		{
 			TreeModel::Row row = *iter;
-			string mimeType(locale_from_utf8(row[m_mimeTypeColumns.m_type]));
+			string mimeType(from_utf8(row[m_mimeTypeColumns.m_type]));
 			bool enabled = row[m_mimeTypeColumns.m_enabled];
 
 			if (enabled == true)

Modified: trunk/UI/GTK2/src/indexDialog.cc
===================================================================
--- trunk/UI/GTK2/src/indexDialog.cc	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/indexDialog.cc	2006-01-14 08:59:50 UTC (rev 60)
@@ -176,7 +176,7 @@
 
 	// Look up that index name in the map
 	const std::map<string, string> &indexesMap = settings.getIndexes();
-	std::map<string, string>::const_iterator indexIter = indexesMap.find(locale_from_utf8(name));
+	std::map<string, string>::const_iterator indexIter = indexesMap.find(from_utf8(name));
 	if (indexIter != indexesMap.end())
 	{
 		// This name is in use

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-14 08:59:50 UTC (rev 60)
@@ -312,7 +312,7 @@
 			TreeModel::Row row = *iter;
 
 			// Add this query to the settings
-			string name = locale_from_utf8(row[m_queryColumns.m_name]);
+			string name = from_utf8(row[m_queryColumns.m_name]);
 			QueryProperties queryProps = row[m_queryColumns.m_properties];
 #ifdef DEBUG
 			cout << "mainWindow::save_queryTreeview: " << name << endl;
@@ -457,7 +457,7 @@
 	{
 		bool isViewable = true, isIndexable = true, isCached = false;
 
-		Url urlObj(locale_from_utf8(url));
+		Url urlObj(from_utf8(url));
 		string protocol = urlObj.getProtocol();
 		// FIXME: there should be a way to know which protocols can be viewed/indexed
 		if (protocol == "xapian")
@@ -1129,8 +1129,25 @@
 
 		if (pUnindexThread->getDocumentsCount() > 0)
 		{
+			ustring indexName(_("My Documents"));
 			status = _("Unindexed document(s)");
 			set_status(status);
+
+			IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_page(indexName, NotebookPageBox::INDEX_PAGE));
+			if (pIndexPage != NULL)
+			{
+				unsigned int docsCount = pIndexPage->getDocumentsCount();
+
+				--docsCount;
+				pIndexPage->setDocumentsCount(docsCount);
+				pIndexPage->updateButtonsState(m_maxDocsCount);
+
+				if ((docsCount >= pIndexPage->getFirstDocument() + m_maxDocsCount))
+				{
+					// Refresh this page
+					browse_index(indexName, pIndexPage->getFirstDocument());
+				}
+			}
 		}
 		// Else, stay silent
 	}
@@ -1155,8 +1172,6 @@
 			{
 				pIndexTree->updateDocumentInfo(pUpdateThread->getDocumentID(),
 					pUpdateThread->getDocumentInfo());
-				// Refresh the tree
-				pIndexTree->refresh();
 			}
 		}
 
@@ -1224,9 +1239,9 @@
 
 		// The only way to edit an index right now is to remove it
 		// first, then add it again
-		if ((m_settings.removeIndex(locale_from_utf8(indexName)) == false) ||
-			(m_settings.addIndex(locale_from_utf8(newName),
-				locale_from_utf8(newLocation)) == false))
+		if ((m_settings.removeIndex(from_utf8(indexName)) == false) ||
+			(m_settings.addIndex(from_utf8(newName),
+				from_utf8(newLocation)) == false))
 		{
 			ustring statusText = _("Couldn't rename index");
 			statusText += " ";
@@ -1299,7 +1314,7 @@
 
 			if (index.isGood() == true)
 			{
-				hasLabel = index.hasLabel(docId, locale_from_utf8(labelName));
+				hasLabel = index.hasLabel(docId, from_utf8(labelName));
 			}
 		}
 	}
@@ -1381,7 +1396,7 @@
 	const set<string> &mailLabelsToDelete = prefsBox.getMailLabelsToDelete();
 	if (mailLabelsToDelete.empty() == false)
 	{
-		start_thread(new UnindexingThread(mailLabelsToDelete, locale_from_utf8(m_settings.m_mailIndexLocation)));
+		start_thread(new UnindexingThread(mailLabelsToDelete, from_utf8(m_settings.m_mailIndexLocation)));
 	}
 }
 
@@ -1533,7 +1548,7 @@
 #endif
 		// Use whatever text is in the clipboard as query name
 		// FIXME: look for \n as query fields separators ?
-		QueryProperties queryProps = QueryProperties(locale_from_utf8(clipText),
+		QueryProperties queryProps = QueryProperties(from_utf8(clipText),
 			"", "", "", "");
 		edit_query(queryProps, true);
 	}
@@ -1656,7 +1671,7 @@
 			if (pResultsTree != NULL)
 			{
 				ustring url = pResultsTree->getFirstSelectionURL();
-				if (view_document(locale_from_utf8(url)) == true)
+				if (view_document(from_utf8(url)) == true)
 				{
 					// We can update the row right now
 					pResultsTree->setFirstSelectionViewedState(true);
@@ -1789,7 +1804,7 @@
 		{
 			// View the first document, don't bother about the rest
 			ustring url = pIndexTree->getFirstSelectionLiveURL();
-			view_document(locale_from_utf8(url));
+			view_document(from_utf8(url));
 		}
 	}
 }
@@ -1873,8 +1888,8 @@
 	IndexPage *pIndexPage = dynamic_cast<IndexPage*>(get_current_page());
 	if (pIndexPage != NULL)
 	{
-		indexName = locale_from_utf8(pIndexPage->getTitle());
-		labelName = locale_from_utf8(pIndexPage->getLabelName());
+		indexName = from_utf8(pIndexPage->getTitle());
+		labelName = from_utf8(pIndexPage->getLabelName());
 		pIndexTree = pIndexPage->getTree();
 	}
 
@@ -2124,8 +2139,8 @@
 	}
 
 	// Add the new index
-	if (m_settings.addIndex(locale_from_utf8(name),
-			locale_from_utf8(location)) == false)
+	if (m_settings.addIndex(from_utf8(name),
+			from_utf8(location)) == false)
 	{
 		ustring statusText = _("Couldn't add index");
 		statusText += " ";
@@ -2174,7 +2189,7 @@
 
 		// Remove it
 		// FIXME: ask for confirmation ?
-		if (m_settings.removeIndex(locale_from_utf8(name)) == false)
+		if (m_settings.removeIndex(from_utf8(name)) == false)
 		{
 			ustring statusText = _("Couldn't remove index");
 			statusText += " ";
@@ -2232,7 +2247,7 @@
 		int termIndex = 0;
 
 		// Get a list of suggestions
-		docsIndex.getCloseTerms(locale_from_utf8(term), suggestedTerms);
+		docsIndex.getCloseTerms(from_utf8(term), suggestedTerms);
 
 		// Populate the list
 		for (set<string>::iterator termIter = suggestedTerms.begin();
@@ -2259,7 +2274,7 @@
 
 	queryProps.setName("Live query");
 	// FIXME: parse the query string !
-	queryProps.setAnyWords(locale_from_utf8(liveQueryEntry->get_text()));
+	queryProps.setAnyWords(from_utf8(liveQueryEntry->get_text()));
 
 	run_search(queryProps);
 }
@@ -2304,7 +2319,7 @@
 	if (iter)
 	{
 		TreeModel::Row row = *iter;
-		string queryName = locale_from_utf8(row[m_queryColumns.m_name]);
+		string queryName = from_utf8(row[m_queryColumns.m_name]);
 
 		if (m_settings.removeQuery(queryName) == true)
 		{
@@ -2778,8 +2793,8 @@
 		set_status(status);
 
 		// Spawn a new thread
-		start_thread(new QueryingThread(locale_from_utf8(engineName),
-			locale_from_utf8(engineDisplayableName), engineOption, queryProps));
+		start_thread(new QueryingThread(from_utf8(engineName),
+			from_utf8(engineDisplayableName), engineOption, queryProps));
 	}
 }
 
@@ -2812,7 +2827,7 @@
 
 	// Spawn a new thread to browse the index
 	IndexBrowserThread *pBrowseThread = new IndexBrowserThread(
-		locale_from_utf8(indexName), m_maxDocsCount, startDoc);
+		from_utf8(indexName), m_maxDocsCount, startDoc);
 	pBrowseThread->getUpdateSignal().connect(SigC::slot(*this,
 		&mainWindow::on_message_indexupdate));
 	start_thread(pBrowseThread);
@@ -2915,7 +2930,7 @@
 			return false;
 		}
 
-		string shellCommand = locale_from_utf8(m_settings.m_browserCommand);
+		string shellCommand = from_utf8(m_settings.m_browserCommand);
 		// FIXME: do substitutions
 		shellCommand += " \"";
 		shellCommand += url;

Modified: trunk/UI/GTK2/src/prefsDialog.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog.cc	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/prefsDialog.cc	2006-01-14 08:59:50 UTC (rev 60)
@@ -184,10 +184,10 @@
 				(label.m_name != oldName))
 			{
 				// Yes, it was
-				m_renamedLabels[locale_from_utf8(oldName)] = locale_from_utf8(label.m_name);
+				m_renamedLabels[from_utf8(oldName)] = from_utf8(label.m_name);
 			}
 			// Check user didn't recreate this label after having deleted it
-			set<string>::iterator labelIter = m_deletedLabels.find(locale_from_utf8(label.m_name));
+			set<string>::iterator labelIter = m_deletedLabels.find(from_utf8(label.m_name));
 			if (labelIter != m_deletedLabels.end())
 			{
 				m_deletedLabels.erase(labelIter);
@@ -264,7 +264,7 @@
 				mailAccount.m_lastMessageTime = row[m_mailColumns.m_minDate];
 
 				string mailLabel("mailbox://");
-				mailLabel += locale_from_utf8(mailAccount.m_name);
+				mailLabel += from_utf8(mailAccount.m_name);
 
 				// Check user didn't recreate this mail account after having deleted it
 				set<string>::iterator mailIter = m_deletedMail.find(mailLabel);
@@ -402,7 +402,7 @@
 		labelsTreeview->get_selection()->select(path);
 		// Erase
 		TreeModel::Row row = *iter;
-		m_deletedLabels.insert(locale_from_utf8(row[m_labelsColumns.m_name]));
+		m_deletedLabels.insert(from_utf8(row[m_labelsColumns.m_name]));
 		m_refLabelsTree->erase(row);
 
 		TreeModel::Children children = m_refLabelsTree->children();
@@ -492,7 +492,7 @@
 
 		// Erase
 		TreeModel::Row row = *iter;
-		mailLabel += locale_from_utf8(row[m_mailColumns.m_location]);
+		mailLabel += from_utf8(row[m_mailColumns.m_location]);
 		m_deletedMail.insert(mailLabel);
 		m_refMailTree->erase(row);
 

Modified: trunk/UI/GTK2/src/propertiesDialog.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.cc	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/propertiesDialog.cc	2006-01-14 08:59:50 UTC (rev 60)
@@ -87,7 +87,7 @@
 		row = *iter;
 
 		row[m_labelsColumns.m_name] = labelIter->m_name;
-		string labelName = locale_from_utf8(labelIter->m_name);
+		string labelName = from_utf8(labelIter->m_name);
 		// Is it in the document labels list ?
 		set<string>::const_iterator iter = find(docLabels.begin(), docLabels.end(), labelName);
 		if (iter != docLabels.end())
@@ -136,7 +136,7 @@
 	if (m_editDocument == true)
 	{
 		// Title
-		m_docInfo.setTitle(locale_from_utf8(titleEntry->get_text()));
+		m_docInfo.setTitle(from_utf8(titleEntry->get_text()));
 	}
 	// Go through the labels tree
 	TreeModel::Children children = m_refLabelsTree->children();
@@ -150,7 +150,7 @@
 			if (enabled == true)
 			{
 				ustring labelName = row[m_labelsColumns.m_name];
-				m_labels.insert(locale_from_utf8(labelName));
+				m_labels.insert(from_utf8(labelName));
 			}
 		}
 	}

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2006-01-14 06:45:15 UTC (rev 59)
+++ trunk/UI/GTK2/src/queryDialog.cc	2006-01-14 08:59:50 UTC (rev 60)
@@ -150,7 +150,7 @@
 void queryDialog::on_queryOkbutton_clicked()
 {
 	// Name
-	m_properties.setName(locale_from_utf8(nameEntry->get_text()));
+	m_properties.setName(from_utf8(nameEntry->get_text()));
 	m_badName = false;
 	// Did the name change ?
 	if (m_name != m_properties.getName())
@@ -170,10 +170,10 @@
 	}
 
 	// Query terms
-	m_properties.setAndWords(locale_from_utf8(andEntry->get_text()));
-	m_properties.setPhrase(locale_from_utf8(phraseEntry->get_text()));
-	m_properties.setAnyWords(locale_from_utf8(anyEntry->get_text()));
-	m_properties.setNotWords(locale_from_utf8(notEntry->get_text()));
+	m_properties.setAndWords(from_utf8(andEntry->get_text()));
+	m_properties.setPhrase(from_utf8(phraseEntry->get_text()));
+	m_properties.setAnyWords(from_utf8(anyEntry->get_text()));
+	m_properties.setNotWords(from_utf8(notEntry->get_text()));
 	// Language
 	m_properties.setLanguage("");
 	int chosenLanguage = languageCombobox->get_active_row_number();
@@ -196,13 +196,13 @@
 	{
 		TreeModel::iterator iter = labelNameCombobox->get_active();
 		TreeModel::Row row = *iter;
-		string labelName = locale_from_utf8(row[m_labelNameColumns.m_name]);
+		string labelName = from_utf8(row[m_labelNameColumns.m_name]);
 
 		m_properties.setLabelName(labelName);
 	}
 	// Filters
-	m_properties.setHostFilter(locale_from_utf8(hostNameEntry->get_text()));
-	m_properties.setFileFilter(locale_from_utf8(fileNameEntry->get_text()));
+	m_properties.setHostFilter(from_utf8(hostNameEntry->get_text()));
+	m_properties.setFileFilter(from_utf8(fileNameEntry->get_text()));
 	// Label filter
 	chosenLabel = labelFilterCombobox->get_active_row_number();
 	m_properties.setLabelFilter("");
@@ -210,7 +210,7 @@
 	{
 		TreeModel::iterator iter = labelFilterCombobox->get_active();
 		TreeModel::Row row = *iter;
-		string labelName = locale_from_utf8(row[m_labelFilterColumns.m_name]);
+		string labelName = from_utf8(row[m_labelFilterColumns.m_name]);
 
 		m_properties.setLabelFilter(labelName);
 	}



From fabricecolin at berlios.de  Sun Jan 15 05:16:47 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sun, 15 Jan 2006 05:16:47 +0100
Subject: [Pinot-svn] r61 - in trunk: . Tokenize
Message-ID: <200601150416.k0F4Glex017064@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-15 05:16:46 +0100 (Sun, 15 Jan 2006)
New Revision: 61

Added:
   trunk/Tokenize/RtfTokenizer.cpp
   trunk/Tokenize/RtfTokenizer.h
Modified:
   trunk/Tokenize/Makefile
   trunk/Tokenize/PdfTokenizer.cpp
   trunk/Tokenize/PdfTokenizer.h
   trunk/Tokenize/Tokenizer.cpp
   trunk/Tokenize/Tokenizer.h
   trunk/Tokenize/TokenizerFactory.cpp
   trunk/Tokenize/TokenizerFactory.h
   trunk/Tokenize/UnknownTypeTokenizer.cpp
   trunk/Tokenize/WordTokenizer.cpp
   trunk/Tokenize/WordTokenizer.h
   trunk/pinot.spec
Log:
New RTF tokenizer based on unrtf. Streamlined running helper programs. New
package pinot-text-docs includes all tokenizers and replaces -pdf and -word.


Modified: trunk/Tokenize/Makefile
===================================================================
--- trunk/Tokenize/Makefile	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/Makefile	2006-01-15 04:16:46 UTC (rev 61)
@@ -10,9 +10,11 @@
 TOKENIZER_TEST = ${BIN_DIR}/tokenizertest
 PDF_TOKENIZER_DL = ${LIB_DIR}/pdf_tokenizer.so
 WORD_TOKENIZER_DL = ${LIB_DIR}/word_tokenizer.so
+RTF_TOKENIZER_DL = ${LIB_DIR}/rtf_tokenizer.so
 
 targets : dirs ${TOKENIZE_LIB} ${TOKENIZER_TEST} \
-	${PDF_TOKENIZER_DL} ${WORD_TOKENIZER_DL}
+	${PDF_TOKENIZER_DL} ${WORD_TOKENIZER_DL} \
+	${RTF_TOKENIZER_DL}
 
 clean :
 	@rm -f ${OBJ_DIR}/* ${TOKENIZE_LIB} ${TOKENIZER_TEST} \
@@ -40,3 +42,6 @@
 	@echo Building ${WORD_TOKENIZER_DL}
 	${LINK} -shared -o ${WORD_TOKENIZER_DL} ${OBJ_DIR}/WordTokenizer.o ${TOKENIZE_LIB} ${UTILS_LIB} ${LIBS} -ldl
 
+${RTF_TOKENIZER_DL} : ${OBJ_DIR}/RtfTokenizer.o
+	@echo Building ${RTF_TOKENIZER_DL}
+	${LINK} -shared -o ${RTF_TOKENIZER_DL} ${OBJ_DIR}/RtfTokenizer.o ${TOKENIZE_LIB} ${UTILS_LIB} ${LIBS} -ldl

Modified: trunk/Tokenize/PdfTokenizer.cpp
===================================================================
--- trunk/Tokenize/PdfTokenizer.cpp	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/PdfTokenizer.cpp	2006-01-15 04:16:46 UTC (rev 61)
@@ -14,10 +14,7 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <stdlib.h>
-#include <unistd.h>
+#include <string.h>
 #include <iostream>
 
 #include "PdfTokenizer.h"
@@ -26,14 +23,17 @@
   * This returns the MIME type supported by the library's tokenizer.
   * The character string is allocated with new[].
   */
-char *getTokenizerType(void)
+char *getTokenizerType(unsigned int typeNum)
 {
-	char *pType = new char[16];
+	if (typeNum == 0)
+	{
+		char *pType = new char[16];
+		strncpy(pType, "application/pdf", 15);
+		pType[15] = '\0';
+		return pType;
+	}
 
-	strncpy(pType, "application/pdf", 15);
-	pType[15] = '\0';
-
-	return pType;
+	return NULL;
 }
 
 /// This returns a pointer to a Tokenizer, allocated with new.
@@ -45,72 +45,15 @@
 PdfTokenizer::PdfTokenizer(const Document *pDocument) :
 	HtmlTokenizer(NULL)
 {
-	char inTemplate[15] = "/tmp/tokXXXXXX";
-	char outTemplate[15] = "/tmp/tokXXXXXX";
+	string cmdLine("pdftohtml -stdout");
 
-	int inFd = mkstemp(inTemplate);
-	int outFd = mkstemp(outTemplate);
-	if ((inFd != -1) &&
-		(outFd != -1))
+	// Run antiword
+	Document *pOutputDocument = runHelperProgram(pDocument, cmdLine);
+	if (pOutputDocument != NULL)
 	{
-		unsigned int dataLength = 0;
-		const char *pData = pDocument->getData(dataLength);
-
-		// Save the data into a temporary file
-		if (write(inFd, (const void*)pData, dataLength) != -1)
-		{
-			// Run pdftohtml to convert it
-			string cmdLine = "pdftohtml -stdout ";
-			cmdLine += inTemplate;
-			cmdLine += " >";
-			cmdLine += outTemplate;
-			cmdLine += " 2>/dev/null";
-
-			if (system(cmdLine.c_str()) != -1)
-			{
-				struct stat fileStat;
-
-				// Read the output
-				if ((stat(outTemplate, &fileStat) != -1) &&
-					(S_ISREG(fileStat.st_mode)))
-				{
-					unsigned int total, bytes;
-					char *content = new char[fileStat.st_size + 1];
-
-					total = bytes = read(outFd, (void*)content, fileStat.st_size);
-					while ((bytes > 0) &&
-						(total < fileStat.st_size))
-					{
-						bytes = read(outFd, (void*)content, fileStat.st_size - total);
-						total += bytes;
-					}
-
-					// Pass the result to the parent class
-					Document *pHtmlDoc = new Document(pDocument->getTitle(),
-						pDocument->getLocation(), pDocument->getType(),
-						pDocument->getLanguage());
-					pHtmlDoc->setData(content, bytes);
-					initialize(pHtmlDoc);
-#ifdef DEBUG
-					cout << "PdfTokenizer::ctor: set " << bytes << " bytes of data" << endl;
-#endif
-
-					delete[] content;
-				}
-			}
-		}
+		// Give the result to the parent class
+		initialize(pOutputDocument);
 	}
-
-	close(outFd);
-	close(inFd);
-
-	if ((unlink(outTemplate) != 0) ||
-		(unlink(inTemplate) != 0))
-	{
-#ifdef DEBUG
-		cerr << "PdfTokenizer::ctor: couldn't delete temporary files" << endl;
-#endif
-	}
 }
 
 PdfTokenizer::PdfTokenizer() :

Modified: trunk/Tokenize/PdfTokenizer.h
===================================================================
--- trunk/Tokenize/PdfTokenizer.h	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/PdfTokenizer.h	2006-01-15 04:16:46 UTC (rev 61)
@@ -31,7 +31,7 @@
   * This returns the MIME type supported by the library's tokenizer.
   * The character string is allocated with new[].
   */
-char *getTokenizerType(void);
+char *getTokenizerType(unsigned int typeNum);
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument);
 

Added: trunk/Tokenize/RtfTokenizer.cpp
===================================================================
--- trunk/Tokenize/RtfTokenizer.cpp	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/RtfTokenizer.cpp	2006-01-15 04:16:46 UTC (rev 61)
@@ -0,0 +1,73 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <string.h>
+#include <iostream>
+
+#include "RtfTokenizer.h"
+
+/**
+  * This returns the MIME type supported by the library's tokenizer.
+  * The character string is allocated with new[].
+  */
+char *getTokenizerType(unsigned int typeNum)
+{
+	if (typeNum == 0)
+	{
+		char *pType = new char[9];
+		strncpy(pType, "text/rtf", 8);
+		pType[8] = '\0';
+		return pType;
+	}
+	else if (typeNum == 1)
+	{
+		char *pType = new char[16];
+		strncpy(pType, "application/rtf", 15);
+		pType[15] = '\0';
+		return pType;
+	}
+
+	return NULL;
+}
+
+/// This returns a pointer to a Tokenizer, allocated with new.
+Tokenizer *getTokenizer(const Document *pDocument)
+{
+	return new RtfTokenizer(pDocument);
+}
+
+RtfTokenizer::RtfTokenizer(const Document *pDocument) :
+	HtmlTokenizer(NULL)
+{
+	string cmdLine("unrtf --nopict --html");
+
+	// Run antiword
+	Document *pOutputDocument = runHelperProgram(pDocument, cmdLine);
+	if (pOutputDocument != NULL)
+	{
+		// Give the result to the parent class
+		initialize(pOutputDocument);
+	}
+}
+
+RtfTokenizer::RtfTokenizer() :
+	HtmlTokenizer()
+{
+}
+
+RtfTokenizer::~RtfTokenizer()
+{
+}

Added: trunk/Tokenize/RtfTokenizer.h
===================================================================
--- trunk/Tokenize/RtfTokenizer.h	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/RtfTokenizer.h	2006-01-15 04:16:46 UTC (rev 61)
@@ -0,0 +1,53 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _RTF_TOKENIZER_H
+#define _RTF_TOKENIZER_H
+
+#include <string>
+#include <map>
+#include <utility>
+#include <set>
+
+#include "Document.h"
+#include "HtmlTokenizer.h"
+
+using namespace std;
+
+/**
+  * This returns the MIME type supported by the library's tokenizer.
+  * The character string is allocated with new[].
+  */
+char *getTokenizerType(unsigned int typeNum);
+/// This returns a pointer to a Tokenizer, allocated with new.
+Tokenizer *getTokenizer(const Document *pDocument);
+
+class RtfTokenizer : public HtmlTokenizer
+{
+	public:
+		RtfTokenizer(const Document *pDocument);
+		virtual ~RtfTokenizer();
+
+	protected:
+		RtfTokenizer();
+
+	private:
+		RtfTokenizer(const RtfTokenizer &other);
+		RtfTokenizer& operator=(const RtfTokenizer& other);
+
+};
+
+#endif // _RTF_TOKENIZER_H

Modified: trunk/Tokenize/Tokenizer.cpp
===================================================================
--- trunk/Tokenize/Tokenizer.cpp	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/Tokenizer.cpp	2006-01-15 04:16:46 UTC (rev 61)
@@ -14,8 +14,11 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
+#include <sys/types.h>
+#include <sys/stat.h>
 #include <ctype.h>
 #include <stdlib.h>
+#include <unistd.h>
 #include <iostream>
 #include <fstream>
 
@@ -33,6 +36,89 @@
 {
 }
 
+Document *Tokenizer::runHelperProgram(const Document *pDocument, const string &cmdLine)
+{
+	Document *pOutputDocument = NULL;
+	char inTemplate[15] = "/tmp/tokXXXXXX";
+	char outTemplate[15] = "/tmp/tokXXXXXX";
+
+	if (cmdLine.empty() == true)
+	{
+		return NULL;
+	}
+
+	int inFd = mkstemp(inTemplate);
+	int outFd = mkstemp(outTemplate);
+	if ((inFd != -1) &&
+		(outFd != -1))
+	{
+		unsigned int dataLength = 0;
+		const char *pData = pDocument->getData(dataLength);
+
+		// Save the data into a temporary file
+		if (write(inFd, (const void*)pData, dataLength) != -1)
+		{
+			string cmdLineRedir(cmdLine);
+			cmdLineRedir += " ";
+			cmdLineRedir += inTemplate;
+			cmdLineRedir += " >";
+			cmdLineRedir += outTemplate;
+			cmdLineRedir += " 2>/dev/null";
+
+			// Run the helper program
+			if (system(cmdLineRedir.c_str()) != -1)
+			{
+				struct stat fileStat;
+
+				// Read the output
+				if ((stat(outTemplate, &fileStat) != -1) &&
+					(S_ISREG(fileStat.st_mode)))
+				{
+					unsigned int total, bytes;
+					char *content = new char[fileStat.st_size + 1];
+
+					total = bytes = read(outFd, (void*)content, fileStat.st_size);
+					while ((bytes > 0) &&
+						(total < fileStat.st_size))
+					{
+						bytes = read(outFd, (void*)content, fileStat.st_size - total);
+						total += bytes;
+					}
+
+					// Pass the result to the parent class
+					pOutputDocument = new Document(pDocument->getTitle(),
+						pDocument->getLocation(), pDocument->getType(),
+						pDocument->getLanguage());
+					pOutputDocument->setData(content, bytes);
+#ifdef DEBUG
+					cout << "Tokenizer::runHelperProgram: set " << bytes
+						<< " bytes of data" << endl;
+#endif
+
+					delete[] content;
+				}
+#ifdef DEBUG
+				else cerr << "Tokenizer::runHelperProgram: "
+					<< cmdLineRedir << " failed" << endl;
+#endif
+			}
+		}
+	}
+
+	close(outFd);
+	close(inFd);
+
+	if ((unlink(outTemplate) != 0) ||
+		(unlink(inTemplate) != 0))
+	{
+#ifdef DEBUG
+		cerr << "Tokenizer::runHelperProgram: couldn't delete temporary files" << endl;
+#endif
+	}
+
+	return pOutputDocument;
+}
+
 void Tokenizer::setDocument(const Document *pDocument)
 {
 	m_pDocument = pDocument;
@@ -122,4 +208,3 @@
 {
 	m_currentPos = 0;
 }
-

Modified: trunk/Tokenize/Tokenizer.h
===================================================================
--- trunk/Tokenize/Tokenizer.h	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/Tokenizer.h	2006-01-15 04:16:46 UTC (rev 61)
@@ -29,6 +29,9 @@
 		Tokenizer(const Document *pDocument);
 		virtual ~Tokenizer();
 
+		/// Converts a document using an helper program.
+		static Document *runHelperProgram(const Document *pDocument, const string &cmdLine);
+
 		/// Returns a pointer to the document being tokenized.
 		virtual const Document *getDocument(void);
 

Modified: trunk/Tokenize/TokenizerFactory.cpp
===================================================================
--- trunk/Tokenize/TokenizerFactory.cpp	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/TokenizerFactory.cpp	2006-01-15 04:16:46 UTC (rev 61)
@@ -32,7 +32,7 @@
 #include "TokenizerFactory.h"
 
 #define GETTOKENIZER		"_Z12getTokenizerPK8Document"
-#define GETTOKENIZERTYPE	"_Z16getTokenizerTypev"
+#define GETTOKENIZERTYPE	"_Z16getTokenizerTypej"
 
 using std::cout;
 using std::endl;
@@ -151,27 +151,39 @@
 					void *pHandle = dlopen(fileName.c_str(), RTLD_LAZY|RTLD_LOCAL);
 					if (pHandle != NULL)
 					{
-						// What type does this support ?
+						// What type(s) does this support ?
 						getTokenizerTypeFunc *pFunc = (getTokenizerTypeFunc *)dlsym(pHandle,
 								GETTOKENIZERTYPE);
 						if (pFunc != NULL)
 						{
-							char *pSupportedType = (*pFunc)();
-							if (pSupportedType != NULL)
+							unsigned int typeNum = 0;
+
+							while (1)
 							{
-								// Add records for this tokenizer
+								char *pSupportedType = (*pFunc)(typeNum);
+								if (pSupportedType == NULL)
+								{
+									break;
+								}
+
+								// Add a record for this tokenizer
 								m_types[pSupportedType] = fileName;
-								m_handles[fileName] = pHandle;
-								++count;
-
 #ifdef DEBUG
 								cout << "TokenizerFactory::loadTokenizers: type "
 									<< pSupportedType << " supported by " << pEntryName << endl;
 #endif
-
 								// It's supposed to have been allocated with new[]
 								delete[] pSupportedType;
+
+								// Next
+								++count;
+								++typeNum;
 							}
+
+							if (typeNum > 0)
+							{
+								m_handles[fileName] = pHandle;
+							}
 						}
 #ifdef DEBUG
 						else cout << "TokenizerFactory::loadTokenizers: couldn't find export getTokenizerType" << endl;

Modified: trunk/Tokenize/TokenizerFactory.h
===================================================================
--- trunk/Tokenize/TokenizerFactory.h	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/TokenizerFactory.h	2006-01-15 04:16:46 UTC (rev 61)
@@ -35,7 +35,7 @@
 		  * This returns the MIME type supported by the library's tokenizer.
 		  * The character string is allocated with new[].
 		  */
-		typedef char *(getTokenizerTypeFunc)(void);
+		typedef char *(getTokenizerTypeFunc)(unsigned int typeNum);
 		/// This returns a pointer to a Tokenizer, allocated with new.
 		typedef Tokenizer *(getTokenizerFunc)(const Document *);
 

Modified: trunk/Tokenize/UnknownTypeTokenizer.cpp
===================================================================
--- trunk/Tokenize/UnknownTypeTokenizer.cpp	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/UnknownTypeTokenizer.cpp	2006-01-15 04:16:46 UTC (rev 61)
@@ -14,10 +14,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <stdlib.h>
-#include <unistd.h>
 #include <iostream>
 
 #include "UnknownTypeTokenizer.h"
@@ -27,71 +23,15 @@
 UnknownTypeTokenizer::UnknownTypeTokenizer(const Document *pDocument) :
 	Tokenizer(NULL)
 {
-	char inTemplate[15] = "/tmp/tokXXXXXX";
-	char outTemplate[15] = "/tmp/tokXXXXXX";
+	string cmdLine("strings --bytes=6");
 
-	int inFd = mkstemp(inTemplate);
-	int outFd = mkstemp(outTemplate);
-	if ((inFd != -1) &&
-		(outFd != -1))
+	// Run strings
+	Document *pOutputDocument = runHelperProgram(pDocument, cmdLine);
+	if (pOutputDocument != NULL)
 	{
-		unsigned int dataLength = 0;
-		const char *pData = pDocument->getData(dataLength);
-
-		// Save the data into a temporary file
-		if (write(inFd, (const void*)pData, dataLength) != -1)
-		{
-			// Run strings against it to extract printable characters
-			string cmdLine = "strings --bytes=6 ";
-			cmdLine += inTemplate;
-			cmdLine += ">";
-			cmdLine += outTemplate;
-			
-			if (system(cmdLine.c_str()) != -1)
-			{
-				struct stat fileStat;
-
-				// Read the output
-				if ((stat(outTemplate, &fileStat) != -1) &&
-					(S_ISREG(fileStat.st_mode)))
-				{
-					unsigned int total, bytes;
-					char *content = new char[fileStat.st_size + 1];
-
-					total = bytes = read(outFd, (void*)content, fileStat.st_size);
-					while ((bytes > 0) &&
-						(total < fileStat.st_size))
-					{
-						bytes = read(outFd, (void*)content, fileStat.st_size - total);
-						total += bytes;
-					}
-
-					// Pass the result to the parent class
-					Document *pStrippedDoc = new Document(pDocument->getTitle(),
-						pDocument->getLocation(), pDocument->getType(),
-						pDocument->getLanguage());
-					pStrippedDoc->setData(content, bytes);
-					setDocument(pStrippedDoc);
-#ifdef DEBUG
-					cout << "UnknownTypeTokenizer::ctor: set " << bytes << " bytes of data" << endl;
-#endif
-
-					delete[] content;
-				}
-			}
-		}
+		// Give the result to the parent class
+		setDocument(pOutputDocument);
 	}
-
-	close(outFd);
-	close(inFd);
-
-	if ((unlink(outTemplate) != 0) ||
-		(unlink(inTemplate) != 0))
-	{
-#ifdef DEBUG
-		cerr << "UnknownTypeTokenizer::ctor: couldn't delete temporary files" << endl;
-#endif
-	}
 }
 
 UnknownTypeTokenizer::~UnknownTypeTokenizer()
@@ -99,7 +39,6 @@
 	if (m_pDocument != NULL)
 	{
 		// This should have been set by setDocument(),
-		// called by the constructor
 		delete m_pDocument;
 	}
 }

Modified: trunk/Tokenize/WordTokenizer.cpp
===================================================================
--- trunk/Tokenize/WordTokenizer.cpp	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/WordTokenizer.cpp	2006-01-15 04:16:46 UTC (rev 61)
@@ -14,10 +14,7 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <stdlib.h>
-#include <unistd.h>
+#include <string.h>
 #include <iostream>
 
 #include "WordTokenizer.h"
@@ -26,14 +23,17 @@
   * This returns the MIME type supported by the library's tokenizer.
   * The character string is allocated with new[].
   */
-char *getTokenizerType(void)
+char *getTokenizerType(unsigned int typeNum)
 {
-	char *pType = new char[16];
+	if (typeNum == 0)
+	{
+		char *pType = new char[16];
+		strncpy(pType, "application/msword", 18);
+		pType[18] = '\0';
+		return pType;
+	}
 
-	strncpy(pType, "application/msword", 18);
-	pType[18] = '\0';
-
-	return pType;
+	return NULL;
 }
 
 /// This returns a pointer to a Tokenizer, allocated with new.
@@ -45,72 +45,15 @@
 WordTokenizer::WordTokenizer(const Document *pDocument) :
 	Tokenizer(NULL)
 {
-	char inTemplate[15] = "/tmp/tokXXXXXX";
-	char outTemplate[15] = "/tmp/tokXXXXXX";
+	string cmdLine("antiword");
 
-	int inFd = mkstemp(inTemplate);
-	int outFd = mkstemp(outTemplate);
-	if ((inFd != -1) &&
-		(outFd != -1))
+	// Run antiword
+	Document *pOutputDocument = runHelperProgram(pDocument, cmdLine);
+	if (pOutputDocument != NULL)
 	{
-		unsigned int dataLength = 0;
-		const char *pData = pDocument->getData(dataLength);
-
-		// Save the data into a temporary file
-		if (write(inFd, (const void*)pData, dataLength) != -1)
-		{
-			// Run antiword to convert it
-			string cmdLine = "antiword ";
-			cmdLine += inTemplate;
-			cmdLine += " >";
-			cmdLine += outTemplate;
-			cmdLine += " 2>/dev/null";
-			
-			if (system(cmdLine.c_str()) != -1)
-			{
-				struct stat fileStat;
-
-				// Read the output
-				if ((stat(outTemplate, &fileStat) != -1) &&
-					(S_ISREG(fileStat.st_mode)))
-				{
-					unsigned int total, bytes;
-					char *content = new char[fileStat.st_size + 1];
-
-					total = bytes = read(outFd, (void*)content, fileStat.st_size);
-					while ((bytes > 0) &&
-						(total < fileStat.st_size))
-					{
-						bytes = read(outFd, (void*)content, fileStat.st_size - total);
-						total += bytes;
-					}
-
-					// Pass the result to the parent class
-					Document *pDoc = new Document(pDocument->getTitle(),
-						pDocument->getLocation(), pDocument->getType(),
-						pDocument->getLanguage());
-					pDoc->setData(content, bytes);
-					setDocument(pDoc);
-#ifdef DEBUG
-					cout << "WordTokenizer::ctor: set " << bytes << " bytes of data" << endl;
-#endif
-
-					delete[] content;
-				}
-			}
-		}
+		// Give the result to the parent class
+		setDocument(pOutputDocument);
 	}
-
-	close(outFd);
-	close(inFd);
-
-	if ((unlink(outTemplate) != 0) ||
-		(unlink(inTemplate) != 0))
-	{
-#ifdef DEBUG
-		cerr << "WordTokenizer::ctor: couldn't delete temporary files" << endl;
-#endif
-	}
 }
 
 WordTokenizer::~WordTokenizer()

Modified: trunk/Tokenize/WordTokenizer.h
===================================================================
--- trunk/Tokenize/WordTokenizer.h	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/Tokenize/WordTokenizer.h	2006-01-15 04:16:46 UTC (rev 61)
@@ -31,7 +31,7 @@
   * This returns the MIME type supported by the library's tokenizer.
   * The character string is allocated with new[].
   */
-char *getTokenizerType(void);
+char *getTokenizerType(unsigned int typeNum);
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument);
 

Modified: trunk/pinot.spec
===================================================================
--- trunk/pinot.spec	2006-01-14 08:59:50 UTC (rev 60)
+++ trunk/pinot.spec	2006-01-15 04:16:46 UTC (rev 61)
@@ -26,24 +26,16 @@
 sources, display as well as analyze and locally index the returned results.
 It may also be used as a lightweight personal space search tool.
 
-%package pdf
-Summary: PDF tokenizer for Pinot that uses pdftohtml
+%package text-docs 
+Summary: Tokenizers for Pinot that handle various text document formats
 Group: Applications/Internet
 Requires: %{name} = %{version}
-Requires: pdftohtml
+Requires: pdftohtml, antiword, unrtf
+Obsoletes: pinot-pdf, pinot-word
 
-%description pdf
-The included tokenizer enables Pinot to index PDF documents.
+%description text-docs 
+The included tokenizers add support for PDF, MS Word and RTF documents.
 
-%package word 
-Summary: MS Word tokenizer for Pinot that uses antiword
-Group: Applications/Internet
-Requires: %{name} = %{version}
-Requires: antiword
-
-%description word
-The included tokenizer enables Pinot to index MS Word documents.
-
 %package omega 
 Summary: Xapian Omega plugin for Pinot
 Group: Applications/Internet
@@ -124,13 +116,11 @@
 %{_datadir}/icons/hicolor/48x48/apps/pinot.png
 %{_datadir}/applications/Amra-%{name}.desktop
 
-%files pdf
+%files text-docs 
 %defattr(-, root, root, -)
 %dir %{_datadir}/pinot/tokenizers/pdf_tokenizer.so
-
-%files word
-%defattr(-, root, root, -)
 %dir %{_datadir}/pinot/tokenizers/word_tokenizer.so
+%dir %{_datadir}/pinot/tokenizers/rtf_tokenizer.so
 
 %files omega
 %defattr(-, root, root, -)



From fabricecolin at berlios.de  Mon Jan 16 15:46:06 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 16 Jan 2006 15:46:06 +0100
Subject: [Pinot-svn] r62 - trunk/Search/Plugins
Message-ID: <200601161446.k0GEk6b3010393@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-16 15:46:06 +0100 (Mon, 16 Jan 2006)
New Revision: 62

Modified:
   trunk/Search/Plugins/AskJeeves.src
Log:
Caught up with AskJeeves' output.


Modified: trunk/Search/Plugins/AskJeeves.src
===================================================================
--- trunk/Search/Plugins/AskJeeves.src	2006-01-15 04:16:46 UTC (rev 61)
+++ trunk/Search/Plugins/AskJeeves.src	2006-01-16 14:46:06 UTC (rev 62)
@@ -18,7 +18,7 @@
 resultListStart=""
 resultListEnd=""
 resultItemStart='<div class="m10_0_16">'
-resultItemEnd='Save</a>'
+resultItemEnd='_u" class="'
 >
 
 </SEARCH>



From fabricecolin at berlios.de  Mon Jan 16 15:46:48 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 16 Jan 2006 15:46:48 +0100
Subject: [Pinot-svn] r63 - trunk/Tokenize
Message-ID: <200601161446.k0GEkmP4010471@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-16 15:46:48 +0100 (Mon, 16 Jan 2006)
New Revision: 63

Modified:
   trunk/Tokenize/PdfTokenizer.h
   trunk/Tokenize/RtfTokenizer.h
   trunk/Tokenize/UnknownTypeTokenizer.h
   trunk/Tokenize/WordTokenizer.h
Log:
Cosmetic changes.


Modified: trunk/Tokenize/PdfTokenizer.h
===================================================================
--- trunk/Tokenize/PdfTokenizer.h	2006-01-16 14:46:06 UTC (rev 62)
+++ trunk/Tokenize/PdfTokenizer.h	2006-01-16 14:46:48 UTC (rev 63)
@@ -17,16 +17,9 @@
 #ifndef _PDF_TOKENIZER_H
 #define _PDF_TOKENIZER_H
 
-#include <string>
-#include <map>
-#include <utility>
-#include <set>
-
 #include "Document.h"
 #include "HtmlTokenizer.h"
 
-using namespace std;
-
 /**
   * This returns the MIME type supported by the library's tokenizer.
   * The character string is allocated with new[].

Modified: trunk/Tokenize/RtfTokenizer.h
===================================================================
--- trunk/Tokenize/RtfTokenizer.h	2006-01-16 14:46:06 UTC (rev 62)
+++ trunk/Tokenize/RtfTokenizer.h	2006-01-16 14:46:48 UTC (rev 63)
@@ -17,16 +17,9 @@
 #ifndef _RTF_TOKENIZER_H
 #define _RTF_TOKENIZER_H
 
-#include <string>
-#include <map>
-#include <utility>
-#include <set>
-
 #include "Document.h"
 #include "HtmlTokenizer.h"
 
-using namespace std;
-
 /**
   * This returns the MIME type supported by the library's tokenizer.
   * The character string is allocated with new[].

Modified: trunk/Tokenize/UnknownTypeTokenizer.h
===================================================================
--- trunk/Tokenize/UnknownTypeTokenizer.h	2006-01-16 14:46:06 UTC (rev 62)
+++ trunk/Tokenize/UnknownTypeTokenizer.h	2006-01-16 14:46:48 UTC (rev 63)
@@ -19,8 +19,6 @@
 
 #include "Tokenizer.h"
 
-using namespace std;
-
 class UnknownTypeTokenizer : public Tokenizer
 {
 	public:

Modified: trunk/Tokenize/WordTokenizer.h
===================================================================
--- trunk/Tokenize/WordTokenizer.h	2006-01-16 14:46:06 UTC (rev 62)
+++ trunk/Tokenize/WordTokenizer.h	2006-01-16 14:46:48 UTC (rev 63)
@@ -17,16 +17,9 @@
 #ifndef _WORD_TOKENIZER_H
 #define _WORD_TOKENIZER_H
 
-#include <string>
-#include <map>
-#include <utility>
-#include <set>
-
 #include "Document.h"
 #include "Tokenizer.h"
 
-using namespace std;
-
 /**
   * This returns the MIME type supported by the library's tokenizer.
   * The character string is allocated with new[].



From fabricecolin at berlios.de  Thu Jan 19 01:31:14 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 19 Jan 2006 01:31:14 +0100
Subject: [Pinot-svn] r64 - in trunk: Index UI/GTK2/src Utils
Message-ID: <200601190031.k0J0VEvA031839@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-19 01:31:09 +0100 (Thu, 19 Jan 2006)
New Revision: 64

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/Utils/MIMEScanner.cpp
   trunk/Utils/Url.cpp
Log:
Indexing a document may change its location property. Make sure the view page
is shown when viewing a freshly downloaded document. Some tweaks for URLs.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-01-16 14:46:48 UTC (rev 63)
+++ trunk/Index/XapianIndex.cpp	2006-01-19 00:31:09 UTC (rev 64)
@@ -170,7 +170,7 @@
 	Url urlObj(location);
 
 	// Index the full URL with prefix U
-	doc.add_term(limitTermLength(string("U") + Url::canonicalizeUrl(location)));
+	doc.add_term(limitTermLength(string("U") + location));
 	// ...the host name with prefix H
 	string hostName = urlObj.getHost();
 	doc.add_term(limitTermLength(string("H") + StringManip::toLowerCase(hostName)));
@@ -351,6 +351,7 @@
 		DocumentInfo docInfo(pDocument->getTitle(), pDocument->getLocation(),
 			pDocument->getType(), pDocument->getLanguage());
 		docInfo.setTimestamp(pDocument->getTimestamp());
+		docInfo.setLocation(Url::canonicalizeUrl(docInfo.getLocation()));
 
 		string summary = scanDocument(pData, dataLength, docInfo);
 
@@ -613,6 +614,7 @@
 	DocumentInfo docInfo(pDocument->getTitle(), pDocument->getLocation(),
 		pDocument->getType(), pDocument->getLanguage());
 	docInfo.setTimestamp(pDocument->getTimestamp());
+	docInfo.setLocation(Url::canonicalizeUrl(docInfo.getLocation()));
 
 	string summary = scanDocument(pData, dataLength, docInfo);
 

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-01-16 14:46:48 UTC (rev 63)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-01-19 00:31:09 UTC (rev 64)
@@ -123,7 +123,7 @@
 {
 	public:
 		IndexBrowserThread(const std::string &indexName,
-			unsigned int maxDocsCount = 0, unsigned int startDoc = 0);
+			unsigned int maxDocsCount, unsigned int startDoc);
 		~IndexBrowserThread();
 
 		virtual Glib::Thread *start(void);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-16 14:46:48 UTC (rev 63)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-19 00:31:09 UTC (rev 64)
@@ -1012,6 +1012,13 @@
 					ustring viewName = _("View");
 
 					// Is there still a view page ?
+					ViewPage *pViewPage = dynamic_cast<ViewPage*>(get_page(viewName, NotebookPageBox::VIEW_PAGE));
+					if (pViewPage != NULL)
+					{
+						// The page may be hidden
+						pViewPage->show();
+					}
+
 					int pageNum = get_page_number(viewName, NotebookPageBox::VIEW_PAGE);
 					if (pageNum >= 0)
 					{

Modified: trunk/Utils/MIMEScanner.cpp
===================================================================
--- trunk/Utils/MIMEScanner.cpp	2006-01-16 14:46:48 UTC (rev 63)
+++ trunk/Utils/MIMEScanner.cpp	2006-01-19 00:31:09 UTC (rev 64)
@@ -121,7 +121,14 @@
 	string mimeType = scanFileType(urlObj.getFile());
 	if (mimeType.empty() == true)
 	{
-		mimeType = "text/plain";
+		if (urlObj.getProtocol() == "http")
+		{
+			mimeType = "text/html";
+		}
+		else
+		{
+			mimeType = "text/plain";
+		}
 	}
 
 	return mimeType;

Modified: trunk/Utils/Url.cpp
===================================================================
--- trunk/Utils/Url.cpp	2006-01-16 14:46:48 UTC (rev 63)
+++ trunk/Utils/Url.cpp	2006-01-19 00:31:09 UTC (rev 64)
@@ -186,8 +186,15 @@
 
 	if (urlObj.isLocal() == false)
 	{
-		// Lower-case it all
-		canonicalUrl = StringManip::toLowerCase(url);
+		string host = urlObj.getHost();
+
+		// Lower-case the host name
+		string::size_type pos = canonicalUrl.find(host);
+		if (pos != string::npos)
+		{
+			canonicalUrl.replace(pos, host.length(), StringManip::toLowerCase(host));
+		}
+		canonicalUrl = escapeUrl(canonicalUrl);;
 	}
 
 	// Get rid of the last directory's slash



From fabricecolin at berlios.de  Thu Jan 19 13:51:18 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 19 Jan 2006 13:51:18 +0100
Subject: [Pinot-svn] r65 - in trunk: . UI/GTK2
Message-ID: <200601191251.k0JCpIDO007505@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-19 13:51:04 +0100 (Thu, 19 Jan 2006)
New Revision: 65

Modified:
   trunk/README
   trunk/TODO
   trunk/UI/GTK2/config.h
   trunk/index.html
   trunk/pinot.spec
Log:
Refreshed docs, bumped version number to 0.40 in preparation for release.


Modified: trunk/README
===================================================================
--- trunk/README	2006-01-19 00:31:09 UTC (rev 64)
+++ trunk/README	2006-01-19 12:51:04 UTC (rev 65)
@@ -15,7 +15,7 @@
 SQLite							sqlite-devel-3.1.2-1
 http://www.sqlite.org/
 
-xapian-core						xapian-core-devel-0.9.0-1
+xapian-core						xapian-core-devel-0.9.2-1
 http://www.xapian.org/
 
 neon							neon-devel-0.24.7-4
@@ -70,7 +70,7 @@
 http://home.wtal.de/petig/Gtk/index.html
 
 (1) enabled with 'make HAS_GOOGLEAPI=yes'
-(2) enabled with 'make HAS_OSAPI=yes'
+(2) enabled with 'make HAS_OSAPI=yes' (now defunct ?)
 (3) or libxml++ 0.26 if HAS_LIBXMLPP026 is defined
 (4) >= 0.1.6 and a recent kernel are required for the inotify backend
 (5) for building only

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2006-01-19 00:31:09 UTC (rev 64)
+++ trunk/TODO	2006-01-19 12:51:04 UTC (rev 65)
@@ -35,6 +35,7 @@
 - Support for HTML frames
 - Allow to cache documents that had to be converted ? eg PDF, MS Word
 - Use poppler for the PDF tokenizer
+- Write a basic XML tokenizer that skips tags
 
 Index
 - Get hold of stopwords lists for the languages supported by Xapian's stemmers and don't index stop words
@@ -43,8 +44,6 @@
 - Interface with libtranslate (http://www.nongnu.org/libtranslate/) ? :-)
 - Xapian lock files can be deleted at startup if no other instance is running
 - Play around with the XAPIAN_FLUSH_THRESHOLD env var
-- Catch DatabaseModifiedError exceptions, call reopen()
-- Sort index/database back-end, don't replicate what's in the configuration file, etc...
 - Switch to Xapian's new Flint back-end (set XAPIAN_PREFER_FLINT=1)
 - Write a back-end for CLucene (http://clucene.sourceforge.net/)
 - Flush the index before searching not after modification
@@ -94,8 +93,10 @@
 - Update Last Run after the query has completed
 - Add a Recent Import section that relies on documents timestamps
 - Filter documents by language, similarly to how labels are shown
-- Save query expander and extract field status in config file
+- Save engines groups state in config file
 - Enable to save live queries
 - Clean up method names
 - Prefer ustring to string whenever possible
-- Extend query completion based on a dictionary (use libsexymm's SpellEntry ?)
+- Closing when threads are running gives the impression Pinot has crashed; how do we tell the user
+  we are waiting for something to finish ?
+

Modified: trunk/UI/GTK2/config.h
===================================================================
--- trunk/UI/GTK2/config.h	2006-01-19 00:31:09 UTC (rev 64)
+++ trunk/UI/GTK2/config.h	2006-01-19 12:51:04 UTC (rev 65)
@@ -76,16 +76,16 @@
 #define PACKAGE_NAME "Pinot"
 
 /* Define to the full name and version of this package. */
-#define PACKAGE_STRING "Pinot v0.35"
+#define PACKAGE_STRING "Pinot v0.40"
 
 /* Define to the one symbol short name of this package. */
-#define PACKAGE_TARNAME "pinot-0.35.tar.gz"
+#define PACKAGE_TARNAME "pinot-0.40.tar.gz"
 
 /* Define to the version of this package. */
-#define PACKAGE_VERSION "0.35"
+#define PACKAGE_VERSION "0.40"
 
 /* Define to 1 if you have the ANSI C header files. */
 #define STDC_HEADERS 1
 
 /* Version number of package */
-#define VERSION "0.35"
+#define VERSION "0.40"

Modified: trunk/index.html
===================================================================
--- trunk/index.html	2006-01-19 00:31:09 UTC (rev 64)
+++ trunk/index.html	2006-01-19 12:51:04 UTC (rev 65)
@@ -14,17 +14,12 @@
 
 <tr>
 <td colspan="3" align="center">
-The official Pinot <a href="http://pinot.berlios.de/">web site</a>.
+Visit the
+<a href="http://pinot.berlios.de/">web site</a> hosted by BerliOS.
 </td>
 </tr>
 
 <tr>
-<td colspan="3" align="center">
-Pinot is powered by <a href="http://www.xapian.org/">Xapian</a>.<br>
-</td>
-</tr>
-
-<tr>
 <td valign="top" align="center">
 <img src="xapian-powered.png" alt="Powered By Xapian Logo" width="208" height="30">
 </td>

Modified: trunk/pinot.spec
===================================================================
--- trunk/pinot.spec	2006-01-19 00:31:09 UTC (rev 64)
+++ trunk/pinot.spec	2006-01-19 12:51:04 UTC (rev 65)
@@ -3,7 +3,7 @@
 
 Summary: Metasearch tool
 Name: pinot
-Version: 0.35
+Version: 0.40
 Release: 1
 License: GPL
 Group: Applications/Internet 
@@ -11,8 +11,8 @@
 Patch0: libxmlpp026.patch
 URL: http://pinot.berlios.de/
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
-Requires: xapian-core-libs >= 0.9.0, neon >= 0.24, gtkmm24 >= 2.6, mozilla >= %{mozilla_ver}, sqlite >= 3.1.2, ots >= 0.4.2, libtextcat >= 2.2, fam >= 2.6.10, gmime >= 2.1, file
-BuildRequires: xapian-core-devel >= 0.9.0, neon-devel >= 0.24, gtkmm24-devel >= 2.6, mozilla-devel >= %{mozilla_ver}, sqlite-devel >= 3.1.2, ots-devel >= 0.4.2, libtextcat-devel >= 2.2, fam-devel >= 2.6.10, gmime-devel >= 2.1, file, boost-devel >= 1.32, desktop-file-utils
+Requires: xapian-core-libs >= 0.9.2, neon >= 0.24, gtkmm24 >= 2.6, mozilla >= %{mozilla_ver}, sqlite >= 3.1.2, ots >= 0.4.2, libtextcat >= 2.2, fam >= 2.6.10, gmime >= 2.1, file
+BuildRequires: xapian-core-devel >= 0.9.2, neon-devel >= 0.24, gtkmm24-devel >= 2.6, mozilla-devel >= %{mozilla_ver}, sqlite-devel >= 3.1.2, ots-devel >= 0.4.2, libtextcat-devel >= 2.2, fam-devel >= 2.6.10, gmime-devel >= 2.1, file, boost-devel >= 1.32, desktop-file-utils
 %if 0%{?_with_libxmlpp026:1}
 Requires: libxml++ >= 0.26
 BuildRequires: libxml++-devel >= 0.26



From fabricecolin at berlios.de  Thu Jan 19 14:32:10 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 19 Jan 2006 14:32:10 +0100
Subject: [Pinot-svn] r66 - in trunk: Index UI/GTK2 UI/GTK2/src Utils po
Message-ID: <200601191332.k0JDWAtF029339@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-19 14:32:09 +0100 (Thu, 19 Jan 2006)
New Revision: 66

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/Index/XapianIndex.h
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/indexDialog.cc
   trunk/UI/GTK2/src/prefsDialog_glade.cc
   trunk/UI/GTK2/src/propertiesDialog_glade.cc
   trunk/Utils/StringManip.cpp
   trunk/Utils/StringManip.h
   trunk/po/en_GB.po
   trunk/po/fr_FR.po
Log:
At indexing time, we may have to hash the URL to guarantee it's unique as it's
limited in length just like other terms. Changed a couple of labels in the UI,
synced the po files with the current source.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/Index/XapianIndex.cpp	2006-01-19 13:32:09 UTC (rev 66)
@@ -39,7 +39,7 @@
 using std::set;
 
 // This puts a limit to terms length.
-const unsigned int XapianIndex::m_maxTermLength = 64;
+const unsigned int XapianIndex::m_maxTermLength = 128;
 const string XapianIndex::MAGIC_TERM = "X-MetaSE-Doc";
 
 XapianIndex::XapianIndex(const string &indexName) :
@@ -62,11 +62,23 @@
 {
 }
 
-string XapianIndex::limitTermLength(const string &term)
+string XapianIndex::limitTermLength(const string &term, bool makeUnique)
 {
 	if (term.length() > XapianIndex::m_maxTermLength)
 	{
-		return term.substr(0, XapianIndex::m_maxTermLength);
+		if (makeUnique == false)
+		{
+			// Truncate
+			return term.substr(0, XapianIndex::m_maxTermLength);
+		}
+		else
+		{
+			string base(term.substr(0, XapianIndex::m_maxTermLength - 30));
+
+			base += StringManip::hashString(term);
+
+			return base;
+		}
 	}
 
 	return term;
@@ -170,15 +182,15 @@
 	Url urlObj(location);
 
 	// Index the full URL with prefix U
-	doc.add_term(limitTermLength(string("U") + location));
+	doc.add_term(limitTermLength(string("U") + location, true));
 	// ...the host name with prefix H
 	string hostName = urlObj.getHost();
-	doc.add_term(limitTermLength(string("H") + StringManip::toLowerCase(hostName)));
+	doc.add_term(limitTermLength(string("H") + StringManip::toLowerCase(hostName), true));
 	// ...and the file name with prefix F
 	string fileName = urlObj.getFile();
-	doc.add_term(limitTermLength(string("F") + StringManip::toLowerCase(fileName)));
+	doc.add_term(limitTermLength(string("F") + StringManip::toLowerCase(fileName), true));
 	// Finally, add the language with prefix L
-	doc.add_term(limitTermLength(string("L") + StringManip::toLowerCase(m_stemLanguage)));
+	doc.add_term(string("L") + StringManip::toLowerCase(m_stemLanguage));
 
 	setDocumentData(doc, info, summary, m_stemLanguage);
 
@@ -784,7 +796,7 @@
 		Xapian::Database *pIndex = pDatabase->readLock();
 		if (pIndex != NULL)
 		{
-			string term(string("U") + Url::canonicalizeUrl(url));
+			string term = limitTermLength(string("U") + Url::canonicalizeUrl(url), true);
 
 			// Get documents that have this term
 			Xapian::PostingIterator postingIter = pIndex->postlist_begin(term);

Modified: trunk/Index/XapianIndex.h
===================================================================
--- trunk/Index/XapianIndex.h	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/Index/XapianIndex.h	2006-01-19 13:32:09 UTC (rev 66)
@@ -94,7 +94,7 @@
 		std::string m_databaseName;
 		std::string m_stemLanguage;
 
-		static std::string limitTermLength(const std::string &term);
+		static std::string limitTermLength(const std::string &term, bool makeUnique = false);
 
 		static bool badField(const std::string &field);
 

Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-01-19 13:32:09 UTC (rev 66)
@@ -1053,7 +1053,7 @@
 		<widget class="GtkLabel" id="apiKeyLabel">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">Google API Key:</property>
+		  <property name="label" translatable="yes">Google API key:</property>
 		  <property name="use_underline">False</property>
 		  <property name="use_markup">False</property>
 		  <property name="justify">GTK_JUSTIFY_LEFT</property>
@@ -2868,7 +2868,7 @@
 		<widget class="GtkLabel" id="typeLabel">
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">Type:</property>
+		  <property name="label" translatable="yes">MIME type:</property>
 		  <property name="use_underline">False</property>
 		  <property name="use_markup">False</property>
 		  <property name="justify">GTK_JUSTIFY_LEFT</property>

Modified: trunk/UI/GTK2/src/indexDialog.cc
===================================================================
--- trunk/UI/GTK2/src/indexDialog.cc	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/UI/GTK2/src/indexDialog.cc	2006-01-19 13:32:09 UTC (rev 66)
@@ -216,34 +216,8 @@
 
 void indexDialog::on_typeCombobox_changed()
 {
-	bool startsWithSlash = false, isLocal = false;
+	checkFields();
 
-	ustring location = locationEntry->get_text();
-	if ((location.empty() == false) &&
-		(location[0] == '/'))
-	{
-		startsWithSlash = true;
-	}
-
-	// Enable the browser entry field and button only if browsing is enabled
-	if (typeCombobox->get_active_row_number() == 1)
-	{
-		// Remote index
-		portSpinbutton->set_sensitive(true);
-		locationButton->set_sensitive(false);
-	}
-	else
-	{
-		// Local index
-		portSpinbutton->set_sensitive(false);
-		locationButton->set_sensitive(true);
-		isLocal = true;
-	}
-
-	if (startsWithSlash != isLocal)
-	{
-		indexOkbutton->set_sensitive(false);
-	}
 }
 
 void indexDialog::on_nameEntry_changed()

Modified: trunk/UI/GTK2/src/prefsDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog_glade.cc	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/UI/GTK2/src/prefsDialog_glade.cc	2006-01-19 13:32:09 UTC (rev 66)
@@ -62,7 +62,7 @@
    Gtk::Label *robotsLabel = Gtk::manage(new class Gtk::Label(_("HTTP crawling:")));
    Gtk::Label *viewLabel = Gtk::manage(new class Gtk::Label(_("View documents:")));
    Gtk::Label *browserLabel = Gtk::manage(new class Gtk::Label(_("Browser:")));
-   apiKeyLabel = Gtk::manage(new class Gtk::Label(_("Google API Key:")));
+   apiKeyLabel = Gtk::manage(new class Gtk::Label(_("Google API key:")));
    apiKeyEntry = Gtk::manage(new class Gtk::Entry());
    viewCombobox = Gtk::manage(new class Gtk::ComboBox());
    ignoreRobotsCheckbutton = Gtk::manage(new class Gtk::CheckButton(_("Ignore robots.txt and Robots META tag")));

Modified: trunk/UI/GTK2/src/propertiesDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-01-19 13:32:09 UTC (rev 66)
@@ -65,7 +65,7 @@
    extractLabel = Gtk::manage(new class Gtk::Label(_("Extract:")));
    languageLabel = Gtk::manage(new class Gtk::Label(_("Language:")));
    languageEntry = Gtk::manage(new class Gtk::Entry());
-   typeLabel = Gtk::manage(new class Gtk::Label(_("Type:")));
+   typeLabel = Gtk::manage(new class Gtk::Label(_("MIME type:")));
    typeEntry = Gtk::manage(new class Gtk::Entry());
    
    Gtk::Table *propertiesTable = Gtk::manage(new class Gtk::Table(2, 2, false));

Modified: trunk/Utils/StringManip.cpp
===================================================================
--- trunk/Utils/StringManip.cpp	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/Utils/StringManip.cpp	2006-01-19 13:32:09 UTC (rev 66)
@@ -176,7 +176,7 @@
 }
 
 /// Hashes a string.
-string StringManip::hashString(string &str)
+string StringManip::hashString(const string &str)
 {
 	if (str.empty() == true)
 	{

Modified: trunk/Utils/StringManip.h
===================================================================
--- trunk/Utils/StringManip.h	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/Utils/StringManip.h	2006-01-19 13:32:09 UTC (rev 66)
@@ -44,7 +44,7 @@
 		static std::string removeQuotes(const std::string &str);
 
 		/// Hashes a string.
-		static std::string hashString(std::string &str);
+		static std::string hashString(const std::string &str);
 
 	protected:
 		StringManip();

Modified: trunk/po/en_GB.po
===================================================================
--- trunk/po/en_GB.po	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/po/en_GB.po	2006-01-19 13:32:09 UTC (rev 66)
@@ -8,8 +8,8 @@
 msgstr ""
 "Project-Id-Version: pinot 0.35\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-01-10 21:12+0800\n"
-"PO-Revision-Date: 2006-01-10 21:12+0800\n"
+"POT-Creation-Date: 2005-12-08 19:20+0800\n"
+"PO-Revision-Date: 2006-01-19 20:22+0800\n"
 "Last-Translator: Fabrice Colin <colinf at chez.com>\n"
 "Language-Team: en_GB <colinf at chez.com>\n"
 "MIME-Version: 1.0\n"
@@ -26,15 +26,16 @@
 
 #: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:344
 #: UI/GTK2/src/mainWindow.cc:347 UI/GTK2/src/mainWindow.cc:520
-#: UI/GTK2/src/mainWindow.cc:1048 UI/GTK2/src/mainWindow.cc:1150
-#: UI/GTK2/src/mainWindow.cc:1763 UI/GTK2/src/PinotSettings.cpp:199
-#: UI/GTK2/src/PinotSettings.cpp:865 UI/GTK2/src/PinotSettings.cpp:921
+#: UI/GTK2/src/mainWindow.cc:1055 UI/GTK2/src/mainWindow.cc:1139
+#: UI/GTK2/src/mainWindow.cc:1174 UI/GTK2/src/mainWindow.cc:1787
+#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:865
+#: UI/GTK2/src/PinotSettings.cpp:921
 msgid "My Documents"
 msgstr ""
 
 #: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:350
 #: UI/GTK2/src/mainWindow.cc:353 UI/GTK2/src/mainWindow.cc:524
-#: UI/GTK2/src/MonitorHandler.cpp:174 UI/GTK2/src/PinotSettings.cpp:200
+#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:200
 #: UI/GTK2/src/PinotSettings.cpp:866 UI/GTK2/src/PinotSettings.cpp:922
 #: UI/GTK2/src/prefsDialog_glade.cc:116
 msgid "My Email"
@@ -44,7 +45,7 @@
 msgid "Enabled"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:105 UI/GTK2/src/prefsDialog.cc:79
+#: UI/GTK2/src/importDialog.cc:105 UI/GTK2/src/prefsDialog.cc:78
 msgid "MIME Type"
 msgstr ""
 
@@ -56,12 +57,12 @@
 msgid "Directory"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:138 UI/GTK2/src/IndexTree.cpp:71
+#: UI/GTK2/src/importDialog.cc:138 UI/GTK2/src/IndexTree.cpp:70
 #: UI/GTK2/src/ResultsTree.cpp:114
 msgid "URL"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:417
+#: UI/GTK2/src/importDialog.cc:426
 msgid "Document To Import"
 msgstr ""
 
@@ -75,7 +76,6 @@
 msgstr ""
 
 #: UI/GTK2/src/importDialog_glade.cc:70 UI/GTK2/src/indexDialog_glade.cc:67
-#: UI/GTK2/src/propertiesDialog_glade.cc:68
 msgid "Type:"
 msgstr ""
 
@@ -84,15 +84,23 @@
 msgid "..."
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:75
+#: UI/GTK2/src/importDialog_glade.cc:78
 msgid "Depth:"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:86 UI/GTK2/src/mainWindow_glade.cc:201
+#: UI/GTK2/src/importDialog_glade.cc:79
+msgid "Symlinks:"
+msgstr ""
+
+#: UI/GTK2/src/importDialog_glade.cc:80
+msgid "Follow symlinks"
+msgstr ""
+
+#: UI/GTK2/src/importDialog_glade.cc:88 UI/GTK2/src/mainWindow_glade.cc:201
 msgid "Import"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:186
+#: UI/GTK2/src/importDialog_glade.cc:200
 msgid "Import document"
 msgstr ""
 
@@ -112,27 +120,23 @@
 msgid "External index"
 msgstr ""
 
-#: UI/GTK2/src/IndexTree.cpp:65 UI/GTK2/src/ResultsTree.cpp:96
+#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:96
 msgid "Title"
 msgstr ""
 
-#: UI/GTK2/src/IndexTree.cpp:76
+#: UI/GTK2/src/IndexTree.cpp:75
 msgid "Timestamp"
 msgstr ""
 
-#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:530
-msgid "No title"
-msgstr ""
-
-#: UI/GTK2/src/IndexPage.cpp:51
+#: UI/GTK2/src/IndexPage.cpp:50
 msgid "Show Previous"
 msgstr ""
 
-#: UI/GTK2/src/IndexPage.cpp:57
+#: UI/GTK2/src/IndexPage.cpp:56
 msgid "Show Next"
 msgstr ""
 
-#: UI/GTK2/src/IndexPage.cpp:159 UI/GTK2/src/IndexPage.cpp:205
+#: UI/GTK2/src/IndexPage.cpp:158 UI/GTK2/src/IndexPage.cpp:204
 #: UI/GTK2/src/queryDialog.cc:91
 msgid "None"
 msgstr ""
@@ -162,7 +166,7 @@
 msgstr ""
 
 #: UI/GTK2/src/mainWindow.cc:249 UI/GTK2/src/mainWindow.cc:1012
-#: UI/GTK2/src/mainWindow.cc:1360 UI/GTK2/src/mainWindow.cc:2945
+#: UI/GTK2/src/mainWindow.cc:1384 UI/GTK2/src/mainWindow.cc:2967
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr ""
@@ -203,7 +207,7 @@
 msgid "Query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2775
+#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2797
 msgid "on"
 msgstr ""
 
@@ -227,143 +231,143 @@
 msgid "Updated label(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1058 UI/GTK2/src/mainWindow.cc:1161
+#: UI/GTK2/src/mainWindow.cc:1065 UI/GTK2/src/mainWindow.cc:1185
 msgid "Updated document"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1071
+#: UI/GTK2/src/mainWindow.cc:1078
 msgid "Indexed"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1132
+#: UI/GTK2/src/mainWindow.cc:1140
 msgid "Unindexed document(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1212
+#: UI/GTK2/src/mainWindow.cc:1236
 msgid "Couldn't rename index, name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1216 UI/GTK2/src/mainWindow.cc:2119
-#: UI/GTK2/src/mainWindow.cc:2609
+#: UI/GTK2/src/mainWindow.cc:1240 UI/GTK2/src/mainWindow.cc:2141
+#: UI/GTK2/src/mainWindow.cc:2631
 msgid "is already in use"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1229
+#: UI/GTK2/src/mainWindow.cc:1253
 msgid "Couldn't rename index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1242
+#: UI/GTK2/src/mainWindow.cc:1266
 msgid "Edited index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1702 UI/GTK2/src/mainWindow.cc:1805
+#: UI/GTK2/src/mainWindow.cc:1726 UI/GTK2/src/mainWindow.cc:1829
 msgid "Please set a location for the index first"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1729
+#: UI/GTK2/src/mainWindow.cc:1753
 msgid "Result location is unknown"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1753
+#: UI/GTK2/src/mainWindow.cc:1777
 msgid "Import Document(s)"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1883 UI/GTK2/src/pinot.cc:148
+#: UI/GTK2/src/mainWindow.cc:1907 UI/GTK2/src/pinot.cc:148
 #: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:371
-#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1210
+#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1209
 msgid "Index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1887 UI/GTK2/src/WorkerThreads.cpp:375
-#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1214
+#: UI/GTK2/src/mainWindow.cc:1911 UI/GTK2/src/WorkerThreads.cpp:375
+#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1213
 msgid "doesn't exist"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1999
+#: UI/GTK2/src/mainWindow.cc:2021
 msgid "Delete this document from the index ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2018
+#: UI/GTK2/src/mainWindow.cc:2040
 msgid "Delete these documents from the index ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2070
+#: UI/GTK2/src/mainWindow.cc:2092
 msgid "A metasearch tool for the Free Desktop"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2071
+#: UI/GTK2/src/mainWindow.cc:2093
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2115
+#: UI/GTK2/src/mainWindow.cc:2137
 msgid "Index name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2130
+#: UI/GTK2/src/mainWindow.cc:2152
 msgid "Couldn't add index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2144
+#: UI/GTK2/src/mainWindow.cc:2166
 msgid "Added new index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2179
+#: UI/GTK2/src/mainWindow.cc:2201
 msgid "Couldn't remove index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2413
+#: UI/GTK2/src/mainWindow.cc:2435
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2605
+#: UI/GTK2/src/mainWindow.cc:2627
 msgid "Query name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2632
+#: UI/GTK2/src/mainWindow.cc:2654
 msgid "Couldn't update query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2640
+#: UI/GTK2/src/mainWindow.cc:2662
 msgid "Edited query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2647
+#: UI/GTK2/src/mainWindow.cc:2669
 msgid "Couldn't add query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2655
+#: UI/GTK2/src/mainWindow.cc:2677
 msgid "Added new query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2669
+#: UI/GTK2/src/mainWindow.cc:2691
 msgid "Query is not set"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2680
+#: UI/GTK2/src/mainWindow.cc:2702
 msgid "No search engine selected"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2762
+#: UI/GTK2/src/mainWindow.cc:2784
 msgid "Please set the Google API key first"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2771
+#: UI/GTK2/src/mainWindow.cc:2793
 msgid "Running query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2876
+#: UI/GTK2/src/mainWindow.cc:2898
 msgid "is already indexed or is being indexed"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2903
+#: UI/GTK2/src/mainWindow.cc:2925
 msgid "No URL to browse"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2914
+#: UI/GTK2/src/mainWindow.cc:2936
 msgid "No browser configured to view results"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2926
+#: UI/GTK2/src/mainWindow.cc:2948
 msgid "Couldn't browse URL:"
 msgstr ""
 
@@ -565,35 +569,35 @@
 msgid "Unclassified"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:70
+#: UI/GTK2/src/prefsDialog.cc:69
 msgid "Name"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:78
+#: UI/GTK2/src/prefsDialog.cc:77
 msgid "Location"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:115
+#: UI/GTK2/src/prefsDialog.cc:114
 msgid "In internal viewer"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:118
+#: UI/GTK2/src/prefsDialog.cc:117
 msgid "In browser"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:333
+#: UI/GTK2/src/prefsDialog.cc:332
 msgid "Browser location"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:344
+#: UI/GTK2/src/prefsDialog.cc:343
 msgid "New Label"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:366
+#: UI/GTK2/src/prefsDialog.cc:365
 msgid "Colour"
 msgstr ""
 
-#: UI/GTK2/src/prefsDialog.cc:437 UI/GTK2/src/prefsDialog.cc:471
+#: UI/GTK2/src/prefsDialog.cc:436 UI/GTK2/src/prefsDialog.cc:470
 msgid "Mbox File Location"
 msgstr ""
 
@@ -610,7 +614,7 @@
 msgstr ""
 
 #: UI/GTK2/src/prefsDialog_glade.cc:65
-msgid "Google API Key:"
+msgid "Google API key:"
 msgstr ""
 
 #: UI/GTK2/src/prefsDialog_glade.cc:68
@@ -657,6 +661,10 @@
 msgid "Language:"
 msgstr ""
 
+#: UI/GTK2/src/propertiesDialog_glade.cc:68
+msgid "MIME type:"
+msgstr ""
+
 #: UI/GTK2/src/queryDialog.cc:96 UI/GTK2/src/queryDialog.cc:125
 msgid "Any"
 msgstr ""
@@ -719,8 +727,8 @@
 
 #: UI/GTK2/src/WorkerThreads.cpp:384 UI/GTK2/src/WorkerThreads.cpp:620
 #: UI/GTK2/src/WorkerThreads.cpp:665 UI/GTK2/src/WorkerThreads.cpp:675
-#: UI/GTK2/src/WorkerThreads.cpp:893 UI/GTK2/src/WorkerThreads.cpp:1095
-#: UI/GTK2/src/WorkerThreads.cpp:1223
+#: UI/GTK2/src/WorkerThreads.cpp:893 UI/GTK2/src/WorkerThreads.cpp:1094
+#: UI/GTK2/src/WorkerThreads.cpp:1222
 msgid "Index error on"
 msgstr ""
 
@@ -736,6 +744,10 @@
 msgid "Couldn't run query on search engine"
 msgstr ""
 
+#: UI/GTK2/src/WorkerThreads.cpp:530
+msgid "No title"
+msgstr ""
+
 #: UI/GTK2/src/WorkerThreads.cpp:592 UI/GTK2/src/WorkerThreads.cpp:656
 msgid "Stopped querying index labels"
 msgstr ""
@@ -756,66 +768,66 @@
 msgid "Stopped indexing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:932
+#: UI/GTK2/src/WorkerThreads.cpp:931
 msgid "Cannot index document type"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:936
+#: UI/GTK2/src/WorkerThreads.cpp:935
 msgid "at"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:961
+#: UI/GTK2/src/WorkerThreads.cpp:960
 msgid "Couln't tokenize"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:982
+#: UI/GTK2/src/WorkerThreads.cpp:981
 msgid "Robots META tag forbids indexing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1018
+#: UI/GTK2/src/WorkerThreads.cpp:1017
 msgid "Couldn't index"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1083
+#: UI/GTK2/src/WorkerThreads.cpp:1082
 msgid "Stopped unindexing document(s)"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1103
+#: UI/GTK2/src/WorkerThreads.cpp:1102
 msgid "Couldn't unindex document(s)"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1195
+#: UI/GTK2/src/WorkerThreads.cpp:1194
 msgid "Stopped document update for "
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1232
+#: UI/GTK2/src/WorkerThreads.cpp:1231
 msgid "Couldn't update document"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1280
+#: UI/GTK2/src/WorkerThreads.cpp:1279
 msgid "Stopped listening on"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1380
+#: UI/GTK2/src/WorkerThreads.cpp:1379
 msgid "Couldn't read FIFO at"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1428
+#: UI/GTK2/src/WorkerThreads.cpp:1427
 msgid "Stopped monitoring"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1446
+#: UI/GTK2/src/WorkerThreads.cpp:1445
 msgid "No monitoring handler"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1480
+#: UI/GTK2/src/WorkerThreads.cpp:1479
 msgid "Couldn't open FAM connection"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1683
+#: UI/GTK2/src/WorkerThreads.cpp:1693
 msgid "Stopped scanning"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1823
+#: UI/GTK2/src/WorkerThreads.cpp:1851
 msgid "Couldn't open directory"
 msgstr ""

Modified: trunk/po/fr_FR.po
===================================================================
--- trunk/po/fr_FR.po	2006-01-19 12:51:04 UTC (rev 65)
+++ trunk/po/fr_FR.po	2006-01-19 13:32:09 UTC (rev 66)
@@ -8,8 +8,8 @@
 msgstr ""
 "Project-Id-Version: pinot 0.35\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2005-12-30 17:20+0800\n"
-"PO-Revision-Date: 2005-12-30 17:20+0800\n"
+"POT-Creation-Date: 2005-12-08 19:20+0800\n"
+"PO-Revision-Date: 2006-01-19 20:22+0800\n"
 "Last-Translator: Fabrice Colin <colinf at chez.com>\n"
 "Language-Team: en_GB <colinf at chez.com>\n"
 "MIME-Version: 1.0\n"
@@ -26,15 +26,16 @@
 
 #: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:344
 #: UI/GTK2/src/mainWindow.cc:347 UI/GTK2/src/mainWindow.cc:520
-#: UI/GTK2/src/mainWindow.cc:1048 UI/GTK2/src/mainWindow.cc:1150
-#: UI/GTK2/src/mainWindow.cc:1763 UI/GTK2/src/PinotSettings.cpp:199
-#: UI/GTK2/src/PinotSettings.cpp:865 UI/GTK2/src/PinotSettings.cpp:921
+#: UI/GTK2/src/mainWindow.cc:1055 UI/GTK2/src/mainWindow.cc:1139
+#: UI/GTK2/src/mainWindow.cc:1174 UI/GTK2/src/mainWindow.cc:1787
+#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:865
+#: UI/GTK2/src/PinotSettings.cpp:921
 msgid "My Documents"
 msgstr "Mes Documents"
 
 #: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:350
 #: UI/GTK2/src/mainWindow.cc:353 UI/GTK2/src/mainWindow.cc:524
-#: UI/GTK2/src/MonitorHandler.cpp:174 UI/GTK2/src/PinotSettings.cpp:200
+#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:200
 #: UI/GTK2/src/PinotSettings.cpp:866 UI/GTK2/src/PinotSettings.cpp:922
 #: UI/GTK2/src/prefsDialog_glade.cc:116
 msgid "My Email"
@@ -44,7 +45,7 @@
 msgid "Enabled"
 msgstr "Un fichier"
 
-#: UI/GTK2/src/importDialog.cc:105 UI/GTK2/src/prefsDialog.cc:79
+#: UI/GTK2/src/importDialog.cc:105 UI/GTK2/src/prefsDialog.cc:78
 msgid "MIME Type"
 msgstr "Un repertoire"
 
@@ -56,12 +57,12 @@
 msgid "Directory"
 msgstr "Document A Importer"
 
-#: UI/GTK2/src/importDialog.cc:138 UI/GTK2/src/IndexTree.cpp:71
+#: UI/GTK2/src/importDialog.cc:138 UI/GTK2/src/IndexTree.cpp:70
 #: UI/GTK2/src/ResultsTree.cpp:114
 msgid "URL"
 msgstr "Importer"
 
-#: UI/GTK2/src/importDialog.cc:417
+#: UI/GTK2/src/importDialog.cc:426
 msgid "Document To Import"
 msgstr "Selectionner"
 
@@ -75,7 +76,6 @@
 msgstr "Titre:"
 
 #: UI/GTK2/src/importDialog_glade.cc:70 UI/GTK2/src/indexDialog_glade.cc:67
-#: UI/GTK2/src/propertiesDialog_glade.cc:68
 msgid "Type:"
 msgstr "Type:"
 
@@ -84,15 +84,23 @@
 msgid "..."
 msgstr "..."
 
-#: UI/GTK2/src/importDialog_glade.cc:75
+#: UI/GTK2/src/importDialog_glade.cc:78
 msgid "Depth:"
 msgstr "Profondeur:"
 
-#: UI/GTK2/src/importDialog_glade.cc:86 UI/GTK2/src/mainWindow_glade.cc:201
+#: UI/GTK2/src/importDialog_glade.cc:79
+msgid "Symlinks:"
+msgstr "Liens:"
+
+#: UI/GTK2/src/importDialog_glade.cc:80
+msgid "Follow symlinks"
+msgstr "Suivre les liens symboliques"
+
+#: UI/GTK2/src/importDialog_glade.cc:88 UI/GTK2/src/mainWindow_glade.cc:201
 msgid "Import"
 msgstr "Importer"
 
-#: UI/GTK2/src/importDialog_glade.cc:186
+#: UI/GTK2/src/importDialog_glade.cc:200
 msgid "Import document"
 msgstr "Importation de document"
 
@@ -112,27 +120,23 @@
 msgid "External index"
 msgstr "Index externe"
 
-#: UI/GTK2/src/IndexTree.cpp:65 UI/GTK2/src/ResultsTree.cpp:96
+#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:96
 msgid "Title"
 msgstr "Titre"
 
-#: UI/GTK2/src/IndexTree.cpp:76
+#: UI/GTK2/src/IndexTree.cpp:75
 msgid "Timestamp"
 msgstr "Date"
 
-#: UI/GTK2/src/IndexTree.cpp:212 UI/GTK2/src/WorkerThreads.cpp:530
-msgid "No title"
-msgstr "Pas de titre"
-
-#: UI/GTK2/src/IndexPage.cpp:51
+#: UI/GTK2/src/IndexPage.cpp:50
 msgid "Show Previous"
 msgstr "Precedents"
 
-#: UI/GTK2/src/IndexPage.cpp:57
+#: UI/GTK2/src/IndexPage.cpp:56
 msgid "Show Next"
 msgstr "Suivants"
 
-#: UI/GTK2/src/IndexPage.cpp:159 UI/GTK2/src/IndexPage.cpp:205
+#: UI/GTK2/src/IndexPage.cpp:158 UI/GTK2/src/IndexPage.cpp:204
 #: UI/GTK2/src/queryDialog.cc:91
 msgid "None"
 msgstr "Aucune"
@@ -162,7 +166,7 @@
 msgstr "Pret"
 
 #: UI/GTK2/src/mainWindow.cc:249 UI/GTK2/src/mainWindow.cc:1012
-#: UI/GTK2/src/mainWindow.cc:1360 UI/GTK2/src/mainWindow.cc:2945
+#: UI/GTK2/src/mainWindow.cc:1384 UI/GTK2/src/mainWindow.cc:2967
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr "Voir"
@@ -203,7 +207,7 @@
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2775
+#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2797
 msgid "on"
 msgstr "sur"
 
@@ -227,143 +231,143 @@
 msgid "Updated label(s)"
 msgstr "Mis a jour l(es) etiquette(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1058 UI/GTK2/src/mainWindow.cc:1161
+#: UI/GTK2/src/mainWindow.cc:1065 UI/GTK2/src/mainWindow.cc:1185
 msgid "Updated document"
 msgstr "Mis a jour le document"
 
-#: UI/GTK2/src/mainWindow.cc:1071
+#: UI/GTK2/src/mainWindow.cc:1078
 msgid "Indexed"
 msgstr "Indexe"
 
-#: UI/GTK2/src/mainWindow.cc:1132
+#: UI/GTK2/src/mainWindow.cc:1140
 msgid "Unindexed document(s)"
 msgstr "Desindexe le(s) document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1212
+#: UI/GTK2/src/mainWindow.cc:1236
 msgid "Couldn't rename index, name"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1216 UI/GTK2/src/mainWindow.cc:2119
-#: UI/GTK2/src/mainWindow.cc:2609
+#: UI/GTK2/src/mainWindow.cc:1240 UI/GTK2/src/mainWindow.cc:2141
+#: UI/GTK2/src/mainWindow.cc:2631
 msgid "is already in use"
 msgstr "est deja utilise"
 
-#: UI/GTK2/src/mainWindow.cc:1229
+#: UI/GTK2/src/mainWindow.cc:1253
 msgid "Couldn't rename index"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1242
+#: UI/GTK2/src/mainWindow.cc:1266
 msgid "Edited index"
 msgstr "Edite l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1702 UI/GTK2/src/mainWindow.cc:1805
+#: UI/GTK2/src/mainWindow.cc:1726 UI/GTK2/src/mainWindow.cc:1829
 msgid "Please set a location for the index first"
 msgstr "Donnez une location a l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1729
+#: UI/GTK2/src/mainWindow.cc:1753
 msgid "Result location is unknown"
 msgstr "La location du resultat est inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:1753
+#: UI/GTK2/src/mainWindow.cc:1777
 msgid "Import Document(s)"
 msgstr "Importation de Document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1883 UI/GTK2/src/pinot.cc:148
+#: UI/GTK2/src/mainWindow.cc:1907 UI/GTK2/src/pinot.cc:148
 #: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:371
-#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1210
+#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1209
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:1887 UI/GTK2/src/WorkerThreads.cpp:375
-#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1214
+#: UI/GTK2/src/mainWindow.cc:1911 UI/GTK2/src/WorkerThreads.cpp:375
+#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1213
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
-#: UI/GTK2/src/mainWindow.cc:1999
+#: UI/GTK2/src/mainWindow.cc:2021
 msgid "Delete this document from the index ?"
 msgstr "Enlever ce document de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2018
+#: UI/GTK2/src/mainWindow.cc:2040
 msgid "Delete these documents from the index ?"
 msgstr "Enlever ces documents de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2070
+#: UI/GTK2/src/mainWindow.cc:2092
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Un outil de recherche pour le Bureau Libre"
 
-#: UI/GTK2/src/mainWindow.cc:2071
+#: UI/GTK2/src/mainWindow.cc:2093
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2115
+#: UI/GTK2/src/mainWindow.cc:2137
 msgid "Index name"
 msgstr "Nom de l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2130
+#: UI/GTK2/src/mainWindow.cc:2152
 msgid "Couldn't add index"
 msgstr "N'a pas pu ajouter l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2144
+#: UI/GTK2/src/mainWindow.cc:2166
 msgid "Added new index"
 msgstr "Ajouter un nouvel index"
 
-#: UI/GTK2/src/mainWindow.cc:2179
+#: UI/GTK2/src/mainWindow.cc:2201
 msgid "Couldn't remove index"
 msgstr "N'a pas pu enlever l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2413
+#: UI/GTK2/src/mainWindow.cc:2435
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2605
+#: UI/GTK2/src/mainWindow.cc:2627
 msgid "Query name"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2632
+#: UI/GTK2/src/mainWindow.cc:2654
 msgid "Couldn't update query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2640
+#: UI/GTK2/src/mainWindow.cc:2662
 msgid "Edited query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2647
+#: UI/GTK2/src/mainWindow.cc:2669
 msgid "Couldn't add query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2655
+#: UI/GTK2/src/mainWindow.cc:2677
 msgid "Added new query"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2669
+#: UI/GTK2/src/mainWindow.cc:2691
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2680
+#: UI/GTK2/src/mainWindow.cc:2702
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:2762
+#: UI/GTK2/src/mainWindow.cc:2784
 msgid "Please set the Google API key first"
 msgstr "Configurez la clef de l'API Google "
 
-#: UI/GTK2/src/mainWindow.cc:2771
+#: UI/GTK2/src/mainWindow.cc:2793
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:2876
+#: UI/GTK2/src/mainWindow.cc:2898
 msgid "is already indexed or is being indexed"
 msgstr "est deja indexe ou est en cours d'indexation"
 
-#: UI/GTK2/src/mainWindow.cc:2903
+#: UI/GTK2/src/mainWindow.cc:2925
 msgid "No URL to browse"
 msgstr "Pas d'URL a brouter"
 
-#: UI/GTK2/src/mainWindow.cc:2914
+#: UI/GTK2/src/mainWindow.cc:2936
 msgid "No browser configured to view results"
 msgstr "Pas de brouter configure"
 
-#: UI/GTK2/src/mainWindow.cc:2926
+#: UI/GTK2/src/mainWindow.cc:2948
 msgid "Couldn't browse URL:"
 msgstr "N'a pas pu brouter l'URL"
 
@@ -565,35 +569,35 @@
 msgid "Unclassified"
 msgstr "Non classifie"
 
-#: UI/GTK2/src/prefsDialog.cc:70
+#: UI/GTK2/src/prefsDialog.cc:69
 msgid "Name"
 msgstr "Nom"
 
-#: UI/GTK2/src/prefsDialog.cc:78
+#: UI/GTK2/src/prefsDialog.cc:77
 msgid "Location"
 msgstr "Location"
 
-#: UI/GTK2/src/prefsDialog.cc:115
+#: UI/GTK2/src/prefsDialog.cc:114
 msgid "In internal viewer"
 msgstr "Dans le brouteur interne"
 
-#: UI/GTK2/src/prefsDialog.cc:118
+#: UI/GTK2/src/prefsDialog.cc:117
 msgid "In browser"
 msgstr "Dans le brouteur"
 
-#: UI/GTK2/src/prefsDialog.cc:333
+#: UI/GTK2/src/prefsDialog.cc:332
 msgid "Browser location"
 msgstr "Brouter la location"
 
-#: UI/GTK2/src/prefsDialog.cc:344
+#: UI/GTK2/src/prefsDialog.cc:343
 msgid "New Label"
 msgstr "Nouvelle Etiquette"
 
-#: UI/GTK2/src/prefsDialog.cc:366
+#: UI/GTK2/src/prefsDialog.cc:365
 msgid "Colour"
 msgstr "Couleur"
 
-#: UI/GTK2/src/prefsDialog.cc:437 UI/GTK2/src/prefsDialog.cc:471
+#: UI/GTK2/src/prefsDialog.cc:436 UI/GTK2/src/prefsDialog.cc:470
 msgid "Mbox File Location"
 msgstr "Location du Fichier mbox"
 
@@ -610,7 +614,7 @@
 msgstr "Brouteur:"
 
 #: UI/GTK2/src/prefsDialog_glade.cc:65
-msgid "Google API Key:"
+msgid "Google API key:"
 msgstr "Clef de l'API Google"
 
 #: UI/GTK2/src/prefsDialog_glade.cc:68
@@ -657,6 +661,10 @@
 msgid "Language:"
 msgstr "Langue:"
 
+#: UI/GTK2/src/propertiesDialog_glade.cc:68
+msgid "MIME type:"
+msgstr "Type MIME:"
+
 #: UI/GTK2/src/queryDialog.cc:96 UI/GTK2/src/queryDialog.cc:125
 msgid "Any"
 msgstr "N'importe"
@@ -719,8 +727,8 @@
 
 #: UI/GTK2/src/WorkerThreads.cpp:384 UI/GTK2/src/WorkerThreads.cpp:620
 #: UI/GTK2/src/WorkerThreads.cpp:665 UI/GTK2/src/WorkerThreads.cpp:675
-#: UI/GTK2/src/WorkerThreads.cpp:893 UI/GTK2/src/WorkerThreads.cpp:1095
-#: UI/GTK2/src/WorkerThreads.cpp:1223
+#: UI/GTK2/src/WorkerThreads.cpp:893 UI/GTK2/src/WorkerThreads.cpp:1094
+#: UI/GTK2/src/WorkerThreads.cpp:1222
 msgid "Index error on"
 msgstr "Erreur d'index sur"
 
@@ -736,6 +744,10 @@
 msgid "Couldn't run query on search engine"
 msgstr "N'a pas pu lancer la recherche sur le moteur"
 
+#: UI/GTK2/src/WorkerThreads.cpp:530
+msgid "No title"
+msgstr "Pas de titre"
+
 #: UI/GTK2/src/WorkerThreads.cpp:592 UI/GTK2/src/WorkerThreads.cpp:656
 msgid "Stopped querying index labels"
 msgstr "Arrete la recherche d'etiquettes"
@@ -756,66 +768,66 @@
 msgid "Stopped indexing"
 msgstr "Arrete l'indexation"
 
-#: UI/GTK2/src/WorkerThreads.cpp:932
+#: UI/GTK2/src/WorkerThreads.cpp:931
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer de type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:936
+#: UI/GTK2/src/WorkerThreads.cpp:935
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:961
+#: UI/GTK2/src/WorkerThreads.cpp:960
 msgid "Couln't tokenize"
 msgstr "N'a pas pu tokenise"
 
-#: UI/GTK2/src/WorkerThreads.cpp:982
+#: UI/GTK2/src/WorkerThreads.cpp:981
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots empeche d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1018
+#: UI/GTK2/src/WorkerThreads.cpp:1017
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1083
+#: UI/GTK2/src/WorkerThreads.cpp:1082
 msgid "Stopped unindexing document(s)"
 msgstr "Arrete d'indexer les document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1103
+#: UI/GTK2/src/WorkerThreads.cpp:1102
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1195
+#: UI/GTK2/src/WorkerThreads.cpp:1194
 msgid "Stopped document update for "
 msgstr "Arrete la mise a jour pour "
 
-#: UI/GTK2/src/WorkerThreads.cpp:1232
+#: UI/GTK2/src/WorkerThreads.cpp:1231
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1280
+#: UI/GTK2/src/WorkerThreads.cpp:1279
 msgid "Stopped listening on"
 msgstr "Arrete l'ecoute sur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1380
+#: UI/GTK2/src/WorkerThreads.cpp:1379
 msgid "Couldn't read FIFO at"
 msgstr "N'a pas pu lire la FIFO a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1428
+#: UI/GTK2/src/WorkerThreads.cpp:1427
 msgid "Stopped monitoring"
 msgstr "Arrete la surveillance"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1446
+#: UI/GTK2/src/WorkerThreads.cpp:1445
 msgid "No monitoring handler"
 msgstr "Pas de moniteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1480
+#: UI/GTK2/src/WorkerThreads.cpp:1479
 msgid "Couldn't open FAM connection"
 msgstr "N'a pas pu ouvrir la connection FAM"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1683
+#: UI/GTK2/src/WorkerThreads.cpp:1693
 msgid "Stopped scanning"
 msgstr "Arrete de scanner"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1823
+#: UI/GTK2/src/WorkerThreads.cpp:1851
 msgid "Couldn't open directory"
 msgstr "N'a pas pu ovrir le repertoire"



From fabricecolin at berlios.de  Thu Jan 19 16:44:56 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 19 Jan 2006 16:44:56 +0100
Subject: [Pinot-svn] r67 - trunk/UI/GTK2/src
Message-ID: <200601191544.k0JFiuCZ013735@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-19 16:44:56 +0100 (Thu, 19 Jan 2006)
New Revision: 67

Modified:
   trunk/UI/GTK2/src/indexDialog.cc
Log:
Fix for previous check-in.


Modified: trunk/UI/GTK2/src/indexDialog.cc
===================================================================
--- trunk/UI/GTK2/src/indexDialog.cc	2006-01-19 13:32:09 UTC (rev 66)
+++ trunk/UI/GTK2/src/indexDialog.cc	2006-01-19 15:44:56 UTC (rev 67)
@@ -122,8 +122,17 @@
 
 		if (typeCombobox->get_active_row_number() == 0)
 		{
+			// Local index
+			portSpinbutton->set_sensitive(false);
+			locationButton->set_sensitive(true);
 			isLocal = true;
 		}
+		else
+		{
+			// Remote index
+			portSpinbutton->set_sensitive(true);
+			locationButton->set_sensitive(false);
+		}
 
 		// Disable the OK button if the type+location pair doesn't make sense
 		if (startsWithSlash == isLocal)



From fabricecolin at berlios.de  Fri Jan 20 12:48:04 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 20 Jan 2006 12:48:04 +0100
Subject: [Pinot-svn] r68 - in trunk: UI/GTK2/src po
Message-ID: <200601201148.k0KBm4uK000473@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-20 12:47:57 +0100 (Fri, 20 Jan 2006)
New Revision: 68

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/indexDialog.cc
   trunk/po/en_GB.po
   trunk/po/fr_FR.po
Log:
More fixes to po strings and one to indexDialog::checkFields().


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-19 15:44:56 UTC (rev 67)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-20 11:47:57 UTC (rev 68)
@@ -957,7 +957,7 @@
 		Tokenizer *pTokens = TokenizerFactory::getTokenizerByType(m_docInfo.getType(), m_pDoc);
 		if (pTokens == NULL)
 		{
-			m_status = _("Couln't tokenize");
+			m_status = _("Couldn't tokenize");
 			m_status += " ";
 			m_status += m_url;
 			emitSignal();

Modified: trunk/UI/GTK2/src/indexDialog.cc
===================================================================
--- trunk/UI/GTK2/src/indexDialog.cc	2006-01-19 15:44:56 UTC (rev 67)
+++ trunk/UI/GTK2/src/indexDialog.cc	2006-01-20 11:47:57 UTC (rev 68)
@@ -106,36 +106,37 @@
 
 void indexDialog::checkFields(void)
 {
-	bool enableOkButton = false;
+	bool isLocal = false, enableOkButton = false;
 
-	ustring name = nameEntry->get_text();
+	if (typeCombobox->get_active_row_number() == 0)
+	{
+		// Local index
+		portSpinbutton->set_sensitive(false);
+		locationButton->set_sensitive(true);
+		isLocal = true;
+	}
+	else
+	{
+		// Remote index
+		portSpinbutton->set_sensitive(true);
+		locationButton->set_sensitive(false);
+	}
+
 	ustring location = locationEntry->get_text();
-	if ((name.empty() == false) &&
-		(location.empty() == false))
+	if (location.empty() == false)
 	{
-		bool startsWithSlash = false, isLocal = false;
+		bool startsWithSlash = false;
 
 		if (location[0] == '/')
 		{
 			startsWithSlash = true;
 		}
 
-		if (typeCombobox->get_active_row_number() == 0)
-		{
-			// Local index
-			portSpinbutton->set_sensitive(false);
-			locationButton->set_sensitive(true);
-			isLocal = true;
-		}
-		else
-		{
-			// Remote index
-			portSpinbutton->set_sensitive(true);
-			locationButton->set_sensitive(false);
-		}
-
 		// Disable the OK button if the type+location pair doesn't make sense
-		if (startsWithSlash == isLocal)
+		// or if name is empty
+		ustring name = nameEntry->get_text();
+		if ((name.empty() == false) &&
+			(startsWithSlash == isLocal))
 		{
 			enableOkButton = true;
 		}

Modified: trunk/po/en_GB.po
===================================================================
--- trunk/po/en_GB.po	2006-01-19 15:44:56 UTC (rev 67)
+++ trunk/po/en_GB.po	2006-01-20 11:47:57 UTC (rev 68)
@@ -6,10 +6,10 @@
 #, fuzzy
 msgid ""
 msgstr ""
-"Project-Id-Version: pinot 0.35\n"
+"Project-Id-Version: pinot 0.40\n"
 "Report-Msgid-Bugs-To: \n"
 "POT-Creation-Date: 2005-12-08 19:20+0800\n"
-"PO-Revision-Date: 2006-01-19 20:22+0800\n"
+"PO-Revision-Date: 2006-01-20 19:32+0800\n"
 "Last-Translator: Fabrice Colin <colinf at chez.com>\n"
 "Language-Team: en_GB <colinf at chez.com>\n"
 "MIME-Version: 1.0\n"
@@ -104,7 +104,7 @@
 msgid "Import document"
 msgstr ""
 
-#: UI/GTK2/src/indexDialog.cc:211
+#: UI/GTK2/src/indexDialog.cc:221
 msgid "Index location"
 msgstr ""
 
@@ -777,7 +777,7 @@
 msgstr ""
 
 #: UI/GTK2/src/WorkerThreads.cpp:960
-msgid "Couln't tokenize"
+msgid "Couldn't tokenize"
 msgstr ""
 
 #: UI/GTK2/src/WorkerThreads.cpp:981

Modified: trunk/po/fr_FR.po
===================================================================
--- trunk/po/fr_FR.po	2006-01-19 15:44:56 UTC (rev 67)
+++ trunk/po/fr_FR.po	2006-01-20 11:47:57 UTC (rev 68)
@@ -6,10 +6,10 @@
 #, fuzzy
 msgid ""
 msgstr ""
-"Project-Id-Version: pinot 0.35\n"
+"Project-Id-Version: pinot 0.40\n"
 "Report-Msgid-Bugs-To: \n"
 "POT-Creation-Date: 2005-12-08 19:20+0800\n"
-"PO-Revision-Date: 2006-01-19 20:22+0800\n"
+"PO-Revision-Date: 2006-01-20 19:44+0800\n"
 "Last-Translator: Fabrice Colin <colinf at chez.com>\n"
 "Language-Team: en_GB <colinf at chez.com>\n"
 "MIME-Version: 1.0\n"
@@ -43,28 +43,28 @@
 
 #: UI/GTK2/src/importDialog.cc:104
 msgid "Enabled"
-msgstr "Un fichier"
+msgstr "Active"
 
 #: UI/GTK2/src/importDialog.cc:105 UI/GTK2/src/prefsDialog.cc:78
 msgid "MIME Type"
-msgstr "Un repertoire"
+msgstr "Type MIME"
 
 #: UI/GTK2/src/importDialog.cc:130
 msgid "File"
-msgstr "URL"
+msgstr "Fichier"
 
 #: UI/GTK2/src/importDialog.cc:133
 msgid "Directory"
-msgstr "Document A Importer"
+msgstr "Repertoire"
 
 #: UI/GTK2/src/importDialog.cc:138 UI/GTK2/src/IndexTree.cpp:70
 #: UI/GTK2/src/ResultsTree.cpp:114
 msgid "URL"
-msgstr "Importer"
+msgstr "URL"
 
 #: UI/GTK2/src/importDialog.cc:426
 msgid "Document To Import"
-msgstr "Selectionner"
+msgstr "Document A Importer"
 
 #: UI/GTK2/src/importDialog_glade.cc:66 UI/GTK2/src/indexDialog_glade.cc:68
 msgid "Location:"
@@ -102,9 +102,9 @@
 
 #: UI/GTK2/src/importDialog_glade.cc:200
 msgid "Import document"
-msgstr "Importation de document"
+msgstr "Import de document"
 
-#: UI/GTK2/src/indexDialog.cc:211
+#: UI/GTK2/src/indexDialog.cc:221
 msgid "Index location"
 msgstr "Location de l'index"
 
@@ -270,7 +270,7 @@
 
 #: UI/GTK2/src/mainWindow.cc:1777
 msgid "Import Document(s)"
-msgstr "Importation de Document(s)"
+msgstr "Import de Document(s)"
 
 #: UI/GTK2/src/mainWindow.cc:1907 UI/GTK2/src/pinot.cc:148
 #: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:371
@@ -317,27 +317,27 @@
 
 #: UI/GTK2/src/mainWindow.cc:2435
 msgid "At least one task hasn't completed yet. Quit now ?"
-msgstr "Nom de la recherche"
+msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
 #: UI/GTK2/src/mainWindow.cc:2627
 msgid "Query name"
-msgstr "N'a pas pu ajouter la recherche"
+msgstr "Nom de la recherche"
 
 #: UI/GTK2/src/mainWindow.cc:2654
 msgid "Couldn't update query"
-msgstr "Ajoute une nouvelle recherche"
+msgstr "N'a pas pu mettre a jour la recherche"
 
 #: UI/GTK2/src/mainWindow.cc:2662
 msgid "Edited query"
-msgstr "N'a pas pu mettre a jour la recherche"
+msgstr "Edite la recherche"
 
 #: UI/GTK2/src/mainWindow.cc:2669
 msgid "Couldn't add query"
-msgstr "Edite la recherche"
+msgstr "N'a pas pu ajouter la recherche"
 
 #: UI/GTK2/src/mainWindow.cc:2677
 msgid "Added new query"
-msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
+msgstr "Ajoute une nouvelle recherche"
 
 #: UI/GTK2/src/mainWindow.cc:2691
 msgid "Query is not set"
@@ -455,11 +455,11 @@
 
 #: UI/GTK2/src/mainWindow_glade.cc:356
 msgid "Pinot"
-msgstr "La base des historiques"
+msgstr "Pinot"
 
 #: UI/GTK2/src/pinot.cc:56
 msgid "Couldn't save configuration file"
-msgstr "n'a pas pu etre creee"
+msgstr "N'a pas pu sauve le fichier de configuration"
 
 #: UI/GTK2/src/pinot.cc:117
 msgid "Danish"
@@ -730,7 +730,7 @@
 #: UI/GTK2/src/WorkerThreads.cpp:893 UI/GTK2/src/WorkerThreads.cpp:1094
 #: UI/GTK2/src/WorkerThreads.cpp:1222
 msgid "Index error on"
-msgstr "Erreur d'index sur"
+msgstr "Erreur sur l'index"
 
 #: UI/GTK2/src/WorkerThreads.cpp:490
 msgid "Stopped querying"
@@ -758,7 +758,7 @@
 
 #: UI/GTK2/src/WorkerThreads.cpp:782
 msgid "Couldn't obtain downloader for protocol"
-msgstr "N'a pas pu obtenir un brouteur pour ="
+msgstr "N'a pas pu obtenir un brouteur pour"
 
 #: UI/GTK2/src/WorkerThreads.cpp:796 UI/GTK2/src/WorkerThreads.cpp:907
 msgid "Couldn't retrieve"
@@ -777,8 +777,8 @@
 msgstr "a"
 
 #: UI/GTK2/src/WorkerThreads.cpp:960
-msgid "Couln't tokenize"
-msgstr "N'a pas pu tokenise"
+msgid "Couldn't tokenize"
+msgstr "N'a pas pu parcourir"
 
 #: UI/GTK2/src/WorkerThreads.cpp:981
 msgid "Robots META tag forbids indexing"



From fabricecolin at berlios.de  Fri Jan 20 13:07:02 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 20 Jan 2006 13:07:02 +0100
Subject: [Pinot-svn] r69 - trunk
Message-ID: <200601201207.k0KC72k9012629@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-20 13:07:01 +0100 (Fri, 20 Jan 2006)
New Revision: 69

Modified:
   trunk/ChangeLog
Log:
Updating log of changes since v0.35.


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2006-01-20 11:47:57 UTC (rev 68)
+++ trunk/ChangeLog	2006-01-20 12:07:01 UTC (rev 69)
@@ -1,3 +1,30 @@
+2006/01/20 version_0_4_0
+UI and SQLite :
+ - dropped ActionHistory
+Search :
+ - fixed issues with documents and queries language
+ - detect encoding of results pages
+ - fixed AskJeeves source
+Index :
+ - fixed issues with documents language
+ - limit amount of text parsed by summarization and language guessing
+ - limit terms length
+ - canonicalize URLs
+ - make sure index is always unlocked properly
+Tokenize :
+ - modified tokenizer plugins interface
+ - new RTF tokenizer (requires unrtf)
+UI :
+ - standard About box
+ - better documents importing
+ - better charset conversion
+ - completion on query field, based on terms in the documents index
+ - all notebook tabs are open on a need-to basis and can be closed
+ - fixed several UI inconsistencies
+ - catch signals and signal threads to ensure clean exits
+ - save language names in English, load in current locale
+ - requires gtkmm v2.6
+
 2005/12/18 version_0_3_5
 Xapian + SQLite back-end :
  - dropped unnecessary tables, moved labels and properties into the index



From fabricecolin at berlios.de  Fri Jan 20 13:12:19 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Fri, 20 Jan 2006 13:12:19 +0100
Subject: [Pinot-svn] r70 - tags
Message-ID: <200601201212.k0KCCJeg015906@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-20 13:12:18 +0100 (Fri, 20 Jan 2006)
New Revision: 70

Added:
   tags/version_0_4_0/
Log:
Releasing v0.40.


Copied: tags/version_0_4_0 (from rev 69, trunk)



From fabricecolin at berlios.de  Sat Jan 21 09:27:22 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 21 Jan 2006 09:27:22 +0100
Subject: [Pinot-svn] r71 - in trunk/UI/GTK2: . src
Message-ID: <200601210827.k0L8RMG4012928@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-21 09:27:21 +0100 (Sat, 21 Jan 2006)
New Revision: 71

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/UI/GTK2/src/importDialog_glade.cc
   trunk/UI/GTK2/src/importDialog_glade.hh
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
Log:
A label can be applied when importing documents. Modified IndexingThread so that
the label is also set when updating a document.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-01-20 12:12:18 UTC (rev 70)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-01-21 08:27:21 UTC (rev 71)
@@ -609,7 +609,7 @@
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
 		  <property name="can_focus">True</property>
-		  <property name="expanded">True</property>
+		  <property name="expanded">False</property>
 		  <property name="spacing">0</property>
 
 		  <child>
@@ -3354,7 +3354,7 @@
 	    <widget class="GtkTable" id="docTable">
 	      <property agent="glademm" name="cxx_visibility">protected</property>
 	      <property name="visible">True</property>
-	      <property name="n_rows">5</property>
+	      <property name="n_rows">6</property>
 	      <property name="n_columns">2</property>
 	      <property name="homogeneous">False</property>
 	      <property name="row_spacing">0</property>
@@ -3650,6 +3650,52 @@
 		  <property name="y_options">fill</property>
 		</packing>
 	      </child>
+
+	      <child>
+		<widget class="GtkComboBox" id="labelNameCombobox">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="add_tearoffs">False</property>
+		  <property name="focus_on_click">True</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">5</property>
+		  <property name="bottom_attach">6</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="labelNameLabel">
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Apply label:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">5</property>
+		  <property name="bottom_attach">6</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options"></property>
+		</packing>
+	      </child>
 	    </widget>
 	    <packing>
 	      <property name="padding">0</property>

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-20 12:12:18 UTC (rev 70)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-21 08:27:21 UTC (rev 71)
@@ -805,32 +805,30 @@
 	}
 }
 
-IndexingThread::IndexingThread(const DocumentInfo &docInfo, const string &labelName) :
-	DownloadingThread(docInfo.getLocation(), false)
+IndexingThread::IndexingThread(const DocumentInfo &docInfo, const string &labelName,
+	unsigned int docId) :
+	DownloadingThread(docInfo.getLocation(), false),
+	m_docInfo(docInfo),
+	m_labelName(labelName),
+	m_docId(docId)
 {
-	m_docInfo = docInfo;
 	m_indexLocation = PinotSettings::getInstance().m_indexLocation;
-	m_ignoreRobotsDirectives = PinotSettings::getInstance().m_ignoreRobotsDirectives;
-	m_labelName = labelName;
-	// This is not an update
-	m_update = false;
+	if (m_docId > 0)
+	{
+		// Ignore robots directives on updates
+		m_ignoreRobotsDirectives = true;
+		m_update = true;
+	}
+	else
+	{
+		m_ignoreRobotsDirectives = PinotSettings::getInstance().m_ignoreRobotsDirectives;
+		// This is not an update
+		m_update = false;
+	}
 	// Don't trigger signal after the document has been downloaded
 	m_signalAfterDownload = false;
 }
 
-IndexingThread::IndexingThread(const DocumentInfo &docInfo, unsigned int docId) :
-	DownloadingThread(docInfo.getLocation(), false)
-{
-	m_docInfo = docInfo;
-	m_indexLocation = PinotSettings::getInstance().m_indexLocation;
-	// Ignore robots directives on updates
-	m_ignoreRobotsDirectives = true;
-	m_docId = docId;
-	m_update = true;
-	// Don't trigger signal after the document has been downloaded
-	m_signalAfterDownload = false;
-}
-
 IndexingThread::~IndexingThread()
 {
 }
@@ -988,23 +986,37 @@
 
 		if (m_done == false)
 		{
+			set<string> labels;
+
 			index.setStemmingMode(IndexInterface::STORE_BOTH);
 
 			// Update an existing document or add to the index ?
 			if (m_update == true)
 			{
-				success = index.updateDocument(m_docId, *pTokens);
-#ifdef DEBUG
-				cout << "IndexingThread::do_indexing: updated " << m_docId << endl;
-#endif
+				// Get the document's current labels
+				index.getDocumentLabels(m_docId, labels);
+
+				// Update the document
+				if (index.updateDocument(m_docId, *pTokens) == true)
+				{
+					// Add the label if it's a new one
+					if (labels.find(m_labelName) == labels.end())
+					{
+						labels.clear();
+						labels.insert(m_labelName);
+
+						index.setDocumentLabels(m_docId, labels, false);
+					}
+					success = true;
+				}
 			}
 			else
 			{
-				set<string> labels;
 				unsigned int docId = 0;
 
-				// Save the new document ID
 				labels.insert(m_labelName);
+
+				// Index the document
 				success = index.indexDocument(*pTokens, labels, docId);
 				if (success == true)
 				{

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-01-20 12:12:18 UTC (rev 70)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-01-21 08:27:21 UTC (rev 71)
@@ -278,10 +278,8 @@
 class IndexingThread : public DownloadingThread
 {
 	public:
-		/// Index a document.
-		IndexingThread(const DocumentInfo &docInfo, const std::string &labelName = "");
-		/// Update a document.
-		IndexingThread(const DocumentInfo &docInfo, unsigned int docId);
+		IndexingThread(const DocumentInfo &docInfo, const std::string &labelName,
+			unsigned int docId = 0);
 		virtual ~IndexingThread();
 
 		virtual Glib::Thread *start(void);
@@ -300,10 +298,10 @@
 
 	protected:
 		DocumentInfo m_docInfo;
-		std::string m_indexLocation;
-		bool m_ignoreRobotsDirectives;
 		std::string m_labelName;
 		unsigned int m_docId;
+		std::string m_indexLocation;
+		bool m_ignoreRobotsDirectives;
 		bool m_update;
 
 		void do_indexing();

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-20 12:12:18 UTC (rev 70)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-21 08:27:21 UTC (rev 71)
@@ -73,8 +73,8 @@
 	set_title(title);
 
 	// Copy the list of authorized MIME types
-	copy(mimeTypes.begin(), mimeTypes.end(), inserter(m_mimeTypes, m_mimeTypes.begin()));
-	// FIXME: populate the list
+	copy(mimeTypes.begin(), mimeTypes.end(),
+		inserter(m_mimeTypes, m_mimeTypes.begin()));
 
 	// Initialize the default directory
 	if (m_state.m_defaultDirectory.empty() == true)
@@ -86,12 +86,16 @@
 		}
 	}
 
-	// Associate the columns model to the type combo
+	// Associate the columns model to the label combo
+	m_refLabelNameTree = ListStore::create(m_labelNameColumns);
+	labelNameCombobox->set_model(m_refLabelNameTree);
+	labelNameCombobox->pack_start(m_labelNameColumns.m_name);
+	// ...and to the type combo
 	m_refTypeList = ListStore::create(m_typeColumns);
 	typeCombobox->set_model(m_refTypeList);
 	typeCombobox->pack_start(m_typeColumns.m_name);
 	// Populate
-	populate_typeCombobox(false);
+	populate_comboboxes(false);
 
 	// The default type is not directory
 	// FIXME: this could also apply to URLs !
@@ -121,7 +125,7 @@
 {
 }
 
-void importDialog::populate_typeCombobox(bool localOnly)
+void importDialog::populate_comboboxes(bool localOnly)
 {
 	bool foundLanguage = false;
 
@@ -137,8 +141,22 @@
 		row = *iter;
 		row[m_typeColumns.m_name] = _("URL");
 	}
+	typeCombobox->set_active(0);
 
-	typeCombobox->set_active(0);
+	iter = m_refLabelNameTree->append();
+	row = *iter;
+	row[m_labelNameColumns.m_name] = _("None");
+	labelNameCombobox->set_active(0);
+	// Add all labels
+	for (set<PinotSettings::Label>::const_iterator labelIter = PinotSettings::getInstance().m_labels.begin();
+		labelIter != PinotSettings::getInstance().m_labels.end(); ++labelIter)
+	{
+		string labelName = labelIter->m_name;
+
+		iter = m_refLabelNameTree->append();
+		row = *iter;
+		row[m_labelNameColumns.m_name] = to_utf8(labelName);
+	}
 }
 
 void importDialog::populate_mimeTreeview(void)
@@ -235,11 +253,11 @@
 		{
 			// This document needs updating
 			index.getDocumentInfo(docId, docInfo);
-			pThread = new IndexingThread(docInfo, docId);
+			pThread = new IndexingThread(docInfo, m_labelName, docId);
 		}
 		else
 		{
-			pThread = new IndexingThread(docInfo);
+			pThread = new IndexingThread(docInfo, m_labelName);
 		}
 
 		// Launch the new thread
@@ -492,6 +510,15 @@
 
 	// Title
 	m_title = titleEntry->get_text();
+	// Label
+	m_labelName.clear();
+	int chosenLabel = labelNameCombobox->get_active_row_number();
+	if (chosenLabel > 0)
+	{
+		TreeModel::iterator iter = labelNameCombobox->get_active();
+		TreeModel::Row row = *iter;
+		m_labelName = from_utf8(row[m_labelNameColumns.m_name]);
+	}
 	// Type
 	if (typeCombobox->get_active_row_number() <= 1)
 	{

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2006-01-20 12:12:18 UTC (rev 70)
+++ trunk/UI/GTK2/src/importDialog.hh	2006-01-21 08:27:21 UTC (rev 71)
@@ -44,7 +44,7 @@
 	unsigned int getDocumentsCount(void);
 
 protected:
-	void populate_typeCombobox(bool localOnly);
+	void populate_comboboxes(bool localOnly);
 	void populate_mimeTreeview(void);
 	bool start_thread(WorkerThread *pNewThread);
 	void signal_scanner(void);
@@ -59,7 +59,11 @@
 	// Type
 	ComboModelColumns m_typeColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refTypeList;
+	// Label
+	ComboModelColumns m_labelNameColumns;
+	Glib::RefPtr<Gtk::ListStore> m_refLabelNameTree;
 	Glib::ustring m_title;
+	std::string m_labelName;
 	unsigned int m_docsCount;
 	bool m_importDirectory;
 	// MIME types

Modified: trunk/UI/GTK2/src/importDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-20 12:12:18 UTC (rev 70)
+++ trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-21 08:27:21 UTC (rev 71)
@@ -1,4 +1,4 @@
-// generated 2006/1/13 22:05:22 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/1/20 22:51:42 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -78,6 +78,9 @@
    Gtk::Label *depthLabel = Gtk::manage(new class Gtk::Label(_("Depth:")));
    Gtk::Label *linksLabel = Gtk::manage(new class Gtk::Label(_("Symlinks:")));
    linksCheckbutton = Gtk::manage(new class Gtk::CheckButton(_("Follow symlinks")));
+   labelNameCombobox = Gtk::manage(new class Gtk::ComboBox());
+   
+   Gtk::Label *labelNameLabel = Gtk::manage(new class Gtk::Label(_("Apply label:")));
    docTable = Gtk::manage(new class Gtk::Table(2, 2, false));
    mimeTreeview = Gtk::manage(new class Gtk::TreeView());
    
@@ -152,6 +155,12 @@
    linksCheckbutton->set_relief(Gtk::RELIEF_NORMAL);
    linksCheckbutton->set_mode(true);
    linksCheckbutton->set_active(false);
+   labelNameLabel->set_alignment(0,0.5);
+   labelNameLabel->set_padding(4,4);
+   labelNameLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   labelNameLabel->set_line_wrap(false);
+   labelNameLabel->set_use_markup(false);
+   labelNameLabel->set_selectable(false);
    docTable->set_row_spacings(0);
    docTable->set_col_spacings(0);
    docTable->attach(*titleEntry, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
@@ -164,6 +173,8 @@
    docTable->attach(*depthLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 0, 0);
    docTable->attach(*linksLabel, 0, 1, 4, 5, Gtk::FILL, Gtk::FILL, 0, 0);
    docTable->attach(*linksCheckbutton, 1, 2, 4, 5, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   docTable->attach(*labelNameCombobox, 1, 2, 5, 6, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   docTable->attach(*labelNameLabel, 0, 1, 5, 6, Gtk::FILL, Gtk::AttachOptions(), 0, 0);
    mimeTreeview->set_flags(Gtk::CAN_FOCUS);
    mimeTreeview->set_headers_visible(true);
    mimeTreeview->set_rules_hint(false);
@@ -217,6 +228,8 @@
    depthLabel->show();
    linksLabel->show();
    linksCheckbutton->show();
+   labelNameCombobox->show();
+   labelNameLabel->show();
    docTable->show();
    mimeTreeview->show();
    mimeScrolledwindow->show();

Modified: trunk/UI/GTK2/src/importDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-20 12:12:18 UTC (rev 70)
+++ trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-21 08:27:21 UTC (rev 71)
@@ -1,4 +1,4 @@
-// generated 2006/1/13 22:05:22 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/1/20 22:51:42 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -54,6 +54,7 @@
         class Gtk::Button * locationButton;
         class Gtk::SpinButton * depthSpinbutton;
         class Gtk::CheckButton * linksCheckbutton;
+        class Gtk::ComboBox * labelNameCombobox;
         class Gtk::Table * docTable;
         class Gtk::TreeView * mimeTreeview;
         class Gtk::ProgressBar * importProgressbar;

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-20 12:12:18 UTC (rev 70)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-21 08:27:21 UTC (rev 71)
@@ -2078,7 +2078,7 @@
 #ifdef DEBUG
 		cout << "mainWindow::on_unindex_activate: " << docIdList.size() << " documents to unindex" << endl;
 #endif
-		queue_unindex(docIdList);
+		start_thread(new UnindexingThread(docIdList));
 	}
 }
 
@@ -2589,17 +2589,6 @@
 }
 
 //
-// Queues index removals.
-//
-bool mainWindow::queue_unindex(set<unsigned int> &docIdList)
-{
-	// Delete the document(s) right away
-	start_thread(new UnindexingThread(docIdList));
-
-	return false;
-}
-
-//
 // Edits a query
 //
 void mainWindow::edit_query(QueryProperties &queryProps, bool newQuery)
@@ -2861,7 +2850,7 @@
 	if (docId > 0)
 	{
 		// Yes, it is
-		start_thread(new IndexingThread(docInfo, docId));
+		start_thread(new IndexingThread(docInfo, labelName, docId));
 	}
 	else
 	{

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2006-01-20 12:12:18 UTC (rev 70)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-01-21 08:27:21 UTC (rev 71)
@@ -121,7 +121,6 @@
 		NotebookPageBox::PageType type);
 	bool queue_index(const DocumentInfo &docInfo, const std::string &labelName,
 		unsigned int docId = 0);
-	bool queue_unindex(set<unsigned int> &docIdList);
 	void edit_query(QueryProperties &queryProps, bool newQuery);
 	void run_search(const QueryProperties &queryProps);
 	void browse_index(const Glib::ustring &indexName, unsigned int startDoc);



From fabricecolin at berlios.de  Sun Jan 22 09:25:19 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sun, 22 Jan 2006 09:25:19 +0100
Subject: [Pinot-svn] r72 - trunk/UI/GTK2/src
Message-ID: <200601220825.k0M8PJPg010256@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-22 09:25:19 +0100 (Sun, 22 Jan 2006)
New Revision: 72

Modified:
   trunk/UI/GTK2/src/IndexTree.cpp
   trunk/UI/GTK2/src/Makefile
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/ResultsTree.cpp
Log:
Scrolled windows in Index and ResultsTree had their policy set to ALWAYS.
PinotSettings checks what the root node is and catches exceptions ! Doh ! :-)


Modified: trunk/UI/GTK2/src/IndexTree.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexTree.cpp	2006-01-21 08:27:21 UTC (rev 71)
+++ trunk/UI/GTK2/src/IndexTree.cpp	2006-01-22 08:25:19 UTC (rev 72)
@@ -52,7 +52,7 @@
 	m_pIndexScrolledwindow->set_flags(Gtk::CAN_FOCUS);
 	m_pIndexScrolledwindow->set_border_width(4);
 	m_pIndexScrolledwindow->set_shadow_type(Gtk::SHADOW_NONE);
-	m_pIndexScrolledwindow->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_ALWAYS);
+	m_pIndexScrolledwindow->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
 	m_pIndexScrolledwindow->property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
 	m_pIndexScrolledwindow->add(*this);
 

Modified: trunk/UI/GTK2/src/Makefile
===================================================================
--- trunk/UI/GTK2/src/Makefile	2006-01-21 08:27:21 UTC (rev 71)
+++ trunk/UI/GTK2/src/Makefile	2006-01-22 08:25:19 UTC (rev 72)
@@ -2,9 +2,9 @@
 ROOT_DIR = ../../..
 include ${ROOT_DIR}/variables.mk
 
-CXXFLAGS += -DHAVE_CONFIG_H -I. -I.. ${LIBXML_CXXFLAGS} ${GTKMOZ_CXXFLAGS} ${GTKMM_CXXFLAGS}
+CXXFLAGS += -DHAVE_CONFIG_H -I. -I.. ${GTKMOZ_CXXFLAGS} ${GTKMM_CXXFLAGS}
 
-LIBS += ${LIBXML_LIBS} ${GTKMOZ_LIBS} ${GTKMM_LIBS} -lgthread-2.0 -lfam
+LIBS += ${GTKMOZ_LIBS} ${GTKMM_LIBS} -lgthread-2.0 -lfam
 
 UI_GTK2_SRCS = importDialog.cc importDialog_glade.cc \
 	indexDialog.cc indexDialog_glade.cc \

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2006-01-21 08:27:21 UTC (rev 71)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2006-01-22 08:25:19 UTC (rev 72)
@@ -229,6 +229,7 @@
 bool PinotSettings::loadConfiguration(const std::string &fileName)
 {
 	struct stat fileStat;
+	bool success = true;
 
 	if ((stat(fileName.c_str(), &fileStat) != 0) ||
 		(!S_ISREG(fileStat.st_mode)))
@@ -236,100 +237,115 @@
 		return false;
 	}
 
-	// Parse the configuration file
-	DomParser parser;
-	parser.parse_file(fileName);
-	xmlpp::Document *pDocument = parser.get_document();
-	if (pDocument == NULL)
+	try
 	{
-		return false;
-	}
+		// Parse the configuration file
+		DomParser parser;
+		parser.set_substitute_entities(true);
+		parser.parse_file(fileName);
+		xmlpp::Document *pDocument = parser.get_document();
+		if (pDocument == NULL)
+		{
+			return false;
+		}
 
-	Element *pRootElem = pDocument->get_root_node();
-	if (pRootElem == NULL)
-	{
-		return false;
-	}
-	string rootNodeName = getElementContent(pRootElem);
-	// FIXME: check the top-level element is okay
+		Element *pRootElem = pDocument->get_root_node();
+		if (pRootElem == NULL)
+		{
+			return false;
+		}
 
-	// Go through the subnodes
-	const Node::NodeList childNodes = pRootElem->get_children();
-	if (childNodes.empty() == false)
-	{
-		for (Node::NodeList::const_iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
+		// Check the top-level element is what we expect
+		ustring rootNodeName = pRootElem->get_name();
+		if (rootNodeName != "pinot")
 		{
-			Node *pNode = (*iter);
-			// All nodes should be elements
-			Element *pElem = dynamic_cast<Element*>(pNode);
-			if (pElem == NULL)
-			{
-				continue;
-			}
+			return false;
+		}
 
-			string nodeName = pElem->get_name();
-			string nodeContent = getElementContent(pElem);
-			if (nodeName == "googleapikey")
+		// Go through the subnodes
+		const Node::NodeList childNodes = pRootElem->get_children();
+		if (childNodes.empty() == false)
+		{
+			for (Node::NodeList::const_iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 			{
-				m_googleAPIKey = nodeContent;
-			}
-			else if (nodeName == "ui")
-			{
-				if (loadUi(pElem) == false)
+				Node *pNode = (*iter);
+				// All nodes should be elements
+				Element *pElem = dynamic_cast<Element*>(pNode);
+				if (pElem == NULL)
 				{
-					cerr << _("Couldn't load ui block") << endl;
+					continue;
 				}
-			}
-			else if (nodeName == "extraindex")
-			{
-				if (loadIndexes(pElem) == false)
+
+				string nodeName = pElem->get_name();
+				string nodeContent = getElementContent(pElem);
+				if (nodeName == "googleapikey")
 				{
-					cerr << _("Couldn't load extraindex block") << endl;
+					m_googleAPIKey = nodeContent;
 				}
-			}
-			else if (nodeName == "storedquery")
-			{
-				if (loadQueries(pElem) == false)
+				else if (nodeName == "ui")
 				{
-					cerr << _("Couldn't load storedquery block") << endl;
+					if (loadUi(pElem) == false)
+					{
+						cerr << _("Couldn't load ui block") << endl;
+					}
 				}
-			}
-			else if (nodeName == "results")
-			{
-				if (loadResults(pElem) == false)
+				else if (nodeName == "extraindex")
 				{
-					cerr << _("Couldn't load results block") << endl;
+					if (loadIndexes(pElem) == false)
+					{
+						cerr << _("Couldn't load extraindex block") << endl;
+					}
 				}
-			}
-			else if (nodeName == "label")
-			{
-				if (loadLabels(pElem) == false)
+				else if (nodeName == "storedquery")
 				{
-					cerr << _("Couldn't load label block") << endl;
+					if (loadQueries(pElem) == false)
+					{
+						cerr << _("Couldn't load storedquery block") << endl;
+					}
 				}
-			}
-			else if (nodeName == "robots")
-			{
-				if (nodeContent == "IGNORE")
+				else if (nodeName == "results")
 				{
-					m_ignoreRobotsDirectives = true;
+					if (loadResults(pElem) == false)
+					{
+						cerr << _("Couldn't load results block") << endl;
+					}
 				}
-				else
+				else if (nodeName == "label")
 				{
-					m_ignoreRobotsDirectives = false;
+					if (loadLabels(pElem) == false)
+					{
+						cerr << _("Couldn't load label block") << endl;
+					}
 				}
-			}
-			else if (nodeName == "mailaccount")
-			{
-				if (loadMailAccounts(pElem) == false)
+				else if (nodeName == "robots")
 				{
-					cerr << _("Couldn't load mailaccount block") << endl;
+					if (nodeContent == "IGNORE")
+					{
+						m_ignoreRobotsDirectives = true;
+					}
+					else
+					{
+						m_ignoreRobotsDirectives = false;
+					}
 				}
+				else if (nodeName == "mailaccount")
+				{
+					if (loadMailAccounts(pElem) == false)
+					{
+						cerr << _("Couldn't load mailaccount block") << endl;
+					}
+				}
 			}
 		}
 	}
+	catch (const std::exception& ex)
+	{
+		cerr << _("Couldn't parse configuration file") << ": "
+			<< ex.what() << endl;
+		success = false;
+	}
 
-	return true;
+	return success;
 }
 
 bool PinotSettings::loadUi(const Element *pElem)

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-01-21 08:27:21 UTC (rev 71)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-01-22 08:25:19 UTC (rev 72)
@@ -65,7 +65,7 @@
 	m_pResultsScrolledwindow->set_flags(CAN_FOCUS);
 	m_pResultsScrolledwindow->set_border_width(4);
 	m_pResultsScrolledwindow->set_shadow_type(SHADOW_NONE);
-	m_pResultsScrolledwindow->set_policy(POLICY_AUTOMATIC, POLICY_ALWAYS);
+	m_pResultsScrolledwindow->set_policy(POLICY_AUTOMATIC, POLICY_AUTOMATIC);
 	m_pResultsScrolledwindow->property_window_placement().set_value(CORNER_TOP_LEFT);
 	m_pResultsScrolledwindow->add(*this);
 



From fabricecolin at berlios.de  Sun Jan 22 10:16:01 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sun, 22 Jan 2006 10:16:01 +0100
Subject: [Pinot-svn] r73 - in trunk: Search Utils
Message-ID: <200601220916.k0M9G1aw013833@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-22 10:16:00 +0100 (Sun, 22 Jan 2006)
New Revision: 73

Added:
   trunk/Search/SearchPluginProperties.cpp
   trunk/Search/SearchPluginProperties.h
   trunk/Search/SherlockParser.cpp
   trunk/Search/SherlockParser.h
   trunk/Search/plugintest.cpp
Removed:
   trunk/Utils/PluginParser.cpp
   trunk/Utils/PluginParser.h
   trunk/Utils/plugintest.cpp
Modified:
   trunk/Search/Makefile
   trunk/Search/PluginWebEngine.cpp
   trunk/Search/PluginWebEngine.h
   trunk/Utils/Makefile
Log:
Renamed PluginParser to SherlockParser, moved to Search with plugintest program.
Added rudimentary OpenSearch Description and Query Syntax parser.


Modified: trunk/Search/Makefile
===================================================================
--- trunk/Search/Makefile	2006-01-22 08:25:19 UTC (rev 72)
+++ trunk/Search/Makefile	2006-01-22 09:16:00 UTC (rev 73)
@@ -2,20 +2,22 @@
 ROOT_DIR = ..
 include ${ROOT_DIR}/variables.mk
 
-SE_SRCS = PluginWebEngine.cpp QueryProperties.cpp SearchEngineFactory.cpp \
-	SearchEngineInterface.cpp WebEngine.cpp XapianEngine.cpp
+SE_SRCS = OpenSearchParser.cpp PluginWebEngine.cpp QueryProperties.cpp \
+	SherlockParser.cpp SearchEngineFactory.cpp SearchEngineInterface.cpp \
+	SearchPluginProperties.cpp WebEngine.cpp XapianEngine.cpp
 SE_OBJS := $(patsubst %.cpp,${OBJ_DIR}/%.o,${SE_SRCS})
 ifeq (${NEEDS_SOAP},yes)
 SOAPENV_OBJS = ${OBJ_DIR}/stdsoap.o ${OBJ_DIR}/SOAPEnvNS.o ${OBJ_DIR}/SOAPEnvC.o
 else
 SOAPENV_OBJS = 
 endif
+PLUGIN_TEST = ${BIN_DIR}/plugintest
 SE_TEST = ${BIN_DIR}/senginetest
 
-targets : dirs ${SE_LIB} ${SOAPENV_LIB} ${SE_TEST}
+targets : dirs ${SE_LIB} ${SOAPENV_LIB} ${PLUGIN_TEST} ${SE_TEST}
 
 clean :
-	@rm -f ${OBJ_DIR}/* ${SE_LIB} ${SOAPENV_LIB} ${SE_TEST}
+	@rm -f ${OBJ_DIR}/* ${SE_LIB} ${SOAPENV_LIB} ${PLUGIN_TEST} ${SE_TEST}
 
 # SOAP environment
 
@@ -35,6 +37,12 @@
 ${OBJ_DIR}/SOAPEnvC.o : SOAPEnvC.cpp
 	${CXX} -o ${OBJ_DIR}/SOAPEnvC.o -c SOAPEnvC.cpp ${CXXFLAGS}
 
+# Parser tester
+
+${PLUGIN_TEST} : ${OBJ_DIR}/plugintest.o ${SE_LIBS} ${DL_LIB} ${TOKENIZE_LIB} ${UTILS_LIB}
+	@echo Building ${PLUGIN_TEST}
+	${LINK} -o $@ ${OBJ_DIR}/plugintest.o ${SE_LIBS} ${DL_LIB} ${TOKENIZE_LIB} ${UTILS_LIB} ${LIBS}
+
 # SearchEngine tester
 
 ${SE_TEST} : ${OBJ_DIR}/senginetest.o ${SE_LIBS} ${DL_LIB} ${TOKENIZE_LIB} ${UTILS_LIB}

Modified: trunk/Search/PluginWebEngine.cpp
===================================================================
--- trunk/Search/PluginWebEngine.cpp	2006-01-22 08:25:19 UTC (rev 72)
+++ trunk/Search/PluginWebEngine.cpp	2006-01-22 09:16:00 UTC (rev 73)
@@ -20,7 +20,7 @@
 
 #include "Document.h"
 #include "HtmlTokenizer.h"
-#include "PluginParser.h"
+#include "SherlockParser.h"
 #include "StringManip.h"
 #include "Url.h"
 #include "FileCollector.h"
@@ -79,7 +79,7 @@
 		return false;
 	}
 
-	PluginParser parser(pPluginDoc);
+	SherlockParser parser(pPluginDoc);
 	if (parser.parse() == false)
 	{
 		delete pPluginDoc;
@@ -432,7 +432,7 @@
 		return false;
 	}
 
-	PluginParser parser(pPluginDoc);
+	SherlockParser parser(pPluginDoc);
 	if (parser.parse(true) == false)
 	{
 #ifdef DEBUG

Modified: trunk/Search/PluginWebEngine.h
===================================================================
--- trunk/Search/PluginWebEngine.h	2006-01-22 08:25:19 UTC (rev 72)
+++ trunk/Search/PluginWebEngine.h	2006-01-22 09:16:00 UTC (rev 73)
@@ -29,7 +29,7 @@
   * A class that implements the Sherlock search plugin standard.
   * See http://developer.apple.com/technotes/tn/tn1141.html
   * and http://mycroft.mozdev.org/deepdocs/deepdocs.html
-  */	  
+  */
 class PluginWebEngine : public WebEngine
 {
 	public:

Added: trunk/Search/SearchPluginProperties.cpp
===================================================================
--- trunk/Search/SearchPluginProperties.cpp	2006-01-22 08:25:19 UTC (rev 72)
+++ trunk/Search/SearchPluginProperties.cpp	2006-01-22 09:16:00 UTC (rev 73)
@@ -0,0 +1,90 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include "SearchPluginProperties.h"
+
+using std::string;
+using std::map;
+using std::set;
+
+SearchPluginProperties::SearchPluginProperties() :
+	m_method(GET_METHOD)
+{
+}
+
+SearchPluginProperties::SearchPluginProperties(const SearchPluginProperties &other) :
+	m_name(other.m_name),
+	m_longName(other.m_longName),
+	m_description(other.m_description),
+	m_channel(other.m_channel),
+	m_baseUrl(other.m_baseUrl),
+	m_method(other.m_method),
+	m_parametersRemainder(other.m_parametersRemainder),
+	m_outputType(other.m_outputType)
+{
+	copy(other.m_languages.begin(), other.m_languages.end(),
+		inserter(m_languages, m_languages.begin()));
+	copy(other.m_outputEncodings.begin(), other.m_outputEncodings.end(),
+		inserter(m_outputEncodings, m_outputEncodings.begin()));
+	copy(other.m_inputEncodings.begin(), other.m_inputEncodings.end(),
+		inserter(m_inputEncodings, m_inputEncodings.begin()));
+	copy(other.m_parameters.begin(), other.m_parameters.end(),
+		inserter(m_parameters, m_parameters.begin()));
+}
+
+SearchPluginProperties::~SearchPluginProperties()
+{
+}
+
+SearchPluginProperties& SearchPluginProperties::operator=(const SearchPluginProperties& other)
+{
+	m_name = other.m_name;
+	m_longName = other.m_longName;
+	m_description = other.m_description;
+	m_channel = other.m_channel;
+	m_baseUrl = other.m_baseUrl;
+	m_method = other.m_method;
+	m_parametersRemainder = other.m_parametersRemainder;
+	m_outputType = other.m_outputType;
+	copy(other.m_languages.begin(), other.m_languages.end(),
+		inserter(m_languages, m_languages.begin()));
+	copy(other.m_outputEncodings.begin(), other.m_outputEncodings.end(),
+		inserter(m_outputEncodings, m_outputEncodings.begin()));
+	copy(other.m_inputEncodings.begin(), other.m_inputEncodings.end(),
+		inserter(m_inputEncodings, m_inputEncodings.begin()));
+	copy(other.m_parameters.begin(), other.m_parameters.end(),
+		inserter(m_parameters, m_parameters.begin()));
+}
+
+bool SearchPluginProperties::operator==(const SearchPluginProperties &other) const
+{
+	if (m_name == other.m_name)
+	{
+		return true;
+	}
+
+	return false;
+}
+
+bool SearchPluginProperties::operator<(const SearchPluginProperties &other) const
+{
+	if (m_name < other.m_name)
+	{
+		return true;
+	}
+
+	return false;
+}

Added: trunk/Search/SearchPluginProperties.h
===================================================================
--- trunk/Search/SearchPluginProperties.h	2006-01-22 08:25:19 UTC (rev 72)
+++ trunk/Search/SearchPluginProperties.h	2006-01-22 09:16:00 UTC (rev 73)
@@ -0,0 +1,58 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _SEARCH_PLUGIN_PROPERTIES_H
+#define _SEARCH_PLUGIN_PROPERTIES_H
+
+#include <string>
+#include <map>
+#include <set>
+
+class SearchPluginProperties
+{
+	public:
+		SearchPluginProperties();
+		SearchPluginProperties(const SearchPluginProperties &other);
+		virtual ~SearchPluginProperties();
+
+		SearchPluginProperties& operator=(const SearchPluginProperties& other);
+		bool operator==(const SearchPluginProperties &other) const;
+		bool operator<(const SearchPluginProperties &other) const;
+
+		typedef enum { GET_METHOD = 0, POST_METHOD } Method;
+
+		typedef enum { UNKNOWN_PARAM = 0, SEARCH_TERMS_PARAM,
+			 COUNT_PARAM,START_INDEX_PARAM, START_PAGE_PARAM, LANGUAGE_PARAM,
+			OUTPUT_ENCODING_PARAM, INPUT_ENCODING_PARAM } Parameter;
+
+		// Description
+		std::string m_name;
+		std::string m_longName;
+		std::string m_description;
+		std::string m_channel;
+		std::set<std::string> m_languages;
+		std::set<std::string> m_outputEncodings;
+		std::set<std::string> m_inputEncodings;
+		// Query
+		std::string m_baseUrl;
+		Method m_method;
+		std::map<Parameter, std::string> m_parameters;
+		std::string m_parametersRemainder;
+		std::string m_outputType;
+
+};
+
+#endif // _SEARCH_PLUGIN_PROPERTIES_H

Copied: trunk/Search/SherlockParser.cpp (from rev 69, trunk/Utils/PluginParser.cpp)
===================================================================
--- trunk/Utils/PluginParser.cpp	2006-01-20 12:07:01 UTC (rev 69)
+++ trunk/Search/SherlockParser.cpp	2006-01-22 09:16:00 UTC (rev 73)
@@ -0,0 +1,264 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <stdlib.h>
+#include <iostream>
+#include <boost/spirit/core.hpp>
+#include <boost/spirit/actor/push_back_actor.hpp>
+#include <boost/spirit/actor/insert_at_actor.hpp>
+#include <boost/spirit/utility/confix.hpp>
+
+#include "SherlockParser.h"
+
+using namespace std;
+using namespace boost::spirit;
+
+struct skip_grammar : public grammar<skip_grammar>
+{
+	template <typename ScannerT>
+	struct definition
+	{
+		definition(skip_grammar const &self)
+		{
+			// Skip all spaces and comments, starting with a #
+			// FIXME: make sure comments start at the beginning of the line !
+			skip = space_p | (ch_p('#') >> *(anychar_p - ch_p('\n')) >> ch_p('\n'));
+		}
+	
+		rule<ScannerT> skip;
+	
+		rule<ScannerT> const& start() const
+		{
+			return skip;
+		}
+	};
+};
+
+/**
+  * A minimal grammar for Sherlock plugins.
+  * This only checks for the existence of the SEARCH tag.
+  * It is used to quickly extract SEARCH attributes.
+  */
+struct plugin_min_grammar : public grammar<plugin_min_grammar>
+{
+	 plugin_min_grammar(PluginProperties &properties)
+        : m_properties(properties)
+	{
+	}
+
+	template <typename ScannerT>
+	struct definition
+	{
+		definition(plugin_min_grammar const &self)
+		{
+			// Start
+			search_plugin = search_header >> rest;
+
+			// All items have a name and an optionally-quoted value, separated by =
+			end_of_name = ch_p('=');
+			any_name = *(~ch_p('>') - end_of_name);
+			any_value_without_quotes = lexeme_d[*(~ch_p('>') - ch_p('\n'))];
+			any_value = ch_p('\'') >> (*(~ch_p('\'')))[assign_a(unquotedValue)] >> ch_p('\'') |
+				ch_p('"') >> (*(~ch_p('"')))[assign_a(unquotedValue)] >> ch_p('"') |
+				any_value_without_quotes[assign_a(unquotedValue)];
+
+			// SEARCH attributes are items
+			// There should be only one SEARCH tag
+			search_item = (any_name[assign_a(itemName)]
+				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)])
+				[insert_at_a(self.m_properties.m_searchParams, itemName, itemValue)];
+
+			// SEARCH may have any number of attributes
+			search_header = ch_p('<') >> as_lower_d[str_p("search")] >> *search_item >> ch_p('>');
+
+			// Rest
+			rest = *anychar_p;
+		}
+
+		string unquotedValue, itemName, itemValue;		
+		rule<ScannerT> search_plugin, search_header, rest;
+		rule<ScannerT> end_of_name, any_name, any_value_without_quotes, any_value, search_item;
+
+		rule<ScannerT> const& start() const
+		{
+			return search_plugin;
+		}
+	};
+
+	PluginProperties &m_properties;
+
+};
+
+/**
+  * A complete but lax grammar for Sherlock plugins.
+  * For instance, it doesn't mind if INPUT has a NAME but no VALUE.
+  * More importantly, it doesn't enforce types, eg FACTOR should be an integer.
+  */
+struct plugin_grammar : public grammar<plugin_grammar>
+{
+	 plugin_grammar(PluginProperties &properties)
+        : m_properties(properties)
+	{
+	}
+
+	template <typename ScannerT>
+	struct definition
+	{
+		definition(plugin_grammar const &self)
+		{
+			// Start
+			search_plugin = search_header >> input_elements >> search_footer;
+
+			// All items have a name and an optionally-quoted value, separated by =
+			end_of_name = ch_p('=');
+			any_name = *(~ch_p('>') - end_of_name);
+			any_value_without_quotes = lexeme_d[*(~ch_p('>') - ch_p('\n'))];
+			any_value = ch_p('\'') >> (*(~ch_p('\'')))[assign_a(unquotedValue)] >> ch_p('\'') |
+				ch_p('"') >> (*(~ch_p('"')))[assign_a(unquotedValue)] >> ch_p('"') |
+				any_value_without_quotes[assign_a(unquotedValue)];
+
+			// SEARCH attributes are items
+			// There should be only one SEARCH tag
+			search_item = (any_name[assign_a(itemName)]
+				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)])
+				[insert_at_a(self.m_properties.m_searchParams, itemName, itemValue)];
+
+			// SEARCH may have any number of attributes
+			search_header = ch_p('<') >> as_lower_d[str_p("search")] >> *search_item >> ch_p('>');
+
+			// INPUT
+			input_item_name = as_lower_d[str_p("name")] >> ch_p('=')
+				>> any_value[assign_a(itemName, unquotedValue)];
+			input_item_value = as_lower_d[str_p("value")] >> ch_p('=')
+				>> any_value[assign_a(itemValue, unquotedValue)];
+			input_item_user = as_lower_d[str_p("user")];
+			input_item_factor = as_lower_d[str_p("factor")]
+				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)];
+
+			// INPUT tags have name and value items; one is marked with USER
+			input_item = input_item_name |
+				input_item_value |
+				input_item_user[assign_a(self.m_properties.m_userInput, itemName)];
+
+			input_element = (ch_p('<') >> as_lower_d[str_p("input")] >> *input_item >> ch_p('>'))
+				[insert_at_a(self.m_properties.m_inputItems, itemName, itemValue)];
+
+			// INPUTPREV tags have name and either factor or value items
+			// There should be only one INPUTPREV tag
+			// FIXME: save those
+			inputprev_item = input_item_name |
+				input_item_factor |
+				input_item_value;
+
+			inputprev_element = ch_p('<') >> as_lower_d[str_p("inputprev")] >> *inputprev_item >> ch_p('>');
+
+			// INPUTNEXT tags have name and either factor or value items
+			// There should be only one INPUTNEXT tag
+			inputnext_item = input_item_name[assign_a(self.m_properties.m_nextInput, itemName)] |
+				input_item_factor[assign_a(self.m_properties.m_nextFactor, itemValue)] |
+				input_item_value[assign_a(self.m_properties.m_nextValue, itemValue)];
+
+			inputnext_element = ch_p('<') >> as_lower_d[str_p("inputnext")] >> *inputnext_item >> ch_p('>');
+
+			// INTERPRET tags have varied types of items
+			// There should be only one INTERPRET tag
+			interpret_item = (any_name[assign_a(itemName)]
+				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)])
+				[insert_at_a(self.m_properties.m_interpretParams, itemName, itemValue)];
+
+			interpret_element = ch_p('<') >> as_lower_d[str_p("interpret")] >> *interpret_item >> ch_p('>');
+
+			// INPUT, INPUTNEXT and INTERPRET may appear in any order
+			input_elements = *(input_element |
+				inputprev_element |
+				inputnext_element |
+				interpret_element);
+
+			// SEARCH has a closing tag
+			search_footer =  ch_p('<') >> ch_p('/') >> as_lower_d[str_p("search")] >> ch_p('>');
+		}
+
+		string unquotedValue, itemName, itemValue;		
+		rule<ScannerT> search_plugin, search_header, search_footer;
+		rule<ScannerT> end_of_name, any_name, any_value_without_quotes, any_value, search_item;
+		rule<ScannerT> input_elements, input_element, inputprev_element, inputnext_element, interpret_element;
+		rule<ScannerT> input_item_name, input_item_value, input_item_user, input_item_factor;
+		rule<ScannerT> input_item, inputprev_item, inputnext_item, interpret_item;
+
+		rule<ScannerT> const& start() const
+		{
+			return search_plugin;
+		}
+	};
+
+	PluginProperties &m_properties;
+
+};
+
+SherlockParser::SherlockParser(const Document *pDocument) :
+	m_pDocument(pDocument)
+{
+}
+
+SherlockParser::~SherlockParser()
+{
+}
+
+bool SherlockParser::parse(bool extractSearchParams)
+{
+	if (m_pDocument == NULL)
+	{
+		return false;
+	}
+
+	unsigned int dataLength;
+	const char *pData = m_pDocument->getData(dataLength);
+	if ((pData == NULL) ||
+		(dataLength == 0))
+	{
+		return false;
+	}
+
+	skip_grammar skip;
+	parse_info<> parseInfo;
+
+	if (extractSearchParams == false)
+	{
+		plugin_grammar plugin(m_properties);
+
+		parseInfo = boost::spirit::parse(pData, plugin, skip);
+	}
+	else
+	{
+		plugin_min_grammar plugin(m_properties);
+
+		parseInfo = boost::spirit::parse(pData, plugin, skip);
+	}
+#ifdef DEBUG
+	if (parseInfo.full == false)
+	{
+		cout << "SherlockParser::parse: syntax error near " << parseInfo.stop << endl;
+	}
+#endif
+
+	return parseInfo.hit;
+}
+
+/// Returns the plugin's properties.
+PluginProperties &SherlockParser::getProperties(void)
+{
+	return m_properties;
+}

Copied: trunk/Search/SherlockParser.h (from rev 69, trunk/Utils/PluginParser.h)
===================================================================
--- trunk/Utils/PluginParser.h	2006-01-20 12:07:01 UTC (rev 69)
+++ trunk/Search/SherlockParser.h	2006-01-22 09:16:00 UTC (rev 73)
@@ -0,0 +1,77 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _SHERLOCK_PARSER_H
+#define _SHERLOCK_PARSER_H
+
+#include <string>
+#include <map>
+
+#include "Document.h"
+
+class PluginProperties
+{
+	public:
+		PluginProperties()
+		{
+		}
+		virtual ~PluginProperties()
+		{
+		}
+
+
+		std::map<std::string, std::string> m_searchParams;
+		std::map<std::string, std::string> m_inputItems;
+		std::string m_userInput;
+		std::string m_nextInput;
+		std::string m_nextFactor;
+		std::string m_nextValue;
+		std::map<std::string, std::string> m_interpretParams;
+
+	private:
+		PluginProperties(const PluginProperties &other);
+		PluginProperties& operator=(const PluginProperties& other);
+
+};
+
+/**
+  * A parser for Sherlock plugin files.
+  * See http://developer.apple.com/technotes/tn/tn1141.html
+  * and http://mycroft.mozdev.org/deepdocs/deepdocs.html
+  */
+class SherlockParser
+{
+	public:
+		SherlockParser(const Document *pDocument);
+		virtual ~SherlockParser();
+
+		/// Parses the plugin; false if not all could be parsed.
+		bool parse(bool extractSearchParams = false);
+
+		/// Returns the plugin's properties.
+		virtual PluginProperties &getProperties(void);
+
+	protected:
+		const Document *m_pDocument;
+		PluginProperties m_properties;
+
+	private:
+		SherlockParser(const SherlockParser &other);
+		SherlockParser& operator=(const SherlockParser& other);
+
+};
+
+#endif // _SHERLOCK_PARSER_H

Copied: trunk/Search/plugintest.cpp (from rev 69, trunk/Utils/plugintest.cpp)
===================================================================
--- trunk/Utils/plugintest.cpp	2006-01-20 12:07:01 UTC (rev 69)
+++ trunk/Search/plugintest.cpp	2006-01-22 09:16:00 UTC (rev 73)
@@ -0,0 +1,137 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <strings.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <fcntl.h>
+#include <unistd.h>
+#include <iostream>
+#include <string>
+
+#include "OpenSearchParser.h"
+#include "SherlockParser.h"
+
+using namespace std;
+
+int main(int argc, char **argv)
+{
+	if (argc < 3)
+	{
+		cerr << "Usage: " << argv[0] << " SHERLOCK|OPENSEARCH <file name> [MIN]" << endl;
+		return EXIT_FAILURE;
+	}
+
+	struct stat fileStat;
+	if ((stat(argv[2], &fileStat) == 0) &&
+		(S_ISREG(fileStat.st_mode)))
+	{
+		bool minParser = false;
+
+		if ((argc >= 4) &&
+			(strncasecmp(argv[3], "MIN", 3) == 0))
+		{
+			minParser = true;
+		}
+
+		if (strncasecmp(argv[1], "SHERLOCK", 8) == 0)
+		{
+			char *buffer = new char[fileStat.st_size + 1];
+			int fd = open(argv[2], O_RDONLY);
+
+			// Read the file
+			ssize_t readBytes = read(fd, buffer, fileStat.st_size);
+			if (readBytes == -1)
+			{
+				cerr << "Couldn't read " << argv[2] << " !" << endl;
+				return EXIT_FAILURE;
+			}
+
+			// Put that data into a document
+			Document doc;
+			doc.setData(buffer, readBytes);
+			delete[] buffer;
+
+			SherlockParser parser(&doc);
+			if (parser.parse(minParser) == true)
+			{
+				cout << "Successfully parsed " << argv[2] << endl;
+			}
+
+			PluginProperties &properties = parser.getProperties();
+
+			cout << "SEARCH parameters are :" << endl;
+			for (map<string, string>::iterator iter = properties.m_searchParams.begin();
+				iter != properties.m_searchParams.end(); ++iter)
+			{
+				cout << iter->first << "=" << iter->second << endl;
+			}
+			cout << "End of SEARCH parameters" << endl;
+
+			cout << "INPUT items are :" << endl;
+			for (map<string, string>::iterator iter = properties.m_inputItems.begin();
+				iter != properties.m_inputItems.end(); ++iter)
+			{
+				if (iter->first != properties.m_userInput)
+				{
+					cout << iter->first << "=" << iter->second << endl;
+				}
+				else
+				{
+					cout << iter->first << " USER" << endl;
+				}
+			}
+			cout << "NEXT " << properties.m_nextInput << "=" << properties.m_nextFactor << endl;
+			cout << "End of INPUT items" << endl;
+
+			cout << "INTERPRET parameters are :" << endl;
+			for (map<string, string>::iterator iter = properties.m_interpretParams.begin();
+				iter != properties.m_interpretParams.end(); ++iter)
+			{
+				cout << iter->first << "=" << iter->second << endl;
+			}
+			cout << "End of INTERPRET parameters" << endl;
+		}
+		else if (strncasecmp(argv[1], "OPENSEARCH", 10) == 0)
+		{
+			OpenSearchParser parser(argv[2]);
+
+			if (parser.parse(minParser) == true)
+			{
+				cout << "Successfully parsed " << argv[2] << endl;
+			}
+
+			SearchPluginProperties &properties = parser.getProperties();
+
+			cout << "Plugin " << properties.m_name << ": " << properties.m_description << endl;
+			cout << "Channel: " << properties.m_channel << endl;
+			cout << "URL: " << properties.m_baseUrl << endl;
+			cout << "Input parameters are:" << endl;
+			for (map<SearchPluginProperties::Parameter, string>::iterator iter = properties.m_parameters.begin();
+				iter != properties.m_parameters.end(); ++iter)
+			{
+				cout << iter->second << "=" << iter->first << endl;
+			}
+			cout << "Remainder:" << properties.m_parametersRemainder << endl;
+		}
+	}
+	else
+	{
+		cerr << "Couldn't stat " << argv[2] << " !" << endl;
+	}
+
+	return EXIT_SUCCESS;
+}

Modified: trunk/Utils/Makefile
===================================================================
--- trunk/Utils/Makefile	2006-01-22 08:25:19 UTC (rev 72)
+++ trunk/Utils/Makefile	2006-01-22 09:16:00 UTC (rev 73)
@@ -5,25 +5,15 @@
 
 UTILS_SRCS = DocumentInfo.cpp Document.cpp HtmlDocument.cpp \
 	IndexedDocument.cpp Languages.cpp MIMEScanner.cpp MboxParser.cpp \
-	PluginParser.cpp Result.cpp StringManip.cpp TimeConverter.cpp \
-	Timer.cpp Url.cpp XapianDatabase.cpp XapianDatabaseFactory.cpp
+	Result.cpp StringManip.cpp TimeConverter.cpp Timer.cpp Url.cpp \
+	XapianDatabase.cpp XapianDatabaseFactory.cpp
 UTILS_OBJS := $(patsubst %.cpp,${OBJ_DIR}/%.o,${UTILS_SRCS})
 
-PLUGIN_TEST = ${BIN_DIR}/plugintest
+targets : dirs ${UTILS_LIB}
 
-targets : dirs ${UTILS_LIB} ${TOKENIZER_TEST} ${PLUGIN_TEST} \
-	${PDF_TOKENIZER_DL} ${WORD_TOKENIZER_DL}
-
 clean :
-	@rm -f ${OBJ_DIR}/* ${UTILS_LIB} ${TOKENIZER_TEST} \
-	${PLUGIN_TEST} ${PDF_TOKENIZER_DL} ${WORD_TOKENIZER_DL}
+	@rm -f ${OBJ_DIR}/* ${UTILS_LIB}
 
-# Utils tester
-
-${PLUGIN_TEST} : ${OBJ_DIR}/plugintest.o ${UTILS_LIB}
-	@echo Building ${PLUGIN_TEST}
-	${LINK} -o ${PLUGIN_TEST} ${OBJ_DIR}/plugintest.o ${UTILS_LIB} ${LIBS}
-
 # Library
 
 ${UTILS_LIB} : ${UTILS_OBJS}

Deleted: trunk/Utils/PluginParser.cpp
===================================================================
--- trunk/Utils/PluginParser.cpp	2006-01-22 08:25:19 UTC (rev 72)
+++ trunk/Utils/PluginParser.cpp	2006-01-22 09:16:00 UTC (rev 73)
@@ -1,272 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#include <stdlib.h>
-#include <string>
-#include <map>
-#include <iostream>
-#include <boost/spirit/core.hpp>
-#include <boost/spirit/actor/push_back_actor.hpp>
-#include <boost/spirit/actor/insert_at_actor.hpp>
-#include <boost/spirit/utility/confix.hpp>
-
-#include "PluginParser.h"
-
-using namespace std;
-using namespace boost::spirit;
-
-struct skip_grammar : public grammar<skip_grammar>
-{
-	template <typename ScannerT>
-	struct definition
-	{
-		definition(skip_grammar const &self)
-		{
-			// Skip all spaces and comments, starting with a #
-			// FIXME: make sure comments start at the beginning of the line !
-			skip = space_p | (ch_p('#') >> *(anychar_p - ch_p('\n')) >> ch_p('\n'));
-		}
-	
-		rule<ScannerT> skip;
-	
-		rule<ScannerT> const& start() const
-		{
-			return skip;
-		}
-	};
-};
-
-/**
-  * A minimal grammar for Sherlock plugins.
-  * This only checks for the existence of the SEARCH tag.
-  * It is used to quickly extract SEARCH attributes.
-  */
-struct plugin_min_grammar : public grammar<plugin_min_grammar>
-{
-	 plugin_min_grammar(PluginProperties &properties)
-        : m_properties(properties)
-	{
-	}
-
-	template <typename ScannerT>
-	struct definition
-	{
-		definition(plugin_min_grammar const &self)
-		{
-			// Start
-			search_plugin = search_header >> rest;
-
-			// All items have a name and an optionally-quoted value, separated by =
-			end_of_name = ch_p('=');
-			any_name = *(~ch_p('>') - end_of_name);
-			any_value_without_quotes = lexeme_d[*(~ch_p('>') - ch_p('\n'))];
-			any_value = ch_p('\'') >> (*(~ch_p('\'')))[assign_a(unquotedValue)] >> ch_p('\'') |
-				ch_p('"') >> (*(~ch_p('"')))[assign_a(unquotedValue)] >> ch_p('"') |
-				any_value_without_quotes[assign_a(unquotedValue)];
-
-			// SEARCH attributes are items
-			// There should be only one SEARCH tag
-			search_item = (any_name[assign_a(itemName)]
-				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)])
-				[insert_at_a(self.m_properties.m_searchParams, itemName, itemValue)];
-
-			// SEARCH may have any number of attributes
-			search_header = ch_p('<') >> as_lower_d[str_p("search")] >> *search_item >> ch_p('>');
-
-			// Rest
-			rest = *anychar_p;
-		}
-
-		string unquotedValue, itemName, itemValue;		
-		rule<ScannerT> search_plugin, search_header, rest;
-		rule<ScannerT> end_of_name, any_name, any_value_without_quotes, any_value, search_item;
-
-		rule<ScannerT> const& start() const
-		{
-			return search_plugin;
-		}
-	};
-
-	PluginProperties &m_properties;
-
-};
-
-/**
-  * A complete but lax grammar for Sherlock plugins.
-  * For instance, it doesn't mind if INPUT has a NAME but no VALUE.
-  * More importantly, it doesn't enforce types, eg FACTOR should be an integer.
-  */
-struct plugin_grammar : public grammar<plugin_grammar>
-{
-	 plugin_grammar(PluginProperties &properties)
-        : m_properties(properties)
-	{
-	}
-
-	template <typename ScannerT>
-	struct definition
-	{
-		definition(plugin_grammar const &self)
-		{
-			// Start
-			search_plugin = search_header >> input_elements >> search_footer;
-
-			// All items have a name and an optionally-quoted value, separated by =
-			end_of_name = ch_p('=');
-			any_name = *(~ch_p('>') - end_of_name);
-			any_value_without_quotes = lexeme_d[*(~ch_p('>') - ch_p('\n'))];
-			any_value = ch_p('\'') >> (*(~ch_p('\'')))[assign_a(unquotedValue)] >> ch_p('\'') |
-				ch_p('"') >> (*(~ch_p('"')))[assign_a(unquotedValue)] >> ch_p('"') |
-				any_value_without_quotes[assign_a(unquotedValue)];
-
-			// SEARCH attributes are items
-			// There should be only one SEARCH tag
-			search_item = (any_name[assign_a(itemName)]
-				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)])
-				[insert_at_a(self.m_properties.m_searchParams, itemName, itemValue)];
-
-			// SEARCH may have any number of attributes
-			search_header = ch_p('<') >> as_lower_d[str_p("search")] >> *search_item >> ch_p('>');
-
-			// INPUT
-			input_item_name = as_lower_d[str_p("name")] >> ch_p('=')
-				>> any_value[assign_a(itemName, unquotedValue)];
-			input_item_value = as_lower_d[str_p("value")] >> ch_p('=')
-				>> any_value[assign_a(itemValue, unquotedValue)];
-			input_item_user = as_lower_d[str_p("user")];
-			input_item_factor = as_lower_d[str_p("factor")]
-				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)];
-
-			// INPUT tags have name and value items; one is marked with USER
-			input_item = input_item_name |
-				input_item_value |
-				input_item_user[assign_a(self.m_properties.m_userInput, itemName)];
-
-			input_element = (ch_p('<') >> as_lower_d[str_p("input")] >> *input_item >> ch_p('>'))
-				[insert_at_a(self.m_properties.m_inputItems, itemName, itemValue)];
-
-			// INPUTPREV tags have name and either factor or value items
-			// There should be only one INPUTPREV tag
-			// FIXME: save those
-			inputprev_item = input_item_name |
-				input_item_factor |
-				input_item_value;
-
-			inputprev_element = ch_p('<') >> as_lower_d[str_p("inputprev")] >> *inputprev_item >> ch_p('>');
-
-			// INPUTNEXT tags have name and either factor or value items
-			// There should be only one INPUTNEXT tag
-			inputnext_item = input_item_name[assign_a(self.m_properties.m_nextInput, itemName)] |
-				input_item_factor[assign_a(self.m_properties.m_nextFactor, itemValue)] |
-				input_item_value[assign_a(self.m_properties.m_nextValue, itemValue)];
-
-			inputnext_element = ch_p('<') >> as_lower_d[str_p("inputnext")] >> *inputnext_item >> ch_p('>');
-
-			// INTERPRET tags have varied types of items
-			// There should be only one INTERPRET tag
-			interpret_item = (any_name[assign_a(itemName)]
-				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)])
-				[insert_at_a(self.m_properties.m_interpretParams, itemName, itemValue)];
-
-			interpret_element = ch_p('<') >> as_lower_d[str_p("interpret")] >> *interpret_item >> ch_p('>');
-
-			// INPUT, INPUTNEXT and INTERPRET may appear in any order
-			input_elements = *(input_element |
-				inputprev_element |
-				inputnext_element |
-				interpret_element);
-
-			// SEARCH has a closing tag
-			search_footer =  ch_p('<') >> ch_p('/') >> as_lower_d[str_p("search")] >> ch_p('>');
-		}
-
-		string unquotedValue, itemName, itemValue;		
-		rule<ScannerT> search_plugin, search_header, search_footer;
-		rule<ScannerT> end_of_name, any_name, any_value_without_quotes, any_value, search_item;
-		rule<ScannerT> input_elements, input_element, inputprev_element, inputnext_element, interpret_element;
-		rule<ScannerT> input_item_name, input_item_value, input_item_user, input_item_factor;
-		rule<ScannerT> input_item, inputprev_item, inputnext_item, interpret_item;
-
-		rule<ScannerT> const& start() const
-		{
-			return search_plugin;
-		}
-	};
-
-	PluginProperties &m_properties;
-
-};
-
-PluginParser::PluginParser(const Document *pDocument)
-{
-	m_pDocument = pDocument;
-}
-
-PluginParser::~PluginParser()
-{
-}
-
-bool PluginParser::parse(bool extractSearchParams)
-{
-	if (m_pDocument == NULL)
-	{
-		return false;
-	}
-
-	unsigned int dataLength;
-	const char *pData = m_pDocument->getData(dataLength);
-	if ((pData == NULL) ||
-		(dataLength == 0))
-	{
-		return false;
-	}
-
-	skip_grammar skip;
-	parse_info<> parseInfo;
-
-	if (extractSearchParams == false)
-	{
-		plugin_grammar plugin(m_properties);
-
-		parseInfo = boost::spirit::parse(pData, plugin, skip);
-	}
-	else
-	{
-		plugin_min_grammar plugin(m_properties);
-
-		parseInfo = boost::spirit::parse(pData, plugin, skip);
-	}
-#ifdef DEBUG
-	if (parseInfo.full == false)
-	{
-		cout << "PluginParser::parse: syntax error near " << parseInfo.stop << endl;
-	}
-#endif
-
-	return parseInfo.hit;
-}
-
-/// Returns the plugin's properties.
-PluginProperties &PluginParser::getProperties(void)
-{
-	return m_properties;
-}
-
-/// Returns a pointer to the plugin file's document.
-const Document *PluginParser::getDocument(void)
-{
-	return m_pDocument;
-}

Deleted: trunk/Utils/PluginParser.h
===================================================================
--- trunk/Utils/PluginParser.h	2006-01-22 08:25:19 UTC (rev 72)
+++ trunk/Utils/PluginParser.h	2006-01-22 09:16:00 UTC (rev 73)
@@ -1,78 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#ifndef _PLUGIN_PARSER_H
-#define _PLUGIN_PARSER_H
-
-#include <string>
-#include <map>
-
-#include "Document.h"
-
-using namespace std;
-
-class PluginProperties
-{
-	public:
-		PluginProperties()
-		{
-		}
-		virtual ~PluginProperties()
-		{
-		}
-
-
-		map<string, string> m_searchParams;
-		map<string, string> m_inputItems;
-		string m_userInput;
-		string m_nextInput;
-		string m_nextFactor;
-		string m_nextValue;
-		map<string, string> m_interpretParams;
-
-	private:
-		PluginProperties(const PluginProperties &other);
-		PluginProperties& operator=(const PluginProperties& other);
-
-};
-
-/// A parser for Sherlock plugin files.
-class PluginParser
-{
-	public:
-		PluginParser(const Document *pDocument);
-		virtual ~PluginParser();
-
-		/// Parses the plugin; false if not all could be parsed.
-		bool parse(bool extractSearchParams = false);
-
-		/// Returns the plugin's properties.
-		virtual PluginProperties &getProperties(void);
-
-		/// Returns a pointer to the plugin file's document.
-		virtual const Document *getDocument(void);
-
-	protected:
-		const Document *m_pDocument;
-		PluginProperties m_properties;
-
-	private:
-		PluginParser(const PluginParser &other);
-		PluginParser& operator=(const PluginParser& other);
-
-};
-
-#endif // _PLUGIN_PARSER_H

Deleted: trunk/Utils/plugintest.cpp
===================================================================
--- trunk/Utils/plugintest.cpp	2006-01-22 08:25:19 UTC (rev 72)
+++ trunk/Utils/plugintest.cpp	2006-01-22 09:16:00 UTC (rev 73)
@@ -1,111 +0,0 @@
-/*
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#include <strings.h>
-#include <sys/types.h>
-#include <sys/stat.h>
-#include <fcntl.h>
-#include <unistd.h>
-#include <iostream>
-#include <string>
-
-#include "PluginParser.h"
-
-using namespace std;
-
-int main(int argc, char **argv)
-{
-	if (argc < 2)
-	{
-		cerr << "Usage: " << argv[0] << " <file name> [MIN]" << endl;
-		return EXIT_FAILURE;
-	}
-
-	struct stat fileStat;
-	if ((stat(argv[1], &fileStat) == 0) &&
-		(S_ISREG(fileStat.st_mode)))
-	{
-		char *buffer = new char[fileStat.st_size + 1];
-		int fd = open(argv[1], O_RDONLY);
-		// Read the file
-		ssize_t readBytes = read(fd, buffer, fileStat.st_size);
-		if (readBytes == -1)
-		{
-			cerr << "Couldn't read " << argv[1] << " !" << endl;
-			return EXIT_FAILURE;
-		}
-
-		// Put that data into a document
-		Document doc;
-		doc.setData(buffer, readBytes);
-		delete[] buffer;
-
-		bool minParser = false;
-		PluginParser parser(&doc);
-
-		if ((argc >= 3) &&
-			(strncasecmp(argv[2], "MIN", 3) == 0))
-		{
-			minParser = true;
-		}
-
-		if (parser.parse(minParser) == true)
-		{
-			cout << "Successfully parsed " << argv[1] << endl;
-		}
-
-		PluginProperties &properties = parser.getProperties();
-
-		cout << "SEARCH parameters are :" << endl;
-		for (map<string, string>::iterator iter = properties.m_searchParams.begin();
-			iter != properties.m_searchParams.end(); ++iter)
-		{
-			cout << iter->first << "=" << iter->second << endl;
-		}
-		cout << "End of SEARCH parameters" << endl;
-
-		cout << "INPUT items are :" << endl;
-		for (map<string, string>::iterator iter = properties.m_inputItems.begin();
-			iter != properties.m_inputItems.end(); ++iter)
-		{
-			if (iter->first != properties.m_userInput)
-			{
-				cout << iter->first << "=" << iter->second << endl;
-			}
-			else
-			{
-				cout << iter->first << " USER" << endl;
-			}
-		}
-		cout << "NEXT " << properties.m_nextInput << "=" << properties.m_nextFactor << endl;
-		cout << "End of INPUT items" << endl;
-
-		cout << "INTERPRET parameters are :" << endl;
-		for (map<string, string>::iterator iter = properties.m_interpretParams.begin();
-			iter != properties.m_interpretParams.end(); ++iter)
-		{
-			cout << iter->first << "=" << iter->second << endl;
-		}
-		cout << "End of INTERPRET parameters" << endl;
-
-	}
-	else
-	{
-		cerr << "Couldn't stat " << argv[1] << " !" << endl;
-	}
-
-	return EXIT_SUCCESS;
-}



From fabricecolin at berlios.de  Sun Jan 22 14:37:56 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sun, 22 Jan 2006 14:37:56 +0100
Subject: [Pinot-svn] r74 - trunk/Search
Message-ID: <200601221337.k0MDbudi032262@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-22 14:37:53 +0100 (Sun, 22 Jan 2006)
New Revision: 74

Modified:
   trunk/Search/PluginWebEngine.cpp
   trunk/Search/PluginWebEngine.h
   trunk/Search/SearchPluginProperties.cpp
   trunk/Search/SearchPluginProperties.h
   trunk/Search/SherlockParser.cpp
   trunk/Search/SherlockParser.h
   trunk/Search/plugintest.cpp
Log:
First shot at unifying Sherlock and OpenSearch plugins.


Modified: trunk/Search/PluginWebEngine.cpp
===================================================================
--- trunk/Search/PluginWebEngine.cpp	2006-01-22 09:16:00 UTC (rev 73)
+++ trunk/Search/PluginWebEngine.cpp	2006-01-22 13:37:53 UTC (rev 74)
@@ -20,38 +20,15 @@
 
 #include "Document.h"
 #include "HtmlTokenizer.h"
-#include "SherlockParser.h"
 #include "StringManip.h"
 #include "Url.h"
 #include "FileCollector.h"
+#include "SherlockParser.h"
 #include "PluginWebEngine.h"
 
-// A function object to lower case map keys with for_each()
-struct LowerAndCopy
-{
-	public:
-		LowerAndCopy(map<string, string> &other) : m_other(other)
-		{
-		}
-
-		void operator()(map<string, string>::value_type &p)
-		{
-			m_other[StringManip::toLowerCase(p.first)] = p.second;
-		}
-
-		map<string, string> &m_other;
-
-};
-
 PluginWebEngine::PluginWebEngine(const string &fileName) :
 	WebEngine()
 {
-	m_skipLocal = true;
-	m_nextFactor = 10;
-	m_nextBase = 0;
-	// SearchEngineInterface members
-	m_maxResultsCount = 10;
-
 	load(fileName);
 }
 
@@ -86,129 +63,10 @@
 
 		return false;
 	}
-	PluginProperties &properties = parser.getProperties();
 
-	map<string, string> searchParams, interpretParams;
+	// Get a copy of the properties
+	m_properties = parser.getProperties();
 
-	// Lower case these maps' keys
-	LowerAndCopy lowCopy1(searchParams);
-	for_each(properties.m_searchParams.begin(), properties.m_searchParams.end(), lowCopy1);
-	LowerAndCopy lowCopy2(interpretParams);
-	for_each(properties.m_interpretParams.begin(), properties.m_interpretParams.end(), lowCopy2);
-
-	map<string, string>::iterator mapIter = searchParams.find("name");
-	if (mapIter != searchParams.end())
-	{
-		m_name = mapIter->second;
-	}
-
-	mapIter = searchParams.find("action");
-	if (mapIter != searchParams.end())
-	{
-		m_baseUrl = mapIter->second;
-	}
-
-	mapIter = searchParams.find("routetype");
-	if (mapIter != searchParams.end())
-	{
-		m_channel = mapIter->second;
-	}
-
-	copy(properties.m_inputItems.begin(), properties.m_inputItems.end(), inserter(m_inputTags, m_inputTags.begin()));
-	if (properties.m_userInput.empty() == false)
-	{
-		// Remove the user input tag from the input tags map
-		mapIter = m_inputTags.find(properties.m_userInput);
-		if (mapIter != m_inputTags.end())
-		{
-			m_inputTags.erase(mapIter);
-		}
-		m_userInputTag = properties.m_userInput;
-	}
-
-	mapIter = interpretParams.find("resultliststart");
-	if (mapIter != interpretParams.end())
-	{
-		m_resultListStart = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
-	}
-
-	mapIter = interpretParams.find("resultlistend");
-	if (mapIter != interpretParams.end())
-	{
-		m_resultListEnd = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
-	}
-
-	mapIter = interpretParams.find("resultitemstart");
-	if (mapIter != interpretParams.end())
-	{
-		m_resultItemStart = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
-	}
-
-	mapIter = interpretParams.find("resultitemend");
-	if (mapIter != interpretParams.end())
-	{
-		m_resultItemEnd = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
-	}
-
-	mapIter = interpretParams.find("resulttitlestart");
-	if (mapIter != interpretParams.end())
-	{
-		m_resultTitleStart = mapIter->second;
-	}
-
-	mapIter = interpretParams.find("resulttitleend");
-	if (mapIter != interpretParams.end())
-	{
-		
-		m_resultTitleEnd = mapIter->second;
-	}
-
-	mapIter = interpretParams.find("resultlinkstart");
-	if (mapIter != interpretParams.end())
-	{
-		m_resultLinkStart = mapIter->second;
-	}
-
-	mapIter = interpretParams.find("resultlinkend");
-	if (mapIter != interpretParams.end())
-	{
-		m_resultLinkEnd = mapIter->second;
-	}
-
-	mapIter = interpretParams.find("resultextractstart");
-	if (mapIter != interpretParams.end())
-	{
-		m_resultExtractStart = mapIter->second;
-	}
-
-	mapIter = interpretParams.find("resultextractend");
-	if (mapIter != interpretParams.end())
-	{
-		m_resultExtractEnd = mapIter->second;
-	}
-
-	mapIter = interpretParams.find("skiplocal");
-	if (mapIter != interpretParams.end())
-	{
-		if (mapIter->second == "false")
-		{
-			m_skipLocal = false;
-		}
-	}
-
-	m_nextTag = properties.m_nextInput;
-	// Here we differ from how Mozilla uses these parameters
-	// Normally, either factor or value is used, but we use value
-	// as the parameter's initial value
-	if (properties.m_nextFactor.empty() == false)
-	{
-		m_nextFactor = (unsigned int)atoi(properties.m_nextFactor.c_str());
-	}
-	if (properties.m_nextValue.empty() == false)
-	{
-		m_nextBase = (unsigned int)atoi(properties.m_nextValue.c_str());
-	}
-
 	delete pPluginDoc;
 
 	return true;
@@ -252,9 +110,11 @@
 
 	// Extract the results list
 #ifdef DEBUG
-	cout << "PluginWebEngine::getPage: getting results list (" << m_resultListStart << ", " << m_resultListEnd << ")" << endl;
+	cout << "PluginWebEngine::getPage: getting results list ("
+		<< m_properties.m_resultListStart << ", " << m_properties.m_resultListEnd << ")" << endl;
 #endif
-	string resultList = StringManip::extractField(urlContent, m_resultListStart, m_resultListEnd);
+	string resultList = StringManip::extractField(urlContent,
+		m_properties.m_resultListStart, m_properties.m_resultListEnd);
 	if (resultList.empty() == true)
 	{
 		resultList = string(urlContent, urlContentLen);
@@ -263,9 +123,11 @@
 	// Extract results
 	string::size_type endPos = 0;
 #ifdef DEBUG
-	cout << "PluginWebEngine::getPage: getting first result (" << m_resultItemStart << ", " << m_resultItemEnd << ")" << endl;
+	cout << "PluginWebEngine::getPage: getting first result ("
+		<< m_properties.m_resultItemStart << ", " << m_properties.m_resultItemEnd << ")" << endl;
 #endif
-	string resultItem = StringManip::extractField(resultList, m_resultItemStart, m_resultItemEnd, endPos);
+	string resultItem = StringManip::extractField(resultList,
+		m_properties.m_resultItemStart, m_properties.m_resultItemEnd, endPos);
 	while ((resultItem.empty() == false) &&
 		(m_resultsList.size() <= m_maxResultsCount))
 	{
@@ -354,22 +216,25 @@
 		{
 			// This is not HTML
 			// Use extended attributes
-			if ((m_resultTitleStart.empty() == false) &&
-				(m_resultTitleEnd.empty() == false))
+			if ((m_properties.m_resultTitleStart.empty() == false) &&
+				(m_properties.m_resultTitleEnd.empty() == false))
 			{
-				name = StringManip::extractField(resultItem, m_resultTitleStart, m_resultTitleEnd);
+				name = StringManip::extractField(resultItem,
+					m_properties.m_resultTitleStart, m_properties.m_resultTitleEnd);
 			}
 
-			if ((m_resultLinkStart.empty() == false) &&
-				(m_resultLinkEnd.empty() == false))
+			if ((m_properties.m_resultLinkStart.empty() == false) &&
+				(m_properties.m_resultLinkEnd.empty() == false))
 			{
-				url = StringManip::extractField(resultItem, m_resultLinkStart, m_resultLinkEnd);
+				url = StringManip::extractField(resultItem,
+					m_properties.m_resultLinkStart, m_properties.m_resultLinkEnd);
 			}
 
-			if ((m_resultExtractStart.empty() == false) &&
-				(m_resultExtractEnd.empty() == false))
+			if ((m_properties.m_resultExtractStart.empty() == false) &&
+				(m_properties.m_resultExtractEnd.empty() == false))
 			{
-				extract = StringManip::extractField(resultItem, m_resultExtractStart, m_resultExtractEnd);
+				extract = StringManip::extractField(resultItem,
+					m_properties.m_resultExtractStart, m_properties.m_resultExtractEnd);
 			}
 		}
 
@@ -404,8 +269,9 @@
 		}
 
 		// Next
-		endPos += m_resultItemEnd.length();
-		resultItem = StringManip::extractField(resultList, m_resultItemStart, m_resultItemEnd, endPos);
+		endPos += m_properties.m_resultItemEnd.length();
+		resultItem = StringManip::extractField(resultList,
+			m_properties.m_resultItemStart, m_properties.m_resultItemEnd, endPos);
 	}
 	delete pUrlDoc;
 
@@ -442,24 +308,11 @@
 
 		return false;
 	}
-	PluginProperties &properties = parser.getProperties();
 
-	map<string, string> searchParams;
+	const SearchPluginProperties &properties = parser.getProperties();
+	name = properties.m_name;
+	channel = properties.m_channel;
 
-	LowerAndCopy lowCopy1(searchParams);
-	for_each(properties.m_searchParams.begin(), properties.m_searchParams.end(), lowCopy1);
-
-	map<string, string>::iterator mapIter = searchParams.find("name");
-	if (mapIter != searchParams.end())
-	{
-		name = mapIter->second;
-	}
-	mapIter = searchParams.find("routetype");
-	if (mapIter != searchParams.end())
-	{
-		channel = mapIter->second;
-	}
-
 	delete pPluginDoc;
 
 	return true;
@@ -477,55 +330,54 @@
 
 	m_resultsList.clear();
 
-	if (m_userInputTag.empty() == true)
+	if (queryString.empty() == true)
 	{
 #ifdef DEBUG
-		cout << "PluginWebEngine::runQuery: no user input tag" << endl;
+		cout << "PluginWebEngine::runQuery: query is empty" << endl;
 #endif
 		return false;
 	}
-	if (queryString.empty() == true)
+
+	map<SearchPluginProperties::Parameter, string>::iterator paramIter = m_properties.m_parameters.find(SearchPluginProperties::SEARCH_TERMS_PARAM);
+	if (paramIter == m_properties.m_parameters.end())
 	{
 #ifdef DEBUG
-		cout << "PluginWebEngine::runQuery: query is empty" << endl;
+		cout << "PluginWebEngine::runQuery: no user input tag" << endl;
 #endif
 		return false;
 	}
 
-	string formattedQuery = m_baseUrl;
+	string userInputTag(paramIter->second);
+	string formattedQuery = m_properties.m_baseUrl;
 	formattedQuery += "?";
-	formattedQuery += m_userInputTag;
+	formattedQuery += userInputTag;
 	formattedQuery += "=";
 	formattedQuery += queryString;
-	for (map<string, string>::iterator tagIter = m_inputTags.begin(); tagIter != m_inputTags.end(); ++tagIter)
-	{
-		formattedQuery += "&";
-		formattedQuery += tagIter->first;
-		formattedQuery += "=";
-		formattedQuery += tagIter->second;
-	}
+	formattedQuery += "&";
+	formattedQuery += m_properties.m_parametersRemainder;
 
 	setHostNameFilter(queryProps.getHostFilter());
 	setFileNameFilter(queryProps.getFileFilter());
 
 #ifdef DEBUG
-	cout << "PluginWebEngine::runQuery: querying " << m_name << endl;
+	cout << "PluginWebEngine::runQuery: querying "
+		<< m_properties.m_name << endl;
 #endif
 	while (count < m_maxResultsCount)
 	{
 		string pageQuery = formattedQuery;
 
-		if (m_nextTag.empty() == false)
+		if (m_properties.m_nextTag.empty() == false)
 		{
 			char factorStr[64];
 
 			// Is the INPUTNEXT FACTOR set to zero ?
-			if (m_nextFactor == 0)
+			if (m_properties.m_nextFactor == 0)
 			{
 				// Assume INPUTNEXT allows to specify a number of results
 				// Not sure if this is how Sherlock/Mozilla interpret this
 				pageQuery += "&";
-				pageQuery += m_nextTag;
+				pageQuery += m_properties.m_nextTag;
 				pageQuery += "=";
 				snprintf(factorStr, 64, "%u", m_maxResultsCount);
 				pageQuery += factorStr;
@@ -533,9 +385,9 @@
 			else
 			{
 				pageQuery += "&";
-				pageQuery += m_nextTag;
+				pageQuery += m_properties.m_nextTag;
 				pageQuery += "=";
-				snprintf(factorStr, 64, "%u", currentFactor + m_nextBase);
+				snprintf(factorStr, 64, "%u", currentFactor + m_properties.m_nextBase);
 				pageQuery += factorStr;
 			}
 		}
@@ -545,7 +397,7 @@
 			break;
 		}
 
-		if (m_nextFactor == 0)
+		if (m_properties.m_nextFactor == 0)
 		{
 			// That one page should have all the results...
 #ifdef DEBUG
@@ -555,7 +407,7 @@
 		}
 		else
 		{
-			if (m_resultsList.size() < count + m_nextFactor)
+			if (m_resultsList.size() < count + m_properties.m_nextFactor)
 			{
 				// We got less than the maximum number of results per page
 				// so there's no point in requesting the next page
@@ -566,7 +418,7 @@
 			}
 
 			// Increase factor
-			currentFactor += m_nextFactor;
+			currentFactor += m_properties.m_nextFactor;
 		}
 		count = m_resultsList.size();
 	}

Modified: trunk/Search/PluginWebEngine.h
===================================================================
--- trunk/Search/PluginWebEngine.h	2006-01-22 09:16:00 UTC (rev 73)
+++ trunk/Search/PluginWebEngine.h	2006-01-22 13:37:53 UTC (rev 74)
@@ -18,13 +18,10 @@
 #define _XML_WEB_ENGINE_H
 
 #include <string>
-#include <set>
-#include <map>
 
+#include "SearchPluginProperties.h"
 #include "WebEngine.h"
 
-using namespace std;
-
 /**
   * A class that implements the Sherlock search plugin standard.
   * See http://developer.apple.com/technotes/tn/tn1141.html
@@ -33,39 +30,21 @@
 class PluginWebEngine : public WebEngine
 {
 	public:
-		PluginWebEngine(const string &fileName);
+		PluginWebEngine(const std::string &fileName);
 		virtual ~PluginWebEngine();
 
 		/// Utility method that returns a search plugin's name and channel.
-		static bool getDetails(const string &fileName, string &name, string &channel);
+		static bool getDetails(const std::string &fileName, std::string &name, std::string &channel);
 
 		/// Runs a query; true if success.
 		virtual bool runQuery(QueryProperties& queryProps);
 
 	protected:
-		string m_name;
-		string m_baseUrl;
-		string m_channel;
-		map<string, string> m_inputTags;
-		string m_userInputTag;
-		string m_resultListStart;
-		string m_resultListEnd;
-		string m_resultItemStart;
-		string m_resultItemEnd;
-		string m_resultTitleStart;
-		string m_resultTitleEnd;
-		string m_resultLinkStart;
-		string m_resultLinkEnd;
-		string m_resultExtractStart;
-		string m_resultExtractEnd;
-		bool m_skipLocal;
-		string m_nextTag;
-		unsigned int m_nextFactor;
-		unsigned int m_nextBase;
+		SearchPluginProperties m_properties;
 
-		bool load(const string &fileName);
+		bool load(const std::string &fileName);
 
-		bool getPage(const string &formattedQuery);
+		bool getPage(const std::string &formattedQuery);
 
 	private:
 		PluginWebEngine(const PluginWebEngine &other);

Modified: trunk/Search/SearchPluginProperties.cpp
===================================================================
--- trunk/Search/SearchPluginProperties.cpp	2006-01-22 09:16:00 UTC (rev 73)
+++ trunk/Search/SearchPluginProperties.cpp	2006-01-22 13:37:53 UTC (rev 74)
@@ -21,7 +21,11 @@
 using std::set;
 
 SearchPluginProperties::SearchPluginProperties() :
-	m_method(GET_METHOD)
+	m_method(GET_METHOD),
+	m_nextFactor(10),
+	m_nextBase(0),
+	m_response(UNKNOWN_RESPONSE),
+	m_skipLocal(true)
 {
 }
 
@@ -33,7 +37,21 @@
 	m_baseUrl(other.m_baseUrl),
 	m_method(other.m_method),
 	m_parametersRemainder(other.m_parametersRemainder),
-	m_outputType(other.m_outputType)
+	m_outputType(other.m_outputType),
+	m_nextTag(other.m_nextTag),
+	m_nextFactor(other.m_nextFactor),
+	m_nextBase(other.m_nextBase),
+	m_resultListStart(other.m_resultListStart),
+	m_resultListEnd(other.m_resultListEnd),
+	m_resultItemStart(other.m_resultItemStart),
+	m_resultItemEnd(other.m_resultItemEnd),
+	m_resultTitleStart(other.m_resultTitleStart),
+	m_resultTitleEnd(other.m_resultTitleEnd),
+	m_resultLinkStart(other.m_resultLinkStart),
+	m_resultLinkEnd(other.m_resultLinkEnd),
+	m_resultExtractStart(other.m_resultExtractStart),
+	m_resultExtractEnd(other.m_resultExtractEnd),
+	m_skipLocal(other.m_skipLocal)
 {
 	copy(other.m_languages.begin(), other.m_languages.end(),
 		inserter(m_languages, m_languages.begin()));
@@ -59,6 +77,21 @@
 	m_method = other.m_method;
 	m_parametersRemainder = other.m_parametersRemainder;
 	m_outputType = other.m_outputType;
+	m_nextTag = other.m_nextTag;
+	m_nextFactor = other.m_nextFactor;
+	m_nextBase = other.m_nextBase;
+	m_resultListStart = other.m_resultListStart;
+	m_resultListEnd = other.m_resultListEnd;
+	m_resultItemStart = other.m_resultItemStart;
+	m_resultItemEnd = other.m_resultItemEnd;
+	m_resultTitleStart = other.m_resultTitleStart;
+	m_resultTitleEnd = other.m_resultTitleEnd;
+	m_resultLinkStart = other.m_resultLinkStart;
+	m_resultLinkEnd = other.m_resultLinkEnd;
+	m_resultExtractStart = other.m_resultExtractStart;
+	m_resultExtractEnd = other.m_resultExtractEnd;
+	m_skipLocal = other.m_skipLocal;
+
 	copy(other.m_languages.begin(), other.m_languages.end(),
 		inserter(m_languages, m_languages.begin()));
 	copy(other.m_outputEncodings.begin(), other.m_outputEncodings.end(),

Modified: trunk/Search/SearchPluginProperties.h
===================================================================
--- trunk/Search/SearchPluginProperties.h	2006-01-22 09:16:00 UTC (rev 73)
+++ trunk/Search/SearchPluginProperties.h	2006-01-22 13:37:53 UTC (rev 74)
@@ -38,6 +38,9 @@
 			 COUNT_PARAM,START_INDEX_PARAM, START_PAGE_PARAM, LANGUAGE_PARAM,
 			OUTPUT_ENCODING_PARAM, INPUT_ENCODING_PARAM } Parameter;
 
+		typedef enum { UNKNOWN_RESPONSE = 0, XML_RESPONSE,
+			HTML_RESPONSE } Response;
+
 		// Description
 		std::string m_name;
 		std::string m_longName;
@@ -52,6 +55,23 @@
 		std::map<Parameter, std::string> m_parameters;
 		std::string m_parametersRemainder;
 		std::string m_outputType;
+		// Query, next page
+		std::string m_nextTag;
+		unsigned int m_nextFactor;
+		unsigned int m_nextBase;
+		// Response
+		Response m_response;
+		std::string m_resultListStart;
+		std::string m_resultListEnd;
+		std::string m_resultItemStart;
+		std::string m_resultItemEnd;
+		std::string m_resultTitleStart;
+		std::string m_resultTitleEnd;
+		std::string m_resultLinkStart;
+		std::string m_resultLinkEnd;
+		std::string m_resultExtractStart;
+		std::string m_resultExtractEnd;
+		bool m_skipLocal;
 
 };
 

Modified: trunk/Search/SherlockParser.cpp
===================================================================
--- trunk/Search/SherlockParser.cpp	2006-01-22 09:16:00 UTC (rev 73)
+++ trunk/Search/SherlockParser.cpp	2006-01-22 13:37:53 UTC (rev 74)
@@ -21,8 +21,32 @@
 #include <boost/spirit/actor/insert_at_actor.hpp>
 #include <boost/spirit/utility/confix.hpp>
 
+#include "StringManip.h"
 #include "SherlockParser.h"
 
+using std::cout;
+using std::endl;
+using std::string;
+using std::map;
+
+// A function object to lower case map keys with for_each()
+struct LowerAndCopy
+{
+	public:
+		LowerAndCopy(map<string, string> &other) :
+			m_other(other)
+		{
+		}
+
+		void operator()(map<string, string>::value_type &p)
+		{
+			m_other[StringManip::toLowerCase(p.first)] = p.second;
+		}
+
+		map<string, string> &m_other;
+
+};
+
 using namespace std;
 using namespace boost::spirit;
 
@@ -54,8 +78,8 @@
   */
 struct plugin_min_grammar : public grammar<plugin_min_grammar>
 {
-	 plugin_min_grammar(PluginProperties &properties)
-        : m_properties(properties)
+	 plugin_min_grammar(map<string, string> &searchParams) :
+		m_searchParams(searchParams)
 	{
 	}
 
@@ -79,7 +103,7 @@
 			// There should be only one SEARCH tag
 			search_item = (any_name[assign_a(itemName)]
 				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)])
-				[insert_at_a(self.m_properties.m_searchParams, itemName, itemValue)];
+				[insert_at_a(self.m_searchParams, itemName, itemValue)];
 
 			// SEARCH may have any number of attributes
 			search_header = ch_p('<') >> as_lower_d[str_p("search")] >> *search_item >> ch_p('>');
@@ -98,7 +122,7 @@
 		}
 	};
 
-	PluginProperties &m_properties;
+	map<string, string> &m_searchParams;
 
 };
 
@@ -109,8 +133,19 @@
   */
 struct plugin_grammar : public grammar<plugin_grammar>
 {
-	 plugin_grammar(PluginProperties &properties)
-        : m_properties(properties)
+	 plugin_grammar(map<string, string> &searchParams,
+		map<string, string> &interpretParams,
+		map<string, string> &inputItems,
+		string &userInput, string &nextInput,
+		string &nextFactor,
+		string &nextValue) :
+		m_searchParams(searchParams),
+		m_interpretParams(interpretParams),
+		m_inputItems(inputItems),
+		m_userInput(userInput),
+		m_nextInput(nextInput),
+		m_nextFactor(nextFactor),
+		m_nextValue(nextValue)
 	{
 	}
 
@@ -134,7 +169,7 @@
 			// There should be only one SEARCH tag
 			search_item = (any_name[assign_a(itemName)]
 				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)])
-				[insert_at_a(self.m_properties.m_searchParams, itemName, itemValue)];
+				[insert_at_a(self.m_searchParams, itemName, itemValue)];
 
 			// SEARCH may have any number of attributes
 			search_header = ch_p('<') >> as_lower_d[str_p("search")] >> *search_item >> ch_p('>');
@@ -151,10 +186,10 @@
 			// INPUT tags have name and value items; one is marked with USER
 			input_item = input_item_name |
 				input_item_value |
-				input_item_user[assign_a(self.m_properties.m_userInput, itemName)];
+				input_item_user[assign_a(self.m_userInput, itemName)];
 
 			input_element = (ch_p('<') >> as_lower_d[str_p("input")] >> *input_item >> ch_p('>'))
-				[insert_at_a(self.m_properties.m_inputItems, itemName, itemValue)];
+				[insert_at_a(self.m_inputItems, itemName, itemValue)];
 
 			// INPUTPREV tags have name and either factor or value items
 			// There should be only one INPUTPREV tag
@@ -167,9 +202,9 @@
 
 			// INPUTNEXT tags have name and either factor or value items
 			// There should be only one INPUTNEXT tag
-			inputnext_item = input_item_name[assign_a(self.m_properties.m_nextInput, itemName)] |
-				input_item_factor[assign_a(self.m_properties.m_nextFactor, itemValue)] |
-				input_item_value[assign_a(self.m_properties.m_nextValue, itemValue)];
+			inputnext_item = input_item_name[assign_a(self.m_nextInput, itemName)] |
+				input_item_factor[assign_a(self.m_nextFactor, itemValue)] |
+				input_item_value[assign_a(self.m_nextValue, itemValue)];
 
 			inputnext_element = ch_p('<') >> as_lower_d[str_p("inputnext")] >> *inputnext_item >> ch_p('>');
 
@@ -177,7 +212,7 @@
 			// There should be only one INTERPRET tag
 			interpret_item = (any_name[assign_a(itemName)]
 				>> ch_p('=') >> any_value[assign_a(itemValue, unquotedValue)])
-				[insert_at_a(self.m_properties.m_interpretParams, itemName, itemValue)];
+				[insert_at_a(self.m_interpretParams, itemName, itemValue)];
 
 			interpret_element = ch_p('<') >> as_lower_d[str_p("interpret")] >> *interpret_item >> ch_p('>');
 
@@ -204,7 +239,13 @@
 		}
 	};
 
-	PluginProperties &m_properties;
+	map<string, string> &m_searchParams;
+	map<string, string> &m_interpretParams;
+	map<string, string> &m_inputItems;
+	string &m_userInput;
+	string &m_nextInput;
+	string &m_nextFactor;
+	string &m_nextValue;
 
 };
 
@@ -232,33 +273,181 @@
 		return false;
 	}
 
+	map<string, string> searchParams, interpretParams, inputItems;
+	string userInput, nextInput, nextFactor, nextValue;
 	skip_grammar skip;
 	parse_info<> parseInfo;
 
 	if (extractSearchParams == false)
 	{
-		plugin_grammar plugin(m_properties);
+		plugin_grammar plugin(searchParams, interpretParams, inputItems,
+			userInput, nextInput, nextFactor, nextValue);
 
 		parseInfo = boost::spirit::parse(pData, plugin, skip);
 	}
 	else
 	{
-		plugin_min_grammar plugin(m_properties);
+		plugin_min_grammar plugin(searchParams);
 
 		parseInfo = boost::spirit::parse(pData, plugin, skip);
 	}
-#ifdef DEBUG
-	if (parseInfo.full == false)
+
+	if (parseInfo.full == true)
 	{
-		cout << "SherlockParser::parse: syntax error near " << parseInfo.stop << endl;
+		map<string, string> lowSearchParams, lowInterpretParams, lowInputItems;
+
+		LowerAndCopy lowCopy1(lowSearchParams);
+		for_each(searchParams.begin(), searchParams.end(), lowCopy1);
+		LowerAndCopy lowCopy2(lowInterpretParams);
+		for_each(interpretParams.begin(), interpretParams.end(), lowCopy2);
+		LowerAndCopy lowCopy3(lowInputItems);
+		for_each(inputItems.begin(), inputItems.end(), lowCopy3);
+
+		// Response
+		m_properties.m_response = SearchPluginProperties::HTML_RESPONSE;
+		// Method
+		m_properties.m_method = SearchPluginProperties::GET_METHOD;
+
+		// Name
+		map<string, string>::iterator mapIter = lowSearchParams.find("name");
+		if (mapIter != lowSearchParams.end())
+		{
+			m_properties.m_name = mapIter->second;
+		}
+
+		// Channel
+		mapIter = lowSearchParams.find("routetype");
+		if (mapIter != lowSearchParams.end())
+		{
+			m_properties.m_channel = mapIter->second;
+		}
+
+		if (extractSearchParams == false)
+		{
+			if (userInput.empty() == false)
+			{
+				// Remove the user input tag from the input tags map
+				mapIter = lowInputItems.find(userInput);
+				if (mapIter != lowInputItems.end())
+				{
+					lowInputItems.erase(mapIter);
+				}
+
+				m_properties.m_parameters[SearchPluginProperties::SEARCH_TERMS_PARAM] = userInput;
+			}
+			for (map<string, string>::iterator iter = lowInputItems.begin();
+				iter != lowInputItems.end(); ++iter)
+			{
+				// Append to the remainder
+				if (m_properties.m_parametersRemainder.empty() == false)
+				{
+					m_properties.m_parametersRemainder += "&";
+				}
+				m_properties.m_parametersRemainder += iter->first;
+				m_properties.m_parametersRemainder += "=";
+				m_properties.m_parametersRemainder += iter->second;
+			}
+
+			// URL
+			mapIter = lowSearchParams.find("action");
+			if (mapIter != lowSearchParams.end())
+			{
+				m_properties.m_baseUrl = mapIter->second;
+			}
+
+			// Response
+			mapIter = lowInterpretParams.find("resultliststart");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultListStart = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
+			}
+
+			mapIter = lowInterpretParams.find("resultlistend");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultListEnd = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
+			}
+
+			mapIter = lowInterpretParams.find("resultitemstart");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultItemStart = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
+			}
+
+			mapIter = lowInterpretParams.find("resultitemend");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultItemEnd = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
+			}
+
+			mapIter = lowInterpretParams.find("resulttitlestart");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultTitleStart = mapIter->second;
+			}
+
+			mapIter = lowInterpretParams.find("resulttitleend");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultTitleEnd = mapIter->second;
+			}
+
+			mapIter = lowInterpretParams.find("resultlinkstart");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultLinkStart = mapIter->second;
+			}
+
+			mapIter = lowInterpretParams.find("resultlinkend");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultLinkEnd = mapIter->second;
+			}
+
+			mapIter = lowInterpretParams.find("resultextractstart");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultExtractStart = mapIter->second;
+			}
+
+			mapIter = lowInterpretParams.find("resultextractend");
+			if (mapIter != lowInterpretParams.end())
+			{
+				m_properties.m_resultExtractEnd = mapIter->second;
+			}
+
+			mapIter = lowInterpretParams.find("skiplocal");
+			if (mapIter != lowInterpretParams.end())
+			{
+				if (mapIter->second == "false")
+				{
+					m_properties.m_skipLocal = false;
+				}
+			}
+
+			m_properties.m_nextTag = nextInput;
+			// Here we differ from how Mozilla uses these parameters
+			// Normally, either factor or value is used, but we use value
+			// as the parameter's initial value
+			if (nextFactor.empty() == false)
+			{
+				m_properties.m_nextFactor = (unsigned int)atoi(nextFactor.c_str());
+			}
+			if (nextValue.empty() == false)
+			{
+				m_properties.m_nextBase = (unsigned int)atoi(nextValue.c_str());
+			}
+		}
 	}
+#ifdef DEBUG
+	else cout << "SherlockParser::parse: syntax error near " << parseInfo.stop << endl;
 #endif
 
 	return parseInfo.hit;
 }
 
 /// Returns the plugin's properties.
-PluginProperties &SherlockParser::getProperties(void)
+const SearchPluginProperties &SherlockParser::getProperties(void)
 {
 	return m_properties;
 }

Modified: trunk/Search/SherlockParser.h
===================================================================
--- trunk/Search/SherlockParser.h	2006-01-22 09:16:00 UTC (rev 73)
+++ trunk/Search/SherlockParser.h	2006-01-22 13:37:53 UTC (rev 74)
@@ -21,32 +21,8 @@
 #include <map>
 
 #include "Document.h"
+#include "SearchPluginProperties.h"
 
-class PluginProperties
-{
-	public:
-		PluginProperties()
-		{
-		}
-		virtual ~PluginProperties()
-		{
-		}
-
-
-		std::map<std::string, std::string> m_searchParams;
-		std::map<std::string, std::string> m_inputItems;
-		std::string m_userInput;
-		std::string m_nextInput;
-		std::string m_nextFactor;
-		std::string m_nextValue;
-		std::map<std::string, std::string> m_interpretParams;
-
-	private:
-		PluginProperties(const PluginProperties &other);
-		PluginProperties& operator=(const PluginProperties& other);
-
-};
-
 /**
   * A parser for Sherlock plugin files.
   * See http://developer.apple.com/technotes/tn/tn1141.html
@@ -62,11 +38,11 @@
 		bool parse(bool extractSearchParams = false);
 
 		/// Returns the plugin's properties.
-		virtual PluginProperties &getProperties(void);
+		virtual const SearchPluginProperties &getProperties(void);
 
 	protected:
 		const Document *m_pDocument;
-		PluginProperties m_properties;
+		SearchPluginProperties m_properties;
 
 	private:
 		SherlockParser(const SherlockParser &other);

Modified: trunk/Search/plugintest.cpp
===================================================================
--- trunk/Search/plugintest.cpp	2006-01-22 09:16:00 UTC (rev 73)
+++ trunk/Search/plugintest.cpp	2006-01-22 13:37:53 UTC (rev 74)
@@ -39,6 +39,7 @@
 	if ((stat(argv[2], &fileStat) == 0) &&
 		(S_ISREG(fileStat.st_mode)))
 	{
+		SearchPluginProperties properties;
 		bool minParser = false;
 
 		if ((argc >= 4) &&
@@ -71,39 +72,7 @@
 				cout << "Successfully parsed " << argv[2] << endl;
 			}
 
-			PluginProperties &properties = parser.getProperties();
-
-			cout << "SEARCH parameters are :" << endl;
-			for (map<string, string>::iterator iter = properties.m_searchParams.begin();
-				iter != properties.m_searchParams.end(); ++iter)
-			{
-				cout << iter->first << "=" << iter->second << endl;
-			}
-			cout << "End of SEARCH parameters" << endl;
-
-			cout << "INPUT items are :" << endl;
-			for (map<string, string>::iterator iter = properties.m_inputItems.begin();
-				iter != properties.m_inputItems.end(); ++iter)
-			{
-				if (iter->first != properties.m_userInput)
-				{
-					cout << iter->first << "=" << iter->second << endl;
-				}
-				else
-				{
-					cout << iter->first << " USER" << endl;
-				}
-			}
-			cout << "NEXT " << properties.m_nextInput << "=" << properties.m_nextFactor << endl;
-			cout << "End of INPUT items" << endl;
-
-			cout << "INTERPRET parameters are :" << endl;
-			for (map<string, string>::iterator iter = properties.m_interpretParams.begin();
-				iter != properties.m_interpretParams.end(); ++iter)
-			{
-				cout << iter->first << "=" << iter->second << endl;
-			}
-			cout << "End of INTERPRET parameters" << endl;
+			properties = parser.getProperties();
 		}
 		else if (strncasecmp(argv[1], "OPENSEARCH", 10) == 0)
 		{
@@ -114,19 +83,19 @@
 				cout << "Successfully parsed " << argv[2] << endl;
 			}
 
-			SearchPluginProperties &properties = parser.getProperties();
+			properties = parser.getProperties();
+		}
 
-			cout << "Plugin " << properties.m_name << ": " << properties.m_description << endl;
-			cout << "Channel: " << properties.m_channel << endl;
-			cout << "URL: " << properties.m_baseUrl << endl;
-			cout << "Input parameters are:" << endl;
-			for (map<SearchPluginProperties::Parameter, string>::iterator iter = properties.m_parameters.begin();
-				iter != properties.m_parameters.end(); ++iter)
-			{
-				cout << iter->second << "=" << iter->first << endl;
-			}
-			cout << "Remainder:" << properties.m_parametersRemainder << endl;
+		cout << "Plugin " << properties.m_name << ": " << properties.m_description << endl;
+		cout << "Channel: " << properties.m_channel << endl;
+		cout << "URL: " << properties.m_baseUrl << endl;
+		cout << "Input parameters are:" << endl;
+		for (map<SearchPluginProperties::Parameter, string>::iterator iter = properties.m_parameters.begin();
+			iter != properties.m_parameters.end(); ++iter)
+		{
+			cout << iter->second << "=" << iter->first << endl;
 		}
+		cout << "Remainder: " << properties.m_parametersRemainder << endl;
 	}
 	else
 	{



From fabricecolin at berlios.de  Wed Jan 25 12:46:15 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 25 Jan 2006 12:46:15 +0100
Subject: [Pinot-svn] r75 - trunk/Search
Message-ID: <200601251146.k0PBkFVi027181@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-25 12:46:04 +0100 (Wed, 25 Jan 2006)
New Revision: 75

Added:
   trunk/Search/OpenSearchParser.cpp
   trunk/Search/OpenSearchParser.h
   trunk/Search/PluginParsers.h
Modified:
   trunk/Search/PluginWebEngine.cpp
   trunk/Search/PluginWebEngine.h
   trunk/Search/SearchEngineInterface.h
   trunk/Search/SearchPluginProperties.cpp
   trunk/Search/SearchPluginProperties.h
   trunk/Search/SherlockParser.cpp
   trunk/Search/SherlockParser.h
   trunk/Search/plugintest.cpp
Log:
PluginWebEngine can now handle Sherlock and OpenSearch plugins (.src and .xml)
and their respective response. The OpenSearch Response parser doesn't do
anything useful just yet.


Added: trunk/Search/OpenSearchParser.cpp
===================================================================
--- trunk/Search/OpenSearchParser.cpp	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/OpenSearchParser.cpp	2006-01-25 11:46:04 UTC (rev 75)
@@ -0,0 +1,345 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <unistd.h>
+#include <iostream>
+#include <glibmm/thread.h>
+#include <glibmm/convert.h>
+#include <libxml++/parsers/domparser.h>
+#include <libxml++/nodes/node.h>
+#include <libxml++/nodes/textnode.h>
+
+#include "StringManip.h"
+#include "OpenSearchParser.h"
+
+using namespace std;
+using namespace Glib;
+using namespace xmlpp;
+
+static ustring getElementContent(const Element *pElem)
+{
+	if (pElem == NULL)
+	{
+		return "";
+	}
+
+#ifdef HAS_LIBXMLPP026
+	const TextNode *pText = pElem->get_child_content();
+#else
+	const TextNode *pText = pElem->get_child_text();
+#endif
+	if (pText == NULL)
+	{
+		return "";
+	}
+
+	return pText->get_content();
+}
+
+OpenSearchResponseParser::OpenSearchResponseParser() :
+	ResponseParserInterface()
+{
+}
+
+OpenSearchResponseParser::~OpenSearchResponseParser()
+{
+}
+
+bool OpenSearchResponseParser::parse(const ::Document *pResponseDoc, vector<Result> &resultsList,
+	unsigned int maxResultsCount) const
+{
+}
+
+OpenSearchParser::OpenSearchParser(const string &fileName) :
+	PluginParserInterface(fileName)
+{
+}
+
+OpenSearchParser::~OpenSearchParser()
+{
+}
+
+ResponseParserInterface *OpenSearchParser::parse(SearchPluginProperties &properties,
+	bool extractSearchParams)
+{
+	struct stat fileStat;
+	bool success = true;
+
+	if ((m_fileName.empty() == true) ||
+		(stat(m_fileName.c_str(), &fileStat) != 0) ||
+		(!S_ISREG(fileStat.st_mode)))
+	{
+		return NULL;
+	}
+
+	try
+	{
+		// Parse the configuration file
+		DomParser parser;
+		parser.set_substitute_entities(true);
+		parser.parse_file(m_fileName);
+		xmlpp::Document *pDocument = parser.get_document();
+		if (pDocument == NULL)
+		{
+			return NULL;
+		}
+
+		Node *pNode = pDocument->get_root_node();
+		Element *pRootElem = dynamic_cast<Element *>(pNode);
+		if (pRootElem == NULL)
+		{
+			return NULL;
+		}
+		// Check the top-level element is what we expect
+		ustring rootNodeName = pRootElem->get_name();
+		if (rootNodeName != "OpenSearchDescription")
+		{
+#ifdef DEBUG
+			cout << "OpenSearchParser::parse: wrong root node " << rootNodeName << endl;
+#endif
+			return NULL;
+		}
+
+		// Go through the subnodes
+		const Node::NodeList childNodes = pRootElem->get_children();
+		if (childNodes.empty() == false)
+		{
+			for (Node::NodeList::const_iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
+			{
+				Node *pNode = (*iter);
+				// All nodes should be elements
+				Element *pElem = dynamic_cast<Element*>(pNode);
+				if (pElem == NULL)
+				{
+					continue;
+				}
+
+				ustring nodeName = pElem->get_name();
+				ustring nodeContent = getElementContent(pElem);
+				if (nodeName == "ShortName")
+				{
+					properties.m_name = nodeContent;
+				}
+				else if (nodeName == "Description")
+				{
+					properties.m_description = nodeContent;
+				}
+				else if (nodeName == "Url")
+				{
+					ustring url, type;
+					bool xmlResponse = false, getMethod = true;
+
+					// Parse Query Syntax
+					Element::AttributeList attributes = pElem->get_attributes();
+					for (Element::AttributeList::const_iterator iter = attributes.begin();
+						iter != attributes.end(); ++iter)
+					{
+						Attribute *pAttr = (*iter);
+
+						if (pAttr != NULL)
+						{
+							ustring attrName = pAttr->get_name();
+							ustring attrContent = pAttr->get_value();
+
+							if (attrName == "template")
+							{
+								url = attrContent;
+							}
+							else if (attrName == "type")
+							{
+								type = attrContent;
+							}
+							else if (attrName == "method")
+							{
+								// GET is the default method
+								if (StringManip::toLowerCase(attrContent) != "get")
+								{
+									getMethod = false;
+								}
+							}
+						}
+					}
+
+					if (getMethod == true)
+					{
+						string::size_type startPos = 0, pos = url.find("?");
+
+						// Determine if this Url is better than previous ones
+						if ((type == "application/rss+xml") ||
+							(type == "application/atom+xml"))
+						{
+							// We prefer OpenSearch Response
+							xmlResponse = true;
+#ifdef DEBUG
+							cout << "OpenSearchParser::parse: XML response type" << endl;
+#endif
+						}
+						else if (type == "text/html")
+						{
+							// HTML is second best
+#ifdef DEBUG
+							cout << "OpenSearchParser::parse: HTML response type" << endl;
+#endif
+							if (xmlResponse == true)
+							{
+								continue;
+							}
+						}
+						else
+						{
+#ifdef DEBUG
+							cout << "OpenSearchParser::parse: unsupported response type "
+								<< type << endl;
+#endif
+							continue;
+						}
+	
+						// Break the URL down into base and parameters
+						if (pos != string::npos)
+						{
+							string params(url.substr(pos + 1));
+
+							// URL
+							properties.m_baseUrl = url.substr(0, pos);
+#ifdef DEBUG
+							cout << "OpenSearchParser::parse: URL is " << url << endl;
+#endif
+
+							// Split this into the actual parameters
+							params += "&amp;";
+							pos = params.find("&amp;");
+							while (pos != string::npos)
+							{
+								string parameter(params.substr(startPos, pos - startPos));
+
+								string::size_type equalPos = parameter.find("=");
+								if (equalPos != string::npos)
+								{
+									string paramName(parameter.substr(0, equalPos));
+									string paramValue(parameter.substr(equalPos + 1));
+									SearchPluginProperties::Parameter param = SearchPluginProperties::UNKNOWN_PARAM;
+
+									if (paramValue == "{searchTerms}")
+									{
+										param = SearchPluginProperties::SEARCH_TERMS_PARAM;
+									}
+									else if (paramValue == "{count}")
+									{
+										param = SearchPluginProperties::COUNT_PARAM;
+									}
+									else if (paramValue == "{startIndex}")
+									{
+										param = SearchPluginProperties::START_INDEX_PARAM;
+									}
+									else if (paramValue == "{startPage}")
+									{
+										param = SearchPluginProperties::START_PAGE_PARAM;
+									}
+									else if (paramValue == "{language}")
+									{
+										param = SearchPluginProperties::LANGUAGE_PARAM;
+									}
+									else if (paramValue == "{outputEncoding}")
+									{
+										param = SearchPluginProperties::OUTPUT_ENCODING_PARAM;
+									}
+									else if (paramValue == "{inputEncoding}")
+									{
+										param = SearchPluginProperties::INPUT_ENCODING_PARAM;
+									}
+
+									if (param != SearchPluginProperties::UNKNOWN_PARAM)
+									{
+										properties.m_parameters[param] = paramName;
+									}
+									else
+									{
+										// Append to the remainder
+										if (properties.m_parametersRemainder.empty() == false)
+										{
+											properties.m_parametersRemainder += "&";
+										}
+										properties.m_parametersRemainder += paramName;
+										properties.m_parametersRemainder += "=";
+										properties.m_parametersRemainder += paramValue;
+									}
+								}
+
+								// Next
+								startPos = pos + 5;
+								pos = params.find_first_of("&\n", startPos);
+							}
+						}
+
+						// Method
+						properties.m_method = SearchPluginProperties::GET_METHOD;
+						// Output type
+						properties.m_outputType = type;
+						// Response
+						if (xmlResponse == true)
+						{
+							properties.m_response = SearchPluginProperties::XML_RESPONSE;
+						}
+						else
+						{
+							properties.m_response = SearchPluginProperties::HTML_RESPONSE;
+						}
+					}
+
+					// We ignore Param as we only support GET
+				}
+				else if (nodeName == "Tags")
+				{
+					// This is a space-delimited list, pick the first tag
+					string::size_type pos = nodeContent.find(" ");
+					properties.m_channel = nodeContent.substr(0, pos);
+				}
+				else if (nodeName == "LongName")
+				{
+					properties.m_longName = nodeContent;
+				}
+				else if (nodeName == "Language")
+				{
+					properties.m_languages.insert(nodeContent);
+				}
+				else if (nodeName == "OutputEncoding")
+				{
+					properties.m_outputEncodings.insert(nodeContent);
+				}
+				else if (nodeName == "InputEncoding")
+				{
+					properties.m_inputEncodings.insert(nodeContent);
+				}
+			}
+		}
+	}
+	catch (const std::exception& ex)
+	{
+#ifdef DEBUG
+		cout << "OpenSearchParser::parse: caught exception: " << ex.what() << endl;
+#endif
+		success = false;
+	}
+
+	if (success == false)
+	{
+		return NULL;
+	}
+
+	return new OpenSearchResponseParser();
+}

Added: trunk/Search/OpenSearchParser.h
===================================================================
--- trunk/Search/OpenSearchParser.h	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/OpenSearchParser.h	2006-01-25 11:46:04 UTC (rev 75)
@@ -0,0 +1,62 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _OPENSEARCH_PARSER_H
+#define _OPENSEARCH_PARSER_H
+
+#include <string>
+
+#include "Document.h"
+#include "PluginParsers.h"
+
+class OpenSearchResponseParser : public ResponseParserInterface
+{
+	public:
+		OpenSearchResponseParser();
+		virtual ~OpenSearchResponseParser();
+
+		/// Parses the response; false if not all could be parsed.
+		virtual bool parse(const Document *pResponseDoc, std::vector<Result> &resultsList,
+			unsigned int maxResultsCount) const;
+
+	private:
+		OpenSearchResponseParser(const OpenSearchResponseParser &other);
+		OpenSearchResponseParser& operator=(const OpenSearchResponseParser& other);
+
+};
+
+/**
+  * A parser for OpenSearch Description and Query Syntax, version 1.1.
+  * See http://opensearch.a9.com/spec/1.1/description/
+  * and http://opensearch.a9.com/spec/1.1/querysyntax/
+  */
+class OpenSearchParser : public PluginParserInterface
+{
+	public:
+		OpenSearchParser(const std::string &fileName);
+		virtual ~OpenSearchParser();
+
+		/// Parses the plugin and returns a response parser.
+		virtual ResponseParserInterface *parse(SearchPluginProperties &properties,
+			bool extractSearchParams = false);
+
+	private:
+		OpenSearchParser(const OpenSearchParser &other);
+		OpenSearchParser& operator=(const OpenSearchParser& other);
+
+};
+
+#endif // _OPENSEARCH_PARSER_H

Added: trunk/Search/PluginParsers.h
===================================================================
--- trunk/Search/PluginParsers.h	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/PluginParsers.h	2006-01-25 11:46:04 UTC (rev 75)
@@ -0,0 +1,72 @@
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _PLUGIN_PARSERS_H
+#define _PLUGIN_PARSERS_H
+
+#include <string>
+#include <vector>
+
+#include "Document.h"
+#include "Result.h"
+#include "SearchPluginProperties.h"
+
+/**
+  * Interface implemented by response parsers.
+  */
+class ResponseParserInterface
+{
+	public:
+		virtual ~ResponseParserInterface()
+		{
+		}
+
+		/// Parses the response; false if not all could be parsed.
+		virtual bool parse(const Document *pResponseDoc, std::vector<Result> &resultsList,
+			unsigned int maxResultsCount) const = 0;
+
+	protected:
+		ResponseParserInterface()
+		{
+		}
+		
+};
+	
+/**
+  * Interface implemented by plugin parsers.
+  */
+class PluginParserInterface
+{
+	public:
+		virtual ~PluginParserInterface()
+		{
+		}
+
+		/// Parses the plugin and returns a response parser.
+		virtual ResponseParserInterface *parse(SearchPluginProperties &properties,
+			bool extractSearchParams = false) = 0;
+
+	protected:
+		std::string m_fileName;
+
+		PluginParserInterface(const std::string &fileName) :
+			m_fileName(fileName)
+		{
+		}
+
+};
+
+#endif // _PLUGIN_PARSERS_H

Modified: trunk/Search/PluginWebEngine.cpp
===================================================================
--- trunk/Search/PluginWebEngine.cpp	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/PluginWebEngine.cpp	2006-01-25 11:46:04 UTC (rev 75)
@@ -19,263 +19,140 @@
 #include <iostream>
 
 #include "Document.h"
-#include "HtmlTokenizer.h"
 #include "StringManip.h"
-#include "Url.h"
-#include "FileCollector.h"
+#include "OpenSearchParser.h"
 #include "SherlockParser.h"
 #include "PluginWebEngine.h"
 
 PluginWebEngine::PluginWebEngine(const string &fileName) :
-	WebEngine()
+	WebEngine(),
+	m_pResponseParser(NULL)
 {
 	load(fileName);
 }
 
 PluginWebEngine::~PluginWebEngine()
 {
+	if (m_pResponseParser != NULL)
+	{
+		delete m_pResponseParser;
+	}
 }
 
-bool PluginWebEngine::load(const string &fileName)
+void PluginWebEngine::load(const string &fileName)
 {
 	if (fileName.empty() == true)
 	{
-		return false;
+		return;
 	}
 
-	// Get the definition file
-	FileCollector fileCollect;
-	DocumentInfo docInfo("Plugin", string("file://") + fileName,
-		"text/plain", "");
-	Document *pPluginDoc = fileCollect.retrieveUrl(docInfo);
-	if (pPluginDoc == NULL)
+	PluginParserInterface *pParser = getPluginParser(fileName);
+	if (pParser == NULL)
 	{
-#ifdef DEBUG
-		cerr << "PluginWebEngine::load: couldn't load " << fileName << endl;
-#endif
-		return false;
+		return;
 	}
 
-	SherlockParser parser(pPluginDoc);
-	if (parser.parse() == false)
-	{
-		delete pPluginDoc;
-
-		return false;
-	}
-
-	// Get a copy of the properties
-	m_properties = parser.getProperties();
-
-	delete pPluginDoc;
-
-	return true;
+	m_pResponseParser = pParser->parse(m_properties);
+	delete pParser;
 }
 
 bool PluginWebEngine::getPage(const string &formattedQuery)
 {
-	bool foundResult = false;
+	if ((m_pResponseParser == NULL) ||
+		(formattedQuery.empty() == true))
+	{
+		return false;
+	}
 
-#ifdef DEBUG
-	cout << "PluginWebEngine::getPage: getting " << formattedQuery << endl;
-#endif
 	DocumentInfo docInfo("Results Page", formattedQuery,
 		"text/html", "");
-	Document *pUrlDoc = downloadPage(docInfo);
-	if (pUrlDoc == NULL)
+	Document *pResponseDoc = downloadPage(docInfo);
+	if (pResponseDoc == NULL)
 	{
 #ifdef DEBUG
-		cerr << "PluginWebEngine::getPage: couldn't download page " << formattedQuery << endl;
+		cerr << "PluginWebEngine::getPage: couldn't download page "
+			<< formattedQuery << endl;
 #endif
 		return false;
 	}
 
-	float pseudoScore = 100;
-	unsigned int urlContentLen;
-	const char *urlContent = pUrlDoc->getData(urlContentLen);
-	if ((urlContent == NULL) ||
-		(urlContentLen == 0))
+	unsigned int contentLen;
+	const char *pContent = pResponseDoc->getData(contentLen);
+	if ((pContent == NULL) ||
+		(contentLen == 0))
 	{
 #ifdef DEBUG
 		cerr << "PluginWebEngine::getPage: downloaded empty page" << endl;
 #endif
-		delete pUrlDoc;
+		delete pResponseDoc;
 		return false;
 	}
 #ifdef DEBUG
 	ofstream pageBackup("PluginWebEngine.html");
-	pageBackup.write(urlContent, urlContentLen);
+	pageBackup.write(pContent, contentLen);
 	pageBackup.close();
 #endif
 
-	// Extract the results list
-#ifdef DEBUG
-	cout << "PluginWebEngine::getPage: getting results list ("
-		<< m_properties.m_resultListStart << ", " << m_properties.m_resultListEnd << ")" << endl;
-#endif
-	string resultList = StringManip::extractField(urlContent,
-		m_properties.m_resultListStart, m_properties.m_resultListEnd);
-	if (resultList.empty() == true)
+	bool success = m_pResponseParser->parse(pResponseDoc, m_resultsList, m_maxResultsCount);
+	vector<Result>::iterator resultIter = m_resultsList.begin();
+	while (resultIter != m_resultsList.end())
 	{
-		resultList = string(urlContent, urlContentLen);
-	}
+		string url(resultIter->getLocation());
 
-	// Extract results
-	string::size_type endPos = 0;
-#ifdef DEBUG
-	cout << "PluginWebEngine::getPage: getting first result ("
-		<< m_properties.m_resultItemStart << ", " << m_properties.m_resultItemEnd << ")" << endl;
-#endif
-	string resultItem = StringManip::extractField(resultList,
-		m_properties.m_resultItemStart, m_properties.m_resultItemEnd, endPos);
-	while ((resultItem.empty() == false) &&
-		(m_resultsList.size() <= m_maxResultsCount))
-	{
-		string contentType, url, name, extract;
-
-#ifdef DEBUG
-		cout << "PluginWebEngine::getPage: candidate chunk \"" << resultItem << "\"" << endl;
-#endif
-		contentType = pUrlDoc->getType();
-		if (strncasecmp(contentType.c_str(), "text/html", 9) == 0)
+		if (processResult(url) == false)
 		{
-			Document chunkDoc("", "", contentType, "");
-			chunkDoc.setData(resultItem.c_str(), resultItem.length());
-			HtmlTokenizer chunkTokens(&chunkDoc);
-			set<Link> &chunkLinks = chunkTokens.getLinks();
-			unsigned int endOfFirstLink = 0, startOfSecondLink = 0, endOfSecondLink = 0, startOfThirdLink = 0;
-
-			// The result's URL and title should be given by the first link
-			for (set<Link>::iterator linkIter = chunkLinks.begin(); linkIter != chunkLinks.end(); ++linkIter)
+			// Remove this result
+			if (resultIter == m_resultsList.begin())
 			{
-				if (linkIter->m_pos == 0)
-				{
-					url = linkIter->m_url;
-					name = linkIter->m_name;
-#ifdef DEBUG
-					cout << "PluginWebEngine::getPage: first link in chunk is " << url << endl;
-#endif
-					endOfFirstLink = linkIter->m_close;
-				}
-				else if (linkIter->m_pos == 1)
-				{
-					startOfSecondLink = linkIter->m_open;
-					endOfSecondLink = linkIter->m_close;
-				}
-				else if (linkIter->m_pos == 2)
-				{
-					startOfThirdLink = linkIter->m_open;
-				}
+				m_resultsList.erase(resultIter);
+				resultIter = m_resultsList.begin();
 			}
-
-			// Chances are the extract is between the first two links
-			if (endOfFirstLink > 0)
+			else
 			{
-				string extractWithMarkup1, extractWithMarkup2;
-				string extractCandidate1, extractCandidate2;
-
-				if (startOfSecondLink > 0)
-				{
-					extractWithMarkup1 = resultItem.substr(endOfFirstLink, startOfSecondLink - endOfFirstLink);
-				}
-				else
-				{
-					extractWithMarkup1 = resultItem.substr(endOfFirstLink);
-				}
-				extractCandidate1 = HtmlTokenizer::stripTags(extractWithMarkup1);
-
-				// ... or between the second and third link :-)
-				if (endOfSecondLink > 0)
-				{
-					if (startOfThirdLink > 0)
-					{
-						extractWithMarkup2 = resultItem.substr(endOfSecondLink, startOfThirdLink - endOfSecondLink);
-					}
-					else
-					{
-						extractWithMarkup2 = resultItem.substr(endOfSecondLink);
-					}
-				}
-				extractCandidate2 = HtmlTokenizer::stripTags(extractWithMarkup2);
-
-				// It seems we can rely on length to determine which is the right one
-				if (extractCandidate1.length() > extractCandidate2.length())
-				{
-					extract = extractCandidate1;
-				}
-				else
-				{
-					extract = extractCandidate2;
-				}
-#ifdef DEBUG
-				cout << "PluginWebEngine::getPage: extract is \"" << extract << "\"" << endl;
-#endif
+				vector<Result>::iterator badResultIter = resultIter;
+				--resultIter;
+				m_resultsList.erase(badResultIter);
 			}
 		}
 		else
 		{
-			// This is not HTML
-			// Use extended attributes
-			if ((m_properties.m_resultTitleStart.empty() == false) &&
-				(m_properties.m_resultTitleEnd.empty() == false))
-			{
-				name = StringManip::extractField(resultItem,
-					m_properties.m_resultTitleStart, m_properties.m_resultTitleEnd);
-			}
-
-			if ((m_properties.m_resultLinkStart.empty() == false) &&
-				(m_properties.m_resultLinkEnd.empty() == false))
-			{
-				url = StringManip::extractField(resultItem,
-					m_properties.m_resultLinkStart, m_properties.m_resultLinkEnd);
-			}
-
-			if ((m_properties.m_resultExtractStart.empty() == false) &&
-				(m_properties.m_resultExtractEnd.empty() == false))
-			{
-				extract = StringManip::extractField(resultItem,
-					m_properties.m_resultExtractStart, m_properties.m_resultExtractEnd);
-			}
+			// Next
+			++resultIter;
 		}
+	}
 
-		if (url.empty() == false)
-		{
-			Url urlObj(url);
+	delete pResponseDoc;
 
-			// Is this URL relative to the search engine's domain ?
-			// FIXME: look for a interpret/baseurl tag, see https://bugzilla.mozilla.org/show_bug.cgi?id=65453
-			// FIXME: obey m_skipLocal
-			if (urlObj.getHost().empty() == true)
-			{
-				Url baseUrlObj(formattedQuery);
+	return success;
+}
 
-				string tmpUrl = baseUrlObj.getProtocol();
-				tmpUrl += "://";
-				tmpUrl += baseUrlObj.getHost();
-				if (url[0] != '/')
-				{
-					tmpUrl += "/";
-				}
-				tmpUrl += url;
-				url = tmpUrl;
-			}
+PluginParserInterface *PluginWebEngine::getPluginParser(const string &fileName)
+{
+	if (fileName.empty() == true)
+	{
+		return NULL;
+	}
 
-			if (processResult(url) == true)
-			{
-				m_resultsList.push_back(Result(url, name, extract, "", pseudoScore));
-			}
-			--pseudoScore;
-			foundResult = true;
-		}
+	// What type of plugin is it ?
+	// Look at the file extension
+	string::size_type pos = fileName.find_last_of(".");
+	if (pos == string::npos)
+	{
+		// No way to tell
+		return NULL;
+	}
 
-		// Next
-		endPos += m_properties.m_resultItemEnd.length();
-		resultItem = StringManip::extractField(resultList,
-			m_properties.m_resultItemStart, m_properties.m_resultItemEnd, endPos);
+	string extension(fileName.substr(pos + 1));
+	if (strncasecmp(extension.c_str(), "src", 3) == 0)
+	{
+		return new SherlockParser(fileName);
 	}
-	delete pUrlDoc;
+	else if (strncasecmp(extension.c_str(), "xml", 3) == 0)
+	{
+		return new OpenSearchParser(fileName);
+	}
 
-	return foundResult;
+	return NULL;
 }
 
 bool PluginWebEngine::getDetails(const string &fileName, string &name, string &channel)
@@ -285,36 +162,27 @@
 		return false;
 	}
 
-	// Get the definition file
-	FileCollector fileCollect;
-	DocumentInfo docInfo(name, string("file://") + fileName,
-		"text/plain", "");
-	Document *pPluginDoc = fileCollect.retrieveUrl(docInfo);
-	if (pPluginDoc == NULL)
+	PluginParserInterface *pParser = getPluginParser(fileName);
+	if (pParser == NULL)
 	{
-#ifdef DEBUG
-		cerr << "PluginWebEngine::getDetails: couldn't load " << fileName << endl;
-#endif
 		return false;
 	}
 
-	SherlockParser parser(pPluginDoc);
-	if (parser.parse(true) == false)
+	SearchPluginProperties properties;
+	if (pParser->parse(properties, true) == false)
 	{
 #ifdef DEBUG
 		cerr << "PluginWebEngine::getDetails: couldn't parse " << fileName << endl;
 #endif
-		delete pPluginDoc;
+		delete pParser;
 
 		return false;
 	}
+	delete pParser;
 
-	const SearchPluginProperties &properties = parser.getProperties();
 	name = properties.m_name;
 	channel = properties.m_channel;
 
-	delete pPluginDoc;
-
 	return true;
 }
 

Modified: trunk/Search/PluginWebEngine.h
===================================================================
--- trunk/Search/PluginWebEngine.h	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/PluginWebEngine.h	2006-01-25 11:46:04 UTC (rev 75)
@@ -19,6 +19,7 @@
 
 #include <string>
 
+#include "PluginParsers.h"
 #include "SearchPluginProperties.h"
 #include "WebEngine.h"
 
@@ -41,11 +42,14 @@
 
 	protected:
 		SearchPluginProperties m_properties;
+		ResponseParserInterface *m_pResponseParser;
 
-		bool load(const std::string &fileName);
+		void load(const std::string &fileName);
 
 		bool getPage(const std::string &formattedQuery);
 
+		static PluginParserInterface *getPluginParser(const std::string &fileName);
+
 	private:
 		PluginWebEngine(const PluginWebEngine &other);
 		PluginWebEngine &operator=(const PluginWebEngine &other);

Modified: trunk/Search/SearchEngineInterface.h
===================================================================
--- trunk/Search/SearchEngineInterface.h	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/SearchEngineInterface.h	2006-01-25 11:46:04 UTC (rev 75)
@@ -14,8 +14,8 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-#ifndef _SEARCHENGINE_INTERFACE_H
-#define _SEARCHENGINE_INTERFACE_H
+#ifndef _SEARCH_ENGINE_INTERFACE_H
+#define _SEARCH_ENGINE_INTERFACE_H
 
 #include <time.h>
 #include <string>
@@ -75,4 +75,4 @@
 
 };
 
-#endif // _SEARCHENGINE_INTERFACE_H
+#endif // _SEARCH_ENGINE_INTERFACE_H

Modified: trunk/Search/SearchPluginProperties.cpp
===================================================================
--- trunk/Search/SearchPluginProperties.cpp	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/SearchPluginProperties.cpp	2006-01-25 11:46:04 UTC (rev 75)
@@ -24,8 +24,7 @@
 	m_method(GET_METHOD),
 	m_nextFactor(10),
 	m_nextBase(0),
-	m_response(UNKNOWN_RESPONSE),
-	m_skipLocal(true)
+	m_response(UNKNOWN_RESPONSE)
 {
 }
 
@@ -41,17 +40,7 @@
 	m_nextTag(other.m_nextTag),
 	m_nextFactor(other.m_nextFactor),
 	m_nextBase(other.m_nextBase),
-	m_resultListStart(other.m_resultListStart),
-	m_resultListEnd(other.m_resultListEnd),
-	m_resultItemStart(other.m_resultItemStart),
-	m_resultItemEnd(other.m_resultItemEnd),
-	m_resultTitleStart(other.m_resultTitleStart),
-	m_resultTitleEnd(other.m_resultTitleEnd),
-	m_resultLinkStart(other.m_resultLinkStart),
-	m_resultLinkEnd(other.m_resultLinkEnd),
-	m_resultExtractStart(other.m_resultExtractStart),
-	m_resultExtractEnd(other.m_resultExtractEnd),
-	m_skipLocal(other.m_skipLocal)
+	m_response(other.m_response)
 {
 	copy(other.m_languages.begin(), other.m_languages.end(),
 		inserter(m_languages, m_languages.begin()));
@@ -80,17 +69,7 @@
 	m_nextTag = other.m_nextTag;
 	m_nextFactor = other.m_nextFactor;
 	m_nextBase = other.m_nextBase;
-	m_resultListStart = other.m_resultListStart;
-	m_resultListEnd = other.m_resultListEnd;
-	m_resultItemStart = other.m_resultItemStart;
-	m_resultItemEnd = other.m_resultItemEnd;
-	m_resultTitleStart = other.m_resultTitleStart;
-	m_resultTitleEnd = other.m_resultTitleEnd;
-	m_resultLinkStart = other.m_resultLinkStart;
-	m_resultLinkEnd = other.m_resultLinkEnd;
-	m_resultExtractStart = other.m_resultExtractStart;
-	m_resultExtractEnd = other.m_resultExtractEnd;
-	m_skipLocal = other.m_skipLocal;
+	m_response = other.m_response;
 
 	copy(other.m_languages.begin(), other.m_languages.end(),
 		inserter(m_languages, m_languages.begin()));

Modified: trunk/Search/SearchPluginProperties.h
===================================================================
--- trunk/Search/SearchPluginProperties.h	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/SearchPluginProperties.h	2006-01-25 11:46:04 UTC (rev 75)
@@ -61,17 +61,6 @@
 		unsigned int m_nextBase;
 		// Response
 		Response m_response;
-		std::string m_resultListStart;
-		std::string m_resultListEnd;
-		std::string m_resultItemStart;
-		std::string m_resultItemEnd;
-		std::string m_resultTitleStart;
-		std::string m_resultTitleEnd;
-		std::string m_resultLinkStart;
-		std::string m_resultLinkEnd;
-		std::string m_resultExtractStart;
-		std::string m_resultExtractEnd;
-		bool m_skipLocal;
 
 };
 

Modified: trunk/Search/SherlockParser.cpp
===================================================================
--- trunk/Search/SherlockParser.cpp	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/SherlockParser.cpp	2006-01-25 11:46:04 UTC (rev 75)
@@ -22,6 +22,9 @@
 #include <boost/spirit/utility/confix.hpp>
 
 #include "StringManip.h"
+#include "Url.h"
+#include "HtmlTokenizer.h"
+#include "FileCollector.h"
 #include "SherlockParser.h"
 
 using std::cout;
@@ -249,28 +252,242 @@
 
 };
 
-SherlockParser::SherlockParser(const Document *pDocument) :
-	m_pDocument(pDocument)
+SherlockResponseParser::SherlockResponseParser() :
+	ResponseParserInterface(),
+	m_skipLocal(true)
 {
 }
 
-SherlockParser::~SherlockParser()
+SherlockResponseParser::~SherlockResponseParser()
 {
 }
 
-bool SherlockParser::parse(bool extractSearchParams)
+bool SherlockResponseParser::parse(const Document *pResponseDoc, vector<Result> &resultsList,
+	unsigned int maxResultsCount) const
 {
-	if (m_pDocument == NULL)
+	float pseudoScore = 100;
+	unsigned int contentLen;
+	bool foundResult = false;
+
+	if ((pResponseDoc == NULL) ||
+		(pResponseDoc->getData(contentLen) == NULL) ||
+		(contentLen == 0))
 	{
 		return false;
 	}
 
+	// These two are the minimum we need
+	if ((m_resultItemStart.empty() == true) ||
+		(m_resultItemEnd.empty() == true))
+	{
+#ifdef DEBUG
+		cout << "SherlockResponseParser::parse: incomplete properties" << endl;
+#endif
+		return false;
+	}
+
+	// Extract the results list
+#ifdef DEBUG
+	cout << "SherlockResponseParser::parse: getting results list ("
+		<< m_resultListStart << ", " << m_resultListEnd << ")" << endl;
+#endif
+	const char *pContent = pResponseDoc->getData(contentLen);
+	string resultList = StringManip::extractField(pContent, m_resultListStart, m_resultListEnd);
+	if (resultList.empty() == true)
+	{
+		resultList = string(pContent, contentLen);
+	}
+
+	// Extract results
+	string::size_type endPos = 0;
+#ifdef DEBUG
+	cout << "SherlockResponseParser::parse: getting first result ("
+		<< m_resultItemStart << ", " << m_resultItemEnd << ")" << endl;
+#endif
+	string resultItem = StringManip::extractField(resultList,
+		m_resultItemStart, m_resultItemEnd, endPos);
+	while ((resultItem.empty() == false) &&
+		(resultsList.size() <= maxResultsCount))
+	{
+		string contentType, url, name, extract;
+
+#ifdef DEBUG
+		cout << "SherlockResponseParser::parse: candidate chunk \""
+			<< resultItem << "\"" << endl;
+#endif
+		contentType = pResponseDoc->getType();
+		if (strncasecmp(contentType.c_str(), "text/html", 9) == 0)
+		{
+			Document chunkDoc("", "", contentType, "");
+			chunkDoc.setData(resultItem.c_str(), resultItem.length());
+			HtmlTokenizer chunkTokens(&chunkDoc);
+			set<Link> &chunkLinks = chunkTokens.getLinks();
+			unsigned int endOfFirstLink = 0, startOfSecondLink = 0, endOfSecondLink = 0, startOfThirdLink = 0;
+
+			// The result's URL and title should be given by the first link
+			for (set<Link>::iterator linkIter = chunkLinks.begin(); linkIter != chunkLinks.end(); ++linkIter)
+			{
+				if (linkIter->m_pos == 0)
+				{
+					url = linkIter->m_url;
+					name = linkIter->m_name;
+#ifdef DEBUG
+					cout << "SherlockResponseParser::parse: first link in chunk is "
+						<< url << endl;
+#endif
+					endOfFirstLink = linkIter->m_close;
+				}
+				else if (linkIter->m_pos == 1)
+				{
+					startOfSecondLink = linkIter->m_open;
+					endOfSecondLink = linkIter->m_close;
+				}
+				else if (linkIter->m_pos == 2)
+				{
+					startOfThirdLink = linkIter->m_open;
+				}
+			}
+
+			// Chances are the extract is between the first two links
+			if (endOfFirstLink > 0)
+			{
+				string extractWithMarkup1, extractWithMarkup2;
+				string extractCandidate1, extractCandidate2;
+
+				if (startOfSecondLink > 0)
+				{
+					extractWithMarkup1 = resultItem.substr(endOfFirstLink, startOfSecondLink - endOfFirstLink);
+				}
+				else
+				{
+					extractWithMarkup1 = resultItem.substr(endOfFirstLink);
+				}
+				extractCandidate1 = HtmlTokenizer::stripTags(extractWithMarkup1);
+
+				// ... or between the second and third link :-)
+				if (endOfSecondLink > 0)
+				{
+					if (startOfThirdLink > 0)
+					{
+						extractWithMarkup2 = resultItem.substr(endOfSecondLink, startOfThirdLink - endOfSecondLink);
+					}
+					else
+					{
+						extractWithMarkup2 = resultItem.substr(endOfSecondLink);
+					}
+				}
+				extractCandidate2 = HtmlTokenizer::stripTags(extractWithMarkup2);
+
+				// It seems we can rely on length to determine which is the right one
+				if (extractCandidate1.length() > extractCandidate2.length())
+				{
+					extract = extractCandidate1;
+				}
+				else
+				{
+					extract = extractCandidate2;
+				}
+#ifdef DEBUG
+				cout << "SherlockResponseParser::parse: extract is \""
+					<< extract << "\"" << endl;
+#endif
+			}
+		}
+		else
+		{
+			// This is not HTML
+			// Use extended attributes
+			if ((m_resultTitleStart.empty() == false) &&
+				(m_resultTitleEnd.empty() == false))
+			{
+				name = StringManip::extractField(resultItem,
+					m_resultTitleStart, m_resultTitleEnd);
+			}
+
+			if ((m_resultLinkStart.empty() == false) &&
+				(m_resultLinkEnd.empty() == false))
+			{
+				url = StringManip::extractField(resultItem,
+					m_resultLinkStart, m_resultLinkEnd);
+			}
+
+			if ((m_resultExtractStart.empty() == false) &&
+				(m_resultExtractEnd.empty() == false))
+			{
+				extract = StringManip::extractField(resultItem,
+					m_resultExtractStart, m_resultExtractEnd);
+			}
+		}
+
+		if (url.empty() == false)
+		{
+			Url urlObj(url);
+
+			// Is this URL relative to the search engine's domain ?
+			// FIXME: look for a interpret/baseurl tag, see https://bugzilla.mozilla.org/show_bug.cgi?id=65453
+			// FIXME: obey m_skipLocal
+			if (urlObj.getHost().empty() == true)
+			{
+				Url baseUrlObj(pResponseDoc->getLocation());
+
+				string tmpUrl = baseUrlObj.getProtocol();
+				tmpUrl += "://";
+				tmpUrl += baseUrlObj.getHost();
+				if (url[0] != '/')
+				{
+					tmpUrl += "/";
+				}
+				tmpUrl += url;
+				url = tmpUrl;
+			}
+
+			resultsList.push_back(Result(url, name, extract, "", pseudoScore));
+			--pseudoScore;
+			foundResult = true;
+		}
+
+		// Next
+		endPos += m_resultItemEnd.length();
+		resultItem = StringManip::extractField(resultList,
+			m_resultItemStart, m_resultItemEnd, endPos);
+	}
+
+	return foundResult;
+}
+
+SherlockParser::SherlockParser(const string &fileName) :
+	PluginParserInterface(fileName)
+{
+}
+
+SherlockParser::~SherlockParser()
+{
+}
+
+ResponseParserInterface *SherlockParser::parse(SearchPluginProperties &properties,
+	bool extractSearchParams)
+{
+	FileCollector fileCollect;
+	DocumentInfo docInfo("Sherlock Source", string("file://") + m_fileName,
+		"text/plain", "");
+
+	// Get the definition file
+	Document *pPluginDoc = fileCollect.retrieveUrl(docInfo);
+	if (pPluginDoc == NULL)
+	{
+#ifdef DEBUG
+		cout << "SherlockParser::parse: couldn't load " << m_fileName << endl;
+#endif
+		return NULL;
+	}
+
 	unsigned int dataLength;
-	const char *pData = m_pDocument->getData(dataLength);
+	const char *pData = pPluginDoc->getData(dataLength);
 	if ((pData == NULL) ||
 		(dataLength == 0))
 	{
-		return false;
+		delete pPluginDoc;
+		return NULL;
 	}
 
 	map<string, string> searchParams, interpretParams, inputItems;
@@ -292,6 +509,11 @@
 		parseInfo = boost::spirit::parse(pData, plugin, skip);
 	}
 
+	// We are done with the document
+	delete pPluginDoc;
+
+	SherlockResponseParser *pResponseParser = new SherlockResponseParser();
+
 	if (parseInfo.full == true)
 	{
 		map<string, string> lowSearchParams, lowInterpretParams, lowInputItems;
@@ -304,22 +526,22 @@
 		for_each(inputItems.begin(), inputItems.end(), lowCopy3);
 
 		// Response
-		m_properties.m_response = SearchPluginProperties::HTML_RESPONSE;
+		properties.m_response = SearchPluginProperties::HTML_RESPONSE;
 		// Method
-		m_properties.m_method = SearchPluginProperties::GET_METHOD;
+		properties.m_method = SearchPluginProperties::GET_METHOD;
 
 		// Name
 		map<string, string>::iterator mapIter = lowSearchParams.find("name");
 		if (mapIter != lowSearchParams.end())
 		{
-			m_properties.m_name = mapIter->second;
+			properties.m_name = mapIter->second;
 		}
 
 		// Channel
 		mapIter = lowSearchParams.find("routetype");
 		if (mapIter != lowSearchParams.end())
 		{
-			m_properties.m_channel = mapIter->second;
+			properties.m_channel = mapIter->second;
 		}
 
 		if (extractSearchParams == false)
@@ -333,87 +555,87 @@
 					lowInputItems.erase(mapIter);
 				}
 
-				m_properties.m_parameters[SearchPluginProperties::SEARCH_TERMS_PARAM] = userInput;
+				properties.m_parameters[SearchPluginProperties::SEARCH_TERMS_PARAM] = userInput;
 			}
 			for (map<string, string>::iterator iter = lowInputItems.begin();
 				iter != lowInputItems.end(); ++iter)
 			{
 				// Append to the remainder
-				if (m_properties.m_parametersRemainder.empty() == false)
+				if (properties.m_parametersRemainder.empty() == false)
 				{
-					m_properties.m_parametersRemainder += "&";
+					properties.m_parametersRemainder += "&";
 				}
-				m_properties.m_parametersRemainder += iter->first;
-				m_properties.m_parametersRemainder += "=";
-				m_properties.m_parametersRemainder += iter->second;
+				properties.m_parametersRemainder += iter->first;
+				properties.m_parametersRemainder += "=";
+				properties.m_parametersRemainder += iter->second;
 			}
 
 			// URL
 			mapIter = lowSearchParams.find("action");
 			if (mapIter != lowSearchParams.end())
 			{
-				m_properties.m_baseUrl = mapIter->second;
+				properties.m_baseUrl = mapIter->second;
 			}
 
 			// Response
 			mapIter = lowInterpretParams.find("resultliststart");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultListStart = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
+				pResponseParser->m_resultListStart = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
 			}
 
 			mapIter = lowInterpretParams.find("resultlistend");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultListEnd = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
+				pResponseParser->m_resultListEnd = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
 			}
 
 			mapIter = lowInterpretParams.find("resultitemstart");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultItemStart = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
+				pResponseParser->m_resultItemStart = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
 			}
 
 			mapIter = lowInterpretParams.find("resultitemend");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultItemEnd = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
+				pResponseParser->m_resultItemEnd = StringManip::replaceSubString(mapIter->second, "\\n", "\n");
 			}
 
 			mapIter = lowInterpretParams.find("resulttitlestart");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultTitleStart = mapIter->second;
+				pResponseParser->m_resultTitleStart = mapIter->second;
 			}
 
 			mapIter = lowInterpretParams.find("resulttitleend");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultTitleEnd = mapIter->second;
+				pResponseParser->m_resultTitleEnd = mapIter->second;
 			}
 
 			mapIter = lowInterpretParams.find("resultlinkstart");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultLinkStart = mapIter->second;
+				pResponseParser->m_resultLinkStart = mapIter->second;
 			}
 
 			mapIter = lowInterpretParams.find("resultlinkend");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultLinkEnd = mapIter->second;
+				pResponseParser->m_resultLinkEnd = mapIter->second;
 			}
 
 			mapIter = lowInterpretParams.find("resultextractstart");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultExtractStart = mapIter->second;
+				pResponseParser->m_resultExtractStart = mapIter->second;
 			}
 
 			mapIter = lowInterpretParams.find("resultextractend");
 			if (mapIter != lowInterpretParams.end())
 			{
-				m_properties.m_resultExtractEnd = mapIter->second;
+				pResponseParser->m_resultExtractEnd = mapIter->second;
 			}
 
 			mapIter = lowInterpretParams.find("skiplocal");
@@ -421,21 +643,21 @@
 			{
 				if (mapIter->second == "false")
 				{
-					m_properties.m_skipLocal = false;
+					pResponseParser->m_skipLocal = false;
 				}
 			}
 
-			m_properties.m_nextTag = nextInput;
+			properties.m_nextTag = nextInput;
 			// Here we differ from how Mozilla uses these parameters
 			// Normally, either factor or value is used, but we use value
 			// as the parameter's initial value
 			if (nextFactor.empty() == false)
 			{
-				m_properties.m_nextFactor = (unsigned int)atoi(nextFactor.c_str());
+				properties.m_nextFactor = (unsigned int)atoi(nextFactor.c_str());
 			}
 			if (nextValue.empty() == false)
 			{
-				m_properties.m_nextBase = (unsigned int)atoi(nextValue.c_str());
+				properties.m_nextBase = (unsigned int)atoi(nextValue.c_str());
 			}
 		}
 	}
@@ -443,11 +665,5 @@
 	else cout << "SherlockParser::parse: syntax error near " << parseInfo.stop << endl;
 #endif
 
-	return parseInfo.hit;
+	return pResponseParser;
 }
-
-/// Returns the plugin's properties.
-const SearchPluginProperties &SherlockParser::getProperties(void)
-{
-	return m_properties;
-}

Modified: trunk/Search/SherlockParser.h
===================================================================
--- trunk/Search/SherlockParser.h	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/SherlockParser.h	2006-01-25 11:46:04 UTC (rev 75)
@@ -18,32 +18,53 @@
 #define _SHERLOCK_PARSER_H
 
 #include <string>
-#include <map>
 
 #include "Document.h"
-#include "SearchPluginProperties.h"
+#include "PluginParsers.h"
 
+class SherlockResponseParser : public ResponseParserInterface
+{
+	public:
+		SherlockResponseParser();
+		virtual ~SherlockResponseParser();
+
+		/// Parses the response; false if not all could be parsed.
+		virtual bool parse(const Document *pResponseDoc, std::vector<Result> &resultsList,
+			unsigned int maxResultsCount) const;
+
+		std::string m_resultListStart;
+		std::string m_resultListEnd;
+		std::string m_resultItemStart;
+		std::string m_resultItemEnd;
+		std::string m_resultTitleStart;
+		std::string m_resultTitleEnd;
+		std::string m_resultLinkStart;
+		std::string m_resultLinkEnd;
+		std::string m_resultExtractStart;
+		std::string m_resultExtractEnd;
+		bool m_skipLocal;
+
+	private:
+		SherlockResponseParser(const SherlockResponseParser &other);
+		SherlockResponseParser& operator=(const SherlockResponseParser& other);
+
+};
+
 /**
   * A parser for Sherlock plugin files.
   * See http://developer.apple.com/technotes/tn/tn1141.html
   * and http://mycroft.mozdev.org/deepdocs/deepdocs.html
   */
-class SherlockParser
+class SherlockParser : public PluginParserInterface
 {
 	public:
-		SherlockParser(const Document *pDocument);
+		SherlockParser(const std::string &fileName);
 		virtual ~SherlockParser();
 
-		/// Parses the plugin; false if not all could be parsed.
-		bool parse(bool extractSearchParams = false);
+		/// Parses the plugin and returns a response parser.
+		virtual ResponseParserInterface *parse(SearchPluginProperties &properties,
+			bool extractSearchParams = false);
 
-		/// Returns the plugin's properties.
-		virtual const SearchPluginProperties &getProperties(void);
-
-	protected:
-		const Document *m_pDocument;
-		SearchPluginProperties m_properties;
-
 	private:
 		SherlockParser(const SherlockParser &other);
 		SherlockParser& operator=(const SherlockParser& other);

Modified: trunk/Search/plugintest.cpp
===================================================================
--- trunk/Search/plugintest.cpp	2006-01-22 13:37:53 UTC (rev 74)
+++ trunk/Search/plugintest.cpp	2006-01-25 11:46:04 UTC (rev 75)
@@ -31,7 +31,7 @@
 {
 	if (argc < 3)
 	{
-		cerr << "Usage: " << argv[0] << " SHERLOCK|OPENSEARCH <file name> [MIN]" << endl;
+		cerr << "Usage: " << argv[0] << " sherlock|opensearch <file name> [MIN]" << endl;
 		return EXIT_FAILURE;
 	}
 
@@ -39,6 +39,7 @@
 	if ((stat(argv[2], &fileStat) == 0) &&
 		(S_ISREG(fileStat.st_mode)))
 	{
+		PluginParserInterface *pParser = NULL;
 		SearchPluginProperties properties;
 		bool minParser = false;
 
@@ -48,43 +49,22 @@
 			minParser = true;
 		}
 
-		if (strncasecmp(argv[1], "SHERLOCK", 8) == 0)
+		if (strncasecmp(argv[1], "sherlock", 8) == 0)
 		{
-			char *buffer = new char[fileStat.st_size + 1];
-			int fd = open(argv[2], O_RDONLY);
-
-			// Read the file
-			ssize_t readBytes = read(fd, buffer, fileStat.st_size);
-			if (readBytes == -1)
-			{
-				cerr << "Couldn't read " << argv[2] << " !" << endl;
-				return EXIT_FAILURE;
-			}
-
-			// Put that data into a document
-			Document doc;
-			doc.setData(buffer, readBytes);
-			delete[] buffer;
-
-			SherlockParser parser(&doc);
-			if (parser.parse(minParser) == true)
-			{
-				cout << "Successfully parsed " << argv[2] << endl;
-			}
-
-			properties = parser.getProperties();
+			pParser = new SherlockParser(argv[2]);
 		}
-		else if (strncasecmp(argv[1], "OPENSEARCH", 10) == 0)
+		else if (strncasecmp(argv[1], "opensearch", 10) == 0)
 		{
-			OpenSearchParser parser(argv[2]);
+			pParser = new OpenSearchParser(argv[2]);
+		}
 
-			if (parser.parse(minParser) == true)
-			{
-				cout << "Successfully parsed " << argv[2] << endl;
-			}
-
-			properties = parser.getProperties();
+		// Parse the document
+		if (pParser->parse(minParser) == true)
+		{
+			cout << "Successfully parsed " << argv[2] << endl;
 		}
+		properties = pParser->getProperties();
+		delete pParser;
 
 		cout << "Plugin " << properties.m_name << ": " << properties.m_description << endl;
 		cout << "Channel: " << properties.m_channel << endl;



From fabricecolin at berlios.de  Wed Jan 25 14:51:29 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 25 Jan 2006 14:51:29 +0100
Subject: [Pinot-svn] r76 - trunk/Search
Message-ID: <200601251351.k0PDpTXW005565@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-25 14:51:16 +0100 (Wed, 25 Jan 2006)
New Revision: 76

Modified:
   trunk/Search/OpenSearchParser.cpp
   trunk/Search/OpenSearchParser.h
   trunk/Search/SearchEngineFactory.cpp
   trunk/Search/SearchPluginProperties.h
   trunk/Search/SherlockParser.cpp
   trunk/Search/plugintest.cpp
Log:
Initial OpenSearch Response support.


Modified: trunk/Search/OpenSearchParser.cpp
===================================================================
--- trunk/Search/OpenSearchParser.cpp	2006-01-25 11:46:04 UTC (rev 75)
+++ trunk/Search/OpenSearchParser.cpp	2006-01-25 13:51:16 UTC (rev 76)
@@ -20,6 +20,7 @@
 #include <iostream>
 #include <glibmm/thread.h>
 #include <glibmm/convert.h>
+#include <libxml/parserInternals.h>
 #include <libxml++/parsers/domparser.h>
 #include <libxml++/nodes/node.h>
 #include <libxml++/nodes/textnode.h>
@@ -51,8 +52,9 @@
 	return pText->get_content();
 }
 
-OpenSearchResponseParser::OpenSearchResponseParser() :
-	ResponseParserInterface()
+OpenSearchResponseParser::OpenSearchResponseParser(bool rssResponse) :
+	ResponseParserInterface(),
+	m_rssResponse(rssResponse)
 {
 }
 
@@ -63,6 +65,163 @@
 bool OpenSearchResponseParser::parse(const ::Document *pResponseDoc, vector<Result> &resultsList,
 	unsigned int maxResultsCount) const
 {
+	float pseudoScore = 100;
+	unsigned int contentLen = 0;
+	bool success = true;
+
+	if ((pResponseDoc == NULL) ||
+		(pResponseDoc->getData(contentLen) == NULL) ||
+		(contentLen == 0))
+	{
+		return false;
+	}
+
+	const char *pContent = pResponseDoc->getData(contentLen);
+	try
+	{
+		bool loadFeed = false;
+
+		// Parse the configuration file
+		DomParser parser;
+		parser.set_substitute_entities(true);
+		parser.parse_memory_raw((const unsigned char *)pContent, (Parser::size_type)contentLen);
+		xmlpp::Document *pDocument = parser.get_document();
+		if (pDocument == NULL)
+		{
+			return false;
+		}
+
+		Node *pNode = pDocument->get_root_node();
+		Element *pRootElem = dynamic_cast<Element *>(pNode);
+		if (pRootElem == NULL)
+		{
+			return false;
+		}
+		// Check the top-level element is what we expect
+		ustring rootNodeName = pRootElem->get_name();
+		if (m_rssResponse == true)
+		{
+			if (rootNodeName == "rss")
+			{
+				const Node::NodeList rssChildNodes = pRootElem->get_children();
+				for (Node::NodeList::const_iterator rssIter = rssChildNodes.begin();
+					rssIter != rssChildNodes.end(); ++rssIter)
+				{
+					Node *pRssNode = (*rssIter);
+					Element *pRssElem = dynamic_cast<Element*>(pRssNode);
+					if (pRssElem != NULL)
+					{
+						if (pRssElem->get_name() == "channel")
+						{
+							pRootElem = pRssElem;
+							loadFeed = true;
+							break;
+						}
+					}
+				}
+			}
+		}
+		else
+		{
+			if (rootNodeName != "feed")
+			{
+				return false;
+			}
+			loadFeed = true;
+		}
+
+		if (loadFeed == false)
+		{
+#ifdef DEBUG
+			cout << "OpenSearchResponseParser::parse: error on root node "
+				<< rootNodeName << endl;
+#endif
+			return false;
+		}
+
+		// RSS
+		ustring itemNode("item");
+		ustring descriptionNode("description");
+		if (m_rssResponse == false)
+		{
+			// Atom
+			itemNode = "entry";
+			descriptionNode = "content";
+		}
+
+		// Go through the subnodes
+		const Node::NodeList childNodes = pRootElem->get_children();
+		for (Node::NodeList::const_iterator iter = childNodes.begin();
+			iter != childNodes.end(); ++iter)
+		{
+			Node *pNode = (*iter);
+			// All nodes should be elements
+			Element *pElem = dynamic_cast<Element*>(pNode);
+			if (pElem == NULL)
+			{
+				continue;
+			}
+
+			ustring nodeName = pElem->get_name();
+			if (nodeName != itemNode)
+			{
+				continue;
+			}
+
+			// Go through the item's subnodes
+			ustring title, url, extract;
+			const Node::NodeList itemChildNodes = pElem->get_children();
+			for (Node::NodeList::const_iterator itemIter = itemChildNodes.begin();
+				itemIter != itemChildNodes.end(); ++itemIter)
+			{
+				Node *pItemNode = (*itemIter);
+				// All nodes should be elements
+				Element *pItemElem = dynamic_cast<Element*>(pItemNode);
+				if (pItemElem == NULL)
+				{
+					continue;
+				}
+
+				ustring itemNodeName = pItemElem->get_name();
+				if (itemNodeName == "title")
+				{
+					title = getElementContent(pItemElem);
+				}
+				else if (itemNodeName == "link")
+				{
+					if (m_rssResponse == true)
+					{
+						url = getElementContent(pItemElem);
+					}
+					else
+					{
+						Attribute *pAttr = pItemElem->get_attribute("href");
+						if (pAttr != NULL)
+						{
+							url = pAttr->get_value();
+						}
+					}
+				}
+				else if (itemNodeName == descriptionNode)
+				{
+					extract = getElementContent(pItemElem);
+				}
+			}
+
+			resultsList.push_back(Result(url, title, extract, "", pseudoScore));
+			--pseudoScore;
+			success = true;
+		}
+	}
+	catch (const std::exception& ex)
+	{
+#ifdef DEBUG
+		cout << "OpenSearchResponseParser::parse: caught exception: " << ex.what() << endl;
+#endif
+		success = false;
+	}
+
+	return success;
 }
 
 OpenSearchParser::OpenSearchParser(const string &fileName) :
@@ -78,7 +237,7 @@
 	bool extractSearchParams)
 {
 	struct stat fileStat;
-	bool success = true;
+	bool rssResponse = true, success = true;
 
 	if ((m_fileName.empty() == true) ||
 		(stat(m_fileName.c_str(), &fileStat) != 0) ||
@@ -142,7 +301,8 @@
 				else if (nodeName == "Url")
 				{
 					ustring url, type;
-					bool xmlResponse = false, getMethod = true;
+					SearchPluginProperties::Response response = SearchPluginProperties::RSS_RESPONSE;
+					bool getMethod = true;
 
 					// Parse Query Syntax
 					Element::AttributeList attributes = pElem->get_attributes();
@@ -175,34 +335,27 @@
 						}
 					}
 
+					// Did we get the URL ?
+					if (url.empty() == true)
+					{
+						// It's probably provided as content, v1.0 style
+						url = nodeContent;
+					}
+
 					if (getMethod == true)
 					{
 						string::size_type startPos = 0, pos = url.find("?");
 
-						// Determine if this Url is better than previous ones
-						if ((type == "application/rss+xml") ||
-							(type == "application/atom+xml"))
+						// Do we support that type ?
+						if (type == "application/atom+xml")
 						{
-							// We prefer OpenSearch Response
-							xmlResponse = true;
-#ifdef DEBUG
-							cout << "OpenSearchParser::parse: XML response type" << endl;
-#endif
+							response = SearchPluginProperties::ATOM_RESPONSE;
+							rssResponse = false;
 						}
-						else if (type == "text/html")
+						else if ((type.empty() == false) &&
+							(type != "application/rss+xml"))
 						{
-							// HTML is second best
 #ifdef DEBUG
-							cout << "OpenSearchParser::parse: HTML response type" << endl;
-#endif
-							if (xmlResponse == true)
-							{
-								continue;
-							}
-						}
-						else
-						{
-#ifdef DEBUG
 							cout << "OpenSearchParser::parse: unsupported response type "
 								<< type << endl;
 #endif
@@ -221,8 +374,8 @@
 #endif
 
 							// Split this into the actual parameters
-							params += "&amp;";
-							pos = params.find("&amp;");
+							params += "&";
+							pos = params.find("&");
 							while (pos != string::npos)
 							{
 								string parameter(params.substr(startPos, pos - startPos));
@@ -281,8 +434,8 @@
 								}
 
 								// Next
-								startPos = pos + 5;
-								pos = params.find_first_of("&\n", startPos);
+								startPos = pos + 1;
+								pos = params.find_first_of("&", startPos);
 							}
 						}
 
@@ -291,14 +444,7 @@
 						// Output type
 						properties.m_outputType = type;
 						// Response
-						if (xmlResponse == true)
-						{
-							properties.m_response = SearchPluginProperties::XML_RESPONSE;
-						}
-						else
-						{
-							properties.m_response = SearchPluginProperties::HTML_RESPONSE;
-						}
+						properties.m_response = response;
 					}
 
 					// We ignore Param as we only support GET
@@ -341,5 +487,5 @@
 		return NULL;
 	}
 
-	return new OpenSearchResponseParser();
+	return new OpenSearchResponseParser(rssResponse);
 }

Modified: trunk/Search/OpenSearchParser.h
===================================================================
--- trunk/Search/OpenSearchParser.h	2006-01-25 11:46:04 UTC (rev 75)
+++ trunk/Search/OpenSearchParser.h	2006-01-25 13:51:16 UTC (rev 76)
@@ -25,13 +25,16 @@
 class OpenSearchResponseParser : public ResponseParserInterface
 {
 	public:
-		OpenSearchResponseParser();
+		OpenSearchResponseParser(bool rssResponse);
 		virtual ~OpenSearchResponseParser();
 
 		/// Parses the response; false if not all could be parsed.
 		virtual bool parse(const Document *pResponseDoc, std::vector<Result> &resultsList,
 			unsigned int maxResultsCount) const;
 
+	protected:
+		bool m_rssResponse;
+
 	private:
 		OpenSearchResponseParser(const OpenSearchResponseParser &other);
 		OpenSearchResponseParser& operator=(const OpenSearchResponseParser& other);

Modified: trunk/Search/SearchEngineFactory.cpp
===================================================================
--- trunk/Search/SearchEngineFactory.cpp	2006-01-25 11:46:04 UTC (rev 75)
+++ trunk/Search/SearchEngineFactory.cpp	2006-01-25 13:51:16 UTC (rev 76)
@@ -38,7 +38,8 @@
 	SearchEngineInterface *myEngine = NULL;
 
 	// Choice by type
-	if (type == "sherlock")
+	if ((type == "sherlock") ||
+		(type == "opensearch"))
 	{
 		myEngine = new PluginWebEngine(option);
 	}

Modified: trunk/Search/SearchPluginProperties.h
===================================================================
--- trunk/Search/SearchPluginProperties.h	2006-01-25 11:46:04 UTC (rev 75)
+++ trunk/Search/SearchPluginProperties.h	2006-01-25 13:51:16 UTC (rev 76)
@@ -38,8 +38,8 @@
 			 COUNT_PARAM,START_INDEX_PARAM, START_PAGE_PARAM, LANGUAGE_PARAM,
 			OUTPUT_ENCODING_PARAM, INPUT_ENCODING_PARAM } Parameter;
 
-		typedef enum { UNKNOWN_RESPONSE = 0, XML_RESPONSE,
-			HTML_RESPONSE } Response;
+		typedef enum { UNKNOWN_RESPONSE = 0, HTML_RESPONSE,
+			RSS_RESPONSE, ATOM_RESPONSE } Response;
 
 		// Description
 		std::string m_name;

Modified: trunk/Search/SherlockParser.cpp
===================================================================
--- trunk/Search/SherlockParser.cpp	2006-01-25 11:46:04 UTC (rev 75)
+++ trunk/Search/SherlockParser.cpp	2006-01-25 13:51:16 UTC (rev 76)
@@ -266,7 +266,7 @@
 	unsigned int maxResultsCount) const
 {
 	float pseudoScore = 100;
-	unsigned int contentLen;
+	unsigned int contentLen = 0;
 	bool foundResult = false;
 
 	if ((pResponseDoc == NULL) ||

Modified: trunk/Search/plugintest.cpp
===================================================================
--- trunk/Search/plugintest.cpp	2006-01-25 11:46:04 UTC (rev 75)
+++ trunk/Search/plugintest.cpp	2006-01-25 13:51:16 UTC (rev 76)
@@ -59,23 +59,27 @@
 		}
 
 		// Parse the document
-		if (pParser->parse(minParser) == true)
+		ResponseParserInterface *pResponseParser = pParser->parse(properties, minParser);
+		if (pResponseParser != NULL)
 		{
-			cout << "Successfully parsed " << argv[2] << endl;
+			delete pResponseParser;
+
+			cout << "Plugin " << properties.m_name << ": " << properties.m_description << endl;
+			cout << "Channel: " << properties.m_channel << endl;
+			cout << "URL: " << properties.m_baseUrl << endl;
+			cout << "Input parameters are:" << endl;
+			for (map<SearchPluginProperties::Parameter, string>::iterator iter = properties.m_parameters.begin();
+				iter != properties.m_parameters.end(); ++iter)
+			{
+				cout << iter->second << "=" << iter->first << endl;
+			}
+			cout << "Remainder: " << properties.m_parametersRemainder << endl;
 		}
-		properties = pParser->getProperties();
-		delete pParser;
-
-		cout << "Plugin " << properties.m_name << ": " << properties.m_description << endl;
-		cout << "Channel: " << properties.m_channel << endl;
-		cout << "URL: " << properties.m_baseUrl << endl;
-		cout << "Input parameters are:" << endl;
-		for (map<SearchPluginProperties::Parameter, string>::iterator iter = properties.m_parameters.begin();
-			iter != properties.m_parameters.end(); ++iter)
+		else
 		{
-			cout << iter->second << "=" << iter->first << endl;
+			cout << "Failed to parse " << argv[2] << endl;
 		}
-		cout << "Remainder: " << properties.m_parametersRemainder << endl;
+		delete pParser;
 	}
 	else
 	{



From fabricecolin at berlios.de  Wed Jan 25 15:28:12 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 25 Jan 2006 15:28:12 +0100
Subject: [Pinot-svn] r77 - trunk/Search
Message-ID: <200601251428.k0PESCDa009474@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-25 15:28:12 +0100 (Wed, 25 Jan 2006)
New Revision: 77

Modified:
   trunk/Search/OpenSearchParser.cpp
   trunk/Search/SherlockParser.cpp
Log:
Slightly better Response parsing.


Modified: trunk/Search/OpenSearchParser.cpp
===================================================================
--- trunk/Search/OpenSearchParser.cpp	2006-01-25 13:51:16 UTC (rev 76)
+++ trunk/Search/OpenSearchParser.cpp	2006-01-25 14:28:12 UTC (rev 77)
@@ -24,6 +24,7 @@
 #include <libxml++/parsers/domparser.h>
 #include <libxml++/nodes/node.h>
 #include <libxml++/nodes/textnode.h>
+#include <libxml++/nodes/cdatanode.h>
 
 #include "StringManip.h"
 #include "OpenSearchParser.h"
@@ -32,24 +33,38 @@
 using namespace Glib;
 using namespace xmlpp;
 
-static ustring getElementContent(const Element *pElem)
+static ustring getNodeContent(const Node *pNode)
 {
-	if (pElem == NULL)
+	if (pNode == NULL)
 	{
 		return "";
 	}
 
+	// Is it an element ?
+	const Element *pElem = dynamic_cast<const Element*>(pNode);
+	if (pElem != NULL)
+	{
 #ifdef HAS_LIBXMLPP026
-	const TextNode *pText = pElem->get_child_content();
+		const TextNode *pText = pElem->get_child_content();
 #else
-	const TextNode *pText = pElem->get_child_text();
+		const TextNode *pText = pElem->get_child_text();
 #endif
-	if (pText == NULL)
+		if (pText == NULL)
+		{
+			return "";
+		}
+
+		return pText->get_content();
+	}
+
+	// Is it CDATA ?
+	const CdataNode *pContent = dynamic_cast<const CdataNode*>(pNode);
+	if (pContent != NULL)
 	{
-		return "";
+		return pContent->get_content();
 	}
 
-	return pText->get_content();
+	return "";
 }
 
 OpenSearchResponseParser::OpenSearchResponseParser(bool rssResponse) :
@@ -67,7 +82,7 @@
 {
 	float pseudoScore = 100;
 	unsigned int contentLen = 0;
-	bool success = true;
+	bool foundResult = true;
 
 	if ((pResponseDoc == NULL) ||
 		(pResponseDoc->getData(contentLen) == NULL) ||
@@ -155,14 +170,8 @@
 			iter != childNodes.end(); ++iter)
 		{
 			Node *pNode = (*iter);
-			// All nodes should be elements
-			Element *pElem = dynamic_cast<Element*>(pNode);
-			if (pElem == NULL)
-			{
-				continue;
-			}
 
-			ustring nodeName = pElem->get_name();
+			ustring nodeName = pNode->get_name();
 			if (nodeName != itemNode)
 			{
 				continue;
@@ -170,28 +179,36 @@
 
 			// Go through the item's subnodes
 			ustring title, url, extract;
-			const Node::NodeList itemChildNodes = pElem->get_children();
+			const Node::NodeList itemChildNodes = pNode->get_children();
 			for (Node::NodeList::const_iterator itemIter = itemChildNodes.begin();
 				itemIter != itemChildNodes.end(); ++itemIter)
 			{
 				Node *pItemNode = (*itemIter);
-				// All nodes should be elements
 				Element *pItemElem = dynamic_cast<Element*>(pItemNode);
 				if (pItemElem == NULL)
 				{
 					continue;
 				}
 
-				ustring itemNodeName = pItemElem->get_name();
+				ustring itemNodeName = pItemNode->get_name();
 				if (itemNodeName == "title")
 				{
-					title = getElementContent(pItemElem);
+					title = getNodeContent(pItemNode);
+					if (title.empty() == true)
+					{
+						// It may be given as CDATA
+						const Node::NodeList titleChildNodes = pItemNode->get_children();
+						if (titleChildNodes.size() == 1)
+						{
+							title = getNodeContent(*titleChildNodes.begin());
+						}
+					}
 				}
 				else if (itemNodeName == "link")
 				{
 					if (m_rssResponse == true)
 					{
-						url = getElementContent(pItemElem);
+						url = getNodeContent(pItemNode);
 					}
 					else
 					{
@@ -204,13 +221,18 @@
 				}
 				else if (itemNodeName == descriptionNode)
 				{
-					extract = getElementContent(pItemElem);
+					extract = getNodeContent(pItemNode);
 				}
 			}
 
 			resultsList.push_back(Result(url, title, extract, "", pseudoScore));
 			--pseudoScore;
-			success = true;
+			foundResult = true;
+			if (resultsList.size() == maxResultsCount)
+			{
+				// Enough results
+				break;
+			}
 		}
 	}
 	catch (const std::exception& ex)
@@ -218,10 +240,10 @@
 #ifdef DEBUG
 		cout << "OpenSearchResponseParser::parse: caught exception: " << ex.what() << endl;
 #endif
-		success = false;
+		foundResult = false;
 	}
 
-	return success;
+	return foundResult;
 }
 
 OpenSearchParser::OpenSearchParser(const string &fileName) :
@@ -281,15 +303,14 @@
 			for (Node::NodeList::const_iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 			{
 				Node *pNode = (*iter);
-				// All nodes should be elements
 				Element *pElem = dynamic_cast<Element*>(pNode);
 				if (pElem == NULL)
 				{
 					continue;
 				}
 
-				ustring nodeName = pElem->get_name();
-				ustring nodeContent = getElementContent(pElem);
+				ustring nodeName = pNode->get_name();
+				ustring nodeContent = getNodeContent(pNode);
 				if (nodeName == "ShortName")
 				{
 					properties.m_name = nodeContent;

Modified: trunk/Search/SherlockParser.cpp
===================================================================
--- trunk/Search/SherlockParser.cpp	2006-01-25 13:51:16 UTC (rev 76)
+++ trunk/Search/SherlockParser.cpp	2006-01-25 14:28:12 UTC (rev 77)
@@ -306,8 +306,7 @@
 #endif
 	string resultItem = StringManip::extractField(resultList,
 		m_resultItemStart, m_resultItemEnd, endPos);
-	while ((resultItem.empty() == false) &&
-		(resultsList.size() <= maxResultsCount))
+	while (resultItem.empty() == false)
 	{
 		string contentType, url, name, extract;
 
@@ -444,6 +443,11 @@
 			resultsList.push_back(Result(url, name, extract, "", pseudoScore));
 			--pseudoScore;
 			foundResult = true;
+			if (resultsList.size() == maxResultsCount)
+			{
+				// Enough results
+				break;
+			}
 		}
 
 		// Next



From fabricecolin at berlios.de  Wed Jan 25 15:39:04 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Wed, 25 Jan 2006 15:39:04 +0100
Subject: [Pinot-svn] r78 - trunk/Search
Message-ID: <200601251439.k0PEd4uA010782@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-25 15:39:03 +0100 (Wed, 25 Jan 2006)
New Revision: 78

Modified:
   trunk/Search/OpenSearchParser.cpp
Log:
Copes better with CDATA nodes.


Modified: trunk/Search/OpenSearchParser.cpp
===================================================================
--- trunk/Search/OpenSearchParser.cpp	2006-01-25 14:28:12 UTC (rev 77)
+++ trunk/Search/OpenSearchParser.cpp	2006-01-25 14:39:03 UTC (rev 78)
@@ -51,19 +51,24 @@
 #endif
 		if (pText == NULL)
 		{
+			// Maybe the text is given as CDATA
+			const Node::NodeList childNodes = pNode->get_children();
+			if (childNodes.size() == 1)
+			{
+				// Is it CDATA ?
+				const CdataNode *pContent = dynamic_cast<const CdataNode*>(*childNodes.begin());
+				if (pContent != NULL)
+				{
+					return pContent->get_content();
+				}
+			}
+
 			return "";
 		}
 
 		return pText->get_content();
 	}
 
-	// Is it CDATA ?
-	const CdataNode *pContent = dynamic_cast<const CdataNode*>(pNode);
-	if (pContent != NULL)
-	{
-		return pContent->get_content();
-	}
-
 	return "";
 }
 
@@ -194,15 +199,6 @@
 				if (itemNodeName == "title")
 				{
 					title = getNodeContent(pItemNode);
-					if (title.empty() == true)
-					{
-						// It may be given as CDATA
-						const Node::NodeList titleChildNodes = pItemNode->get_children();
-						if (titleChildNodes.size() == 1)
-						{
-							title = getNodeContent(*titleChildNodes.begin());
-						}
-					}
 				}
 				else if (itemNodeName == "link")
 				{



From fabricecolin at berlios.de  Thu Jan 26 16:12:06 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 26 Jan 2006 16:12:06 +0100
Subject: [Pinot-svn] r79 - in trunk: . Search
Message-ID: <200601261512.k0QFC6M4018636@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-26 16:12:05 +0100 (Thu, 26 Jan 2006)
New Revision: 79

Modified:
   trunk/Search/OpenSearchParser.cpp
   trunk/Search/OpenSearchParser.h
   trunk/Search/PluginParsers.h
   trunk/Search/PluginWebEngine.cpp
   trunk/Search/SearchPluginProperties.cpp
   trunk/Search/SearchPluginProperties.h
   trunk/Search/SherlockParser.cpp
   trunk/Search/SherlockParser.h
   trunk/Search/XapianEngine.cpp
   trunk/variables.mk
Log:
More than one results page can be requested with OpenSearch. XapianEngine
no longer loops ad vitam eternam if the index couldn't be locked !
Minor changes to variables.mk.


Modified: trunk/Search/OpenSearchParser.cpp
===================================================================
--- trunk/Search/OpenSearchParser.cpp	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/Search/OpenSearchParser.cpp	2006-01-26 15:12:05 UTC (rev 79)
@@ -83,11 +83,11 @@
 }
 
 bool OpenSearchResponseParser::parse(const ::Document *pResponseDoc, vector<Result> &resultsList,
-	unsigned int maxResultsCount) const
+	unsigned int &totalResults, unsigned int &firstResultIndex) const
 {
 	float pseudoScore = 100;
 	unsigned int contentLen = 0;
-	bool foundResult = true;
+	bool foundResult = false;
 
 	if ((pResponseDoc == NULL) ||
 		(pResponseDoc->getData(contentLen) == NULL) ||
@@ -96,6 +96,17 @@
 		return false;
 	}
 
+	// Make sure the response MIME type is sensible
+	string mimeType = pResponseDoc->getType();
+	if ((mimeType.empty() == false) &&
+		(mimeType.find("xml") == string::npos))
+	{
+#ifdef DEBUG
+		cout << "OpenSearchResponseParser::parse: response is not XML" << endl;
+#endif
+		return false;
+	}
+
 	const char *pContent = pResponseDoc->getData(contentLen);
 	try
 	{
@@ -177,6 +188,33 @@
 			Node *pNode = (*iter);
 
 			ustring nodeName = pNode->get_name();
+			ustring nodeContent = getNodeContent(pNode);
+
+			// Is this an OpenSearch extension ?
+			// FIXME: make sure namespace is opensearch
+			if (nodeName == "totalResults")
+			{
+				if (nodeContent.empty() == false)
+				{
+					totalResults = min((unsigned int)atoi(nodeContent.c_str()), totalResults);
+#ifdef DEBUG
+					cout << "OpenSearchResponseParser::parse: total results "
+						<< totalResults << endl;
+#endif
+				}
+			}
+			else if (nodeName == "startIndex")
+			{
+				if (nodeContent.empty() == false)
+				{
+					firstResultIndex = (unsigned int)atoi(nodeContent.c_str());
+#ifdef DEBUG
+					cout << "OpenSearchResponseParser::parse: first result index "
+						<< firstResultIndex << endl;
+#endif
+				}
+			}
+
 			if (nodeName != itemNode)
 			{
 				continue;
@@ -224,7 +262,7 @@
 			resultsList.push_back(Result(url, title, extract, "", pseudoScore));
 			--pseudoScore;
 			foundResult = true;
-			if (resultsList.size() == maxResultsCount)
+			if (resultsList.size() >= totalResults)
 			{
 				// Enough results
 				break;
@@ -372,6 +410,7 @@
 						else if ((type.empty() == false) &&
 							(type != "application/rss+xml"))
 						{
+							response = SearchPluginProperties::UNKNOWN_RESPONSE;
 #ifdef DEBUG
 							cout << "OpenSearchParser::parse: unsupported response type "
 								<< type << endl;
@@ -504,5 +543,17 @@
 		return NULL;
 	}
 
+	// Scrolling
+	properties.m_nextIncrement = 1;
+	properties.m_nextBase = 1;
+	if (properties.m_parameters.find(SearchPluginProperties::START_PAGE_PARAM) != properties.m_parameters.end())
+	{
+		properties.m_scrolling = SearchPluginProperties::PER_PAGE;
+	}
+	else
+	{
+		properties.m_scrolling = SearchPluginProperties::PER_INDEX;
+	}
+
 	return new OpenSearchResponseParser(rssResponse);
 }

Modified: trunk/Search/OpenSearchParser.h
===================================================================
--- trunk/Search/OpenSearchParser.h	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/Search/OpenSearchParser.h	2006-01-26 15:12:05 UTC (rev 79)
@@ -30,7 +30,7 @@
 
 		/// Parses the response; false if not all could be parsed.
 		virtual bool parse(const Document *pResponseDoc, std::vector<Result> &resultsList,
-			unsigned int maxResultsCount) const;
+			unsigned int &totalResults, unsigned int &firstResultIndex) const;
 
 	protected:
 		bool m_rssResponse;

Modified: trunk/Search/PluginParsers.h
===================================================================
--- trunk/Search/PluginParsers.h	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/Search/PluginParsers.h	2006-01-26 15:12:05 UTC (rev 79)
@@ -36,7 +36,7 @@
 
 		/// Parses the response; false if not all could be parsed.
 		virtual bool parse(const Document *pResponseDoc, std::vector<Result> &resultsList,
-			unsigned int maxResultsCount) const = 0;
+			unsigned int &totalResults, unsigned int &firstResultIndex) const = 0;
 
 	protected:
 		ResponseParserInterface()

Modified: trunk/Search/PluginWebEngine.cpp
===================================================================
--- trunk/Search/PluginWebEngine.cpp	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/Search/PluginWebEngine.cpp	2006-01-26 15:12:05 UTC (rev 79)
@@ -93,7 +93,8 @@
 	pageBackup.close();
 #endif
 
-	bool success = m_pResponseParser->parse(pResponseDoc, m_resultsList, m_maxResultsCount);
+	bool success = m_pResponseParser->parse(pResponseDoc, m_resultsList,
+		m_maxResultsCount, m_properties.m_nextBase);
 	vector<Result>::iterator resultIter = m_resultsList.begin();
 	while (resultIter != m_resultsList.end())
 	{
@@ -169,7 +170,8 @@
 	}
 
 	SearchPluginProperties properties;
-	if (pParser->parse(properties, true) == false)
+	ResponseParserInterface *pResponseParser = pParser->parse(properties, true);
+	if (pResponseParser == NULL)
 	{
 #ifdef DEBUG
 		cerr << "PluginWebEngine::getDetails: couldn't parse " << fileName << endl;
@@ -178,8 +180,18 @@
 
 		return false;
 	}
+	delete pResponseParser;
 	delete pParser;
 
+	if (properties.m_response == SearchPluginProperties::UNKNOWN_RESPONSE)
+	{
+#ifdef DEBUG
+		cerr << "PluginWebEngine::getDetails: bad response type for "
+			<< fileName << endl;
+#endif
+		return false;
+	}
+
 	name = properties.m_name;
 	channel = properties.m_channel;
 
@@ -194,7 +206,8 @@
 bool PluginWebEngine::runQuery(QueryProperties& queryProps)
 {
 	string queryString = queryProps.toString(false);
-	unsigned int currentFactor = 0, count = 0;
+	char countStr[64];
+	unsigned int currentIncrement = 0, count = 0;
 
 	m_resultsList.clear();
 
@@ -221,8 +234,11 @@
 	formattedQuery += userInputTag;
 	formattedQuery += "=";
 	formattedQuery += queryString;
-	formattedQuery += "&";
-	formattedQuery += m_properties.m_parametersRemainder;
+	if (m_properties.m_parametersRemainder.empty() == false)
+	{
+		formattedQuery += "&";
+		formattedQuery += m_properties.m_parametersRemainder;
+	}
 
 	setHostNameFilter(queryProps.getHostFilter());
 	setFileNameFilter(queryProps.getFileFilter());
@@ -233,30 +249,44 @@
 #endif
 	while (count < m_maxResultsCount)
 	{
-		string pageQuery = formattedQuery;
+		string pageQuery(formattedQuery);
 
-		if (m_properties.m_nextTag.empty() == false)
+		// How do we scroll ?
+		if (m_properties.m_scrolling == SearchPluginProperties::PER_INDEX)
 		{
-			char factorStr[64];
+			paramIter = m_properties.m_parameters.find(SearchPluginProperties::COUNT_PARAM);
+			if (paramIter != m_properties.m_parameters.end())
+			{
+				// Number of results requested
+				pageQuery += "&";
+				pageQuery += paramIter->second;
+				pageQuery += "=";
+				snprintf(countStr, 64, "%u", m_maxResultsCount);
+				pageQuery += countStr;
+			}
 
-			// Is the INPUTNEXT FACTOR set to zero ?
-			if (m_properties.m_nextFactor == 0)
+			paramIter = m_properties.m_parameters.find(SearchPluginProperties::START_INDEX_PARAM);
+			if (paramIter != m_properties.m_parameters.end())
 			{
-				// Assume INPUTNEXT allows to specify a number of results
-				// Not sure if this is how Sherlock/Mozilla interpret this
+				// The offset of the first result (typically 1 or 0)
 				pageQuery += "&";
-				pageQuery += m_properties.m_nextTag;
+				pageQuery += paramIter->second;
 				pageQuery += "=";
-				snprintf(factorStr, 64, "%u", m_maxResultsCount);
-				pageQuery += factorStr;
+				snprintf(countStr, 64, "%u", count + m_properties.m_nextBase);
+				pageQuery += countStr;
 			}
-			else
+		}
+		else
+		{
+			paramIter = m_properties.m_parameters.find(SearchPluginProperties::START_PAGE_PARAM);
+			if (paramIter != m_properties.m_parameters.end())
 			{
+				// The offset of the page
 				pageQuery += "&";
-				pageQuery += m_properties.m_nextTag;
+				pageQuery += paramIter->second;
 				pageQuery += "=";
-				snprintf(factorStr, 64, "%u", currentFactor + m_properties.m_nextBase);
-				pageQuery += factorStr;
+				snprintf(countStr, 64, "%u", currentIncrement + m_properties.m_nextBase);
+				pageQuery += countStr;
 			}
 		}
 
@@ -265,7 +295,7 @@
 			break;
 		}
 
-		if (m_properties.m_nextFactor == 0)
+		if (m_properties.m_nextIncrement == 0)
 		{
 			// That one page should have all the results...
 #ifdef DEBUG
@@ -275,7 +305,7 @@
 		}
 		else
 		{
-			if (m_resultsList.size() < count + m_properties.m_nextFactor)
+			if (m_resultsList.size() < count + m_properties.m_nextIncrement)
 			{
 				// We got less than the maximum number of results per page
 				// so there's no point in requesting the next page
@@ -286,7 +316,7 @@
 			}
 
 			// Increase factor
-			currentFactor += m_properties.m_nextFactor;
+			currentIncrement += m_properties.m_nextIncrement;
 		}
 		count = m_resultsList.size();
 	}

Modified: trunk/Search/SearchPluginProperties.cpp
===================================================================
--- trunk/Search/SearchPluginProperties.cpp	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/Search/SearchPluginProperties.cpp	2006-01-26 15:12:05 UTC (rev 79)
@@ -22,7 +22,8 @@
 
 SearchPluginProperties::SearchPluginProperties() :
 	m_method(GET_METHOD),
-	m_nextFactor(10),
+	m_scrolling(PER_PAGE),
+	m_nextIncrement(0),
 	m_nextBase(0),
 	m_response(UNKNOWN_RESPONSE)
 {
@@ -37,8 +38,8 @@
 	m_method(other.m_method),
 	m_parametersRemainder(other.m_parametersRemainder),
 	m_outputType(other.m_outputType),
-	m_nextTag(other.m_nextTag),
-	m_nextFactor(other.m_nextFactor),
+	m_scrolling(other.m_scrolling),
+	m_nextIncrement(other.m_nextIncrement),
 	m_nextBase(other.m_nextBase),
 	m_response(other.m_response)
 {
@@ -66,8 +67,8 @@
 	m_method = other.m_method;
 	m_parametersRemainder = other.m_parametersRemainder;
 	m_outputType = other.m_outputType;
-	m_nextTag = other.m_nextTag;
-	m_nextFactor = other.m_nextFactor;
+	m_scrolling = other.m_scrolling;
+	m_nextIncrement = other.m_nextIncrement;
 	m_nextBase = other.m_nextBase;
 	m_response = other.m_response;
 

Modified: trunk/Search/SearchPluginProperties.h
===================================================================
--- trunk/Search/SearchPluginProperties.h	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/Search/SearchPluginProperties.h	2006-01-26 15:12:05 UTC (rev 79)
@@ -38,6 +38,8 @@
 			 COUNT_PARAM,START_INDEX_PARAM, START_PAGE_PARAM, LANGUAGE_PARAM,
 			OUTPUT_ENCODING_PARAM, INPUT_ENCODING_PARAM } Parameter;
 
+		typedef enum { PER_PAGE = 0, PER_INDEX } Scrolling;
+
 		typedef enum { UNKNOWN_RESPONSE = 0, HTML_RESPONSE,
 			RSS_RESPONSE, ATOM_RESPONSE } Response;
 
@@ -55,9 +57,9 @@
 		std::map<Parameter, std::string> m_parameters;
 		std::string m_parametersRemainder;
 		std::string m_outputType;
-		// Query, next page
-		std::string m_nextTag;
-		unsigned int m_nextFactor;
+		// Scrolling
+		Scrolling m_scrolling;
+		unsigned int m_nextIncrement;
 		unsigned int m_nextBase;
 		// Response
 		Response m_response;

Modified: trunk/Search/SherlockParser.cpp
===================================================================
--- trunk/Search/SherlockParser.cpp	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/Search/SherlockParser.cpp	2006-01-26 15:12:05 UTC (rev 79)
@@ -263,7 +263,7 @@
 }
 
 bool SherlockResponseParser::parse(const Document *pResponseDoc, vector<Result> &resultsList,
-	unsigned int maxResultsCount) const
+	unsigned int &totalResults, unsigned int &firstResultIndex) const
 {
 	float pseudoScore = 100;
 	unsigned int contentLen = 0;
@@ -443,7 +443,7 @@
 			resultsList.push_back(Result(url, name, extract, "", pseudoScore));
 			--pseudoScore;
 			foundResult = true;
-			if (resultsList.size() == maxResultsCount)
+			if (resultsList.size() == totalResults)
 			{
 				// Enough results
 				break;
@@ -651,18 +651,32 @@
 				}
 			}
 
-			properties.m_nextTag = nextInput;
 			// Here we differ from how Mozilla uses these parameters
 			// Normally, either factor or value is used, but we use value
 			// as the parameter's initial value
 			if (nextFactor.empty() == false)
 			{
-				properties.m_nextFactor = (unsigned int)atoi(nextFactor.c_str());
+				properties.m_parameters[SearchPluginProperties::START_PAGE_PARAM] = nextInput;
+				properties.m_scrolling = SearchPluginProperties::PER_PAGE;
+				// What Sherlock calls a factor is actually an increment
+				properties.m_nextIncrement = (unsigned int)atoi(nextFactor.c_str());
 			}
+			else
+			{
+				// Assume INPUTNEXT allows to specify a number of results
+				// Not sure if this is how Sherlock/Mozilla interpret this
+				properties.m_parameters[SearchPluginProperties::COUNT_PARAM] = nextInput;
+				properties.m_scrolling = SearchPluginProperties::PER_INDEX;
+				properties.m_nextIncrement = 0;
+			}
 			if (nextValue.empty() == false)
 			{
 				properties.m_nextBase = (unsigned int)atoi(nextValue.c_str());
 			}
+			else
+			{
+				properties.m_nextBase = 0;
+			}
 		}
 	}
 #ifdef DEBUG

Modified: trunk/Search/SherlockParser.h
===================================================================
--- trunk/Search/SherlockParser.h	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/Search/SherlockParser.h	2006-01-26 15:12:05 UTC (rev 79)
@@ -30,7 +30,7 @@
 
 		/// Parses the response; false if not all could be parsed.
 		virtual bool parse(const Document *pResponseDoc, std::vector<Result> &resultsList,
-			unsigned int maxResultsCount) const;
+			unsigned int &totalResults, unsigned int &firstResultIndex) const;
 
 		std::string m_resultListStart;
 		std::string m_resultListEnd;

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/Search/XapianEngine.cpp	2006-01-26 15:12:05 UTC (rev 79)
@@ -411,53 +411,55 @@
 			}
 
 			// Query the database
-			if (queryDatabase(queryStack.top()) == true)
+			if (queryDatabase(queryStack.top()) == false)
 			{
-				if (m_resultsList.empty() == true)
+				break;
+			}
+
+			if (m_resultsList.empty() == true)
+			{
+				// The search did succeed but didn't return anything
+				// Try the next step
+				switch (++searchStep)
 				{
-					// The search did succeed but didn't return anything
-					// Try the next step
-					switch (++searchStep)
-					{
-						case 2:
-							followOperators = true;
-							stemLanguage = queryProps.getLanguage();
-							if (stemLanguage.empty() == false)
-							{
-								break;
-							}
-							++searchStep;
-						case 3:
-							followOperators = false;
-							stemLanguage.clear();
+					case 2:
+						followOperators = true;
+						stemLanguage = queryProps.getLanguage();
+						if (stemLanguage.empty() == false)
+						{
 							break;
-						case 4:
-							followOperators = false;
-							stemLanguage = queryProps.getLanguage();
-							if (stemLanguage.empty() == false)
-							{
-								break;
-							}
-							++searchStep;
-						default:
-							return true;
-					}
+						}
+						++searchStep;
+					case 3:
+						followOperators = false;
+						stemLanguage.clear();
+						break;
+					case 4:
+						followOperators = false;
+						stemLanguage = queryProps.getLanguage();
+						if (stemLanguage.empty() == false)
+						{
+							break;
+						}
+						++searchStep;
+					default:
+						return true;
+				}
 
-					// Empty the stack
-					while (queryStack.empty() == false)
-					{
-						queryStack.pop();
-					}
+				// Empty the stack
+				while (queryStack.empty() == false)
+				{
+					queryStack.pop();
+				}
 #ifdef DEBUG
-					cout << "XapianEngine::runQuery: trying step " << searchStep << endl;
+				cout << "XapianEngine::runQuery: trying step " << searchStep << endl;
 #endif
-					stackQuery(queryProps, queryStack,
-						Languages::toEnglish(stemLanguage), followOperators);
-					continue;
-				}
+				stackQuery(queryProps, queryStack,
+					Languages::toEnglish(stemLanguage), followOperators);
+				continue;
+			}
 
-				return true;
-			}
+			return true;
 		}
 	}
 	catch (const Xapian::Error &error)

Modified: trunk/variables.mk
===================================================================
--- trunk/variables.mk	2006-01-25 14:39:03 UTC (rev 78)
+++ trunk/variables.mk	2006-01-26 15:12:05 UTC (rev 79)
@@ -1,5 +1,5 @@
 CXX := @g++
-LINK := @libtool --mode=link g++
+LINK := @libtool --tag=CXX --mode=link g++ -fPIC
 AR := @ar
 WSDLC := @${GSOAP_HOME}/wsdl2h
 SOAPC := @${GSOAP_HOME}/soapcpp2 -I${GSOAP_HOME}
@@ -52,8 +52,8 @@
 endif
 
 # NEON
-NEON_CXXFLAGS = $(shell neon-config --cflags)
-NEON_LIBS = $(shell neon-config --libs)
+NEON_CXXFLAGS = $(shell /usr/bin/pkg-config --cflags neon)
+NEON_LIBS = $(shell /usr/bin/pkg-config --libs neon)
 # OTS
 OTS_CXXFLAGS = $(shell /usr/bin/pkg-config --cflags libots-1)
 OTS_LIBS = $(shell /usr/bin/pkg-config --libs libots-1)
@@ -69,7 +69,7 @@
 # SQLite
 SQLITE_CXXFLAGS = $(shell /usr/bin/pkg-config --cflags sqlite3)
 SQLITE_LIBS = $(shell /usr/bin/pkg-config --libs sqlite3)
-# LibXML 2.0
+# LibXML++
 LIBXML_CXXFLAGS = $(shell /usr/bin/pkg-config --cflags libxml++-2.6)
 LIBXML_LIBS = $(shell /usr/bin/pkg-config --libs libxml++-2.6)
 # Mozilla
@@ -85,7 +85,7 @@
 MOZILLA_XPCOM_LIBS = -Xlinker -rpath -Xlinker ${MOZILLA_LIB_DIR} $(shell /usr/bin/pkg-config --libs mozilla-xpcom)
 GTKMOZ_CXXFLAGS = $(shell /usr/bin/pkg-config --cflags mozilla-gtkmozembed gtk+-2.0)
 GTKMOZ_LIBS = -Xlinker -rpath -Xlinker ${MOZILLA_LIB_DIR} $(shell /usr/bin/pkg-config --libs mozilla-gtkmozembed gtk+-2.0 mozilla-nss)
-# GTKmm 2.0
+# GTKmm
 GTKMM_CXXFLAGS = $(shell /usr/bin/pkg-config --cflags gtkmm-2.4)
 GTKMM_LIBS = $(shell /usr/bin/pkg-config --libs gtkmm-2.4)
 



From fabricecolin at berlios.de  Thu Jan 26 16:19:59 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Thu, 26 Jan 2006 16:19:59 +0100
Subject: [Pinot-svn] r80 - trunk/Search/Plugins
Message-ID: <200601261519.k0QFJxZc019237@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-26 16:19:59 +0100 (Thu, 26 Jan 2006)
New Revision: 80

Added:
   trunk/Search/Plugins/KodersDescription.xml
   trunk/Search/Plugins/MozDexDescription.xml
Removed:
   trunk/Search/Plugins/Koders.src
Log:
Replaced Koders Sherlock source with its OpenSearch equivalent, added MozDex.


Deleted: trunk/Search/Plugins/Koders.src
===================================================================
--- trunk/Search/Plugins/Koders.src	2006-01-26 15:12:05 UTC (rev 79)
+++ trunk/Search/Plugins/Koders.src	2006-01-26 15:19:59 UTC (rev 80)
@@ -1,25 +0,0 @@
-# Koders Plugin
-
-<SEARCH
-	version="1.0"
-	name="Koders"
-	description="Koders.com"
-	method="GET"
-	action="http://koders.com/"
-	routeType="Source Code"
->
-
-<INPUT NAME="s" USER>
-<INPUT NAME="_%3Abtn" VALUE="Search">
-<INPUT NAME="_%3Ala" VALUE="*">
-<INPUT NAME="_%3Ali" VALUE="*">
-<INPUTNEXT NAME="p" FACTOR="1">
-
-<INTERPRET
-resultListStart=""
-resultListEnd=""
-resultItemStart='class="results_header">'
-resultItemEnd='</tr><tr>'
->
-
-</SEARCH>

Added: trunk/Search/Plugins/KodersDescription.xml
===================================================================
--- trunk/Search/Plugins/KodersDescription.xml	2006-01-26 15:12:05 UTC (rev 79)
+++ trunk/Search/Plugins/KodersDescription.xml	2006-01-26 15:19:59 UTC (rev 80)
@@ -0,0 +1,16 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<OpenSearchDescription xmlns="http://a9.com/-/spec/opensearchdescription/1.0/">
+  <Url>http://www.koders.com/?s={searchTerms}&amp;p={startPage}&amp;output=rss</Url>
+  <Format>http://a9.com/-/spec/opensearchrss/1.0/</Format>
+  <ShortName>Koders</ShortName>
+  <LongName>Koders Source Code Search</LongName>
+  <Description>Search open source code on Koders.com. Supports languages such as java, c, c++, c#, php, perl, python, and many others.</Description>
+  <Tags>OpenSearch</Tags>
+  <Image>http://www.koders.com/images/koders_icon64x64.gif</Image>
+  <SampleSearch>calculator</SampleSearch>
+  <Developer>Koders Inc.</Developer>
+  <Contact>webmaster at koders.com</Contact>
+  <Attribution>&amp;copy; 2005, Koders Inc., All Rights Reserved.</Attribution>
+  <SyndicationRight>open</SyndicationRight>
+  <AdultContent>false</AdultContent>
+</OpenSearchDescription>

Added: trunk/Search/Plugins/MozDexDescription.xml
===================================================================
--- trunk/Search/Plugins/MozDexDescription.xml	2006-01-26 15:12:05 UTC (rev 79)
+++ trunk/Search/Plugins/MozDexDescription.xml	2006-01-26 15:19:59 UTC (rev 80)
@@ -0,0 +1,17 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<OpenSearchDescription xmlns="http://a9.com/-/spec/opensearchdescription/1.0/">
+  <Url>http://www.mozdex.com/open.jsp?query={searchTerms}&amp;start={startIndex}</Url>
+  <Format>http://a9.com/-/spec/opensearchrss/1.0/</Format>
+  <ShortName>Mozdex</ShortName>
+  <LongName>Mozdex Search Engine</LongName>
+  <Description>Search the Internet at Mozdex.com.</Description>
+  <Tags>OpenSearch</Tags>
+  <Image>http://www.mozdex.com/spec/ico-64-unavailable.gif</Image>
+  <SampleSearch>linux</SampleSearch>
+  <Developer>Mozdex.com</Developer>
+  <Contact>byronm at gmail.com</Contact>
+  <Attribution>Search data &amp;copy; 2005, Small Productions,
+   All Rights Reserved</Attribution>
+  <SyndicationRight>open</SyndicationRight>
+  <AdultContent>false</AdultContent>
+</OpenSearchDescription>



From fabricecolin at berlios.de  Sat Jan 28 10:07:34 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Sat, 28 Jan 2006 10:07:34 +0100
Subject: [Pinot-svn] r81 - trunk/UI/GTK2/src
Message-ID: <200601280907.k0S97YtB016090@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-28 10:07:33 +0100 (Sat, 28 Jan 2006)
New Revision: 81

Modified:
   trunk/UI/GTK2/src/Notebook.cpp
   trunk/UI/GTK2/src/Notebook.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Results pages have a VPaned so that the extract field can be resized.
Fixed issue with Listener and MonitorThread's control pipe that prevented
the latter from quitting right away when there's nothing to monitor.


Modified: trunk/UI/GTK2/src/Notebook.cpp
===================================================================
--- trunk/UI/GTK2/src/Notebook.cpp	2006-01-26 15:19:59 UTC (rev 80)
+++ trunk/UI/GTK2/src/Notebook.cpp	2006-01-28 09:07:33 UTC (rev 81)
@@ -53,14 +53,23 @@
 }
 
 ResultsPage::ResultsPage(const ustring &queryName, ResultsTree *pTree,
-	PinotSettings &settings) :
+	int parentHeight, PinotSettings &settings) :
 	NotebookPageBox(queryName, NotebookPageBox::RESULTS_PAGE, settings),
+	m_pVPaned(NULL),
 	m_pTree(pTree)
 {
 	if (pTree != NULL)
 	{
-		pack_start(*pTree->getResultsScrolledWindow(), Gtk::PACK_EXPAND_WIDGET, 0);
-		pack_start(*pTree->getExtractScrolledWindow(), Gtk::PACK_SHRINK, 0);
+		m_pVPaned = manage(new VPaned());
+		m_pVPaned->set_flags(Gtk::CAN_FOCUS);
+		m_pVPaned->set_position(105);
+		m_pVPaned->pack1(*pTree->getResultsScrolledWindow(), Gtk::EXPAND|Gtk::SHRINK);
+		m_pVPaned->pack2(*pTree->getExtractScrolledWindow(), Gtk::SHRINK);
+		pack_start(*m_pVPaned, Gtk::PACK_EXPAND_WIDGET, 0);
+
+		// Give the extract 2/10th of the height
+		m_pVPaned->set_position((parentHeight * 8) / 10);
+		m_pVPaned->show();
 	}
 
 	show();

Modified: trunk/UI/GTK2/src/Notebook.h
===================================================================
--- trunk/UI/GTK2/src/Notebook.h	2006-01-26 15:19:59 UTC (rev 80)
+++ trunk/UI/GTK2/src/Notebook.h	2006-01-28 09:07:33 UTC (rev 81)
@@ -20,6 +20,7 @@
 #include <sigc++/signal.h>
 #include <glibmm/ustring.h>
 #include <gtkmm/box.h>
+#include <gtkmm/paned.h>
 #include <gtkmm/label.h>
 #include <gtkmm/image.h>
 #if _USE_BUTTON_TAB
@@ -58,13 +59,14 @@
 {
 	public:
 		ResultsPage(const Glib::ustring &queryName, ResultsTree *pTree,
-			PinotSettings &settings);
+			int parentHeight, PinotSettings &settings);
 		virtual ~ResultsPage();
 
 		/// Returns the page's tree.
 		virtual ResultsTree *getTree(void) const;
 
 	protected:
+		Gtk::VPaned *m_pVPaned;
 		ResultsTree *m_pTree;
 
 };

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-26 15:19:59 UTC (rev 80)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-28 09:07:33 UTC (rev 81)
@@ -1255,7 +1255,9 @@
 }
 
 ListenerThread::ListenerThread(const string &fifoFileName) :
-	WorkerThread()
+	WorkerThread(),
+	m_ctrlReadPipe(-1),
+	m_ctrlWritePipe(-1)
 {
 	int pipeFds[2];
 
@@ -1336,12 +1338,15 @@
 		fd_set listenSet;
 		FD_ZERO(&listenSet);
 		FD_SET(fd, &listenSet);
-		FD_SET(m_ctrlReadPipe, &listenSet);
+		if (m_ctrlReadPipe >= 0)
+		{
+			FD_SET(m_ctrlReadPipe, &listenSet);
+		}
 
 		// Listen and wait for something to read
 		while (m_done == false)
 		{
-			int fdCount = select(fd + 1, &listenSet, NULL, NULL, NULL);
+			int fdCount = select(max(fd, m_ctrlReadPipe) + 1, &listenSet, NULL, NULL, NULL);
 			if ((fdCount < 0) &&
 				(errno != EINTR))
 			{
@@ -1397,7 +1402,9 @@
 }
 
 MonitorThread::MonitorThread(MonitorHandler *pHandler) :
-	WorkerThread()
+	WorkerThread(),
+	m_ctrlReadPipe(-1),
+	m_ctrlWritePipe(-1)
 {
 	int pipeFds[2];
 
@@ -1437,6 +1444,9 @@
 	m_done = true;
 	write(m_ctrlWritePipe, "Stop", 4);
 	m_status = _("Stopped monitoring");
+#ifdef DEBUG
+	cout << "MonitorThread::do_monitoring: stop called" << endl;
+#endif
 
 	return true;
 }
@@ -1462,6 +1472,19 @@
 	// Wait for something to happen
 	while (m_done == false)
 	{
+		struct timeval selectTimeout;
+		fd_set listenSet;
+		int famFd = -1;
+
+		selectTimeout.tv_sec = 60;
+		selectTimeout.tv_usec = 0;
+
+		FD_ZERO(&listenSet);
+		if (m_ctrlReadPipe >= 0)
+		{
+			FD_SET(m_ctrlReadPipe, &listenSet);
+		}
+
 #ifdef DEBUG
 		cout << "MonitorThread::do_monitoring: checking locations" << endl;
 #endif
@@ -1522,21 +1545,16 @@
 				cout << "MonitorThread::do_monitoring: added " << fsLocation << ", " << famStatus << endl;
 #endif
 			}
+
+			famFd = FAMCONNECTION_GETFD(&famConn);
+			FD_SET(famFd, &listenSet);
 		}
 		setLocationsToMonitor = false;
 
-		int fd = FAMCONNECTION_GETFD(&famConn);
-
-		fd_set listenSet;
-		FD_ZERO(&listenSet);
-		FD_SET(fd, &listenSet);
-		FD_SET(m_ctrlReadPipe, &listenSet);
-
-		struct timeval selectTimeout;
-		selectTimeout.tv_sec = 60;
-		selectTimeout.tv_usec = 0;
-
-		int fdCount = select(fd + 1, &listenSet, NULL, NULL, &selectTimeout);
+#ifdef DEBUG
+		cout << "MonitorThread::do_monitoring: starting select()" << endl;
+#endif
+		int fdCount = select(max(famFd, m_ctrlReadPipe) + 1, &listenSet, NULL, NULL, &selectTimeout);
 		if ((fdCount < 0) &&
 			(errno != EINTR))
 		{
@@ -1545,7 +1563,8 @@
 #endif
 			break;
 		}
-		else if (FD_ISSET(fd, &listenSet))
+		else if ((famFd >= 0) &&
+			(FD_ISSET(famFd, &listenSet)))
 		{
 			// There might be more than one event waiting...
 			int pendingEvents = FAMPending(&famConn);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-26 15:19:59 UTC (rev 80)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-28 09:07:33 UTC (rev 81)
@@ -867,7 +867,7 @@
 
 			// Position the results tree
 			pResultsTree = manage(new ResultsTree(queryName, resultsMenuitem->get_submenu(), m_settings));
-			pResultsPage = manage(new ResultsPage(queryName, pResultsTree, m_settings));
+			pResultsPage = manage(new ResultsPage(queryName, pResultsTree, m_pNotebook->get_height(), m_settings));
 			// Connect to the "changed" signal
 			pResultsTree->getSelectionChangedSignal().connect(
 				SigC::slot(*this, &mainWindow::on_resultsTreeviewSelection_changed));



From fabricecolin at berlios.de  Mon Jan 30 04:49:04 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 30 Jan 2006 04:49:04 +0100
Subject: [Pinot-svn] r82 - trunk/Search/Plugins
Message-ID: <200601300349.k0U3n4dF017403@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-30 04:49:01 +0100 (Mon, 30 Jan 2006)
New Revision: 82

Modified:
   trunk/Search/Plugins/Topix.src
Log:
Fixed Topix search plugin.


Modified: trunk/Search/Plugins/Topix.src
===================================================================
--- trunk/Search/Plugins/Topix.src	2006-01-28 09:07:33 UTC (rev 81)
+++ trunk/Search/Plugins/Topix.src	2006-01-30 03:49:01 UTC (rev 82)
@@ -11,12 +11,13 @@
 
 <INPUT NAME="q" USER>
 <INPUT NAME="n" VALUE="search">
+<INPUT NAME="list" VALUE="1">
 <INPUTNEXT NAME="start" FACTOR="1" VALUE="0">
 
 <INTERPRET
 resultListStart=""
 resultListEnd=""
-resultItemStart='<div class=searchres>'
+resultItemStart='<div class="article">'
 resultItemEnd='</div> </div>'
 >
 



From fabricecolin at berlios.de  Mon Jan 30 05:04:26 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 30 Jan 2006 05:04:26 +0100
Subject: [Pinot-svn] r83 - trunk/Search/Plugins
Message-ID: <200601300404.k0U44Qbg026519@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-30 05:04:21 +0100 (Mon, 30 Jan 2006)
New Revision: 83

Added:
   trunk/Search/Plugins/OmegaDescription.xml
Removed:
   trunk/Search/Plugins/Omega.src
Log:
Replaced Omega.src with an OpenSearch Description file as Omega supports
OpenSearch Response.


Deleted: trunk/Search/Plugins/Omega.src
===================================================================
--- trunk/Search/Plugins/Omega.src	2006-01-30 03:49:01 UTC (rev 82)
+++ trunk/Search/Plugins/Omega.src	2006-01-30 04:04:21 UTC (rev 83)
@@ -1,35 +0,0 @@
-# Xapian Omega Search Plugin
-
-<SEARCH
-	version="1.0"
-	name="Xapian Omega"
-	description="Xapian Omega"
-	method="GET"
-	action="http://localhost/cgi-bin/omega"
-	routeType="Local Host"
->
-
-<INPUT NAME="P" USER>
-<INPUT NAME="DEFAULTOP" VALUE="or">
-<INPUT NAME="DB" VALUE="default">
-<INPUT NAME="FMT" VALUE="query">
-<INPUT NAME="FILTERS" VALUE="--O">
-<INPUTNEXT NAME="%5B" FACTOR="1" VALUE="1">
-
-<INTERPRET
-resultListStart="<hits>"
-resultListEnd="</hits>"
-resultItemStart="<TD VALIGN=top>"
-resultItemEnd="</small><P></TD>"
-# The following attributes are specific to Pinot
-#resultTitleStart='title="'
-#resultTitleEnd='"'
-#resultLinkStart='url="'
-#resultLinkEnd='"'
-#resultExtractStart='sample="'
-#resultExtractEnd='"'
->
-
-</SEARCH>
-
-

Added: trunk/Search/Plugins/OmegaDescription.xml
===================================================================
--- trunk/Search/Plugins/OmegaDescription.xml	2006-01-30 03:49:01 UTC (rev 82)
+++ trunk/Search/Plugins/OmegaDescription.xml	2006-01-30 04:04:21 UTC (rev 83)
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+<OpenSearchDescription xmlns="http://a9.com/-/spec/opensearchdescription/1.0/">
+	<ShortName>Xapian Omega</ShortName>
+	<LongName>The Xapian Omega CGI search frontend</LongName>
+	<Description>Omega is a CGI application which uses the Xapian Information Retrieval library to search collections of documents.</Description>
+	<Tags>OpenSearch</Tags>
+	<Url type="application/rss+xml" template="http://localhost/cgi-bin/omega?P={searchTerms}&amp;DEFAULTOP=or&amp;DB=default&amp;FMT=opensearch&amp;%5B={startPage}" />
+</OpenSearchDescription>



From fabricecolin at berlios.de  Mon Jan 30 07:23:49 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 30 Jan 2006 07:23:49 +0100
Subject: [Pinot-svn] r84 - in trunk/Search: . Plugins
Message-ID: <200601300623.k0U6NnnC032374@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-30 07:23:44 +0100 (Mon, 30 Jan 2006)
New Revision: 84

Modified:
   trunk/Search/OpenSearchParser.cpp
   trunk/Search/Plugins/KodersDescription.xml
   trunk/Search/Plugins/MozDexDescription.xml
   trunk/Search/Plugins/OmegaDescription.xml
Log:
Use Tags as the channel name.


Modified: trunk/Search/OpenSearchParser.cpp
===================================================================
--- trunk/Search/OpenSearchParser.cpp	2006-01-30 04:04:21 UTC (rev 83)
+++ trunk/Search/OpenSearchParser.cpp	2006-01-30 06:23:44 UTC (rev 84)
@@ -507,9 +507,8 @@
 				}
 				else if (nodeName == "Tags")
 				{
-					// This is a space-delimited list, pick the first tag
-					string::size_type pos = nodeContent.find(" ");
-					properties.m_channel = nodeContent.substr(0, pos);
+					// This is supposed to be a space-delimited list, but use the whole thing as channel
+					properties.m_channel = nodeContent;
 				}
 				else if (nodeName == "LongName")
 				{

Modified: trunk/Search/Plugins/KodersDescription.xml
===================================================================
--- trunk/Search/Plugins/KodersDescription.xml	2006-01-30 04:04:21 UTC (rev 83)
+++ trunk/Search/Plugins/KodersDescription.xml	2006-01-30 06:23:44 UTC (rev 84)
@@ -5,7 +5,7 @@
   <ShortName>Koders</ShortName>
   <LongName>Koders Source Code Search</LongName>
   <Description>Search open source code on Koders.com. Supports languages such as java, c, c++, c#, php, perl, python, and many others.</Description>
-  <Tags>OpenSearch</Tags>
+  <Tags>Source Code</Tags>
   <Image>http://www.koders.com/images/koders_icon64x64.gif</Image>
   <SampleSearch>calculator</SampleSearch>
   <Developer>Koders Inc.</Developer>

Modified: trunk/Search/Plugins/MozDexDescription.xml
===================================================================
--- trunk/Search/Plugins/MozDexDescription.xml	2006-01-30 04:04:21 UTC (rev 83)
+++ trunk/Search/Plugins/MozDexDescription.xml	2006-01-30 06:23:44 UTC (rev 84)
@@ -5,7 +5,7 @@
   <ShortName>Mozdex</ShortName>
   <LongName>Mozdex Search Engine</LongName>
   <Description>Search the Internet at Mozdex.com.</Description>
-  <Tags>OpenSearch</Tags>
+  <Tags>The Web</Tags>
   <Image>http://www.mozdex.com/spec/ico-64-unavailable.gif</Image>
   <SampleSearch>linux</SampleSearch>
   <Developer>Mozdex.com</Developer>

Modified: trunk/Search/Plugins/OmegaDescription.xml
===================================================================
--- trunk/Search/Plugins/OmegaDescription.xml	2006-01-30 04:04:21 UTC (rev 83)
+++ trunk/Search/Plugins/OmegaDescription.xml	2006-01-30 06:23:44 UTC (rev 84)
@@ -3,6 +3,6 @@
 	<ShortName>Xapian Omega</ShortName>
 	<LongName>The Xapian Omega CGI search frontend</LongName>
 	<Description>Omega is a CGI application which uses the Xapian Information Retrieval library to search collections of documents.</Description>
-	<Tags>OpenSearch</Tags>
+	<Tags>Local Host</Tags>
 	<Url type="application/rss+xml" template="http://localhost/cgi-bin/omega?P={searchTerms}&amp;DEFAULTOP=or&amp;DB=default&amp;FMT=opensearch&amp;%5B={startPage}" />
 </OpenSearchDescription>



From fabricecolin at berlios.de  Mon Jan 30 16:15:07 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Mon, 30 Jan 2006 16:15:07 +0100
Subject: [Pinot-svn] r85 - trunk/po
Message-ID: <200601301515.k0UFF7O1025955@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-30 16:15:06 +0100 (Mon, 30 Jan 2006)
New Revision: 85

Added:
   trunk/po/es_ES.po
Modified:
   trunk/po/en_GB.po
   trunk/po/fr_FR.po
Log:
Synced PO files with current source. Added (almost final) Spanish translation
by Jes?\195?\186s Tramullas (jesus at tramullas dot com).


Modified: trunk/po/en_GB.po
===================================================================
--- trunk/po/en_GB.po	2006-01-30 06:23:44 UTC (rev 84)
+++ trunk/po/en_GB.po	2006-01-30 15:15:06 UTC (rev 85)
@@ -28,41 +28,46 @@
 #: UI/GTK2/src/mainWindow.cc:347 UI/GTK2/src/mainWindow.cc:520
 #: UI/GTK2/src/mainWindow.cc:1055 UI/GTK2/src/mainWindow.cc:1139
 #: UI/GTK2/src/mainWindow.cc:1174 UI/GTK2/src/mainWindow.cc:1787
-#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:865
-#: UI/GTK2/src/PinotSettings.cpp:921
+#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:881
+#: UI/GTK2/src/PinotSettings.cpp:937
 msgid "My Documents"
 msgstr ""
 
 #: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:350
 #: UI/GTK2/src/mainWindow.cc:353 UI/GTK2/src/mainWindow.cc:524
 #: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:200
-#: UI/GTK2/src/PinotSettings.cpp:866 UI/GTK2/src/PinotSettings.cpp:922
+#: UI/GTK2/src/PinotSettings.cpp:882 UI/GTK2/src/PinotSettings.cpp:938
 #: UI/GTK2/src/prefsDialog_glade.cc:116
 msgid "My Email"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:104
+#: UI/GTK2/src/importDialog.cc:108
 msgid "Enabled"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:105 UI/GTK2/src/prefsDialog.cc:78
+#: UI/GTK2/src/importDialog.cc:109 UI/GTK2/src/prefsDialog.cc:78
 msgid "MIME Type"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:130
+#: UI/GTK2/src/importDialog.cc:134
 msgid "File"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:133
+#: UI/GTK2/src/importDialog.cc:137
 msgid "Directory"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:138 UI/GTK2/src/IndexTree.cpp:70
+#: UI/GTK2/src/importDialog.cc:142 UI/GTK2/src/IndexTree.cpp:70
 #: UI/GTK2/src/ResultsTree.cpp:114
 msgid "URL"
 msgstr ""
 
-#: UI/GTK2/src/importDialog.cc:426
+#: UI/GTK2/src/importDialog.cc:148 UI/GTK2/src/IndexPage.cpp:158
+#: UI/GTK2/src/IndexPage.cpp:204 UI/GTK2/src/queryDialog.cc:91
+msgid "None"
+msgstr ""
+
+#: UI/GTK2/src/importDialog.cc:444
 msgid "Document To Import"
 msgstr ""
 
@@ -96,11 +101,15 @@
 msgid "Follow symlinks"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:88 UI/GTK2/src/mainWindow_glade.cc:201
+#: UI/GTK2/src/importDialog_glade.cc:83
+msgid "Apply label:"
+msgstr ""
+
+#: UI/GTK2/src/importDialog_glade.cc:91 UI/GTK2/src/mainWindow_glade.cc:201
 msgid "Import"
 msgstr ""
 
-#: UI/GTK2/src/importDialog_glade.cc:200
+#: UI/GTK2/src/importDialog_glade.cc:211
 msgid "Import document"
 msgstr ""
 
@@ -136,11 +145,6 @@
 msgid "Show Next"
 msgstr ""
 
-#: UI/GTK2/src/IndexPage.cpp:158 UI/GTK2/src/IndexPage.cpp:204
-#: UI/GTK2/src/queryDialog.cc:91
-msgid "None"
-msgstr ""
-
 #: UI/GTK2/src/mainWindow.cc:148
 msgid "Query Name"
 msgstr ""
@@ -166,7 +170,7 @@
 msgstr ""
 
 #: UI/GTK2/src/mainWindow.cc:249 UI/GTK2/src/mainWindow.cc:1012
-#: UI/GTK2/src/mainWindow.cc:1384 UI/GTK2/src/mainWindow.cc:2967
+#: UI/GTK2/src/mainWindow.cc:1384 UI/GTK2/src/mainWindow.cc:2956
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr ""
@@ -207,7 +211,7 @@
 msgid "Query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2797
+#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2786
 msgid "on"
 msgstr ""
 
@@ -248,7 +252,7 @@
 msgstr ""
 
 #: UI/GTK2/src/mainWindow.cc:1240 UI/GTK2/src/mainWindow.cc:2141
-#: UI/GTK2/src/mainWindow.cc:2631
+#: UI/GTK2/src/mainWindow.cc:2620
 msgid "is already in use"
 msgstr ""
 
@@ -274,12 +278,12 @@
 
 #: UI/GTK2/src/mainWindow.cc:1907 UI/GTK2/src/pinot.cc:148
 #: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:371
-#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1209
+#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1221
 msgid "Index"
 msgstr ""
 
 #: UI/GTK2/src/mainWindow.cc:1911 UI/GTK2/src/WorkerThreads.cpp:375
-#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1213
+#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1225
 msgid "doesn't exist"
 msgstr ""
 
@@ -319,55 +323,55 @@
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2627
+#: UI/GTK2/src/mainWindow.cc:2616
 msgid "Query name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2654
+#: UI/GTK2/src/mainWindow.cc:2643
 msgid "Couldn't update query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2662
+#: UI/GTK2/src/mainWindow.cc:2651
 msgid "Edited query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2669
+#: UI/GTK2/src/mainWindow.cc:2658
 msgid "Couldn't add query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2677
+#: UI/GTK2/src/mainWindow.cc:2666
 msgid "Added new query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2691
+#: UI/GTK2/src/mainWindow.cc:2680
 msgid "Query is not set"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2702
+#: UI/GTK2/src/mainWindow.cc:2691
 msgid "No search engine selected"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2784
+#: UI/GTK2/src/mainWindow.cc:2773
 msgid "Please set the Google API key first"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2793
+#: UI/GTK2/src/mainWindow.cc:2782
 msgid "Running query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2898
+#: UI/GTK2/src/mainWindow.cc:2887
 msgid "is already indexed or is being indexed"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2925
+#: UI/GTK2/src/mainWindow.cc:2914
 msgid "No URL to browse"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2936
+#: UI/GTK2/src/mainWindow.cc:2925
 msgid "No browser configured to view results"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2948
+#: UI/GTK2/src/mainWindow.cc:2937
 msgid "Couldn't browse URL:"
 msgstr ""
 
@@ -541,31 +545,35 @@
 msgid "Green"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:280
+#: UI/GTK2/src/PinotSettings.cpp:289
 msgid "Couldn't load ui block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:287
+#: UI/GTK2/src/PinotSettings.cpp:296
 msgid "Couldn't load extraindex block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:294
+#: UI/GTK2/src/PinotSettings.cpp:303
 msgid "Couldn't load storedquery block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:301
+#: UI/GTK2/src/PinotSettings.cpp:310
 msgid "Couldn't load results block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:308
+#: UI/GTK2/src/PinotSettings.cpp:317
 msgid "Couldn't load label block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:326
+#: UI/GTK2/src/PinotSettings.cpp:335
 msgid "Couldn't load mailaccount block"
 msgstr ""
 
-#: UI/GTK2/src/PinotSettings.cpp:716
+#: UI/GTK2/src/PinotSettings.cpp:343
+msgid "Couldn't parse configuration file"
+msgstr ""
+
+#: UI/GTK2/src/PinotSettings.cpp:732
 msgid "Unclassified"
 msgstr ""
 
@@ -727,8 +735,8 @@
 
 #: UI/GTK2/src/WorkerThreads.cpp:384 UI/GTK2/src/WorkerThreads.cpp:620
 #: UI/GTK2/src/WorkerThreads.cpp:665 UI/GTK2/src/WorkerThreads.cpp:675
-#: UI/GTK2/src/WorkerThreads.cpp:893 UI/GTK2/src/WorkerThreads.cpp:1094
-#: UI/GTK2/src/WorkerThreads.cpp:1222
+#: UI/GTK2/src/WorkerThreads.cpp:891 UI/GTK2/src/WorkerThreads.cpp:1106
+#: UI/GTK2/src/WorkerThreads.cpp:1234
 msgid "Index error on"
 msgstr ""
 
@@ -760,74 +768,74 @@
 msgid "Couldn't obtain downloader for protocol"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:796 UI/GTK2/src/WorkerThreads.cpp:907
+#: UI/GTK2/src/WorkerThreads.cpp:796 UI/GTK2/src/WorkerThreads.cpp:905
 msgid "Couldn't retrieve"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:878
+#: UI/GTK2/src/WorkerThreads.cpp:876
 msgid "Stopped indexing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:931
+#: UI/GTK2/src/WorkerThreads.cpp:929
 msgid "Cannot index document type"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:935
+#: UI/GTK2/src/WorkerThreads.cpp:933
 msgid "at"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:960
+#: UI/GTK2/src/WorkerThreads.cpp:958
 msgid "Couldn't tokenize"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:981
+#: UI/GTK2/src/WorkerThreads.cpp:979
 msgid "Robots META tag forbids indexing"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1017
+#: UI/GTK2/src/WorkerThreads.cpp:1029
 msgid "Couldn't index"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1082
+#: UI/GTK2/src/WorkerThreads.cpp:1094
 msgid "Stopped unindexing document(s)"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1102
+#: UI/GTK2/src/WorkerThreads.cpp:1114
 msgid "Couldn't unindex document(s)"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1194
+#: UI/GTK2/src/WorkerThreads.cpp:1206
 msgid "Stopped document update for "
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1231
+#: UI/GTK2/src/WorkerThreads.cpp:1243
 msgid "Couldn't update document"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1279
+#: UI/GTK2/src/WorkerThreads.cpp:1293
 msgid "Stopped listening on"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1379
+#: UI/GTK2/src/WorkerThreads.cpp:1396
 msgid "Couldn't read FIFO at"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1427
+#: UI/GTK2/src/WorkerThreads.cpp:1446
 msgid "Stopped monitoring"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1445
+#: UI/GTK2/src/WorkerThreads.cpp:1467
 msgid "No monitoring handler"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1479
+#: UI/GTK2/src/WorkerThreads.cpp:1514
 msgid "Couldn't open FAM connection"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1693
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "Stopped scanning"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1851
+#: UI/GTK2/src/WorkerThreads.cpp:1882
 msgid "Couldn't open directory"
 msgstr ""

Added: trunk/po/es_ES.po
===================================================================
--- trunk/po/es_ES.po	2006-01-30 06:23:44 UTC (rev 84)
+++ trunk/po/es_ES.po	2006-01-30 15:15:06 UTC (rev 85)
@@ -0,0 +1,841 @@
+# es_ES PO file for pinot.
+# Copyright (C) 2006 Fabrice Colin, Jes?s Tramullas
+# This file is distributed under the same license as the pinot package.
+# Jes?s Tramullas <jesus at tramullas.com>, 2006.
+#
+#, fuzzy
+msgid ""
+msgstr ""
+"Project-Id-Version: pinot 0.40\n"
+"Report-Msgid-Bugs-To: \n"
+"POT-Creation-Date: 2006-01-26 10:20+0800\n"
+"PO-Revision-Date: 2006-01-30 16:44+0800\n"
+"Last-Translator: Jes?s Tramullas <jesus at tramullas.com>\n"
+"Language-Team: es_ES <jesus at tramullas.com>\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=utf-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#: UI/GTK2/src/EnginesTree.cpp:67
+msgid "Search Engines"
+msgstr "Motores de b?squeda"
+
+#: UI/GTK2/src/EnginesTree.cpp:291
+msgid "Current User"
+msgstr "Usuario"
+
+#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:344
+#: UI/GTK2/src/mainWindow.cc:347 UI/GTK2/src/mainWindow.cc:520
+#: UI/GTK2/src/mainWindow.cc:1055 UI/GTK2/src/mainWindow.cc:1139
+#: UI/GTK2/src/mainWindow.cc:1174 UI/GTK2/src/mainWindow.cc:1787
+#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:881
+#: UI/GTK2/src/PinotSettings.cpp:937
+msgid "My Documents"
+msgstr "Mis documentos"
+
+#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:350
+#: UI/GTK2/src/mainWindow.cc:353 UI/GTK2/src/mainWindow.cc:524
+#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:200
+#: UI/GTK2/src/PinotSettings.cpp:882 UI/GTK2/src/PinotSettings.cpp:938
+#: UI/GTK2/src/prefsDialog_glade.cc:116
+msgid "My Email"
+msgstr "Mi email"
+
+#: UI/GTK2/src/importDialog.cc:108
+msgid "Enabled"
+msgstr "Activo"
+
+#: UI/GTK2/src/importDialog.cc:109 UI/GTK2/src/prefsDialog.cc:78
+msgid "MIME Type"
+msgstr "Tipo MIME"
+
+#: UI/GTK2/src/importDialog.cc:134
+msgid "File"
+msgstr "Fichero"
+
+#: UI/GTK2/src/importDialog.cc:137
+msgid "Directory"
+msgstr "Directorio"
+
+#: UI/GTK2/src/importDialog.cc:142 UI/GTK2/src/IndexTree.cpp:70
+#: UI/GTK2/src/ResultsTree.cpp:114
+msgid "URL"
+msgstr "URL"
+
+#: UI/GTK2/src/importDialog.cc:148 UI/GTK2/src/IndexPage.cpp:158
+#: UI/GTK2/src/IndexPage.cpp:204 UI/GTK2/src/queryDialog.cc:91
+msgid "None"
+msgstr "Ninguno"
+
+#: UI/GTK2/src/importDialog.cc:444
+msgid "Document To Import"
+msgstr "Documento a importar"
+
+#: UI/GTK2/src/importDialog_glade.cc:66 UI/GTK2/src/indexDialog_glade.cc:68
+msgid "Location:"
+msgstr "Localizaci?n:"
+
+#: UI/GTK2/src/importDialog_glade.cc:67
+#: UI/GTK2/src/propertiesDialog_glade.cc:64
+msgid "Title:"
+msgstr "T?tulo:"
+
+#: UI/GTK2/src/importDialog_glade.cc:70 UI/GTK2/src/indexDialog_glade.cc:67
+msgid "Type:"
+msgstr "Tipo:"
+
+#: UI/GTK2/src/importDialog_glade.cc:72 UI/GTK2/src/indexDialog_glade.cc:64
+#: UI/GTK2/src/prefsDialog_glade.cc:70
+msgid "..."
+msgstr "..."
+
+#: UI/GTK2/src/importDialog_glade.cc:78
+msgid "Depth:"
+msgstr "Profundidad:"
+
+#: UI/GTK2/src/importDialog_glade.cc:79
+msgid "Symlinks:"
+msgstr "Enlaces:"
+
+#: UI/GTK2/src/importDialog_glade.cc:80
+msgid "Follow symlinks"
+msgstr "Seguir los enlaces"
+
+#: UI/GTK2/src/importDialog_glade.cc:83
+msgid "Apply label:"
+msgstr ""
+
+#: UI/GTK2/src/importDialog_glade.cc:91 UI/GTK2/src/mainWindow_glade.cc:201
+msgid "Import"
+msgstr "Importar"
+
+#: UI/GTK2/src/importDialog_glade.cc:211
+msgid "Import document"
+msgstr "Importar documento"
+
+#: UI/GTK2/src/indexDialog.cc:221
+msgid "Index location"
+msgstr "Localizaci?n del ?ndice"
+
+#: UI/GTK2/src/indexDialog_glade.cc:62 UI/GTK2/src/queryDialog_glade.cc:60
+msgid "Name:"
+msgstr "Nombre:"
+
+#: UI/GTK2/src/indexDialog_glade.cc:69
+msgid "Port:"
+msgstr "Puerto:"
+
+#: UI/GTK2/src/indexDialog_glade.cc:143
+msgid "External index"
+msgstr "?ndice externo"
+
+#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:96
+msgid "Title"
+msgstr "T?tulo"
+
+#: UI/GTK2/src/IndexTree.cpp:75
+msgid "Timestamp"
+msgstr "Fecha"
+
+#: UI/GTK2/src/IndexPage.cpp:50
+msgid "Show Previous"
+msgstr "Mostrar previos"
+
+#: UI/GTK2/src/IndexPage.cpp:56
+msgid "Show Next"
+msgstr "Mostrar siguientes"
+
+#: UI/GTK2/src/mainWindow.cc:148
+msgid "Query Name"
+msgstr "Nombre de la b?squeda"
+
+#: UI/GTK2/src/mainWindow.cc:153
+msgid "Last Run"
+msgstr "?ltima ejecuci?n"
+
+#: UI/GTK2/src/mainWindow.cc:154
+msgid "Summary"
+msgstr "Sumario"
+
+#: UI/GTK2/src/mainWindow.cc:211
+msgid "Add index"
+msgstr "A?adir ?ndice"
+
+#: UI/GTK2/src/mainWindow.cc:212
+msgid "Remove index"
+msgstr "Borrar ?ndice"
+
+#: UI/GTK2/src/mainWindow.cc:235
+msgid "Ready"
+msgstr "Listo"
+
+#: UI/GTK2/src/mainWindow.cc:249 UI/GTK2/src/mainWindow.cc:1012
+#: UI/GTK2/src/mainWindow.cc:1384 UI/GTK2/src/mainWindow.cc:2956
+#: UI/GTK2/src/mainWindow_glade.cc:207
+msgid "View"
+msgstr "Ver"
+
+#: UI/GTK2/src/mainWindow.cc:281
+msgid "N/A"
+msgstr "Desconocido"
+
+#: UI/GTK2/src/mainWindow.cc:291
+msgid "<undefined>"
+msgstr "<indefinido>"
+
+#: UI/GTK2/src/mainWindow.cc:482
+msgid "Result location is"
+msgstr "La localizaci?n del resultado es"
+
+#: UI/GTK2/src/mainWindow.cc:535
+msgid "Document location is"
+msgstr "La localizaci?n del documento es"
+
+#: UI/GTK2/src/mainWindow.cc:644
+msgid "No label"
+msgstr "Sin etiqueta"
+
+#: UI/GTK2/src/mainWindow.cc:793
+msgid "Showing"
+msgstr "Mostrando"
+
+#: UI/GTK2/src/mainWindow.cc:798
+msgid "off"
+msgstr "desactivado"
+
+#: UI/GTK2/src/mainWindow.cc:803
+msgid "documents, starting at"
+msgstr "documentos comenzando en"
+
+#: UI/GTK2/src/mainWindow.cc:837
+msgid "Query"
+msgstr "B?squeda"
+
+#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2786
+msgid "on"
+msgstr "en"
+
+#: UI/GTK2/src/mainWindow.cc:845
+msgid "ended"
+msgstr "finalizado"
+
+#: UI/GTK2/src/mainWindow.cc:946 UI/GTK2/src/propertiesDialog.cc:40
+msgid "Label"
+msgstr "Etiqueta"
+
+#: UI/GTK2/src/mainWindow.cc:950
+msgid "matches"
+msgstr "correspondencias"
+
+#: UI/GTK2/src/mainWindow.cc:955
+msgid "document(s)"
+msgstr "documento(s)"
+
+#: UI/GTK2/src/mainWindow.cc:987
+msgid "Updated label(s)"
+msgstr "Etiqueta(s) actualizada(s)"
+
+#: UI/GTK2/src/mainWindow.cc:1065 UI/GTK2/src/mainWindow.cc:1185
+msgid "Updated document"
+msgstr "Documento actualizado"
+
+#: UI/GTK2/src/mainWindow.cc:1078
+msgid "Indexed"
+msgstr "Indizado"
+
+#: UI/GTK2/src/mainWindow.cc:1140
+msgid "Unindexed document(s)"
+msgstr "Documento(s) no indizado(s)"
+
+#: UI/GTK2/src/mainWindow.cc:1236
+msgid "Couldn't rename index, name"
+msgstr "No se podu renombrar el ?ndice, nombre"
+
+#: UI/GTK2/src/mainWindow.cc:1240 UI/GTK2/src/mainWindow.cc:2141
+#: UI/GTK2/src/mainWindow.cc:2620
+msgid "is already in use"
+msgstr "ya est? en uso"
+
+#: UI/GTK2/src/mainWindow.cc:1253
+msgid "Couldn't rename index"
+msgstr "No se pudo renombrar el ?ndice"
+
+#: UI/GTK2/src/mainWindow.cc:1266
+msgid "Edited index"
+msgstr "?ndice editado"
+
+#: UI/GTK2/src/mainWindow.cc:1726 UI/GTK2/src/mainWindow.cc:1829
+msgid "Please set a location for the index first"
+msgstr "Por favor, primero fije una localizaci?n para el ?ndice"
+
+#: UI/GTK2/src/mainWindow.cc:1753
+msgid "Result location is unknown"
+msgstr "Se desconoce la localizaci?n del resultado"
+
+#: UI/GTK2/src/mainWindow.cc:1777
+msgid "Import Document(s)"
+msgstr "Importar Documento(s)"
+
+#: UI/GTK2/src/mainWindow.cc:1907 UI/GTK2/src/pinot.cc:148
+#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:371
+#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1221
+msgid "Index"
+msgstr "?ndice"
+
+#: UI/GTK2/src/mainWindow.cc:1911 UI/GTK2/src/WorkerThreads.cpp:375
+#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1225
+msgid "doesn't exist"
+msgstr "no existe"
+
+#: UI/GTK2/src/mainWindow.cc:2021
+msgid "Delete this document from the index ?"
+msgstr "Enlever ce document de l'index ?"
+
+#: UI/GTK2/src/mainWindow.cc:2040
+msgid "Delete these documents from the index ?"
+msgstr "?Borrar este documento del ?ndice?"
+
+#: UI/GTK2/src/mainWindow.cc:2092
+msgid "A metasearch tool for the Free Desktop"
+msgstr "Una herramienta metabuscador para el escritorio libre"
+
+#: UI/GTK2/src/mainWindow.cc:2093
+msgid "(C) 2005-2006 Fabrice Colin"
+msgstr "(C) 2005-2006 Fabrice Colin"
+
+#: UI/GTK2/src/mainWindow.cc:2137
+msgid "Index name"
+msgstr "Nombre del ?ndice"
+
+#: UI/GTK2/src/mainWindow.cc:2152
+msgid "Couldn't add index"
+msgstr "No se pudo a?adir el ?ndice"
+
+#: UI/GTK2/src/mainWindow.cc:2166
+msgid "Added new index"
+msgstr "A?adido un nuevo ?ndice"
+
+#: UI/GTK2/src/mainWindow.cc:2201
+msgid "Couldn't remove index"
+msgstr "No se pudo borrar el ?ndice"
+
+#: UI/GTK2/src/mainWindow.cc:2435
+msgid "At least one task hasn't completed yet. Quit now ?"
+msgstr "Al menos una tarea no ha finalizado. ?Parar ahora?"
+
+#: UI/GTK2/src/mainWindow.cc:2616
+msgid "Query name"
+msgstr "Nombre la b?squeda"
+
+#: UI/GTK2/src/mainWindow.cc:2643
+msgid "Couldn't update query"
+msgstr "No se pudo actualizar la b?squeda"
+
+#: UI/GTK2/src/mainWindow.cc:2651
+msgid "Edited query"
+msgstr "B?squeda editada"
+
+#: UI/GTK2/src/mainWindow.cc:2658
+msgid "Couldn't add query"
+msgstr "No se pudo a?adir la b?squeda"
+
+#: UI/GTK2/src/mainWindow.cc:2666
+msgid "Added new query"
+msgstr "A?adida una nueva b?squeda"
+
+#: UI/GTK2/src/mainWindow.cc:2680
+msgid "Query is not set"
+msgstr "B?squeda no definida"
+
+#: UI/GTK2/src/mainWindow.cc:2691
+msgid "No search engine selected"
+msgstr "Motor de b?squeda no seleccionado"
+
+#: UI/GTK2/src/mainWindow.cc:2773
+msgid "Please set the Google API key first"
+msgstr "Por favor, primero configure el API de Google"
+
+#: UI/GTK2/src/mainWindow.cc:2782
+msgid "Running query"
+msgstr "Ejecutando la b?squeda"
+
+#: UI/GTK2/src/mainWindow.cc:2887
+msgid "is already indexed or is being indexed"
+msgstr "ya ha sido indizado, o se est? indizando"
+
+#: UI/GTK2/src/mainWindow.cc:2914
+msgid "No URL to browse"
+msgstr "No hay URL que mostrar"
+
+#: UI/GTK2/src/mainWindow.cc:2925
+msgid "No browser configured to view results"
+msgstr "NO ha configurado un navegador para ver los resultados"
+
+#: UI/GTK2/src/mainWindow.cc:2937
+msgid "Couldn't browse URL:"
+msgstr "No se pudo mostrar el URL:"
+
+#: UI/GTK2/src/mainWindow_glade.cc:115
+msgid "Query:"
+msgstr "B?squeda:"
+
+#: UI/GTK2/src/mainWindow_glade.cc:127 UI/GTK2/src/prefsDialog_glade.cc:86
+msgid "Edit"
+msgstr "Editar"
+
+#: UI/GTK2/src/mainWindow_glade.cc:136
+msgid "Stored queries"
+msgstr "B?squedas guardadas"
+
+#: UI/GTK2/src/mainWindow_glade.cc:171
+msgid "Search Engine"
+msgstr "Motores de b?squeda"
+
+#: UI/GTK2/src/mainWindow_glade.cc:174
+msgid "Host Name"
+msgstr "Nombre del servidor"
+
+#: UI/GTK2/src/mainWindow_glade.cc:177
+msgid "Clear List"
+msgstr "Limpiar la lista"
+
+#: UI/GTK2/src/mainWindow_glade.cc:180
+msgid "Show Extract"
+msgstr "Mostrar extra?dos"
+
+#: UI/GTK2/src/mainWindow_glade.cc:183
+msgid "Group By"
+msgstr "Agrupar por"
+
+#: UI/GTK2/src/mainWindow_glade.cc:189
+msgid "Vie_w"
+msgstr "Ver"
+
+#: UI/GTK2/src/mainWindow_glade.cc:192
+msgid "View Cache"
+msgstr "Ver la cache"
+
+#: UI/GTK2/src/mainWindow_glade.cc:195 UI/GTK2/src/mainWindow_glade.cc:231
+msgid "_Index"
+msgstr "?ndice"
+
+#: UI/GTK2/src/mainWindow_glade.cc:198
+msgid "List Contents Of"
+msgstr "Listar el contenido de"
+
+#: UI/GTK2/src/mainWindow_glade.cc:210
+msgid "Update"
+msgstr "Actualizar"
+
+#: UI/GTK2/src/mainWindow_glade.cc:213
+msgid "Unindex"
+msgstr "Desindizar"
+
+#: UI/GTK2/src/mainWindow_glade.cc:216
+#: UI/GTK2/src/propertiesDialog_glade.cc:171
+#: UI/GTK2/src/queryDialog_glade.cc:83
+msgid "Properties"
+msgstr "Propiedades"
+
+#: UI/GTK2/src/mainWindow_glade.cc:219
+msgid "_About"
+msgstr "Sobre"
+
+#: UI/GTK2/src/mainWindow_glade.cc:222
+msgid "_Session"
+msgstr "Sesi?n"
+
+#: UI/GTK2/src/mainWindow_glade.cc:225
+msgid "_Edit"
+msgstr "Editar"
+
+#: UI/GTK2/src/mainWindow_glade.cc:228
+msgid "_Results"
+msgstr "Resultados"
+
+#: UI/GTK2/src/mainWindow_glade.cc:234
+msgid "_Help"
+msgstr "Ayuda"
+
+#: UI/GTK2/src/mainWindow_glade.cc:356
+msgid "Pinot"
+msgstr "Pinot"
+
+#: UI/GTK2/src/pinot.cc:56
+msgid "Couldn't save configuration file"
+msgstr "No se pudo guardar el fichero de configuraci?n"
+
+#: UI/GTK2/src/pinot.cc:117
+msgid "Danish"
+msgstr "Dan?s"
+
+#: UI/GTK2/src/pinot.cc:118
+msgid "Dutch"
+msgstr "Holand?s"
+
+#: UI/GTK2/src/pinot.cc:119
+msgid "English"
+msgstr "Ingl?s"
+
+#: UI/GTK2/src/pinot.cc:120
+msgid "Finnish"
+msgstr "Finland?s"
+
+#: UI/GTK2/src/pinot.cc:121
+msgid "French"
+msgstr "Franc?s"
+
+#: UI/GTK2/src/pinot.cc:122
+msgid "German"
+msgstr "Alem?n"
+
+#: UI/GTK2/src/pinot.cc:123
+msgid "Italian"
+msgstr "Italiano"
+
+#: UI/GTK2/src/pinot.cc:124
+msgid "Norwegian"
+msgstr "Noruego"
+
+#: UI/GTK2/src/pinot.cc:125
+msgid "Portuguese"
+msgstr "Portugu?s"
+
+#: UI/GTK2/src/pinot.cc:126
+msgid "Russian"
+msgstr "Ruso"
+
+#: UI/GTK2/src/pinot.cc:127
+msgid "Spanish"
+msgstr "Espa?ol"
+
+#: UI/GTK2/src/pinot.cc:128
+msgid "Swedish"
+msgstr "Sueco"
+
+#: UI/GTK2/src/pinot.cc:149 UI/GTK2/src/pinot.cc:154
+msgid "is not valid, please check"
+msgstr "no es v?lido, por favor compru?belo"
+
+#: UI/GTK2/src/pinot.cc:162
+msgid "History database"
+msgstr "Base de datos del hist?rico"
+
+#: UI/GTK2/src/pinot.cc:163
+msgid "couldn't be created"
+msgstr "no se pudo crear"
+
+#: UI/GTK2/src/PinotSettings.cpp:106
+msgid "Couldn't create pinot directory at"
+msgstr "No se pudo crear un directorio pinot en"
+
+#: UI/GTK2/src/PinotSettings.cpp:195
+msgid "Failed to parse configuration file"
+msgstr "Fallo en el fichero de configuraci?n"
+
+#: UI/GTK2/src/PinotSettings.cpp:204
+msgid "Red"
+msgstr "Rojo"
+
+#: UI/GTK2/src/PinotSettings.cpp:206
+msgid "Blue"
+msgstr "Azul"
+
+#: UI/GTK2/src/PinotSettings.cpp:208
+msgid "Green"
+msgstr "Verde"
+
+#: UI/GTK2/src/PinotSettings.cpp:289
+msgid "Couldn't load ui block"
+msgstr "No se pudo cargar el bloque ui"
+
+#: UI/GTK2/src/PinotSettings.cpp:296
+msgid "Couldn't load extraindex block"
+msgstr "No se pudo cargar el bloque extraindex"
+
+#: UI/GTK2/src/PinotSettings.cpp:303
+msgid "Couldn't load storedquery block"
+msgstr "No se pudo cargar el bloque storedquery"
+
+#: UI/GTK2/src/PinotSettings.cpp:310
+msgid "Couldn't load results block"
+msgstr "o se pudo cargar el bloque results"
+
+#: UI/GTK2/src/PinotSettings.cpp:317
+msgid "Couldn't load label block"
+msgstr "o se pudo cargar el bloque label"
+
+#: UI/GTK2/src/PinotSettings.cpp:335
+msgid "Couldn't load mailaccount block"
+msgstr "o se pudo cargar el bloque mailaccount"
+
+#: UI/GTK2/src/PinotSettings.cpp:343
+msgid "Couldn't parse configuration file"
+msgstr ""
+
+#: UI/GTK2/src/PinotSettings.cpp:732
+msgid "Unclassified"
+msgstr "No clasificado"
+
+#: UI/GTK2/src/prefsDialog.cc:69
+msgid "Name"
+msgstr "Nombre"
+
+#: UI/GTK2/src/prefsDialog.cc:77
+msgid "Location"
+msgstr "Localizaci?n"
+
+#: UI/GTK2/src/prefsDialog.cc:114
+msgid "In internal viewer"
+msgstr "En el visor interno"
+
+#: UI/GTK2/src/prefsDialog.cc:117
+msgid "In browser"
+msgstr "En el navegador"
+
+#: UI/GTK2/src/prefsDialog.cc:332
+msgid "Browser location"
+msgstr "Mostrar la localizaci?n"
+
+#: UI/GTK2/src/prefsDialog.cc:343
+msgid "New Label"
+msgstr "Nueva etiqueta"
+
+#: UI/GTK2/src/prefsDialog.cc:365
+msgid "Colour"
+msgstr "Color"
+
+#: UI/GTK2/src/prefsDialog.cc:436 UI/GTK2/src/prefsDialog.cc:470
+msgid "Mbox File Location"
+msgstr "Localizaci?n del fichero mbox"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:62
+msgid "HTTP crawling:"
+msgstr "Navegador HTTP:"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:63
+msgid "View documents:"
+msgstr "Ver los documentos"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:64
+msgid "Browser:"
+msgstr "Navegador:"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:65
+msgid "Google API key:"
+msgstr "Clave del API de Google"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:68
+msgid "Ignore robots.txt and Robots META tag"
+msgstr "Ignorar robots.txt y la etiqueta META Robots"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:74
+msgid "General"
+msgstr "General"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:75
+msgid "Labels are used to classify indexed documents:"
+msgstr "Las etiquetas se usan para clasificar los documentos indizados:"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:80 UI/GTK2/src/prefsDialog_glade.cc:106
+msgid "Add"
+msgstr "A?adir"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:92
+msgid "Remove"
+msgstr "Borrar"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:100
+msgid "Labels"
+msgstr "Etiquetas"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:101
+msgid "Mail boxes of type mbox can be monitored and indexed:"
+msgstr "Lo sbuzones de correo de tipo mbox pueden ser controlados e indizados"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:332
+msgid "Preferences"
+msgstr "Preferencias"
+
+#: UI/GTK2/src/propertiesDialog.cc:51
+msgid "Unknown"
+msgstr "Desconocido"
+
+#: UI/GTK2/src/propertiesDialog_glade.cc:65
+msgid "Extract:"
+msgstr "Extraer:"
+
+#: UI/GTK2/src/propertiesDialog_glade.cc:66
+msgid "Language:"
+msgstr "Idioma:"
+
+#: UI/GTK2/src/propertiesDialog_glade.cc:68
+msgid "MIME type:"
+msgstr "Tipo MIME:"
+
+#: UI/GTK2/src/queryDialog.cc:96 UI/GTK2/src/queryDialog.cc:125
+msgid "Any"
+msgstr "Cualquiera"
+
+#: UI/GTK2/src/queryDialog_glade.cc:70
+msgid "Index all results with label"
+msgstr "Indizar todos los resultados con la etiqueta"
+
+#: UI/GTK2/src/queryDialog_glade.cc:72
+msgid "Any of the words:"
+msgstr "Cualquiera de las palabras:"
+
+#: UI/GTK2/src/queryDialog_glade.cc:73
+msgid "File name:"
+msgstr "Nombre de fichero:"
+
+#: UI/GTK2/src/queryDialog_glade.cc:74
+msgid "Number of results:"
+msgstr "N?mero de resultados:"
+
+#: UI/GTK2/src/queryDialog_glade.cc:77
+msgid "Host name:"
+msgstr "Nombre del servidor:"
+
+#: UI/GTK2/src/queryDialog_glade.cc:78
+msgid "None of the words:"
+msgstr "Ninguna de las palabras:"
+
+#: UI/GTK2/src/queryDialog_glade.cc:84
+msgid "Limit to documents that match"
+msgstr "Limitar a los documentos que coincidan"
+
+#: UI/GTK2/src/queryDialog_glade.cc:87
+msgid "the exact phrase:"
+msgstr "la frase exacta"
+
+#: UI/GTK2/src/queryDialog_glade.cc:88
+msgid "the language:"
+msgstr "el idioma"
+
+#: UI/GTK2/src/queryDialog_glade.cc:92
+msgid "all the words:"
+msgstr "todas las palabras:"
+
+#: UI/GTK2/src/queryDialog_glade.cc:93
+msgid "the label:"
+msgstr "la etiqueta"
+
+#: UI/GTK2/src/queryDialog_glade.cc:98
+msgid "Advanced"
+msgstr "Avanzado"
+
+#: UI/GTK2/src/queryDialog_glade.cc:283
+msgid "Query properties"
+msgstr "Propriedades de la b?squeda"
+
+#: UI/GTK2/src/WorkerThreads.cpp:350
+msgid "Stopped browsing"
+msgstr "Exploraci?n detenida"
+
+#: UI/GTK2/src/WorkerThreads.cpp:384 UI/GTK2/src/WorkerThreads.cpp:620
+#: UI/GTK2/src/WorkerThreads.cpp:665 UI/GTK2/src/WorkerThreads.cpp:675
+#: UI/GTK2/src/WorkerThreads.cpp:891 UI/GTK2/src/WorkerThreads.cpp:1106
+#: UI/GTK2/src/WorkerThreads.cpp:1234
+msgid "Index error on"
+msgstr "Error en el ?ndice"
+
+#: UI/GTK2/src/WorkerThreads.cpp:490
+msgid "Stopped querying"
+msgstr "B?squeda detenida"
+
+#: UI/GTK2/src/WorkerThreads.cpp:502
+msgid "Couldn't create search engine"
+msgstr "No se pudo crear el motor de b?squeda"
+
+#: UI/GTK2/src/WorkerThreads.cpp:514
+msgid "Couldn't run query on search engine"
+msgstr "No se pudo ejecutar la b?squeda contra el motor"
+
+#: UI/GTK2/src/WorkerThreads.cpp:530
+msgid "No title"
+msgstr "Sin t?tulo"
+
+#: UI/GTK2/src/WorkerThreads.cpp:592 UI/GTK2/src/WorkerThreads.cpp:656
+msgid "Stopped querying index labels"
+msgstr "Detenida la b?squeda de etiquetas de ?ndice"
+
+#: UI/GTK2/src/WorkerThreads.cpp:746
+msgid "Stopped retrieval of"
+msgstr "Detenida la recuperaci?n de"
+
+#: UI/GTK2/src/WorkerThreads.cpp:782
+msgid "Couldn't obtain downloader for protocol"
+msgstr "No se pudo usar un recuperador para el protocolo"
+
+#: UI/GTK2/src/WorkerThreads.cpp:796 UI/GTK2/src/WorkerThreads.cpp:905
+msgid "Couldn't retrieve"
+msgstr "No se pudo descargar"
+
+#: UI/GTK2/src/WorkerThreads.cpp:876
+msgid "Stopped indexing"
+msgstr "Detenida la indizaci?n"
+
+#: UI/GTK2/src/WorkerThreads.cpp:929
+msgid "Cannot index document type"
+msgstr "No se pudo indizar el tipo de documento"
+
+#: UI/GTK2/src/WorkerThreads.cpp:933
+msgid "at"
+msgstr "a"
+
+#: UI/GTK2/src/WorkerThreads.cpp:958
+msgid "Couldn't tokenize"
+msgstr "No se pudo parcourir"
+
+#: UI/GTK2/src/WorkerThreads.cpp:979
+msgid "Robots META tag forbids indexing"
+msgstr "La etiqueta META Robots proh?be la indizaci?n"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1029
+msgid "Couldn't index"
+msgstr "No se pudo indizar"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1094
+msgid "Stopped unindexing document(s)"
+msgstr "Detenida la desindizaci?n de documento(s)"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1114
+msgid "Couldn't unindex document(s)"
+msgstr "No se pudo desindizar lo(s) documento(s)"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1206
+msgid "Stopped document update for "
+msgstr "Detenida la actualizaci?n del documento por "
+
+#: UI/GTK2/src/WorkerThreads.cpp:1243
+msgid "Couldn't update document"
+msgstr "No se pudo actualizar el documento"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1293
+msgid "Stopped listening on"
+msgstr "Detenida la escucha en"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1396
+msgid "Couldn't read FIFO at"
+msgstr "No se pudo leer FIFO en"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1446
+msgid "Stopped monitoring"
+msgstr "Detenida la monitorizaci?n"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1467
+msgid "No monitoring handler"
+msgstr "No hay monitorizaci?n"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1514
+msgid "Couldn't open FAM connection"
+msgstr "No se pudo abrir la conexi?n FAM"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1724
+msgid "Stopped scanning"
+msgstr "Detenida la exploraci?n"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1882
+msgid "Couldn't open directory"
+msgstr "No se pudo abrir el directorio"

Modified: trunk/po/fr_FR.po
===================================================================
--- trunk/po/fr_FR.po	2006-01-30 06:23:44 UTC (rev 84)
+++ trunk/po/fr_FR.po	2006-01-30 15:15:06 UTC (rev 85)
@@ -28,41 +28,46 @@
 #: UI/GTK2/src/mainWindow.cc:347 UI/GTK2/src/mainWindow.cc:520
 #: UI/GTK2/src/mainWindow.cc:1055 UI/GTK2/src/mainWindow.cc:1139
 #: UI/GTK2/src/mainWindow.cc:1174 UI/GTK2/src/mainWindow.cc:1787
-#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:865
-#: UI/GTK2/src/PinotSettings.cpp:921
+#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:881
+#: UI/GTK2/src/PinotSettings.cpp:937
 msgid "My Documents"
 msgstr "Mes Documents"
 
 #: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:350
 #: UI/GTK2/src/mainWindow.cc:353 UI/GTK2/src/mainWindow.cc:524
 #: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:200
-#: UI/GTK2/src/PinotSettings.cpp:866 UI/GTK2/src/PinotSettings.cpp:922
+#: UI/GTK2/src/PinotSettings.cpp:882 UI/GTK2/src/PinotSettings.cpp:938
 #: UI/GTK2/src/prefsDialog_glade.cc:116
 msgid "My Email"
 msgstr "Mon Courrier"
 
-#: UI/GTK2/src/importDialog.cc:104
+#: UI/GTK2/src/importDialog.cc:108
 msgid "Enabled"
 msgstr "Active"
 
-#: UI/GTK2/src/importDialog.cc:105 UI/GTK2/src/prefsDialog.cc:78
+#: UI/GTK2/src/importDialog.cc:109 UI/GTK2/src/prefsDialog.cc:78
 msgid "MIME Type"
 msgstr "Type MIME"
 
-#: UI/GTK2/src/importDialog.cc:130
+#: UI/GTK2/src/importDialog.cc:134
 msgid "File"
 msgstr "Fichier"
 
-#: UI/GTK2/src/importDialog.cc:133
+#: UI/GTK2/src/importDialog.cc:137
 msgid "Directory"
 msgstr "Repertoire"
 
-#: UI/GTK2/src/importDialog.cc:138 UI/GTK2/src/IndexTree.cpp:70
+#: UI/GTK2/src/importDialog.cc:142 UI/GTK2/src/IndexTree.cpp:70
 #: UI/GTK2/src/ResultsTree.cpp:114
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/importDialog.cc:426
+#: UI/GTK2/src/importDialog.cc:148 UI/GTK2/src/IndexPage.cpp:158
+#: UI/GTK2/src/IndexPage.cpp:204 UI/GTK2/src/queryDialog.cc:91
+msgid "None"
+msgstr ""
+
+#: UI/GTK2/src/importDialog.cc:444
 msgid "Document To Import"
 msgstr "Document A Importer"
 
@@ -96,11 +101,15 @@
 msgid "Follow symlinks"
 msgstr "Suivre les liens symboliques"
 
-#: UI/GTK2/src/importDialog_glade.cc:88 UI/GTK2/src/mainWindow_glade.cc:201
+#: UI/GTK2/src/importDialog_glade.cc:83
+msgid "Apply label:"
+msgstr ""
+
+#: UI/GTK2/src/importDialog_glade.cc:91 UI/GTK2/src/mainWindow_glade.cc:201
 msgid "Import"
 msgstr "Importer"
 
-#: UI/GTK2/src/importDialog_glade.cc:200
+#: UI/GTK2/src/importDialog_glade.cc:211
 msgid "Import document"
 msgstr "Import de document"
 
@@ -136,11 +145,6 @@
 msgid "Show Next"
 msgstr "Suivants"
 
-#: UI/GTK2/src/IndexPage.cpp:158 UI/GTK2/src/IndexPage.cpp:204
-#: UI/GTK2/src/queryDialog.cc:91
-msgid "None"
-msgstr "Aucune"
-
 #: UI/GTK2/src/mainWindow.cc:148
 msgid "Query Name"
 msgstr "Nom de la Recherche"
@@ -166,7 +170,7 @@
 msgstr "Pret"
 
 #: UI/GTK2/src/mainWindow.cc:249 UI/GTK2/src/mainWindow.cc:1012
-#: UI/GTK2/src/mainWindow.cc:1384 UI/GTK2/src/mainWindow.cc:2967
+#: UI/GTK2/src/mainWindow.cc:1384 UI/GTK2/src/mainWindow.cc:2956
 #: UI/GTK2/src/mainWindow_glade.cc:207
 msgid "View"
 msgstr "Voir"
@@ -207,7 +211,7 @@
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2797
+#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2786
 msgid "on"
 msgstr "sur"
 
@@ -248,7 +252,7 @@
 msgstr "N'a pas pu renommer l'index"
 
 #: UI/GTK2/src/mainWindow.cc:1240 UI/GTK2/src/mainWindow.cc:2141
-#: UI/GTK2/src/mainWindow.cc:2631
+#: UI/GTK2/src/mainWindow.cc:2620
 msgid "is already in use"
 msgstr "est deja utilise"
 
@@ -274,12 +278,12 @@
 
 #: UI/GTK2/src/mainWindow.cc:1907 UI/GTK2/src/pinot.cc:148
 #: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:371
-#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1209
+#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1221
 msgid "Index"
 msgstr "L'index"
 
 #: UI/GTK2/src/mainWindow.cc:1911 UI/GTK2/src/WorkerThreads.cpp:375
-#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1213
+#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1225
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
@@ -319,55 +323,55 @@
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2627
+#: UI/GTK2/src/mainWindow.cc:2616
 msgid "Query name"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2654
+#: UI/GTK2/src/mainWindow.cc:2643
 msgid "Couldn't update query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2662
+#: UI/GTK2/src/mainWindow.cc:2651
 msgid "Edited query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2669
+#: UI/GTK2/src/mainWindow.cc:2658
 msgid "Couldn't add query"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2677
+#: UI/GTK2/src/mainWindow.cc:2666
 msgid "Added new query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2691
+#: UI/GTK2/src/mainWindow.cc:2680
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2702
+#: UI/GTK2/src/mainWindow.cc:2691
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:2784
+#: UI/GTK2/src/mainWindow.cc:2773
 msgid "Please set the Google API key first"
 msgstr "Configurez la clef de l'API Google "
 
-#: UI/GTK2/src/mainWindow.cc:2793
+#: UI/GTK2/src/mainWindow.cc:2782
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:2898
+#: UI/GTK2/src/mainWindow.cc:2887
 msgid "is already indexed or is being indexed"
 msgstr "est deja indexe ou est en cours d'indexation"
 
-#: UI/GTK2/src/mainWindow.cc:2925
+#: UI/GTK2/src/mainWindow.cc:2914
 msgid "No URL to browse"
 msgstr "Pas d'URL a brouter"
 
-#: UI/GTK2/src/mainWindow.cc:2936
+#: UI/GTK2/src/mainWindow.cc:2925
 msgid "No browser configured to view results"
 msgstr "Pas de brouter configure"
 
-#: UI/GTK2/src/mainWindow.cc:2948
+#: UI/GTK2/src/mainWindow.cc:2937
 msgid "Couldn't browse URL:"
 msgstr "N'a pas pu brouter l'URL"
 
@@ -541,31 +545,35 @@
 msgid "Green"
 msgstr "Vert"
 
-#: UI/GTK2/src/PinotSettings.cpp:280
+#: UI/GTK2/src/PinotSettings.cpp:289
 msgid "Couldn't load ui block"
 msgstr "N'a pas pu charger le bloc ui"
 
-#: UI/GTK2/src/PinotSettings.cpp:287
+#: UI/GTK2/src/PinotSettings.cpp:296
 msgid "Couldn't load extraindex block"
 msgstr "N'a pas pu charger le bloc extraindex"
 
-#: UI/GTK2/src/PinotSettings.cpp:294
+#: UI/GTK2/src/PinotSettings.cpp:303
 msgid "Couldn't load storedquery block"
 msgstr "N'a pas pu charger le bloc storedquery"
 
-#: UI/GTK2/src/PinotSettings.cpp:301
+#: UI/GTK2/src/PinotSettings.cpp:310
 msgid "Couldn't load results block"
 msgstr "N'a pas pu charger le bloc results"
 
-#: UI/GTK2/src/PinotSettings.cpp:308
+#: UI/GTK2/src/PinotSettings.cpp:317
 msgid "Couldn't load label block"
 msgstr "N'a pas pu charger le bloc label"
 
-#: UI/GTK2/src/PinotSettings.cpp:326
+#: UI/GTK2/src/PinotSettings.cpp:335
 msgid "Couldn't load mailaccount block"
 msgstr "N'a pas pu charger le bloc mailaccount"
 
-#: UI/GTK2/src/PinotSettings.cpp:716
+#: UI/GTK2/src/PinotSettings.cpp:343
+msgid "Couldn't parse configuration file"
+msgstr ""
+
+#: UI/GTK2/src/PinotSettings.cpp:732
 msgid "Unclassified"
 msgstr "Non classifie"
 
@@ -727,8 +735,8 @@
 
 #: UI/GTK2/src/WorkerThreads.cpp:384 UI/GTK2/src/WorkerThreads.cpp:620
 #: UI/GTK2/src/WorkerThreads.cpp:665 UI/GTK2/src/WorkerThreads.cpp:675
-#: UI/GTK2/src/WorkerThreads.cpp:893 UI/GTK2/src/WorkerThreads.cpp:1094
-#: UI/GTK2/src/WorkerThreads.cpp:1222
+#: UI/GTK2/src/WorkerThreads.cpp:891 UI/GTK2/src/WorkerThreads.cpp:1106
+#: UI/GTK2/src/WorkerThreads.cpp:1234
 msgid "Index error on"
 msgstr "Erreur sur l'index"
 
@@ -760,74 +768,74 @@
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N'a pas pu obtenir un brouteur pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:796 UI/GTK2/src/WorkerThreads.cpp:907
+#: UI/GTK2/src/WorkerThreads.cpp:796 UI/GTK2/src/WorkerThreads.cpp:905
 msgid "Couldn't retrieve"
 msgstr "N'a pas pu telecharger"
 
-#: UI/GTK2/src/WorkerThreads.cpp:878
+#: UI/GTK2/src/WorkerThreads.cpp:876
 msgid "Stopped indexing"
 msgstr "Arrete l'indexation"
 
-#: UI/GTK2/src/WorkerThreads.cpp:931
+#: UI/GTK2/src/WorkerThreads.cpp:929
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer de type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:935
+#: UI/GTK2/src/WorkerThreads.cpp:933
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:960
+#: UI/GTK2/src/WorkerThreads.cpp:958
 msgid "Couldn't tokenize"
 msgstr "N'a pas pu parcourir"
 
-#: UI/GTK2/src/WorkerThreads.cpp:981
+#: UI/GTK2/src/WorkerThreads.cpp:979
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots empeche d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1017
+#: UI/GTK2/src/WorkerThreads.cpp:1029
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1082
+#: UI/GTK2/src/WorkerThreads.cpp:1094
 msgid "Stopped unindexing document(s)"
 msgstr "Arrete d'indexer les document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1102
+#: UI/GTK2/src/WorkerThreads.cpp:1114
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1194
+#: UI/GTK2/src/WorkerThreads.cpp:1206
 msgid "Stopped document update for "
 msgstr "Arrete la mise a jour pour "
 
-#: UI/GTK2/src/WorkerThreads.cpp:1231
+#: UI/GTK2/src/WorkerThreads.cpp:1243
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1279
+#: UI/GTK2/src/WorkerThreads.cpp:1293
 msgid "Stopped listening on"
 msgstr "Arrete l'ecoute sur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1379
+#: UI/GTK2/src/WorkerThreads.cpp:1396
 msgid "Couldn't read FIFO at"
 msgstr "N'a pas pu lire la FIFO a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1427
+#: UI/GTK2/src/WorkerThreads.cpp:1446
 msgid "Stopped monitoring"
 msgstr "Arrete la surveillance"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1445
+#: UI/GTK2/src/WorkerThreads.cpp:1467
 msgid "No monitoring handler"
 msgstr "Pas de moniteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1479
+#: UI/GTK2/src/WorkerThreads.cpp:1514
 msgid "Couldn't open FAM connection"
 msgstr "N'a pas pu ouvrir la connection FAM"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1693
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "Stopped scanning"
 msgstr "Arrete de scanner"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1851
+#: UI/GTK2/src/WorkerThreads.cpp:1882
 msgid "Couldn't open directory"
 msgstr "N'a pas pu ovrir le repertoire"



From fabricecolin at berlios.de  Tue Jan 31 03:59:38 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 31 Jan 2006 03:59:38 +0100
Subject: [Pinot-svn] r86 - in trunk: UI/GTK2/src po
Message-ID: <200601310259.k0V2xcti002948@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-31 03:59:27 +0100 (Tue, 31 Jan 2006)
New Revision: 86

Modified:
   trunk/UI/GTK2/src/pinot.cc
   trunk/po/es_ES.po
Log:
Complete Spanish translation. Main program catches exceptions, eg thrown by
set_icon_from_file().


Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2006-01-30 15:15:06 UTC (rev 85)
+++ trunk/UI/GTK2/src/pinot.cc	2006-01-31 02:59:27 UTC (rev 86)
@@ -165,9 +165,21 @@
 
 	atexit(closeAll);
 
-	// Create and open the main dialog box
-	mainWindow mainBox;
-	m.run(mainBox);
+	try
+	{
+		// Create and open the main dialog box
+		mainWindow mainBox;
+		m.run(mainBox);
+	}
+	catch (const Glib::Exception &e)
+	{
+		cerr << e.what() << endl;
+		return EXIT_FAILURE;
+	}
+	catch (...)
+	{
+		return EXIT_FAILURE;
+	}
 
 	return EXIT_SUCCESS;
 }

Modified: trunk/po/es_ES.po
===================================================================
--- trunk/po/es_ES.po	2006-01-30 15:15:06 UTC (rev 85)
+++ trunk/po/es_ES.po	2006-01-31 02:59:27 UTC (rev 86)
@@ -103,7 +103,7 @@
 
 #: UI/GTK2/src/importDialog_glade.cc:83
 msgid "Apply label:"
-msgstr ""
+msgstr "Etiqueta aplicada:"
 
 #: UI/GTK2/src/importDialog_glade.cc:91 UI/GTK2/src/mainWindow_glade.cc:201
 msgid "Import"
@@ -567,11 +567,11 @@
 
 #: UI/GTK2/src/PinotSettings.cpp:335
 msgid "Couldn't load mailaccount block"
-msgstr "o se pudo cargar el bloque mailaccount"
+msgstr "No se pudo cargar el bloque mailaccount"
 
 #: UI/GTK2/src/PinotSettings.cpp:343
 msgid "Couldn't parse configuration file"
-msgstr ""
+msgstr "No se pudo procesar el fichero de configuraci?n"
 
 #: UI/GTK2/src/PinotSettings.cpp:732
 msgid "Unclassified"



From fabricecolin at berlios.de  Tue Jan 31 04:19:30 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 31 Jan 2006 04:19:30 +0100
Subject: [Pinot-svn] r87 - trunk/Tokenize
Message-ID: <200601310319.k0V3JUdf010630@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-31 04:19:10 +0100 (Tue, 31 Jan 2006)
New Revision: 87

Modified:
   trunk/Tokenize/TokenizerFactory.cpp
Log:
Use dlerror().


Modified: trunk/Tokenize/TokenizerFactory.cpp
===================================================================
--- trunk/Tokenize/TokenizerFactory.cpp	2006-01-31 02:59:27 UTC (rev 86)
+++ trunk/Tokenize/TokenizerFactory.cpp	2006-01-31 03:19:10 UTC (rev 87)
@@ -186,11 +186,11 @@
 							}
 						}
 #ifdef DEBUG
-						else cout << "TokenizerFactory::loadTokenizers: couldn't find export getTokenizerType" << endl;
+						else cout << "TokenizerFactory::loadTokenizers: " << dlerror() << endl;
 #endif
 					}
 #ifdef DEBUG
-					else cout << "TokenizerFactory::loadTokenizers: couldn't open " << fileName << endl;
+					else cout << "TokenizerFactory::loadTokenizers: " << dlerror() << endl;
 #endif
 				}
 #ifdef DEBUG



From fabricecolin at berlios.de  Tue Jan 31 04:21:02 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 31 Jan 2006 04:21:02 +0100
Subject: [Pinot-svn] r88 - in trunk: . UI/GTK2 po
Message-ID: <200601310321.k0V3L2Om011002@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-31 04:20:50 +0100 (Tue, 31 Jan 2006)
New Revision: 88

Modified:
   trunk/ChangeLog
   trunk/Makefile
   trunk/README
   trunk/TODO
   trunk/UI/GTK2/config.h
   trunk/pinot.spec
   trunk/po/en_GB.po
   trunk/po/es_ES.po
   trunk/po/fr_FR.po
Log:
Preparing for v0.42 release.


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2006-01-31 03:19:10 UTC (rev 87)
+++ trunk/ChangeLog	2006-01-31 03:20:50 UTC (rev 88)
@@ -1,3 +1,15 @@
+2006/01/31 version_0_4_2
+Search :
+ - support for OpenSearch Description, Query and Response
+ - replaced Koders and Omega Sherlock plugins with their OpenSearch equivalent
+ - added MozDex
+Index :
+ - queries on an index that cannot be locked no longer loop
+UI :
+ - when no email boxes were being monitored, Pinot wouldn't exit right away
+ - results extract field can be resized
+ - Spanish translation by Jes?s Tramullas (jesus at tramullas dot com)
+
 2006/01/20 version_0_4_0
 UI and SQLite :
  - dropped ActionHistory

Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2006-01-31 03:19:10 UTC (rev 87)
+++ trunk/Makefile	2006-01-31 03:20:50 UTC (rev 88)
@@ -28,6 +28,7 @@
 	@mkdir -p mo
 	@msgfmt -o mo/en_GB.mo po/en_GB.po
 	@msgfmt -o mo/fr_FR.mo po/fr_FR.po
+	@msgfmt -o mo/es_ES.mo po/es_ES.po
 
 %_clean :
 	@make -C $(patsubst %_clean, %, $@) clean
@@ -51,6 +52,7 @@
 	install -m 644 textcat_conf.txt $(PREFIX)/usr/share/pinot/
 	@mkdir -p $(PREFIX)/usr/share/locale/fr/LC_MESSAGES/
 	install -m 644 mo/fr_FR.mo $(PREFIX)/usr/share/locale/fr/LC_MESSAGES/pinot.mo
+	install -m 644 mo/es_ES.mo $(PREFIX)/usr/share/locale/es/LC_MESSAGES/pinot.mo
 	@mkdir -p $(PREFIX)/usr/share/icons/hicolor/48x48/apps/
 	install -m 644 UI/GTK2/pinot.png $(PREFIX)/usr/share/icons/hicolor/48x48/apps/
 

Modified: trunk/README
===================================================================
--- trunk/README	2006-01-31 03:19:10 UTC (rev 87)
+++ trunk/README	2006-01-31 03:20:50 UTC (rev 88)
@@ -66,6 +66,9 @@
 antiword						antiword-0.36.1-2
 http://www.winfield.demon.nl/
 
+unrtf							unrtf-0.19.3-4
+http://www.gnu.org/software/unrtf/unrtf.html
+
 glademm (6)						glademm-2.6.0_cvs-SNAP
 http://home.wtal.de/petig/Gtk/index.html
 

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2006-01-31 03:19:10 UTC (rev 87)
+++ trunk/TODO	2006-01-31 03:20:50 UTC (rev 88)
@@ -22,9 +22,11 @@
 - Add http://beta.exalead.com/search
 - Add csourcesearch.net
 - Add http://www.patentcommons.org/commons/patentsearch.php
+- Add http://www.podzinger.com/
 - Apply Pinot specific filters (eg "L" for language) on internal indices only
 - Assuming text is tokenized a la omindex, use Xapian's QueryParser, map fields
   (label, language, title) to prefixes, etc...
+- Implement AutoDiscovery of OpenSearch Description files (http://opensearch.a9.com/spec/1.1/description/)
 
 Collect
 - Comply with robot stuff defined at http://www.robotstxt.org/
@@ -36,6 +38,7 @@
 - Allow to cache documents that had to be converted ? eg PDF, MS Word
 - Use poppler for the PDF tokenizer
 - Write a basic XML tokenizer that skips tags
+- WordPerfect tokenizer with libwpd
 
 Index
 - Get hold of stopwords lists for the languages supported by Xapian's stemmers and don't index stop words
@@ -79,13 +82,12 @@
 - Switching back and forth between grouping modes messes up results rankings : check scores
 - When sorting results by host name, give better score to results that appear several times
 - Results and index trees should be sorted when clicking on columns
-- Make sure all operations (eg search engines) and threads can be stopped cleanly
 - Show which threads are running, what they are doing, and allow to stop them selectively
 - Add an history window to edit Index and ViewHistory
 - Automatic indexing of a query's results depending on type, source, size, language
 - Non modal status window to display log of operations
 - Display search engines icons (Gtk::IconSource::set_filename() and Gtk::Style::render_icon())
-- Only show documents that have the selected label
+- Only show documents that have the selected label, merge LabelQueryThread into IndexBrowser
 - Replace Combobox objects with ComboboxText's (glademm support required)
 - Replace glademm with libglademm ?
 - Show extract instead of URL in index list
@@ -99,4 +101,5 @@
 - Prefer ustring to string whenever possible
 - Closing when threads are running gives the impression Pinot has crashed; how do we tell the user
   we are waiting for something to finish ?
+- Try sizing the window optimally on the first startup
 

Modified: trunk/UI/GTK2/config.h
===================================================================
--- trunk/UI/GTK2/config.h	2006-01-31 03:19:10 UTC (rev 87)
+++ trunk/UI/GTK2/config.h	2006-01-31 03:20:50 UTC (rev 88)
@@ -76,16 +76,16 @@
 #define PACKAGE_NAME "Pinot"
 
 /* Define to the full name and version of this package. */
-#define PACKAGE_STRING "Pinot v0.40"
+#define PACKAGE_STRING "Pinot v0.42"
 
 /* Define to the one symbol short name of this package. */
-#define PACKAGE_TARNAME "pinot-0.40.tar.gz"
+#define PACKAGE_TARNAME "pinot-0.42.tar.gz"
 
 /* Define to the version of this package. */
-#define PACKAGE_VERSION "0.40"
+#define PACKAGE_VERSION "0.42"
 
 /* Define to 1 if you have the ANSI C header files. */
 #define STDC_HEADERS 1
 
 /* Version number of package */
-#define VERSION "0.40"
+#define VERSION "0.42"

Modified: trunk/pinot.spec
===================================================================
--- trunk/pinot.spec	2006-01-31 03:19:10 UTC (rev 87)
+++ trunk/pinot.spec	2006-01-31 03:20:50 UTC (rev 88)
@@ -3,7 +3,7 @@
 
 Summary: Metasearch tool
 Name: pinot
-Version: 0.40
+Version: 0.42
 Release: 1
 License: GPL
 Group: Applications/Internet 
@@ -22,7 +22,7 @@
 %endif
 
 %description
-Pinot is a metasearch tool for the Free Desktop.  It enables one to query
+Pinot is a metasearch tool for the Free Desktop. It enables one to query
 sources, display as well as analyze and locally index the returned results.
 It may also be used as a lightweight personal space search tool.
 
@@ -63,7 +63,7 @@
 # Desktop file
 cat >%{name}.desktop << EOF
 [Desktop Entry]
-Name=Pinot Metasearch tool
+Name=Pinot Metasearch Tool
 Comment=Search the Web and your documents
 Exec=%{_bindir}/pinot
 StartupNotify=true
@@ -102,7 +102,6 @@
 %config(noreplace) %{_datadir}/pinot/engines/BitTorrent.src
 %config(noreplace) %{_datadir}/pinot/engines/Clusty.src
 %config(noreplace) %{_datadir}/pinot/engines/Freshmeat.src
-%config(noreplace) %{_datadir}/pinot/engines/Koders.src
 %config(noreplace) %{_datadir}/pinot/engines/Google.src
 %config(noreplace) %{_datadir}/pinot/engines/Lycos.src
 %config(noreplace) %{_datadir}/pinot/engines/MSN.src
@@ -112,7 +111,10 @@
 %config(noreplace) %{_datadir}/pinot/engines/Yahoo.src
 %config(noreplace) %{_datadir}/pinot/engines/YahooAPI.src
 %config(noreplace) %{_datadir}/pinot/engines/Wikipedia.src
+%config(noreplace) %{_datadir}/pinot/engines/KodersDescription.xml
+%config(noreplace) %{_datadir}/pinot/engines/MozDexDescription.xml
 %{_datadir}/locale/fr/LC_MESSAGES/pinot.mo
+%{_datadir}/locale/es/LC_MESSAGES/pinot.mo
 %{_datadir}/icons/hicolor/48x48/apps/pinot.png
 %{_datadir}/applications/Amra-%{name}.desktop
 
@@ -124,6 +126,6 @@
 
 %files omega
 %defattr(-, root, root, -)
-%config(noreplace) %{_datadir}/pinot/engines/Omega.src
+%config(noreplace) %{_datadir}/pinot/engines/OmegaDescription.xml
 
 %changelog

Modified: trunk/po/en_GB.po
===================================================================
--- trunk/po/en_GB.po	2006-01-31 03:19:10 UTC (rev 87)
+++ trunk/po/en_GB.po	2006-01-31 03:20:50 UTC (rev 88)
@@ -6,7 +6,7 @@
 #, fuzzy
 msgid ""
 msgstr ""
-"Project-Id-Version: pinot 0.40\n"
+"Project-Id-Version: pinot 0.42\n"
 "Report-Msgid-Bugs-To: \n"
 "POT-Creation-Date: 2005-12-08 19:20+0800\n"
 "PO-Revision-Date: 2006-01-20 19:32+0800\n"

Modified: trunk/po/es_ES.po
===================================================================
--- trunk/po/es_ES.po	2006-01-31 03:19:10 UTC (rev 87)
+++ trunk/po/es_ES.po	2006-01-31 03:20:50 UTC (rev 88)
@@ -6,7 +6,7 @@
 #, fuzzy
 msgid ""
 msgstr ""
-"Project-Id-Version: pinot 0.40\n"
+"Project-Id-Version: pinot 0.42\n"
 "Report-Msgid-Bugs-To: \n"
 "POT-Creation-Date: 2006-01-26 10:20+0800\n"
 "PO-Revision-Date: 2006-01-30 16:44+0800\n"

Modified: trunk/po/fr_FR.po
===================================================================
--- trunk/po/fr_FR.po	2006-01-31 03:19:10 UTC (rev 87)
+++ trunk/po/fr_FR.po	2006-01-31 03:20:50 UTC (rev 88)
@@ -6,7 +6,7 @@
 #, fuzzy
 msgid ""
 msgstr ""
-"Project-Id-Version: pinot 0.40\n"
+"Project-Id-Version: pinot 0.42\n"
 "Report-Msgid-Bugs-To: \n"
 "POT-Creation-Date: 2005-12-08 19:20+0800\n"
 "PO-Revision-Date: 2006-01-20 19:44+0800\n"



From fabricecolin at berlios.de  Tue Jan 31 04:31:40 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 31 Jan 2006 04:31:40 +0100
Subject: [Pinot-svn] r89 - trunk
Message-ID: <200601310331.k0V3Veic014184@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-31 04:31:36 +0100 (Tue, 31 Jan 2006)
New Revision: 89

Modified:
   trunk/Makefile
Log:
Missing directory.


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2006-01-31 03:20:50 UTC (rev 88)
+++ trunk/Makefile	2006-01-31 03:31:36 UTC (rev 89)
@@ -52,6 +52,7 @@
 	install -m 644 textcat_conf.txt $(PREFIX)/usr/share/pinot/
 	@mkdir -p $(PREFIX)/usr/share/locale/fr/LC_MESSAGES/
 	install -m 644 mo/fr_FR.mo $(PREFIX)/usr/share/locale/fr/LC_MESSAGES/pinot.mo
+	@mkdir -p $(PREFIX)/usr/share/locale/es/LC_MESSAGES/
 	install -m 644 mo/es_ES.mo $(PREFIX)/usr/share/locale/es/LC_MESSAGES/pinot.mo
 	@mkdir -p $(PREFIX)/usr/share/icons/hicolor/48x48/apps/
 	install -m 644 UI/GTK2/pinot.png $(PREFIX)/usr/share/icons/hicolor/48x48/apps/



From fabricecolin at berlios.de  Tue Jan 31 05:06:45 2006
From: fabricecolin at berlios.de (fabricecolin at BerliOS)
Date: Tue, 31 Jan 2006 05:06:45 +0100
Subject: [Pinot-svn] r90 - tags
Message-ID: <200601310406.k0V46jlP029576@sheep.berlios.de>

Author: fabricecolin
Date: 2006-01-31 05:06:30 +0100 (Tue, 31 Jan 2006)
New Revision: 90

Added:
   tags/version_0_4_2/
Log:
Version 0.4.2.


Copied: tags/version_0_4_2 (from rev 89, trunk)



