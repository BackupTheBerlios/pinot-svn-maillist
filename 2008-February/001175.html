<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Pinot-svn] r1181 - in trunk: . IndexSearch IndexSearch/Xapian
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/pinot-svn/2008-February/index.html" >
   <LINK REL="made" HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r1181%20-%20in%20trunk%3A%20.%20IndexSearch%20IndexSearch/Xapian&In-Reply-To=%3C200802201440.m1KEevAO014865%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001173.html">
   <LINK REL="Next"  HREF="001176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Pinot-svn] r1181 - in trunk: . IndexSearch IndexSearch/Xapian</H1>
    <B>fabricecolin at BerliOS</B> 
    <A HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r1181%20-%20in%20trunk%3A%20.%20IndexSearch%20IndexSearch/Xapian&In-Reply-To=%3C200802201440.m1KEevAO014865%40sheep.berlios.de%3E"
       TITLE="[Pinot-svn] r1181 - in trunk: . IndexSearch IndexSearch/Xapian">fabricecolin at mail.berlios.de
       </A><BR>
    <I>Wed Feb 20 15:40:57 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001173.html">[Pinot-svn] r1180 - trunk/UI/GTK2/src
</A></li>
        <LI>Next message: <A HREF="001176.html">[Pinot-svn] r1182 - trunk/UI/GTK2/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1175">[ date ]</a>
              <a href="thread.html#1175">[ thread ]</a>
              <a href="subject.html#1175">[ subject ]</a>
              <a href="author.html#1175">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fabricecolin
Date: 2008-02-20 15:40:56 +0100 (Wed, 20 Feb 2008)
New Revision: 1181

Modified:
   trunk/IndexSearch/Xapian/XapianEngine.cpp
   trunk/IndexSearch/pinot-search.1
   trunk/IndexSearch/pinot-search.cpp
   trunk/README
Log:
In XapianEngine, if the query matched a Z-prefixed term (ie a stem, because
stemming is enabled), find terms in each document that are potential unstems
and use those as seed terms to generate the abstract. This may throw false
positives as the matched stem isn't compared against those termss stemmed form.
The pinot-search program now has a &quot;--stemming/-s&quot; parameter to specify a
stemming language, in English not in the locale !
The README emphasizes that stemming is applied only if there is no exact match,
and that the directory filter is recursive.


Modified: trunk/IndexSearch/Xapian/XapianEngine.cpp
===================================================================
--- trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-02-18 11:38:52 UTC (rev 1180)
+++ trunk/IndexSearch/Xapian/XapianEngine.cpp	2008-02-20 14:40:56 UTC (rev 1181)
@@ -463,6 +463,33 @@
 						cout &lt;&lt; &quot;XapianEngine::queryDatabase: matched term &quot; &lt;&lt; *termIter &lt;&lt; endl;
 #endif
 					}
+					else if (firstChar == 'Z')
+					{
+						string stemmed((*termIter).substr(1));
+						string::size_type stemmedLen = stemmed.length();
+
+						// Which of this document's terms stem to this ?
+						Xapian::TermIterator docTermIter = pIndex-&gt;termlist_begin(docId);
+						if (docTermIter != pIndex-&gt;termlist_end(docId))
+						{
+							for (docTermIter.skip_to(stemmed);
+								docTermIter != pIndex-&gt;termlist_end(docId); ++docTermIter)
+							{
+								// Is this a potential unstem ?
+								if (strncasecmp((*docTermIter).c_str(), stemmed.c_str(), stemmedLen) != 0)
+								{
+									// No, no point looking at the next terms
+									break;
+								}
+#ifdef DEBUG
+								cout &lt;&lt; &quot;XapianEngine::queryDatabase: matched unstem &quot; &lt;&lt; *docTermIter &lt;&lt; endl;
+#endif
+
+								// FIXME: check this term stems to stemmed !
+								seedTerms.push_back(*docTermIter); 
+							}
+						}
+					}
 				}
 
 				DocumentInfo thisResult;

Modified: trunk/IndexSearch/pinot-search.1
===================================================================
--- trunk/IndexSearch/pinot-search.1	2008-02-18 11:38:52 UTC (rev 1180)
+++ trunk/IndexSearch/pinot-search.1	2008-02-20 14:40:56 UTC (rev 1181)
@@ -1,11 +1,12 @@
 .\&quot; DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-SEARCH &quot;1&quot; &quot;January 2008&quot; &quot;pinot-search - pinot 0.82&quot; &quot;User Commands&quot;
+.TH PINOT-SEARCH &quot;1&quot; &quot;February 2008&quot; &quot;pinot-search - pinot 0.82&quot; &quot;User Commands&quot;
 .SH NAME
 pinot-search \- Query search engines from the command-line
 .SH SYNOPSIS
 .B pinot-search
 [\fIOPTIONS\fR] \fISEARCHENGINETYPE SEARCHENGINENAME|SEARCHENGINEOPTION QUERYINPUT\fR
 .SH DESCRIPTION
+ModuleFactory::loadModules: type xapian is supported by libxapianbackend.so
 pinot\-search \- Query search engines from the command\-line
 .SH OPTIONS
 .TP
@@ -24,6 +25,9 @@
 \fB\-t\fR, \fB\-\-proxytype\fR
 proxy type (default HTTP, SOCKS4, SOCKS5)
 .TP
+\fB\-s\fR, \fB\-\-stemming\fR
+stemming language (in English)
+.TP
 \fB\-c\fR, \fB\-\-tocsv\fR
 file to export results in CSV format to
 .TP
@@ -49,7 +53,7 @@
 .PP
 pinot\-search xapian ~/.pinot/index &quot;label:Clowns&quot;
 .PP
-pinot\-search xapian somehostname:12345 &quot;clowns&quot;
+pinot\-search \fB\-\-stemming\fR english xapian somehostname:12345 &quot;clowning&quot;
 .SH &quot;REPORTING BUGS&quot;
 Report bugs to <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabricecolin at users.berlios.de</A>
 .PP

Modified: trunk/IndexSearch/pinot-search.cpp
===================================================================
--- trunk/IndexSearch/pinot-search.cpp	2008-02-18 11:38:52 UTC (rev 1180)
+++ trunk/IndexSearch/pinot-search.cpp	2008-02-20 14:40:56 UTC (rev 1181)
@@ -40,6 +40,7 @@
 	{&quot;proxyaddress&quot;, 1, 0, 'a'},
 	{&quot;proxyport&quot;, 1, 0, 'p'},
 	{&quot;proxytype&quot;, 1, 0, 't'},
+	{&quot;stemming&quot;, 1, 0, 's'},
 	{&quot;tocsv&quot;, 1, 0, 'c'},
 	{&quot;toxml&quot;, 1, 0, 'x'},
 	{&quot;version&quot;, 0, 0, 'v'},
@@ -92,6 +93,7 @@
 		&lt;&lt; &quot;  -a, --proxyaddress        proxy address\n&quot;
 		&lt;&lt; &quot;  -p, --proxyport           proxy port\n&quot;
 		&lt;&lt; &quot;  -t, --proxytype           proxy type (default HTTP, SOCKS4, SOCKS5)\n&quot;
+		&lt;&lt; &quot;  -s, --stemming            stemming language (in English)\n&quot;
 		&lt;&lt; &quot;  -c, --tocsv               file to export results in CSV format to\n&quot;
 		&lt;&lt; &quot;  -x, --toxml               file to export results in XML format to\n&quot;
 		&lt;&lt; &quot;  -v, --version             output version information and exit\n&quot;
@@ -109,20 +111,20 @@
 		&lt;&lt; &quot;pinot-search opensearch &quot; &lt;&lt; PREFIX &lt;&lt; &quot;/share/pinot/engines/KrustyDescription.xml \&quot;clowns\&quot;\n\n&quot;
 		&lt;&lt; &quot;pinot-search --max 20 sherlock &quot; &lt;&lt; PREFIX &lt;&lt; &quot;/share/pinot/engines/Bozo.src \&quot;clowns\&quot;\n\n&quot;
 		&lt;&lt; &quot;pinot-search xapian ~/.pinot/index \&quot;label:Clowns\&quot;\n\n&quot;
-		&lt;&lt; &quot;pinot-search xapian somehostname:12345 \&quot;clowns\&quot;\n\n&quot;
+		&lt;&lt; &quot;pinot-search --stemming english xapian somehostname:12345 \&quot;clowning\&quot;\n\n&quot;
 		&lt;&lt; &quot;Report bugs to &quot; &lt;&lt; PACKAGE_BUGREPORT &lt;&lt; endl;
 }
 
 int main(int argc, char **argv)
 {
 	QueryProperties::QueryType queryType = QueryProperties::XAPIAN_QP;
-	string engineType, option, csvExport, xmlExport, proxyAddress, proxyPort, proxyType;
+	string engineType, option, csvExport, xmlExport, proxyAddress, proxyPort, proxyType, stemLanguage;
 	unsigned int maxResultsCount = 10; 
 	int longOptionIndex = 0;
 	bool printResults = true;
 
 	// Look at the options
-	int optionChar = getopt_long(argc, argv, &quot;c:hm:a:p:qt:uvx:&quot;, g_longOptions, &amp;longOptionIndex);
+	int optionChar = getopt_long(argc, argv, &quot;c:hm:a:p:qs:t:uvx:&quot;, g_longOptions, &amp;longOptionIndex);
 	while (optionChar != -1)
 	{
 		switch (optionChar)
@@ -158,6 +160,12 @@
 			case 'q':
 				queryType = QueryProperties::XESAM_QL;
 				break;
+			case 's':
+				if (optarg != NULL)
+				{
+					stemLanguage = optarg;
+				}
+				break;
 			case 't':
 				if (optarg != NULL)
 				{
@@ -185,7 +193,7 @@
 		}
 
 		// Next option
-		optionChar = getopt_long(argc, argv, &quot;c:hm:a:p:qt:uvx:&quot;, g_longOptions, &amp;longOptionIndex);
+		optionChar = getopt_long(argc, argv, &quot;c:hm:a:p:qs:t:uvx:&quot;, g_longOptions, &amp;longOptionIndex);
 	}
 
 	if (argc == 1)
@@ -277,8 +285,9 @@
 
 		queryProps.setFreeQuery(fileContents);
 	}
+	queryProps.setStemmingLanguage(stemLanguage);
+	queryProps.setMaximumResultsCount(maxResultsCount);
 
-	queryProps.setMaximumResultsCount(maxResultsCount);
 	pEngine-&gt;setDefaultOperator(SearchEngineInterface::DEFAULT_OP_AND);
 	if (pEngine-&gt;runQuery(queryProps) == true)
 	{

Modified: trunk/README
===================================================================
--- trunk/README	2008-02-18 11:38:52 UTC (rev 1180)
+++ trunk/README	2008-02-20 14:40:56 UTC (rev 1181)
@@ -190,12 +190,13 @@
       &quot;class&quot; for MIME type classification, eg &quot;class:text&quot;
       &quot;label&quot; for label, eg &quot;label:Important&quot;
 
+  The directory filter is recursive, ie it applies to sub-directories.
   Allowed language codes are &quot;da&quot;, &quot;nl&quot;, &quot;en&quot;, &quot;fi&quot;, &quot;fr&quot;, &quot;de&quot;, &quot;it&quot;, &quot;nn&quot;, &quot;pt&quot;,
   &quot;ru&quot;, &quot;es&quot; and &quot;sv&quot;.
 
   Stemming is available to queries for which a stemming language is defined.
-  If no results are found for such a query, the terms are stemmed and the query
-  is run again.
+  If such a query doesn't return any exact match, the query terms are stemmed
+  and the query is run again.
 
   The values of &quot;file&quot;, &quot;url&quot;, &quot;dir&quot; and &quot;label&quot; may be double-quoted. It's also
   worth pointing out that the query &quot;dir:/X/Y&quot; will return files and directories


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001173.html">[Pinot-svn] r1180 - trunk/UI/GTK2/src
</A></li>
	<LI>Next message: <A HREF="001176.html">[Pinot-svn] r1182 - trunk/UI/GTK2/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1175">[ date ]</a>
              <a href="thread.html#1175">[ thread ]</a>
              <a href="subject.html#1175">[ subject ]</a>
              <a href="author.html#1175">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/pinot-svn">More information about the Pinot-svn
mailing list</a><br>
</body></html>
