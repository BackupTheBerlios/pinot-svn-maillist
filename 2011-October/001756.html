<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Pinot-svn] r1767 - in trunk: . Monitor
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/pinot-svn/2011-October/index.html" >
   <LINK REL="made" HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r1767%20-%20in%20trunk%3A%20.%20Monitor&In-Reply-To=%3C20111002054233.D005B4811DB%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001755.html">
   <LINK REL="Next"  HREF="001757.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Pinot-svn] r1767 - in trunk: . Monitor</H1>
    <B>fabricecolin at mail.berlios.de</B> 
    <A HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r1767%20-%20in%20trunk%3A%20.%20Monitor&In-Reply-To=%3C20111002054233.D005B4811DB%40sheep.berlios.de%3E"
       TITLE="[Pinot-svn] r1767 - in trunk: . Monitor">fabricecolin at mail.berlios.de
       </A><BR>
    <I>Sun Oct  2 07:42:33 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="001755.html">[Pinot-svn] r1766 - trunk/Utils
</A></li>
        <LI>Next message: <A HREF="001757.html">[Pinot-svn] r1768 - trunk/UI/GTK2/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1756">[ date ]</a>
              <a href="thread.html#1756">[ thread ]</a>
              <a href="subject.html#1756">[ subject ]</a>
              <a href="author.html#1756">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fabricecolin
Date: 2011-10-02 07:42:33 +0200 (Sun, 02 Oct 2011)
New Revision: 1767

Modified:
   trunk/Makefile.am
   trunk/Monitor/Makefile.am
   trunk/ltmain.sh
Log:
Regenerated ltmain.sh with libtool 2.4.


Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2011-10-02 05:10:45 UTC (rev 1766)
+++ trunk/Makefile.am	2011-10-02 05:42:33 UTC (rev 1767)
@@ -1,7 +1,6 @@
 
 SUBDIRS = po Utils Tokenize SQL Collect IndexSearch IndexSearch/Xapian Monitor Core UI/GTK2/src
 
-# TODO: Fix that when cleaning up for distcheck! - crazy -
 EXTRA_DIST = AUTHORS ChangeLog ChangeLog-dijon FAQ NEWS README TODO \
 	Tokenize/filters/external-filters.xml globalconfig.xml \
 	textcat*conf.txt pinot*.desktop pinot.spec \

Modified: trunk/Monitor/Makefile.am
===================================================================
--- trunk/Monitor/Makefile.am	2011-10-02 05:10:45 UTC (rev 1766)
+++ trunk/Monitor/Makefile.am	2011-10-02 05:42:33 UTC (rev 1767)
@@ -28,7 +28,7 @@
 	-I$(top_srcdir)/Index \
 	-I$(top_srcdir)/Search \
 	@HTTP_CFLAGS@ @XML_CFLAGS@ @INDEX_CFLAGS@ \
-	@SOAP_CFLAGS@ @GMIME_CFLAGS@ @SIGCPP_CFLAGS@
+	@GMIME_CFLAGS@ @SIGCPP_CFLAGS@
 
 if HAVE_LINUX_INOTIFY
 libMonitor_la_CXXFLAGS += -DHAVE_LINUX_INOTIFY

Modified: trunk/ltmain.sh
===================================================================
--- trunk/ltmain.sh	2011-10-02 05:10:45 UTC (rev 1766)
+++ trunk/ltmain.sh	2011-10-02 05:42:33 UTC (rev 1767)
@@ -1,6 +1,5 @@
-# Generated from ltmain.m4sh.
 
-# libtool (GNU libtool) 2.2.10
+# libtool (GNU libtool) 2.4
 # Written by Gordon Matzigkeit &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">gord at gnu.ai.mit.edu</A>&gt;, 1996
 
 # Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2003, 2004, 2005, 2006,
@@ -70,17 +69,19 @@
 #         compiler:		$LTCC
 #         compiler flags:		$LTCFLAGS
 #         linker:		$LD (gnu? $with_gnu_ld)
-#         $progname:	(GNU libtool) 2.2.10
+#         $progname:	(GNU libtool) 2.4
 #         automake:	$automake_version
 #         autoconf:	$autoconf_version
 #
 # Report bugs to &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">bug-libtool at gnu.org</A>&gt;.
+# GNU libtool home page: &lt;<A HREF="http://www.gnu.org/software/libtool/">http://www.gnu.org/software/libtool/</A>&gt;.
+# General help using GNU software: &lt;<A HREF="http://www.gnu.org/gethelp/">http://www.gnu.org/gethelp/</A>&gt;.
 
 PROGRAM=libtool
 PACKAGE=libtool
-VERSION=2.2.10
+VERSION=2.4
 TIMESTAMP=&quot;&quot;
-package_revision=1.3175
+package_revision=1.3293
 
 # Be Bourne compatible
 if test -n &quot;${ZSH_VERSION+set}&quot; &amp;&amp; (emulate sh) &gt;/dev/null 2&gt;&amp;1; then
@@ -163,6 +164,27 @@
 dirname=&quot;s,/[^/]*$,,&quot;
 basename=&quot;s,^.*/,,&quot;
 
+# func_dirname file append nondir_replacement
+# Compute the dirname of FILE.  If nonempty, add APPEND to the result,
+# otherwise set result to NONDIR_REPLACEMENT.
+func_dirname ()
+{
+    func_dirname_result=`$ECHO &quot;${1}&quot; | $SED &quot;$dirname&quot;`
+    if test &quot;X$func_dirname_result&quot; = &quot;X${1}&quot;; then
+      func_dirname_result=&quot;${3}&quot;
+    else
+      func_dirname_result=&quot;$func_dirname_result${2}&quot;
+    fi
+} # func_dirname may be replaced by extended shell implementation
+
+
+# func_basename file
+func_basename ()
+{
+    func_basename_result=`$ECHO &quot;${1}&quot; | $SED &quot;$basename&quot;`
+} # func_basename may be replaced by extended shell implementation
+
+
 # func_dirname_and_basename file append nondir_replacement
 # perform func_basename and func_dirname in a single function
 # call:
@@ -177,18 +199,32 @@
 # those functions but instead duplicate the functionality here.
 func_dirname_and_basename ()
 {
-  # Extract subdirectory from the argument.
-  func_dirname_result=`$ECHO &quot;${1}&quot; | $SED -e &quot;$dirname&quot;`
-  if test &quot;X$func_dirname_result&quot; = &quot;X${1}&quot;; then
-    func_dirname_result=&quot;${3}&quot;
-  else
-    func_dirname_result=&quot;$func_dirname_result${2}&quot;
-  fi
-  func_basename_result=`$ECHO &quot;${1}&quot; | $SED -e &quot;$basename&quot;`
-}
+    # Extract subdirectory from the argument.
+    func_dirname_result=`$ECHO &quot;${1}&quot; | $SED -e &quot;$dirname&quot;`
+    if test &quot;X$func_dirname_result&quot; = &quot;X${1}&quot;; then
+      func_dirname_result=&quot;${3}&quot;
+    else
+      func_dirname_result=&quot;$func_dirname_result${2}&quot;
+    fi
+    func_basename_result=`$ECHO &quot;${1}&quot; | $SED -e &quot;$basename&quot;`
+} # func_dirname_and_basename may be replaced by extended shell implementation
 
-# Generated shell functions inserted here.
 
+# func_stripname prefix suffix name
+# strip PREFIX and SUFFIX off of NAME.
+# PREFIX and SUFFIX must not contain globbing or regex special
+# characters, hashes, percent signs, but SUFFIX may contain a leading
+# dot (in which case that matches only a dot).
+# func_strip_suffix prefix name
+func_stripname ()
+{
+    case ${2} in
+      .*) func_stripname_result=`$ECHO &quot;${3}&quot; | $SED &quot;s%^${1}%%; s%\\\\${2}\$%%&quot;`;;
+      *)  func_stripname_result=`$ECHO &quot;${3}&quot; | $SED &quot;s%^${1}%%; s%${2}\$%%&quot;`;;
+    esac
+} # func_stripname may be replaced by extended shell implementation
+
+
 # These SED scripts presuppose an absolute path with a trailing slash.
 pathcar='s,^/\([^/]*\).*$,\1,'
 pathcdr='s,^/[^/]*,,'
@@ -370,6 +406,15 @@
 # Same as above, but do not quote variable references.
 double_quote_subst='s/\([&quot;`\\]\)/\\\1/g'
 
+# Sed substitution that turns a string into a regex matching for the
+# string literally.
+sed_make_literal_regex='s,[].[^$\\*\/],\\&amp;,g'
+
+# Sed substitution that converts a w32 file name or path
+# which contains forward slashes, into one that contains
+# (escaped) backslashes.  A very naive implementation.
+lt_sed_naive_backslashify='s|\\\\*|\\|g;s|/|\\|g;s|\\|\\\\|g'
+
 # Re-`\' parameter expansions in output of double_quote_subst that were
 # `\'-ed in input to the same.  If an odd number of `\' preceded a '$'
 # in input to double_quote_subst, that '$' was protected from expansion.
@@ -398,7 +443,7 @@
 # name if it has been set yet.
 func_echo ()
 {
-    $ECHO &quot;$progname${mode+: }$mode: $*&quot;
+    $ECHO &quot;$progname: ${opt_mode+$opt_mode: }$*&quot;
 }
 
 # func_verbose arg...
@@ -424,14 +469,14 @@
 # Echo program name prefixed message to standard error.
 func_error ()
 {
-    $ECHO &quot;$progname${mode+: }$mode: &quot;${1+&quot;$@&quot;} 1&gt;&amp;2
+    $ECHO &quot;$progname: ${opt_mode+$opt_mode: }&quot;${1+&quot;$@&quot;} 1&gt;&amp;2
 }
 
 # func_warning arg...
 # Echo program name prefixed warning message to standard error.
 func_warning ()
 {
-    $opt_warning &amp;&amp; $ECHO &quot;$progname${mode+: }$mode: warning: &quot;${1+&quot;$@&quot;} 1&gt;&amp;2
+    $opt_warning &amp;&amp; $ECHO &quot;$progname: ${opt_mode+$opt_mode: }warning: &quot;${1+&quot;$@&quot;} 1&gt;&amp;2
 
     # bash bug again:
     :
@@ -650,11 +695,30 @@
     fi
 }
 
+# func_tr_sh
+# Turn $1 into a string suitable for a shell variable name.
+# Result is stored in $func_tr_sh_result.  All characters
+# not in the set a-zA-Z0-9_ are replaced with '_'. Further,
+# if $1 begins with a digit, a '_' is prepended as well.
+func_tr_sh ()
+{
+  case $1 in
+  [0-9]* | *[!a-zA-Z0-9_]*)
+    func_tr_sh_result=`$ECHO &quot;$1&quot; | $SED 's/^\([0-9]\)/_\1/; s/[^a-zA-Z0-9_]/_/g'`
+    ;;
+  * )
+    func_tr_sh_result=$1
+    ;;
+  esac
+}
 
+
 # func_version
 # Echo version message to standard output and exit.
 func_version ()
 {
+    $opt_debug
+
     $SED -n '/(C)/!b go
 	:more
 	/\./!{
@@ -676,6 +740,8 @@
 # Echo short help message to standard output and exit.
 func_usage ()
 {
+    $opt_debug
+
     $SED -n '/^# Usage:/,/^#  *.*--help/ {
         s/^# //
 	s/^# *$//
@@ -692,7 +758,10 @@
 # unless 'noexit' is passed as argument.
 func_help ()
 {
+    $opt_debug
+
     $SED -n '/^# Usage:/,/# Report bugs to/ {
+	:print
         s/^# //
 	s/^# *$//
 	s*\$progname*'$progname'*
@@ -705,7 +774,11 @@
 	s/\$automake_version/'&quot;`(automake --version) 2&gt;/dev/null |$SED 1q`&quot;'/
 	s/\$autoconf_version/'&quot;`(autoconf --version) 2&gt;/dev/null |$SED 1q`&quot;'/
 	p
-     }' &lt; &quot;$progpath&quot;
+	d
+     }
+     /^# .* home page:/b print
+     /^# General help using/b print
+     ' &lt; &quot;$progpath&quot;
     ret=$?
     if test -z &quot;$1&quot;; then
       exit $ret
@@ -717,40 +790,106 @@
 # exit_cmd.
 func_missing_arg ()
 {
+    $opt_debug
+
     func_error &quot;missing argument for $1.&quot;
     exit_cmd=exit
 }
 
+
+# func_split_short_opt shortopt
+# Set func_split_short_opt_name and func_split_short_opt_arg shell
+# variables after splitting SHORTOPT after the 2nd character.
+func_split_short_opt ()
+{
+    my_sed_short_opt='1s/^\(..\).*$/\1/;q'
+    my_sed_short_rest='1s/^..\(.*\)$/\1/;q'
+
+    func_split_short_opt_name=`$ECHO &quot;$1&quot; | $SED &quot;$my_sed_short_opt&quot;`
+    func_split_short_opt_arg=`$ECHO &quot;$1&quot; | $SED &quot;$my_sed_short_rest&quot;`
+} # func_split_short_opt may be replaced by extended shell implementation
+
+
+# func_split_long_opt longopt
+# Set func_split_long_opt_name and func_split_long_opt_arg shell
+# variables after splitting LONGOPT at the `=' sign.
+func_split_long_opt ()
+{
+    my_sed_long_opt='1s/^\(--[^=]*\)=.*/\1/;q'
+    my_sed_long_arg='1s/^--[^=]*=//'
+
+    func_split_long_opt_name=`$ECHO &quot;$1&quot; | $SED &quot;$my_sed_long_opt&quot;`
+    func_split_long_opt_arg=`$ECHO &quot;$1&quot; | $SED &quot;$my_sed_long_arg&quot;`
+} # func_split_long_opt may be replaced by extended shell implementation
+
 exit_cmd=:
 
 
 
 
 
-
 magic=&quot;%%%MAGIC variable%%%&quot;
 magic_exe=&quot;%%%MAGIC EXE variable%%%&quot;
 
 # Global variables.
-# $mode is unset
 nonopt=
-execute_dlfiles=
 preserve_args=
 lo2o=&quot;s/\\.lo\$/.${objext}/&quot;
 o2lo=&quot;s/\\.${objext}\$/.lo/&quot;
 extracted_archives=
 extracted_serial=0
 
-opt_dry_run=false
-opt_duplicate_deps=false
-opt_silent=false
-opt_debug=:
-
 # If this variable is set in any of the actions, the command in it
 # will be execed at the end.  This prevents here-documents from being
 # left over by shells.
 exec_cmd=
 
+# func_append var value
+# Append VALUE to the end of shell variable VAR.
+func_append ()
+{
+    eval &quot;${1}=\$${1}\${2}&quot;
+} # func_append may be replaced by extended shell implementation
+
+# func_append_quoted var value
+# Quote VALUE and append to the end of shell variable VAR, separated
+# by a space.
+func_append_quoted ()
+{
+    func_quote_for_eval &quot;${2}&quot;
+    eval &quot;${1}=\$${1}\\ \$func_quote_for_eval_result&quot;
+} # func_append_quoted may be replaced by extended shell implementation
+
+
+# func_arith arithmetic-term...
+func_arith ()
+{
+    func_arith_result=`expr &quot;${@}&quot;`
+} # func_arith may be replaced by extended shell implementation
+
+
+# func_len string
+# STRING may not start with a hyphen.
+func_len ()
+{
+    func_len_result=`expr &quot;${1}&quot; : &quot;.*&quot; 2&gt;/dev/null || echo $max_cmd_len`
+} # func_len may be replaced by extended shell implementation
+
+
+# func_lo2o object
+func_lo2o ()
+{
+    func_lo2o_result=`$ECHO &quot;${1}&quot; | $SED &quot;$lo2o&quot;`
+} # func_lo2o may be replaced by extended shell implementation
+
+
+# func_xform libobj-or-source
+func_xform ()
+{
+    func_xform_result=`$ECHO &quot;${1}&quot; | $SED 's/\.[^.]*$/.lo/'`
+} # func_xform may be replaced by extended shell implementation
+
+
 # func_fatal_configuration arg...
 # Echo program name prefixed message to standard error, followed by
 # a configuration failure hint, and exit.
@@ -840,213 +979,250 @@
   esac
 }
 
-# Parse options once, thoroughly.  This comes as soon as possible in
-# the script to make things like `libtool --version' happen quickly.
+# func_check_version_match
+# Ensure that we are using m4 macros, and libtool script from the same
+# release of libtool.
+func_check_version_match ()
 {
+  if test &quot;$package_revision&quot; != &quot;$macro_revision&quot;; then
+    if test &quot;$VERSION&quot; != &quot;$macro_version&quot;; then
+      if test -z &quot;$macro_version&quot;; then
+        cat &gt;&amp;2 &lt;&lt;_LT_EOF
+$progname: Version mismatch error.  This is $PACKAGE $VERSION, but the
+$progname: definition of this LT_INIT comes from an older release.
+$progname: You should recreate aclocal.m4 with macros from $PACKAGE $VERSION
+$progname: and run autoconf again.
+_LT_EOF
+      else
+        cat &gt;&amp;2 &lt;&lt;_LT_EOF
+$progname: Version mismatch error.  This is $PACKAGE $VERSION, but the
+$progname: definition of this LT_INIT comes from $PACKAGE $macro_version.
+$progname: You should recreate aclocal.m4 with macros from $PACKAGE $VERSION
+$progname: and run autoconf again.
+_LT_EOF
+      fi
+    else
+      cat &gt;&amp;2 &lt;&lt;_LT_EOF
+$progname: Version mismatch error.  This is $PACKAGE $VERSION, revision $package_revision,
+$progname: but the definition of this LT_INIT comes from revision $macro_revision.
+$progname: You should recreate aclocal.m4 with macros from revision $package_revision
+$progname: of $PACKAGE $VERSION and run autoconf again.
+_LT_EOF
+    fi
 
-  # Shorthand for --mode=foo, only valid as the first argument
-  case $1 in
-  clean|clea|cle|cl)
-    shift; set dummy --mode clean ${1+&quot;$@&quot;}; shift
-    ;;
-  compile|compil|compi|comp|com|co|c)
-    shift; set dummy --mode compile ${1+&quot;$@&quot;}; shift
-    ;;
-  execute|execut|execu|exec|exe|ex|e)
-    shift; set dummy --mode execute ${1+&quot;$@&quot;}; shift
-    ;;
-  finish|finis|fini|fin|fi|f)
-    shift; set dummy --mode finish ${1+&quot;$@&quot;}; shift
-    ;;
-  install|instal|insta|inst|ins|in|i)
-    shift; set dummy --mode install ${1+&quot;$@&quot;}; shift
-    ;;
-  link|lin|li|l)
-    shift; set dummy --mode link ${1+&quot;$@&quot;}; shift
-    ;;
-  uninstall|uninstal|uninsta|uninst|unins|unin|uni|un|u)
-    shift; set dummy --mode uninstall ${1+&quot;$@&quot;}; shift
-    ;;
-  esac
+    exit $EXIT_MISMATCH
+  fi
+}
 
-  # Parse non-mode specific arguments:
-  while test &quot;$#&quot; -gt 0; do
+
+# Shorthand for --mode=foo, only valid as the first argument
+case $1 in
+clean|clea|cle|cl)
+  shift; set dummy --mode clean ${1+&quot;$@&quot;}; shift
+  ;;
+compile|compil|compi|comp|com|co|c)
+  shift; set dummy --mode compile ${1+&quot;$@&quot;}; shift
+  ;;
+execute|execut|execu|exec|exe|ex|e)
+  shift; set dummy --mode execute ${1+&quot;$@&quot;}; shift
+  ;;
+finish|finis|fini|fin|fi|f)
+  shift; set dummy --mode finish ${1+&quot;$@&quot;}; shift
+  ;;
+install|instal|insta|inst|ins|in|i)
+  shift; set dummy --mode install ${1+&quot;$@&quot;}; shift
+  ;;
+link|lin|li|l)
+  shift; set dummy --mode link ${1+&quot;$@&quot;}; shift
+  ;;
+uninstall|uninstal|uninsta|uninst|unins|unin|uni|un|u)
+  shift; set dummy --mode uninstall ${1+&quot;$@&quot;}; shift
+  ;;
+esac
+
+
+
+# Option defaults:
+opt_debug=:
+opt_dry_run=false
+opt_config=false
+opt_preserve_dup_deps=false
+opt_features=false
+opt_finish=false
+opt_help=false
+opt_help_all=false
+opt_silent=:
+opt_verbose=:
+opt_silent=false
+opt_verbose=false
+
+
+# Parse options once, thoroughly.  This comes as soon as possible in the
+# script to make things like `--version' happen as quickly as we can.
+{
+  # this just eases exit handling
+  while test $# -gt 0; do
     opt=&quot;$1&quot;
     shift
-
     case $opt in
-      --config)		func_config					;;
-
-      --debug)		preserve_args=&quot;$preserve_args $opt&quot;
+      --debug|-x)	opt_debug='set -x'
 			func_echo &quot;enabling shell trace mode&quot;
-			opt_debug='set -x'
 			$opt_debug
 			;;
-
-      -dlopen)		test &quot;$#&quot; -eq 0 &amp;&amp; func_missing_arg &quot;$opt&quot; &amp;&amp; break
-			execute_dlfiles=&quot;$execute_dlfiles $1&quot;
-			shift
+      --dry-run|--dryrun|-n)
+			opt_dry_run=:
 			;;
-
-      --dry-run | -n)	opt_dry_run=:					;;
-      --features)       func_features					;;
-      --finish)		mode=&quot;finish&quot;					;;
-
-      --mode)		test &quot;$#&quot; -eq 0 &amp;&amp; func_missing_arg &quot;$opt&quot; &amp;&amp; break
-			case $1 in
-			  # Valid mode arguments:
-			  clean)	;;
-			  compile)	;;
-			  execute)	;;
-			  finish)	;;
-			  install)	;;
-			  link)		;;
-			  relink)	;;
-			  uninstall)	;;
-
-			  # Catch anything else as an error
-			  *) func_error &quot;invalid argument for $opt&quot;
-			     exit_cmd=exit
-			     break
-			     ;;
-		        esac
-
-			mode=&quot;$1&quot;
+      --config)
+			opt_config=:
+func_config
+			;;
+      --dlopen|-dlopen)
+			optarg=&quot;$1&quot;
+			opt_dlopen=&quot;${opt_dlopen+$opt_dlopen
+}$optarg&quot;
 			shift
 			;;
-
       --preserve-dup-deps)
-			opt_duplicate_deps=:				;;
-
-      --quiet|--silent)	preserve_args=&quot;$preserve_args $opt&quot;
-			opt_silent=:
-			opt_verbose=false
+			opt_preserve_dup_deps=:
 			;;
+      --features)
+			opt_features=:
+func_features
+			;;
+      --finish)
+			opt_finish=:
+set dummy --mode finish ${1+&quot;$@&quot;}; shift
+			;;
+      --help)
+			opt_help=:
+			;;
+      --help-all)
+			opt_help_all=:
+opt_help=': help-all'
+			;;
+      --mode)
+			test $# = 0 &amp;&amp; func_missing_arg $opt &amp;&amp; break
+			optarg=&quot;$1&quot;
+			opt_mode=&quot;$optarg&quot;
+case $optarg in
+  # Valid mode arguments:
+  clean|compile|execute|finish|install|link|relink|uninstall) ;;
 
-      --no-quiet|--no-silent)
-			preserve_args=&quot;$preserve_args $opt&quot;
-			opt_silent=false
+  # Catch anything else as an error
+  *) func_error &quot;invalid argument for $opt&quot;
+     exit_cmd=exit
+     break
+     ;;
+esac
+			shift
 			;;
-
-      --verbose| -v)	preserve_args=&quot;$preserve_args $opt&quot;
+      --no-silent|--no-quiet)
 			opt_silent=false
-			opt_verbose=:
+func_append preserve_args &quot; $opt&quot;
 			;;
-
-      --no-verbose)	preserve_args=&quot;$preserve_args $opt&quot;
+      --no-verbose)
 			opt_verbose=false
+func_append preserve_args &quot; $opt&quot;
 			;;
-
-      --tag)		test &quot;$#&quot; -eq 0 &amp;&amp; func_missing_arg &quot;$opt&quot; &amp;&amp; break
-			preserve_args=&quot;$preserve_args $opt $1&quot;
-			func_enable_tag &quot;$1&quot;	# tagname is set here
+      --silent|--quiet)
+			opt_silent=:
+func_append preserve_args &quot; $opt&quot;
+        opt_verbose=false
+			;;
+      --verbose|-v)
+			opt_verbose=:
+func_append preserve_args &quot; $opt&quot;
+opt_silent=false
+			;;
+      --tag)
+			test $# = 0 &amp;&amp; func_missing_arg $opt &amp;&amp; break
+			optarg=&quot;$1&quot;
+			opt_tag=&quot;$optarg&quot;
+func_append preserve_args &quot; $opt $optarg&quot;
+func_enable_tag &quot;$optarg&quot;
 			shift
 			;;
 
+      -\?|-h)		func_usage				;;
+      --help)		func_help				;;
+      --version)	func_version				;;
+
       # Separate optargs to long options:
-      -dlopen=*|--mode=*|--tag=*)
-			func_opt_split &quot;$opt&quot;
-			set dummy &quot;$func_opt_split_opt&quot; &quot;$func_opt_split_arg&quot; ${1+&quot;$@&quot;}
+      --*=*)
+			func_split_long_opt &quot;$opt&quot;
+			set dummy &quot;$func_split_long_opt_name&quot; &quot;$func_split_long_opt_arg&quot; ${1+&quot;$@&quot;}
 			shift
 			;;
 
-      -\?|-h)		func_usage					;;
-      --help)		opt_help=:					;;
-      --help-all)	opt_help=': help-all'				;;
-      --version)	func_version					;;
+      # Separate non-argument short options:
+      -\?*|-h*|-n*|-v*)
+			func_split_short_opt &quot;$opt&quot;
+			set dummy &quot;$func_split_short_opt_name&quot; &quot;-$func_split_short_opt_arg&quot; ${1+&quot;$@&quot;}
+			shift
+			;;
 
-      -*)		func_fatal_help &quot;unrecognized option \`$opt'&quot;	;;
-
-      *)		nonopt=&quot;$opt&quot;
-			break
-			;;
+      --)		break					;;
+      -*)		func_fatal_help &quot;unrecognized option \`$opt'&quot; ;;
+      *)		set dummy &quot;$opt&quot; ${1+&quot;$@&quot;};	shift; break  ;;
     esac
   done
 
+  # Validate options:
 
+  # save first non-option argument
+  if test &quot;$#&quot; -gt 0; then
+    nonopt=&quot;$opt&quot;
+    shift
+  fi
+
+  # preserve --debug
+  test &quot;$opt_debug&quot; = : || func_append preserve_args &quot; --debug&quot;
+
   case $host in
     *cygwin* | *mingw* | *pw32* | *cegcc*)
       # don't eliminate duplications in $postdeps and $predeps
       opt_duplicate_compiler_generated_deps=:
       ;;
     *)
-      opt_duplicate_compiler_generated_deps=$opt_duplicate_deps
+      opt_duplicate_compiler_generated_deps=$opt_preserve_dup_deps
       ;;
   esac
 
-  # Having warned about all mis-specified options, bail out if
-  # anything was wrong.
-  $exit_cmd $EXIT_FAILURE
-}
+  $opt_help || {
+    # Sanity checks first:
+    func_check_version_match
 
-# func_check_version_match
-# Ensure that we are using m4 macros, and libtool script from the same
-# release of libtool.
-func_check_version_match ()
-{
-  if test &quot;$package_revision&quot; != &quot;$macro_revision&quot;; then
-    if test &quot;$VERSION&quot; != &quot;$macro_version&quot;; then
-      if test -z &quot;$macro_version&quot;; then
-        cat &gt;&amp;2 &lt;&lt;_LT_EOF
-$progname: Version mismatch error.  This is $PACKAGE $VERSION, but the
-$progname: definition of this LT_INIT comes from an older release.
-$progname: You should recreate aclocal.m4 with macros from $PACKAGE $VERSION
-$progname: and run autoconf again.
-_LT_EOF
-      else
-        cat &gt;&amp;2 &lt;&lt;_LT_EOF
-$progname: Version mismatch error.  This is $PACKAGE $VERSION, but the
-$progname: definition of this LT_INIT comes from $PACKAGE $macro_version.
-$progname: You should recreate aclocal.m4 with macros from $PACKAGE $VERSION
-$progname: and run autoconf again.
-_LT_EOF
-      fi
-    else
-      cat &gt;&amp;2 &lt;&lt;_LT_EOF
-$progname: Version mismatch error.  This is $PACKAGE $VERSION, revision $package_revision,
-$progname: but the definition of this LT_INIT comes from revision $macro_revision.
-$progname: You should recreate aclocal.m4 with macros from revision $package_revision
-$progname: of $PACKAGE $VERSION and run autoconf again.
-_LT_EOF
+    if test &quot;$build_libtool_libs&quot; != yes &amp;&amp; test &quot;$build_old_libs&quot; != yes; then
+      func_fatal_configuration &quot;not configured to build any kind of library&quot;
     fi
 
-    exit $EXIT_MISMATCH
-  fi
-}
+    # Darwin sucks
+    eval std_shrext=\&quot;$shrext_cmds\&quot;
 
+    # Only execute mode is allowed to have -dlopen flags.
+    if test -n &quot;$opt_dlopen&quot; &amp;&amp; test &quot;$opt_mode&quot; != execute; then
+      func_error &quot;unrecognized option \`-dlopen'&quot;
+      $ECHO &quot;$help&quot; 1&gt;&amp;2
+      exit $EXIT_FAILURE
+    fi
 
-## ----------- ##
-##    Main.    ##
-## ----------- ##
+    # Change the help message to a mode-specific one.
+    generic_help=&quot;$help&quot;
+    help=&quot;Try \`$progname --help --mode=$opt_mode' for more information.&quot;
+  }
 
-$opt_help || {
-  # Sanity checks first:
-  func_check_version_match
 
-  if test &quot;$build_libtool_libs&quot; != yes &amp;&amp; test &quot;$build_old_libs&quot; != yes; then
-    func_fatal_configuration &quot;not configured to build any kind of library&quot;
-  fi
+  # Bail if the options were screwed
+  $exit_cmd $EXIT_FAILURE
+}
 
-  test -z &quot;$mode&quot; &amp;&amp; func_fatal_error &quot;error: you must specify a MODE.&quot;
 
 
-  # Darwin sucks
-  eval std_shrext=\&quot;$shrext_cmds\&quot;
 
+## ----------- ##
+##    Main.    ##
+## ----------- ##
 
-  # Only execute mode is allowed to have -dlopen flags.
-  if test -n &quot;$execute_dlfiles&quot; &amp;&amp; test &quot;$mode&quot; != execute; then
-    func_error &quot;unrecognized option \`-dlopen'&quot;
-    $ECHO &quot;$help&quot; 1&gt;&amp;2
-    exit $EXIT_FAILURE
-  fi
-
-  # Change the help message to a mode-specific one.
-  generic_help=&quot;$help&quot;
-  help=&quot;Try \`$progname --help --mode=$mode' for more information.&quot;
-}
-
-
 # func_lalib_p file
 # True iff FILE is a libtool `.la' library or `.lo' object file.
 # This function is only a basic sanity check; it will hardly flush out
@@ -1110,12 +1286,9 @@
 # temporary ltwrapper_script.
 func_ltwrapper_scriptname ()
 {
-    func_ltwrapper_scriptname_result=&quot;&quot;
-    if func_ltwrapper_executable_p &quot;$1&quot;; then
-	func_dirname_and_basename &quot;$1&quot; &quot;&quot; &quot;.&quot;
-	func_stripname '' '.exe' &quot;$func_basename_result&quot;
-	func_ltwrapper_scriptname_result=&quot;$func_dirname_result/$objdir/${func_stripname_result}_ltshwrapper&quot;
-    fi
+    func_dirname_and_basename &quot;$1&quot; &quot;&quot; &quot;.&quot;
+    func_stripname '' '.exe' &quot;$func_basename_result&quot;
+    func_ltwrapper_scriptname_result=&quot;$func_dirname_result/$objdir/${func_stripname_result}_ltshwrapper&quot;
 }
 
 # func_ltwrapper_p file
@@ -1161,6 +1334,37 @@
 }
 
 
+# func_resolve_sysroot PATH
+# Replace a leading = in PATH with a sysroot.  Store the result into
+# func_resolve_sysroot_result
+func_resolve_sysroot ()
+{
+  func_resolve_sysroot_result=$1
+  case $func_resolve_sysroot_result in
+  =*)
+    func_stripname '=' '' &quot;$func_resolve_sysroot_result&quot;
+    func_resolve_sysroot_result=$lt_sysroot$func_stripname_result
+    ;;
+  esac
+}
+
+# func_replace_sysroot PATH
+# If PATH begins with the sysroot, replace it with = and
+# store the result into func_replace_sysroot_result.
+func_replace_sysroot ()
+{
+  case &quot;$lt_sysroot:$1&quot; in
+  ?*:&quot;$lt_sysroot&quot;*)
+    func_stripname &quot;$lt_sysroot&quot; '' &quot;$1&quot;
+    func_replace_sysroot_result=&quot;=$func_stripname_result&quot;
+    ;;
+  *)
+    # Including no sysroot.
+    func_replace_sysroot_result=$1
+    ;;
+  esac
+}
+
 # func_infer_tag arg
 # Infer tagged configuration to use if any are available and
 # if one wasn't chosen via the &quot;--tag&quot; command line option.
@@ -1173,8 +1377,7 @@
     if test -n &quot;$available_tags&quot; &amp;&amp; test -z &quot;$tagname&quot;; then
       CC_quoted=
       for arg in $CC; do
-        func_quote_for_eval &quot;$arg&quot;
-	CC_quoted=&quot;$CC_quoted $func_quote_for_eval_result&quot;
+	func_append_quoted CC_quoted &quot;$arg&quot;
       done
       CC_expanded=`func_echo_all $CC`
       CC_quoted_expanded=`func_echo_all $CC_quoted`
@@ -1193,8 +1396,7 @@
 	    CC_quoted=
 	    for arg in $CC; do
 	      # Double-quote args containing other shell metacharacters.
-	      func_quote_for_eval &quot;$arg&quot;
-	      CC_quoted=&quot;$CC_quoted $func_quote_for_eval_result&quot;
+	      func_append_quoted CC_quoted &quot;$arg&quot;
 	    done
 	    CC_expanded=`func_echo_all $CC`
 	    CC_quoted_expanded=`func_echo_all $CC_quoted`
@@ -1263,6 +1465,486 @@
     }
 }
 
+
+##################################################
+# FILE NAME AND PATH CONVERSION HELPER FUNCTIONS #
+##################################################
+
+# func_convert_core_file_wine_to_w32 ARG
+# Helper function used by file name conversion functions when $build is *nix,
+# and $host is mingw, cygwin, or some other w32 environment. Relies on a
+# correctly configured wine environment available, with the winepath program
+# in $build's $PATH.
+#
+# ARG is the $build file name to be converted to w32 format.
+# Result is available in $func_convert_core_file_wine_to_w32_result, and will
+# be empty on error (or when ARG is empty)
+func_convert_core_file_wine_to_w32 ()
+{
+  $opt_debug
+  func_convert_core_file_wine_to_w32_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    # Unfortunately, winepath does not exit with a non-zero error code, so we
+    # are forced to check the contents of stdout. On the other hand, if the
+    # command is not found, the shell will set an exit code of 127 and print
+    # *an error message* to stdout. So we must check for both error code of
+    # zero AND non-empty stdout, which explains the odd construction:
+    func_convert_core_file_wine_to_w32_tmp=`winepath -w &quot;$1&quot; 2&gt;/dev/null`
+    if test &quot;$?&quot; -eq 0 &amp;&amp; test -n &quot;${func_convert_core_file_wine_to_w32_tmp}&quot;; then
+      func_convert_core_file_wine_to_w32_result=`$ECHO &quot;$func_convert_core_file_wine_to_w32_tmp&quot; |
+        $SED -e &quot;$lt_sed_naive_backslashify&quot;`
+    else
+      func_convert_core_file_wine_to_w32_result=
+    fi
+  fi
+}
+# end: func_convert_core_file_wine_to_w32
+
+
+# func_convert_core_path_wine_to_w32 ARG
+# Helper function used by path conversion functions when $build is *nix, and
+# $host is mingw, cygwin, or some other w32 environment. Relies on a correctly
+# configured wine environment available, with the winepath program in $build's
+# $PATH. Assumes ARG has no leading or trailing path separator characters.
+#
+# ARG is path to be converted from $build format to win32.
+# Result is available in $func_convert_core_path_wine_to_w32_result.
+# Unconvertible file (directory) names in ARG are skipped; if no directory names
+# are convertible, then the result may be empty.
+func_convert_core_path_wine_to_w32 ()
+{
+  $opt_debug
+  # unfortunately, winepath doesn't convert paths, only file names
+  func_convert_core_path_wine_to_w32_result=&quot;&quot;
+  if test -n &quot;$1&quot;; then
+    oldIFS=$IFS
+    IFS=:
+    for func_convert_core_path_wine_to_w32_f in $1; do
+      IFS=$oldIFS
+      func_convert_core_file_wine_to_w32 &quot;$func_convert_core_path_wine_to_w32_f&quot;
+      if test -n &quot;$func_convert_core_file_wine_to_w32_result&quot; ; then
+        if test -z &quot;$func_convert_core_path_wine_to_w32_result&quot;; then
+          func_convert_core_path_wine_to_w32_result=&quot;$func_convert_core_file_wine_to_w32_result&quot;
+        else
+          func_append func_convert_core_path_wine_to_w32_result &quot;;$func_convert_core_file_wine_to_w32_result&quot;
+        fi
+      fi
+    done
+    IFS=$oldIFS
+  fi
+}
+# end: func_convert_core_path_wine_to_w32
+
+
+# func_cygpath ARGS...
+# Wrapper around calling the cygpath program via LT_CYGPATH. This is used when
+# when (1) $build is *nix and Cygwin is hosted via a wine environment; or (2)
+# $build is MSYS and $host is Cygwin, or (3) $build is Cygwin. In case (1) or
+# (2), returns the Cygwin file name or path in func_cygpath_result (input
+# file name or path is assumed to be in w32 format, as previously converted
+# from $build's *nix or MSYS format). In case (3), returns the w32 file name
+# or path in func_cygpath_result (input file name or path is assumed to be in
+# Cygwin format). Returns an empty string on error.
+#
+# ARGS are passed to cygpath, with the last one being the file name or path to
+# be converted.
+#
+# Specify the absolute *nix (or w32) name to cygpath in the LT_CYGPATH
+# environment variable; do not put it in $PATH.
+func_cygpath ()
+{
+  $opt_debug
+  if test -n &quot;$LT_CYGPATH&quot; &amp;&amp; test -f &quot;$LT_CYGPATH&quot;; then
+    func_cygpath_result=`$LT_CYGPATH &quot;$@&quot; 2&gt;/dev/null`
+    if test &quot;$?&quot; -ne 0; then
+      # on failure, ensure result is empty
+      func_cygpath_result=
+    fi
+  else
+    func_cygpath_result=
+    func_error &quot;LT_CYGPATH is empty or specifies non-existent file: \`$LT_CYGPATH'&quot;
+  fi
+}
+#end: func_cygpath
+
+
+# func_convert_core_msys_to_w32 ARG
+# Convert file name or path ARG from MSYS format to w32 format.  Return
+# result in func_convert_core_msys_to_w32_result.
+func_convert_core_msys_to_w32 ()
+{
+  $opt_debug
+  # awkward: cmd appends spaces to result
+  func_convert_core_msys_to_w32_result=`( cmd //c echo &quot;$1&quot; ) 2&gt;/dev/null |
+    $SED -e 's/[ ]*$//' -e &quot;$lt_sed_naive_backslashify&quot;`
+}
+#end: func_convert_core_msys_to_w32
+
+
+# func_convert_file_check ARG1 ARG2
+# Verify that ARG1 (a file name in $build format) was converted to $host
+# format in ARG2. Otherwise, emit an error message, but continue (resetting
+# func_to_host_file_result to ARG1).
+func_convert_file_check ()
+{
+  $opt_debug
+  if test -z &quot;$2&quot; &amp;&amp; test -n &quot;$1&quot; ; then
+    func_error &quot;Could not determine host file name corresponding to&quot;
+    func_error &quot;  \`$1'&quot;
+    func_error &quot;Continuing, but uninstalled executables may not work.&quot;
+    # Fallback:
+    func_to_host_file_result=&quot;$1&quot;
+  fi
+}
+# end func_convert_file_check
+
+
+# func_convert_path_check FROM_PATHSEP TO_PATHSEP FROM_PATH TO_PATH
+# Verify that FROM_PATH (a path in $build format) was converted to $host
+# format in TO_PATH. Otherwise, emit an error message, but continue, resetting
+# func_to_host_file_result to a simplistic fallback value (see below).
+func_convert_path_check ()
+{
+  $opt_debug
+  if test -z &quot;$4&quot; &amp;&amp; test -n &quot;$3&quot;; then
+    func_error &quot;Could not determine the host path corresponding to&quot;
+    func_error &quot;  \`$3'&quot;
+    func_error &quot;Continuing, but uninstalled executables may not work.&quot;
+    # Fallback.  This is a deliberately simplistic &quot;conversion&quot; and
+    # should not be &quot;improved&quot;.  See libtool.info.
+    if test &quot;x$1&quot; != &quot;x$2&quot;; then
+      lt_replace_pathsep_chars=&quot;s|$1|$2|g&quot;
+      func_to_host_path_result=`echo &quot;$3&quot; |
+        $SED -e &quot;$lt_replace_pathsep_chars&quot;`
+    else
+      func_to_host_path_result=&quot;$3&quot;
+    fi
+  fi
+}
+# end func_convert_path_check
+
+
+# func_convert_path_front_back_pathsep FRONTPAT BACKPAT REPL ORIG
+# Modifies func_to_host_path_result by prepending REPL if ORIG matches FRONTPAT
+# and appending REPL if ORIG matches BACKPAT.
+func_convert_path_front_back_pathsep ()
+{
+  $opt_debug
+  case $4 in
+  $1 ) func_to_host_path_result=&quot;$3$func_to_host_path_result&quot;
+    ;;
+  esac
+  case $4 in
+  $2 ) func_append func_to_host_path_result &quot;$3&quot;
+    ;;
+  esac
+}
+# end func_convert_path_front_back_pathsep
+
+
+##################################################
+# $build to $host FILE NAME CONVERSION FUNCTIONS #
+##################################################
+# invoked via `$to_host_file_cmd ARG'
+#
+# In each case, ARG is the path to be converted from $build to $host format.
+# Result will be available in $func_to_host_file_result.
+
+
+# func_to_host_file ARG
+# Converts the file name ARG from $build format to $host format. Return result
+# in func_to_host_file_result.
+func_to_host_file ()
+{
+  $opt_debug
+  $to_host_file_cmd &quot;$1&quot;
+}
+# end func_to_host_file
+
+
+# func_to_tool_file ARG LAZY
+# converts the file name ARG from $build format to toolchain format. Return
+# result in func_to_tool_file_result.  If the conversion in use is listed
+# in (the comma separated) LAZY, no conversion takes place.
+func_to_tool_file ()
+{
+  $opt_debug
+  case ,$2, in
+    *,&quot;$to_tool_file_cmd&quot;,*)
+      func_to_tool_file_result=$1
+      ;;
+    *)
+      $to_tool_file_cmd &quot;$1&quot;
+      func_to_tool_file_result=$func_to_host_file_result
+      ;;
+  esac
+}
+# end func_to_tool_file
+
+
+# func_convert_file_noop ARG
+# Copy ARG to func_to_host_file_result.
+func_convert_file_noop ()
+{
+  func_to_host_file_result=&quot;$1&quot;
+}
+# end func_convert_file_noop
+
+
+# func_convert_file_msys_to_w32 ARG
+# Convert file name ARG from (mingw) MSYS to (mingw) w32 format; automatic
+# conversion to w32 is not available inside the cwrapper.  Returns result in
+# func_to_host_file_result.
+func_convert_file_msys_to_w32 ()
+{
+  $opt_debug
+  func_to_host_file_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    func_convert_core_msys_to_w32 &quot;$1&quot;
+    func_to_host_file_result=&quot;$func_convert_core_msys_to_w32_result&quot;
+  fi
+  func_convert_file_check &quot;$1&quot; &quot;$func_to_host_file_result&quot;
+}
+# end func_convert_file_msys_to_w32
+
+
+# func_convert_file_cygwin_to_w32 ARG
+# Convert file name ARG from Cygwin to w32 format.  Returns result in
+# func_to_host_file_result.
+func_convert_file_cygwin_to_w32 ()
+{
+  $opt_debug
+  func_to_host_file_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    # because $build is cygwin, we call &quot;the&quot; cygpath in $PATH; no need to use
+    # LT_CYGPATH in this case.
+    func_to_host_file_result=`cygpath -m &quot;$1&quot;`
+  fi
+  func_convert_file_check &quot;$1&quot; &quot;$func_to_host_file_result&quot;
+}
+# end func_convert_file_cygwin_to_w32
+
+
+# func_convert_file_nix_to_w32 ARG
+# Convert file name ARG from *nix to w32 format.  Requires a wine environment
+# and a working winepath. Returns result in func_to_host_file_result.
+func_convert_file_nix_to_w32 ()
+{
+  $opt_debug
+  func_to_host_file_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    func_convert_core_file_wine_to_w32 &quot;$1&quot;
+    func_to_host_file_result=&quot;$func_convert_core_file_wine_to_w32_result&quot;
+  fi
+  func_convert_file_check &quot;$1&quot; &quot;$func_to_host_file_result&quot;
+}
+# end func_convert_file_nix_to_w32
+
+
+# func_convert_file_msys_to_cygwin ARG
+# Convert file name ARG from MSYS to Cygwin format.  Requires LT_CYGPATH set.
+# Returns result in func_to_host_file_result.
+func_convert_file_msys_to_cygwin ()
+{
+  $opt_debug
+  func_to_host_file_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    func_convert_core_msys_to_w32 &quot;$1&quot;
+    func_cygpath -u &quot;$func_convert_core_msys_to_w32_result&quot;
+    func_to_host_file_result=&quot;$func_cygpath_result&quot;
+  fi
+  func_convert_file_check &quot;$1&quot; &quot;$func_to_host_file_result&quot;
+}
+# end func_convert_file_msys_to_cygwin
+
+
+# func_convert_file_nix_to_cygwin ARG
+# Convert file name ARG from *nix to Cygwin format.  Requires Cygwin installed
+# in a wine environment, working winepath, and LT_CYGPATH set.  Returns result
+# in func_to_host_file_result.
+func_convert_file_nix_to_cygwin ()
+{
+  $opt_debug
+  func_to_host_file_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    # convert from *nix to w32, then use cygpath to convert from w32 to cygwin.
+    func_convert_core_file_wine_to_w32 &quot;$1&quot;
+    func_cygpath -u &quot;$func_convert_core_file_wine_to_w32_result&quot;
+    func_to_host_file_result=&quot;$func_cygpath_result&quot;
+  fi
+  func_convert_file_check &quot;$1&quot; &quot;$func_to_host_file_result&quot;
+}
+# end func_convert_file_nix_to_cygwin
+
+
+#############################################
+# $build to $host PATH CONVERSION FUNCTIONS #
+#############################################
+# invoked via `$to_host_path_cmd ARG'
+#
+# In each case, ARG is the path to be converted from $build to $host format.
+# The result will be available in $func_to_host_path_result.
+#
+# Path separators are also converted from $build format to $host format.  If
+# ARG begins or ends with a path separator character, it is preserved (but
+# converted to $host format) on output.
+#
+# All path conversion functions are named using the following convention:
+#   file name conversion function    : func_convert_file_X_to_Y ()
+#   path conversion function         : func_convert_path_X_to_Y ()
+# where, for any given $build/$host combination the 'X_to_Y' value is the
+# same.  If conversion functions are added for new $build/$host combinations,
+# the two new functions must follow this pattern, or func_init_to_host_path_cmd
+# will break.
+
+
+# func_init_to_host_path_cmd
+# Ensures that function &quot;pointer&quot; variable $to_host_path_cmd is set to the
+# appropriate value, based on the value of $to_host_file_cmd.
+to_host_path_cmd=
+func_init_to_host_path_cmd ()
+{
+  $opt_debug
+  if test -z &quot;$to_host_path_cmd&quot;; then
+    func_stripname 'func_convert_file_' '' &quot;$to_host_file_cmd&quot;
+    to_host_path_cmd=&quot;func_convert_path_${func_stripname_result}&quot;
+  fi
+}
+
+
+# func_to_host_path ARG
+# Converts the path ARG from $build format to $host format. Return result
+# in func_to_host_path_result.
+func_to_host_path ()
+{
+  $opt_debug
+  func_init_to_host_path_cmd
+  $to_host_path_cmd &quot;$1&quot;
+}
+# end func_to_host_path
+
+
+# func_convert_path_noop ARG
+# Copy ARG to func_to_host_path_result.
+func_convert_path_noop ()
+{
+  func_to_host_path_result=&quot;$1&quot;
+}
+# end func_convert_path_noop
+
+
+# func_convert_path_msys_to_w32 ARG
+# Convert path ARG from (mingw) MSYS to (mingw) w32 format; automatic
+# conversion to w32 is not available inside the cwrapper.  Returns result in
+# func_to_host_path_result.
+func_convert_path_msys_to_w32 ()
+{
+  $opt_debug
+  func_to_host_path_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    # Remove leading and trailing path separator characters from ARG.  MSYS
+    # behavior is inconsistent here; cygpath turns them into '.;' and ';.';
+    # and winepath ignores them completely.
+    func_stripname : : &quot;$1&quot;
+    func_to_host_path_tmp1=$func_stripname_result
+    func_convert_core_msys_to_w32 &quot;$func_to_host_path_tmp1&quot;
+    func_to_host_path_result=&quot;$func_convert_core_msys_to_w32_result&quot;
+    func_convert_path_check : &quot;;&quot; \
+      &quot;$func_to_host_path_tmp1&quot; &quot;$func_to_host_path_result&quot;
+    func_convert_path_front_back_pathsep &quot;:*&quot; &quot;*:&quot; &quot;;&quot; &quot;$1&quot;
+  fi
+}
+# end func_convert_path_msys_to_w32
+
+
+# func_convert_path_cygwin_to_w32 ARG
+# Convert path ARG from Cygwin to w32 format.  Returns result in
+# func_to_host_file_result.
+func_convert_path_cygwin_to_w32 ()
+{
+  $opt_debug
+  func_to_host_path_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    # See func_convert_path_msys_to_w32:
+    func_stripname : : &quot;$1&quot;
+    func_to_host_path_tmp1=$func_stripname_result
+    func_to_host_path_result=`cygpath -m -p &quot;$func_to_host_path_tmp1&quot;`
+    func_convert_path_check : &quot;;&quot; \
+      &quot;$func_to_host_path_tmp1&quot; &quot;$func_to_host_path_result&quot;
+    func_convert_path_front_back_pathsep &quot;:*&quot; &quot;*:&quot; &quot;;&quot; &quot;$1&quot;
+  fi
+}
+# end func_convert_path_cygwin_to_w32
+
+
+# func_convert_path_nix_to_w32 ARG
+# Convert path ARG from *nix to w32 format.  Requires a wine environment and
+# a working winepath.  Returns result in func_to_host_file_result.
+func_convert_path_nix_to_w32 ()
+{
+  $opt_debug
+  func_to_host_path_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    # See func_convert_path_msys_to_w32:
+    func_stripname : : &quot;$1&quot;
+    func_to_host_path_tmp1=$func_stripname_result
+    func_convert_core_path_wine_to_w32 &quot;$func_to_host_path_tmp1&quot;
+    func_to_host_path_result=&quot;$func_convert_core_path_wine_to_w32_result&quot;
+    func_convert_path_check : &quot;;&quot; \
+      &quot;$func_to_host_path_tmp1&quot; &quot;$func_to_host_path_result&quot;
+    func_convert_path_front_back_pathsep &quot;:*&quot; &quot;*:&quot; &quot;;&quot; &quot;$1&quot;
+  fi
+}
+# end func_convert_path_nix_to_w32
+
+
+# func_convert_path_msys_to_cygwin ARG
+# Convert path ARG from MSYS to Cygwin format.  Requires LT_CYGPATH set.
+# Returns result in func_to_host_file_result.
+func_convert_path_msys_to_cygwin ()
+{
+  $opt_debug
+  func_to_host_path_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    # See func_convert_path_msys_to_w32:
+    func_stripname : : &quot;$1&quot;
+    func_to_host_path_tmp1=$func_stripname_result
+    func_convert_core_msys_to_w32 &quot;$func_to_host_path_tmp1&quot;
+    func_cygpath -u -p &quot;$func_convert_core_msys_to_w32_result&quot;
+    func_to_host_path_result=&quot;$func_cygpath_result&quot;
+    func_convert_path_check : : \
+      &quot;$func_to_host_path_tmp1&quot; &quot;$func_to_host_path_result&quot;
+    func_convert_path_front_back_pathsep &quot;:*&quot; &quot;*:&quot; : &quot;$1&quot;
+  fi
+}
+# end func_convert_path_msys_to_cygwin
+
+
+# func_convert_path_nix_to_cygwin ARG
+# Convert path ARG from *nix to Cygwin format.  Requires Cygwin installed in a
+# a wine environment, working winepath, and LT_CYGPATH set.  Returns result in
+# func_to_host_file_result.
+func_convert_path_nix_to_cygwin ()
+{
+  $opt_debug
+  func_to_host_path_result=&quot;$1&quot;
+  if test -n &quot;$1&quot;; then
+    # Remove leading and trailing path separator characters from
+    # ARG. msys behavior is inconsistent here, cygpath turns them
+    # into '.;' and ';.', and winepath ignores them completely.
+    func_stripname : : &quot;$1&quot;
+    func_to_host_path_tmp1=$func_stripname_result
+    func_convert_core_path_wine_to_w32 &quot;$func_to_host_path_tmp1&quot;
+    func_cygpath -u -p &quot;$func_convert_core_path_wine_to_w32_result&quot;
+    func_to_host_path_result=&quot;$func_cygpath_result&quot;
+    func_convert_path_check : : \
+      &quot;$func_to_host_path_tmp1&quot; &quot;$func_to_host_path_result&quot;
+    func_convert_path_front_back_pathsep &quot;:*&quot; &quot;*:&quot; : &quot;$1&quot;
+  fi
+}
+# end func_convert_path_nix_to_cygwin
+
+
 # func_mode_compile arg...
 func_mode_compile ()
 {
@@ -1303,12 +1985,12 @@
 	  ;;
 
 	-pie | -fpie | -fPIE)
-          pie_flag=&quot;$pie_flag $arg&quot;
+          func_append pie_flag &quot; $arg&quot;
 	  continue
 	  ;;
 
 	-shared | -static | -prefer-pic | -prefer-non-pic)
-	  later=&quot;$later $arg&quot;
+	  func_append later &quot; $arg&quot;
 	  continue
 	  ;;
 
@@ -1329,15 +2011,14 @@
 	  save_ifs=&quot;$IFS&quot;; IFS=','
 	  for arg in $args; do
 	    IFS=&quot;$save_ifs&quot;
-	    func_quote_for_eval &quot;$arg&quot;
-	    lastarg=&quot;$lastarg $func_quote_for_eval_result&quot;
+	    func_append_quoted lastarg &quot;$arg&quot;
 	  done
 	  IFS=&quot;$save_ifs&quot;
 	  func_stripname ' ' '' &quot;$lastarg&quot;
 	  lastarg=$func_stripname_result
 
 	  # Add the arguments to base_compile.
-	  base_compile=&quot;$base_compile $lastarg&quot;
+	  func_append base_compile &quot; $lastarg&quot;
 	  continue
 	  ;;
 
@@ -1353,8 +2034,7 @@
       esac    #  case $arg_mode
 
       # Aesthetically quote the previous argument.
-      func_quote_for_eval &quot;$lastarg&quot;
-      base_compile=&quot;$base_compile $func_quote_for_eval_result&quot;
+      func_append_quoted base_compile &quot;$lastarg&quot;
     done # for arg
 
     case $arg_mode in
@@ -1485,17 +2165,16 @@
 	$opt_dry_run || $RM $removelist
 	exit $EXIT_FAILURE
       fi
-      removelist=&quot;$removelist $output_obj&quot;
+      func_append removelist &quot; $output_obj&quot;
       $ECHO &quot;$srcfile&quot; &gt; &quot;$lockfile&quot;
     fi
 
     $opt_dry_run || $RM $removelist
-    removelist=&quot;$removelist $lockfile&quot;
+    func_append removelist &quot; $lockfile&quot;
     trap '$opt_dry_run || $RM $removelist; exit $EXIT_FAILURE' 1 2 15
 
-    if test -n &quot;$fix_srcfile_path&quot;; then
-      eval srcfile=\&quot;$fix_srcfile_path\&quot;
-    fi
+    func_to_tool_file &quot;$srcfile&quot; func_convert_file_msys_to_w32
+    srcfile=$func_to_tool_file_result
     func_quote_for_eval &quot;$srcfile&quot;
     qsrcfile=$func_quote_for_eval_result
 
@@ -1515,7 +2194,7 @@
 
       if test -z &quot;$output_obj&quot;; then
 	# Place PIC objects in $objdir
-	command=&quot;$command -o $lobj&quot;
+	func_append command &quot; -o $lobj&quot;
       fi
 
       func_show_eval_locale &quot;$command&quot;	\
@@ -1562,11 +2241,11 @@
 	command=&quot;$base_compile $qsrcfile $pic_flag&quot;
       fi
       if test &quot;$compiler_c_o&quot; = yes; then
-	command=&quot;$command -o $obj&quot;
+	func_append command &quot; -o $obj&quot;
       fi
 
       # Suppress compiler output if we already did a PIC compilation.
-      command=&quot;$command$suppress_output&quot;
+      func_append command &quot;$suppress_output&quot;
       func_show_eval_locale &quot;$command&quot; \
         '$opt_dry_run || $RM $removelist; exit $EXIT_FAILURE'
 
@@ -1611,13 +2290,13 @@
 }
 
 $opt_help || {
-  test &quot;$mode&quot; = compile &amp;&amp; func_mode_compile ${1+&quot;$@&quot;}
+  test &quot;$opt_mode&quot; = compile &amp;&amp; func_mode_compile ${1+&quot;$@&quot;}
 }
 
 func_mode_help ()
 {
     # We need to display help for each of the modes.
-    case $mode in
+    case $opt_mode in
       &quot;&quot;)
         # Generic help is extracted from the usage comments
         # at the start of this file.
@@ -1793,7 +2472,7 @@
         ;;
 
       *)
-        func_fatal_help &quot;invalid operation mode \`$mode'&quot;
+        func_fatal_help &quot;invalid operation mode \`$opt_mode'&quot;
         ;;
     esac
 
@@ -1808,13 +2487,13 @@
   else
     {
       func_help noexit
-      for mode in compile link execute install finish uninstall clean; do
+      for opt_mode in compile link execute install finish uninstall clean; do
 	func_mode_help
       done
     } | sed -n '1p; 2,$s/^Usage:/  or: /p'
     {
       func_help noexit
-      for mode in compile link execute install finish uninstall clean; do
+      for opt_mode in compile link execute install finish uninstall clean; do
 	echo
 	func_mode_help
       done
@@ -1843,13 +2522,16 @@
       func_fatal_help &quot;you must specify a COMMAND&quot;
 
     # Handle -dlopen flags immediately.
-    for file in $execute_dlfiles; do
+    for file in $opt_dlopen; do
       test -f &quot;$file&quot; \
 	|| func_fatal_help &quot;\`$file' is not a file&quot;
 
       dir=
       case $file in
       *.la)
+	func_resolve_sysroot &quot;$file&quot;
+	file=$func_resolve_sysroot_result
+
 	# Check to see that this really is a libtool archive.
 	func_lalib_unsafe_p &quot;$file&quot; \
 	  || func_fatal_help &quot;\`$lib' is not a valid libtool archive&quot;
@@ -1871,7 +2553,7 @@
 	dir=&quot;$func_dirname_result&quot;
 
 	if test -f &quot;$dir/$objdir/$dlname&quot;; then
-	  dir=&quot;$dir/$objdir&quot;
+	  func_append dir &quot;/$objdir&quot;
 	else
 	  if test ! -f &quot;$dir/$dlname&quot;; then
 	    func_fatal_error &quot;cannot find \`$dlname' in \`$dir' or \`$dir/$objdir'&quot;
@@ -1928,8 +2610,7 @@
 	;;
       esac
       # Quote arguments (to preserve shell metacharacters).
-      func_quote_for_eval &quot;$file&quot;
-      args=&quot;$args $func_quote_for_eval_result&quot;
+      func_append_quoted args &quot;$file&quot;
     done
 
     if test &quot;X$opt_dry_run&quot; = Xfalse; then
@@ -1961,22 +2642,59 @@
     fi
 }
 
-test &quot;$mode&quot; = execute &amp;&amp; func_mode_execute ${1+&quot;$@&quot;}
+test &quot;$opt_mode&quot; = execute &amp;&amp; func_mode_execute ${1+&quot;$@&quot;}
 
 
 # func_mode_finish arg...
 func_mode_finish ()
 {
     $opt_debug
-    libdirs=&quot;$nonopt&quot;
+    libs=
+    libdirs=
     admincmds=
 
+    for opt in &quot;$nonopt&quot; ${1+&quot;$@&quot;}
+    do
+      if test -d &quot;$opt&quot;; then
+	func_append libdirs &quot; $opt&quot;
+
+      elif test -f &quot;$opt&quot;; then
+	if func_lalib_unsafe_p &quot;$opt&quot;; then
+	  func_append libs &quot; $opt&quot;
+	else
+	  func_warning &quot;\`$opt' is not a valid libtool archive&quot;
+	fi
+
+      else
+	func_fatal_error &quot;invalid argument \`$opt'&quot;
+      fi
+    done
+
+    if test -n &quot;$libs&quot;; then
+      if test -n &quot;$lt_sysroot&quot;; then
+        sysroot_regex=`$ECHO &quot;$lt_sysroot&quot; | $SED &quot;$sed_make_literal_regex&quot;`
+        sysroot_cmd=&quot;s/\([ ']\)$sysroot_regex/\1/g;&quot;
+      else
+        sysroot_cmd=
+      fi
+
+      # Remove sysroot references
+      if $opt_dry_run; then
+        for lib in $libs; do
+          echo &quot;removing references to $lt_sysroot and \`=' prefixes from $lib&quot;
+        done
+      else
+        tmpdir=`func_mktempdir`
+        for lib in $libs; do
+	  sed -e &quot;${sysroot_cmd} s/\([ ']-[LR]\)=/\1/g; s/\([ ']\)=/\1/g&quot; $lib \
+	    &gt; $tmpdir/tmp-la
+	  mv -f $tmpdir/tmp-la $lib
+	done
+        ${RM}r &quot;$tmpdir&quot;
+      fi
+    fi
+
     if test -n &quot;$finish_cmds$finish_eval&quot; &amp;&amp; test -n &quot;$libdirs&quot;; then
-      for dir
-      do
-	libdirs=&quot;$libdirs $dir&quot;
-      done
-
       for libdir in $libdirs; do
 	if test -n &quot;$finish_cmds&quot;; then
 	  # Do each command in the finish commands.
@@ -1986,7 +2704,7 @@
 	if test -n &quot;$finish_eval&quot;; then
 	  # Do the single finish_eval.
 	  eval cmds=\&quot;$finish_eval\&quot;
-	  $opt_dry_run || eval &quot;$cmds&quot; || admincmds=&quot;$admincmds
+	  $opt_dry_run || eval &quot;$cmds&quot; || func_append admincmds &quot;
        $cmds&quot;
 	fi
       done
@@ -1995,53 +2713,55 @@
     # Exit here if they wanted silent mode.
     $opt_silent &amp;&amp; exit $EXIT_SUCCESS
 
-    echo &quot;----------------------------------------------------------------------&quot;
-    echo &quot;Libraries have been installed in:&quot;
-    for libdir in $libdirs; do
-      $ECHO &quot;   $libdir&quot;
-    done
-    echo
-    echo &quot;If you ever happen to want to link against installed libraries&quot;
-    echo &quot;in a given directory, LIBDIR, you must either use libtool, and&quot;
-    echo &quot;specify the full pathname of the library, or use the \`-LLIBDIR'&quot;
-    echo &quot;flag during linking and do at least one of the following:&quot;
-    if test -n &quot;$shlibpath_var&quot;; then
-      echo &quot;   - add LIBDIR to the \`$shlibpath_var' environment variable&quot;
-      echo &quot;     during execution&quot;
-    fi
-    if test -n &quot;$runpath_var&quot;; then
-      echo &quot;   - add LIBDIR to the \`$runpath_var' environment variable&quot;
-      echo &quot;     during linking&quot;
-    fi
-    if test -n &quot;$hardcode_libdir_flag_spec&quot;; then
-      libdir=LIBDIR
-      eval flag=\&quot;$hardcode_libdir_flag_spec\&quot;
+    if test -n &quot;$finish_cmds$finish_eval&quot; &amp;&amp; test -n &quot;$libdirs&quot;; then
+      echo &quot;----------------------------------------------------------------------&quot;
+      echo &quot;Libraries have been installed in:&quot;
+      for libdir in $libdirs; do
+	$ECHO &quot;   $libdir&quot;
+      done
+      echo
+      echo &quot;If you ever happen to want to link against installed libraries&quot;
+      echo &quot;in a given directory, LIBDIR, you must either use libtool, and&quot;
+      echo &quot;specify the full pathname of the library, or use the \`-LLIBDIR'&quot;
+      echo &quot;flag during linking and do at least one of the following:&quot;
+      if test -n &quot;$shlibpath_var&quot;; then
+	echo &quot;   - add LIBDIR to the \`$shlibpath_var' environment variable&quot;
+	echo &quot;     during execution&quot;
+      fi
+      if test -n &quot;$runpath_var&quot;; then
+	echo &quot;   - add LIBDIR to the \`$runpath_var' environment variable&quot;
+	echo &quot;     during linking&quot;
+      fi
+      if test -n &quot;$hardcode_libdir_flag_spec&quot;; then
+	libdir=LIBDIR
+	eval flag=\&quot;$hardcode_libdir_flag_spec\&quot;
 
-      $ECHO &quot;   - use the \`$flag' linker flag&quot;
+	$ECHO &quot;   - use the \`$flag' linker flag&quot;
+      fi
+      if test -n &quot;$admincmds&quot;; then
+	$ECHO &quot;   - have your system administrator run these commands:$admincmds&quot;
+      fi
+      if test -f /etc/ld.so.conf; then
+	echo &quot;   - have your system administrator add LIBDIR to \`/etc/ld.so.conf'&quot;
+      fi
+      echo
+
+      echo &quot;See any operating system documentation about shared libraries for&quot;
+      case $host in
+	solaris2.[6789]|solaris2.1[0-9])
+	  echo &quot;more information, such as the ld(1), crle(1) and ld.so(8) manual&quot;
+	  echo &quot;pages.&quot;
+	  ;;
+	*)
+	  echo &quot;more information, such as the ld(1) and ld.so(8) manual pages.&quot;
+	  ;;
+      esac
+      echo &quot;----------------------------------------------------------------------&quot;
     fi
-    if test -n &quot;$admincmds&quot;; then
-      $ECHO &quot;   - have your system administrator run these commands:$admincmds&quot;
-    fi
-    if test -f /etc/ld.so.conf; then
-      echo &quot;   - have your system administrator add LIBDIR to \`/etc/ld.so.conf'&quot;
-    fi
-    echo
-
-    echo &quot;See any operating system documentation about shared libraries for&quot;
-    case $host in
-      solaris2.[6789]|solaris2.1[0-9])
-        echo &quot;more information, such as the ld(1), crle(1) and ld.so(8) manual&quot;
-	echo &quot;pages.&quot;
-	;;
-      *)
-        echo &quot;more information, such as the ld(1) and ld.so(8) manual pages.&quot;
-        ;;
-    esac
-    echo &quot;----------------------------------------------------------------------&quot;
     exit $EXIT_SUCCESS
 }
 
-test &quot;$mode&quot; = finish &amp;&amp; func_mode_finish ${1+&quot;$@&quot;}
+test &quot;$opt_mode&quot; = finish &amp;&amp; func_mode_finish ${1+&quot;$@&quot;}
 
 
 # func_mode_install arg...
@@ -2066,7 +2786,7 @@
     # The real first argument should be the name of the installation program.
     # Aesthetically quote it.
     func_quote_for_eval &quot;$arg&quot;
-    install_prog=&quot;$install_prog$func_quote_for_eval_result&quot;
+    func_append install_prog &quot;$func_quote_for_eval_result&quot;
     install_shared_prog=$install_prog
     case &quot; $install_prog &quot; in
       *[\\\ /]cp\ *) install_cp=: ;;
@@ -2086,7 +2806,7 @@
     do
       arg2=
       if test -n &quot;$dest&quot;; then
-	files=&quot;$files $dest&quot;
+	func_append files &quot; $dest&quot;
 	dest=$arg
 	continue
       fi
@@ -2124,11 +2844,11 @@
 
       # Aesthetically quote the argument.
       func_quote_for_eval &quot;$arg&quot;
-      install_prog=&quot;$install_prog $func_quote_for_eval_result&quot;
+      func_append install_prog &quot; $func_quote_for_eval_result&quot;
       if test -n &quot;$arg2&quot;; then
 	func_quote_for_eval &quot;$arg2&quot;
       fi
-      install_shared_prog=&quot;$install_shared_prog $func_quote_for_eval_result&quot;
+      func_append install_shared_prog &quot; $func_quote_for_eval_result&quot;
     done
 
     test -z &quot;$install_prog&quot; &amp;&amp; \
@@ -2140,7 +2860,7 @@
     if test -n &quot;$install_override_mode&quot; &amp;&amp; $no_mode; then
       if $install_cp; then :; else
 	func_quote_for_eval &quot;$install_override_mode&quot;
-	install_shared_prog=&quot;$install_shared_prog -m $func_quote_for_eval_result&quot;
+	func_append install_shared_prog &quot; -m $func_quote_for_eval_result&quot;
       fi
     fi
 
@@ -2198,10 +2918,13 @@
       case $file in
       *.$libext)
 	# Do the static libraries later.
-	staticlibs=&quot;$staticlibs $file&quot;
+	func_append staticlibs &quot; $file&quot;
 	;;
 
       *.la)
+	func_resolve_sysroot &quot;$file&quot;
+	file=$func_resolve_sysroot_result
+
 	# Check to see that this really is a libtool archive.
 	func_lalib_unsafe_p &quot;$file&quot; \
 	  || func_fatal_help &quot;\`$file' is not a valid libtool archive&quot;
@@ -2215,19 +2938,19 @@
 	if test &quot;X$destdir&quot; = &quot;X$libdir&quot;; then
 	  case &quot;$current_libdirs &quot; in
 	  *&quot; $libdir &quot;*) ;;
-	  *) current_libdirs=&quot;$current_libdirs $libdir&quot; ;;
+	  *) func_append current_libdirs &quot; $libdir&quot; ;;
 	  esac
 	else
 	  # Note the libdir as a future libdir.
 	  case &quot;$future_libdirs &quot; in
 	  *&quot; $libdir &quot;*) ;;
-	  *) future_libdirs=&quot;$future_libdirs $libdir&quot; ;;
+	  *) func_append future_libdirs &quot; $libdir&quot; ;;
 	  esac
 	fi
 
 	func_dirname &quot;$file&quot; &quot;/&quot; &quot;&quot;
 	dir=&quot;$func_dirname_result&quot;
-	dir=&quot;$dir$objdir&quot;
+	func_append dir &quot;$objdir&quot;
 
 	if test -n &quot;$relink_command&quot;; then
 	  # Determine the prefix the user has applied to our future dir.
@@ -2304,7 +3027,7 @@
 	func_show_eval &quot;$install_prog $instname $destdir/$name&quot; 'exit $?'
 
 	# Maybe install the static library, too.
-	test -n &quot;$old_library&quot; &amp;&amp; staticlibs=&quot;$staticlibs $dir/$old_library&quot;
+	test -n &quot;$old_library&quot; &amp;&amp; func_append staticlibs &quot; $dir/$old_library&quot;
 	;;
 
       *.lo)
@@ -2501,7 +3224,7 @@
     fi
 }
 
-test &quot;$mode&quot; = install &amp;&amp; func_mode_install ${1+&quot;$@&quot;}
+test &quot;$opt_mode&quot; = install &amp;&amp; func_mode_install ${1+&quot;$@&quot;}
 
 
 # func_generate_dlsyms outputname originator pic_p
@@ -2548,6 +3271,18 @@
 #pragma GCC diagnostic ignored \&quot;-Wstrict-prototypes\&quot;
 #endif
 
+/* Keep this code in sync between libtool.m4, ltmain, lt_system.h, and tests.  */
+#if defined(_WIN32) || defined(__CYGWIN__) || defined(_WIN32_WCE)
+/* DATA imports from DLLs on WIN32 con't be const, because runtime
+   relocations are performed -- see ld's documentation on pseudo-relocs.  */
+# define LT_DLSYM_CONST
+#elif defined(__osf__)
+/* This system does not cope well with relocations in const data.  */
+# define LT_DLSYM_CONST
+#else
+# define LT_DLSYM_CONST const
+#endif
+
 /* External symbol declarations for the compiler. */\
 &quot;
 
@@ -2559,8 +3294,9 @@
 	  # Add our own program objects to the symbol list.
 	  progfiles=`$ECHO &quot;$objs$old_deplibs&quot; | $SP2NL | $SED &quot;$lo2o&quot; | $NL2SP`
 	  for progfile in $progfiles; do
-	    func_verbose &quot;extracting global C symbols from \`$progfile'&quot;
-	    $opt_dry_run || eval &quot;$NM $progfile | $global_symbol_pipe &gt;&gt; '$nlist'&quot;
+	    func_to_tool_file &quot;$progfile&quot; func_convert_file_msys_to_w32
+	    func_verbose &quot;extracting global C symbols from \`$func_to_tool_file_result'&quot;
+	    $opt_dry_run || eval &quot;$NM $func_to_tool_file_result | $global_symbol_pipe &gt;&gt; '$nlist'&quot;
 	  done
 
 	  if test -n &quot;$exclude_expsyms&quot;; then
@@ -2609,10 +3345,52 @@
 	  func_verbose &quot;extracting global C symbols from \`$dlprefile'&quot;
 	  func_basename &quot;$dlprefile&quot;
 	  name=&quot;$func_basename_result&quot;
-	  $opt_dry_run || {
-	    eval '$ECHO &quot;: $name &quot; &gt;&gt; &quot;$nlist&quot;'
-	    eval &quot;$NM $dlprefile 2&gt;/dev/null | $global_symbol_pipe &gt;&gt; '$nlist'&quot;
-	  }
+          case $host in
+	    *cygwin* | *mingw* | *cegcc* )
+	      # if an import library, we need to obtain dlname
+	      if func_win32_import_lib_p &quot;$dlprefile&quot;; then
+	        func_tr_sh &quot;$dlprefile&quot;
+	        eval &quot;curr_lafile=\$libfile_$func_tr_sh_result&quot;
+	        dlprefile_dlbasename=&quot;&quot;
+	        if test -n &quot;$curr_lafile&quot; &amp;&amp; func_lalib_p &quot;$curr_lafile&quot;; then
+	          # Use subshell, to avoid clobbering current variable values
+	          dlprefile_dlname=`source &quot;$curr_lafile&quot; &amp;&amp; echo &quot;$dlname&quot;`
+	          if test -n &quot;$dlprefile_dlname&quot; ; then
+	            func_basename &quot;$dlprefile_dlname&quot;
+	            dlprefile_dlbasename=&quot;$func_basename_result&quot;
+	          else
+	            # no lafile. user explicitly requested -dlpreopen &lt;import library&gt;.
+	            $sharedlib_from_linklib_cmd &quot;$dlprefile&quot;
+	            dlprefile_dlbasename=$sharedlib_from_linklib_result
+	          fi
+	        fi
+	        $opt_dry_run || {
+	          if test -n &quot;$dlprefile_dlbasename&quot; ; then
+	            eval '$ECHO &quot;: $dlprefile_dlbasename&quot; &gt;&gt; &quot;$nlist&quot;'
+	          else
+	            func_warning &quot;Could not compute DLL name from $name&quot;
+	            eval '$ECHO &quot;: $name &quot; &gt;&gt; &quot;$nlist&quot;'
+	          fi
+	          func_to_tool_file &quot;$dlprefile&quot; func_convert_file_msys_to_w32
+	          eval &quot;$NM \&quot;$func_to_tool_file_result\&quot; 2&gt;/dev/null | $global_symbol_pipe |
+	            $SED -e '/I __imp/d' -e 's/I __nm_/D /;s/_nm__//' &gt;&gt; '$nlist'&quot;
+	        }
+	      else # not an import lib
+	        $opt_dry_run || {
+	          eval '$ECHO &quot;: $name &quot; &gt;&gt; &quot;$nlist&quot;'
+	          func_to_tool_file &quot;$dlprefile&quot; func_convert_file_msys_to_w32
+	          eval &quot;$NM \&quot;$func_to_tool_file_result\&quot; 2&gt;/dev/null | $global_symbol_pipe &gt;&gt; '$nlist'&quot;
+	        }
+	      fi
+	    ;;
+	    *)
+	      $opt_dry_run || {
+	        eval '$ECHO &quot;: $name &quot; &gt;&gt; &quot;$nlist&quot;'
+	        func_to_tool_file &quot;$dlprefile&quot; func_convert_file_msys_to_w32
+	        eval &quot;$NM \&quot;$func_to_tool_file_result\&quot; 2&gt;/dev/null | $global_symbol_pipe &gt;&gt; '$nlist'&quot;
+	      }
+	    ;;
+          esac
 	done
 
 	$opt_dry_run || {
@@ -2650,26 +3428,9 @@
   const char *name;
   void *address;
 } lt_dlsymlist;
-&quot;
-	  case $host in
-	  *cygwin* | *mingw* | *cegcc* )
-	    echo &gt;&gt; &quot;$output_objdir/$my_dlsyms&quot; &quot;\
-/* DATA imports from DLLs on WIN32 con't be const, because
-   runtime relocations are performed -- see ld's documentation
-   on pseudo-relocs.  */&quot;
-	    lt_dlsym_const= ;;
-	  *osf5*)
-	    echo &gt;&gt; &quot;$output_objdir/$my_dlsyms&quot; &quot;\
-/* This system does not cope well with relocations in const data */&quot;
-	    lt_dlsym_const= ;;
-	  *)
-	    lt_dlsym_const=const ;;
-	  esac
-
-	  echo &gt;&gt; &quot;$output_objdir/$my_dlsyms&quot; &quot;\
-extern $lt_dlsym_const lt_dlsymlist
+extern LT_DLSYM_CONST lt_dlsymlist
 lt_${my_prefix}_LTX_preloaded_symbols[];
-$lt_dlsym_const lt_dlsymlist
+LT_DLSYM_CONST lt_dlsymlist
 lt_${my_prefix}_LTX_preloaded_symbols[] =
 {\
   { \&quot;$my_originator\&quot;, (void *) 0 },&quot;
@@ -2725,7 +3486,7 @@
 	for arg in $LTCFLAGS; do
 	  case $arg in
 	  -pie | -fpie | -fPIE) ;;
-	  *) symtab_cflags=&quot;$symtab_cflags $arg&quot; ;;
+	  *) func_append symtab_cflags &quot; $arg&quot; ;;
 	  esac
 	done
 
@@ -2788,7 +3549,8 @@
     # Keep the egrep pattern in sync with the one in _LT_CHECK_MAGIC_METHOD.
     if eval $OBJDUMP -f $1 | $SED -e '10q' 2&gt;/dev/null |
        $EGREP 'file format (pei*-i386(.*architecture: i386)?|pe-arm-wince|pe-x86-64)' &gt;/dev/null; then
-      win32_nmres=`eval $NM -f posix -A $1 |
+      func_to_tool_file &quot;$1&quot; func_convert_file_msys_to_w32
+      win32_nmres=`eval $NM -f posix -A \&quot;$func_to_tool_file_result\&quot; |
 	$SED -n -e '
 	    1,100{
 		/ I /{
@@ -2817,8 +3579,133 @@
   $ECHO &quot;$win32_libid_type&quot;
 }
 
+# func_cygming_dll_for_implib ARG
+#
+# Platform-specific function to extract the
+# name of the DLL associated with the specified
+# import library ARG.
+# Invoked by eval'ing the libtool variable
+#    $sharedlib_from_linklib_cmd
+# Result is available in the variable
+#    $sharedlib_from_linklib_result
+func_cygming_dll_for_implib ()
+{
+  $opt_debug
+  sharedlib_from_linklib_result=`$DLLTOOL --identify-strict --identify &quot;$1&quot;`
+}
 
+# func_cygming_dll_for_implib_fallback_core SECTION_NAME LIBNAMEs
+#
+# The is the core of a fallback implementation of a
+# platform-specific function to extract the name of the
+# DLL associated with the specified import library LIBNAME.
+#
+# SECTION_NAME is either .idata$6 or .idata$7, depending
+# on the platform and compiler that created the implib.
+#
+# Echos the name of the DLL associated with the
+# specified import library.
+func_cygming_dll_for_implib_fallback_core ()
+{
+  $opt_debug
+  match_literal=`$ECHO &quot;$1&quot; | $SED &quot;$sed_make_literal_regex&quot;`
+  $OBJDUMP -s --section &quot;$1&quot; &quot;$2&quot; 2&gt;/dev/null |
+    $SED '/^Contents of section '&quot;$match_literal&quot;':/{
+      # Place marker at beginning of archive member dllname section
+      s/.*/====MARK====/
+      p
+      d
+    }
+    # These lines can sometimes be longer than 43 characters, but
+    # are always uninteresting
+    /:[	 ]*file format pe[i]\{,1\}-/d
+    /^In archive [^:]*:/d
+    # Ensure marker is printed
+    /^====MARK====/p
+    # Remove all lines with less than 43 characters
+    /^.\{43\}/!d
+    # From remaining lines, remove first 43 characters
+    s/^.\{43\}//' |
+    $SED -n '
+      # Join marker and all lines until next marker into a single line
+      /^====MARK====/ b para
+      H
+      $ b para
+      b
+      :para
+      x
+      s/\n//g
+      # Remove the marker
+      s/^====MARK====//
+      # Remove trailing dots and whitespace
+      s/[\. \t]*$//
+      # Print
+      /./p' |
+    # we now have a list, one entry per line, of the stringified
+    # contents of the appropriate section of all members of the
+    # archive which possess that section. Heuristic: eliminate
+    # all those which have a first or second character that is
+    # a '.' (that is, objdump's representation of an unprintable
+    # character.) This should work for all archives with less than
+    # 0x302f exports -- but will fail for DLLs whose name actually
+    # begins with a literal '.' or a single character followed by
+    # a '.'.
+    #
+    # Of those that remain, print the first one.
+    $SED -e '/^\./d;/^.\./d;q'
+}
 
+# func_cygming_gnu_implib_p ARG
+# This predicate returns with zero status (TRUE) if
+# ARG is a GNU/binutils-style import library. Returns
+# with nonzero status (FALSE) otherwise.
+func_cygming_gnu_implib_p ()
+{
+  $opt_debug
+  func_to_tool_file &quot;$1&quot; func_convert_file_msys_to_w32
+  func_cygming_gnu_implib_tmp=`$NM &quot;$func_to_tool_file_result&quot; | eval &quot;$global_symbol_pipe&quot; | $EGREP ' (_head_[A-Za-z0-9_]+_[ad]l*|[A-Za-z0-9_]+_[ad]l*_iname)$'`
+  test -n &quot;$func_cygming_gnu_implib_tmp&quot;
+}
+
+# func_cygming_ms_implib_p ARG
+# This predicate returns with zero status (TRUE) if
+# ARG is an MS-style import library. Returns
+# with nonzero status (FALSE) otherwise.
+func_cygming_ms_implib_p ()
+{
+  $opt_debug
+  func_to_tool_file &quot;$1&quot; func_convert_file_msys_to_w32
+  func_cygming_ms_implib_tmp=`$NM &quot;$func_to_tool_file_result&quot; | eval &quot;$global_symbol_pipe&quot; | $GREP '_NULL_IMPORT_DESCRIPTOR'`
+  test -n &quot;$func_cygming_ms_implib_tmp&quot;
+}
+
+# func_cygming_dll_for_implib_fallback ARG
+# Platform-specific function to extract the
+# name of the DLL associated with the specified
+# import library ARG.
+#
+# This fallback implementation is for use when $DLLTOOL
+# does not support the --identify-strict option.
+# Invoked by eval'ing the libtool variable
+#    $sharedlib_from_linklib_cmd
+# Result is available in the variable
+#    $sharedlib_from_linklib_result
+func_cygming_dll_for_implib_fallback ()
+{
+  $opt_debug
+  if func_cygming_gnu_implib_p &quot;$1&quot; ; then
+    # binutils import library
+    sharedlib_from_linklib_result=`func_cygming_dll_for_implib_fallback_core '.idata$7' &quot;$1&quot;`
+  elif func_cygming_ms_implib_p &quot;$1&quot; ; then
+    # ms-generated import library
+    sharedlib_from_linklib_result=`func_cygming_dll_for_implib_fallback_core '.idata$6' &quot;$1&quot;`
+  else
+    # unknown
+    sharedlib_from_linklib_result=&quot;&quot;
+  fi
+}
+
+
 # func_extract_an_archive dir oldlib
 func_extract_an_archive ()
 {
@@ -3195,6 +4082,18 @@
 
   if test -f \&quot;\$progdir/\$program\&quot;; then&quot;
 
+	# fixup the dll searchpath if we need to.
+	#
+	# Fix the DLL searchpath if we need to.  Do this before prepending
+	# to shlibpath, because on Windows, both are PATH and uninstalled
+	# libraries must come first.
+	if test -n &quot;$dllsearchpath&quot;; then
+	  $ECHO &quot;\
+    # Add the dll search path components to the executable PATH
+    PATH=$dllsearchpath:\$PATH
+&quot;
+	fi
+
 	# Export our shlibpath_var if we have one.
 	if test &quot;$shlibpath_overrides_runpath&quot; = yes &amp;&amp; test -n &quot;$shlibpath_var&quot; &amp;&amp; test -n &quot;$temp_rpath&quot;; then
 	  $ECHO &quot;\
@@ -3209,14 +4108,6 @@
 &quot;
 	fi
 
-	# fixup the dll searchpath if we need to.
-	if test -n &quot;$dllsearchpath&quot;; then
-	  $ECHO &quot;\
-    # Add the dll search path components to the executable PATH
-    PATH=$dllsearchpath:\$PATH
-&quot;
-	fi
-
 	$ECHO &quot;\
     if test \&quot;\$libtool_execute_magic\&quot; != \&quot;$magic\&quot;; then
       # Run the actual program with our arguments.
@@ -3234,166 +4125,6 @@
 }
 
 
-# func_to_host_path arg
-#
-# Convert paths to host format when used with build tools.
-# Intended for use with &quot;native&quot; mingw (where libtool itself
-# is running under the msys shell), or in the following cross-
-# build environments:
-#    $build          $host
-#    mingw (msys)    mingw  [e.g. native]
-#    cygwin          mingw
-#    *nix + wine     mingw
-# where wine is equipped with the `winepath' executable.
-# In the native mingw case, the (msys) shell automatically
-# converts paths for any non-msys applications it launches,
-# but that facility isn't available from inside the cwrapper.
-# Similar accommodations are necessary for $host mingw and
-# $build cygwin.  Calling this function does no harm for other
-# $host/$build combinations not listed above.
-#
-# ARG is the path (on $build) that should be converted to
-# the proper representation for $host. The result is stored
-# in $func_to_host_path_result.
-func_to_host_path ()
-{
-  func_to_host_path_result=&quot;$1&quot;
-  if test -n &quot;$1&quot;; then
-    case $host in
-      *mingw* )
-        lt_sed_naive_backslashify='s|\\\\*|\\|g;s|/|\\|g;s|\\|\\\\|g'
-        case $build in
-          *mingw* ) # actually, msys
-            # awkward: cmd appends spaces to result
-            func_to_host_path_result=`( cmd //c echo &quot;$1&quot; ) 2&gt;/dev/null |
-              $SED -e 's/[ ]*$//' -e &quot;$lt_sed_naive_backslashify&quot;`
-            ;;
-          *cygwin* )
-            func_to_host_path_result=`cygpath -w &quot;$1&quot; |
-	      $SED -e &quot;$lt_sed_naive_backslashify&quot;`
-            ;;
-          * )
-            # Unfortunately, winepath does not exit with a non-zero
-            # error code, so we are forced to check the contents of
-            # stdout. On the other hand, if the command is not
-            # found, the shell will set an exit code of 127 and print
-            # *an error message* to stdout. So we must check for both
-            # error code of zero AND non-empty stdout, which explains
-            # the odd construction:
-            func_to_host_path_tmp1=`winepath -w &quot;$1&quot; 2&gt;/dev/null`
-            if test &quot;$?&quot; -eq 0 &amp;&amp; test -n &quot;${func_to_host_path_tmp1}&quot;; then
-              func_to_host_path_result=`$ECHO &quot;$func_to_host_path_tmp1&quot; |
-                $SED -e &quot;$lt_sed_naive_backslashify&quot;`
-            else
-              # Allow warning below.
-              func_to_host_path_result=
-            fi
-            ;;
-        esac
-        if test -z &quot;$func_to_host_path_result&quot; ; then
-          func_error &quot;Could not determine host path corresponding to&quot;
-          func_error &quot;  \`$1'&quot;
-          func_error &quot;Continuing, but uninstalled executables may not work.&quot;
-          # Fallback:
-          func_to_host_path_result=&quot;$1&quot;
-        fi
-        ;;
-    esac
-  fi
-}
-# end: func_to_host_path
-
-# func_to_host_pathlist arg
-#
-# Convert pathlists to host format when used with build tools.
-# See func_to_host_path(), above. This function supports the
-# following $build/$host combinations (but does no harm for
-# combinations not listed here):
-#    $build          $host
-#    mingw (msys)    mingw  [e.g. native]
-#    cygwin          mingw
-#    *nix + wine     mingw
-#
-# Path separators are also converted from $build format to
-# $host format. If ARG begins or ends with a path separator
-# character, it is preserved (but converted to $host format)
-# on output.
-#
-# ARG is a pathlist (on $build) that should be converted to
-# the proper representation on $host. The result is stored
-# in $func_to_host_pathlist_result.
-func_to_host_pathlist ()
-{
-  func_to_host_pathlist_result=&quot;$1&quot;
-  if test -n &quot;$1&quot;; then
-    case $host in
-      *mingw* )
-        lt_sed_naive_backslashify='s|\\\\*|\\|g;s|/|\\|g;s|\\|\\\\|g'
-        # Remove leading and trailing path separator characters from
-        # ARG. msys behavior is inconsistent here, cygpath turns them
-        # into '.;' and ';.', and winepath ignores them completely.
-	func_stripname : : &quot;$1&quot;
-        func_to_host_pathlist_tmp1=$func_stripname_result
-        case $build in
-          *mingw* ) # Actually, msys.
-            # Awkward: cmd appends spaces to result.
-            func_to_host_pathlist_result=`
-	      ( cmd //c echo &quot;$func_to_host_pathlist_tmp1&quot; ) 2&gt;/dev/null |
-	      $SED -e 's/[ ]*$//' -e &quot;$lt_sed_naive_backslashify&quot;`
-            ;;
-          *cygwin* )
-            func_to_host_pathlist_result=`cygpath -w -p &quot;$func_to_host_pathlist_tmp1&quot; |
-              $SED -e &quot;$lt_sed_naive_backslashify&quot;`
-            ;;
-          * )
-            # unfortunately, winepath doesn't convert pathlists
-            func_to_host_pathlist_result=&quot;&quot;
-            func_to_host_pathlist_oldIFS=$IFS
-            IFS=:
-            for func_to_host_pathlist_f in $func_to_host_pathlist_tmp1 ; do
-              IFS=$func_to_host_pathlist_oldIFS
-              if test -n &quot;$func_to_host_pathlist_f&quot; ; then
-                func_to_host_path &quot;$func_to_host_pathlist_f&quot;
-                if test -n &quot;$func_to_host_path_result&quot; ; then
-                  if test -z &quot;$func_to_host_pathlist_result&quot; ; then
-                    func_to_host_pathlist_result=&quot;$func_to_host_path_result&quot;
-                  else
-                    func_append func_to_host_pathlist_result &quot;;$func_to_host_path_result&quot;
-                  fi
-                fi
-              fi
-            done
-            IFS=$func_to_host_pathlist_oldIFS
-            ;;
-        esac
-        if test -z &quot;$func_to_host_pathlist_result&quot;; then
-          func_error &quot;Could not determine the host path(s) corresponding to&quot;
-          func_error &quot;  \`$1'&quot;
-          func_error &quot;Continuing, but uninstalled executables may not work.&quot;
-          # Fallback. This may break if $1 contains DOS-style drive
-          # specifications. The fix is not to complicate the expression
-          # below, but for the user to provide a working wine installation
-          # with winepath so that path translation in the cross-to-mingw
-          # case works properly.
-          lt_replace_pathsep_nix_to_dos=&quot;s|:|;|g&quot;
-          func_to_host_pathlist_result=`echo &quot;$func_to_host_pathlist_tmp1&quot; |\
-            $SED -e &quot;$lt_replace_pathsep_nix_to_dos&quot;`
-        fi
-        # Now, add the leading and trailing path separators back
-        case &quot;$1&quot; in
-          :* ) func_to_host_pathlist_result=&quot;;$func_to_host_pathlist_result&quot;
-            ;;
-        esac
-        case &quot;$1&quot; in
-          *: ) func_append func_to_host_pathlist_result &quot;;&quot;
-            ;;
-        esac
-        ;;
-    esac
-  fi
-}
-# end: func_to_host_pathlist
-
 # func_emit_cwrapperexe_src
 # emit the source code for a wrapper executable on stdout
 # Must ONLY be called from within func_mode_link because
@@ -3563,14 +4294,14 @@
 EOF
 
 	    cat &lt;&lt;EOF
-const char * MAGIC_EXE = &quot;$magic_exe&quot;;
+volatile const char * MAGIC_EXE = &quot;$magic_exe&quot;;
 const char * LIB_PATH_VARNAME = &quot;$shlibpath_var&quot;;
 EOF
 
 	    if test &quot;$shlibpath_overrides_runpath&quot; = yes &amp;&amp; test -n &quot;$shlibpath_var&quot; &amp;&amp; test -n &quot;$temp_rpath&quot;; then
-              func_to_host_pathlist &quot;$temp_rpath&quot;
+              func_to_host_path &quot;$temp_rpath&quot;
 	      cat &lt;&lt;EOF
-const char * LIB_PATH_VALUE   = &quot;$func_to_host_pathlist_result&quot;;
+const char * LIB_PATH_VALUE   = &quot;$func_to_host_path_result&quot;;
 EOF
 	    else
 	      cat &lt;&lt;&quot;EOF&quot;
@@ -3579,10 +4310,10 @@
 	    fi
 
 	    if test -n &quot;$dllsearchpath&quot;; then
-              func_to_host_pathlist &quot;$dllsearchpath:&quot;
+              func_to_host_path &quot;$dllsearchpath:&quot;
 	      cat &lt;&lt;EOF
 const char * EXE_PATH_VARNAME = &quot;PATH&quot;;
-const char * EXE_PATH_VALUE   = &quot;$func_to_host_pathlist_result&quot;;
+const char * EXE_PATH_VALUE   = &quot;$func_to_host_path_result&quot;;
 EOF
 	    else
 	      cat &lt;&lt;&quot;EOF&quot;
@@ -3765,8 +4496,12 @@
 
   lt_setenv (&quot;BIN_SH&quot;, &quot;xpg4&quot;); /* for Tru64 */
   lt_setenv (&quot;DUALCASE&quot;, &quot;1&quot;);  /* for MSK sh */
+  /* Update the DLL searchpath.  EXE_PATH_VALUE ($dllsearchpath) must
+     be prepended before (that is, appear after) LIB_PATH_VALUE ($temp_rpath)
+     because on Windows, both *_VARNAMEs are PATH but uninstalled
+     libraries must come first. */
+  lt_update_exe_path (EXE_PATH_VARNAME, EXE_PATH_VALUE);
   lt_update_lib_path (LIB_PATH_VARNAME, LIB_PATH_VALUE);
-  lt_update_exe_path (EXE_PATH_VARNAME, EXE_PATH_VALUE);
 
   lt_debugprintf (__FILE__, __LINE__, &quot;(main) lt_argv_zero: %s\n&quot;,
 		  nonnull (lt_argv_zero));
@@ -4515,9 +5250,9 @@
 	    ;;
 	  *)
 	    if test &quot;$prev&quot; = dlfiles; then
-	      dlfiles=&quot;$dlfiles $arg&quot;
+	      func_append dlfiles &quot; $arg&quot;
 	    else
-	      dlprefiles=&quot;$dlprefiles $arg&quot;
+	      func_append dlprefiles &quot; $arg&quot;
 	    fi
 	    prev=
 	    continue
@@ -4541,7 +5276,7 @@
 	    *-*-darwin*)
 	      case &quot;$deplibs &quot; in
 		*&quot; $qarg.ltframework &quot;*) ;;
-		*) deplibs=&quot;$deplibs $qarg.ltframework&quot; # this is fixed later
+		*) func_append deplibs &quot; $qarg.ltframework&quot; # this is fixed later
 		   ;;
 	      esac
 	      ;;
@@ -4560,7 +5295,7 @@
 	    moreargs=
 	    for fil in `cat &quot;$save_arg&quot;`
 	    do
-#	      moreargs=&quot;$moreargs $fil&quot;
+#	      func_append moreargs &quot; $fil&quot;
 	      arg=$fil
 	      # A libtool-controlled object.
 
@@ -4589,7 +5324,7 @@
 
 		  if test &quot;$prev&quot; = dlfiles; then
 		    if test &quot;$build_libtool_libs&quot; = yes &amp;&amp; test &quot;$dlopen_support&quot; = yes; then
-		      dlfiles=&quot;$dlfiles $pic_object&quot;
+		      func_append dlfiles &quot; $pic_object&quot;
 		      prev=
 		      continue
 		    else
@@ -4601,7 +5336,7 @@
 		  # CHECK ME:  I think I busted this.  -Ossama
 		  if test &quot;$prev&quot; = dlprefiles; then
 		    # Preload the old-style object.
-		    dlprefiles=&quot;$dlprefiles $pic_object&quot;
+		    func_append dlprefiles &quot; $pic_object&quot;
 		    prev=
 		  fi
 
@@ -4671,12 +5406,12 @@
 	  if test &quot;$prev&quot; = rpath; then
 	    case &quot;$rpath &quot; in
 	    *&quot; $arg &quot;*) ;;
-	    *) rpath=&quot;$rpath $arg&quot; ;;
+	    *) func_append rpath &quot; $arg&quot; ;;
 	    esac
 	  else
 	    case &quot;$xrpath &quot; in
 	    *&quot; $arg &quot;*) ;;
-	    *) xrpath=&quot;$xrpath $arg&quot; ;;
+	    *) func_append xrpath &quot; $arg&quot; ;;
 	    esac
 	  fi
 	  prev=
@@ -4688,28 +5423,28 @@
 	  continue
 	  ;;
 	weak)
-	  weak_libs=&quot;$weak_libs $arg&quot;
+	  func_append weak_libs &quot; $arg&quot;
 	  prev=
 	  continue
 	  ;;
 	xcclinker)
-	  linker_flags=&quot;$linker_flags $qarg&quot;
-	  compiler_flags=&quot;$compiler_flags $qarg&quot;
+	  func_append linker_flags &quot; $qarg&quot;
+	  func_append compiler_flags &quot; $qarg&quot;
 	  prev=
 	  func_append compile_command &quot; $qarg&quot;
 	  func_append finalize_command &quot; $qarg&quot;
 	  continue
 	  ;;
 	xcompiler)
-	  compiler_flags=&quot;$compiler_flags $qarg&quot;
+	  func_append compiler_flags &quot; $qarg&quot;
 	  prev=
 	  func_append compile_command &quot; $qarg&quot;
 	  func_append finalize_command &quot; $qarg&quot;
 	  continue
 	  ;;
 	xlinker)
-	  linker_flags=&quot;$linker_flags $qarg&quot;
-	  compiler_flags=&quot;$compiler_flags $wl$qarg&quot;
+	  func_append linker_flags &quot; $qarg&quot;
+	  func_append compiler_flags &quot; $wl$qarg&quot;
 	  prev=
 	  func_append compile_command &quot; $wl$qarg&quot;
 	  func_append finalize_command &quot; $wl$qarg&quot;
@@ -4800,15 +5535,16 @@
 	;;
 
       -L*)
-	func_stripname '-L' '' &quot;$arg&quot;
-	dir=$func_stripname_result
-	if test -z &quot;$dir&quot;; then
+	func_stripname &quot;-L&quot; '' &quot;$arg&quot;
+	if test -z &quot;$func_stripname_result&quot;; then
 	  if test &quot;$#&quot; -gt 0; then
 	    func_fatal_error &quot;require no space between \`-L' and \`$1'&quot;
 	  else
 	    func_fatal_error &quot;need path for \`-L' option&quot;
 	  fi
 	fi
+	func_resolve_sysroot &quot;$func_stripname_result&quot;
+	dir=$func_resolve_sysroot_result
 	# We need an absolute path.
 	case $dir in
 	[\\/]* | [A-Za-z]:[\\/]*) ;;
@@ -4820,10 +5556,16 @@
 	  ;;
 	esac
 	case &quot;$deplibs &quot; in
-	*&quot; -L$dir &quot;*) ;;
+	*&quot; -L$dir &quot;* | *&quot; $arg &quot;*)
+	  # Will only happen for absolute or sysroot arguments
+	  ;;
 	*)
-	  deplibs=&quot;$deplibs -L$dir&quot;
-	  lib_search_path=&quot;$lib_search_path $dir&quot;
+	  # Preserve sysroot, but never include relative directories
+	  case $dir in
+	    [\\/]* | [A-Za-z]:[\\/]* | =*) func_append deplibs &quot; $arg&quot; ;;
+	    *) func_append deplibs &quot; -L$dir&quot; ;;
+	  esac
+	  func_append lib_search_path &quot; $dir&quot;
 	  ;;
 	esac
 	case $host in
@@ -4832,12 +5574,12 @@
 	  case :$dllsearchpath: in
 	  *&quot;:$dir:&quot;*) ;;
 	  ::) dllsearchpath=$dir;;
-	  *) dllsearchpath=&quot;$dllsearchpath:$dir&quot;;;
+	  *) func_append dllsearchpath &quot;:$dir&quot;;;
 	  esac
 	  case :$dllsearchpath: in
 	  *&quot;:$testbindir:&quot;*) ;;
 	  ::) dllsearchpath=$testbindir;;
-	  *) dllsearchpath=&quot;$dllsearchpath:$testbindir&quot;;;
+	  *) func_append dllsearchpath &quot;:$testbindir&quot;;;
 	  esac
 	  ;;
 	esac
@@ -4861,7 +5603,7 @@
 	    ;;
 	  *-*-rhapsody* | *-*-darwin1.[012])
 	    # Rhapsody C and math libraries are in the System framework
-	    deplibs=&quot;$deplibs System.ltframework&quot;
+	    func_append deplibs &quot; System.ltframework&quot;
 	    continue
 	    ;;
 	  *-*-sco3.2v5* | *-*-sco5v6*)
@@ -4881,7 +5623,7 @@
 	   ;;
 	 esac
 	fi
-	deplibs=&quot;$deplibs $arg&quot;
+	func_append deplibs &quot; $arg&quot;
 	continue
 	;;
 
@@ -4893,8 +5635,8 @@
       # Tru64 UNIX uses -model [arg] to determine the layout of C++
       # classes, name mangling, and exception handling.
       # Darwin uses the -arch flag to determine output architecture.
-      -model|-arch|-isysroot)
-	compiler_flags=&quot;$compiler_flags $arg&quot;
+      -model|-arch|-isysroot|--sysroot)
+	func_append compiler_flags &quot; $arg&quot;
 	func_append compile_command &quot; $arg&quot;
 	func_append finalize_command &quot; $arg&quot;
 	prev=xcompiler
@@ -4902,12 +5644,12 @@
 	;;
 
       -mt|-mthreads|-kthread|-Kthread|-pthread|-pthreads|--thread-safe|-threads)
-	compiler_flags=&quot;$compiler_flags $arg&quot;
+	func_append compiler_flags &quot; $arg&quot;
 	func_append compile_command &quot; $arg&quot;
 	func_append finalize_command &quot; $arg&quot;
 	case &quot;$new_inherited_linker_flags &quot; in
 	    *&quot; $arg &quot;*) ;;
-	    * ) new_inherited_linker_flags=&quot;$new_inherited_linker_flags $arg&quot; ;;
+	    * ) func_append new_inherited_linker_flags &quot; $arg&quot; ;;
 	esac
 	continue
 	;;
@@ -4974,13 +5716,17 @@
 	# We need an absolute path.
 	case $dir in
 	[\\/]* | [A-Za-z]:[\\/]*) ;;
+	=*)
+	  func_stripname '=' '' &quot;$dir&quot;
+	  dir=$lt_sysroot$func_stripname_result
+	  ;;
 	*)
 	  func_fatal_error &quot;only absolute run-paths are allowed&quot;
 	  ;;
 	esac
 	case &quot;$xrpath &quot; in
 	*&quot; $dir &quot;*) ;;
-	*) xrpath=&quot;$xrpath $dir&quot; ;;
+	*) func_append xrpath &quot; $dir&quot; ;;
 	esac
 	continue
 	;;
@@ -5033,8 +5779,8 @@
 	for flag in $args; do
 	  IFS=&quot;$save_ifs&quot;
           func_quote_for_eval &quot;$flag&quot;
-	  arg=&quot;$arg $func_quote_for_eval_result&quot;
-	  compiler_flags=&quot;$compiler_flags $func_quote_for_eval_result&quot;
+	  func_append arg &quot; $func_quote_for_eval_result&quot;
+	  func_append compiler_flags &quot; $func_quote_for_eval_result&quot;
 	done
 	IFS=&quot;$save_ifs&quot;
 	func_stripname ' ' '' &quot;$arg&quot;
@@ -5054,9 +5800,9 @@
 	for flag in $args; do
 	  IFS=&quot;$save_ifs&quot;
           func_quote_for_eval &quot;$flag&quot;
-	  arg=&quot;$arg $wl$func_quote_for_eval_result&quot;
-	  compiler_flags=&quot;$compiler_flags $wl$func_quote_for_eval_result&quot;
-	  linker_flags=&quot;$linker_flags $func_quote_for_eval_result&quot;
+	  func_append arg &quot; $wl$func_quote_for_eval_result&quot;
+	  func_append compiler_flags &quot; $wl$func_quote_for_eval_result&quot;
+	  func_append linker_flags &quot; $func_quote_for_eval_result&quot;
 	done
 	IFS=&quot;$save_ifs&quot;
 	func_stripname ' ' '' &quot;$arg&quot;
@@ -5095,13 +5841,16 @@
       # -p, -pg, --coverage, -fprofile-*  profiling flags for GCC
       # @file                GCC response files
       # -tp=*                Portland pgcc target processor selection
+      # --sysroot=*          for sysroot support
+      # -O*, -flto*, -fwhopr*, -fuse-linker-plugin GCC link-time optimization
       -64|-mips[0-9]|-r[0-9][0-9]*|-xarch=*|-xtarget=*|+DA*|+DD*|-q*|-m*| \
-      -t[45]*|-txscale*|-p|-pg|--coverage|-fprofile-*|-F*|@*|-tp=*)
+      -t[45]*|-txscale*|-p|-pg|--coverage|-fprofile-*|-F*|@*|-tp=*|--sysroot=*| \
+      -O*|-flto*|-fwhopr*|-fuse-linker-plugin)
         func_quote_for_eval &quot;$arg&quot;
 	arg=&quot;$func_quote_for_eval_result&quot;
         func_append compile_command &quot; $arg&quot;
         func_append finalize_command &quot; $arg&quot;
-        compiler_flags=&quot;$compiler_flags $arg&quot;
+        func_append compiler_flags &quot; $arg&quot;
         continue
         ;;
 
@@ -5113,7 +5862,7 @@
 
       *.$objext)
 	# A standard object.
-	objs=&quot;$objs $arg&quot;
+	func_append objs &quot; $arg&quot;
 	;;
 
       *.lo)
@@ -5144,7 +5893,7 @@
 
 	    if test &quot;$prev&quot; = dlfiles; then
 	      if test &quot;$build_libtool_libs&quot; = yes &amp;&amp; test &quot;$dlopen_support&quot; = yes; then
-		dlfiles=&quot;$dlfiles $pic_object&quot;
+		func_append dlfiles &quot; $pic_object&quot;
 		prev=
 		continue
 	      else
@@ -5156,7 +5905,7 @@
 	    # CHECK ME:  I think I busted this.  -Ossama
 	    if test &quot;$prev&quot; = dlprefiles; then
 	      # Preload the old-style object.
-	      dlprefiles=&quot;$dlprefiles $pic_object&quot;
+	      func_append dlprefiles &quot; $pic_object&quot;
 	      prev=
 	    fi
 
@@ -5201,24 +5950,25 @@
 
       *.$libext)
 	# An archive.
-	deplibs=&quot;$deplibs $arg&quot;
-	old_deplibs=&quot;$old_deplibs $arg&quot;
+	func_append deplibs &quot; $arg&quot;
+	func_append old_deplibs &quot; $arg&quot;
 	continue
 	;;
 
       *.la)
 	# A libtool-controlled library.
 
+	func_resolve_sysroot &quot;$arg&quot;
 	if test &quot;$prev&quot; = dlfiles; then
 	  # This library was specified with -dlopen.
-	  dlfiles=&quot;$dlfiles $arg&quot;
+	  func_append dlfiles &quot; $func_resolve_sysroot_result&quot;
 	  prev=
 	elif test &quot;$prev&quot; = dlprefiles; then
 	  # The library was specified with -dlpreopen.
-	  dlprefiles=&quot;$dlprefiles $arg&quot;
+	  func_append dlprefiles &quot; $func_resolve_sysroot_result&quot;
 	  prev=
 	else
-	  deplibs=&quot;$deplibs $arg&quot;
+	  func_append deplibs &quot; $func_resolve_sysroot_result&quot;
 	fi
 	continue
 	;;
@@ -5265,6 +6015,8 @@
 
     func_dirname &quot;$output&quot; &quot;/&quot; &quot;&quot;
     output_objdir=&quot;$func_dirname_result$objdir&quot;
+    func_to_tool_file &quot;$output_objdir/&quot;
+    tool_output_objdir=$func_to_tool_file_result
     # Create the object directory.
     func_mkdir_p &quot;$output_objdir&quot;
 
@@ -5285,12 +6037,12 @@
     # Find all interdependent deplibs by searching for libraries
     # that are linked more than once (e.g. -la -lb -la)
     for deplib in $deplibs; do
-      if $opt_duplicate_deps ; then
+      if $opt_preserve_dup_deps ; then
 	case &quot;$libs &quot; in
-	*&quot; $deplib &quot;*) specialdeplibs=&quot;$specialdeplibs $deplib&quot; ;;
+	*&quot; $deplib &quot;*) func_append specialdeplibs &quot; $deplib&quot; ;;
 	esac
       fi
-      libs=&quot;$libs $deplib&quot;
+      func_append libs &quot; $deplib&quot;
     done
 
     if test &quot;$linkmode&quot; = lib; then
@@ -5303,9 +6055,9 @@
       if $opt_duplicate_compiler_generated_deps; then
 	for pre_post_dep in $predeps $postdeps; do
 	  case &quot;$pre_post_deps &quot; in
-	  *&quot; $pre_post_dep &quot;*) specialdeplibs=&quot;$specialdeplibs $pre_post_deps&quot; ;;
+	  *&quot; $pre_post_dep &quot;*) func_append specialdeplibs &quot; $pre_post_deps&quot; ;;
 	  esac
-	  pre_post_deps=&quot;$pre_post_deps $pre_post_dep&quot;
+	  func_append pre_post_deps &quot; $pre_post_dep&quot;
 	done
       fi
       pre_post_deps=
@@ -5372,8 +6124,9 @@
 	for lib in $dlprefiles; do
 	  # Ignore non-libtool-libs
 	  dependency_libs=
+	  func_resolve_sysroot &quot;$lib&quot;
 	  case $lib in
-	  *.la)	func_source &quot;$lib&quot; ;;
+	  *.la)	func_source &quot;$func_resolve_sysroot_result&quot; ;;
 	  esac
 
 	  # Collect preopened libtool deplibs, except any this library
@@ -5383,7 +6136,7 @@
             deplib_base=$func_basename_result
 	    case &quot; $weak_libs &quot; in
 	    *&quot; $deplib_base &quot;*) ;;
-	    *) deplibs=&quot;$deplibs $deplib&quot; ;;
+	    *) func_append deplibs &quot; $deplib&quot; ;;
 	    esac
 	  done
 	done
@@ -5413,11 +6166,11 @@
 	    compile_deplibs=&quot;$deplib $compile_deplibs&quot;
 	    finalize_deplibs=&quot;$deplib $finalize_deplibs&quot;
 	  else
-	    compiler_flags=&quot;$compiler_flags $deplib&quot;
+	    func_append compiler_flags &quot; $deplib&quot;
 	    if test &quot;$linkmode&quot; = lib ; then
 		case &quot;$new_inherited_linker_flags &quot; in
 		    *&quot; $deplib &quot;*) ;;
-		    * ) new_inherited_linker_flags=&quot;$new_inherited_linker_flags $deplib&quot; ;;
+		    * ) func_append new_inherited_linker_flags &quot; $deplib&quot; ;;
 		esac
 	    fi
 	  fi
@@ -5502,7 +6255,7 @@
 	    if test &quot;$linkmode&quot; = lib ; then
 		case &quot;$new_inherited_linker_flags &quot; in
 		    *&quot; $deplib &quot;*) ;;
-		    * ) new_inherited_linker_flags=&quot;$new_inherited_linker_flags $deplib&quot; ;;
+		    * ) func_append new_inherited_linker_flags &quot; $deplib&quot; ;;
 		esac
 	    fi
 	  fi
@@ -5515,7 +6268,8 @@
 	    test &quot;$pass&quot; = conv &amp;&amp; continue
 	    newdependency_libs=&quot;$deplib $newdependency_libs&quot;
 	    func_stripname '-L' '' &quot;$deplib&quot;
-	    newlib_search_path=&quot;$newlib_search_path $func_stripname_result&quot;
+	    func_resolve_sysroot &quot;$func_stripname_result&quot;
+	    func_append newlib_search_path &quot; $func_resolve_sysroot_result&quot;
 	    ;;
 	  prog)
 	    if test &quot;$pass&quot; = conv; then
@@ -5529,7 +6283,8 @@
 	      finalize_deplibs=&quot;$deplib $finalize_deplibs&quot;
 	    fi
 	    func_stripname '-L' '' &quot;$deplib&quot;
-	    newlib_search_path=&quot;$newlib_search_path $func_stripname_result&quot;
+	    func_resolve_sysroot &quot;$func_stripname_result&quot;
+	    func_append newlib_search_path &quot; $func_resolve_sysroot_result&quot;
 	    ;;
 	  *)
 	    func_warning &quot;\`-L' is ignored for archives/objects&quot;
@@ -5540,17 +6295,21 @@
 	-R*)
 	  if test &quot;$pass&quot; = link; then
 	    func_stripname '-R' '' &quot;$deplib&quot;
-	    dir=$func_stripname_result
+	    func_resolve_sysroot &quot;$func_stripname_result&quot;
+	    dir=$func_resolve_sysroot_result
 	    # Make sure the xrpath contains only unique directories.
 	    case &quot;$xrpath &quot; in
 	    *&quot; $dir &quot;*) ;;
-	    *) xrpath=&quot;$xrpath $dir&quot; ;;
+	    *) func_append xrpath &quot; $dir&quot; ;;
 	    esac
 	  fi
 	  deplibs=&quot;$deplib $deplibs&quot;
 	  continue
 	  ;;
-	*.la) lib=&quot;$deplib&quot; ;;
+	*.la)
+	  func_resolve_sysroot &quot;$deplib&quot;
+	  lib=$func_resolve_sysroot_result
+	  ;;
 	*.$libext)
 	  if test &quot;$pass&quot; = conv; then
 	    deplibs=&quot;$deplib $deplibs&quot;
@@ -5613,11 +6372,11 @@
 	    if test &quot;$pass&quot; = dlpreopen || test &quot;$dlopen_support&quot; != yes || test &quot;$build_libtool_libs&quot; = no; then
 	      # If there is no dlopen support or we're linking statically,
 	      # we need to preload.
-	      newdlprefiles=&quot;$newdlprefiles $deplib&quot;
+	      func_append newdlprefiles &quot; $deplib&quot;
 	      compile_deplibs=&quot;$deplib $compile_deplibs&quot;
 	      finalize_deplibs=&quot;$deplib $finalize_deplibs&quot;
 	    else
-	      newdlfiles=&quot;$newdlfiles $deplib&quot;
+	      func_append newdlfiles &quot; $deplib&quot;
 	    fi
 	  fi
 	  continue
@@ -5663,7 +6422,7 @@
 	  for tmp_inherited_linker_flag in $tmp_inherited_linker_flags; do
 	    case &quot; $new_inherited_linker_flags &quot; in
 	      *&quot; $tmp_inherited_linker_flag &quot;*) ;;
-	      *) new_inherited_linker_flags=&quot;$new_inherited_linker_flags $tmp_inherited_linker_flag&quot;;;
+	      *) func_append new_inherited_linker_flags &quot; $tmp_inherited_linker_flag&quot;;;
 	    esac
 	  done
 	fi
@@ -5671,8 +6430,8 @@
 	if test &quot;$linkmode,$pass&quot; = &quot;lib,link&quot; ||
 	   test &quot;$linkmode,$pass&quot; = &quot;prog,scan&quot; ||
 	   { test &quot;$linkmode&quot; != prog &amp;&amp; test &quot;$linkmode&quot; != lib; }; then
-	  test -n &quot;$dlopen&quot; &amp;&amp; dlfiles=&quot;$dlfiles $dlopen&quot;
-	  test -n &quot;$dlpreopen&quot; &amp;&amp; dlprefiles=&quot;$dlprefiles $dlpreopen&quot;
+	  test -n &quot;$dlopen&quot; &amp;&amp; func_append dlfiles &quot; $dlopen&quot;
+	  test -n &quot;$dlpreopen&quot; &amp;&amp; func_append dlprefiles &quot; $dlpreopen&quot;
 	fi
 
 	if test &quot;$pass&quot; = conv; then
@@ -5683,20 +6442,20 @@
 	      func_fatal_error &quot;cannot find name of link library for \`$lib'&quot;
 	    fi
 	    # It is a libtool convenience library, so add in its objects.
-	    convenience=&quot;$convenience $ladir/$objdir/$old_library&quot;
-	    old_convenience=&quot;$old_convenience $ladir/$objdir/$old_library&quot;
+	    func_append convenience &quot; $ladir/$objdir/$old_library&quot;
+	    func_append old_convenience &quot; $ladir/$objdir/$old_library&quot;
 	  elif test &quot;$linkmode&quot; != prog &amp;&amp; test &quot;$linkmode&quot; != lib; then
 	    func_fatal_error &quot;\`$lib' is not a convenience library&quot;
 	  fi
 	  tmp_libs=
 	  for deplib in $dependency_libs; do
 	    deplibs=&quot;$deplib $deplibs&quot;
-	    if $opt_duplicate_deps ; then
+	    if $opt_preserve_dup_deps ; then
 	      case &quot;$tmp_libs &quot; in
-	      *&quot; $deplib &quot;*) specialdeplibs=&quot;$specialdeplibs $deplib&quot; ;;
+	      *&quot; $deplib &quot;*) func_append specialdeplibs &quot; $deplib&quot; ;;
 	      esac
 	    fi
-	    tmp_libs=&quot;$tmp_libs $deplib&quot;
+	    func_append tmp_libs &quot; $deplib&quot;
 	  done
 	  continue
 	fi # $pass = conv
@@ -5704,9 +6463,15 @@
 
 	# Get the name of the library we link against.
 	linklib=
-	for l in $old_library $library_names; do
-	  linklib=&quot;$l&quot;
-	done
+	if test -n &quot;$old_library&quot; &amp;&amp;
+	   { test &quot;$prefer_static_libs&quot; = yes ||
+	     test &quot;$prefer_static_libs,$installed&quot; = &quot;built,no&quot;; }; then
+	  linklib=$old_library
+	else
+	  for l in $old_library $library_names; do
+	    linklib=&quot;$l&quot;
+	  done
+	fi
 	if test -z &quot;$linklib&quot;; then
 	  func_fatal_error &quot;cannot find name of link library for \`$lib'&quot;
 	fi
@@ -5723,9 +6488,9 @@
 	    # statically, we need to preload.  We also need to preload any
 	    # dependent libraries so libltdl's deplib preloader doesn't
 	    # bomb out in the load deplibs phase.
-	    dlprefiles=&quot;$dlprefiles $lib $dependency_libs&quot;
+	    func_append dlprefiles &quot; $lib $dependency_libs&quot;
 	  else
-	    newdlfiles=&quot;$newdlfiles $lib&quot;
+	    func_append newdlfiles &quot; $lib&quot;
 	  fi
 	  continue
 	fi # $pass = dlopen
@@ -5747,14 +6512,14 @@
 
 	# Find the relevant object directory and library name.
 	if test &quot;X$installed&quot; = Xyes; then
-	  if test ! -f &quot;$libdir/$linklib&quot; &amp;&amp; test -f &quot;$abs_ladir/$linklib&quot;; then
+	  if test ! -f &quot;$lt_sysroot$libdir/$linklib&quot; &amp;&amp; test -f &quot;$abs_ladir/$linklib&quot;; then
 	    func_warning &quot;library \`$lib' was moved.&quot;
 	    dir=&quot;$ladir&quot;
 	    absdir=&quot;$abs_ladir&quot;
 	    libdir=&quot;$abs_ladir&quot;
 	  else
-	    dir=&quot;$libdir&quot;
-	    absdir=&quot;$libdir&quot;
+	    dir=&quot;$lt_sysroot$libdir&quot;
+	    absdir=&quot;$lt_sysroot$libdir&quot;
 	  fi
 	  test &quot;X$hardcode_automatic&quot; = Xyes &amp;&amp; avoidtemprpath=yes
 	else
@@ -5762,12 +6527,12 @@
 	    dir=&quot;$ladir&quot;
 	    absdir=&quot;$abs_ladir&quot;
 	    # Remove this search path later
-	    notinst_path=&quot;$notinst_path $abs_ladir&quot;
+	    func_append notinst_path &quot; $abs_ladir&quot;
 	  else
 	    dir=&quot;$ladir/$objdir&quot;
 	    absdir=&quot;$abs_ladir/$objdir&quot;
 	    # Remove this search path later
-	    notinst_path=&quot;$notinst_path $abs_ladir&quot;
+	    func_append notinst_path &quot; $abs_ladir&quot;
 	  fi
 	fi # $installed = yes
 	func_stripname 'lib' '.la' &quot;$laname&quot;
@@ -5778,20 +6543,46 @@
 	  if test -z &quot;$libdir&quot; &amp;&amp; test &quot;$linkmode&quot; = prog; then
 	    func_fatal_error &quot;only libraries may -dlpreopen a convenience library: \`$lib'&quot;
 	  fi
-	  # Prefer using a static library (so that no silly _DYNAMIC symbols
-	  # are required to link).
-	  if test -n &quot;$old_library&quot;; then
-	    newdlprefiles=&quot;$newdlprefiles $dir/$old_library&quot;
-	    # Keep a list of preopened convenience libraries to check
-	    # that they are being used correctly in the link pass.
-	    test -z &quot;$libdir&quot; &amp;&amp; \
-		dlpreconveniencelibs=&quot;$dlpreconveniencelibs $dir/$old_library&quot;
-	  # Otherwise, use the dlname, so that lt_dlopen finds it.
-	  elif test -n &quot;$dlname&quot;; then
-	    newdlprefiles=&quot;$newdlprefiles $dir/$dlname&quot;
-	  else
-	    newdlprefiles=&quot;$newdlprefiles $dir/$linklib&quot;
-	  fi
+	  case &quot;$host&quot; in
+	    # special handling for platforms with PE-DLLs.
+	    *cygwin* | *mingw* | *cegcc* )
+	      # Linker will automatically link against shared library if both
+	      # static and shared are present.  Therefore, ensure we extract
+	      # symbols from the import library if a shared library is present
+	      # (otherwise, the dlopen module name will be incorrect).  We do
+	      # this by putting the import library name into $newdlprefiles.
+	      # We recover the dlopen module name by 'saving' the la file
+	      # name in a special purpose variable, and (later) extracting the
+	      # dlname from the la file.
+	      if test -n &quot;$dlname&quot;; then
+	        func_tr_sh &quot;$dir/$linklib&quot;
+	        eval &quot;libfile_$func_tr_sh_result=\$abs_ladir/\$laname&quot;
+	        func_append newdlprefiles &quot; $dir/$linklib&quot;
+	      else
+	        func_append newdlprefiles &quot; $dir/$old_library&quot;
+	        # Keep a list of preopened convenience libraries to check
+	        # that they are being used correctly in the link pass.
+	        test -z &quot;$libdir&quot; &amp;&amp; \
+	          func_append dlpreconveniencelibs &quot; $dir/$old_library&quot;
+	      fi
+	    ;;
+	    * )
+	      # Prefer using a static library (so that no silly _DYNAMIC symbols
+	      # are required to link).
+	      if test -n &quot;$old_library&quot;; then
+	        func_append newdlprefiles &quot; $dir/$old_library&quot;
+	        # Keep a list of preopened convenience libraries to check
+	        # that they are being used correctly in the link pass.
+	        test -z &quot;$libdir&quot; &amp;&amp; \
+	          func_append dlpreconveniencelibs &quot; $dir/$old_library&quot;
+	      # Otherwise, use the dlname, so that lt_dlopen finds it.
+	      elif test -n &quot;$dlname&quot;; then
+	        func_append newdlprefiles &quot; $dir/$dlname&quot;
+	      else
+	        func_append newdlprefiles &quot; $dir/$linklib&quot;
+	      fi
+	    ;;
+	  esac
 	fi # $pass = dlpreopen
 
 	if test -z &quot;$libdir&quot;; then
@@ -5809,7 +6600,7 @@
 
 
 	if test &quot;$linkmode&quot; = prog &amp;&amp; test &quot;$pass&quot; != link; then
-	  newlib_search_path=&quot;$newlib_search_path $ladir&quot;
+	  func_append newlib_search_path &quot; $ladir&quot;
 	  deplibs=&quot;$lib $deplibs&quot;
 
 	  linkalldeplibs=no
@@ -5822,7 +6613,8 @@
 	  for deplib in $dependency_libs; do
 	    case $deplib in
 	    -L*) func_stripname '-L' '' &quot;$deplib&quot;
-	         newlib_search_path=&quot;$newlib_search_path $func_stripname_result&quot;
+	         func_resolve_sysroot &quot;$func_stripname_result&quot;
+	         func_append newlib_search_path &quot; $func_resolve_sysroot_result&quot;
 		 ;;
 	    esac
 	    # Need to link against all dependency_libs?
@@ -5833,12 +6625,12 @@
 	      # or/and link against static libraries
 	      newdependency_libs=&quot;$deplib $newdependency_libs&quot;
 	    fi
-	    if $opt_duplicate_deps ; then
+	    if $opt_preserve_dup_deps ; then
 	      case &quot;$tmp_libs &quot; in
-	      *&quot; $deplib &quot;*) specialdeplibs=&quot;$specialdeplibs $deplib&quot; ;;
+	      *&quot; $deplib &quot;*) func_append specialdeplibs &quot; $deplib&quot; ;;
 	      esac
 	    fi
-	    tmp_libs=&quot;$tmp_libs $deplib&quot;
+	    func_append tmp_libs &quot; $deplib&quot;
 	  done # for deplib
 	  continue
 	fi # $linkmode = prog...
@@ -5853,7 +6645,7 @@
 	      # Make sure the rpath contains only unique directories.
 	      case &quot;$temp_rpath:&quot; in
 	      *&quot;$absdir:&quot;*) ;;
-	      *) temp_rpath=&quot;$temp_rpath$absdir:&quot; ;;
+	      *) func_append temp_rpath &quot;$absdir:&quot; ;;
 	      esac
 	    fi
 
@@ -5865,7 +6657,7 @@
 	    *)
 	      case &quot;$compile_rpath &quot; in
 	      *&quot; $absdir &quot;*) ;;
-	      *) compile_rpath=&quot;$compile_rpath $absdir&quot;
+	      *) func_append compile_rpath &quot; $absdir&quot; ;;
 	      esac
 	      ;;
 	    esac
@@ -5874,7 +6666,7 @@
 	    *)
 	      case &quot;$finalize_rpath &quot; in
 	      *&quot; $libdir &quot;*) ;;
-	      *) finalize_rpath=&quot;$finalize_rpath $libdir&quot;
+	      *) func_append finalize_rpath &quot; $libdir&quot; ;;
 	      esac
 	      ;;
 	    esac
@@ -5899,12 +6691,12 @@
 	  case $host in
 	  *cygwin* | *mingw* | *cegcc*)
 	      # No point in relinking DLLs because paths are not encoded
-	      notinst_deplibs=&quot;$notinst_deplibs $lib&quot;
+	      func_append notinst_deplibs &quot; $lib&quot;
 	      need_relink=no
 	    ;;
 	  *)
 	    if test &quot;$installed&quot; = no; then
-	      notinst_deplibs=&quot;$notinst_deplibs $lib&quot;
+	      func_append notinst_deplibs &quot; $lib&quot;
 	      need_relink=yes
 	    fi
 	    ;;
@@ -5939,7 +6731,7 @@
 	    *)
 	      case &quot;$compile_rpath &quot; in
 	      *&quot; $absdir &quot;*) ;;
-	      *) compile_rpath=&quot;$compile_rpath $absdir&quot;
+	      *) func_append compile_rpath &quot; $absdir&quot; ;;
 	      esac
 	      ;;
 	    esac
@@ -5948,7 +6740,7 @@
 	    *)
 	      case &quot;$finalize_rpath &quot; in
 	      *&quot; $libdir &quot;*) ;;
-	      *) finalize_rpath=&quot;$finalize_rpath $libdir&quot;
+	      *) func_append finalize_rpath &quot; $libdir&quot; ;;
 	      esac
 	      ;;
 	    esac
@@ -6002,7 +6794,7 @@
 	    linklib=$newlib
 	  fi # test -n &quot;$old_archive_from_expsyms_cmds&quot;
 
-	  if test &quot;$linkmode&quot; = prog || test &quot;$mode&quot; != relink; then
+	  if test &quot;$linkmode&quot; = prog || test &quot;$opt_mode&quot; != relink; then
 	    add_shlibpath=
 	    add_dir=
 	    add=
@@ -6058,7 +6850,7 @@
 		if test -n &quot;$inst_prefix_dir&quot;; then
 		  case $libdir in
 		    [\\/]*)
-		      add_dir=&quot;$add_dir -L$inst_prefix_dir$libdir&quot;
+		      func_append add_dir &quot; -L$inst_prefix_dir$libdir&quot;
 		      ;;
 		  esac
 		fi
@@ -6080,7 +6872,7 @@
 	    if test -n &quot;$add_shlibpath&quot;; then
 	      case :$compile_shlibpath: in
 	      *&quot;:$add_shlibpath:&quot;*) ;;
-	      *) compile_shlibpath=&quot;$compile_shlibpath$add_shlibpath:&quot; ;;
+	      *) func_append compile_shlibpath &quot;$add_shlibpath:&quot; ;;
 	      esac
 	    fi
 	    if test &quot;$linkmode&quot; = prog; then
@@ -6094,13 +6886,13 @@
 		 test &quot;$hardcode_shlibpath_var&quot; = yes; then
 		case :$finalize_shlibpath: in
 		*&quot;:$libdir:&quot;*) ;;
-		*) finalize_shlibpath=&quot;$finalize_shlibpath$libdir:&quot; ;;
+		*) func_append finalize_shlibpath &quot;$libdir:&quot; ;;
 		esac
 	      fi
 	    fi
 	  fi
 
-	  if test &quot;$linkmode&quot; = prog || test &quot;$mode&quot; = relink; then
+	  if test &quot;$linkmode&quot; = prog || test &quot;$opt_mode&quot; = relink; then
 	    add_shlibpath=
 	    add_dir=
 	    add=
@@ -6114,7 +6906,7 @@
 	    elif test &quot;$hardcode_shlibpath_var&quot; = yes; then
 	      case :$finalize_shlibpath: in
 	      *&quot;:$libdir:&quot;*) ;;
-	      *) finalize_shlibpath=&quot;$finalize_shlibpath$libdir:&quot; ;;
+	      *) func_append finalize_shlibpath &quot;$libdir:&quot; ;;
 	      esac
 	      add=&quot;-l$name&quot;
 	    elif test &quot;$hardcode_automatic&quot; = yes; then
@@ -6131,7 +6923,7 @@
 	      if test -n &quot;$inst_prefix_dir&quot;; then
 		case $libdir in
 		  [\\/]*)
-		    add_dir=&quot;$add_dir -L$inst_prefix_dir$libdir&quot;
+		    func_append add_dir &quot; -L$inst_prefix_dir$libdir&quot;
 		    ;;
 		esac
 	      fi
@@ -6208,27 +7000,33 @@
 	           temp_xrpath=$func_stripname_result
 		   case &quot; $xrpath &quot; in
 		   *&quot; $temp_xrpath &quot;*) ;;
-		   *) xrpath=&quot;$xrpath $temp_xrpath&quot;;;
+		   *) func_append xrpath &quot; $temp_xrpath&quot;;;
 		   esac;;
-	      *) temp_deplibs=&quot;$temp_deplibs $libdir&quot;;;
+	      *) func_append temp_deplibs &quot; $libdir&quot;;;
 	      esac
 	    done
 	    dependency_libs=&quot;$temp_deplibs&quot;
 	  fi
 
-	  newlib_search_path=&quot;$newlib_search_path $absdir&quot;
+	  func_append newlib_search_path &quot; $absdir&quot;
 	  # Link against this library
 	  test &quot;$link_static&quot; = no &amp;&amp; newdependency_libs=&quot;$abs_ladir/$laname $newdependency_libs&quot;
 	  # ... and its dependency_libs
 	  tmp_libs=
 	  for deplib in $dependency_libs; do
 	    newdependency_libs=&quot;$deplib $newdependency_libs&quot;
-	    if $opt_duplicate_deps ; then
+	    case $deplib in
+              -L*) func_stripname '-L' '' &quot;$deplib&quot;
+                   func_resolve_sysroot &quot;$func_stripname_result&quot;;;
+              *) func_resolve_sysroot &quot;$deplib&quot; ;;
+            esac
+	    if $opt_preserve_dup_deps ; then
 	      case &quot;$tmp_libs &quot; in
-	      *&quot; $deplib &quot;*) specialdeplibs=&quot;$specialdeplibs $deplib&quot; ;;
+	      *&quot; $func_resolve_sysroot_result &quot;*)
+                func_append specialdeplibs &quot; $func_resolve_sysroot_result&quot; ;;
 	      esac
 	    fi
-	    tmp_libs=&quot;$tmp_libs $deplib&quot;
+	    func_append tmp_libs &quot; $func_resolve_sysroot_result&quot;
 	  done
 
 	  if test &quot;$link_all_deplibs&quot; != no; then
@@ -6238,8 +7036,10 @@
 	      case $deplib in
 	      -L*) path=&quot;$deplib&quot; ;;
 	      *.la)
+	        func_resolve_sysroot &quot;$deplib&quot;
+	        deplib=$func_resolve_sysroot_result
 	        func_dirname &quot;$deplib&quot; &quot;&quot; &quot;.&quot;
-		dir=&quot;$func_dirname_result&quot;
+		dir=$func_dirname_result
 		# We need an absolute path.
 		case $dir in
 		[\\/]* | [A-Za-z]:[\\/]*) absdir=&quot;$dir&quot; ;;
@@ -6266,8 +7066,8 @@
                       if test -z &quot;$darwin_install_name&quot;; then
                           darwin_install_name=`${OTOOL64} -L $depdepl  | awk '{if (NR == 2) {print $1;exit}}'`
                       fi
-		      compiler_flags=&quot;$compiler_flags ${wl}-dylib_file ${wl}${darwin_install_name}:${depdepl}&quot;
-		      linker_flags=&quot;$linker_flags -dylib_file ${darwin_install_name}:${depdepl}&quot;
+		      func_append compiler_flags &quot; ${wl}-dylib_file ${wl}${darwin_install_name}:${depdepl}&quot;
+		      func_append linker_flags &quot; -dylib_file ${darwin_install_name}:${depdepl}&quot;
 		      path=
 		    fi
 		  fi
@@ -6317,7 +7117,7 @@
 	  for dir in $newlib_search_path; do
 	    case &quot;$lib_search_path &quot; in
 	    *&quot; $dir &quot;*) ;;
-	    *) lib_search_path=&quot;$lib_search_path $dir&quot; ;;
+	    *) func_append lib_search_path &quot; $dir&quot; ;;
 	    esac
 	  done
 	  newlib_search_path=
@@ -6375,10 +7175,10 @@
 	    -L*)
 	      case &quot; $tmp_libs &quot; in
 	      *&quot; $deplib &quot;*) ;;
-	      *) tmp_libs=&quot;$tmp_libs $deplib&quot; ;;
+	      *) func_append tmp_libs &quot; $deplib&quot; ;;
 	      esac
 	      ;;
-	    *) tmp_libs=&quot;$tmp_libs $deplib&quot; ;;
+	    *) func_append tmp_libs &quot; $deplib&quot; ;;
 	    esac
 	  done
 	  eval $var=\&quot;$tmp_libs\&quot;
@@ -6394,7 +7194,7 @@
 	  ;;
 	esac
 	if test -n &quot;$i&quot; ; then
-	  tmp_libs=&quot;$tmp_libs $i&quot;
+	  func_append tmp_libs &quot; $i&quot;
 	fi
       done
       dependency_libs=$tmp_libs
@@ -6435,7 +7235,7 @@
       # Now set the variables for building old libraries.
       build_libtool_libs=no
       oldlibs=&quot;$output&quot;
-      objs=&quot;$objs$old_deplibs&quot;
+      func_append objs &quot;$old_deplibs&quot;
       ;;
 
     lib)
@@ -6471,7 +7271,7 @@
 	  echo
 	  $ECHO &quot;*** Warning: Linking the shared library $output against the non-libtool&quot;
 	  $ECHO &quot;*** objects $objs is not portable!&quot;
-	  libobjs=&quot;$libobjs $objs&quot;
+	  func_append libobjs &quot; $objs&quot;
 	fi
       fi
 
@@ -6669,7 +7469,7 @@
 	  done
 
 	  # Make executables depend on our current version.
-	  verstring=&quot;$verstring:${current}.0&quot;
+	  func_append verstring &quot;:${current}.0&quot;
 	  ;;
 
 	qnx)
@@ -6737,10 +7537,10 @@
       fi
 
       func_generate_dlsyms &quot;$libname&quot; &quot;$libname&quot; &quot;yes&quot;
-      libobjs=&quot;$libobjs $symfileobj&quot;
+      func_append libobjs &quot; $symfileobj&quot;
       test &quot;X$libobjs&quot; = &quot;X &quot; &amp;&amp; libobjs=
 
-      if test &quot;$mode&quot; != relink; then
+      if test &quot;$opt_mode&quot; != relink; then
 	# Remove our outputs, but don't remove object files since they
 	# may have been created when compiling PIC objects.
 	removelist=
@@ -6756,7 +7556,7 @@
 		   continue
 		 fi
 	       fi
-	       removelist=&quot;$removelist $p&quot;
+	       func_append removelist &quot; $p&quot;
 	       ;;
 	    *) ;;
 	  esac
@@ -6767,7 +7567,7 @@
 
       # Now set the variables for building old libraries.
       if test &quot;$build_old_libs&quot; = yes &amp;&amp; test &quot;$build_libtool_libs&quot; != convenience ; then
-	oldlibs=&quot;$oldlibs $output_objdir/$libname.$libext&quot;
+	func_append oldlibs &quot; $output_objdir/$libname.$libext&quot;
 
 	# Transform .lo files to .o files.
 	oldobjs=&quot;$objs &quot;`$ECHO &quot;$libobjs&quot; | $SP2NL | $SED &quot;/\.${libext}$/d; $lo2o&quot; | $NL2SP`
@@ -6784,10 +7584,11 @@
 	# If the user specified any rpath flags, then add them.
 	temp_xrpath=
 	for libdir in $xrpath; do
-	  temp_xrpath=&quot;$temp_xrpath -R$libdir&quot;
+	  func_replace_sysroot &quot;$libdir&quot;
+	  func_append temp_xrpath &quot; -R$func_replace_sysroot_result&quot;
 	  case &quot;$finalize_rpath &quot; in
 	  *&quot; $libdir &quot;*) ;;
-	  *) finalize_rpath=&quot;$finalize_rpath $libdir&quot; ;;
+	  *) func_append finalize_rpath &quot; $libdir&quot; ;;
 	  esac
 	done
 	if test &quot;$hardcode_into_libs&quot; != yes || test &quot;$build_old_libs&quot; = yes; then
@@ -6801,7 +7602,7 @@
       for lib in $old_dlfiles; do
 	case &quot; $dlprefiles $dlfiles &quot; in
 	*&quot; $lib &quot;*) ;;
-	*) dlfiles=&quot;$dlfiles $lib&quot; ;;
+	*) func_append dlfiles &quot; $lib&quot; ;;
 	esac
       done
 
@@ -6811,7 +7612,7 @@
       for lib in $old_dlprefiles; do
 	case &quot;$dlprefiles &quot; in
 	*&quot; $lib &quot;*) ;;
-	*) dlprefiles=&quot;$dlprefiles $lib&quot; ;;
+	*) func_append dlprefiles &quot; $lib&quot; ;;
 	esac
       done
 
@@ -6823,7 +7624,7 @@
 	    ;;
 	  *-*-rhapsody* | *-*-darwin1.[012])
 	    # Rhapsody C library is in the System framework
-	    deplibs=&quot;$deplibs System.ltframework&quot;
+	    func_append deplibs &quot; System.ltframework&quot;
 	    ;;
 	  *-*-netbsd*)
 	    # Don't link with libc until the a.out ld.so is fixed.
@@ -6840,7 +7641,7 @@
 	  *)
 	    # Add libc to deplibs on all other systems if necessary.
 	    if test &quot;$build_libtool_need_lc&quot; = &quot;yes&quot;; then
-	      deplibs=&quot;$deplibs -lc&quot;
+	      func_append deplibs &quot; -lc&quot;
 	    fi
 	    ;;
 	  esac
@@ -6889,7 +7690,7 @@
 		if test &quot;X$allow_libtool_libs_with_static_runtimes&quot; = &quot;Xyes&quot; ; then
 		  case &quot; $predeps $postdeps &quot; in
 		  *&quot; $i &quot;*)
-		    newdeplibs=&quot;$newdeplibs $i&quot;
+		    func_append newdeplibs &quot; $i&quot;
 		    i=&quot;&quot;
 		    ;;
 		  esac
@@ -6900,7 +7701,7 @@
 		  set dummy $deplib_matches; shift
 		  deplib_match=$1
 		  if test `expr &quot;$ldd_output&quot; : &quot;.*$deplib_match&quot;` -ne 0 ; then
-		    newdeplibs=&quot;$newdeplibs $i&quot;
+		    func_append newdeplibs &quot; $i&quot;
 		  else
 		    droppeddeps=yes
 		    echo
@@ -6914,7 +7715,7 @@
 		fi
 		;;
 	      *)
-		newdeplibs=&quot;$newdeplibs $i&quot;
+		func_append newdeplibs &quot; $i&quot;
 		;;
 	      esac
 	    done
@@ -6932,7 +7733,7 @@
 		  if test &quot;X$allow_libtool_libs_with_static_runtimes&quot; = &quot;Xyes&quot; ; then
 		    case &quot; $predeps $postdeps &quot; in
 		    *&quot; $i &quot;*)
-		      newdeplibs=&quot;$newdeplibs $i&quot;
+		      func_append newdeplibs &quot; $i&quot;
 		      i=&quot;&quot;
 		      ;;
 		    esac
@@ -6943,7 +7744,7 @@
 		    set dummy $deplib_matches; shift
 		    deplib_match=$1
 		    if test `expr &quot;$ldd_output&quot; : &quot;.*$deplib_match&quot;` -ne 0 ; then
-		      newdeplibs=&quot;$newdeplibs $i&quot;
+		      func_append newdeplibs &quot; $i&quot;
 		    else
 		      droppeddeps=yes
 		      echo
@@ -6965,7 +7766,7 @@
 		fi
 		;;
 	      *)
-		newdeplibs=&quot;$newdeplibs $i&quot;
+		func_append newdeplibs &quot; $i&quot;
 		;;
 	      esac
 	    done
@@ -6982,15 +7783,27 @@
 	      if test &quot;X$allow_libtool_libs_with_static_runtimes&quot; = &quot;Xyes&quot; ; then
 		case &quot; $predeps $postdeps &quot; in
 		*&quot; $a_deplib &quot;*)
-		  newdeplibs=&quot;$newdeplibs $a_deplib&quot;
+		  func_append newdeplibs &quot; $a_deplib&quot;
 		  a_deplib=&quot;&quot;
 		  ;;
 		esac
 	      fi
 	      if test -n &quot;$a_deplib&quot; ; then
 		libname=`eval &quot;\\$ECHO \&quot;$libname_spec\&quot;&quot;`
+		if test -n &quot;$file_magic_glob&quot;; then
+		  libnameglob=`func_echo_all &quot;$libname&quot; | $SED -e $file_magic_glob`
+		else
+		  libnameglob=$libname
+		fi
+		test &quot;$want_nocaseglob&quot; = yes &amp;&amp; nocaseglob=`shopt -p nocaseglob`
 		for i in $lib_search_path $sys_lib_search_path $shlib_search_path; do
-		  potential_libs=`ls $i/$libname[.-]* 2&gt;/dev/null`
+		  if test &quot;$want_nocaseglob&quot; = yes; then
+		    shopt -s nocaseglob
+		    potential_libs=`ls $i/$libnameglob[.-]* 2&gt;/dev/null`
+		    $nocaseglob
+		  else
+		    potential_libs=`ls $i/$libnameglob[.-]* 2&gt;/dev/null`
+		  fi
 		  for potent_lib in $potential_libs; do
 		      # Follow soft links.
 		      if ls -lLd &quot;$potent_lib&quot; 2&gt;/dev/null |
@@ -7013,7 +7826,7 @@
 		      if eval $file_magic_cmd \&quot;\$potlib\&quot; 2&gt;/dev/null |
 			 $SED -e 10q |
 			 $EGREP &quot;$file_magic_regex&quot; &gt; /dev/null; then
-			newdeplibs=&quot;$newdeplibs $a_deplib&quot;
+			func_append newdeplibs &quot; $a_deplib&quot;
 			a_deplib=&quot;&quot;
 			break 2
 		      fi
@@ -7038,7 +7851,7 @@
 	      ;;
 	    *)
 	      # Add a -L argument.
-	      newdeplibs=&quot;$newdeplibs $a_deplib&quot;
+	      func_append newdeplibs &quot; $a_deplib&quot;
 	      ;;
 	    esac
 	  done # Gone through all deplibs.
@@ -7054,7 +7867,7 @@
 	      if test &quot;X$allow_libtool_libs_with_static_runtimes&quot; = &quot;Xyes&quot; ; then
 		case &quot; $predeps $postdeps &quot; in
 		*&quot; $a_deplib &quot;*)
-		  newdeplibs=&quot;$newdeplibs $a_deplib&quot;
+		  func_append newdeplibs &quot; $a_deplib&quot;
 		  a_deplib=&quot;&quot;
 		  ;;
 		esac
@@ -7067,7 +7880,7 @@
 		    potlib=&quot;$potent_lib&quot; # see symlink-check above in file_magic test
 		    if eval &quot;\$ECHO \&quot;$potent_lib\&quot;&quot; 2&gt;/dev/null | $SED 10q | \
 		       $EGREP &quot;$match_pattern_regex&quot; &gt; /dev/null; then
-		      newdeplibs=&quot;$newdeplibs $a_deplib&quot;
+		      func_append newdeplibs &quot; $a_deplib&quot;
 		      a_deplib=&quot;&quot;
 		      break 2
 		    fi
@@ -7092,7 +7905,7 @@
 	      ;;
 	    *)
 	      # Add a -L argument.
-	      newdeplibs=&quot;$newdeplibs $a_deplib&quot;
+	      func_append newdeplibs &quot; $a_deplib&quot;
 	      ;;
 	    esac
 	  done # Gone through all deplibs.
@@ -7196,7 +8009,7 @@
 	*)
 	  case &quot; $deplibs &quot; in
 	  *&quot; -L$path/$objdir &quot;*)
-	    new_libs=&quot;$new_libs -L$path/$objdir&quot; ;;
+	    func_append new_libs &quot; -L$path/$objdir&quot; ;;
 	  esac
 	  ;;
 	esac
@@ -7206,10 +8019,10 @@
 	-L*)
 	  case &quot; $new_libs &quot; in
 	  *&quot; $deplib &quot;*) ;;
-	  *) new_libs=&quot;$new_libs $deplib&quot; ;;
+	  *) func_append new_libs &quot; $deplib&quot; ;;
 	  esac
 	  ;;
-	*) new_libs=&quot;$new_libs $deplib&quot; ;;
+	*) func_append new_libs &quot; $deplib&quot; ;;
 	esac
       done
       deplibs=&quot;$new_libs&quot;
@@ -7226,10 +8039,12 @@
 	  hardcode_libdirs=
 	  dep_rpath=
 	  rpath=&quot;$finalize_rpath&quot;
-	  test &quot;$mode&quot; != relink &amp;&amp; rpath=&quot;$compile_rpath$rpath&quot;
+	  test &quot;$opt_mode&quot; != relink &amp;&amp; rpath=&quot;$compile_rpath$rpath&quot;
 	  for libdir in $rpath; do
 	    if test -n &quot;$hardcode_libdir_flag_spec&quot;; then
 	      if test -n &quot;$hardcode_libdir_separator&quot;; then
+		func_replace_sysroot &quot;$libdir&quot;
+		libdir=$func_replace_sysroot_result
 		if test -z &quot;$hardcode_libdirs&quot;; then
 		  hardcode_libdirs=&quot;$libdir&quot;
 		else
@@ -7238,18 +8053,18 @@
 		  *&quot;$hardcode_libdir_separator$libdir$hardcode_libdir_separator&quot;*)
 		    ;;
 		  *)
-		    hardcode_libdirs=&quot;$hardcode_libdirs$hardcode_libdir_separator$libdir&quot;
+		    func_append hardcode_libdirs &quot;$hardcode_libdir_separator$libdir&quot;
 		    ;;
 		  esac
 		fi
 	      else
 		eval flag=\&quot;$hardcode_libdir_flag_spec\&quot;
-		dep_rpath=&quot;$dep_rpath $flag&quot;
+		func_append dep_rpath &quot; $flag&quot;
 	      fi
 	    elif test -n &quot;$runpath_var&quot;; then
 	      case &quot;$perm_rpath &quot; in
 	      *&quot; $libdir &quot;*) ;;
-	      *) perm_rpath=&quot;$perm_rpath $libdir&quot; ;;
+	      *) func_apped perm_rpath &quot; $libdir&quot; ;;
 	      esac
 	    fi
 	  done
@@ -7267,7 +8082,7 @@
 	    # We should set the runpath_var.
 	    rpath=
 	    for dir in $perm_rpath; do
-	      rpath=&quot;$rpath$dir:&quot;
+	      func_append rpath &quot;$dir:&quot;
 	    done
 	    eval &quot;$runpath_var='$rpath\$$runpath_var'; export $runpath_var&quot;
 	  fi
@@ -7275,7 +8090,7 @@
 	fi
 
 	shlibpath=&quot;$finalize_shlibpath&quot;
-	test &quot;$mode&quot; != relink &amp;&amp; shlibpath=&quot;$compile_shlibpath$shlibpath&quot;
+	test &quot;$opt_mode&quot; != relink &amp;&amp; shlibpath=&quot;$compile_shlibpath$shlibpath&quot;
 	if test -n &quot;$shlibpath&quot;; then
 	  eval &quot;$shlibpath_var='$shlibpath\$$shlibpath_var'; export $shlibpath_var&quot;
 	fi
@@ -7301,7 +8116,7 @@
 	linknames=
 	for link
 	do
-	  linknames=&quot;$linknames $link&quot;
+	  func_append linknames &quot; $link&quot;
 	done
 
 	# Use standard objects if they are pic
@@ -7312,7 +8127,7 @@
 	if test -n &quot;$export_symbols&quot; &amp;&amp; test -n &quot;$include_expsyms&quot;; then
 	  $opt_dry_run || cp &quot;$export_symbols&quot; &quot;$output_objdir/$libname.uexp&quot;
 	  export_symbols=&quot;$output_objdir/$libname.uexp&quot;
-	  delfiles=&quot;$delfiles $export_symbols&quot;
+	  func_append delfiles &quot; $export_symbols&quot;
 	fi
 
 	orig_export_symbols=
@@ -7343,14 +8158,46 @@
 	    $opt_dry_run || $RM $export_symbols
 	    cmds=$export_symbols_cmds
 	    save_ifs=&quot;$IFS&quot;; IFS='~'
-	    for cmd in $cmds; do
+	    for cmd1 in $cmds; do
 	      IFS=&quot;$save_ifs&quot;
-	      eval cmd=\&quot;$cmd\&quot;
-	      func_len &quot; $cmd&quot;
-	      len=$func_len_result
-	      if test &quot;$len&quot; -lt &quot;$max_cmd_len&quot; || test &quot;$max_cmd_len&quot; -le -1; then
+	      # Take the normal branch if the nm_file_list_spec branch
+	      # doesn't work or if tool conversion is not needed.
+	      case $nm_file_list_spec~$to_tool_file_cmd in
+		*~func_convert_file_noop | *~func_convert_file_msys_to_w32 | ~*)
+		  try_normal_branch=yes
+		  eval cmd=\&quot;$cmd1\&quot;
+		  func_len &quot; $cmd&quot;
+		  len=$func_len_result
+		  ;;
+		*)
+		  try_normal_branch=no
+		  ;;
+	      esac
+	      if test &quot;$try_normal_branch&quot; = yes \
+		 &amp;&amp; { test &quot;$len&quot; -lt &quot;$max_cmd_len&quot; \
+		      || test &quot;$max_cmd_len&quot; -le -1; }
+	      then
 		func_show_eval &quot;$cmd&quot; 'exit $?'
 		skipped_export=false
+	      elif test -n &quot;$nm_file_list_spec&quot;; then
+		func_basename &quot;$output&quot;
+		output_la=$func_basename_result
+		save_libobjs=$libobjs
+		save_output=$output
+		output=${output_objdir}/${output_la}.nm
+		func_to_tool_file &quot;$output&quot;
+		libobjs=$nm_file_list_spec$func_to_tool_file_result
+		func_append delfiles &quot; $output&quot;
+		func_verbose &quot;creating $NM input file list: $output&quot;
+		for obj in $save_libobjs; do
+		  func_to_tool_file &quot;$obj&quot;
+		  $ECHO &quot;$func_to_tool_file_result&quot;
+		done &gt; &quot;$output&quot;
+		eval cmd=\&quot;$cmd1\&quot;
+		func_show_eval &quot;$cmd&quot; 'exit $?'
+		output=$save_output
+		libobjs=$save_libobjs
+		skipped_export=false
 	      else
 		# The command line is too long to execute in one step.
 		func_verbose &quot;using reloadable object file for export list...&quot;
@@ -7383,7 +8230,7 @@
 	  # global variables. join(1) would be nice here, but unfortunately
 	  # isn't a blessed tool.
 	  $opt_dry_run || $SED -e '/[ ,]DATA/!d;s,\(.*\)\([ \,].*\),s|^\1$|\1\2|,' &lt; $export_symbols &gt; $output_objdir/$libname.filter
-	  delfiles=&quot;$delfiles $export_symbols $output_objdir/$libname.filter&quot;
+	  func_append delfiles &quot; $export_symbols $output_objdir/$libname.filter&quot;
 	  export_symbols=$output_objdir/$libname.def
 	  $opt_dry_run || $SED -f $output_objdir/$libname.filter &lt; $orig_export_symbols &gt; $export_symbols
 	fi
@@ -7393,7 +8240,7 @@
 	  case &quot; $convenience &quot; in
 	  *&quot; $test_deplib &quot;*) ;;
 	  *)
-	    tmp_deplibs=&quot;$tmp_deplibs $test_deplib&quot;
+	    func_append tmp_deplibs &quot; $test_deplib&quot;
 	    ;;
 	  esac
 	done
@@ -7413,21 +8260,21 @@
 	    test &quot;X$libobjs&quot; = &quot;X &quot; &amp;&amp; libobjs=
 	  else
 	    gentop=&quot;$output_objdir/${outputname}x&quot;
-	    generated=&quot;$generated $gentop&quot;
+	    func_append generated &quot; $gentop&quot;
 
 	    func_extract_archives $gentop $convenience
-	    libobjs=&quot;$libobjs $func_extract_archives_result&quot;
+	    func_append libobjs &quot; $func_extract_archives_result&quot;
 	    test &quot;X$libobjs&quot; = &quot;X &quot; &amp;&amp; libobjs=
 	  fi
 	fi
 
 	if test &quot;$thread_safe&quot; = yes &amp;&amp; test -n &quot;$thread_safe_flag_spec&quot;; then
 	  eval flag=\&quot;$thread_safe_flag_spec\&quot;
-	  linker_flags=&quot;$linker_flags $flag&quot;
+	  func_append linker_flags &quot; $flag&quot;
 	fi
 
 	# Make a backup of the uninstalled library when relinking
-	if test &quot;$mode&quot; = relink; then
+	if test &quot;$opt_mode&quot; = relink; then
 	  $opt_dry_run || eval '(cd $output_objdir &amp;&amp; $RM ${realname}U &amp;&amp; $MV $realname ${realname}U)' || exit $?
 	fi
 
@@ -7489,10 +8336,13 @@
 	    echo 'INPUT (' &gt; $output
 	    for obj in $save_libobjs
 	    do
-	      $ECHO &quot;$obj&quot; &gt;&gt; $output
+	      func_to_tool_file &quot;$obj&quot;
+	      $ECHO &quot;$func_to_tool_file_result&quot; &gt;&gt; $output
 	    done
 	    echo ')' &gt;&gt; $output
-	    delfiles=&quot;$delfiles $output&quot;
+	    func_append delfiles &quot; $output&quot;
+	    func_to_tool_file &quot;$output&quot;
+	    output=$func_to_tool_file_result
 	  elif test -n &quot;$save_libobjs&quot; &amp;&amp; test &quot;X$skipped_export&quot; != &quot;X:&quot; &amp;&amp; test &quot;X$file_list_spec&quot; != X; then
 	    output=${output_objdir}/${output_la}.lnk
 	    func_verbose &quot;creating linker input file list: $output&quot;
@@ -7506,10 +8356,12 @@
 	    fi
 	    for obj
 	    do
-	      $ECHO &quot;$obj&quot; &gt;&gt; $output
+	      func_to_tool_file &quot;$obj&quot;
+	      $ECHO &quot;$func_to_tool_file_result&quot; &gt;&gt; $output
 	    done
-	    delfiles=&quot;$delfiles $output&quot;
-	    output=$firstobj\&quot;$file_list_spec$output\&quot;
+	    func_append delfiles &quot; $output&quot;
+	    func_to_tool_file &quot;$output&quot;
+	    output=$firstobj\&quot;$file_list_spec$func_to_tool_file_result\&quot;
 	  else
 	    if test -n &quot;$save_libobjs&quot;; then
 	      func_verbose &quot;creating reloadable object files...&quot;
@@ -7560,7 +8412,7 @@
 	      if test -n &quot;$last_robj&quot;; then
 	        eval concat_cmds=\&quot;\${concat_cmds}~\$RM $last_robj\&quot;
 	      fi
-	      delfiles=&quot;$delfiles $output&quot;
+	      func_append delfiles &quot; $output&quot;
 
 	    else
 	      output=
@@ -7594,7 +8446,7 @@
 		lt_exit=$?
 
 		# Restore the uninstalled library and exit
-		if test &quot;$mode&quot; = relink; then
+		if test &quot;$opt_mode&quot; = relink; then
 		  ( cd &quot;$output_objdir&quot; &amp;&amp; \
 		    $RM &quot;${realname}T&quot; &amp;&amp; \
 		    $MV &quot;${realname}U&quot; &quot;$realname&quot; )
@@ -7627,7 +8479,7 @@
 	      # global variables. join(1) would be nice here, but unfortunately
 	      # isn't a blessed tool.
 	      $opt_dry_run || $SED -e '/[ ,]DATA/!d;s,\(.*\)\([ \,].*\),s|^\1$|\1\2|,' &lt; $export_symbols &gt; $output_objdir/$libname.filter
-	      delfiles=&quot;$delfiles $export_symbols $output_objdir/$libname.filter&quot;
+	      func_append delfiles &quot; $export_symbols $output_objdir/$libname.filter&quot;
 	      export_symbols=$output_objdir/$libname.def
 	      $opt_dry_run || $SED -f $output_objdir/$libname.filter &lt; $orig_export_symbols &gt; $export_symbols
 	    fi
@@ -7668,10 +8520,10 @@
 	# Add any objects from preloaded convenience libraries
 	if test -n &quot;$dlprefiles&quot;; then
 	  gentop=&quot;$output_objdir/${outputname}x&quot;
-	  generated=&quot;$generated $gentop&quot;
+	  func_append generated &quot; $gentop&quot;
 
 	  func_extract_archives $gentop $dlprefiles
-	  libobjs=&quot;$libobjs $func_extract_archives_result&quot;
+	  func_append libobjs &quot; $func_extract_archives_result&quot;
 	  test &quot;X$libobjs&quot; = &quot;X &quot; &amp;&amp; libobjs=
 	fi
 
@@ -7687,7 +8539,7 @@
 	    lt_exit=$?
 
 	    # Restore the uninstalled library and exit
-	    if test &quot;$mode&quot; = relink; then
+	    if test &quot;$opt_mode&quot; = relink; then
 	      ( cd &quot;$output_objdir&quot; &amp;&amp; \
 	        $RM &quot;${realname}T&quot; &amp;&amp; \
 		$MV &quot;${realname}U&quot; &quot;$realname&quot; )
@@ -7699,7 +8551,7 @@
 	IFS=&quot;$save_ifs&quot;
 
 	# Restore the uninstalled library and exit
-	if test &quot;$mode&quot; = relink; then
+	if test &quot;$opt_mode&quot; = relink; then
 	  $opt_dry_run || eval '(cd $output_objdir &amp;&amp; $RM ${realname}T &amp;&amp; $MV $realname ${realname}T &amp;&amp; $MV ${realname}U $realname)' || exit $?
 
 	  if test -n &quot;$convenience&quot;; then
@@ -7783,13 +8635,16 @@
 	  reload_conv_objs=$reload_objs\ `$ECHO &quot;$tmp_whole_archive_flags&quot; | $SED 's|,| |g'`
 	else
 	  gentop=&quot;$output_objdir/${obj}x&quot;
-	  generated=&quot;$generated $gentop&quot;
+	  func_append generated &quot; $gentop&quot;
 
 	  func_extract_archives $gentop $convenience
 	  reload_conv_objs=&quot;$reload_objs $func_extract_archives_result&quot;
 	fi
       fi
 
+      # If we're not building shared, we need to use non_pic_objs
+      test &quot;$build_libtool_libs&quot; != yes &amp;&amp; libobjs=&quot;$non_pic_objects&quot;
+
       # Create the old-style object.
       reload_objs=&quot;$objs$old_deplibs &quot;`$ECHO &quot;$libobjs&quot; | $SP2NL | $SED &quot;/\.${libext}$/d; /\.lib$/d; $lo2o&quot; | $NL2SP`&quot; $reload_conv_objs&quot; ### testsuite: skip nested quoting test
 
@@ -7863,8 +8718,8 @@
 	if test &quot;$tagname&quot; = CXX ; then
 	  case ${MACOSX_DEPLOYMENT_TARGET-10.0} in
 	    10.[0123])
-	      compile_command=&quot;$compile_command ${wl}-bind_at_load&quot;
-	      finalize_command=&quot;$finalize_command ${wl}-bind_at_load&quot;
+	      func_append compile_command &quot; ${wl}-bind_at_load&quot;
+	      func_append finalize_command &quot; ${wl}-bind_at_load&quot;
 	    ;;
 	  esac
 	fi
@@ -7884,7 +8739,7 @@
 	*)
 	  case &quot; $compile_deplibs &quot; in
 	  *&quot; -L$path/$objdir &quot;*)
-	    new_libs=&quot;$new_libs -L$path/$objdir&quot; ;;
+	    func_append new_libs &quot; -L$path/$objdir&quot; ;;
 	  esac
 	  ;;
 	esac
@@ -7894,17 +8749,17 @@
 	-L*)
 	  case &quot; $new_libs &quot; in
 	  *&quot; $deplib &quot;*) ;;
-	  *) new_libs=&quot;$new_libs $deplib&quot; ;;
+	  *) func_append new_libs &quot; $deplib&quot; ;;
 	  esac
 	  ;;
-	*) new_libs=&quot;$new_libs $deplib&quot; ;;
+	*) func_append new_libs &quot; $deplib&quot; ;;
 	esac
       done
       compile_deplibs=&quot;$new_libs&quot;
 
 
-      compile_command=&quot;$compile_command $compile_deplibs&quot;
-      finalize_command=&quot;$finalize_command $finalize_deplibs&quot;
+      func_append compile_command &quot; $compile_deplibs&quot;
+      func_append finalize_command &quot; $finalize_deplibs&quot;
 
       if test -n &quot;$rpath$xrpath&quot;; then
 	# If the user specified any rpath flags, then add them.
@@ -7912,7 +8767,7 @@
 	  # This is the magic to use -rpath.
 	  case &quot;$finalize_rpath &quot; in
 	  *&quot; $libdir &quot;*) ;;
-	  *) finalize_rpath=&quot;$finalize_rpath $libdir&quot; ;;
+	  *) func_append finalize_rpath &quot; $libdir&quot; ;;
 	  esac
 	done
       fi
@@ -7931,18 +8786,18 @@
 	      *&quot;$hardcode_libdir_separator$libdir$hardcode_libdir_separator&quot;*)
 		;;
 	      *)
-		hardcode_libdirs=&quot;$hardcode_libdirs$hardcode_libdir_separator$libdir&quot;
+		func_append hardcode_libdirs &quot;$hardcode_libdir_separator$libdir&quot;
 		;;
 	      esac
 	    fi
 	  else
 	    eval flag=\&quot;$hardcode_libdir_flag_spec\&quot;
-	    rpath=&quot;$rpath $flag&quot;
+	    func_append rpath &quot; $flag&quot;
 	  fi
 	elif test -n &quot;$runpath_var&quot;; then
 	  case &quot;$perm_rpath &quot; in
 	  *&quot; $libdir &quot;*) ;;
-	  *) perm_rpath=&quot;$perm_rpath $libdir&quot; ;;
+	  *) func_append perm_rpath &quot; $libdir&quot; ;;
 	  esac
 	fi
 	case $host in
@@ -7951,12 +8806,12 @@
 	  case :$dllsearchpath: in
 	  *&quot;:$libdir:&quot;*) ;;
 	  ::) dllsearchpath=$libdir;;
-	  *) dllsearchpath=&quot;$dllsearchpath:$libdir&quot;;;
+	  *) func_append dllsearchpath &quot;:$libdir&quot;;;
 	  esac
 	  case :$dllsearchpath: in
 	  *&quot;:$testbindir:&quot;*) ;;
 	  ::) dllsearchpath=$testbindir;;
-	  *) dllsearchpath=&quot;$dllsearchpath:$testbindir&quot;;;
+	  *) func_append dllsearchpath &quot;:$testbindir&quot;;;
 	  esac
 	  ;;
 	esac
@@ -7982,18 +8837,18 @@
 	      *&quot;$hardcode_libdir_separator$libdir$hardcode_libdir_separator&quot;*)
 		;;
 	      *)
-		hardcode_libdirs=&quot;$hardcode_libdirs$hardcode_libdir_separator$libdir&quot;
+		func_append hardcode_libdirs &quot;$hardcode_libdir_separator$libdir&quot;
 		;;
 	      esac
 	    fi
 	  else
 	    eval flag=\&quot;$hardcode_libdir_flag_spec\&quot;
-	    rpath=&quot;$rpath $flag&quot;
+	    func_append rpath &quot; $flag&quot;
 	  fi
 	elif test -n &quot;$runpath_var&quot;; then
 	  case &quot;$finalize_perm_rpath &quot; in
 	  *&quot; $libdir &quot;*) ;;
-	  *) finalize_perm_rpath=&quot;$finalize_perm_rpath $libdir&quot; ;;
+	  *) func_append finalize_perm_rpath &quot; $libdir&quot; ;;
 	  esac
 	fi
       done
@@ -8044,6 +8899,12 @@
 	exit_status=0
 	func_show_eval &quot;$link_command&quot; 'exit_status=$?'
 
+	if test -n &quot;$postlink_cmds&quot;; then
+	  func_to_tool_file &quot;$output&quot;
+	  postlink_cmds=`func_echo_all &quot;$postlink_cmds&quot; | $SED -e 's%@OUTPUT@%'&quot;$output&quot;'%g' -e 's%@TOOL_OUTPUT@%'&quot;$func_to_tool_file_result&quot;'%g'`
+	  func_execute_cmds &quot;$postlink_cmds&quot; 'exit $?'
+	fi
+
 	# Delete the generated files.
 	if test -f &quot;$output_objdir/${outputname}S.${objext}&quot;; then
 	  func_show_eval '$RM &quot;$output_objdir/${outputname}S.${objext}&quot;'
@@ -8066,7 +8927,7 @@
 	  # We should set the runpath_var.
 	  rpath=
 	  for dir in $perm_rpath; do
-	    rpath=&quot;$rpath$dir:&quot;
+	    func_append rpath &quot;$dir:&quot;
 	  done
 	  compile_var=&quot;$runpath_var=\&quot;$rpath\$$runpath_var\&quot; &quot;
 	fi
@@ -8074,7 +8935,7 @@
 	  # We should set the runpath_var.
 	  rpath=
 	  for dir in $finalize_perm_rpath; do
-	    rpath=&quot;$rpath$dir:&quot;
+	    func_append rpath &quot;$dir:&quot;
 	  done
 	  finalize_var=&quot;$runpath_var=\&quot;$rpath\$$runpath_var\&quot; &quot;
 	fi
@@ -8089,6 +8950,13 @@
 	$opt_dry_run || $RM $output
 	# Link the executable and exit
 	func_show_eval &quot;$link_command&quot; 'exit $?'
+
+	if test -n &quot;$postlink_cmds&quot;; then
+	  func_to_tool_file &quot;$output&quot;
+	  postlink_cmds=`func_echo_all &quot;$postlink_cmds&quot; | $SED -e 's%@OUTPUT@%'&quot;$output&quot;'%g' -e 's%@TOOL_OUTPUT@%'&quot;$func_to_tool_file_result&quot;'%g'`
+	  func_execute_cmds &quot;$postlink_cmds&quot; 'exit $?'
+	fi
+
 	exit $EXIT_SUCCESS
       fi
 
@@ -8122,6 +8990,12 @@
 
       func_show_eval &quot;$link_command&quot; 'exit $?'
 
+      if test -n &quot;$postlink_cmds&quot;; then
+	func_to_tool_file &quot;$output_objdir/$outputname&quot;
+	postlink_cmds=`func_echo_all &quot;$postlink_cmds&quot; | $SED -e 's%@OUTPUT@%'&quot;$output_objdir/$outputname&quot;'%g' -e 's%@TOOL_OUTPUT@%'&quot;$func_to_tool_file_result&quot;'%g'`
+	func_execute_cmds &quot;$postlink_cmds&quot; 'exit $?'
+      fi
+
       # Now create the wrapper script.
       func_verbose &quot;creating $output&quot;
 
@@ -8219,7 +9093,7 @@
 	else
 	  oldobjs=&quot;$old_deplibs $non_pic_objects&quot;
 	  if test &quot;$preload&quot; = yes &amp;&amp; test -f &quot;$symfileobj&quot;; then
-	    oldobjs=&quot;$oldobjs $symfileobj&quot;
+	    func_append oldobjs &quot; $symfileobj&quot;
 	  fi
 	fi
 	addlibs=&quot;$old_convenience&quot;
@@ -8227,10 +9101,10 @@
 
       if test -n &quot;$addlibs&quot;; then
 	gentop=&quot;$output_objdir/${outputname}x&quot;
-	generated=&quot;$generated $gentop&quot;
+	func_append generated &quot; $gentop&quot;
 
 	func_extract_archives $gentop $addlibs
-	oldobjs=&quot;$oldobjs $func_extract_archives_result&quot;
+	func_append oldobjs &quot; $func_extract_archives_result&quot;
       fi
 
       # Do each command in the archive commands.
@@ -8241,10 +9115,10 @@
 	# Add any objects from preloaded convenience libraries
 	if test -n &quot;$dlprefiles&quot;; then
 	  gentop=&quot;$output_objdir/${outputname}x&quot;
-	  generated=&quot;$generated $gentop&quot;
+	  func_append generated &quot; $gentop&quot;
 
 	  func_extract_archives $gentop $dlprefiles
-	  oldobjs=&quot;$oldobjs $func_extract_archives_result&quot;
+	  func_append oldobjs &quot; $func_extract_archives_result&quot;
 	fi
 
 	# POSIX demands no paths to be encoded in archives.  We have
@@ -8262,7 +9136,7 @@
 	else
 	  echo &quot;copying selected object files to avoid basename conflicts...&quot;
 	  gentop=&quot;$output_objdir/${outputname}x&quot;
-	  generated=&quot;$generated $gentop&quot;
+	  func_append generated &quot; $gentop&quot;
 	  func_mkdir_p &quot;$gentop&quot;
 	  save_oldobjs=$oldobjs
 	  oldobjs=
@@ -8286,9 +9160,9 @@
 		esac
 	      done
 	      func_show_eval &quot;ln $obj $gentop/$newobj || cp $obj $gentop/$newobj&quot;
-	      oldobjs=&quot;$oldobjs $gentop/$newobj&quot;
+	      func_append oldobjs &quot; $gentop/$newobj&quot;
 	      ;;
-	    *) oldobjs=&quot;$oldobjs $obj&quot; ;;
+	    *) func_append oldobjs &quot; $obj&quot; ;;
 	    esac
 	  done
 	fi
@@ -8298,6 +9172,16 @@
 	len=$func_len_result
 	if test &quot;$len&quot; -lt &quot;$max_cmd_len&quot; || test &quot;$max_cmd_len&quot; -le -1; then
 	  cmds=$old_archive_cmds
+	elif test -n &quot;$archiver_list_spec&quot;; then
+	  func_verbose &quot;using command file archive linking...&quot;
+	  for obj in $oldobjs
+	  do
+	    func_to_tool_file &quot;$obj&quot;
+	    $ECHO &quot;$func_to_tool_file_result&quot;
+	  done &gt; $output_objdir/$libname.libcmd
+	  func_to_tool_file &quot;$output_objdir/$libname.libcmd&quot;
+	  oldobjs=&quot; $archiver_list_spec$func_to_tool_file_result&quot;
+	  cmds=$old_archive_cmds
 	else
 	  # the command line is too long to link in one step, link in parts
 	  func_verbose &quot;using piecewise archive linking...&quot;
@@ -8394,9 +9278,19 @@
 		eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $deplib`
 		test -z &quot;$libdir&quot; &amp;&amp; \
 		  func_fatal_error &quot;\`$deplib' is not a valid libtool archive&quot;
-		newdependency_libs=&quot;$newdependency_libs $libdir/$name&quot;
+		func_append newdependency_libs &quot; ${lt_sysroot:+=}$libdir/$name&quot;
 		;;
-	      *) newdependency_libs=&quot;$newdependency_libs $deplib&quot; ;;
+	      -L*)
+		func_stripname -L '' &quot;$deplib&quot;
+		func_replace_sysroot &quot;$func_stripname_result&quot;
+		func_append newdependency_libs &quot; -L$func_replace_sysroot_result&quot;
+		;;
+	      -R*)
+		func_stripname -R '' &quot;$deplib&quot;
+		func_replace_sysroot &quot;$func_stripname_result&quot;
+		func_append newdependency_libs &quot; -R$func_replace_sysroot_result&quot;
+		;;
+	      *) func_append newdependency_libs &quot; $deplib&quot; ;;
 	      esac
 	    done
 	    dependency_libs=&quot;$newdependency_libs&quot;
@@ -8410,9 +9304,9 @@
 		eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $lib`
 		test -z &quot;$libdir&quot; &amp;&amp; \
 		  func_fatal_error &quot;\`$lib' is not a valid libtool archive&quot;
-		newdlfiles=&quot;$newdlfiles $libdir/$name&quot;
+		func_append newdlfiles &quot; ${lt_sysroot:+=}$libdir/$name&quot;
 		;;
-	      *) newdlfiles=&quot;$newdlfiles $lib&quot; ;;
+	      *) func_append newdlfiles &quot; $lib&quot; ;;
 	      esac
 	    done
 	    dlfiles=&quot;$newdlfiles&quot;
@@ -8429,7 +9323,7 @@
 		eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $lib`
 		test -z &quot;$libdir&quot; &amp;&amp; \
 		  func_fatal_error &quot;\`$lib' is not a valid libtool archive&quot;
-		newdlprefiles=&quot;$newdlprefiles $libdir/$name&quot;
+		func_append newdlprefiles &quot; ${lt_sysroot:+=}$libdir/$name&quot;
 		;;
 	      esac
 	    done
@@ -8441,7 +9335,7 @@
 		[\\/]* | [A-Za-z]:[\\/]*) abs=&quot;$lib&quot; ;;
 		*) abs=`pwd`&quot;/$lib&quot; ;;
 	      esac
-	      newdlfiles=&quot;$newdlfiles $abs&quot;
+	      func_append newdlfiles &quot; $abs&quot;
 	    done
 	    dlfiles=&quot;$newdlfiles&quot;
 	    newdlprefiles=
@@ -8450,7 +9344,7 @@
 		[\\/]* | [A-Za-z]:[\\/]*) abs=&quot;$lib&quot; ;;
 		*) abs=`pwd`&quot;/$lib&quot; ;;
 	      esac
-	      newdlprefiles=&quot;$newdlprefiles $abs&quot;
+	      func_append newdlprefiles &quot; $abs&quot;
 	    done
 	    dlprefiles=&quot;$newdlprefiles&quot;
 	  fi
@@ -8535,7 +9429,7 @@
     exit $EXIT_SUCCESS
 }
 
-{ test &quot;$mode&quot; = link || test &quot;$mode&quot; = relink; } &amp;&amp;
+{ test &quot;$opt_mode&quot; = link || test &quot;$opt_mode&quot; = relink; } &amp;&amp;
     func_mode_link ${1+&quot;$@&quot;}
 
 
@@ -8555,9 +9449,9 @@
     for arg
     do
       case $arg in
-      -f) RM=&quot;$RM $arg&quot;; rmforce=yes ;;
-      -*) RM=&quot;$RM $arg&quot; ;;
-      *) files=&quot;$files $arg&quot; ;;
+      -f) func_append RM &quot; $arg&quot;; rmforce=yes ;;
+      -*) func_append RM &quot; $arg&quot; ;;
+      *) func_append files &quot; $arg&quot; ;;
       esac
     done
 
@@ -8566,24 +9460,23 @@
 
     rmdirs=
 
-    origobjdir=&quot;$objdir&quot;
     for file in $files; do
       func_dirname &quot;$file&quot; &quot;&quot; &quot;.&quot;
       dir=&quot;$func_dirname_result&quot;
       if test &quot;X$dir&quot; = X.; then
-	objdir=&quot;$origobjdir&quot;
+	odir=&quot;$objdir&quot;
       else
-	objdir=&quot;$dir/$origobjdir&quot;
+	odir=&quot;$dir/$objdir&quot;
       fi
       func_basename &quot;$file&quot;
       name=&quot;$func_basename_result&quot;
-      test &quot;$mode&quot; = uninstall &amp;&amp; objdir=&quot;$dir&quot;
+      test &quot;$opt_mode&quot; = uninstall &amp;&amp; odir=&quot;$dir&quot;
 
-      # Remember objdir for removal later, being careful to avoid duplicates
-      if test &quot;$mode&quot; = clean; then
+      # Remember odir for removal later, being careful to avoid duplicates
+      if test &quot;$opt_mode&quot; = clean; then
 	case &quot; $rmdirs &quot; in
-	  *&quot; $objdir &quot;*) ;;
-	  *) rmdirs=&quot;$rmdirs $objdir&quot; ;;
+	  *&quot; $odir &quot;*) ;;
+	  *) func_append rmdirs &quot; $odir&quot; ;;
 	esac
       fi
 
@@ -8609,18 +9502,17 @@
 
 	  # Delete the libtool libraries and symlinks.
 	  for n in $library_names; do
-	    rmfiles=&quot;$rmfiles $objdir/$n&quot;
+	    func_append rmfiles &quot; $odir/$n&quot;
 	  done
-	  test -n &quot;$old_library&quot; &amp;&amp; rmfiles=&quot;$rmfiles $objdir/$old_library&quot;
+	  test -n &quot;$old_library&quot; &amp;&amp; func_append rmfiles &quot; $odir/$old_library&quot;
 
-	  case &quot;$mode&quot; in
+	  case &quot;$opt_mode&quot; in
 	  clean)
-	    case &quot;  $library_names &quot; in
-	    # &quot;  &quot; in the beginning catches empty $dlname
+	    case &quot; $library_names &quot; in
 	    *&quot; $dlname &quot;*) ;;
-	    *) rmfiles=&quot;$rmfiles $objdir/$dlname&quot; ;;
+	    *) test -n &quot;$dlname&quot; &amp;&amp; func_append rmfiles &quot; $odir/$dlname&quot; ;;
 	    esac
-	    test -n &quot;$libdir&quot; &amp;&amp; rmfiles=&quot;$rmfiles $objdir/$name $objdir/${name}i&quot;
+	    test -n &quot;$libdir&quot; &amp;&amp; func_append rmfiles &quot; $odir/$name $odir/${name}i&quot;
 	    ;;
 	  uninstall)
 	    if test -n &quot;$library_names&quot;; then
@@ -8648,19 +9540,19 @@
 	  # Add PIC object to the list of files to remove.
 	  if test -n &quot;$pic_object&quot; &amp;&amp;
 	     test &quot;$pic_object&quot; != none; then
-	    rmfiles=&quot;$rmfiles $dir/$pic_object&quot;
+	    func_append rmfiles &quot; $dir/$pic_object&quot;
 	  fi
 
 	  # Add non-PIC object to the list of files to remove.
 	  if test -n &quot;$non_pic_object&quot; &amp;&amp;
 	     test &quot;$non_pic_object&quot; != none; then
-	    rmfiles=&quot;$rmfiles $dir/$non_pic_object&quot;
+	    func_append rmfiles &quot; $dir/$non_pic_object&quot;
 	  fi
 	fi
 	;;
 
       *)
-	if test &quot;$mode&quot; = clean ; then
+	if test &quot;$opt_mode&quot; = clean ; then
 	  noexename=$name
 	  case $file in
 	  *.exe)
@@ -8670,7 +9562,7 @@
 	    noexename=$func_stripname_result
 	    # $file with .exe has already been added to rmfiles,
 	    # add $file without .exe
-	    rmfiles=&quot;$rmfiles $file&quot;
+	    func_append rmfiles &quot; $file&quot;
 	    ;;
 	  esac
 	  # Do a test to see if this is a libtool program.
@@ -8679,7 +9571,7 @@
 	      func_ltwrapper_scriptname &quot;$file&quot;
 	      relink_command=
 	      func_source $func_ltwrapper_scriptname_result
-	      rmfiles=&quot;$rmfiles $func_ltwrapper_scriptname_result&quot;
+	      func_append rmfiles &quot; $func_ltwrapper_scriptname_result&quot;
 	    else
 	      relink_command=
 	      func_source $dir/$noexename
@@ -8687,12 +9579,12 @@
 
 	    # note $name still contains .exe if it was in $file originally
 	    # as does the version of $file that was added into $rmfiles
-	    rmfiles=&quot;$rmfiles $objdir/$name $objdir/${name}S.${objext}&quot;
+	    func_append rmfiles &quot; $odir/$name $odir/${name}S.${objext}&quot;
 	    if test &quot;$fast_install&quot; = yes &amp;&amp; test -n &quot;$relink_command&quot;; then
-	      rmfiles=&quot;$rmfiles $objdir/lt-$name&quot;
+	      func_append rmfiles &quot; $odir/lt-$name&quot;
 	    fi
 	    if test &quot;X$noexename&quot; != &quot;X$name&quot; ; then
-	      rmfiles=&quot;$rmfiles $objdir/lt-${noexename}.c&quot;
+	      func_append rmfiles &quot; $odir/lt-${noexename}.c&quot;
 	    fi
 	  fi
 	fi
@@ -8700,7 +9592,6 @@
       esac
       func_show_eval &quot;$RM $rmfiles&quot; 'exit_status=1'
     done
-    objdir=&quot;$origobjdir&quot;
 
     # Try to remove the ${objdir}s in the directories where we deleted files
     for dir in $rmdirs; do
@@ -8712,16 +9603,16 @@
     exit $exit_status
 }
 
-{ test &quot;$mode&quot; = uninstall || test &quot;$mode&quot; = clean; } &amp;&amp;
+{ test &quot;$opt_mode&quot; = uninstall || test &quot;$opt_mode&quot; = clean; } &amp;&amp;
     func_mode_uninstall ${1+&quot;$@&quot;}
 
-test -z &quot;$mode&quot; &amp;&amp; {
+test -z &quot;$opt_mode&quot; &amp;&amp; {
   help=&quot;$generic_help&quot;
   func_fatal_help &quot;you must specify a MODE&quot;
 }
 
 test -z &quot;$exec_cmd&quot; &amp;&amp; \
-  func_fatal_help &quot;invalid operation mode \`$mode'&quot;
+  func_fatal_help &quot;invalid operation mode \`$opt_mode'&quot;
 
 if test -n &quot;$exec_cmd&quot;; then
   eval exec &quot;$exec_cmd&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001755.html">[Pinot-svn] r1766 - trunk/Utils
</A></li>
	<LI>Next message: <A HREF="001757.html">[Pinot-svn] r1768 - trunk/UI/GTK2/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1756">[ date ]</a>
              <a href="thread.html#1756">[ thread ]</a>
              <a href="subject.html#1756">[ subject ]</a>
              <a href="author.html#1756">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/pinot-svn">More information about the Pinot-svn
mailing list</a><br>
</body></html>
