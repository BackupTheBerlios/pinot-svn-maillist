From fabricecolin at mail.berlios.de  Wed Nov  1 14:58:33 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 1 Nov 2006 14:58:33 +0100
Subject: [Pinot-svn] r545 - trunk/Search
Message-ID: <200611011358.kA1DwXhN004668@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-01 14:58:32 +0100 (Wed, 01 Nov 2006)
New Revision: 545

Modified:
   trunk/Search/XapianEngine.cpp
Log:
XDIR and XLABEL always include a colon at indexing time, and they should here
as well.


Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2006-10-31 14:19:54 UTC (rev 544)
+++ trunk/Search/XapianEngine.cpp	2006-11-01 13:58:32 UTC (rev 545)
@@ -140,14 +140,15 @@
 		parser.set_database(*pIndex);
 	}
 	// ...including prefixes
+	// X prefixes should always include a colon
 	parser.add_boolean_prefix("site", "H");
 	parser.add_boolean_prefix("file", "P");
 	parser.add_boolean_prefix("title", "S");
 	parser.add_boolean_prefix("url", "U");
-	parser.add_boolean_prefix("dir", "XDIR");
+	parser.add_boolean_prefix("dir", "XDIR:");
 	parser.add_boolean_prefix("lang", "L");
 	parser.add_boolean_prefix("type", "T");
-	parser.add_boolean_prefix("label", "XLABEL");
+	parser.add_boolean_prefix("label", "XLABEL:");
 
 	// Activate all options and parse
 	return parser.parse_query(freeQuery,



From fabricecolin at mail.berlios.de  Wed Nov  1 17:07:12 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 1 Nov 2006 17:07:12 +0100
Subject: [Pinot-svn] r546 - trunk/Utils
Message-ID: <200611011607.kA1G7CpJ016487@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-01 17:07:12 +0100 (Wed, 01 Nov 2006)
New Revision: 546

Modified:
   trunk/Utils/Document.cpp
Log:
No point trying to mmap() an empty file.


Modified: trunk/Utils/Document.cpp
===================================================================
--- trunk/Utils/Document.cpp	2006-11-01 13:58:32 UTC (rev 545)
+++ trunk/Utils/Document.cpp	2006-11-01 16:07:12 UTC (rev 546)
@@ -167,6 +167,13 @@
 		return false;
 	}
 
+	if (fileStat.st_size == 0)
+	{
+		// The file is empty
+		freeData();
+		return true;
+	}
+
 	// Open the file in read-only mode
 	int fd = open(fileName.c_str(), O_RDONLY);
 	if (fd == -1)



From fabricecolin at mail.berlios.de  Thu Nov  2 12:46:20 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Thu, 2 Nov 2006 12:46:20 +0100
Subject: [Pinot-svn] r547 - trunk/UI/GTK2/src
Message-ID: <200611021146.kA2BkKqf002205@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-02 12:46:18 +0100 (Thu, 02 Nov 2006)
New Revision: 547

Modified:
   trunk/UI/GTK2/src/OnDiskHandler.cpp
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/PinotSettings.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
Log:
Load and save glob patterns for files that shouldn't be indexed. Both
ThreadsManager::index_document() and OnDiskHandler::indexFile() now check files
with PinotSettings::isBlackListed().
Index_document() returns why it failed.
PinotSettings saves the current version string to allow automatic upgrades.


Modified: trunk/UI/GTK2/src/OnDiskHandler.cpp
===================================================================
--- trunk/UI/GTK2/src/OnDiskHandler.cpp	2006-11-01 16:07:12 UTC (rev 546)
+++ trunk/UI/GTK2/src/OnDiskHandler.cpp	2006-11-02 11:46:18 UTC (rev 547)
@@ -31,6 +31,7 @@
 #include "XapianDatabase.h"
 #include "TokenizerFactory.h"
 #include "FileCollector.h"
+#include "PinotSettings.h"
 #include "OnDiskHandler.h"
 
 using namespace std;
@@ -63,6 +64,15 @@
 		return false;
 	}
 
+	// Is it black-listed ?
+	if (PinotSettings::getInstance().isBlackListed(fileName) == true)
+	{
+#ifdef DEBUG
+		cout << "OnDiskHandler::indexFile: " << location << " is black-listed" << endl;
+#endif
+		return false;
+	}
+
 	// Has this file been indexed already ?
 	unsigned int docId = m_index.hasDocument(location);
 	if ((docId > 0) &&

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2006-11-01 16:07:12 UTC (rev 546)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2006-11-02 11:46:18 UTC (rev 547)
@@ -23,6 +23,7 @@
 #include <sys/stat.h>
 #include <dirent.h>
 #include <pwd.h>
+#include <fnmatch.h>
 #include <algorithm>
 #include <iostream>
 
@@ -206,6 +207,7 @@
 	m_labels.clear();
 	m_mailAccounts.clear();
 	m_indexableLocations.clear();
+	m_filePatternsBlackList.clear();
 	m_cacheProviders.clear();
 }
 
@@ -233,12 +235,23 @@
 	addIndex(_("My Web Pages"), m_docsIndexLocation);
 	addIndex(_("My Documents"), m_daemonIndexLocation);
 
-	// Add default labels on the first run
 	if (m_firstRun == true)
 	{
+		// Add default labels
 		m_labels.insert(_("Important"));
 		m_labels.insert(_("New"));
 		m_labels.insert(_("Personal"));
+		// Skip common image and video types
+		m_filePatternsBlackList.insert("*.avi");
+		m_filePatternsBlackList.insert("*.asf");
+		m_filePatternsBlackList.insert("*.gif");
+		m_filePatternsBlackList.insert("*.jpeg");
+		m_filePatternsBlackList.insert("*.jpg");
+		m_filePatternsBlackList.insert("*.png");
+		m_filePatternsBlackList.insert("*.mov");
+		m_filePatternsBlackList.insert("*.mpeg");
+		m_filePatternsBlackList.insert("*.mpg");
+		m_filePatternsBlackList.insert("*.wmv");
 	}
 
 	// Some search engines are hardcoded
@@ -318,6 +331,10 @@
 						continue;
 					}
 				}
+				else if (nodeName == "version")
+				{
+					m_version = nodeContent;
+				}
 				else if (nodeName == "googleapikey")
 				{
 					m_googleAPIKey = nodeContent;
@@ -376,6 +393,10 @@
 				{
 					loadIndexableLocations(pElem);
 				}
+				else if (nodeName == "blacklist")
+				{
+					loadFilePatterns(pElem);
+				}
 			}
 		}
 	}
@@ -874,6 +895,41 @@
 	return true;
 }
 
+bool PinotSettings::loadFilePatterns(const Element *pElem)
+{
+	if (pElem == NULL)
+	{
+		return false;
+	}
+
+	Node::NodeList childNodes = pElem->get_children();
+	if (childNodes.empty() == true)
+	{
+		return false;
+	}
+
+	// Load the file patterns list
+	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
+	{
+		Node *pNode = (*iter);
+		Element *pElem = dynamic_cast<Element*>(pNode);
+		if (pElem == NULL)
+		{
+			continue;
+		}
+
+		string nodeName = pElem->get_name();
+		string nodeContent = getElementContent(pElem);
+
+		if (nodeName == "pattern")
+		{
+			m_filePatternsBlackList.insert(nodeContent);
+		}
+	}
+
+	return true;
+}
+
 bool PinotSettings::loadCacheProviders(const Element *pElem)
 {
 	if (pElem == NULL)
@@ -1011,6 +1067,7 @@
 		return false;
 	}
 	// ...with text children nodes
+	addChildElement(pRootElem, "version", VERSION);
 	addChildElement(pRootElem, "googleapikey", m_googleAPIKey);
 	// User interface position and size
 	pElem = pRootElem->add_child("ui");
@@ -1128,6 +1185,16 @@
 		addChildElement(pElem, "name", locationIter->m_name);
 		addChildElement(pElem, "monitor", (locationIter->m_monitor ? "YES" : "NO"));
 	}
+	// File patterns that are blacklisted
+	pElem = pRootElem->add_child("blacklist");
+	if (pElem == NULL)
+	{
+		return false;
+	}
+	for (set<ustring>::iterator patternIter = m_filePatternsBlackList.begin(); patternIter != m_filePatternsBlackList.end() ; ++patternIter)
+	{
+		addChildElement(pElem, "pattern", *patternIter);
+	}
 
 	// Save to file
 	doc.write_to_file_formatted(getConfigurationFileName());
@@ -1417,6 +1484,35 @@
 	m_labels.clear();
 }
 
+/// Determines if a file matches the blacklist.
+bool PinotSettings::isBlackListed(const string &fileName)
+{
+	if (m_filePatternsBlackList.empty() == true)
+	{
+		return false;
+	}
+
+#ifdef DEBUG
+	cout << "PinotSettings::isBlackListed: examining " << fileName << endl;
+#endif
+	// Any pattern matches this the file name ?
+	for (set<ustring>::iterator patternIter = m_filePatternsBlackList.begin(); patternIter != m_filePatternsBlackList.end() ; ++patternIter)
+	{
+		if (fnmatch(patternIter->c_str(), fileName.c_str(), FNM_NOESCAPE) == 0)
+		{
+#ifdef DEBUG
+			cout << "PinotSettings::isBlackListed: matched " << *patternIter << endl;
+#endif
+			return true;
+		}
+#ifdef DEBUG
+		cout << "PinotSettings::isBlackListed: didn't match " << *patternIter << endl;
+#endif
+	}
+
+	return false;
+}
+
 PinotSettings::Engine::Engine()
 {
 }

Modified: trunk/UI/GTK2/src/PinotSettings.h
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.h	2006-11-01 16:07:12 UTC (rev 546)
+++ trunk/UI/GTK2/src/PinotSettings.h	2006-11-02 11:46:18 UTC (rev 547)
@@ -134,6 +134,9 @@
 		/// Clears the labels list.
 		void clearLabels(void);
 
+		/// Determines if a file matches the blacklist.
+		bool isBlackListed(const std::string &fileName);
+
 		class TimestampedItem
 		{
 			public:
@@ -181,6 +184,7 @@
 				std::set<Glib::ustring> m_protocols;
 		};
 
+		Glib::ustring m_version;
 		Glib::ustring m_googleAPIKey;
 		Glib::ustring m_docsIndexLocation;
 		Glib::ustring m_daemonIndexLocation;
@@ -199,6 +203,7 @@
 		unsigned short m_newResultsColourBlue;
 		std::set<TimestampedItem> m_mailAccounts;
 		std::set<IndexableLocation> m_indexableLocations;
+		std::set<Glib::ustring> m_filePatternsBlackList;
 		std::vector<CacheProvider> m_cacheProviders;
 		std::set<Glib::ustring> m_cacheProtocols;
 
@@ -224,6 +229,7 @@
 		bool loadColour(const xmlpp::Element *pElem);
 		bool loadMailAccounts(const xmlpp::Element *pElem);
 		bool loadIndexableLocations(const xmlpp::Element *pElem);
+		bool loadFilePatterns(const xmlpp::Element *pElem);
 		bool loadCacheProviders(const xmlpp::Element *pElem);
 
 	private:

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-01 16:07:12 UTC (rev 546)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-02 11:46:18 UTC (rev 547)
@@ -285,21 +285,21 @@
 	return pWorkerThread;
 }
 
-bool ThreadsManager::index_document(const DocumentInfo &docInfo)
+ustring ThreadsManager::index_document(const DocumentInfo &docInfo)
 {
 	string location(docInfo.getLocation());
 
 	if (location.empty() == true)
 	{
 		// Nothing to do
-		return false;
+		return "";
 	}
 
 	// If the document is a mail message, we can't index it again
 	Url urlObj(location);
 	if (urlObj.getProtocol() == "mailbox")
 	{
-		return false;
+		return _("Couldn't index mailbox data here");
 	}
 
 	// Is the document being indexed/updated ?
@@ -318,15 +318,33 @@
 		if (beingProcessed == true)
 		{
 			// FIXME: we may have to set labels on this document
-			return false;
+			ustring status(location);
+			status += " ";
+			status += _("is already being indexed");
+			return status;
 		}
 	}
 
+	// Is the document blacklisted ?
+	if (PinotSettings::getInstance().isBlackListed(location) == true)
+	{
+#ifdef DEBUG
+		cout << "ThreadsManager::index_document: " << docInfo.getLocation() << " is blacklisted" << endl;
+#endif
+		ustring status(location);
+		status += " ";
+		status += _("is blacklisted");
+		return status;
+	}
+
 	// Is it an update ?
 	IndexInterface *pIndex = PinotSettings::getInstance().getIndex(m_defaultIndexLocation);
 	if (pIndex == NULL)
 	{
-		return false;
+		ustring status = _("Index error on");
+		status += " ";
+		status += m_defaultIndexLocation;
+		return status;
 	}
 
 	unsigned int docId = pIndex->hasDocument(docInfo.getLocation());
@@ -342,7 +360,7 @@
 	}
 	delete pIndex;
 
-	return true;
+	return "";
 }
 
 bool ThreadsManager::start_thread(WorkerThread *pWorkerThread, bool inBackground)
@@ -468,7 +486,7 @@
 	m_onThreadEndSignal.emit(pThread);
 }
 
-bool ThreadsManager::queue_index(const DocumentInfo &docInfo)
+ustring ThreadsManager::queue_index(const DocumentInfo &docInfo)
 {
 	double averageLoad[3];
 	bool addToQueue = false;
@@ -497,7 +515,7 @@
 			unlock_lists();
 		}
 
-		return true;
+		return "";
 	}
 
 	return index_document(docInfo);
@@ -530,25 +548,27 @@
 			}
 		}
 
-		// Get the first item ?
-		if ((getItem == true) &&
-			(m_indexQueue.empty() == false))
+		// Get an item ?
+		if (getItem == true)
 		{
-			docInfo = m_indexQueue.front();
-			m_indexQueue.pop();
-			foundItem = true;
+			while (m_indexQueue.empty() == false)
+			{
+				docInfo = m_indexQueue.front();
+				m_indexQueue.pop();
+
+				ustring status = index_document(docInfo);
+				if (status.empty() == true)
+				{
+					foundItem = true;
+					break;
+				}
+			}
 		}
 
 		unlock_lists();
 	}
 
-	if (foundItem == false)
-	{
-		// Nothing to do
-		return false;
-	}
-
-	return index_document(docInfo);
+	return foundItem;
 }
 
 void ThreadsManager::get_statistics(unsigned int &queueSize)

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-11-01 16:07:12 UTC (rev 546)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-11-02 11:46:18 UTC (rev 547)
@@ -122,7 +122,7 @@
 
 		void unlock_lists(void);
 
-		bool queue_index(const DocumentInfo &docInfo);
+		Glib::ustring queue_index(const DocumentInfo &docInfo);
 
 		bool pop_queue(const std::string &urlWasIndexed = "");
 
@@ -146,7 +146,7 @@
 		bool write_lock_threads(void);
 		void unlock_threads(void);
 		WorkerThread *get_thread(void);
-		bool index_document(const DocumentInfo &docInfo);
+		Glib::ustring index_document(const DocumentInfo &docInfo);
 
 	private:
 		ThreadsManager(const ThreadsManager &other);



From fabricecolin at mail.berlios.de  Thu Nov  2 12:48:52 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Thu, 2 Nov 2006 12:48:52 +0100
Subject: [Pinot-svn] r548 - in trunk/UI/GTK2: . src
Message-ID: <200611021148.kA2BmqrU006719@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-02 12:48:45 +0100 (Thu, 02 Nov 2006)
New Revision: 548

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/prefsDialog.cc
   trunk/UI/GTK2/src/prefsDialog.hh
   trunk/UI/GTK2/src/prefsDialog_glade.cc
   trunk/UI/GTK2/src/prefsDialog_glade.hh
Log:
File patterns are editable though the Preferences dialog box.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-11-02 11:46:18 UTC (rev 547)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-11-02 11:48:45 UTC (rev 548)
@@ -1529,7 +1529,7 @@
 	  </child>
 
 	  <child>
-	    <widget class="GtkVBox" id="directoriesVbox">
+	    <widget class="GtkVBox" id="indexingVbox">
 	      <property name="visible">True</property>
 	      <property name="homogeneous">False</property>
 	      <property name="spacing">0</property>
@@ -1883,6 +1883,181 @@
 		  <property name="fill">True</property>
 		</packing>
 	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="patternsLabel">
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Specify any file pattern you wish to exclude from indexing:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">True</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">4</property>
+		  <property name="ypad">4</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="padding">4</property>
+		  <property name="expand">False</property>
+		  <property name="fill">False</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkHBox" id="patternsHbox">
+		  <property name="visible">True</property>
+		  <property name="homogeneous">False</property>
+		  <property name="spacing">0</property>
+
+		  <child>
+		    <widget class="GtkScrolledWindow" id="patternsScrolledwindow">
+		      <property name="border_width">4</property>
+		      <property name="visible">True</property>
+		      <property name="can_focus">True</property>
+		      <property name="hscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+		      <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+		      <property name="shadow_type">GTK_SHADOW_NONE</property>
+		      <property name="window_placement">GTK_CORNER_TOP_LEFT</property>
+
+		      <child>
+			<widget class="GtkTreeView" id="patternsTreeview">
+			  <property agent="glademm" name="cxx_visibility">protected</property>
+			  <property name="visible">True</property>
+			  <property name="can_focus">True</property>
+			  <property name="headers_visible">True</property>
+			  <property name="rules_hint">False</property>
+			  <property name="reorderable">False</property>
+			  <property name="enable_search">True</property>
+			  <property name="fixed_height_mode">True</property>
+			  <property name="hover_selection">False</property>
+			  <property name="hover_expand">False</property>
+			</widget>
+		      </child>
+		    </widget>
+		    <packing>
+		      <property name="padding">0</property>
+		      <property name="expand">True</property>
+		      <property name="fill">True</property>
+		    </packing>
+		  </child>
+
+		  <child>
+		    <widget class="GtkVButtonBox" id="patternsVbuttonbox">
+		      <property name="visible">True</property>
+		      <property name="layout_style">GTK_BUTTONBOX_START</property>
+		      <property name="spacing">0</property>
+
+		      <child>
+			<widget class="GtkButton" id="addPatternButton">
+			  <property name="border_width">4</property>
+			  <property agent="glademm" name="cxx_visibility">protected</property>
+			  <property name="visible">True</property>
+			  <property name="can_default">True</property>
+			  <property name="can_focus">True</property>
+			  <property name="relief">GTK_RELIEF_NORMAL</property>
+			  <property name="focus_on_click">True</property>
+			  <signal name="clicked" handler="on_addPatternButton_clicked" last_modification_time="Tue, 31 Oct 2006 14:48:22 GMT"/>
+
+			  <child>
+			    <widget class="GtkAlignment" id="alignment36">
+			      <property name="visible">True</property>
+			      <property name="xalign">0.5</property>
+			      <property name="yalign">0.5</property>
+			      <property name="xscale">0</property>
+			      <property name="yscale">0</property>
+			      <property name="top_padding">0</property>
+			      <property name="bottom_padding">0</property>
+			      <property name="left_padding">0</property>
+			      <property name="right_padding">0</property>
+
+			      <child>
+				<widget class="GtkHBox" id="hbox56">
+				  <property name="visible">True</property>
+				  <property name="homogeneous">False</property>
+				  <property name="spacing">2</property>
+
+				  <child>
+				    <widget class="GtkImage" id="image624">
+				      <property name="visible">True</property>
+				      <property name="stock">gtk-add</property>
+				      <property name="icon_size">4</property>
+				      <property name="xalign">0.5</property>
+				      <property name="yalign">0.5</property>
+				      <property name="xpad">0</property>
+				      <property name="ypad">0</property>
+				    </widget>
+				    <packing>
+				      <property name="padding">0</property>
+				      <property name="expand">False</property>
+				      <property name="fill">False</property>
+				    </packing>
+				  </child>
+
+				  <child>
+				    <widget class="GtkLabel" id="label60">
+				      <property name="visible">True</property>
+				      <property name="label" translatable="yes">Add</property>
+				      <property name="use_underline">True</property>
+				      <property name="use_markup">False</property>
+				      <property name="justify">GTK_JUSTIFY_LEFT</property>
+				      <property name="wrap">False</property>
+				      <property name="selectable">False</property>
+				      <property name="xalign">0.5</property>
+				      <property name="yalign">0.5</property>
+				      <property name="xpad">0</property>
+				      <property name="ypad">0</property>
+				      <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+				      <property name="width_chars">-1</property>
+				      <property name="single_line_mode">False</property>
+				      <property name="angle">0</property>
+				    </widget>
+				    <packing>
+				      <property name="padding">0</property>
+				      <property name="expand">False</property>
+				      <property name="fill">False</property>
+				    </packing>
+				  </child>
+				</widget>
+			      </child>
+			    </widget>
+			  </child>
+			</widget>
+		      </child>
+
+		      <child>
+			<widget class="GtkButton" id="removePatternButton">
+			  <property name="border_width">4</property>
+			  <property agent="glademm" name="cxx_visibility">protected</property>
+			  <property name="visible">True</property>
+			  <property name="can_default">True</property>
+			  <property name="can_focus">True</property>
+			  <property name="label">gtk-remove</property>
+			  <property name="use_stock">True</property>
+			  <property name="relief">GTK_RELIEF_NORMAL</property>
+			  <property name="focus_on_click">True</property>
+			  <signal name="clicked" handler="on_removePatternButton_clicked" last_modification_time="Tue, 31 Oct 2006 14:48:32 GMT"/>
+			</widget>
+		      </child>
+		    </widget>
+		    <packing>
+		      <property name="padding">0</property>
+		      <property name="expand">False</property>
+		      <property name="fill">True</property>
+		    </packing>
+		  </child>
+		</widget>
+		<packing>
+		  <property name="padding">0</property>
+		  <property name="expand">True</property>
+		  <property name="fill">True</property>
+		</packing>
+	      </child>
 	    </widget>
 	    <packing>
 	      <property name="tab_expand">False</property>

Modified: trunk/UI/GTK2/src/prefsDialog.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog.cc	2006-11-02 11:46:18 UTC (rev 547)
+++ trunk/UI/GTK2/src/prefsDialog.cc	2006-11-02 11:48:45 UTC (rev 548)
@@ -86,6 +86,14 @@
 	mailTreeview->get_selection()->set_mode(SELECTION_SINGLE);
 	populate_mailTreeview();
 
+	// Associate the columns model to the file patterns tree
+	m_refPatternsTree = ListStore::create(m_patternsColumns);
+	patternsTreeview->set_model(m_refPatternsTree);
+	patternsTreeview->append_column_editable(_("Pattern"), m_patternsColumns.m_location);
+	// Allow only single selection
+	patternsTreeview->get_selection()->set_mode(SELECTION_SINGLE);
+	populate_patternsTreeview();
+
 	// Hide the Google API entry field ?
 	if (SearchEngineFactory::isSupported("googleapi") == false)
 	{
@@ -319,6 +327,56 @@
 	return startService;
 }
 
+void prefsDialog::populate_patternsTreeview()
+{
+	TreeModel::iterator iter;
+	TreeModel::Row row;
+
+	if (m_settings.m_filePatternsBlackList.empty() == true)
+	{
+		// This button will stay disabled until a ppatern is added to the list
+		removePatternButton->set_sensitive(false);
+		return;
+	}
+
+	// Populate the tree
+	for (set<ustring>::iterator patternIter = m_settings.m_filePatternsBlackList.begin();
+		patternIter != m_settings.m_filePatternsBlackList.end();
+		++patternIter)
+	{
+		// Create a new row
+		iter = m_refPatternsTree->append();
+		row = *iter;
+		// Set its name
+		row[m_patternsColumns.m_location] = *patternIter;
+	}
+
+	removePatternButton->set_sensitive(true);
+}
+
+void prefsDialog::save_patternsTreeview()
+{
+	// Clear the current settings
+	m_settings.m_filePatternsBlackList.clear();
+
+	// Go through the file patterns tree
+	TreeModel::Children children = m_refPatternsTree->children();
+	if (children.empty() == false)
+	{
+		TreeModel::Children::iterator iter = children.begin();
+		for (; iter != children.end(); ++iter)
+		{
+			TreeModel::Row row = *iter;
+			ustring pattern(row[m_patternsColumns.m_location]);
+
+			if (pattern.empty() == false)
+			{
+				m_settings.m_filePatternsBlackList.insert(pattern);
+			}
+		}
+	}
+}
+
 void prefsDialog::on_prefsOkbutton_clicked()
 {
 	// Synchronise widgets with settings
@@ -334,6 +392,7 @@
 	save_labelsTreeview();
 	bool startForDirectories = save_directoriesTreeview();
 	bool startForMail = save_mailTreeview();
+	save_patternsTreeview();
 	if ((startForDirectories == true) ||
 		(startForMail == true))
 	{
@@ -509,3 +568,57 @@
 		}
 	}
 }
+
+void prefsDialog::on_addPatternButton_clicked()
+{
+	TreeModel::Children children = m_refPatternsTree->children();
+	bool wasEmpty = children.empty();
+
+	// Create a new entry in the file patterns list
+	TreeModel::iterator iter = m_refPatternsTree->append();
+	TreeModel::Row row = *iter;
+
+	row[m_patternsColumns.m_location] = "";
+	row[m_patternsColumns.m_mTime] = time(NULL);
+
+	// Select and start editing the row
+	TreeViewColumn *pColumn = patternsTreeview->get_column(0);
+	if (pColumn != NULL)
+	{
+		TreeModel::Path path = m_refPatternsTree->get_path(iter);
+		patternsTreeview->set_cursor(path, *pColumn, true);
+	}
+
+	if (wasEmpty == true)
+	{
+		// Enable this button
+		removePatternButton->set_sensitive(true);
+	}
+}
+
+void prefsDialog::on_removePatternButton_clicked()
+{
+	// Get the selected file pattern in the list
+	TreeModel::iterator iter = patternsTreeview->get_selection()->get_selected();
+	if (iter)
+	{
+		// Unselect
+		patternsTreeview->get_selection()->unselect(iter);
+		// Select another row
+		TreeModel::Path path = m_refPatternsTree->get_path(iter);
+		path.next();
+		patternsTreeview->get_selection()->select(path);
+
+		// Erase
+		TreeModel::Row row = *iter;
+		m_refPatternsTree->erase(row);
+
+		TreeModel::Children children = m_refPatternsTree->children();
+		if (children.empty() == true)
+		{
+			// Disable this button
+			removePatternButton->set_sensitive(false);
+		}
+	}
+}
+

Modified: trunk/UI/GTK2/src/prefsDialog.hh
===================================================================
--- trunk/UI/GTK2/src/prefsDialog.hh	2006-11-02 11:46:18 UTC (rev 547)
+++ trunk/UI/GTK2/src/prefsDialog.hh	2006-11-02 11:48:45 UTC (rev 548)
@@ -48,6 +48,8 @@
 	virtual void on_removeDirectoryButton_clicked();
 	virtual void on_addAccountButton_clicked();
 	virtual void on_removeAccountButton_clicked();
+	virtual void on_addPatternButton_clicked();
+	virtual void on_removePatternButton_clicked();
 
 	void populate_labelsTreeview();
 	void save_labelsTreeview();
@@ -55,6 +57,8 @@
 	bool save_directoriesTreeview();
 	void populate_mailTreeview();
 	bool save_mailTreeview();
+	void populate_patternsTreeview();
+	void save_patternsTreeview();
 
 private:
 	PinotSettings &m_settings;
@@ -66,6 +70,8 @@
 	Glib::RefPtr<Gtk::ListStore> m_refDirectoriesTree;
 	TimestampedModelColumns m_mailColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refMailTree;
+	TimestampedModelColumns m_patternsColumns;
+	Glib::RefPtr<Gtk::ListStore> m_refPatternsTree;
 	std::set<std::string> m_deletedLabels;
 	std::map<std::string, std::string> m_renamedLabels;
 	std::set<std::string> m_deletedDirectories;

Modified: trunk/UI/GTK2/src/prefsDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog_glade.cc	2006-11-02 11:46:18 UTC (rev 547)
+++ trunk/UI/GTK2/src/prefsDialog_glade.cc	2006-11-02 11:48:45 UTC (rev 548)
@@ -1,9 +1,9 @@
-// generated 2006/10/13 21:02:13 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/11/1 20:52:15 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.8.20 and gtkmm 2.8.8
+// for gtk 2.10.4 and gtkmm 2.10.2
 //
 // Please modify the corresponding derived classes in ./src/prefsDialog.cc
 
@@ -120,7 +120,20 @@
    
    Gtk::VButtonBox *mailVbuttonbox = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
    Gtk::HBox *mailHbox = Gtk::manage(new class Gtk::HBox(false, 0));
-   Gtk::VBox *directoriesVbox = Gtk::manage(new class Gtk::VBox(false, 0));
+   Gtk::Label *patternsLabel = Gtk::manage(new class Gtk::Label(_("Specify any file pattern you wish to exclude from indexing:")));
+   patternsTreeview = Gtk::manage(new class Gtk::TreeView());
+   
+   Gtk::ScrolledWindow *patternsScrolledwindow = Gtk::manage(new class Gtk::ScrolledWindow());
+   Gtk::Image *image624 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-add"), Gtk::IconSize(4)));
+   Gtk::Label *label60 = Gtk::manage(new class Gtk::Label(_("Add")));
+   Gtk::HBox *hbox56 = Gtk::manage(new class Gtk::HBox(false, 2));
+   Gtk::Alignment *alignment36 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
+   addPatternButton = Gtk::manage(new class Gtk::Button());
+   removePatternButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-remove")));
+   
+   Gtk::VButtonBox *patternsVbuttonbox = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
+   Gtk::HBox *patternsHbox = Gtk::manage(new class Gtk::HBox(false, 0));
+   Gtk::VBox *indexingVbox = Gtk::manage(new class Gtk::VBox(false, 0));
    Gtk::Label *indexingLabel = Gtk::manage(new class Gtk::Label(_("Indexing")));
    prefsNotebook = Gtk::manage(new class Gtk::Notebook());
    prefsCancelbutton->set_flags(Gtk::CAN_FOCUS);
@@ -328,10 +341,53 @@
    mailVbuttonbox->pack_start(*removeAccountButton);
    mailHbox->pack_start(*mailScrolledwindow);
    mailHbox->pack_start(*mailVbuttonbox, Gtk::PACK_SHRINK, 0);
-   directoriesVbox->pack_start(*directoriesLabel, Gtk::PACK_SHRINK, 4);
-   directoriesVbox->pack_start(*directoriesHbox, Gtk::PACK_EXPAND_WIDGET, 4);
-   directoriesVbox->pack_start(*mailAccountsLabel, Gtk::PACK_SHRINK, 4);
-   directoriesVbox->pack_start(*mailHbox, Gtk::PACK_EXPAND_WIDGET, 4);
+   patternsLabel->set_alignment(0,0.5);
+   patternsLabel->set_padding(4,4);
+   patternsLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   patternsLabel->set_line_wrap(true);
+   patternsLabel->set_use_markup(false);
+   patternsLabel->set_selectable(false);
+   patternsTreeview->set_flags(Gtk::CAN_FOCUS);
+   patternsTreeview->set_headers_visible(true);
+   patternsTreeview->set_rules_hint(false);
+   patternsTreeview->set_reorderable(false);
+   patternsTreeview->set_enable_search(true);
+   patternsScrolledwindow->set_flags(Gtk::CAN_FOCUS);
+   patternsScrolledwindow->set_border_width(4);
+   patternsScrolledwindow->set_shadow_type(Gtk::SHADOW_NONE);
+   patternsScrolledwindow->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
+   patternsScrolledwindow->property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
+   patternsScrolledwindow->add(*patternsTreeview);
+   image624->set_alignment(0.5,0.5);
+   image624->set_padding(0,0);
+   label60->set_alignment(0.5,0.5);
+   label60->set_padding(0,0);
+   label60->set_justify(Gtk::JUSTIFY_LEFT);
+   label60->set_line_wrap(false);
+   label60->set_use_markup(false);
+   label60->set_selectable(false);
+   hbox56->pack_start(*image624, Gtk::PACK_SHRINK, 0);
+   hbox56->pack_start(*label60, Gtk::PACK_SHRINK, 0);
+   alignment36->add(*hbox56);
+   addPatternButton->set_flags(Gtk::CAN_FOCUS);
+   addPatternButton->set_flags(Gtk::CAN_DEFAULT);
+   addPatternButton->set_border_width(4);
+   addPatternButton->set_relief(Gtk::RELIEF_NORMAL);
+   addPatternButton->add(*alignment36);
+   removePatternButton->set_flags(Gtk::CAN_FOCUS);
+   removePatternButton->set_flags(Gtk::CAN_DEFAULT);
+   removePatternButton->set_border_width(4);
+   removePatternButton->set_relief(Gtk::RELIEF_NORMAL);
+   patternsVbuttonbox->pack_start(*addPatternButton);
+   patternsVbuttonbox->pack_start(*removePatternButton);
+   patternsHbox->pack_start(*patternsScrolledwindow);
+   patternsHbox->pack_start(*patternsVbuttonbox, Gtk::PACK_SHRINK, 0);
+   indexingVbox->pack_start(*directoriesLabel, Gtk::PACK_SHRINK, 4);
+   indexingVbox->pack_start(*directoriesHbox, Gtk::PACK_EXPAND_WIDGET, 4);
+   indexingVbox->pack_start(*mailAccountsLabel, Gtk::PACK_SHRINK, 4);
+   indexingVbox->pack_start(*mailHbox, Gtk::PACK_EXPAND_WIDGET, 4);
+   indexingVbox->pack_start(*patternsLabel, Gtk::PACK_SHRINK, 4);
+   indexingVbox->pack_start(*patternsHbox);
    indexingLabel->set_alignment(0.5,0.5);
    indexingLabel->set_padding(0,0);
    indexingLabel->set_justify(Gtk::JUSTIFY_LEFT);
@@ -347,7 +403,7 @@
    prefsNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
    prefsNotebook->append_page(*labelsVbox, *labelsLabel);
    prefsNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
-   prefsNotebook->append_page(*directoriesVbox, *indexingLabel);
+   prefsNotebook->append_page(*indexingVbox, *indexingLabel);
    prefsNotebook->pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
    prefsDialog->get_vbox()->set_homogeneous(false);
    prefsDialog->get_vbox()->set_spacing(0);
@@ -411,7 +467,18 @@
    removeAccountButton->show();
    mailVbuttonbox->show();
    mailHbox->show();
-   directoriesVbox->show();
+   patternsLabel->show();
+   patternsTreeview->show();
+   patternsScrolledwindow->show();
+   image624->show();
+   label60->show();
+   hbox56->show();
+   alignment36->show();
+   addPatternButton->show();
+   removePatternButton->show();
+   patternsVbuttonbox->show();
+   patternsHbox->show();
+   indexingVbox->show();
    indexingLabel->show();
    prefsNotebook->show();
    prefsDialog->show();
@@ -422,6 +489,8 @@
    removeDirectoryButton->signal_clicked().connect(SigC::slot(*this, &prefsDialog_glade::on_removeDirectoryButton_clicked), false);
    addAccountButton->signal_clicked().connect(SigC::slot(*this, &prefsDialog_glade::on_addAccountButton_clicked), false);
    removeAccountButton->signal_clicked().connect(SigC::slot(*this, &prefsDialog_glade::on_removeAccountButton_clicked), false);
+   addPatternButton->signal_clicked().connect(SigC::slot(*this, &prefsDialog_glade::on_addPatternButton_clicked), false);
+   removePatternButton->signal_clicked().connect(SigC::slot(*this, &prefsDialog_glade::on_removePatternButton_clicked), false);
 }
 
 prefsDialog_glade::~prefsDialog_glade()

Modified: trunk/UI/GTK2/src/prefsDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/prefsDialog_glade.hh	2006-11-02 11:46:18 UTC (rev 547)
+++ trunk/UI/GTK2/src/prefsDialog_glade.hh	2006-11-02 11:48:45 UTC (rev 548)
@@ -1,9 +1,9 @@
-// generated 2006/10/13 21:02:13 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2006/11/1 20:52:15 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.8.20 and gtkmm 2.8.8
+// for gtk 2.10.4 and gtkmm 2.10.2
 //
 // Please modify the corresponding derived classes in ./src/prefsDialog.hh and./src/prefsDialog.cc
 
@@ -63,6 +63,9 @@
         class Gtk::TreeView * mailTreeview;
         class Gtk::Button * addAccountButton;
         class Gtk::Button * removeAccountButton;
+        class Gtk::TreeView * patternsTreeview;
+        class Gtk::Button * addPatternButton;
+        class Gtk::Button * removePatternButton;
         class Gtk::Notebook * prefsNotebook;
         
         prefsDialog_glade();
@@ -76,5 +79,7 @@
         virtual void on_removeDirectoryButton_clicked() = 0;
         virtual void on_addAccountButton_clicked() = 0;
         virtual void on_removeAccountButton_clicked() = 0;
+        virtual void on_addPatternButton_clicked() = 0;
+        virtual void on_removePatternButton_clicked() = 0;
 };
 #endif



From fabricecolin at mail.berlios.de  Thu Nov  2 12:53:37 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Thu, 2 Nov 2006 12:53:37 +0100
Subject: [Pinot-svn] r549 - trunk/UI/GTK2/src
Message-ID: <200611021153.kA2BrbZ5012088@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-02 12:53:36 +0100 (Thu, 02 Nov 2006)
New Revision: 549

Modified:
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
Log:
If queue_index() fails, display the reason string.
In importDialog, start pulsing the progress bar only when we know for sure that
the document was queued for indexing.


Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-11-02 11:48:45 UTC (rev 548)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-11-02 11:53:36 UTC (rev 549)
@@ -105,11 +105,19 @@
 void importDialog::import_url(const string &location)
 {
 	Url urlObj(location);
-	set<string> labels;
-	string title(from_utf8(m_title));
+	DocumentInfo docInfo(from_utf8(m_title), location, MIMEScanner::scanUrl(urlObj), "");
 
-   DocumentInfo docInfo(title, location, MIMEScanner::scanUrl(urlObj), "");
-	m_state.queue_index(docInfo);
+	// Was the document queued for indexing ?
+	ustring status = m_state.queue_index(docInfo);
+	if (status.empty() == true)
+	{
+		m_timeoutConnection = Glib::signal_timeout().connect(SigC::slot(*this,
+			&importDialog::on_activity_timeout), 1000);
+	}
+	else
+	{
+		importProgressbar->set_text(status);
+	}
 }
 
 void importDialog::on_thread_end(WorkerThread *pThread)
@@ -226,9 +234,6 @@
 	// Disable the import button
 	importButton->set_sensitive(false);
 
-	m_timeoutConnection = Glib::signal_timeout().connect(SigC::slot(*this,
-		&importDialog::on_activity_timeout), 1000);
-
 	// Title
 	m_title = titleEntry->get_text();
 	// Label

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-11-02 11:48:45 UTC (rev 548)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-11-02 11:53:36 UTC (rev 549)
@@ -1331,15 +1331,6 @@
 }
 
 //
-// Message reception from ListenerThread
-//
-void mainWindow::on_message_reception(DocumentInfo docInfo)
-{
-	// Queue this
-	m_state.queue_index(docInfo);
-}
-
-//
 // Message reception from IndexBrowserThread
 //
 void mainWindow::on_message_indexupdate(IndexedDocument docInfo, unsigned int docId, string indexName)
@@ -1792,7 +1783,11 @@
 #ifdef DEBUG
 					cout << "mainWindow::on_indexresults_activate: URL is " << resultIter->getLocation() << endl;
 #endif
-					m_state.queue_index(*resultIter);
+					ustring status = m_state.queue_index(*resultIter);
+					if (status.empty() == false)
+					{
+						set_status(status);
+					}
 				}
 
 				// We can update the rows right now
@@ -1902,7 +1897,11 @@
 		DocumentInfo docInfo(docIter->getTitle(), url,
 			docIter->getType(), docIter->getLanguage());
 		docInfo.setTimestamp(docIter->getTimestamp());
-		m_state.queue_index(docInfo);
+		ustring status = m_state.queue_index(docInfo);
+		if (status.empty() == false)
+		{
+			set_status(status);
+		}
 	}
 }
 

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2006-11-02 11:48:45 UTC (rev 548)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-11-02 11:53:36 UTC (rev 549)
@@ -74,7 +74,6 @@
 	void on_close_page(Glib::ustring title, NotebookPageBox::PageType type);
 	void on_thread_end(WorkerThread *pThread);
 	void on_editindex(Glib::ustring indexName, Glib::ustring location);
-	void on_message_reception(DocumentInfo docInfo);
 	void on_message_indexupdate(IndexedDocument docInfo, unsigned int docId, std::string indexName);
 
 	// Handlers inherited from the base class



From fabricecolin at mail.berlios.de  Thu Nov  2 15:39:45 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Thu, 2 Nov 2006 15:39:45 +0100
Subject: [Pinot-svn] r550 - trunk
Message-ID: <200611021439.kA2EdjiM030916@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-02 15:39:45 +0100 (Thu, 02 Nov 2006)
New Revision: 550

Modified:
   trunk/README
Log:
New section on how to reset indexes.
Also added blurb about dbus-send and file patterns.


Modified: trunk/README
===================================================================
--- trunk/README	2006-11-02 11:53:36 UTC (rev 549)
+++ trunk/README	2006-11-02 14:39:45 UTC (rev 550)
@@ -14,8 +14,9 @@
 9. More Like This
 10. D-Bus service
 11. Deskbar Applet plugin
-12. Dependencies
-13. FAQ
+12. How to reset indexes
+13. Dependencies
+14. FAQ
 
 
 1. What is Pinot
@@ -175,7 +176,7 @@
 8. File formats
 
 
-  Supported document types are
+  The following document types are supported and will be fully indexed
   * plain text
   * HTML
   * PDF (pdftotext is required)
@@ -187,7 +188,16 @@
   * MP3 and Ogg Vorbis (TagLib required)
   More formats will be supported as the project matures.
 
+  For other document types, Pinot will only index metadata such as name,
+  location etc... In any case, starting with 0.62, it is possible to
+  skip indexing of files with glob(3) patterns.
+  These patterns are configured in the Indexing tab of the Preferences box.
+  For example, "*.mp3" will skip all files with the extension "mp3", even
+  though that particular document type is supported by Pinot.
+  If you have never run Pinot before, it will initialize the patterns list
+  to common picture and video types such as JPG, GIF, AVI and MPG.
 
+
 9. More Like This
 
 
@@ -225,6 +235,15 @@
        for changes and should consume little resources, unless a huge
        quantity of files needs its attention.
 
+  If you have dbus-send installed, you can start the deamon manually by calling
+  the GetStatistics method with
+  $ dbus-send --session --print-reply --type=method_call \
+    --dest=de.berlios.Pinot /de/berlios/Pinot de.berlios.Pinot.GetStatistics
+  and stop it by calling the Stop method with
+  $ dbus-send --session --print-reply --type=method_call \
+    --dest=de.berlios.Pinot /de/berlios/Pinot de.berlios.Pinot.Stop
+  The daemon will also exit if killed.
+
   For a list of available D-Bus methods, see the file pinot-dbus-daemon.xml.
   Note that only the My Documents index is accessible through D-Bus for the
   time being.
@@ -246,16 +265,36 @@
   results in the same order as the Pinot UI.
 
 
-12. Dependencies
+12. How to reset indexes
 
 
+  You may wish to reset one of the index and start from scratch. There
+  are several ways to do this, depending on which index it is.
+
+  If you want to reset My Web Pages, you can either :
+    * use Pinot to unindex every single document by selecting them all
+      and choosing Unindex in the Index menu
+    * or delete ~/.pinot/index or ~/.pinot/index/* while Pinot isn't running
+
+  If you want to reset My Documents, special considerations apply because
+  of the historical data maintained by the daemon. First, make sure the
+  daemon is stopped, then delete the index with
+  $ rm ~/.pinot/daemon/*
+  and remove historical data as follows
+  $ sqlite3 ~/.pinot/history "delete from CrawlHistory; \
+    delete from CrawlSources;"
+
+
+13. Dependencies
+
+
 ---------------------------------------------------------------
 Name							Version
 ---------------------------------------------------------------
 SQLite							3.1.2
 http://www.sqlite.org/
 
-xapian-core						0.9.4
+xapian-core						0.9.6
 http://www.xapian.org/
 
 curl (1)						7.13.1
@@ -316,7 +355,7 @@
 ---------------------------------------------------------------
 
 
-13. FAQ
+14. FAQ
 
 
   * At startup, when listing an index or indexing documents, Pinot complains



From fabricecolin at mail.berlios.de  Thu Nov  2 15:40:26 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Thu, 2 Nov 2006 15:40:26 +0100
Subject: [Pinot-svn] r551 - trunk/Utils
Message-ID: <200611021440.kA2EeQnU031049@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-02 15:40:26 +0100 (Thu, 02 Nov 2006)
New Revision: 551

Modified:
   trunk/Utils/MIMEScanner.cpp
Log:
Less verbose.


Modified: trunk/Utils/MIMEScanner.cpp
===================================================================
--- trunk/Utils/MIMEScanner.cpp	2006-11-02 14:39:45 UTC (rev 550)
+++ trunk/Utils/MIMEScanner.cpp	2006-11-02 14:40:26 UTC (rev 551)
@@ -265,9 +265,6 @@
 	if ((pType == NULL) ||
 		(strncasecmp(pType, xdg_mime_type_unknown, strlen(pType)) == 0))
 	{
-#ifdef DEBUG
-		cout << "MIMEScanner::scanFileType: couldn't determine type of " << fileName << endl;
-#endif
 		return "";
 	}
 



From fabricecolin at mail.berlios.de  Fri Nov  3 12:02:18 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 3 Nov 2006 12:02:18 +0100
Subject: [Pinot-svn] r552 - trunk/UI/GTK2/src
Message-ID: <200611031102.kA3B2Ior028673@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-03 12:02:17 +0100 (Fri, 03 Nov 2006)
New Revision: 552

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
Log:
When receiving a WRITE_CLOSED event, ensure the file was actually modified
before being closed.
This should fix a major bug where the daemon loops endlessly reindexing mp3/ogg
files. It seems the event is generated by the TagLib tokenizer.


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-02 14:40:26 UTC (rev 551)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-03 11:02:17 UTC (rev 552)
@@ -1500,6 +1500,7 @@
 
 void MonitorThread::processEvents(void)
 {
+	CrawlHistory history(PinotSettings::getInstance().m_historyDatabase);
 	queue<MonitorEvent> events;
 
 #ifdef DEBUG
@@ -1558,7 +1559,25 @@
 		{
 			if (event.m_isDirectory == false)
 			{
-				m_pHandler->fileModified(event.m_location);
+				CrawlHistory::CrawlStatus status = CrawlHistory::UNKNOWN;
+				struct stat fileStat;
+				time_t itemDate;
+
+				if (history.hasItem("file://" + event.m_location, status, itemDate) == true)
+				{
+					// Was the file actually modified ?
+					if ((stat(event.m_location.c_str(), &fileStat) == 0) &&
+						(itemDate < fileStat.st_mtime))
+					{
+						m_pHandler->fileModified(event.m_location);
+					}
+#ifdef DEBUG
+					else cout << "MonitorThread::processEvents: file wasn't modified" << endl;
+#endif
+				}
+#ifdef DEBUG
+				else cout << "MonitorThread::processEvents: file wasn't crawled" << endl;
+#endif
 			}
 		}
 		else if (event.m_type == MonitorEvent::MOVED)



From fabricecolin at mail.berlios.de  Fri Nov  3 12:02:53 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 3 Nov 2006 12:02:53 +0100
Subject: [Pinot-svn] r553 - trunk/Tokenize
Message-ID: <200611031102.kA3B2rgI029157@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-03 12:02:52 +0100 (Fri, 03 Nov 2006)
New Revision: 553

Modified:
   trunk/Tokenize/TagLibTokenizer.cpp
Log:
Minor modification.


Modified: trunk/Tokenize/TagLibTokenizer.cpp
===================================================================
--- trunk/Tokenize/TagLibTokenizer.cpp	2006-11-03 11:02:17 UTC (rev 552)
+++ trunk/Tokenize/TagLibTokenizer.cpp	2006-11-03 11:02:52 UTC (rev 553)
@@ -67,9 +67,7 @@
 			location += urlObj.getFile();
 
 			TagLib::FileRef fileRef(location.c_str(), false);
-
-			if ((fileRef.isNull() == false) &&
-				(fileRef.file()->isOpen() == true))
+			if (fileRef.isNull() == false)
 			{
 				TagLib::Tag *pTag = fileRef.tag();
 				if ((pTag != NULL) &&



From fabricecolin at mail.berlios.de  Fri Nov  3 12:15:01 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 3 Nov 2006 12:15:01 +0100
Subject: [Pinot-svn] r554 - trunk/UI/GTK2/src
Message-ID: <200611031115.kA3BF1xj031147@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-03 12:15:01 +0100 (Fri, 03 Nov 2006)
New Revision: 554

Modified:
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
Log:
Don't close the D-Bus connection, unreference it. This removes the error message
"Applications can not close shared connections.  Please fix this in your app.
Ignoring close request and continuing." seen when the daemon exits.
Any such message seen when calling one of our methods comes from the client;
this holds true for dbus-send ;-)


Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-03 11:02:52 UTC (rev 553)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-03 11:15:01 UTC (rev 554)
@@ -800,7 +800,7 @@
 #ifdef DEBUG
 	cout << "Closing connection..." << endl;
 #endif
-	dbus_connection_close(pConnection);
+	dbus_connection_unref(pConnection);
 	dbus_g_connection_unref(pBus);
 
 	return EXIT_SUCCESS;



From fabricecolin at mail.berlios.de  Fri Nov  3 12:36:26 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 3 Nov 2006 12:36:26 +0100
Subject: [Pinot-svn] r555 - in trunk: . Collect Index Search UI/GTK2/src
Message-ID: <200611031136.kA3BaQgB019086@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-03 12:36:20 +0100 (Fri, 03 Nov 2006)
New Revision: 555

Modified:
   trunk/Collect/pinot-collect.1
   trunk/Index/pinot-index.1
   trunk/Search/pinot-search.1
   trunk/UI/GTK2/src/pinot-dbus-daemon.1
   trunk/UI/GTK2/src/pinot.1
   trunk/configure.in
Log:
Preparing for imminent 0.62 release. Updated man pages.


Modified: trunk/Collect/pinot-collect.1
===================================================================
--- trunk/Collect/pinot-collect.1	2006-11-03 11:15:01 UTC (rev 554)
+++ trunk/Collect/pinot-collect.1	2006-11-03 11:36:20 UTC (rev 555)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-COLLECT "1" "October 2006" "pinot-collect - pinot 0.61" "User Commands"
+.TH PINOT-COLLECT "1" "November 2006" "pinot-collect - pinot 0.62" "User Commands"
 .SH NAME
 pinot-collect \- Download an URL from the command-line
 .SH SYNOPSIS

Modified: trunk/Index/pinot-index.1
===================================================================
--- trunk/Index/pinot-index.1	2006-11-03 11:15:01 UTC (rev 554)
+++ trunk/Index/pinot-index.1	2006-11-03 11:36:20 UTC (rev 555)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-INDEX "1" "October 2006" "pinot-index - pinot 0.61" "User Commands"
+.TH PINOT-INDEX "1" "November 2006" "pinot-index - pinot 0.62" "User Commands"
 .SH NAME
 pinot-index \- Index documents from the command-line
 .SH SYNOPSIS

Modified: trunk/Search/pinot-search.1
===================================================================
--- trunk/Search/pinot-search.1	2006-11-03 11:15:01 UTC (rev 554)
+++ trunk/Search/pinot-search.1	2006-11-03 11:36:20 UTC (rev 555)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-SEARCH "1" "October 2006" "pinot-search - pinot 0.61" "User Commands"
+.TH PINOT-SEARCH "1" "November 2006" "pinot-search - pinot 0.62" "User Commands"
 .SH NAME
 pinot-search \- Query search engines from the command-line
 .SH SYNOPSIS

Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.1
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.1	2006-11-03 11:15:01 UTC (rev 554)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.1	2006-11-03 11:36:20 UTC (rev 555)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-DBUS-DAEMON "1" "October 2006" "pinot-dbus-daemon - pinot 0.61" "User Commands"
+.TH PINOT-DBUS-DAEMON "1" "November 2006" "pinot-dbus-daemon - pinot 0.62" "User Commands"
 .SH NAME
 pinot-dbus-daemon \- D-Bus search and index daemon
 .SH SYNOPSIS

Modified: trunk/UI/GTK2/src/pinot.1
===================================================================
--- trunk/UI/GTK2/src/pinot.1	2006-11-03 11:15:01 UTC (rev 554)
+++ trunk/UI/GTK2/src/pinot.1	2006-11-03 11:36:20 UTC (rev 555)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT "1" "October 2006" "pinot - pinot 0.61" "User Commands"
+.TH PINOT "1" "November 2006" "pinot - pinot 0.62" "User Commands"
 .SH NAME
 pinot \- A metasearch tool for the Free Desktop
 .SH SYNOPSIS

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2006-11-03 11:15:01 UTC (rev 554)
+++ trunk/configure.in	2006-11-03 11:36:20 UTC (rev 555)
@@ -2,7 +2,7 @@
 # using glademm V2.6.0
 
 AC_PREREQ(2.50)
-AC_INIT(pinot, 0.61,[fabricecolin at users.berlios.de])
+AC_INIT(pinot, 0.62,[fabricecolin at users.berlios.de])
 AM_INIT_AUTOMAKE
 AC_CONFIG_HEADERS(config.h)
 



From fabricecolin at mail.berlios.de  Fri Nov  3 13:21:42 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 3 Nov 2006 13:21:42 +0100
Subject: [Pinot-svn] r556 - trunk/UI/GTK2/src
Message-ID: <200611031221.kA3CLg3M010769@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-03 13:21:41 +0100 (Fri, 03 Nov 2006)
New Revision: 556

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
Log:
Changed message.


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-03 11:36:20 UTC (rev 555)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-03 12:21:41 UTC (rev 556)
@@ -299,7 +299,7 @@
 	Url urlObj(location);
 	if (urlObj.getProtocol() == "mailbox")
 	{
-		return _("Couldn't index mailbox data here");
+		return _("Can't index mail here");
 	}
 
 	// Is the document being indexed/updated ?



From fabricecolin at mail.berlios.de  Fri Nov  3 13:40:34 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 3 Nov 2006 13:40:34 +0100
Subject: [Pinot-svn] r557 - trunk/UI/GTK2/src
Message-ID: <200611031240.kA3CeYFa013193@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-03 13:40:34 +0100 (Fri, 03 Nov 2006)
New Revision: 557

Modified:
   trunk/UI/GTK2/src/PinotSettings.cpp
Log:
Added archive formats to file patterns blacklist.


Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2006-11-03 12:21:41 UTC (rev 556)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2006-11-03 12:40:34 UTC (rev 557)
@@ -241,17 +241,25 @@
 		m_labels.insert(_("Important"));
 		m_labels.insert(_("New"));
 		m_labels.insert(_("Personal"));
-		// Skip common image and video types
+		// Skip common image, video and archive types
+		m_filePatternsBlackList.insert("*.Z");
 		m_filePatternsBlackList.insert("*.avi");
 		m_filePatternsBlackList.insert("*.asf");
+		m_filePatternsBlackList.insert("*.bz2");
+		m_filePatternsBlackList.insert("*.deb");
 		m_filePatternsBlackList.insert("*.gif");
+		m_filePatternsBlackList.insert("*.gz");
 		m_filePatternsBlackList.insert("*.jpeg");
 		m_filePatternsBlackList.insert("*.jpg");
 		m_filePatternsBlackList.insert("*.png");
+		m_filePatternsBlackList.insert("*.lha");
 		m_filePatternsBlackList.insert("*.mov");
 		m_filePatternsBlackList.insert("*.mpeg");
 		m_filePatternsBlackList.insert("*.mpg");
+		m_filePatternsBlackList.insert("*.rpm");
+		m_filePatternsBlackList.insert("*.tar");
 		m_filePatternsBlackList.insert("*.wmv");
+		m_filePatternsBlackList.insert("*.zip");
 	}
 
 	// Some search engines are hardcoded



From fabricecolin at mail.berlios.de  Fri Nov  3 14:40:26 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 3 Nov 2006 14:40:26 +0100
Subject: [Pinot-svn] r558 - trunk/Search/Plugins
Message-ID: <200611031340.kA3DeQxt021849@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-03 14:40:25 +0100 (Fri, 03 Nov 2006)
New Revision: 558

Modified:
   trunk/Search/Plugins/Accoona.src
   trunk/Search/Plugins/Exalead.src
Log:
Caught up with modified output.


Modified: trunk/Search/Plugins/Accoona.src
===================================================================
--- trunk/Search/Plugins/Accoona.src	2006-11-03 12:40:34 UTC (rev 557)
+++ trunk/Search/Plugins/Accoona.src	2006-11-03 13:40:25 UTC (rev 558)
@@ -17,8 +17,8 @@
 <INTERPRET
 resultListStart=""
 resultListEnd=""
-resultItemStart='<td class="webtitle" valign="top">'
-resultItemEnd='</span></td></tr>'
+resultItemStart='<span class="restit">'
+resultItemEnd='</table>'
 >
 
 </SEARCH>

Modified: trunk/Search/Plugins/Exalead.src
===================================================================
--- trunk/Search/Plugins/Exalead.src	2006-11-03 12:40:34 UTC (rev 557)
+++ trunk/Search/Plugins/Exalead.src	2006-11-03 13:40:25 UTC (rev 558)
@@ -21,8 +21,8 @@
 <INTERPRET
 resultListStart=''
 resultListEnd=''
-resultItemStart='<td class="d1"'
-resultItemEnd='</td></tr>'
+resultItemStart='alt="Preview" />'
+resultItemEnd='</span></span>'
 >
 
 </SEARCH>



From fabricecolin at mail.berlios.de  Sat Nov  4 05:08:04 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 05:08:04 +0100
Subject: [Pinot-svn] r559 - trunk/Index
Message-ID: <200611040408.kA4484mN004023@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 05:08:03 +0100 (Sat, 04 Nov 2006)
New Revision: 559

Modified:
   trunk/Index/IndexInterface.h
   trunk/Index/XapianIndex.cpp
   trunk/Index/XapianIndex.h
Log:
Overloaded unindexDocument() to allow unindexing by location.


Modified: trunk/Index/IndexInterface.h
===================================================================
--- trunk/Index/IndexInterface.h	2006-11-03 13:40:25 UTC (rev 558)
+++ trunk/Index/IndexInterface.h	2006-11-04 04:08:03 UTC (rev 559)
@@ -100,6 +100,9 @@
 		/// Unindexes the given document.
 		virtual bool unindexDocument(unsigned int docId) = 0;
 
+		/// Unindexes the given document.
+		virtual bool unindexDocument(const std::string &location) = 0;
+
 		/// Unindexes documents with the given label.
 		virtual bool unindexDocuments(const std::string &labelName) = 0;
 

Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-11-03 13:40:25 UTC (rev 558)
+++ trunk/Index/XapianIndex.cpp	2006-11-04 04:08:03 UTC (rev 559)
@@ -1291,6 +1291,48 @@
 	return unindexed;
 }
 
+/// Unindexes the given document.
+bool XapianIndex::unindexDocument(const string &location)
+{
+	bool unindexed = false;
+
+	if (location.empty() == true)
+	{
+		return false;
+	}
+
+	XapianDatabase *pDatabase = XapianDatabaseFactory::getDatabase(m_databaseName, false);
+	if (pDatabase == NULL)
+	{
+		cerr << "Bad index " << m_databaseName << endl;
+		return false;
+	}
+
+	try
+	{
+		Xapian::WritableDatabase *pIndex = pDatabase->writeLock();
+		if (pIndex != NULL)
+		{
+			string term = limitTermLength(string("U") + Url::canonicalizeUrl(location), true);
+
+			// Only one document should have this term
+			pIndex->delete_document(term);
+			unindexed = true;
+		}
+	}
+	catch (const Xapian::Error &error)
+	{
+		cerr << "Couldn't unindex documents: " << error.get_type() << ": " << error.get_msg() << endl;
+	}
+	catch (...)
+	{
+		cerr << "Couldn't unindex documents, unknown exception occured" << endl;
+	}
+	pDatabase->unlock();
+
+	return unindexed;
+}
+
 /// Unindexes documents with the given label.
 bool XapianIndex::unindexDocuments(const string &labelName)
 {

Modified: trunk/Index/XapianIndex.h
===================================================================
--- trunk/Index/XapianIndex.h	2006-11-03 13:40:25 UTC (rev 558)
+++ trunk/Index/XapianIndex.h	2006-11-04 04:08:03 UTC (rev 559)
@@ -90,6 +90,9 @@
 		/// Unindexes the given document.
 		virtual bool unindexDocument(unsigned int docId);
 
+		/// Unindexes the given document.
+		virtual bool unindexDocument(const std::string &location);
+
 		/// Unindexes documents with the given label.
 		virtual bool unindexDocuments(const std::string &labelName);
 



From fabricecolin at mail.berlios.de  Sat Nov  4 05:11:16 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 05:11:16 +0100
Subject: [Pinot-svn] r560 - trunk/UI/GTK2/src
Message-ID: <200611040411.kA44BG4g004671@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 05:11:16 +0100 (Sat, 04 Nov 2006)
New Revision: 560

Modified:
   trunk/UI/GTK2/src/OnDiskHandler.cpp
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/WorkerThreads.cpp
Log:
DirectoryScanner checks whether files and directories are blacklisted so that
it can skip crawling those that are and remove those that didn't used to be.
Use unindexDocument() overload where it makes sense.
DEBUG output a bit less verbose.


Modified: trunk/UI/GTK2/src/OnDiskHandler.cpp
===================================================================
--- trunk/UI/GTK2/src/OnDiskHandler.cpp	2006-11-04 04:08:03 UTC (rev 559)
+++ trunk/UI/GTK2/src/OnDiskHandler.cpp	2006-11-04 04:11:16 UTC (rev 560)
@@ -67,9 +67,6 @@
 	// Is it black-listed ?
 	if (PinotSettings::getInstance().isBlackListed(fileName) == true)
 	{
-#ifdef DEBUG
-		cout << "OnDiskHandler::indexFile: " << location << " is black-listed" << endl;
-#endif
 		return false;
 	}
 
@@ -155,13 +152,8 @@
 
 bool OnDiskHandler::replaceFile(unsigned int docId, DocumentInfo &docInfo)
 {
-	// Has the destination file been indexed too ?
-	unsigned int destDocId = m_index.hasDocument(docInfo.getLocation());
-	if (destDocId > 0)
-	{
-		// Unindex it
-		m_index.unindexDocument(destDocId);
-	}
+	// Unindex the destination file
+	m_index.unindexDocument(docInfo.getLocation());
 
 	// Update the document info
 	return m_index.updateDocumentInfo(docId, docInfo);
@@ -345,7 +337,7 @@
 
 bool OnDiskHandler::fileDeleted(const string &fileName)
 {
-	bool handledEvent = false;
+	bool handledEvent = true;
 
 #ifdef DEBUG
 	cout << "OnDiskHandler::fileDeleted: " << fileName << endl;

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2006-11-04 04:08:03 UTC (rev 559)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2006-11-04 04:11:16 UTC (rev 560)
@@ -1500,22 +1500,16 @@
 		return false;
 	}
 
-#ifdef DEBUG
-	cout << "PinotSettings::isBlackListed: examining " << fileName << endl;
-#endif
 	// Any pattern matches this the file name ?
 	for (set<ustring>::iterator patternIter = m_filePatternsBlackList.begin(); patternIter != m_filePatternsBlackList.end() ; ++patternIter)
 	{
 		if (fnmatch(patternIter->c_str(), fileName.c_str(), FNM_NOESCAPE) == 0)
 		{
 #ifdef DEBUG
-			cout << "PinotSettings::isBlackListed: matched " << *patternIter << endl;
+			cout << "PinotSettings::isBlackListed: " << fileName << " matches " << *patternIter << endl;
 #endif
 			return true;
 		}
-#ifdef DEBUG
-		cout << "PinotSettings::isBlackListed: didn't match " << *patternIter << endl;
-#endif
 	}
 
 	return false;

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-04 04:08:03 UTC (rev 559)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-04 04:11:16 UTC (rev 560)
@@ -328,9 +328,6 @@
 	// Is the document blacklisted ?
 	if (PinotSettings::getInstance().isBlackListed(location) == true)
 	{
-#ifdef DEBUG
-		cout << "ThreadsManager::index_document: " << docInfo.getLocation() << " is blacklisted" << endl;
-#endif
 		ustring status(location);
 		status += " ";
 		status += _("is blacklisted");
@@ -1815,29 +1812,34 @@
 	{
 		bool reportFile = false;
 
-		// It's actually a file
-		if (itemExists == false)
+		// Is this file blacklisted ?
+		// We have to check early so that if necessary the file's status stays at CRAWLING 
+		// and it is removed from the index at the end of this crawl
+		if (PinotSettings::getInstance().isBlackListed(entryName) == false)
 		{
-			// Record it
-			history.insertItem("file://" + entryName, CrawlHistory::CRAWLED, m_sourceId, fileStat.st_mtime);
+			if (itemExists == false)
+			{
+				// Record it
+				history.insertItem("file://" + entryName, CrawlHistory::CRAWLED, m_sourceId, fileStat.st_mtime);
 #ifdef DEBUG
-			cout << "DirectoryScannerThread::scanEntry: reporting new file " << entryName << endl;
+				cout << "DirectoryScannerThread::scanEntry: reporting new file " << entryName << endl;
 #endif
-			reportFile = true;
-		}
-		else
-		{
-			// Update the record
-			history.updateItem("file://" + entryName, CrawlHistory::CRAWLED, fileStat.st_mtime);
+				reportFile = true;
+			}
+			else
+			{
+				// Update the record
+				history.updateItem("file://" + entryName, CrawlHistory::CRAWLED, fileStat.st_mtime);
 
-			// Was it last crawled after it was modified ?
-			if (itemDate < fileStat.st_mtime)
-			{
+				// Was it last crawled after it was modified ?
+				if (itemDate < fileStat.st_mtime)
+				{
 #ifdef DEBUG
-				cout << "DirectoryScannerThread::scanEntry: reporting modified file " << entryName << endl;
+					cout << "DirectoryScannerThread::scanEntry: reporting modified file " << entryName << endl;
 #endif
-				// No, crawl and index it again
-				reportFile = true;
+					// No, crawl and index it again
+					reportFile = true;
+				}
 			}
 		}
 
@@ -1849,8 +1851,9 @@
 	else if (S_ISDIR(fileStat.st_mode))
 	{
 		// Can we scan this directory ?
-		if ((m_maxLevel == 0) ||
-			(m_currentLevel < m_maxLevel))
+		if (((m_maxLevel == 0) ||
+			(m_currentLevel < m_maxLevel)) &&
+			(PinotSettings::getInstance().isBlackListed(entryName) == false))
 		{
 			++m_currentLevel;
 



From fabricecolin at mail.berlios.de  Sat Nov  4 05:13:46 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 05:13:46 +0100
Subject: [Pinot-svn] r561 - trunk
Message-ID: <200611040413.kA44Dkpq005023@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 05:13:46 +0100 (Sat, 04 Nov 2006)
New Revision: 561

Modified:
   trunk/README
Log:
Mention patterns, that the Flint backend is immune to the lock problem, when
monitor events are acted on, and that directory filters work as expected with
Xapian 0.9.8.


Modified: trunk/README
===================================================================
--- trunk/README	2006-11-04 04:11:16 UTC (rev 560)
+++ trunk/README	2006-11-04 04:13:46 UTC (rev 561)
@@ -70,6 +70,8 @@
     * mbox mail accounts. Monitoring is always enabled.
   Both are configured with the Indexing tab in the Preferences box and are
   handled by the D-Bus service.
+  if you want to exclude specific files or directories from indexing, use
+  patterns as described in section "8. File formats".
   See section "10. D-Bus service".
 
 
@@ -194,8 +196,10 @@
   These patterns are configured in the Indexing tab of the Preferences box.
   For example, "*.mp3" will skip all files with the extension "mp3", even
   though that particular document type is supported by Pinot.
+  Patterns also apply to directory; for instance "*/Desktop*" will skip
+  "~/Desktop" and not crawl nor monitor this directory's contents.
   If you have never run Pinot before, it will initialize the patterns list
-  to common picture and video types such as JPG, GIF, AVI and MPG.
+  to common picture, archive and video types such as JPG, GIF, ZIP and MPG.
 
 
 9. More Like This
@@ -234,6 +238,9 @@
      * when finished crawling, the service will monitor these locations
        for changes and should consume little resources, unless a huge
        quantity of files needs its attention.
+     * any change detected by the monitor is immediately acted upon, ie the
+       daemon will reindex right away a file that was modified. Future
+       releases will queue events and act on them only when the system is idle.
 
   If you have dbus-send installed, you can start the deamon manually by calling
   the GetStatistics method with
@@ -362,8 +369,10 @@
     of an "index error"
     This is likely because a previous instance didn't exit properly and one
     (or more) index is still locked. Quit Pinot and look for a "db_lock" file
-    in "~/.pinot/index" and "~/.pinot/mail". If it's there, delete it and
-    restart Pinot. This will be fixed in the future.
+    in "~/.pinot/index". If it's there, delete it and restart Pinot.
+    Starting with 0.60, indexes are created with the newer Flint back-end
+    which is immune to this issue. The easiest way to "upgrade" is to delete
+    the index, let Pinot recreate it, then reindex your data.
 
   * When compiling from source, you may run into linking problems related to
     libstdc++.la. Try patching xapian-config as explained in the post at
@@ -377,4 +386,8 @@
   * If you have built Pinot from source, make sure you have done a "make install".
     Pinot will fail to start if it can't find stuff it needs, its icon for instance.
 
+  * The directory filter doesn't work as expected if the filter starts with a
+    non alpha-numeric character
+    This has been fixed in Xapian 0.9.8.
 
+



From fabricecolin at mail.berlios.de  Sat Nov  4 06:46:09 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 06:46:09 +0100
Subject: [Pinot-svn] r562 - trunk/UI/GTK2/src
Message-ID: <200611040546.kA45k9gS013646@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 06:46:01 +0100 (Sat, 04 Nov 2006)
New Revision: 562

Modified:
   trunk/UI/GTK2/src/importDialog.cc
Log:
Removed unused variable.


Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-11-04 04:13:46 UTC (rev 561)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-11-04 05:46:01 UTC (rev 562)
@@ -221,7 +221,6 @@
 void importDialog::on_importButton_clicked()
 {
 	string location = from_utf8(locationEntry->get_text());
-	unsigned int level = 0;
 
 	// Rudimentary lock
 	if (m_state.m_importing == true)



From fabricecolin at mail.berlios.de  Sat Nov  4 06:59:04 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 06:59:04 +0100
Subject: [Pinot-svn] r563 - trunk/UI/GTK2/src
Message-ID: <200611040559.kA45x4rg027971@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 06:59:03 +0100 (Sat, 04 Nov 2006)
New Revision: 563

Modified:
   trunk/UI/GTK2/src/pinot.cc
Log:
Some strings were not localized.
Don't alarm the user if the daemon index cannot be open, it just means it's not
been created just yet.


Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2006-11-04 05:46:01 UTC (rev 562)
+++ trunk/UI/GTK2/src/pinot.cc	2006-11-04 05:59:03 UTC (rev 563)
@@ -200,17 +200,13 @@
 	if ((pFirstDb == NULL) ||
 		(pFirstDb->isOpen() == false))
 	{
-		errorMsg = "Couldn't open index ";
+		errorMsg = _("Couldn't open index");
+		errorMsg += " ";
 		errorMsg += settings.m_docsIndexLocation;
 	}
 	// ...and the daemon index in read-only mode
+	// If it can't be open, it just means the daemon has not yet created it
 	XapianDatabase *pSecondDb = XapianDatabaseFactory::getDatabase(settings.m_daemonIndexLocation);
-	if ((pSecondDb == NULL) ||
-		(pSecondDb->isOpen() == false))
-	{
-		errorMsg = "Couldn't open index ";
-		errorMsg += settings.m_daemonIndexLocation;
-	}
 	// Merge these two, this will be useful later
 	XapianDatabaseFactory::mergeDatabases("MERGED", pFirstDb, pSecondDb);
 
@@ -219,7 +215,8 @@
 		(QueryHistory::create(settings.m_historyDatabase) == false) ||
 		(ViewHistory::create(settings.m_historyDatabase) == false))
 	{
-		errorMsg = "Couldn't create history database ";
+		errorMsg = _("Couldn't create history database");
+		errorMsg += " ";
 		errorMsg += settings.m_historyDatabase;
 	}
 	else



From fabricecolin at mail.berlios.de  Sat Nov  4 11:23:46 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 11:23:46 +0100
Subject: [Pinot-svn] r564 - trunk
Message-ID: <200611041023.kA4ANkYA011235@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 11:23:46 +0100 (Sat, 04 Nov 2006)
New Revision: 564

Modified:
   trunk/AUTHORS
   trunk/TODO
Log:
Updates.


Modified: trunk/AUTHORS
===================================================================
--- trunk/AUTHORS	2006-11-04 05:59:03 UTC (rev 563)
+++ trunk/AUTHORS	2006-11-04 10:23:46 UTC (rev 564)
@@ -7,6 +7,7 @@
 	Building with CygWin - Reini Urban <rurban at x-ray dot at>
 	SuSE-friendly spec file - Marcus Rueckert <darix at web dot de>
 	Simplified UI - Manuel Breitfeld <manu_foren at gmx dot net>
+	Missing copyright notice - Gauvain Pocentek <gauvainpocentek at gmail dot com>
 
 The file Monitor/linux-inotify-syscalls.h is originally from libinotify
 (Copyright ? 2005 Ryan Lortie <desrt at desrt dot ca>).

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2006-11-04 05:59:03 UTC (rev 563)
+++ trunk/TODO	2006-11-04 10:23:46 UTC (rev 564)
@@ -3,7 +3,6 @@
 - Get rid of dead code/classes/methods...
 - Advertise service via Rendezvous
 - MIMEScanner should also return parent types so that we don't filter out types unnecessarily
-- Update to gtk+'s xdgmime as it seems to be the reference now
 - Build a -devel package for those who want to write their own tokenizers
 - Allow building without inotify/the DBus daemon
 
@@ -11,6 +10,7 @@
 - Allow to cache documents that had to be converted ? eg PDF, MS Word
 - PDF tokenizer with poppler
 - WordPerfect tokenizer with libwpd
+- Office tokenizer with libgst
 - Spin tokenizers into separate project, a la libextractor
 - Check whether pdftotext flattens text in PDF documents that have columns
 - HtmlTokenizer should skip htdig_noindex blocks (http://www.htdig.org/attrs.html#noindex_start)



From fabricecolin at mail.berlios.de  Sat Nov  4 11:25:00 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 11:25:00 +0100
Subject: [Pinot-svn] r565 - trunk
Message-ID: <200611041025.kA4AP0XF011330@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 11:25:00 +0100 (Sat, 04 Nov 2006)
New Revision: 565

Modified:
   trunk/pinot.spec.in
Log:
Merged text-docs into main package since most people only download that.


Modified: trunk/pinot.spec.in
===================================================================
--- trunk/pinot.spec.in	2006-11-04 10:23:46 UTC (rev 564)
+++ trunk/pinot.spec.in	2006-11-04 10:25:00 UTC (rev 565)
@@ -26,6 +26,8 @@
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
 Requires: xapian-core-libs >= 0.9.7, libtextcat >= 2.2, sqlite >= 3.1.2, curl >= 7.13, gmime >= 2.1
 Requires: gtkmm24 >= 2.6, libxml++ >= 2.12, %{dbus_pkg} >= 0.60, shared-mime-info
+Requires: unzip, antiword, unrtf, %{pftotext_pkg}
+Obsoletes: pinot-pdf, pinot-word, pinot-text-docs
 BuildRequires: xapian-core-devel >= 0.9.7, libtextcat-devel >= 2.2, sqlite-devel >= 3.1.2, curl-devel >= 7.13, gmime-devel >= 2.1, boost-devel >= 1.32
 BuildRequires: gtkmm24-devel >= 2.6, libxml++-devel >= 2.12, %{dbus_dev_pkg} >= 0.60, gettext-devel, desktop-file-utils
 BuildRequires: taglib-devel >= 1.4
@@ -39,17 +41,6 @@
 sources, display as well as analyze and locally index the returned results.
 It may also be used as a lightweight personal space search tool.
 
-%package text-docs 
-Summary: Tokenizers for Pinot that handle various text document formats
-Group: Applications/Internet
-Requires: %{name} = %{version}
-Requires: unzip, antiword, unrtf, %{pftotext_pkg}
-Obsoletes: pinot-pdf, pinot-word
-
-%description text-docs 
-The included tokenizers add support for OpenDocument, Sun StarOffice,
-PDF, MS Word and RTF documents.
-
 %package audio-docs 
 Summary: Tokenizers for Pinot that handle various audio document formats
 Group: Applications/Internet
@@ -108,6 +99,11 @@
 %{_datadir}/pinot/metase-gtk2.gladep
 %{_datadir}/pinot/pinot-dbus-daemon.xml
 %{_datadir}/pinot/textcat_conf.txt
+%{_datadir}/pinot/textcat3_conf.txt
+%{_datadir}/pinot/tokenizers/libopendocumenttokenizer.so
+%{_datadir}/pinot/tokenizers/libpdftokenizer.so
+%{_datadir}/pinot/tokenizers/librtftokenizer.so
+%{_datadir}/pinot/tokenizers/libwordtokenizer.so
 %{_datadir}/dbus-1/services/de.berlios.Pinot.service
 %{_datadir}/pinot/*.src
 %dir %{_datadir}/pinot/engines/
@@ -140,13 +136,6 @@
 %{_mandir}/man1/pinot-index.*
 %{_mandir}/man1/pinot-search.*
 
-%files text-docs 
-%defattr(-, root, root, -)
-%{_datadir}/pinot/tokenizers/libopendocumenttokenizer.so
-%{_datadir}/pinot/tokenizers/libpdftokenizer.so
-%{_datadir}/pinot/tokenizers/librtftokenizer.so
-%{_datadir}/pinot/tokenizers/libwordtokenizer.so
-
 %files audio-docs 
 %defattr(-, root, root, -)
 %{_datadir}/pinot/tokenizers/libtaglibtokenizer.so



From fabricecolin at mail.berlios.de  Sat Nov  4 14:17:37 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 14:17:37 +0100
Subject: [Pinot-svn] r567 - trunk
Message-ID: <200611041317.kA4DHbTJ032683@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 14:17:36 +0100 (Sat, 04 Nov 2006)
New Revision: 567

Modified:
   trunk/NEWS
Log:
List bug fixes and new features since 0.61.


Modified: trunk/NEWS
===================================================================
--- trunk/NEWS	2006-11-04 13:13:38 UTC (rev 566)
+++ trunk/NEWS	2006-11-04 13:17:36 UTC (rev 567)
@@ -1,3 +1,26 @@
+2006/11/04 version_0_6_2
+General :
+ - query shared-mime-info prefix, so that the applications database can be
+  loaded even when Pinot is installed under a different prefix
+ - copyright notice was missing in source
+Index :
+ - detect and support libtextcat 3.0 peculiarities
+ - can skip files based on glob pattern
+Search :
+ - fixed issue where label and directory filters were not applied correctly
+  when the filter doesn't start with an upper-case letter. Directory filters
+  starting with a non-alphanumeric character only work with Xapian >= 0.9.8.
+ - fixed A9, Accoona and Exalead plugins
+UI :
+ - file patterns to skip can be set in Preferences, Indexing
+ - columns showing a timestamp were sorted alphabetically
+ - refresh index lists correctly when exiting Preferences
+Daemon :
+ - fixed major bug where the daemon would loop endlessly reindexing mp3/ogg
+  files. When notified that a writable file was closed, check the file was
+  actually modified before reindexing it.
+ - fixed D-Bus warning about closing the connection when exiting
+
 2006/10/18 version_0_6_1
 General :
  - switched to gtk+'s version of xdgmime



From fabricecolin at mail.berlios.de  Sat Nov  4 14:13:39 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 14:13:39 +0100
Subject: [Pinot-svn] r566 - trunk/po
Message-ID: <200611041313.kA4DDdnL032322@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 14:13:38 +0100 (Sat, 04 Nov 2006)
New Revision: 566

Removed:
   trunk/po/en.po
Modified:
   trunk/po/es.po
   trunk/po/fr.po
Log:
Updated translations. I am taking over the Spanish po... only temporarily
hopefully :-)


Deleted: trunk/po/en.po
===================================================================
--- trunk/po/en.po	2006-11-04 10:25:00 UTC (rev 565)
+++ trunk/po/en.po	2006-11-04 13:13:38 UTC (rev 566)
@@ -1,841 +0,0 @@
-# en_GB PO file for pinot.
-# Copyright (C) 2005-2006 Fabrice Colin
-# This file is distributed under the same license as the pinot package.
-# Fabrice Colin <colinf at chez.com>, 2005-2006.
-#
-#, fuzzy
-msgid ""
-msgstr ""
-"Project-Id-Version: pinot 0.42\n"
-"Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2005-12-08 19:20+0800\n"
-"PO-Revision-Date: 2006-01-20 19:32+0800\n"
-"Last-Translator: Fabrice Colin <colinf at chez.com>\n"
-"Language-Team: en_GB <colinf at chez.com>\n"
-"MIME-Version: 1.0\n"
-"Content-Type: text/plain; charset=utf-8\n"
-"Content-Transfer-Encoding: 8bit\n"
-
-#: UI/GTK2/src/EnginesTree.cpp:67
-msgid "Search Engines"
-msgstr ""
-
-#: UI/GTK2/src/EnginesTree.cpp:291
-msgid "Current User"
-msgstr ""
-
-#: UI/GTK2/src/EnginesTree.cpp:303 UI/GTK2/src/mainWindow.cc:344
-#: UI/GTK2/src/mainWindow.cc:347 UI/GTK2/src/mainWindow.cc:520
-#: UI/GTK2/src/mainWindow.cc:1055 UI/GTK2/src/mainWindow.cc:1139
-#: UI/GTK2/src/mainWindow.cc:1174 UI/GTK2/src/mainWindow.cc:1787
-#: UI/GTK2/src/PinotSettings.cpp:199 UI/GTK2/src/PinotSettings.cpp:881
-#: UI/GTK2/src/PinotSettings.cpp:937
-msgid "My Documents"
-msgstr ""
-
-#: UI/GTK2/src/EnginesTree.cpp:307 UI/GTK2/src/mainWindow.cc:350
-#: UI/GTK2/src/mainWindow.cc:353 UI/GTK2/src/mainWindow.cc:524
-#: UI/GTK2/src/MonitorHandler.cpp:173 UI/GTK2/src/PinotSettings.cpp:200
-#: UI/GTK2/src/PinotSettings.cpp:882 UI/GTK2/src/PinotSettings.cpp:938
-#: UI/GTK2/src/prefsDialog_glade.cc:116
-msgid "My Email"
-msgstr ""
-
-#: UI/GTK2/src/importDialog.cc:108
-msgid "Enabled"
-msgstr ""
-
-#: UI/GTK2/src/importDialog.cc:109 UI/GTK2/src/prefsDialog.cc:78
-msgid "MIME Type"
-msgstr ""
-
-#: UI/GTK2/src/importDialog.cc:134
-msgid "File"
-msgstr ""
-
-#: UI/GTK2/src/importDialog.cc:137
-msgid "Directory"
-msgstr ""
-
-#: UI/GTK2/src/importDialog.cc:142 UI/GTK2/src/IndexTree.cpp:70
-#: UI/GTK2/src/ResultsTree.cpp:114
-msgid "URL"
-msgstr ""
-
-#: UI/GTK2/src/importDialog.cc:148 UI/GTK2/src/IndexPage.cpp:158
-#: UI/GTK2/src/IndexPage.cpp:204 UI/GTK2/src/queryDialog.cc:91
-msgid "None"
-msgstr ""
-
-#: UI/GTK2/src/importDialog.cc:444
-msgid "Document To Import"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:66 UI/GTK2/src/indexDialog_glade.cc:68
-msgid "Location:"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:67
-#: UI/GTK2/src/propertiesDialog_glade.cc:64
-msgid "Title:"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:70 UI/GTK2/src/indexDialog_glade.cc:67
-msgid "Type:"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:72 UI/GTK2/src/indexDialog_glade.cc:64
-#: UI/GTK2/src/prefsDialog_glade.cc:70
-msgid "..."
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:78
-msgid "Depth:"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:79
-msgid "Symlinks:"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:80
-msgid "Follow symlinks"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:83
-msgid "Apply label:"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:91 UI/GTK2/src/mainWindow_glade.cc:201
-msgid "Import"
-msgstr ""
-
-#: UI/GTK2/src/importDialog_glade.cc:211
-msgid "Import document"
-msgstr ""
-
-#: UI/GTK2/src/indexDialog.cc:221
-msgid "Index location"
-msgstr ""
-
-#: UI/GTK2/src/indexDialog_glade.cc:62 UI/GTK2/src/queryDialog_glade.cc:60
-msgid "Name:"
-msgstr ""
-
-#: UI/GTK2/src/indexDialog_glade.cc:69
-msgid "Port:"
-msgstr ""
-
-#: UI/GTK2/src/indexDialog_glade.cc:143
-msgid "External index"
-msgstr ""
-
-#: UI/GTK2/src/IndexTree.cpp:64 UI/GTK2/src/ResultsTree.cpp:96
-msgid "Title"
-msgstr ""
-
-#: UI/GTK2/src/IndexTree.cpp:75
-msgid "Timestamp"
-msgstr ""
-
-#: UI/GTK2/src/IndexPage.cpp:50
-msgid "Show Previous"
-msgstr ""
-
-#: UI/GTK2/src/IndexPage.cpp:56
-msgid "Show Next"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:148
-msgid "Query Name"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:153
-msgid "Last Run"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:154
-msgid "Summary"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:211
-msgid "Add index"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:212
-msgid "Remove index"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:235
-msgid "Ready"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:249 UI/GTK2/src/mainWindow.cc:1012
-#: UI/GTK2/src/mainWindow.cc:1384 UI/GTK2/src/mainWindow.cc:2956
-#: UI/GTK2/src/mainWindow_glade.cc:207
-msgid "View"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:281
-msgid "N/A"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:291
-msgid "<undefined>"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:482
-msgid "Result location is"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:535
-msgid "Document location is"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:644
-msgid "No label"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:793
-msgid "Showing"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:798
-msgid "off"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:803
-msgid "documents, starting at"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:837
-msgid "Query"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:841 UI/GTK2/src/mainWindow.cc:2786
-msgid "on"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:845
-msgid "ended"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:946 UI/GTK2/src/propertiesDialog.cc:40
-msgid "Label"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:950
-msgid "matches"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:955
-msgid "document(s)"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:987
-msgid "Updated label(s)"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1065 UI/GTK2/src/mainWindow.cc:1185
-msgid "Updated document"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1078
-msgid "Indexed"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1140
-msgid "Unindexed document(s)"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1236
-msgid "Couldn't rename index, name"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1240 UI/GTK2/src/mainWindow.cc:2141
-#: UI/GTK2/src/mainWindow.cc:2620
-msgid "is already in use"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1253
-msgid "Couldn't rename index"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1266
-msgid "Edited index"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1726 UI/GTK2/src/mainWindow.cc:1829
-msgid "Please set a location for the index first"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1753
-msgid "Result location is unknown"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1777
-msgid "Import Document(s)"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1907 UI/GTK2/src/pinot.cc:148
-#: UI/GTK2/src/pinot.cc:153 UI/GTK2/src/WorkerThreads.cpp:371
-#: UI/GTK2/src/WorkerThreads.cpp:608 UI/GTK2/src/WorkerThreads.cpp:1221
-msgid "Index"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:1911 UI/GTK2/src/WorkerThreads.cpp:375
-#: UI/GTK2/src/WorkerThreads.cpp:612 UI/GTK2/src/WorkerThreads.cpp:1225
-msgid "doesn't exist"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2021
-msgid "Delete this document from the index ?"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2040
-msgid "Delete these documents from the index ?"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2092
-msgid "A metasearch tool for the Free Desktop"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2093
-msgid "(C) 2005-2006 Fabrice Colin"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2137
-msgid "Index name"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2152
-msgid "Couldn't add index"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2166
-msgid "Added new index"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2201
-msgid "Couldn't remove index"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2435
-msgid "At least one task hasn't completed yet. Quit now ?"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2616
-msgid "Query name"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2643
-msgid "Couldn't update query"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2651
-msgid "Edited query"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2658
-msgid "Couldn't add query"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2666
-msgid "Added new query"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2680
-msgid "Query is not set"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2691
-msgid "No search engine selected"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2773
-msgid "Please set the Google API key first"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2782
-msgid "Running query"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2887
-msgid "is already indexed or is being indexed"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2914
-msgid "No URL to browse"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2925
-msgid "No browser configured to view results"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow.cc:2937
-msgid "Couldn't browse URL:"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:115
-msgid "Query:"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:127 UI/GTK2/src/prefsDialog_glade.cc:86
-msgid "Edit"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:136
-msgid "Stored queries"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:171
-msgid "Search Engine"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:174
-msgid "Host Name"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:177
-msgid "Clear List"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:180
-msgid "Show Extract"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:183
-msgid "Group By"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:189
-msgid "Vie_w"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:192
-msgid "View Cache"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:195 UI/GTK2/src/mainWindow_glade.cc:231
-msgid "_Index"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:198
-msgid "List Contents Of"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:210
-msgid "Update"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:213
-msgid "Unindex"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:216
-#: UI/GTK2/src/propertiesDialog_glade.cc:171
-#: UI/GTK2/src/queryDialog_glade.cc:83
-msgid "Properties"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:219
-msgid "_About"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:222
-msgid "_Session"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:225
-msgid "_Edit"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:228
-msgid "_Results"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:234
-msgid "_Help"
-msgstr ""
-
-#: UI/GTK2/src/mainWindow_glade.cc:356
-msgid "Pinot"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:56
-msgid "Couldn't save configuration file"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:117
-msgid "Danish"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:118
-msgid "Dutch"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:119
-msgid "English"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:120
-msgid "Finnish"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:121
-msgid "French"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:122
-msgid "German"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:123
-msgid "Italian"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:124
-msgid "Norwegian"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:125
-msgid "Portuguese"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:126
-msgid "Russian"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:127
-msgid "Spanish"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:128
-msgid "Swedish"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:149 UI/GTK2/src/pinot.cc:154
-msgid "is not valid, please check"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:162
-msgid "History database"
-msgstr ""
-
-#: UI/GTK2/src/pinot.cc:163
-msgid "couldn't be created"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:106
-msgid "Couldn't create pinot directory at"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:195
-msgid "Failed to parse configuration file"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:204
-msgid "Red"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:206
-msgid "Blue"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:208
-msgid "Green"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:289
-msgid "Couldn't load ui block"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:296
-msgid "Couldn't load extraindex block"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:303
-msgid "Couldn't load storedquery block"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:310
-msgid "Couldn't load results block"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:317
-msgid "Couldn't load label block"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:335
-msgid "Couldn't load mailaccount block"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:343
-msgid "Couldn't parse configuration file"
-msgstr ""
-
-#: UI/GTK2/src/PinotSettings.cpp:732
-msgid "Unclassified"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:69
-msgid "Name"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:77
-msgid "Location"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:114
-msgid "In internal viewer"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:117
-msgid "In browser"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:332
-msgid "Browser location"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:343
-msgid "New Label"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:365
-msgid "Colour"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog.cc:436 UI/GTK2/src/prefsDialog.cc:470
-msgid "Mbox File Location"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:62
-msgid "HTTP crawling:"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:63
-msgid "View documents:"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:64
-msgid "Browser:"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:65
-msgid "Google API key:"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:68
-msgid "Ignore robots.txt and Robots META tag"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:74
-msgid "General"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:75
-msgid "Labels are used to classify indexed documents:"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:80 UI/GTK2/src/prefsDialog_glade.cc:106
-msgid "Add"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:92
-msgid "Remove"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:100
-msgid "Labels"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:101
-msgid "Mail boxes of type mbox can be monitored and indexed:"
-msgstr ""
-
-#: UI/GTK2/src/prefsDialog_glade.cc:332
-msgid "Preferences"
-msgstr ""
-
-#: UI/GTK2/src/propertiesDialog.cc:51
-msgid "Unknown"
-msgstr ""
-
-#: UI/GTK2/src/propertiesDialog_glade.cc:65
-msgid "Extract:"
-msgstr ""
-
-#: UI/GTK2/src/propertiesDialog_glade.cc:66
-msgid "Language:"
-msgstr ""
-
-#: UI/GTK2/src/propertiesDialog_glade.cc:68
-msgid "MIME type:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog.cc:96 UI/GTK2/src/queryDialog.cc:125
-msgid "Any"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:70
-msgid "Index all results with label"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "Any of the words:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:73
-msgid "File name:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:74
-msgid "Number of results:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:77
-msgid "Host name:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:78
-msgid "None of the words:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:84
-msgid "Limit to documents that match"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:87
-msgid "the exact phrase:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:88
-msgid "the language:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:92
-msgid "all the words:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:93
-msgid "the label:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:98
-msgid "Advanced"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:283
-msgid "Query properties"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:350
-msgid "Stopped browsing"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:384 UI/GTK2/src/WorkerThreads.cpp:620
-#: UI/GTK2/src/WorkerThreads.cpp:665 UI/GTK2/src/WorkerThreads.cpp:675
-#: UI/GTK2/src/WorkerThreads.cpp:891 UI/GTK2/src/WorkerThreads.cpp:1106
-#: UI/GTK2/src/WorkerThreads.cpp:1234
-msgid "Index error on"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:490
-msgid "Stopped querying"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:502
-msgid "Couldn't create search engine"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:514
-msgid "Couldn't run query on search engine"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:530
-msgid "No title"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:592 UI/GTK2/src/WorkerThreads.cpp:656
-msgid "Stopped querying index labels"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:746
-msgid "Stopped retrieval of"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:782
-msgid "Couldn't obtain downloader for protocol"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:796 UI/GTK2/src/WorkerThreads.cpp:905
-msgid "Couldn't retrieve"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:876
-msgid "Stopped indexing"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:929
-msgid "Cannot index document type"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:933
-msgid "at"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:958
-msgid "Couldn't tokenize"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:979
-msgid "Robots META tag forbids indexing"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1029
-msgid "Couldn't index"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1094
-msgid "Stopped unindexing document(s)"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1114
-msgid "Couldn't unindex document(s)"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1206
-msgid "Stopped document update for "
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1243
-msgid "Couldn't update document"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1293
-msgid "Stopped listening on"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1396
-msgid "Couldn't read FIFO at"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1446
-msgid "Stopped monitoring"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1467
-msgid "No monitoring handler"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1514
-msgid "Couldn't open FAM connection"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1724
-msgid "Stopped scanning"
-msgstr ""
-
-#: UI/GTK2/src/WorkerThreads.cpp:1882
-msgid "Couldn't open directory"
-msgstr ""

Modified: trunk/po/es.po
===================================================================
--- trunk/po/es.po	2006-11-04 10:25:00 UTC (rev 565)
+++ trunk/po/es.po	2006-11-04 13:13:38 UTC (rev 566)
@@ -8,38 +8,38 @@
 msgstr ""
 "Project-Id-Version: pinot 0.49\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-10-17 21:42+0800\n"
-"PO-Revision-Date: 2006-10-18 20:38+0800\n"
-"Last-Translator: Jes?s Tramullas <jesus at tramullas.com>\n"
-"Language-Team: es <jesus at tramullas.com>\n"
+"POT-Creation-Date: 2006-11-04 13:55+0800\n"
+"PO-Revision-Date: 2006-11-04 21:10+0800\n"
+"Last-Translator: Fabrice Colin <fabricecolin at users.berlios.de>\n"
+"Language-Team: es <fabricecolin at users.berlios.de>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=utf-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: UI/GTK2/src/EnginesTree.cpp:66
+#: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
 msgstr "Motores de b?squeda"
 
-#: UI/GTK2/src/EnginesTree.cpp:328
+#: UI/GTK2/src/EnginesTree.cpp:330
 msgid "Current User"
 msgstr "Usuario"
 
-#: UI/GTK2/src/EnginesTree.cpp:339 UI/GTK2/src/mainWindow.cc:309
-#: UI/GTK2/src/mainWindow.cc:312 UI/GTK2/src/mainWindow.cc:538
-#: UI/GTK2/src/mainWindow.cc:1141 UI/GTK2/src/mainWindow.cc:1183
-#: UI/GTK2/src/mainWindow.cc:1203 UI/GTK2/src/mainWindow.cc:1234
-#: UI/GTK2/src/mainWindow.cc:1806 UI/GTK2/src/PinotSettings.cpp:231
-#: UI/GTK2/src/PinotSettings.cpp:1145 UI/GTK2/src/PinotSettings.cpp:1201
+#: UI/GTK2/src/EnginesTree.cpp:341 UI/GTK2/src/mainWindow.cc:317
+#: UI/GTK2/src/mainWindow.cc:320 UI/GTK2/src/mainWindow.cc:546
+#: UI/GTK2/src/mainWindow.cc:1149 UI/GTK2/src/mainWindow.cc:1191
+#: UI/GTK2/src/mainWindow.cc:1211 UI/GTK2/src/mainWindow.cc:1242
+#: UI/GTK2/src/mainWindow.cc:1816 UI/GTK2/src/PinotSettings.cpp:235
+#: UI/GTK2/src/PinotSettings.cpp:1222 UI/GTK2/src/PinotSettings.cpp:1278
 msgid "My Web Pages"
 msgstr "Mis Paginas Web"
 
-#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:303
-#: UI/GTK2/src/mainWindow.cc:306 UI/GTK2/src/PinotSettings.cpp:232
-#: UI/GTK2/src/PinotSettings.cpp:1146 UI/GTK2/src/PinotSettings.cpp:1202
+#: UI/GTK2/src/EnginesTree.cpp:342 UI/GTK2/src/mainWindow.cc:311
+#: UI/GTK2/src/mainWindow.cc:314 UI/GTK2/src/PinotSettings.cpp:236
+#: UI/GTK2/src/PinotSettings.cpp:1223 UI/GTK2/src/PinotSettings.cpp:1279
 msgid "My Documents"
 msgstr "Mis documentos"
 
-#: UI/GTK2/src/importDialog.cc:81 UI/GTK2/src/queryDialog.cc:79
+#: UI/GTK2/src/importDialog.cc:83 UI/GTK2/src/queryDialog.cc:81
 msgid "None"
 msgstr "Ninguno"
 
@@ -64,7 +64,7 @@
 msgid "Import URL"
 msgstr "Importar una URL"
 
-#: UI/GTK2/src/indexDialog.cc:223
+#: UI/GTK2/src/indexDialog.cc:225
 msgid "Index location"
 msgstr "Localizaci?n del ?ndice"
 
@@ -88,236 +88,236 @@
 msgid "External index"
 msgstr "?ndice externo"
 
-#: UI/GTK2/src/IndexTree.cpp:63 UI/GTK2/src/queryDialog.cc:107
-#: UI/GTK2/src/ResultsTree.cpp:131
+#: UI/GTK2/src/IndexTree.cpp:66 UI/GTK2/src/queryDialog.cc:109
+#: UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "T?tulo"
 
-#: UI/GTK2/src/IndexTree.cpp:68 UI/GTK2/src/queryDialog.cc:110
-#: UI/GTK2/src/ResultsTree.cpp:141
+#: UI/GTK2/src/IndexTree.cpp:71 UI/GTK2/src/queryDialog.cc:112
+#: UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/IndexTree.cpp:73
+#: UI/GTK2/src/IndexTree.cpp:76
 msgid "Timestamp"
 msgstr "Fecha"
 
-#: UI/GTK2/src/IndexPage.cpp:49
+#: UI/GTK2/src/IndexPage.cpp:51
 msgid "Show Previous"
 msgstr "Mostrar previos"
 
-#: UI/GTK2/src/IndexPage.cpp:55
+#: UI/GTK2/src/IndexPage.cpp:57
 msgid "Show Next"
 msgstr "Mostrar siguientes"
 
-#: UI/GTK2/src/IndexPage.cpp:157 UI/GTK2/src/IndexPage.cpp:203
+#: UI/GTK2/src/IndexPage.cpp:159 UI/GTK2/src/IndexPage.cpp:205
 msgid "All labels"
 msgstr "Todas las etiquetas"
 
-#: UI/GTK2/src/mainWindow.cc:138
+#: UI/GTK2/src/mainWindow.cc:140
 msgid "Query Name"
 msgstr "Nombre de la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:143
+#: UI/GTK2/src/mainWindow.cc:145
 msgid "Last Run"
 msgstr "?ltima ejecuci?n"
 
-#: UI/GTK2/src/mainWindow.cc:148
+#: UI/GTK2/src/mainWindow.cc:150
 msgid "Summary"
 msgstr "Sumario"
 
-#: UI/GTK2/src/mainWindow.cc:181
+#: UI/GTK2/src/mainWindow.cc:183
 msgid "Show all search engines"
 msgstr "Mostrar todos los motores de b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:182
+#: UI/GTK2/src/mainWindow.cc:184
 msgid "Add index"
 msgstr "A?adir ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:185
 msgid "Remove index"
 msgstr "Borrar ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:189
+#: UI/GTK2/src/mainWindow.cc:191
 msgid "Ready"
 msgstr "Listo"
 
-#: UI/GTK2/src/mainWindow.cc:232
+#: UI/GTK2/src/mainWindow.cc:235
 msgid "N/A"
 msgstr "Desconocido"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:250
 msgid "<undefined>"
 msgstr "<indefinido>"
 
-#: UI/GTK2/src/mainWindow.cc:461
+#: UI/GTK2/src/mainWindow.cc:469
 msgid "Result location is"
 msgstr "La localizaci?n del resultado es"
 
-#: UI/GTK2/src/mainWindow.cc:548
+#: UI/GTK2/src/mainWindow.cc:556
 msgid "Document location is"
 msgstr "La localizaci?n del documento es"
 
-#: UI/GTK2/src/mainWindow.cc:866
+#: UI/GTK2/src/mainWindow.cc:874
 msgid "Showing"
 msgstr "Mostrando"
 
-#: UI/GTK2/src/mainWindow.cc:871
+#: UI/GTK2/src/mainWindow.cc:879
 msgid "of"
 msgstr "documentos"
 
-#: UI/GTK2/src/mainWindow.cc:876
+#: UI/GTK2/src/mainWindow.cc:884
 msgid "documents, starting at"
 msgstr "documentos comenzando en"
 
-#: UI/GTK2/src/mainWindow.cc:909
+#: UI/GTK2/src/mainWindow.cc:917
 msgid "Query"
 msgstr "B?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:913 UI/GTK2/src/mainWindow.cc:2857
+#: UI/GTK2/src/mainWindow.cc:921 UI/GTK2/src/mainWindow.cc:2873
 msgid "on"
 msgstr "en"
 
-#: UI/GTK2/src/mainWindow.cc:917
+#: UI/GTK2/src/mainWindow.cc:925
 msgid "ended"
 msgstr "finalizado"
 
-#: UI/GTK2/src/mainWindow.cc:1006
+#: UI/GTK2/src/mainWindow.cc:1014
 msgid "More Like"
 msgstr "M?s como"
 
-#: UI/GTK2/src/mainWindow.cc:1067
+#: UI/GTK2/src/mainWindow.cc:1075
 msgid "Updated label(s)"
 msgstr "Etiqueta(s) actualizada(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1151
+#: UI/GTK2/src/mainWindow.cc:1159
 msgid "Updated document"
 msgstr "Documento actualizado"
 
-#: UI/GTK2/src/mainWindow.cc:1164
+#: UI/GTK2/src/mainWindow.cc:1172
 msgid "Indexed"
 msgstr "Indizado"
 
-#: UI/GTK2/src/mainWindow.cc:1204
+#: UI/GTK2/src/mainWindow.cc:1212
 msgid "Unindexed document(s)"
 msgstr "Documento(s) no indizado(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1245
+#: UI/GTK2/src/mainWindow.cc:1253
 msgid "Updated document properties"
 msgstr "Propiedades del documento actualizadas"
 
-#: UI/GTK2/src/mainWindow.cc:1292
+#: UI/GTK2/src/mainWindow.cc:1300
 msgid "Couldn't rename index, name"
 msgstr "No se pudo renombrar ?ndice, nombre"
 
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:2183
-#: UI/GTK2/src/mainWindow.cc:2692
+#: UI/GTK2/src/mainWindow.cc:1304 UI/GTK2/src/mainWindow.cc:2197
+#: UI/GTK2/src/mainWindow.cc:2708
 msgid "is already in use"
 msgstr "ya est? en uso"
 
-#: UI/GTK2/src/mainWindow.cc:1309
+#: UI/GTK2/src/mainWindow.cc:1317
 msgid "Couldn't rename index"
 msgstr "No se pudo renombrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1322
+#: UI/GTK2/src/mainWindow.cc:1330
 msgid "Edited index"
 msgstr "?ndice editado"
 
-#: UI/GTK2/src/mainWindow.cc:1688 UI/GTK2/src/mainWindow.cc:2353
+#: UI/GTK2/src/mainWindow.cc:1694 UI/GTK2/src/mainWindow.cc:2367
 msgid "Live query"
 msgstr "B?squeda activa"
 
-#: UI/GTK2/src/mainWindow.cc:1714
+#: UI/GTK2/src/mainWindow.cc:1720
 msgid "Couldn't find query"
 msgstr "No se pudo a?adir la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:1758 UI/GTK2/src/mainWindow.cc:1850
+#: UI/GTK2/src/mainWindow.cc:1764 UI/GTK2/src/mainWindow.cc:1860
 msgid "Please set a location for the index first"
 msgstr "Por favor, primero fije una localizaci?n para el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1923 UI/GTK2/src/WorkerThreads.cpp:620
-#: UI/GTK2/src/WorkerThreads.cpp:1396
+#: UI/GTK2/src/mainWindow.cc:1937 UI/GTK2/src/WorkerThreads.cpp:639
+#: UI/GTK2/src/WorkerThreads.cpp:1415
 msgid "Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1927 UI/GTK2/src/WorkerThreads.cpp:624
-#: UI/GTK2/src/WorkerThreads.cpp:1400
+#: UI/GTK2/src/mainWindow.cc:1941 UI/GTK2/src/WorkerThreads.cpp:643
+#: UI/GTK2/src/WorkerThreads.cpp:1419
 msgid "doesn't exist"
 msgstr "no existe"
 
-#: UI/GTK2/src/mainWindow.cc:2071
+#: UI/GTK2/src/mainWindow.cc:2085
 msgid "Remove this document from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:2090
+#: UI/GTK2/src/mainWindow.cc:2104
 msgid "Remove these documents from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:2134
+#: UI/GTK2/src/mainWindow.cc:2148
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Una herramienta metabuscador para el escritorio libre"
 
-#: UI/GTK2/src/mainWindow.cc:2135
+#: UI/GTK2/src/mainWindow.cc:2149
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2179
+#: UI/GTK2/src/mainWindow.cc:2193
 msgid "Index name"
 msgstr "Nombre del ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2194
+#: UI/GTK2/src/mainWindow.cc:2208
 msgid "Couldn't add index"
 msgstr "No se pudo a?adir el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2208
+#: UI/GTK2/src/mainWindow.cc:2222
 msgid "Added new index"
 msgstr "A?adido un nuevo ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2243
+#: UI/GTK2/src/mainWindow.cc:2257
 msgid "Couldn't remove index"
 msgstr "No se pudo borrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2506
+#: UI/GTK2/src/mainWindow.cc:2522
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Al menos una tarea no ha finalizado. ?Parar ahora?"
 
-#: UI/GTK2/src/mainWindow.cc:2688
+#: UI/GTK2/src/mainWindow.cc:2704
 msgid "Query name"
 msgstr "Nombre la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2715
+#: UI/GTK2/src/mainWindow.cc:2731
 msgid "Couldn't update query"
 msgstr "No se pudo actualizar la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2723
+#: UI/GTK2/src/mainWindow.cc:2739
 msgid "Edited query"
 msgstr "B?squeda editada"
 
-#: UI/GTK2/src/mainWindow.cc:2730
+#: UI/GTK2/src/mainWindow.cc:2746
 msgid "Couldn't add query"
 msgstr "No se pudo a?adir la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2738
+#: UI/GTK2/src/mainWindow.cc:2754
 msgid "Added new query"
 msgstr "A?adida una nueva b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2751
+#: UI/GTK2/src/mainWindow.cc:2767
 msgid "Query is not set"
 msgstr "B?squeda no definida"
 
-#: UI/GTK2/src/mainWindow.cc:2762
+#: UI/GTK2/src/mainWindow.cc:2778
 msgid "No search engine selected"
 msgstr "Motor de b?squeda no seleccionado"
 
-#: UI/GTK2/src/mainWindow.cc:2844
+#: UI/GTK2/src/mainWindow.cc:2860
 msgid "Please set the Google API key first"
 msgstr "Por favor, primero configure el API de Google"
 
-#: UI/GTK2/src/mainWindow.cc:2853
+#: UI/GTK2/src/mainWindow.cc:2869
 msgid "Running query"
 msgstr "Ejecutando la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:3023
+#: UI/GTK2/src/mainWindow.cc:3042
 msgid "No default application defined for type"
 msgstr "No hay aplicaci?n predefinida para el tipo"
 
@@ -414,95 +414,107 @@
 msgid "Pinot"
 msgstr "Pinot"
 
-#: UI/GTK2/src/pinot.cc:164 UI/GTK2/src/pinot-dbus-daemon.cc:680
+#: UI/GTK2/src/pinot.cc:167 UI/GTK2/src/pinot-dbus-daemon.cc:680
 msgid "Unknown"
 msgstr "Desconocido"
 
-#: UI/GTK2/src/pinot.cc:165 UI/GTK2/src/pinot-dbus-daemon.cc:681
+#: UI/GTK2/src/pinot.cc:168 UI/GTK2/src/pinot-dbus-daemon.cc:681
 msgid "Danish"
 msgstr "Dan?s"
 
-#: UI/GTK2/src/pinot.cc:166 UI/GTK2/src/pinot-dbus-daemon.cc:682
+#: UI/GTK2/src/pinot.cc:169 UI/GTK2/src/pinot-dbus-daemon.cc:682
 msgid "Dutch"
 msgstr "Holand?s"
 
-#: UI/GTK2/src/pinot.cc:167 UI/GTK2/src/pinot-dbus-daemon.cc:683
+#: UI/GTK2/src/pinot.cc:170 UI/GTK2/src/pinot-dbus-daemon.cc:683
 msgid "English"
 msgstr "Ingl?s"
 
-#: UI/GTK2/src/pinot.cc:168 UI/GTK2/src/pinot-dbus-daemon.cc:684
+#: UI/GTK2/src/pinot.cc:171 UI/GTK2/src/pinot-dbus-daemon.cc:684
 msgid "Finnish"
 msgstr "Finland?s"
 
-#: UI/GTK2/src/pinot.cc:169 UI/GTK2/src/pinot-dbus-daemon.cc:685
+#: UI/GTK2/src/pinot.cc:172 UI/GTK2/src/pinot-dbus-daemon.cc:685
 msgid "French"
 msgstr "Franc?s"
 
-#: UI/GTK2/src/pinot.cc:170 UI/GTK2/src/pinot-dbus-daemon.cc:686
+#: UI/GTK2/src/pinot.cc:173 UI/GTK2/src/pinot-dbus-daemon.cc:686
 msgid "German"
 msgstr "Alem?n"
 
-#: UI/GTK2/src/pinot.cc:171 UI/GTK2/src/pinot-dbus-daemon.cc:687
+#: UI/GTK2/src/pinot.cc:174 UI/GTK2/src/pinot-dbus-daemon.cc:687
 msgid "Italian"
 msgstr "Italiano"
 
-#: UI/GTK2/src/pinot.cc:172 UI/GTK2/src/pinot-dbus-daemon.cc:688
+#: UI/GTK2/src/pinot.cc:175 UI/GTK2/src/pinot-dbus-daemon.cc:688
 msgid "Norwegian"
 msgstr "Noruego"
 
-#: UI/GTK2/src/pinot.cc:173 UI/GTK2/src/pinot-dbus-daemon.cc:689
+#: UI/GTK2/src/pinot.cc:176 UI/GTK2/src/pinot-dbus-daemon.cc:689
 msgid "Portuguese"
 msgstr "Portugu?s"
 
-#: UI/GTK2/src/pinot.cc:174 UI/GTK2/src/pinot-dbus-daemon.cc:690
+#: UI/GTK2/src/pinot.cc:177 UI/GTK2/src/pinot-dbus-daemon.cc:690
 msgid "Russian"
 msgstr "Ruso"
 
-#: UI/GTK2/src/pinot.cc:175 UI/GTK2/src/pinot-dbus-daemon.cc:691
+#: UI/GTK2/src/pinot.cc:178 UI/GTK2/src/pinot-dbus-daemon.cc:691
 msgid "Spanish"
 msgstr "Espa?ol"
 
-#: UI/GTK2/src/pinot.cc:176 UI/GTK2/src/pinot-dbus-daemon.cc:692
+#: UI/GTK2/src/pinot.cc:179 UI/GTK2/src/pinot-dbus-daemon.cc:692
 msgid "Swedish"
 msgstr "Sueco"
 
-#: UI/GTK2/src/PinotSettings.cpp:237
+#: UI/GTK2/src/pinot.cc:203
+msgid "Couldn't open index"
+msgstr "No se pudo abrir el ?ndice"
+
+#: UI/GTK2/src/pinot.cc:218
+msgid "Couldn't create history database"
+msgstr "No se pudo crear la base de datos del hist?rico"
+
+#: UI/GTK2/src/PinotSettings.cpp:241
 msgid "Important"
 msgstr "Importante"
 
-#: UI/GTK2/src/PinotSettings.cpp:238
+#: UI/GTK2/src/PinotSettings.cpp:242
 msgid "New"
 msgstr "Nuevo"
 
-#: UI/GTK2/src/PinotSettings.cpp:239
+#: UI/GTK2/src/PinotSettings.cpp:243
 msgid "Personal"
 msgstr "Personal"
 
-#: UI/GTK2/src/PinotSettings.cpp:981
+#: UI/GTK2/src/PinotSettings.cpp:1047
 msgid "Unclassified"
 msgstr "No clasificado"
 
-#: UI/GTK2/src/prefsDialog.cc:65
+#: UI/GTK2/src/prefsDialog.cc:67
 msgid "Name"
 msgstr "Nombre"
 
-#: UI/GTK2/src/prefsDialog.cc:73
+#: UI/GTK2/src/prefsDialog.cc:75
 msgid "Monitor"
 msgstr "Supervisar"
 
-#: UI/GTK2/src/prefsDialog.cc:74 UI/GTK2/src/prefsDialog.cc:82
+#: UI/GTK2/src/prefsDialog.cc:76 UI/GTK2/src/prefsDialog.cc:84
 msgid "Location"
 msgstr "Localizaci?n"
 
-#: UI/GTK2/src/prefsDialog.cc:357
+#: UI/GTK2/src/prefsDialog.cc:92
+msgid "Pattern"
+msgstr "Patron"
+
+#: UI/GTK2/src/prefsDialog.cc:418
 msgid "New Label"
 msgstr "Nueva etiqueta"
 
-#: UI/GTK2/src/prefsDialog.cc:398
+#: UI/GTK2/src/prefsDialog.cc:459
 msgid "Directory to index"
 msgstr "Carpeta a indexar"
 
-#: UI/GTK2/src/prefsDialog.cc:456
+#: UI/GTK2/src/prefsDialog.cc:517
 msgid "Mbox File Location"
 msgstr "Localizaci?n del fichero mbox"
 
@@ -539,7 +551,7 @@
 msgstr "Las etiquetas se usan para clasificar los documentos indizados:"
 
 #: UI/GTK2/src/prefsDialog_glade.cc:82 UI/GTK2/src/prefsDialog_glade.cc:102
-#: UI/GTK2/src/prefsDialog_glade.cc:115
+#: UI/GTK2/src/prefsDialog_glade.cc:115 UI/GTK2/src/prefsDialog_glade.cc:128
 msgid "Add"
 msgstr "A?adir"
 
@@ -559,19 +571,23 @@
 msgid "Mail boxes of type mbox can be monitored and indexed:"
 msgstr "Los buzones de correo de tipo mbox pueden ser controlados e indizados"
 
-#: UI/GTK2/src/prefsDialog_glade.cc:124
+#: UI/GTK2/src/prefsDialog_glade.cc:123
+msgid "Specify any file pattern you wish to exclude from indexing:"
+msgstr "Especifique patrones que desea excluir del ?ndice:"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:137
 msgid "Indexing"
 msgstr "?ndices"
 
-#: UI/GTK2/src/prefsDialog_glade.cc:355
+#: UI/GTK2/src/prefsDialog_glade.cc:411
 msgid "Preferences"
 msgstr "Preferencias"
 
-#: UI/GTK2/src/propertiesDialog.cc:49 UI/GTK2/src/queryDialog.cc:122
+#: UI/GTK2/src/propertiesDialog.cc:51 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "Etiqueta"
 
-#: UI/GTK2/src/propertiesDialog.cc:62
+#: UI/GTK2/src/propertiesDialog.cc:64
 msgid "Per document"
 msgstr "Documento"
 
@@ -583,23 +599,23 @@
 msgid "MIME type:"
 msgstr "Tipo MIME:"
 
-#: UI/GTK2/src/queryDialog.cc:101
+#: UI/GTK2/src/queryDialog.cc:103
 msgid "Host name"
 msgstr "Nombre de servidor"
 
-#: UI/GTK2/src/queryDialog.cc:104
+#: UI/GTK2/src/queryDialog.cc:106
 msgid "File name"
 msgstr "Nombre de fichero"
 
-#: UI/GTK2/src/queryDialog.cc:113
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "Directory"
 msgstr "Carpeta"
 
-#: UI/GTK2/src/queryDialog.cc:116
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "Language code"
 msgstr "Codigo de idioma"
 
-#: UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "MIME type"
 msgstr "Tipo MIME"
 
@@ -623,72 +639,85 @@
 msgid "Query parameters"
 msgstr "Par?metros de b?squeda"
 
-#: UI/GTK2/src/ResultsTree.cpp:121
+#: UI/GTK2/src/ResultsTree.cpp:123
 msgid "Score"
 msgstr "Cuenta"
 
-#: UI/GTK2/src/WorkerThreads.cpp:633 UI/GTK2/src/WorkerThreads.cpp:909
-#: UI/GTK2/src/WorkerThreads.cpp:918 UI/GTK2/src/WorkerThreads.cpp:1084
-#: UI/GTK2/src/WorkerThreads.cpp:1285 UI/GTK2/src/WorkerThreads.cpp:1409
+#: UI/GTK2/src/WorkerThreads.cpp:302
+msgid "Can't index mail here"
+msgstr "No se pudo indizar el buzon de correo"
+
+#: UI/GTK2/src/WorkerThreads.cpp:323
+msgid "is already being indexed"
+msgstr "ya est? indizado"
+
+#: UI/GTK2/src/WorkerThreads.cpp:333
+msgid "is blacklisted"
+msgstr "ya excluido"
+
+#: UI/GTK2/src/WorkerThreads.cpp:341 UI/GTK2/src/WorkerThreads.cpp:652
+#: UI/GTK2/src/WorkerThreads.cpp:928 UI/GTK2/src/WorkerThreads.cpp:937
+#: UI/GTK2/src/WorkerThreads.cpp:1103 UI/GTK2/src/WorkerThreads.cpp:1304
+#: UI/GTK2/src/WorkerThreads.cpp:1428
 msgid "Index error on"
 msgstr "Error en el ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:752 UI/GTK2/src/WorkerThreads.cpp:853
+#: UI/GTK2/src/WorkerThreads.cpp:771 UI/GTK2/src/WorkerThreads.cpp:872
 msgid "Couldn't create search engine"
 msgstr "No se pudo crear el motor de b?squeda"
 
-#: UI/GTK2/src/WorkerThreads.cpp:764 UI/GTK2/src/WorkerThreads.cpp:867
+#: UI/GTK2/src/WorkerThreads.cpp:783 UI/GTK2/src/WorkerThreads.cpp:886
 msgid "Couldn't run query on search engine"
 msgstr "No se pudo ejecutar la b?squeda contra el motor"
 
-#: UI/GTK2/src/WorkerThreads.cpp:780
+#: UI/GTK2/src/WorkerThreads.cpp:799
 msgid "No title"
 msgstr "Sin t?tulo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:997
+#: UI/GTK2/src/WorkerThreads.cpp:1016
 msgid "Couldn't obtain downloader for protocol"
 msgstr "No se pudo usar un recuperador para el protocolo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1008
+#: UI/GTK2/src/WorkerThreads.cpp:1027
 msgid "Couldn't retrieve"
 msgstr "No se pudo descargar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1134
+#: UI/GTK2/src/WorkerThreads.cpp:1153
 msgid "Cannot index document type"
 msgstr "No se pudo indizar el tipo de documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1138
+#: UI/GTK2/src/WorkerThreads.cpp:1157
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1160
+#: UI/GTK2/src/WorkerThreads.cpp:1179
 msgid "Couldn't tokenize"
 msgstr "No se pudo extraer cadenas"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1180
+#: UI/GTK2/src/WorkerThreads.cpp:1199
 msgid "Robots META tag forbids indexing"
 msgstr "La etiqueta META Robots proh?be la indizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1215
+#: UI/GTK2/src/WorkerThreads.cpp:1234
 msgid "Couldn't index"
 msgstr "No se pudo indizar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1296
+#: UI/GTK2/src/WorkerThreads.cpp:1315
 msgid "Couldn't unindex document(s)"
 msgstr "No se pudo des-indizar lo(s) documento(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1421
+#: UI/GTK2/src/WorkerThreads.cpp:1440
 msgid "Couldn't update document"
 msgstr "No se pudo actualizar el documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1578
+#: UI/GTK2/src/WorkerThreads.cpp:1616
 msgid "No monitoring handler"
 msgstr "No hay monitorizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1620
+#: UI/GTK2/src/WorkerThreads.cpp:1658
 msgid "Couldn't initialize file monitor"
 msgstr "No se puede inicializar el monitor de archivo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1896
+#: UI/GTK2/src/WorkerThreads.cpp:1940
 msgid "Couldn't open directory"
 msgstr "No se pudo abrir el directorio"

Modified: trunk/po/fr.po
===================================================================
--- trunk/po/fr.po	2006-11-04 10:25:00 UTC (rev 565)
+++ trunk/po/fr.po	2006-11-04 13:13:38 UTC (rev 566)
@@ -1,45 +1,45 @@
 # fr PO file for pinot.
 # Copyright (C) 2005 Fabrice Colin
 # This file is distributed under the same license as the pinot package.
-# Fabrice Colin <colinf at chez.com>, 2005.
+# Fabrice Colin <fabricecolin at users.berlios.de>, 2005.
 #
 #, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.49\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-10-17 21:42+0800\n"
-"PO-Revision-Date: 2006-10-18 20:38+0800\n"
-"Last-Translator: Fabrice Colin <colinf at chez.com>\n"
-"Language-Team: fr <colinf at chez.com>\n"
+"POT-Creation-Date: 2006-11-04 13:55+0800\n"
+"PO-Revision-Date: 2006-11-04 21:10+0800\n"
+"Last-Translator: Fabrice Colin <fabricecolin at users.berlios.de>\n"
+"Language-Team: fr <fabricecolin at users.berlios.de>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=utf-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: UI/GTK2/src/EnginesTree.cpp:66
+#: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
 msgstr "Moteurs"
 
-#: UI/GTK2/src/EnginesTree.cpp:328
+#: UI/GTK2/src/EnginesTree.cpp:330
 msgid "Current User"
 msgstr "Utilisateur"
 
-#: UI/GTK2/src/EnginesTree.cpp:339 UI/GTK2/src/mainWindow.cc:309
-#: UI/GTK2/src/mainWindow.cc:312 UI/GTK2/src/mainWindow.cc:538
-#: UI/GTK2/src/mainWindow.cc:1141 UI/GTK2/src/mainWindow.cc:1183
-#: UI/GTK2/src/mainWindow.cc:1203 UI/GTK2/src/mainWindow.cc:1234
-#: UI/GTK2/src/mainWindow.cc:1806 UI/GTK2/src/PinotSettings.cpp:231
-#: UI/GTK2/src/PinotSettings.cpp:1145 UI/GTK2/src/PinotSettings.cpp:1201
+#: UI/GTK2/src/EnginesTree.cpp:341 UI/GTK2/src/mainWindow.cc:317
+#: UI/GTK2/src/mainWindow.cc:320 UI/GTK2/src/mainWindow.cc:546
+#: UI/GTK2/src/mainWindow.cc:1149 UI/GTK2/src/mainWindow.cc:1191
+#: UI/GTK2/src/mainWindow.cc:1211 UI/GTK2/src/mainWindow.cc:1242
+#: UI/GTK2/src/mainWindow.cc:1816 UI/GTK2/src/PinotSettings.cpp:235
+#: UI/GTK2/src/PinotSettings.cpp:1222 UI/GTK2/src/PinotSettings.cpp:1278
 msgid "My Web Pages"
 msgstr "Mes Pages Web"
 
-#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:303
-#: UI/GTK2/src/mainWindow.cc:306 UI/GTK2/src/PinotSettings.cpp:232
-#: UI/GTK2/src/PinotSettings.cpp:1146 UI/GTK2/src/PinotSettings.cpp:1202
+#: UI/GTK2/src/EnginesTree.cpp:342 UI/GTK2/src/mainWindow.cc:311
+#: UI/GTK2/src/mainWindow.cc:314 UI/GTK2/src/PinotSettings.cpp:236
+#: UI/GTK2/src/PinotSettings.cpp:1223 UI/GTK2/src/PinotSettings.cpp:1279
 msgid "My Documents"
 msgstr "Mes Documents"
 
-#: UI/GTK2/src/importDialog.cc:81 UI/GTK2/src/queryDialog.cc:79
+#: UI/GTK2/src/importDialog.cc:83 UI/GTK2/src/queryDialog.cc:81
 msgid "None"
 msgstr "Aucune"
 
@@ -64,7 +64,7 @@
 msgid "Import URL"
 msgstr "Importer une URL"
 
-#: UI/GTK2/src/indexDialog.cc:223
+#: UI/GTK2/src/indexDialog.cc:225
 msgid "Index location"
 msgstr "Chemin de l'index"
 
@@ -88,236 +88,236 @@
 msgid "External index"
 msgstr "Index externe"
 
-#: UI/GTK2/src/IndexTree.cpp:63 UI/GTK2/src/queryDialog.cc:107
-#: UI/GTK2/src/ResultsTree.cpp:131
+#: UI/GTK2/src/IndexTree.cpp:66 UI/GTK2/src/queryDialog.cc:109
+#: UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "Titre"
 
-#: UI/GTK2/src/IndexTree.cpp:68 UI/GTK2/src/queryDialog.cc:110
-#: UI/GTK2/src/ResultsTree.cpp:141
+#: UI/GTK2/src/IndexTree.cpp:71 UI/GTK2/src/queryDialog.cc:112
+#: UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/IndexTree.cpp:73
+#: UI/GTK2/src/IndexTree.cpp:76
 msgid "Timestamp"
 msgstr "Date"
 
-#: UI/GTK2/src/IndexPage.cpp:49
+#: UI/GTK2/src/IndexPage.cpp:51
 msgid "Show Previous"
 msgstr "Precedents"
 
-#: UI/GTK2/src/IndexPage.cpp:55
+#: UI/GTK2/src/IndexPage.cpp:57
 msgid "Show Next"
 msgstr "Suivants"
 
-#: UI/GTK2/src/IndexPage.cpp:157 UI/GTK2/src/IndexPage.cpp:203
+#: UI/GTK2/src/IndexPage.cpp:159 UI/GTK2/src/IndexPage.cpp:205
 msgid "All labels"
 msgstr "Toutes les etiquettes"
 
-#: UI/GTK2/src/mainWindow.cc:138
+#: UI/GTK2/src/mainWindow.cc:140
 msgid "Query Name"
 msgstr "Nom de la Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:143
+#: UI/GTK2/src/mainWindow.cc:145
 msgid "Last Run"
 msgstr "Derniere Utilisation"
 
-#: UI/GTK2/src/mainWindow.cc:148
+#: UI/GTK2/src/mainWindow.cc:150
 msgid "Summary"
 msgstr "Sommaire"
 
-#: UI/GTK2/src/mainWindow.cc:181
+#: UI/GTK2/src/mainWindow.cc:183
 msgid "Show all search engines"
 msgstr "Montrer tous les moteurs"
 
-#: UI/GTK2/src/mainWindow.cc:182
+#: UI/GTK2/src/mainWindow.cc:184
 msgid "Add index"
 msgstr "Ajouter un index"
 
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:185
 msgid "Remove index"
 msgstr "Enlever un index"
 
-#: UI/GTK2/src/mainWindow.cc:189
+#: UI/GTK2/src/mainWindow.cc:191
 msgid "Ready"
 msgstr "Pret"
 
-#: UI/GTK2/src/mainWindow.cc:232
+#: UI/GTK2/src/mainWindow.cc:235
 msgid "N/A"
 msgstr "Inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:250
 msgid "<undefined>"
 msgstr "<inconnu>"
 
-#: UI/GTK2/src/mainWindow.cc:461
+#: UI/GTK2/src/mainWindow.cc:469
 msgid "Result location is"
 msgstr "Le chemin du resultat est"
 
-#: UI/GTK2/src/mainWindow.cc:548
+#: UI/GTK2/src/mainWindow.cc:556
 msgid "Document location is"
 msgstr "Le chemin du document is"
 
-#: UI/GTK2/src/mainWindow.cc:866
+#: UI/GTK2/src/mainWindow.cc:874
 msgid "Showing"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:871
+#: UI/GTK2/src/mainWindow.cc:879
 msgid "of"
 msgstr "documents,"
 
-#: UI/GTK2/src/mainWindow.cc:876
+#: UI/GTK2/src/mainWindow.cc:884
 msgid "documents, starting at"
 msgstr "au total, a partir de"
 
-#: UI/GTK2/src/mainWindow.cc:909
+#: UI/GTK2/src/mainWindow.cc:917
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:913 UI/GTK2/src/mainWindow.cc:2857
+#: UI/GTK2/src/mainWindow.cc:921 UI/GTK2/src/mainWindow.cc:2873
 msgid "on"
 msgstr "sur"
 
-#: UI/GTK2/src/mainWindow.cc:917
+#: UI/GTK2/src/mainWindow.cc:925
 msgid "ended"
 msgstr "est terminee"
 
-#: UI/GTK2/src/mainWindow.cc:1006
+#: UI/GTK2/src/mainWindow.cc:1014
 msgid "More Like"
 msgstr "Similaire a"
 
-#: UI/GTK2/src/mainWindow.cc:1067
+#: UI/GTK2/src/mainWindow.cc:1075
 msgid "Updated label(s)"
 msgstr "Mis a jour l(es) etiquette(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1151
+#: UI/GTK2/src/mainWindow.cc:1159
 msgid "Updated document"
 msgstr "Mis a jour le document"
 
-#: UI/GTK2/src/mainWindow.cc:1164
+#: UI/GTK2/src/mainWindow.cc:1172
 msgid "Indexed"
 msgstr "Indexe"
 
-#: UI/GTK2/src/mainWindow.cc:1204
+#: UI/GTK2/src/mainWindow.cc:1212
 msgid "Unindexed document(s)"
 msgstr "Desindexe le(s) document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1245
+#: UI/GTK2/src/mainWindow.cc:1253
 msgid "Updated document properties"
 msgstr "Mis a jour les proprietes du document"
 
-#: UI/GTK2/src/mainWindow.cc:1292
+#: UI/GTK2/src/mainWindow.cc:1300
 msgid "Couldn't rename index, name"
 msgstr "N'a pas pu renommer l'index, le nom"
 
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:2183
-#: UI/GTK2/src/mainWindow.cc:2692
+#: UI/GTK2/src/mainWindow.cc:1304 UI/GTK2/src/mainWindow.cc:2197
+#: UI/GTK2/src/mainWindow.cc:2708
 msgid "is already in use"
 msgstr "est deja utilise"
 
-#: UI/GTK2/src/mainWindow.cc:1309
+#: UI/GTK2/src/mainWindow.cc:1317
 msgid "Couldn't rename index"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1322
+#: UI/GTK2/src/mainWindow.cc:1330
 msgid "Edited index"
 msgstr "Edite l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1688 UI/GTK2/src/mainWindow.cc:2353
+#: UI/GTK2/src/mainWindow.cc:1694 UI/GTK2/src/mainWindow.cc:2367
 msgid "Live query"
 msgstr "Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:1714
+#: UI/GTK2/src/mainWindow.cc:1720
 msgid "Couldn't find query"
 msgstr "N'a pas pu trouver"
 
-#: UI/GTK2/src/mainWindow.cc:1758 UI/GTK2/src/mainWindow.cc:1850
+#: UI/GTK2/src/mainWindow.cc:1764 UI/GTK2/src/mainWindow.cc:1860
 msgid "Please set a location for the index first"
 msgstr "Donnez un chemin a l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1923 UI/GTK2/src/WorkerThreads.cpp:620
-#: UI/GTK2/src/WorkerThreads.cpp:1396
+#: UI/GTK2/src/mainWindow.cc:1937 UI/GTK2/src/WorkerThreads.cpp:639
+#: UI/GTK2/src/WorkerThreads.cpp:1415
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:1927 UI/GTK2/src/WorkerThreads.cpp:624
-#: UI/GTK2/src/WorkerThreads.cpp:1400
+#: UI/GTK2/src/mainWindow.cc:1941 UI/GTK2/src/WorkerThreads.cpp:643
+#: UI/GTK2/src/WorkerThreads.cpp:1419
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
-#: UI/GTK2/src/mainWindow.cc:2071
+#: UI/GTK2/src/mainWindow.cc:2085
 msgid "Remove this document from the index ?"
 msgstr "Enlever ce document de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2090
+#: UI/GTK2/src/mainWindow.cc:2104
 msgid "Remove these documents from the index ?"
 msgstr "Enlever ces documents de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2134
+#: UI/GTK2/src/mainWindow.cc:2148
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Un outil de recherche pour le Bureau Libre"
 
-#: UI/GTK2/src/mainWindow.cc:2135
+#: UI/GTK2/src/mainWindow.cc:2149
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2179
+#: UI/GTK2/src/mainWindow.cc:2193
 msgid "Index name"
 msgstr "Nom de l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2194
+#: UI/GTK2/src/mainWindow.cc:2208
 msgid "Couldn't add index"
 msgstr "N'a pas pu ajouter l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2208
+#: UI/GTK2/src/mainWindow.cc:2222
 msgid "Added new index"
 msgstr "Ajoute un nouvel index"
 
-#: UI/GTK2/src/mainWindow.cc:2243
+#: UI/GTK2/src/mainWindow.cc:2257
 msgid "Couldn't remove index"
 msgstr "N'a pas pu enlever l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2506
+#: UI/GTK2/src/mainWindow.cc:2522
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2688
+#: UI/GTK2/src/mainWindow.cc:2704
 msgid "Query name"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2715
+#: UI/GTK2/src/mainWindow.cc:2731
 msgid "Couldn't update query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2723
+#: UI/GTK2/src/mainWindow.cc:2739
 msgid "Edited query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2730
+#: UI/GTK2/src/mainWindow.cc:2746
 msgid "Couldn't add query"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2738
+#: UI/GTK2/src/mainWindow.cc:2754
 msgid "Added new query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2751
+#: UI/GTK2/src/mainWindow.cc:2767
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2762
+#: UI/GTK2/src/mainWindow.cc:2778
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:2844
+#: UI/GTK2/src/mainWindow.cc:2860
 msgid "Please set the Google API key first"
 msgstr "Configurez la clef de l'API Google "
 
-#: UI/GTK2/src/mainWindow.cc:2853
+#: UI/GTK2/src/mainWindow.cc:2869
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:3023
+#: UI/GTK2/src/mainWindow.cc:3042
 msgid "No default application defined for type"
 msgstr "Pas d'application definie pour le type"
 
@@ -414,95 +414,107 @@
 msgid "Pinot"
 msgstr "Pinot"
 
-#: UI/GTK2/src/pinot.cc:164 UI/GTK2/src/pinot-dbus-daemon.cc:680
+#: UI/GTK2/src/pinot.cc:167 UI/GTK2/src/pinot-dbus-daemon.cc:680
 msgid "Unknown"
 msgstr "Inconnu"
 
-#: UI/GTK2/src/pinot.cc:165 UI/GTK2/src/pinot-dbus-daemon.cc:681
+#: UI/GTK2/src/pinot.cc:168 UI/GTK2/src/pinot-dbus-daemon.cc:681
 msgid "Danish"
 msgstr "Danois"
 
-#: UI/GTK2/src/pinot.cc:166 UI/GTK2/src/pinot-dbus-daemon.cc:682
+#: UI/GTK2/src/pinot.cc:169 UI/GTK2/src/pinot-dbus-daemon.cc:682
 msgid "Dutch"
 msgstr "Hollandais"
 
-#: UI/GTK2/src/pinot.cc:167 UI/GTK2/src/pinot-dbus-daemon.cc:683
+#: UI/GTK2/src/pinot.cc:170 UI/GTK2/src/pinot-dbus-daemon.cc:683
 msgid "English"
 msgstr "Anglais"
 
-#: UI/GTK2/src/pinot.cc:168 UI/GTK2/src/pinot-dbus-daemon.cc:684
+#: UI/GTK2/src/pinot.cc:171 UI/GTK2/src/pinot-dbus-daemon.cc:684
 msgid "Finnish"
 msgstr "Finlandais"
 
-#: UI/GTK2/src/pinot.cc:169 UI/GTK2/src/pinot-dbus-daemon.cc:685
+#: UI/GTK2/src/pinot.cc:172 UI/GTK2/src/pinot-dbus-daemon.cc:685
 msgid "French"
 msgstr "Francais"
 
-#: UI/GTK2/src/pinot.cc:170 UI/GTK2/src/pinot-dbus-daemon.cc:686
+#: UI/GTK2/src/pinot.cc:173 UI/GTK2/src/pinot-dbus-daemon.cc:686
 msgid "German"
 msgstr "Allemand"
 
-#: UI/GTK2/src/pinot.cc:171 UI/GTK2/src/pinot-dbus-daemon.cc:687
+#: UI/GTK2/src/pinot.cc:174 UI/GTK2/src/pinot-dbus-daemon.cc:687
 msgid "Italian"
 msgstr "Italien"
 
-#: UI/GTK2/src/pinot.cc:172 UI/GTK2/src/pinot-dbus-daemon.cc:688
+#: UI/GTK2/src/pinot.cc:175 UI/GTK2/src/pinot-dbus-daemon.cc:688
 msgid "Norwegian"
 msgstr "Norvegien"
 
-#: UI/GTK2/src/pinot.cc:173 UI/GTK2/src/pinot-dbus-daemon.cc:689
+#: UI/GTK2/src/pinot.cc:176 UI/GTK2/src/pinot-dbus-daemon.cc:689
 msgid "Portuguese"
 msgstr "Portugais"
 
-#: UI/GTK2/src/pinot.cc:174 UI/GTK2/src/pinot-dbus-daemon.cc:690
+#: UI/GTK2/src/pinot.cc:177 UI/GTK2/src/pinot-dbus-daemon.cc:690
 msgid "Russian"
 msgstr "Russe"
 
-#: UI/GTK2/src/pinot.cc:175 UI/GTK2/src/pinot-dbus-daemon.cc:691
+#: UI/GTK2/src/pinot.cc:178 UI/GTK2/src/pinot-dbus-daemon.cc:691
 msgid "Spanish"
 msgstr "Espagnol"
 
-#: UI/GTK2/src/pinot.cc:176 UI/GTK2/src/pinot-dbus-daemon.cc:692
+#: UI/GTK2/src/pinot.cc:179 UI/GTK2/src/pinot-dbus-daemon.cc:692
 msgid "Swedish"
 msgstr "Suedois"
 
-#: UI/GTK2/src/PinotSettings.cpp:237
+#: UI/GTK2/src/pinot.cc:203
+msgid "Couldn't open index"
+msgstr "N'a pas pu ouvrir l'index"
+
+#: UI/GTK2/src/pinot.cc:218
+msgid "Couldn't create history database"
+msgstr "N'a pas pu creer la base d'historiques"
+
+#: UI/GTK2/src/PinotSettings.cpp:241
 msgid "Important"
 msgstr "Important"
 
-#: UI/GTK2/src/PinotSettings.cpp:238
+#: UI/GTK2/src/PinotSettings.cpp:242
 msgid "New"
 msgstr "Nouveau"
 
-#: UI/GTK2/src/PinotSettings.cpp:239
+#: UI/GTK2/src/PinotSettings.cpp:243
 msgid "Personal"
 msgstr "Personnel"
 
-#: UI/GTK2/src/PinotSettings.cpp:981
+#: UI/GTK2/src/PinotSettings.cpp:1047
 msgid "Unclassified"
 msgstr "Sans classification"
 
-#: UI/GTK2/src/prefsDialog.cc:65
+#: UI/GTK2/src/prefsDialog.cc:67
 msgid "Name"
 msgstr "Nom"
 
-#: UI/GTK2/src/prefsDialog.cc:73
+#: UI/GTK2/src/prefsDialog.cc:75
 msgid "Monitor"
 msgstr "Surveiller"
 
-#: UI/GTK2/src/prefsDialog.cc:74 UI/GTK2/src/prefsDialog.cc:82
+#: UI/GTK2/src/prefsDialog.cc:76 UI/GTK2/src/prefsDialog.cc:84
 msgid "Location"
 msgstr "Chemin"
 
-#: UI/GTK2/src/prefsDialog.cc:357
+#: UI/GTK2/src/prefsDialog.cc:92
+msgid "Pattern"
+msgstr "Motif"
+
+#: UI/GTK2/src/prefsDialog.cc:418
 msgid "New Label"
 msgstr "Nouvelle Etiquette"
 
-#: UI/GTK2/src/prefsDialog.cc:398
+#: UI/GTK2/src/prefsDialog.cc:459
 msgid "Directory to index"
 msgstr "Repertoire a indexer"
 
-#: UI/GTK2/src/prefsDialog.cc:456
+#: UI/GTK2/src/prefsDialog.cc:517
 msgid "Mbox File Location"
 msgstr "Chemin du Fichier mbox"
 
@@ -539,7 +551,7 @@
 msgstr "Les etiquettes servent a classer les documents:"
 
 #: UI/GTK2/src/prefsDialog_glade.cc:82 UI/GTK2/src/prefsDialog_glade.cc:102
-#: UI/GTK2/src/prefsDialog_glade.cc:115
+#: UI/GTK2/src/prefsDialog_glade.cc:115 UI/GTK2/src/prefsDialog_glade.cc:128
 msgid "Add"
 msgstr "Ajouter"
 
@@ -557,21 +569,25 @@
 
 #: UI/GTK2/src/prefsDialog_glade.cc:110
 msgid "Mail boxes of type mbox can be monitored and indexed:"
-msgstr "Les boites de type mbox peuvent etre indexees"
+msgstr "Les boites a courrier de type mbox peuvent etre indexees"
 
-#: UI/GTK2/src/prefsDialog_glade.cc:124
+#: UI/GTK2/src/prefsDialog_glade.cc:123
+msgid "Specify any file pattern you wish to exclude from indexing:"
+msgstr "Specifiez tous les motifs de fichiers a ne pas indexer:"
+
+#: UI/GTK2/src/prefsDialog_glade.cc:137
 msgid "Indexing"
 msgstr "Indexes"
 
-#: UI/GTK2/src/prefsDialog_glade.cc:355
+#: UI/GTK2/src/prefsDialog_glade.cc:411
 msgid "Preferences"
 msgstr "Preferences"
 
-#: UI/GTK2/src/propertiesDialog.cc:49 UI/GTK2/src/queryDialog.cc:122
+#: UI/GTK2/src/propertiesDialog.cc:51 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "L'etiquette"
 
-#: UI/GTK2/src/propertiesDialog.cc:62
+#: UI/GTK2/src/propertiesDialog.cc:64
 msgid "Per document"
 msgstr "Par document"
 
@@ -583,23 +599,23 @@
 msgid "MIME type:"
 msgstr "Type MIME:"
 
-#: UI/GTK2/src/queryDialog.cc:101
+#: UI/GTK2/src/queryDialog.cc:103
 msgid "Host name"
 msgstr "Nom de machine"
 
-#: UI/GTK2/src/queryDialog.cc:104
+#: UI/GTK2/src/queryDialog.cc:106
 msgid "File name"
 msgstr "Nom de ficher"
 
-#: UI/GTK2/src/queryDialog.cc:113
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "Directory"
 msgstr "Repertoire"
 
-#: UI/GTK2/src/queryDialog.cc:116
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "Language code"
 msgstr "Code langue"
 
-#: UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "MIME type"
 msgstr "Type MIME"
 
@@ -623,72 +639,86 @@
 msgid "Query parameters"
 msgstr "Parametres de la recherche"
 
-#: UI/GTK2/src/ResultsTree.cpp:121
+#: UI/GTK2/src/ResultsTree.cpp:123
 msgid "Score"
 msgstr "Score"
 
-#: UI/GTK2/src/WorkerThreads.cpp:633 UI/GTK2/src/WorkerThreads.cpp:909
-#: UI/GTK2/src/WorkerThreads.cpp:918 UI/GTK2/src/WorkerThreads.cpp:1084
-#: UI/GTK2/src/WorkerThreads.cpp:1285 UI/GTK2/src/WorkerThreads.cpp:1409
+#: UI/GTK2/src/WorkerThreads.cpp:302
+#, fuzzy
+msgid "Can't index mail here"
+msgstr "Ne peut pas indexer le courrier ici"
+
+#: UI/GTK2/src/WorkerThreads.cpp:323
+msgid "is already being indexed"
+msgstr "est deja indexe"
+
+#: UI/GTK2/src/WorkerThreads.cpp:333
+msgid "is blacklisted"
+msgstr "est exclus"
+
+#: UI/GTK2/src/WorkerThreads.cpp:341 UI/GTK2/src/WorkerThreads.cpp:652
+#: UI/GTK2/src/WorkerThreads.cpp:928 UI/GTK2/src/WorkerThreads.cpp:937
+#: UI/GTK2/src/WorkerThreads.cpp:1103 UI/GTK2/src/WorkerThreads.cpp:1304
+#: UI/GTK2/src/WorkerThreads.cpp:1428
 msgid "Index error on"
 msgstr "Erreur sur l'index"
 
-#: UI/GTK2/src/WorkerThreads.cpp:752 UI/GTK2/src/WorkerThreads.cpp:853
+#: UI/GTK2/src/WorkerThreads.cpp:771 UI/GTK2/src/WorkerThreads.cpp:872
 msgid "Couldn't create search engine"
 msgstr "N'a pas pu creer le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:764 UI/GTK2/src/WorkerThreads.cpp:867
+#: UI/GTK2/src/WorkerThreads.cpp:783 UI/GTK2/src/WorkerThreads.cpp:886
 msgid "Couldn't run query on search engine"
 msgstr "N'a pas pu lancer la recherche sur le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:780
+#: UI/GTK2/src/WorkerThreads.cpp:799
 msgid "No title"
 msgstr "Pas de titre"
 
-#: UI/GTK2/src/WorkerThreads.cpp:997
+#: UI/GTK2/src/WorkerThreads.cpp:1016
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N'a pas pu obtenir un brouteur pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1008
+#: UI/GTK2/src/WorkerThreads.cpp:1027
 msgid "Couldn't retrieve"
 msgstr "N'a pas pu telecharger"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1134
+#: UI/GTK2/src/WorkerThreads.cpp:1153
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer ce type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1138
+#: UI/GTK2/src/WorkerThreads.cpp:1157
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1160
+#: UI/GTK2/src/WorkerThreads.cpp:1179
 msgid "Couldn't tokenize"
 msgstr "N'a pas pu extraire les termes de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1180
+#: UI/GTK2/src/WorkerThreads.cpp:1199
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots interdit d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1215
+#: UI/GTK2/src/WorkerThreads.cpp:1234
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1296
+#: UI/GTK2/src/WorkerThreads.cpp:1315
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1421
+#: UI/GTK2/src/WorkerThreads.cpp:1440
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1578
+#: UI/GTK2/src/WorkerThreads.cpp:1616
 msgid "No monitoring handler"
 msgstr "Pas de moniteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1620
+#: UI/GTK2/src/WorkerThreads.cpp:1658
 msgid "Couldn't initialize file monitor"
 msgstr "N'a pas pu initializer le moniteur de fichiers"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1896
+#: UI/GTK2/src/WorkerThreads.cpp:1940
 msgid "Couldn't open directory"
 msgstr "N'a pas pu ouvrir le repertoire"



From fabricecolin at mail.berlios.de  Sat Nov  4 14:40:05 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 4 Nov 2006 14:40:05 +0100
Subject: [Pinot-svn] r568 - tags
Message-ID: <200611041340.kA4De5w0001559@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-04 14:40:05 +0100 (Sat, 04 Nov 2006)
New Revision: 568

Added:
   tags/version_0_6_2/
Log:
Releasing 0.62.


Copied: tags/version_0_6_2 (from rev 567, trunk)



From fabricecolin at mail.berlios.de  Sun Nov 12 05:52:31 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 12 Nov 2006 05:52:31 +0100
Subject: [Pinot-svn] r569 - trunk
Message-ID: <200611120452.kAC4qVNT019758@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-12 05:52:30 +0100 (Sun, 12 Nov 2006)
New Revision: 569

Added:
   trunk/pinot-dbus-daemon.desktop
Modified:
   trunk/Makefile.am
   trunk/configure.in
   trunk/pinot.spec.in
Log:
Let Autostart handle the daemon.


Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2006-11-04 13:40:05 UTC (rev 568)
+++ trunk/Makefile.am	2006-11-12 04:52:30 UTC (rev 569)
@@ -4,8 +4,9 @@
 SUBDIRS = po Utils Tokenize SQL Collect Index @SOAP_SUBDIRS@ \
 	Search Monitor UI/GTK2/src
 
-EXTRA_DIST = ChangeLog NEWS README TODO mkinstalldirs pinot.desktop \
-	pinot.spec textcat_conf.txt textcat3_conf.txt globalconfig.xml \
+EXTRA_DIST = ChangeLog NEWS README TODO mkinstalldirs \
+	pinot.desktop pinot-dbus-daemon.desktop pinot.spec \
+	textcat_conf.txt textcat3_conf.txt globalconfig.xml \
 	Search/Plugins/*src Search/Plugins/*.xml \
 	Collect/pinot-collect.1 Index/pinot-index.1 Search/pinot-search.1 \
 	UI/GTK2/src/pinot.1 UI/GTK2/src/pinot-dbus-daemon.1 \
@@ -37,7 +38,9 @@
 	$(mkinstalldirs) $(DESTDIR)$(datadir)/icons/hicolor/48x48/apps/
 	$(INSTALL_DATA) UI/GTK2/pinot.png $(DESTDIR)$(datadir)/icons/hicolor/48x48/apps/pinot.png
 	$(mkinstalldirs) $(DESTDIR)$(datadir)/applications
-	@desktop-file-install --vendor Amra --dir $(DESTDIR)$(datadir)/applications pinot.desktop
+	@desktop-file-install --vendor="" --dir=$(DESTDIR)$(datadir)/applications pinot.desktop
+	$(mkinstalldirs) $(DESTDIR)${sysconfdir}/xdg/autostart
+	@desktop-file-install --vendor="" --dir=$(DESTDIR)${sysconfdir}/xdg/autostart pinot-dbus-daemon.desktop
 	$(mkinstalldirs) $(DESTDIR)$(libdir)/deskbar-applet/handlers/
 	$(INSTALL_DATA) UI/pinot-live.py $(DESTDIR)$(libdir)/deskbar-applet/handlers/
 

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2006-11-04 13:40:05 UTC (rev 568)
+++ trunk/configure.in	2006-11-12 04:52:30 UTC (rev 569)
@@ -46,9 +46,11 @@
 		[Define to the package prefix.])
 fi
 
-dnl Set DBUS_SERVICES_DIR in de.berlios.Pinot.service.
 AS_AC_EXPAND(DATADIR, $datadir)
 AS_AC_EXPAND(BINDIR, $bindir)
+AS_AC_EXPAND(SYSCONFDIR, $sysconfdir)
+
+dnl Set DBUS_SERVICES_DIR in de.berlios.Pinot.service.
 DBUS_SERVICES_DIR="$DATADIR/dbus-1/services"
 AC_SUBST(BINDIR)
 AC_SUBST(DBUS_SERVICES_DIR)

Added: trunk/pinot-dbus-daemon.desktop
===================================================================
--- trunk/pinot-dbus-daemon.desktop	2006-11-04 13:40:05 UTC (rev 568)
+++ trunk/pinot-dbus-daemon.desktop	2006-11-12 04:52:30 UTC (rev 569)
@@ -0,0 +1,9 @@
+[Desktop Entry]
+Name=Pinot
+Comment=Search the Web and your documents
+Exec=pinot-dbus-daemon
+Icon=pinot.png
+Terminal=false
+Type=Application
+Categories=
+Encoding=UTF-8

Modified: trunk/pinot.spec.in
===================================================================
--- trunk/pinot.spec.in	2006-11-04 13:40:05 UTC (rev 568)
+++ trunk/pinot.spec.in	2006-11-12 04:52:30 UTC (rev 569)
@@ -129,7 +129,8 @@
 %{_datadir}/locale/fr/LC_MESSAGES/pinot.mo
 %{_datadir}/locale/es/LC_MESSAGES/pinot.mo
 %{_datadir}/icons/hicolor/48x48/apps/pinot.png
-%{_datadir}/applications/Amra-pinot.desktop
+%{_sysconfdir}/xdg/autostart/*.desktop
+%{_datadir}/applications/*.desktop
 %{_mandir}/man1/pinot.*
 %ghost %{_mandir}/man1/pinot-collect.*
 %{_mandir}/man1/pinot-dbus-daemon.*



From fabricecolin at mail.berlios.de  Sun Nov 12 06:03:37 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 12 Nov 2006 06:03:37 +0100
Subject: [Pinot-svn] r570 - trunk/Search
Message-ID: <200611120503.kAC53b3g020205@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-12 06:03:36 +0100 (Sun, 12 Nov 2006)
New Revision: 570

Modified:
   trunk/Search/AbstractGenerator.cpp
   trunk/Search/AbstractGenerator.h
   trunk/Search/XapianEngine.cpp
Log:
Use a simple markup on terms that should be highlighted, so that the abstract
doesn't have to be parsed again when displayed.
That markup is conveniently the same as Pango's :-)


Modified: trunk/Search/AbstractGenerator.cpp
===================================================================
--- trunk/Search/AbstractGenerator.cpp	2006-11-12 04:52:30 UTC (rev 569)
+++ trunk/Search/AbstractGenerator.cpp	2006-11-12 05:03:36 UTC (rev 570)
@@ -20,6 +20,7 @@
 #include <ctype.h>
 #include <sys/time.h>
 #include <map>
+#include <algorithm>
 #include <iostream>
 #include <utility>
 
@@ -32,8 +33,9 @@
 using std::string;
 using std::vector;
 using std::map;
+using std::find;
 
-unsigned int AbstractGenerator::m_maxSeedTerms = 4;
+unsigned int AbstractGenerator::m_maxSeedTerms = 5;
 unsigned int AbstractGenerator::m_minTermPositions = 10;
 
 AbstractGenerator::PositionWindow::PositionWindow() :
@@ -58,8 +60,8 @@
 }
 
 /// Attempts to generate an abstract of wordsCount words.
-string AbstractGenerator::generateAbstract(const vector<string> &seedTerms,
-	Xapian::docid docId)
+string AbstractGenerator::generateAbstract(Xapian::docid docId,
+	const vector<string> &seedTerms)
 {
 	map<Xapian::termpos, PositionWindow> abstractWindows;
 	map<Xapian::termpos, string> wordsBuffer;
@@ -209,11 +211,22 @@
 		return "";
 	}
 
+	// Generate the abstract
 	for (map<Xapian::termpos, string>::iterator wordIter = wordsBuffer.begin();
 		wordIter != wordsBuffer.end(); ++wordIter)
 	{
+		// Is this a seed term ?
+		if (find(seedTerms.begin(), seedTerms.end(), wordIter->second) != seedTerms.end())
+		{
+			summary += "<b>";
+			summary += wordIter->second;
+			summary += "</b>";
+		}
+		else
+		{
+			summary += wordIter->second;
+		}
 		summary += " ";
-		summary += wordIter->second;
 	}
 #ifdef DEBUG
 	cout << "AbstractGenerator::generateAbstract: summarized document "

Modified: trunk/Search/AbstractGenerator.h
===================================================================
--- trunk/Search/AbstractGenerator.h	2006-11-12 04:52:30 UTC (rev 569)
+++ trunk/Search/AbstractGenerator.h	2006-11-12 05:03:36 UTC (rev 570)
@@ -31,8 +31,8 @@
 		virtual ~AbstractGenerator();
 
 		/// Attempts to generate an abstract of wordsCount words.
-		std::string generateAbstract(const std::vector<std::string> &seedTerms,
-			Xapian::docid docId);
+		std::string generateAbstract(Xapian::docid docId,
+			const std::vector<std::string> &seedTerms);
 
 	protected:
 		static unsigned int m_maxSeedTerms;

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2006-11-12 04:52:30 UTC (rev 569)
+++ trunk/Search/XapianEngine.cpp	2006-11-12 05:03:36 UTC (rev 570)
@@ -268,7 +268,7 @@
 					string language = StringManip::extractField(record, "language=", "\n");
 
 					// Generate an abstract based on the query's terms
-					string summary = abstractGen.generateAbstract(seedTerms, docId);
+					string summary = abstractGen.generateAbstract(docId, seedTerms);
 
 					// Add this result
 					Result thisResult(url, title, summary, language, (float)mIter.get_percent());



From fabricecolin at mail.berlios.de  Sun Nov 12 06:08:49 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 12 Nov 2006 06:08:49 +0100
Subject: [Pinot-svn] r571 - trunk/UI/GTK2/src
Message-ID: <200611120508.kAC58nGv020417@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-12 06:08:48 +0100 (Sun, 12 Nov 2006)
New Revision: 571

Modified:
   trunk/UI/GTK2/src/EnginesTree.cpp
   trunk/UI/GTK2/src/IndexTree.cpp
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/mainWindow.cc
Log:
In ResultsTree, don't re-parse the abstract, just rely on included markup.
Replaced the extract text view with a list to make this easier. Groups are
highlighted (search engine/host name).
Let columns autoresize in the results, index, engines and query trees.


Modified: trunk/UI/GTK2/src/EnginesTree.cpp
===================================================================
--- trunk/UI/GTK2/src/EnginesTree.cpp	2006-11-12 05:03:36 UTC (rev 570)
+++ trunk/UI/GTK2/src/EnginesTree.cpp	2006-11-12 05:08:48 UTC (rev 571)
@@ -49,9 +49,11 @@
 	// This is the actual engines tree
 	set_events(Gdk::BUTTON_PRESS_MASK);
 	set_flags(CAN_FOCUS);
+	set_headers_clickable(true);
 	set_headers_visible(true);
 	set_reorderable(false);
 	set_enable_search(false);
+	get_selection()->set_mode(SELECTION_MULTIPLE);
 	enginesScrolledwindow->set_flags(CAN_FOCUS);
 	enginesScrolledwindow->set_shadow_type(SHADOW_NONE);
 	enginesScrolledwindow->set_policy(POLICY_AUTOMATIC, POLICY_AUTOMATIC);
@@ -71,13 +73,9 @@
 	pColumn->pack_start(*manage(pIconRenderer), false);
 	pColumn->set_cell_data_func(*pIconRenderer, SigC::slot(*this, &EnginesTree::renderEngineIcon));
 	pColumn->pack_end(m_enginesColumns.m_name, false);
+	pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 	append_column(*manage(pColumn));
 
-	// Make headers clickable
-	set_headers_clickable(true);
-	// Allow multiple selection
-	get_selection()->set_mode(SELECTION_MULTIPLE);
-
 	// Handle button presses
 	signal_button_press_event().connect_notify(SigC::slot(*this, &EnginesTree::onButtonPressEvent));
 	// Control which rows can be selected

Modified: trunk/UI/GTK2/src/IndexTree.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexTree.cpp	2006-11-12 05:03:36 UTC (rev 570)
+++ trunk/UI/GTK2/src/IndexTree.cpp	2006-11-12 05:08:48 UTC (rev 571)
@@ -47,10 +47,12 @@
 	// This is the actual index tree
 	set_events(Gdk::BUTTON_PRESS_MASK);
 	set_flags(CAN_FOCUS);
+	set_headers_clickable(true);
 	set_headers_visible(true);
 	set_rules_hint(true);
 	set_reorderable(false);
 	set_enable_search(true);
+	get_selection()->set_mode(SELECTION_MULTIPLE);
 	m_pIndexScrolledwindow->set_flags(Gtk::CAN_FOCUS);
 	m_pIndexScrolledwindow->set_border_width(4);
 	m_pIndexScrolledwindow->set_shadow_type(Gtk::SHADOW_NONE);
@@ -66,24 +68,22 @@
 	TreeViewColumn *pColumn = create_column(_("Title"), m_indexColumns.m_text, true, true, m_indexColumns.m_text);
 	if (pColumn != NULL)
 	{
+		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		append_column(*manage(pColumn));
 	}
 	pColumn = create_column(_("URL"), m_indexColumns.m_liveUrl, true, true, m_indexColumns.m_liveUrl);
 	if (pColumn != NULL)
 	{
+		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		append_column(*manage(pColumn));
 	}
 	pColumn = create_column(_("Timestamp"), m_indexColumns.m_timestamp, false, true, m_indexColumns.m_timestampTime);
 	if (pColumn != NULL)
 	{
+		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		append_column(*manage(pColumn));
 	}
 
-	// Make headers clickable
-	set_headers_clickable(true);
-	// Allow multiple selection
-	get_selection()->set_mode(SELECTION_MULTIPLE);
-
 	// Connect the signals
 	signal_button_press_event().connect_notify(
 		SigC::slot(*this, &IndexTree::onButtonPressEvent));

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-11-12 05:03:36 UTC (rev 570)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-11-12 05:08:48 UTC (rev 571)
@@ -25,7 +25,6 @@
 #include <gtkmm/image.h>
 #include <gtkmm/label.h>
 #include <gtkmm/stock.h>
-#include <gtkmm/textbuffer.h>
 #include <gtkmm/cellrendererprogress.h>
 
 #include "StringManip.h"
@@ -52,21 +51,23 @@
 	m_pResultsScrolledwindow(NULL),
 	m_settings(settings),
 	m_pExtractScrolledwindow(NULL),
-	m_extractTextview(NULL),
+	m_extractTreeView(NULL),
 	m_showExtract(true),
 	m_groupBySearchEngine(true)
 {
 	m_pResultsScrolledwindow = manage(new ScrolledWindow());
 	m_pExtractScrolledwindow = manage(new ScrolledWindow());
-	m_extractTextview = manage(new TextView());
+	m_extractTreeView = manage(new TreeView());
 
 	// This is the actual results tree
 	set_events(Gdk::BUTTON_PRESS_MASK);
 	set_flags(CAN_FOCUS);
+	set_headers_clickable(true);
 	set_headers_visible(true);
 	set_rules_hint(true);
 	set_reorderable(false);
 	set_enable_search(true);
+	get_selection()->set_mode(SELECTION_MULTIPLE);
 	m_pResultsScrolledwindow->set_flags(CAN_FOCUS);
 	m_pResultsScrolledwindow->set_border_width(4);
 	m_pResultsScrolledwindow->set_shadow_type(SHADOW_NONE);
@@ -75,29 +76,21 @@
 	m_pResultsScrolledwindow->add(*this);
 
 	// That's for the extract view
-	m_extractTextview->set_flags(CAN_FOCUS);
-	m_extractTextview->set_editable(false);
-	m_extractTextview->set_cursor_visible(false);
-	m_extractTextview->set_pixels_above_lines(0);
-	m_extractTextview->set_pixels_below_lines(0);
-	m_extractTextview->set_pixels_inside_wrap(0);
-	m_extractTextview->set_left_margin(0);
-	m_extractTextview->set_right_margin(0);
-	m_extractTextview->set_indent(0);
-	m_extractTextview->set_wrap_mode(WRAP_WORD);
-	m_extractTextview->set_justification(JUSTIFY_LEFT);
+	m_extractTreeView->set_events(Gdk::BUTTON_PRESS_MASK);
+	m_extractTreeView->set_flags(CAN_FOCUS);
+	m_extractTreeView->set_headers_clickable(false);
+	m_extractTreeView->set_headers_visible(false);
+	m_extractTreeView->set_rules_hint(true);
+	m_extractTreeView->set_reorderable(false);
+	m_extractTreeView->set_enable_search(true);
+	m_extractTreeView->get_selection()->set_mode(SELECTION_SINGLE);
 	m_pExtractScrolledwindow->set_flags(CAN_FOCUS);
 	m_pExtractScrolledwindow->set_border_width(4);
 	m_pExtractScrolledwindow->set_shadow_type(SHADOW_NONE);
 	m_pExtractScrolledwindow->set_policy(POLICY_AUTOMATIC, POLICY_AUTOMATIC);
 	m_pExtractScrolledwindow->property_window_placement().set_value(CORNER_TOP_LEFT);
-	m_pExtractScrolledwindow->add(*m_extractTextview);
+	m_pExtractScrolledwindow->add(*m_extractTreeView);
 
-	// Create a blod text tag to highlight extract terms with
-	RefPtr<TextBuffer> refBuffer = m_extractTextview->get_buffer();
-	RefPtr<TextBuffer::Tag> refBoldTag = refBuffer->create_tag("bold-text");
-	refBoldTag->property_weight() = Pango::WEIGHT_BOLD;
-
 	// Associate the columns model to the results tree
 	m_refStore = TreeStore::create(m_resultsColumns);
 	set_model(m_refStore);
@@ -117,6 +110,7 @@
 	pColumn->pack_start(*manage(pIconRenderer), false);
 	pColumn->set_cell_data_func(*pIconRenderer, SigC::slot(*this, &ResultsTree::renderRanking));
 	pColumn->set_resizable(true);
+	pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 	append_column(*manage(pColumn));
 
 	// This is the score column
@@ -126,6 +120,7 @@
 	pColumn->add_attribute(pProgressRenderer->property_text(), m_resultsColumns.m_scoreText);
 	pColumn->add_attribute(pProgressRenderer->property_value(), m_resultsColumns.m_score);
 	pColumn->set_resizable(true);
+	pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 	pColumn->set_sort_column(m_resultsColumns.m_score);
 	append_column(*manage(pColumn));
 
@@ -133,9 +128,10 @@
 	pColumn = new TreeViewColumn(_("Title"));
 	CellRendererText *pTextRenderer = new CellRendererText();
 	pColumn->pack_start(*manage(pTextRenderer));
-	pColumn->set_cell_data_func(*pTextRenderer, SigC::slot(*this, &ResultsTree::renderBackgroundColour));
+	pColumn->set_cell_data_func(*pTextRenderer, SigC::slot(*this, &ResultsTree::renderTitleColumn));
 	pColumn->add_attribute(pTextRenderer->property_text(), m_resultsColumns.m_text);
 	pColumn->set_resizable(true);
+	pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 	pColumn->set_sort_column(m_resultsColumns.m_text);
 	append_column(*manage(pColumn));
 
@@ -143,14 +139,10 @@
 	pColumn = create_column(_("URL"), m_resultsColumns.m_url, false, true, m_resultsColumns.m_url);
 	if (pColumn != NULL)
 	{
+		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		append_column(*manage(pColumn));
 	}
 
-	// Make headers clickable
-	set_headers_clickable(true);
-	// Allow multiple selection
-	get_selection()->set_mode(SELECTION_MULTIPLE);
-
 	// Connect the signals
 	signal_button_press_event().connect_notify(
 		SigC::slot(*this, &ResultsTree::onButtonPressEvent));
@@ -170,10 +162,21 @@
 	m_upIconPixbuf = render_icon(Stock::GO_UP, ICON_SIZE_MENU, "MetaSE-pinot");
 	m_downIconPixbuf = render_icon(Stock::GO_DOWN, ICON_SIZE_MENU, "MetaSE-pinot");
 
+	// Associate the columns model to the extract tree
+	m_refExtractStore = ListStore::create(m_extractColumns);
+	m_extractTreeView->set_model(m_refExtractStore);
+	pColumn = new TreeViewColumn(_("Extract"));
+	pTextRenderer = new CellRendererText();
+	pColumn->pack_start(*manage(pTextRenderer));
+	pColumn->set_cell_data_func(*pTextRenderer, SigC::slot(*this, &ResultsTree::renderExtractColumn));
+	pColumn->add_attribute(pTextRenderer->property_text(), m_extractColumns.m_name);
+	pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
+	m_extractTreeView->append_column(*manage(pColumn));
+
 	// Show all
 	show();
 	m_pResultsScrolledwindow->show();
-	m_extractTextview->show();
+	m_extractTreeView->show();
 	m_pExtractScrolledwindow->show();
 }
 
@@ -181,16 +184,16 @@
 {
 }
 
-void ResultsTree::renderViewStatus(CellRenderer *renderer, const TreeModel::iterator &iter)
+void ResultsTree::renderViewStatus(CellRenderer *pRenderer, const TreeModel::iterator &iter)
 {
 	TreeModel::Row row = *iter;
 
-	if (renderer == NULL)
+	if (pRenderer == NULL)
 	{
 		return;
 	}
 
-	CellRendererPixbuf *pIconRenderer = dynamic_cast<CellRendererPixbuf*>(renderer);
+	CellRendererPixbuf *pIconRenderer = dynamic_cast<CellRendererPixbuf*>(pRenderer);
 	if (pIconRenderer != NULL)
 	{
 		// Has this result been already viewed ?
@@ -206,16 +209,16 @@
 	}
 }
 
-void ResultsTree::renderIndexStatus(CellRenderer *renderer, const TreeModel::iterator &iter)
+void ResultsTree::renderIndexStatus(CellRenderer *pRenderer, const TreeModel::iterator &iter)
 {
 	TreeModel::Row row = *iter;
 
-	if (renderer == NULL)
+	if (pRenderer == NULL)
 	{
 		return;
 	}
 
-	CellRendererPixbuf *pIconRenderer = dynamic_cast<CellRendererPixbuf*>(renderer);
+	CellRendererPixbuf *pIconRenderer = dynamic_cast<CellRendererPixbuf*>(pRenderer);
 	if (pIconRenderer != NULL)
 	{
 		// Is this result indexed ?
@@ -231,16 +234,16 @@
 	}
 }
 
-void ResultsTree::renderRanking(CellRenderer *renderer, const TreeModel::iterator &iter)
+void ResultsTree::renderRanking(CellRenderer *pRenderer, const TreeModel::iterator &iter)
 {
 	TreeModel::Row row = *iter;
 
-	if (renderer == NULL)
+	if (pRenderer == NULL)
 	{
 		return;
 	}
 
-	CellRendererPixbuf *pIconRenderer = dynamic_cast<CellRendererPixbuf*>(renderer);
+	CellRendererPixbuf *pIconRenderer = dynamic_cast<CellRendererPixbuf*>(pRenderer);
 	if (pIconRenderer != NULL)
 	{
 		int rankDiff = row[m_resultsColumns.m_rankDiff];
@@ -262,16 +265,16 @@
 	}
 }
 
-void ResultsTree::renderBackgroundColour(CellRenderer *renderer, const TreeModel::iterator &iter)
+void ResultsTree::renderTitleColumn(CellRenderer *pRenderer, const TreeModel::iterator &iter)
 {
 	TreeModel::Row row = *iter;
 
-	if (renderer == NULL)
+	if (pRenderer == NULL)
 	{
 		return;
 	}
 
-	CellRendererText *pTextRenderer = dynamic_cast<CellRendererText*>(renderer);
+	CellRendererText *pTextRenderer = dynamic_cast<CellRendererText*>(pRenderer);
 	if (pTextRenderer != NULL)
 	{
 		// Is this result new ?
@@ -290,9 +293,38 @@
 		{
 			pTextRenderer->property_background_gdk().reset_value();
 		}
+
+		ResultsModelColumns::ResultType type = row[m_resultsColumns.m_type];
+		if ((type == ResultsModelColumns::RESULT_ROOT) ||
+			(type == ResultsModelColumns::RESULT_HOST))
+		{
+			ustring markup("<b>");
+			markup += row[m_resultsColumns.m_text];
+			markup += "</b>";
+			pTextRenderer->property_markup() = markup;
+		}
 	}
 }
 
+void ResultsTree::renderExtractColumn(CellRenderer *pRenderer, const TreeModel::iterator &iter)
+{
+	TreeModel::Row row = *iter;
+
+	if (pRenderer == NULL)
+	{
+		return;
+	}
+
+	CellRendererText *pTextRenderer = dynamic_cast<CellRendererText*>(pRenderer);
+	if (pTextRenderer != NULL)
+	{
+		ustring markup(row[m_extractColumns.m_name]);
+		pTextRenderer->property_markup() = markup;
+		pTextRenderer->property_wrap_mode() = Pango::WRAP_WORD;
+		pTextRenderer->property_wrap_width() = m_pExtractScrolledwindow->get_width();
+	}
+}
+
 void ResultsTree::onButtonPressEvent(GdkEventButton *ev)
 {
 	// Check for popup click
@@ -329,85 +361,21 @@
 
 	if (path_currently_selected == false)
 	{
-#ifdef DEBUG
-		cout << "ResultsTree::onSelectionSelect: selected entry " << row[m_resultsColumns.m_text] << endl;
-#endif
+		// Clear the extract
+		m_extractTreeView->get_selection()->unselect_all();
+		m_refExtractStore->clear();
 
 		// Is this an actual result ?
 		ResultsModelColumns::ResultType type = row[m_resultsColumns.m_type];
 		if (type == ResultsModelColumns::RESULT_TITLE)
 		{
-			QueryHistory history(m_settings.m_historyDatabase);
-			set<string> engineNames, indexNames;
-			string extract;
-
-			string url = from_utf8(row[m_resultsColumns.m_url]);
-			unsigned int engineIds = row[m_resultsColumns.m_engines];
-			unsigned int indexIds = row[m_resultsColumns.m_indexes];
-
 #ifdef DEBUG
-			cout << "ResultsTree::onSelectionSelect: selected result (" << engineIds << "," << indexIds << ")" << endl;
+			cout << "ResultsTree::onSelectionSelect: extract for " << row[m_resultsColumns.m_text] << endl;
 #endif
-			m_settings.getEngineNames(engineIds, engineNames);
-			if (engineNames.empty() == false)
-			{
-				// Get the first engine this result was obtained from
-				string engineName = (*engineNames.begin());
-				if (engineName == "Xapian")
-				{
-					m_settings.getIndexNames(indexIds, indexNames);
-					if (indexNames.empty() == false)
-					{
-						// Use the name of the first index as engine name
-						engineName = (*indexNames.begin());
 
-						// Any internal index in there ?
-						for (set<string>::iterator indexIter = indexNames.begin(); indexIter != indexNames.end(); ++indexIter)
-						{
-							if  (m_settings.isInternalIndex(*indexIter) == true)
-							{
-								m_indexNames.insert(*indexIter);
-							}
-						}
-					}
-				}
-
-#ifdef DEBUG
-				cout << "ResultsTree::onSelectionSelect: first engine for " << url << " was " << engineName << endl;
-#endif
-				extract = history.getItemExtract(from_utf8(m_queryName), engineName, url);
-			}
-
-			RefPtr<TextBuffer> refBuffer = m_extractTextview->get_buffer();
-			refBuffer->set_text(to_utf8(extract));
-
-			// Highlight the query's terms in the extract
-			ustring lowerExtract(StringManip::toLowerCase(to_utf8(extract)));
-			for (set<string>::iterator termIter = m_queryTerms.begin();
-				termIter != m_queryTerms.end(); ++termIter)
-			{
-				ustring term(to_utf8(StringManip::toLowerCase(*termIter)));
-
-				ustring::size_type pos = lowerExtract.find(term);
-				while (pos != ustring::npos)
-				{
-					if (((pos > 0) && (isspace(lowerExtract[pos - 1]) != 0)) ||
-						((pos + termIter->length() < lowerExtract.length() - 1) &&
-							(isspace(lowerExtract[pos + termIter->length()]) != 0)))
-					{
-						// Apply the tag
-						refBuffer->apply_tag_by_name("bold-text", refBuffer->get_iter_at_offset(pos),
-							refBuffer->get_iter_at_offset(pos + termIter->length()));
-					}
-
-					// Next
-					pos = lowerExtract.find(term, pos + 1);
-				}
-			}
-
-			// The extract is not editable
-			m_extractTextview->set_editable(false);
-			m_extractTextview->set_cursor_visible(false);
+			TreeModel::iterator iter = m_refExtractStore->append();
+			TreeModel::Row extractRow = *iter;
+			extractRow[m_extractColumns.m_name] = findResultsExtract(row);
 		}
 	}
 
@@ -1045,11 +1013,9 @@
 		}
 		m_refStore->clear();
 
-		// Clear the extract field
-		RefPtr<TextBuffer> refBuffer = m_extractTextview->get_buffer();
-		refBuffer->set_text("");
-		m_extractTextview->set_editable(false);
-		m_extractTextview->set_cursor_visible(false);
+		// Clear the extract
+		m_extractTreeView->get_selection()->unselect_all();
+		m_refExtractStore->clear();
 
 		onSelectionChanged();
 	}
@@ -1263,3 +1229,51 @@
 	row[m_resultsColumns.m_viewed] = viewed;
 	row[m_resultsColumns.m_rankDiff] = rankDiff;
 }
+
+//
+// Retrieves the extract to show for the given row.
+//
+string ResultsTree::findResultsExtract(const Gtk::TreeModel::Row &row)
+{
+	QueryHistory history(m_settings.m_historyDatabase);
+	set<string> engineNames, indexNames;
+	string url(from_utf8(row[m_resultsColumns.m_url]));
+	string extract;
+	unsigned int engineIds = row[m_resultsColumns.m_engines];
+	unsigned int indexIds = row[m_resultsColumns.m_indexes];
+
+#ifdef DEBUG
+	cout << "ResultsTree::getExtract: engines " << engineIds << ", indexes " << indexIds << endl;
+#endif
+	m_settings.getEngineNames(engineIds, engineNames);
+	if (engineNames.empty() == false)
+	{
+		// Get the first engine this result was obtained from
+		string engineName = (*engineNames.begin());
+		if (engineName == "Xapian")
+		{
+			m_settings.getIndexNames(indexIds, indexNames);
+			if (indexNames.empty() == false)
+			{
+				// Use the name of the first index as engine name
+				engineName = (*indexNames.begin());
+
+				// Any internal index in there ?
+				for (set<string>::iterator indexIter = indexNames.begin(); indexIter != indexNames.end(); ++indexIter)
+				{
+					if  (m_settings.isInternalIndex(*indexIter) == true)
+					{
+						m_indexNames.insert(*indexIter);
+					}
+				}
+			}
+		}
+
+#ifdef DEBUG
+		cout << "ResultsTree::getExtract: first engine for " << url << " was " << engineName << endl;
+#endif
+		extract = history.getItemExtract(from_utf8(m_queryName), engineName, url);
+	}
+
+	return extract;
+}

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2006-11-12 05:03:36 UTC (rev 570)
+++ trunk/UI/GTK2/src/ResultsTree.h	2006-11-12 05:08:48 UTC (rev 571)
@@ -30,8 +30,8 @@
 #include <gtkmm/button.h>
 #include <gtkmm/menu.h>
 #include <gtkmm/scrolledwindow.h>
-#include <gtkmm/textview.h>
 #include <gtkmm/treestore.h>
+#include <gtkmm/liststore.h>
 #include <gtkmm/treeview.h>
 #include <gtkmm/treeselection.h>
 
@@ -112,20 +112,24 @@
 		std::map<std::string, Gtk::TreeModel::iterator> m_resultsGroups;
 		ResultsModelColumns m_resultsColumns;
 		Gtk::ScrolledWindow *m_pExtractScrolledwindow;
-		Gtk::TextView *m_extractTextview;
+		Gtk::TreeView *m_extractTreeView;
+		Glib::RefPtr<Gtk::ListStore> m_refExtractStore;
+		ComboModelColumns m_extractColumns;
 		std::set<std::string> m_indexNames;
 		bool m_showExtract;
 		bool m_groupBySearchEngine;
 		std::set<std::string> m_queryTerms;
 
-		void renderViewStatus(Gtk::CellRenderer *renderer, const Gtk::TreeModel::iterator &iter);
+		void renderViewStatus(Gtk::CellRenderer *pRenderer, const Gtk::TreeModel::iterator &iter);
 
-		void renderIndexStatus(Gtk::CellRenderer *renderer, const Gtk::TreeModel::iterator &iter);
+		void renderIndexStatus(Gtk::CellRenderer *pRenderer, const Gtk::TreeModel::iterator &iter);
 
-		void renderRanking(Gtk::CellRenderer *renderer, const Gtk::TreeModel::iterator &iter);
+		void renderRanking(Gtk::CellRenderer *pRenderer, const Gtk::TreeModel::iterator &iter);
 
-		void renderBackgroundColour(Gtk::CellRenderer *renderer, const Gtk::TreeModel::iterator &iter);
+		void renderTitleColumn(Gtk::CellRenderer *pRenderer, const Gtk::TreeModel::iterator &iter);
 
+		void renderExtractColumn(Gtk::CellRenderer *pRenderer, const Gtk::TreeModel::iterator &iter);
+
 		void onButtonPressEvent(GdkEventButton *ev);
 
 		void onSelectionChanged(void);
@@ -154,6 +158,9 @@
 			const Glib::ustring &url, int score, unsigned int engineId, unsigned int indexId,
 			ResultsModelColumns::ResultType type, bool indexed, bool viewed, int rankDiff);
 
+		/// Retrieves the extract to show for the given row.
+		std::string findResultsExtract(const Gtk::TreeModel::Row &row);
+
 	private:
 		ResultsTree(const ResultsTree &other);
 		ResultsTree &operator=(const ResultsTree &other);

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-12 05:03:36 UTC (rev 570)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-12 05:08:48 UTC (rev 571)
@@ -797,7 +797,6 @@
 			resultIter != resultsList.end(); ++resultIter)
 		{
 			string title(_("No title"));
-			string extract(XmlTokenizer::stripTags(resultIter->getExtract()));
 			string language(resultIter->getLanguage());
 
 			// The title may contain formatting
@@ -817,7 +816,7 @@
 
 			m_resultsList.push_back(Result(resultIter->getLocation(),
 				title,
-				extract,
+				resultIter->getExtract(),
 				language,
 				resultIter->getScore()));
 		}

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-11-12 05:03:36 UTC (rev 570)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-11-12 05:08:48 UTC (rev 571)
@@ -140,11 +140,13 @@
 	TreeViewColumn *pColumn = create_column(_("Query Name"), m_queryColumns.m_name, true, true, m_queryColumns.m_name);
 	if (pColumn != NULL)
 	{
+		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		queryTreeview->append_column(*manage(pColumn));
 	}
 	pColumn = create_column(_("Last Run"), m_queryColumns.m_lastRun, true, true, m_queryColumns.m_lastRunTime);
 	if (pColumn != NULL)
 	{
+		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		queryTreeview->append_column(*manage(pColumn));
 	}
 	queryTreeview->append_column(_("Summary"), m_queryColumns.m_summary);
@@ -775,10 +777,10 @@
 #endif
 	}
 
+	show_global_menuitems(showResultsMenuitems);
 	// Did the page change ?
 	if (m_state.m_currentPage != p1)
 	{
-		show_global_menuitems(showResultsMenuitems);
 		show_selectionbased_menuitems(false);
 	}
 	m_state.m_currentPage = p1;



From fabricecolin at mail.berlios.de  Sun Nov 12 06:11:06 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 12 Nov 2006 06:11:06 +0100
Subject: [Pinot-svn] r572 - trunk
Message-ID: <200611120511.kAC5B6Fw020657@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-12 06:11:06 +0100 (Sun, 12 Nov 2006)
New Revision: 572

Modified:
   trunk/README
Log:
Mention freedesktop.org's Autostart.


Modified: trunk/README
===================================================================
--- trunk/README	2006-11-12 05:08:48 UTC (rev 571)
+++ trunk/README	2006-11-12 05:11:06 UTC (rev 572)
@@ -70,7 +70,7 @@
     * mbox mail accounts. Monitoring is always enabled.
   Both are configured with the Indexing tab in the Preferences box and are
   handled by the D-Bus service.
-  if you want to exclude specific files or directories from indexing, use
+  If you want to exclude specific files or directories from indexing, use
   patterns as described in section "8. File formats".
   See section "10. D-Bus service".
 
@@ -219,15 +219,18 @@
 10. D-Bus service
 
 
-   Thanks to D-Bus activation, the service is started whenever one of its
-   methods are invoked, either by the UI or any other consumer application.
-   When directories or mbox files are configured for indexing in the UI,
-   clicking OK on the Preferences box will call a method of the service
-   to make sure it is running.
+   D-Bus activation makes sure the service is running whenever one of its
+   methods is invoked by any consumer application. For instance, when
+   directories or mbox files are configured for indexing in the UI, clicking
+   OK on the Preferences box will call the service's GetStatistics method,
+   thus ensuring the service is running.
 
-   If you want the service to be started when you start a new X session,
-   add pinot-dbus-daemon to your desktop environment's startup programs
-   list.
+   Starting with 0.63, the service is auto-started. The file that enables
+   this is located at /etc/xdg/autostart/pinot-dbus-daemon.desktop.
+   For older versions, if you want the service to be started with your X
+   session, add pinot-dbus-daemon to your desktop environment's startup
+   programs list.
+
    A few things to keep in mind :
      * the service doesn't reload its configuration while running, so any
        change (adding or removing a directory or mbox file) will take effect
@@ -242,7 +245,7 @@
        daemon will reindex right away a file that was modified. Future
        releases will queue events and act on them only when the system is idle.
 
-  If you have dbus-send installed, you can start the deamon manually by calling
+  If you have dbus-send installed, you can start the daemon manually by calling
   the GetStatistics method with
   $ dbus-send --session --print-reply --type=method_call \
     --dest=de.berlios.Pinot /de/berlios/Pinot de.berlios.Pinot.GetStatistics



From fabricecolin at mail.berlios.de  Sun Nov 12 10:05:05 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 12 Nov 2006 10:05:05 +0100
Subject: [Pinot-svn] r573 - in trunk: Search Search/Google Utils
Message-ID: <200611120905.kAC955sI004641@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-12 10:05:04 +0100 (Sun, 12 Nov 2006)
New Revision: 573

Modified:
   trunk/Search/AbstractGenerator.cpp
   trunk/Search/Google/GoogleAPIEngine.cpp
   trunk/Search/Google/GoogleAPIEngine.h
   trunk/Search/PluginWebEngine.cpp
   trunk/Search/SearchEngineInterface.cpp
   trunk/Search/SearchEngineInterface.h
   trunk/Search/WebEngine.cpp
   trunk/Search/WebEngine.h
   trunk/Search/XapianEngine.cpp
   trunk/Utils/Result.cpp
   trunk/Utils/Result.h
Log:
WebEngine now handles filtering results and highlighting abstracts, similarly
to AbstractGenerator.
Escape strings in markup. Minor cleanup.


Modified: trunk/Search/AbstractGenerator.cpp
===================================================================
--- trunk/Search/AbstractGenerator.cpp	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Search/AbstractGenerator.cpp	2006-11-12 09:05:04 UTC (rev 573)
@@ -19,6 +19,7 @@
 #include <string.h>
 #include <ctype.h>
 #include <sys/time.h>
+#include <glib.h>
 #include <map>
 #include <algorithm>
 #include <iostream>
@@ -215,18 +216,27 @@
 	for (map<Xapian::termpos, string>::iterator wordIter = wordsBuffer.begin();
 		wordIter != wordsBuffer.end(); ++wordIter)
 	{
+		char *pEscWord = g_markup_escape_text(wordIter->second.c_str(), -1);
+
+		if (pEscWord == NULL)
+		{
+			continue;
+		}
+
 		// Is this a seed term ?
 		if (find(seedTerms.begin(), seedTerms.end(), wordIter->second) != seedTerms.end())
 		{
 			summary += "<b>";
-			summary += wordIter->second;
+			summary += pEscWord;
 			summary += "</b>";
 		}
 		else
 		{
-			summary += wordIter->second;
+			summary += pEscWord;
 		}
 		summary += " ";
+
+		g_free(pEscWord);
 	}
 #ifdef DEBUG
 	cout << "AbstractGenerator::generateAbstract: summarized document "

Modified: trunk/Search/Google/GoogleAPIEngine.cpp
===================================================================
--- trunk/Search/Google/GoogleAPIEngine.cpp	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Search/Google/GoogleAPIEngine.cpp	2006-11-12 09:05:04 UTC (rev 573)
@@ -30,10 +30,8 @@
 using std::endl;
 
 GoogleAPIEngine::GoogleAPIEngine() :
-	SearchEngineInterface()
+	WebEngine()
 {
-	// SearchEngineInterface members
-	m_maxResultsCount = 10;
 }
 
 GoogleAPIEngine::~GoogleAPIEngine()
@@ -88,8 +86,10 @@
 bool GoogleAPIEngine::runQuery(QueryProperties& queryProps)
 {
 	string queryString(queryProps.getFreeQuery(true));
+
 	setHostNameFilter(queryProps.getHostFilter());
 	setFileNameFilter(queryProps.getFileFilter());
+	setQuery(queryString);
 
 	if (m_key.empty() == true)
 	{
@@ -130,11 +130,11 @@
 		for (int i = 0; i < searchResult->resultElements->__size; ++i)
 		{
 			struct gapi1__ResultElement *resultElement = searchResult->resultElements->__ptr[i];
+			Result result(resultElement->URL, resultElement->title, resultElement->snippet, "", pseudoScore);
 
-			string resultUrl(resultElement->URL);
-			if (processResult("http://www.google.com/", resultUrl) == true)
+			if (processResult("http://www.google.com/", result) == true)
 			{
-				m_resultsList.push_back(Result(resultUrl, resultElement->title, resultElement->snippet, "", pseudoScore));
+				m_resultsList.push_back(result);
 				--pseudoScore;
 			}
 		}

Modified: trunk/Search/Google/GoogleAPIEngine.h
===================================================================
--- trunk/Search/Google/GoogleAPIEngine.h	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Search/Google/GoogleAPIEngine.h	2006-11-12 09:05:04 UTC (rev 573)
@@ -22,11 +22,11 @@
 #include <string>
 
 #include "Document.h"
-#include "SearchEngineInterface.h"
+#include "WebEngine.h"
 
 using namespace std;
 
-class GoogleAPIEngine : public SearchEngineInterface
+class GoogleAPIEngine : public WebEngine
 {
 	public:
 		GoogleAPIEngine();

Modified: trunk/Search/PluginWebEngine.cpp
===================================================================
--- trunk/Search/PluginWebEngine.cpp	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Search/PluginWebEngine.cpp	2006-11-12 09:05:04 UTC (rev 573)
@@ -105,9 +105,7 @@
 	vector<Result>::iterator resultIter = m_resultsList.begin();
 	while (resultIter != m_resultsList.end())
 	{
-		string url(resultIter->getLocation());
-
-		if (processResult(formattedQuery, url) == false)
+		if (processResult(formattedQuery, *resultIter) == false)
 		{
 			// Remove this result
 			if (resultIter == m_resultsList.begin())
@@ -124,8 +122,6 @@
 		}
 		else
 		{
-			resultIter->setLocation(url);
-
 			// Next
 			++resultIter;
 		}
@@ -253,6 +249,7 @@
 
 	setHostNameFilter(queryProps.getHostFilter());
 	setFileNameFilter(queryProps.getFileFilter());
+	setQuery(queryString);
 
 #ifdef DEBUG
 	cout << "PluginWebEngine::runQuery: querying "

Modified: trunk/Search/SearchEngineInterface.cpp
===================================================================
--- trunk/Search/SearchEngineInterface.cpp	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Search/SearchEngineInterface.cpp	2006-11-12 09:05:04 UTC (rev 573)
@@ -18,6 +18,7 @@
 
 #include <iostream>
 
+#include "Document.h"
 #include "StringManip.h"
 #include "Url.h"
 #include "SearchEngineInterface.h"
@@ -79,108 +80,3 @@
 {
 	return m_expandTerms;
 }
-
-void SearchEngineInterface::setHostNameFilter(const string &filter)
-{
-	m_hostFilter = filter;
-}
-
-void SearchEngineInterface::setFileNameFilter(const string &filter)
-{
-	m_fileFilter = filter;
-}
-
-bool SearchEngineInterface::processResult(const string &queryUrl, string &resultUrl)
-{
-	Url queryUrlObj(queryUrl);
-	string queryHost(Url::reduceHost(queryUrlObj.getHost(), 2));
-
-	if (resultUrl.empty() == true)
-	{
-		return false;
-	}
-
-	if ((resultUrl[0] == '/') ||
-		((resultUrl.length() > 1) &&
-		(resultUrl[0] == '.') &&
-		(resultUrl[1] == '/')))
-	{
-		string fullResultUrl(queryUrlObj.getProtocol());
-
-		fullResultUrl += "://";
-		fullResultUrl += queryUrlObj.getHost();
-		if (resultUrl[0] == '.')
-		{
-			fullResultUrl += resultUrl.substr(1);
-		}
-		else
-		{
-			fullResultUrl += resultUrl;
-		}
-
-		resultUrl = fullResultUrl;
-	}
-
-	Url resultUrlObj(resultUrl);
-
-	if ((m_hostFilter.empty() == false) &&
-		(resultUrlObj.getHost() != m_hostFilter))
-	{
-#ifdef DEBUG
-		cout << "SearchEngineInterface::processResult: skipping " << resultUrl << endl;
-#endif
-		return false;
-	}
-
-	if ((m_fileFilter.empty() == false) &&
-		(resultUrlObj.getFile() != m_fileFilter))
-	{
-#ifdef DEBUG
-		cout << "SearchEngineInterface::processResult: skipping " << resultUrl << endl;
-#endif
-		return false;
-	}
-
-	// Is the result's host name the same as the search engine's ?
-	// FIXME: not all TLDs have leafs at level 2
-	if (queryHost == Url::reduceHost(resultUrlObj.getHost(), 2))
-	{
-		string protocol(resultUrlObj.getProtocol());
-
-		if (protocol.empty() == false)
-		{
-			string embeddedUrl;
-
-			string::size_type startPos = resultUrl.find(protocol, protocol.length());
-			if (startPos != string::npos)
-			{
-				string::size_type endPos = resultUrl.find("&amp;", startPos);
-				if (endPos != string::npos)
-				{
-					embeddedUrl = resultUrl.substr(startPos, endPos - startPos);
-				}
-				else
-				{
-					embeddedUrl = resultUrl.substr(startPos);
-				}
-
-				resultUrl = Url::unescapeUrl(embeddedUrl);
-			}
-#ifdef DEBUG
-			else cout << "SearchEngineInterface::processResult: no embedded URL" << endl;
-#endif
-		}
-#ifdef DEBUG
-		else cout << "SearchEngineInterface::processResult: no protocol" << endl;
-#endif
-	}
-
-	// Trim spaces
-	string trimmedUrl(resultUrl);
-	StringManip::trimSpaces(trimmedUrl);
-
-	// Return a canonical form
-	resultUrl = Url::canonicalizeUrl(trimmedUrl);
-
-	return true;
-}

Modified: trunk/Search/SearchEngineInterface.h
===================================================================
--- trunk/Search/SearchEngineInterface.h	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Search/SearchEngineInterface.h	2006-11-12 09:05:04 UTC (rev 573)
@@ -67,20 +67,12 @@
 		time_t m_startTime;
 		unsigned int m_maxResultsCount;
 		bool m_expandQueries;
-		string m_hostFilter;
-		string m_fileFilter;
 		vector<Result> m_resultsList;
 		string m_charset;
 		set<string> m_expandTerms;
 
 		SearchEngineInterface();
 
-		void setHostNameFilter(const string &filter);
-
-		void setFileNameFilter(const string &filter);
-
-		virtual bool processResult(const string &queryUrl, string &resultUrl);
-
 };
 
 #endif // _SEARCH_ENGINE_INTERFACE_H

Modified: trunk/Search/WebEngine.cpp
===================================================================
--- trunk/Search/WebEngine.cpp	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Search/WebEngine.cpp	2006-11-12 09:05:04 UTC (rev 573)
@@ -18,8 +18,10 @@
 
 #include <string.h>
 #include <sys/types.h>
-#include <regex.h>
+#include <glib.h>
 #include <string>
+#include <vector>
+#include <iostream>
 
 #include "StringManip.h"
 #include "Url.h"
@@ -27,7 +29,12 @@
 #include "DownloaderFactory.h"
 #include "WebEngine.h"
 
+using std::cout;
+using std::cerr;
+using std::endl;
 using std::string;
+using std::set;
+using std::vector;
 
 static string getCharset(const string &contentType)
 {
@@ -90,3 +97,176 @@
 
 	return pDoc;
 }
+
+void WebEngine::setHostNameFilter(const string &filter)
+{
+	m_hostFilter = filter;
+}
+
+void WebEngine::setFileNameFilter(const string &filter)
+{
+	m_fileFilter = filter;
+}
+
+void WebEngine::setQuery(const string &queryString)
+{
+	if (queryString.empty() == true)
+	{
+		return;
+	}
+
+	Document doc;
+	doc.setData(queryString.c_str(), queryString.length());
+	Tokenizer tokens(&doc);
+
+	m_queryTerms.clear();
+
+	string token;
+	while (tokens.nextToken(token) == true)
+	{
+		// Lower case the word
+		m_queryTerms.insert(StringManip::toLowerCase(token));
+	}
+}
+
+bool WebEngine::processResult(const string &queryUrl, Result &result)
+{
+	Url queryUrlObj(queryUrl);
+	string resultUrl(result.getLocation());
+	string queryHost(Url::reduceHost(queryUrlObj.getHost(), 2));
+
+	if (resultUrl.empty() == true)
+	{
+		return false;
+	}
+
+	if ((resultUrl[0] == '/') ||
+		((resultUrl.length() > 1) &&
+		(resultUrl[0] == '.') &&
+		(resultUrl[1] == '/')))
+	{
+		string fullResultUrl(queryUrlObj.getProtocol());
+
+		fullResultUrl += "://";
+		fullResultUrl += queryUrlObj.getHost();
+		if (resultUrl[0] == '.')
+		{
+			fullResultUrl += resultUrl.substr(1);
+		}
+		else
+		{
+			fullResultUrl += resultUrl;
+		}
+
+		resultUrl = fullResultUrl;
+	}
+
+	Url resultUrlObj(resultUrl);
+
+	if ((m_hostFilter.empty() == false) &&
+		(resultUrlObj.getHost() != m_hostFilter))
+	{
+#ifdef DEBUG
+		cout << "WebEngine::processResult: skipping " << resultUrl << endl;
+#endif
+		return false;
+	}
+
+	if ((m_fileFilter.empty() == false) &&
+		(resultUrlObj.getFile() != m_fileFilter))
+	{
+#ifdef DEBUG
+		cout << "WebEngine::processResult: skipping " << resultUrl << endl;
+#endif
+		return false;
+	}
+
+	// Is the result's host name the same as the search engine's ?
+	// FIXME: not all TLDs have leafs at level 2
+	if (queryHost == Url::reduceHost(resultUrlObj.getHost(), 2))
+	{
+		string protocol(resultUrlObj.getProtocol());
+
+		if (protocol.empty() == false)
+		{
+			string embeddedUrl;
+
+			string::size_type startPos = resultUrl.find(protocol, protocol.length());
+			if (startPos != string::npos)
+			{
+				string::size_type endPos = resultUrl.find("&amp;", startPos);
+				if (endPos != string::npos)
+				{
+					embeddedUrl = resultUrl.substr(startPos, endPos - startPos);
+				}
+				else
+				{
+					embeddedUrl = resultUrl.substr(startPos);
+				}
+
+				resultUrl = Url::unescapeUrl(embeddedUrl);
+			}
+#ifdef DEBUG
+			else cout << "WebEngine::processResult: no embedded URL" << endl;
+#endif
+		}
+#ifdef DEBUG
+		else cout << "WebEngine::processResult: no protocol" << endl;
+#endif
+	}
+
+	// Trim spaces
+	string trimmedUrl(resultUrl);
+	StringManip::trimSpaces(trimmedUrl);
+
+	// Make the URL canonical
+	result.setLocation(Url::canonicalizeUrl(trimmedUrl));
+
+	// Scan the extract for query terms
+	string extract(result.getExtract());
+	if (extract.empty() == true)
+	{
+		return true;
+	}
+#ifdef DEBUG
+	cout << "WebEngine::processResult: " << extract << endl;
+#endif
+
+	Document doc;
+	doc.setData(extract.c_str(), extract.length());
+	Tokenizer tokens(&doc);
+
+	extract.clear();
+
+	string token;
+	while (tokens.nextToken(token) == true)
+	{
+		char *pEscToken = g_markup_escape_text(token.c_str(), -1);
+		if (pEscToken == NULL)
+		{
+			continue;
+		}
+
+		// Is this a query term ?
+		if (m_queryTerms.find(StringManip::toLowerCase(token)) == m_queryTerms.end())
+		{
+			extract += pEscToken;
+		}
+		else
+		{
+			extract += "<b>";
+			extract += pEscToken;
+			extract += "</b>";
+		}
+		extract += " ";
+
+		g_free(pEscToken);
+#ifdef DEBUG
+		cout << "WebEngine::processResult: " << extract << endl;
+#endif
+
+		result.setExtract(extract);
+	}
+
+	return true;
+}

Modified: trunk/Search/WebEngine.h
===================================================================
--- trunk/Search/WebEngine.h	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Search/WebEngine.h	2006-11-12 09:05:04 UTC (rev 573)
@@ -20,6 +20,7 @@
 #define _WEB_ENGINE_H
 
 #include <string>
+#include <set>
 
 #include "SearchEngineInterface.h"
 #include "Document.h"
@@ -33,9 +34,18 @@
 	protected:
 		std::string m_hostFilter;
 		std::string m_fileFilter;
+		std::set<std::string> m_queryTerms;
 
 		Document *downloadPage(const DocumentInfo &docInfo);
 
+		void setHostNameFilter(const string &filter);
+
+		void setFileNameFilter(const string &filter);
+
+		void setQuery(const std::string &queryString);
+
+		virtual bool processResult(const string &queryUrl, Result &result);
+
 	private:
 		WebEngine(const WebEngine &other);
 		WebEngine &operator=(const WebEngine &other);

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Search/XapianEngine.cpp	2006-11-12 09:05:04 UTC (rev 573)
@@ -26,7 +26,6 @@
 
 #include "Languages.h"
 #include "StringManip.h"
-#include "Tokenizer.h"
 #include "Url.h"
 #include "XapianDatabaseFactory.h"
 #include "AbstractGenerator.h"
@@ -40,51 +39,6 @@
 using std::endl;
 using std::inserter;
 
-static bool extractWords(const string &text, const string &stemLanguage, vector<string> &wordsList)
-{
-	Xapian::Stem *pStemmer = NULL;
-
-	if (text.empty() == true)
-	{
-		return false;
-	}
-
-	if (stemLanguage.empty() == false)
-	{
-		pStemmer = new Xapian::Stem(StringManip::toLowerCase(stemLanguage));
-	}
-
-	Document doc;
-	doc.setData(text.c_str(), text.length());
-	Tokenizer tokens(&doc);
-
-	string token;
-	while (tokens.nextToken(token) == true)
-	{
-		string term = token;
-
-		// Lower case the term
-		term = StringManip::toLowerCase(term);
-		// Stem it ?
-		if (pStemmer != NULL)
-		{
-			string stemmedTerm = pStemmer->stem_word(term);
-			wordsList.push_back(stemmedTerm);
-		}
-		else
-		{
-			wordsList.push_back(term);
-		}
-	}
-
-	if (pStemmer != NULL)
-	{
-		delete pStemmer;
-	}
-
-	return true;
-}
-
 XapianEngine::XapianEngine(const string &database) :
 	SearchEngineInterface()
 {

Modified: trunk/Utils/Result.cpp
===================================================================
--- trunk/Utils/Result.cpp	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Utils/Result.cpp	2006-11-12 09:05:04 UTC (rev 573)
@@ -66,7 +66,13 @@
 	return true;
 }
 
-/// Returns the result extract.
+/// Sets the result extract.
+void Result::setExtract(const string &extract)
+{
+	m_extract = extract;
+}
+
+/// Gets the result extract.
 string Result::getExtract(void) const
 {
 	return m_extract;

Modified: trunk/Utils/Result.h
===================================================================
--- trunk/Utils/Result.h	2006-11-12 05:11:06 UTC (rev 572)
+++ trunk/Utils/Result.h	2006-11-12 09:05:04 UTC (rev 573)
@@ -36,7 +36,10 @@
 
 		bool operator<(const Result& other) const;
 
-		/// Returns the result extract.
+		/// Sets the result extract.
+		void setExtract(const std::string &extract);
+
+		/// Gets the result extract.
 		std::string getExtract(void) const;
 
 		/// Returns the result score.



From fabricecolin at mail.berlios.de  Mon Nov 13 12:40:35 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Mon, 13 Nov 2006 12:40:35 +0100
Subject: [Pinot-svn] r574 - in trunk/Search: . Google
Message-ID: <200611131140.kADBeZXU000232@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-13 12:40:33 +0100 (Mon, 13 Nov 2006)
New Revision: 574

Modified:
   trunk/Search/Google/GoogleAPIEngine.cpp
   trunk/Search/PluginWebEngine.cpp
   trunk/Search/WebEngine.cpp
   trunk/Search/WebEngine.h
Log:
Use QueryProperties::getTerms() as it skips filters.


Modified: trunk/Search/Google/GoogleAPIEngine.cpp
===================================================================
--- trunk/Search/Google/GoogleAPIEngine.cpp	2006-11-12 09:05:04 UTC (rev 573)
+++ trunk/Search/Google/GoogleAPIEngine.cpp	2006-11-13 11:40:33 UTC (rev 574)
@@ -89,7 +89,7 @@
 
 	setHostNameFilter(queryProps.getHostFilter());
 	setFileNameFilter(queryProps.getFileFilter());
-	setQuery(queryString);
+	setQuery(queryProps);
 
 	if (m_key.empty() == true)
 	{

Modified: trunk/Search/PluginWebEngine.cpp
===================================================================
--- trunk/Search/PluginWebEngine.cpp	2006-11-12 09:05:04 UTC (rev 573)
+++ trunk/Search/PluginWebEngine.cpp	2006-11-13 11:40:33 UTC (rev 574)
@@ -249,7 +249,7 @@
 
 	setHostNameFilter(queryProps.getHostFilter());
 	setFileNameFilter(queryProps.getFileFilter());
-	setQuery(queryString);
+	setQuery(queryProps);
 
 #ifdef DEBUG
 	cout << "PluginWebEngine::runQuery: querying "

Modified: trunk/Search/WebEngine.cpp
===================================================================
--- trunk/Search/WebEngine.cpp	2006-11-12 09:05:04 UTC (rev 573)
+++ trunk/Search/WebEngine.cpp	2006-11-13 11:40:33 UTC (rev 574)
@@ -108,25 +108,9 @@
 	m_fileFilter = filter;
 }
 
-void WebEngine::setQuery(const string &queryString)
+void WebEngine::setQuery(const QueryProperties &queryProps)
 {
-	if (queryString.empty() == true)
-	{
-		return;
-	}
-
-	Document doc;
-	doc.setData(queryString.c_str(), queryString.length());
-	Tokenizer tokens(&doc);
-
-	m_queryTerms.clear();
-
-	string token;
-	while (tokens.nextToken(token) == true)
-	{
-		// Lower case the word
-		m_queryTerms.insert(StringManip::toLowerCase(token));
-	}
+	queryProps.getTerms(m_queryTerms);
 }
 
 bool WebEngine::processResult(const string &queryUrl, Result &result)

Modified: trunk/Search/WebEngine.h
===================================================================
--- trunk/Search/WebEngine.h	2006-11-12 09:05:04 UTC (rev 573)
+++ trunk/Search/WebEngine.h	2006-11-13 11:40:33 UTC (rev 574)
@@ -22,8 +22,9 @@
 #include <string>
 #include <set>
 
+#include "Document.h"
+#include "QueryProperties.h"
 #include "SearchEngineInterface.h"
-#include "Document.h"
 
 class WebEngine : public SearchEngineInterface
 {
@@ -42,7 +43,7 @@
 
 		void setFileNameFilter(const string &filter);
 
-		void setQuery(const std::string &queryString);
+		void setQuery(const QueryProperties &queryProps);
 
 		virtual bool processResult(const string &queryUrl, Result &result);
 



From fabricecolin at mail.berlios.de  Mon Nov 13 12:42:51 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Mon, 13 Nov 2006 12:42:51 +0100
Subject: [Pinot-svn] r575 - trunk/UI/GTK2/src
Message-ID: <200611131142.kADBgpfF002476@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-13 12:42:51 +0100 (Mon, 13 Nov 2006)
New Revision: 575

Modified:
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Extract was not copied into the clipboard and result rows not correctly.


Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-11-13 11:40:33 UTC (rev 574)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-11-13 11:42:51 UTC (rev 575)
@@ -411,6 +411,33 @@
 }
 
 //
+// Returns the extract tree.
+//
+TreeView *ResultsTree::getExtractTree(void) const
+{
+	return m_extractTreeView;
+}
+
+//
+// Returns the extract.
+//
+ustring ResultsTree::getExtract(void) const
+{
+	ustring text;
+
+	TreeModel::Children children = m_refExtractStore->children();
+	for (TreeModel::Children::iterator iter = children.begin();
+		iter != children.end(); ++iter)
+	{
+		TreeModel::Row row = *iter;
+
+		text += row[m_extractColumns.m_name];
+	}
+
+	return text;
+}
+
+//
 // Adds a set of results.
 // Returns true if something was added to the tree.
 //
@@ -760,25 +787,6 @@
 }
 
 //
-// Gets the first selected item.
-//
-Result ResultsTree::getFirstSelection(void)
-{
-	list<TreeModel::Path> selectedItems = get_selection()->get_selected_rows();
-	if (selectedItems.empty() == true)
-	{
-		return Result("", "", "", "");
-	}
-
-	list<TreeModel::Path>::iterator itemPath = selectedItems.begin();
-	TreeModel::iterator iter = m_refStore->get_iter(*itemPath);
-	TreeModel::Row row = *iter;
-	return Result(from_utf8(row[m_resultsColumns.m_url]),
-		from_utf8(row[m_resultsColumns.m_text]),
-		"", "");
-}
-
-//
 // Gets a list of selected items.
 //
 bool ResultsTree::getSelection(vector<DocumentInfo> &resultsList)
@@ -796,14 +804,8 @@
 		TreeModel::iterator iter = m_refStore->get_iter(*itemPath);
 		TreeModel::Row row = *iter;
 
-		if (row[m_resultsColumns.m_type] != ResultsModelColumns::RESULT_TITLE)
-		{
-			continue;
-		}
-
 		resultsList.push_back(DocumentInfo(from_utf8(row[m_resultsColumns.m_text]),
-			from_utf8(row[m_resultsColumns.m_url]),
-			"", ""));
+			from_utf8(row[m_resultsColumns.m_url]), "", ""));
 	}
 #ifdef DEBUG
 	cout << "ResultsTree::getSelection: " << resultsList.size() << " results selected" << endl;
@@ -1243,7 +1245,7 @@
 	unsigned int indexIds = row[m_resultsColumns.m_indexes];
 
 #ifdef DEBUG
-	cout << "ResultsTree::getExtract: engines " << engineIds << ", indexes " << indexIds << endl;
+	cout << "ResultsTree::findResultsExtract: engines " << engineIds << ", indexes " << indexIds << endl;
 #endif
 	m_settings.getEngineNames(engineIds, engineNames);
 	if (engineNames.empty() == false)
@@ -1270,7 +1272,7 @@
 		}
 
 #ifdef DEBUG
-		cout << "ResultsTree::getExtract: first engine for " << url << " was " << engineName << endl;
+		cout << "ResultsTree::findResultsExtract: first engine for " << url << " was " << engineName << endl;
 #endif
 		extract = history.getItemExtract(from_utf8(m_queryName), engineName, url);
 	}

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2006-11-13 11:40:33 UTC (rev 574)
+++ trunk/UI/GTK2/src/ResultsTree.h	2006-11-13 11:42:51 UTC (rev 575)
@@ -53,6 +53,12 @@
 		/// Returns the extract scrolled window.
 		Gtk::ScrolledWindow *getExtractScrolledWindow(void) const;
 
+		/// Returns the extract tree.
+		Gtk::TreeView *getExtractTree(void) const;
+
+		/// Returns the extract.
+		Glib::ustring getExtract(void) const;
+
 		/**
 		  * Adds a set of results.
 		  * Returns true if something was added to the tree.
@@ -64,9 +70,6 @@
 		/// Sets how results are grouped.
 		void setGroupMode(bool groupBySearchEngine);
 
-		/// Gets the first selected item.
-		Result getFirstSelection(void);
-
 		/// Gets a list of selected items.
 		bool getSelection(std::vector<DocumentInfo> &resultsList);
 

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-11-13 11:40:33 UTC (rev 574)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-11-13 11:42:51 UTC (rev 575)
@@ -193,6 +193,7 @@
 	set_status(_("Ready"));
 	m_pNotebook->show();
 	show();
+	liveQueryEntry->grab_focus();
 }
 
 //
@@ -1461,8 +1462,18 @@
 				ResultsTree *pResultsTree = pResultsPage->getTree();
 				if (pResultsTree != NULL)
 				{
-					// Get the current results selection
-					pResultsTree->getSelection(documentsList);
+					TreeView *pTree = pResultsTree->getExtractTree();
+					if ((pTree != NULL) &&
+						(pTree->is_focus() == true))
+					{
+						// Retrieve the extract
+						text = pResultsTree->getExtract();
+					}
+					else
+					{
+						// Get the current results selection
+						pResultsTree->getSelection(documentsList);
+					}
 				}
 			}
 
@@ -1483,13 +1494,18 @@
 			for (vector<DocumentInfo>::const_iterator docIter = documentsList.begin();
 				docIter != documentsList.end(); ++docIter)
 			{
+				string location(docIter->getLocation());
+
 				if (firstItem == false)
 				{
 					text += "\n";
 				}
 				text += docIter->getTitle();
-				text += " ";
-				text += docIter->getLocation();
+				if (location.empty() == false)
+				{
+					text += " ";
+					text += location;
+				}
 				firstItem = false;
 			}
 		}



From fabricecolin at mail.berlios.de  Tue Nov 14 14:23:10 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 14 Nov 2006 14:23:10 +0100
Subject: [Pinot-svn] r576 - trunk/UI/GTK2/src
Message-ID: <200611141323.kAEDNAuq011661@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-14 14:23:10 +0100 (Tue, 14 Nov 2006)
New Revision: 576

Modified:
   trunk/UI/GTK2/src/IndexTree.cpp
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Minor mods.


Modified: trunk/UI/GTK2/src/IndexTree.cpp
===================================================================
--- trunk/UI/GTK2/src/IndexTree.cpp	2006-11-13 11:42:51 UTC (rev 575)
+++ trunk/UI/GTK2/src/IndexTree.cpp	2006-11-14 13:23:10 UTC (rev 576)
@@ -68,19 +68,16 @@
 	TreeViewColumn *pColumn = create_column(_("Title"), m_indexColumns.m_text, true, true, m_indexColumns.m_text);
 	if (pColumn != NULL)
 	{
-		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		append_column(*manage(pColumn));
 	}
 	pColumn = create_column(_("URL"), m_indexColumns.m_liveUrl, true, true, m_indexColumns.m_liveUrl);
 	if (pColumn != NULL)
 	{
-		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		append_column(*manage(pColumn));
 	}
 	pColumn = create_column(_("Timestamp"), m_indexColumns.m_timestamp, false, true, m_indexColumns.m_timestampTime);
 	if (pColumn != NULL)
 	{
-		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		append_column(*manage(pColumn));
 	}
 

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2006-11-13 11:42:51 UTC (rev 575)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2006-11-14 13:23:10 UTC (rev 576)
@@ -109,7 +109,6 @@
 	pIconRenderer = new CellRendererPixbuf();
 	pColumn->pack_start(*manage(pIconRenderer), false);
 	pColumn->set_cell_data_func(*pIconRenderer, SigC::slot(*this, &ResultsTree::renderRanking));
-	pColumn->set_resizable(true);
 	pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 	append_column(*manage(pColumn));
 
@@ -119,7 +118,6 @@
 	pColumn->pack_start(*manage(pProgressRenderer));
 	pColumn->add_attribute(pProgressRenderer->property_text(), m_resultsColumns.m_scoreText);
 	pColumn->add_attribute(pProgressRenderer->property_value(), m_resultsColumns.m_score);
-	pColumn->set_resizable(true);
 	pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 	pColumn->set_sort_column(m_resultsColumns.m_score);
 	append_column(*manage(pColumn));
@@ -131,7 +129,6 @@
 	pColumn->set_cell_data_func(*pTextRenderer, SigC::slot(*this, &ResultsTree::renderTitleColumn));
 	pColumn->add_attribute(pTextRenderer->property_text(), m_resultsColumns.m_text);
 	pColumn->set_resizable(true);
-	pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 	pColumn->set_sort_column(m_resultsColumns.m_text);
 	append_column(*manage(pColumn));
 
@@ -320,8 +317,12 @@
 	{
 		ustring markup(row[m_extractColumns.m_name]);
 		pTextRenderer->property_markup() = markup;
+		pTextRenderer->property_single_paragraph_mode() = true;
+		// These properties are not available in gtkmm 2.8
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=10
 		pTextRenderer->property_wrap_mode() = Pango::WRAP_WORD;
 		pTextRenderer->property_wrap_width() = m_pExtractScrolledwindow->get_width();
+#endif
 	}
 }
 

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-11-13 11:42:51 UTC (rev 575)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-11-14 13:23:10 UTC (rev 576)
@@ -140,13 +140,11 @@
 	TreeViewColumn *pColumn = create_column(_("Query Name"), m_queryColumns.m_name, true, true, m_queryColumns.m_name);
 	if (pColumn != NULL)
 	{
-		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		queryTreeview->append_column(*manage(pColumn));
 	}
 	pColumn = create_column(_("Last Run"), m_queryColumns.m_lastRun, true, true, m_queryColumns.m_lastRunTime);
 	if (pColumn != NULL)
 	{
-		pColumn->set_sizing(TREE_VIEW_COLUMN_AUTOSIZE);
 		queryTreeview->append_column(*manage(pColumn));
 	}
 	queryTreeview->append_column(_("Summary"), m_queryColumns.m_summary);



From fabricecolin at mail.berlios.de  Tue Nov 14 15:00:30 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 14 Nov 2006 15:00:30 +0100
Subject: [Pinot-svn] r577 - trunk/po
Message-ID: <200611141400.kAEE0Ujb022395@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-14 15:00:30 +0100 (Tue, 14 Nov 2006)
New Revision: 577

Modified:
   trunk/po/es.po
   trunk/po/fr.po
Log:
Added new strings since 0.62, merged in fixes to French po made by Nicolas Velin
prior to updating templates in Rosetta.


Modified: trunk/po/es.po
===================================================================
--- trunk/po/es.po	2006-11-14 13:23:10 UTC (rev 576)
+++ trunk/po/es.po	2006-11-14 14:00:30 UTC (rev 577)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.49\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-11-04 13:55+0800\n"
+"POT-Creation-Date: 2006-11-14 21:46+0800\n"
 "PO-Revision-Date: 2006-11-04 21:10+0800\n"
 "Last-Translator: Fabrice Colin <fabricecolin at users.berlios.de>\n"
 "Language-Team: es <fabricecolin at users.berlios.de>\n"
@@ -16,25 +16,30 @@
 "Content-Type: text/plain; charset=utf-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: UI/GTK2/src/EnginesTree.cpp:68
+#: UI/GTK2/src/EnginesTree.cpp:70
 msgid "Search Engines"
 msgstr "Motores de b?squeda"
 
-#: UI/GTK2/src/EnginesTree.cpp:330
+#: UI/GTK2/src/EnginesTree.cpp:328
 msgid "Current User"
 msgstr "Usuario"
 
-#: UI/GTK2/src/EnginesTree.cpp:341 UI/GTK2/src/mainWindow.cc:317
-#: UI/GTK2/src/mainWindow.cc:320 UI/GTK2/src/mainWindow.cc:546
-#: UI/GTK2/src/mainWindow.cc:1149 UI/GTK2/src/mainWindow.cc:1191
-#: UI/GTK2/src/mainWindow.cc:1211 UI/GTK2/src/mainWindow.cc:1242
-#: UI/GTK2/src/mainWindow.cc:1816 UI/GTK2/src/PinotSettings.cpp:235
+#. Bind the callback's parameter to the index name
+#. Enable these menu items unless it is not the documents index
+#. Internal indices
+#: UI/GTK2/src/EnginesTree.cpp:339 UI/GTK2/src/mainWindow.cc:318
+#: UI/GTK2/src/mainWindow.cc:321 UI/GTK2/src/mainWindow.cc:547
+#: UI/GTK2/src/mainWindow.cc:1150 UI/GTK2/src/mainWindow.cc:1192
+#: UI/GTK2/src/mainWindow.cc:1212 UI/GTK2/src/mainWindow.cc:1243
+#: UI/GTK2/src/mainWindow.cc:1832 UI/GTK2/src/PinotSettings.cpp:235
 #: UI/GTK2/src/PinotSettings.cpp:1222 UI/GTK2/src/PinotSettings.cpp:1278
 msgid "My Web Pages"
 msgstr "Mis Paginas Web"
 
-#: UI/GTK2/src/EnginesTree.cpp:342 UI/GTK2/src/mainWindow.cc:311
-#: UI/GTK2/src/mainWindow.cc:314 UI/GTK2/src/PinotSettings.cpp:236
+#. Populate the submenu
+#. Bind the callback's parameter to the index name
+#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:312
+#: UI/GTK2/src/mainWindow.cc:315 UI/GTK2/src/PinotSettings.cpp:236
 #: UI/GTK2/src/PinotSettings.cpp:1223 UI/GTK2/src/PinotSettings.cpp:1279
 msgid "My Documents"
 msgstr "Mis documentos"
@@ -88,17 +93,20 @@
 msgid "External index"
 msgstr "?ndice externo"
 
-#: UI/GTK2/src/IndexTree.cpp:66 UI/GTK2/src/queryDialog.cc:109
-#: UI/GTK2/src/ResultsTree.cpp:133
+#. The score column is used for status icons
+#. This is the title column
+#: UI/GTK2/src/IndexTree.cpp:68 UI/GTK2/src/queryDialog.cc:109
+#: UI/GTK2/src/ResultsTree.cpp:126
 msgid "Title"
 msgstr "T?tulo"
 
-#: UI/GTK2/src/IndexTree.cpp:71 UI/GTK2/src/queryDialog.cc:112
-#: UI/GTK2/src/ResultsTree.cpp:143
+#. The last column is for the URL
+#: UI/GTK2/src/IndexTree.cpp:73 UI/GTK2/src/queryDialog.cc:112
+#: UI/GTK2/src/ResultsTree.cpp:136
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/IndexTree.cpp:76
+#: UI/GTK2/src/IndexTree.cpp:78
 msgid "Timestamp"
 msgstr "Fecha"
 
@@ -126,6 +134,7 @@
 msgid "Summary"
 msgstr "Sumario"
 
+#. Set tooltips
 #: UI/GTK2/src/mainWindow.cc:183
 msgid "Show all search engines"
 msgstr "Mostrar todos los motores de b?squeda"
@@ -138,186 +147,191 @@
 msgid "Remove index"
 msgstr "Borrar ?ndice"
 
+#. Now we are ready
 #: UI/GTK2/src/mainWindow.cc:191
 msgid "Ready"
 msgstr "Listo"
 
-#: UI/GTK2/src/mainWindow.cc:235
+#: UI/GTK2/src/mainWindow.cc:236
 msgid "N/A"
 msgstr "Desconocido"
 
-#: UI/GTK2/src/mainWindow.cc:250
+#: UI/GTK2/src/mainWindow.cc:251
 msgid "<undefined>"
 msgstr "<indefinido>"
 
-#: UI/GTK2/src/mainWindow.cc:469
+#. Show the URL of the first result in the status bar
+#: UI/GTK2/src/mainWindow.cc:470
 msgid "Result location is"
 msgstr "La localizaci?n del resultado es"
 
-#: UI/GTK2/src/mainWindow.cc:556
+#. Show the URL in the status bar
+#: UI/GTK2/src/mainWindow.cc:557
 msgid "Document location is"
 msgstr "La localizaci?n del documento es"
 
-#: UI/GTK2/src/mainWindow.cc:874
+#: UI/GTK2/src/mainWindow.cc:875
 msgid "Showing"
 msgstr "Mostrando"
 
-#: UI/GTK2/src/mainWindow.cc:879
+#: UI/GTK2/src/mainWindow.cc:880
 msgid "of"
 msgstr "documentos"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:885
 msgid "documents, starting at"
 msgstr "documentos comenzando en"
 
-#: UI/GTK2/src/mainWindow.cc:917
+#: UI/GTK2/src/mainWindow.cc:918
 msgid "Query"
 msgstr "B?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:921 UI/GTK2/src/mainWindow.cc:2873
+#: UI/GTK2/src/mainWindow.cc:922 UI/GTK2/src/mainWindow.cc:2889
 msgid "on"
 msgstr "en"
 
-#: UI/GTK2/src/mainWindow.cc:925
+#: UI/GTK2/src/mainWindow.cc:926
 msgid "ended"
 msgstr "finalizado"
 
-#: UI/GTK2/src/mainWindow.cc:1014
+#: UI/GTK2/src/mainWindow.cc:1015
 msgid "More Like"
 msgstr "M?s como"
 
-#: UI/GTK2/src/mainWindow.cc:1075
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "Updated label(s)"
 msgstr "Etiqueta(s) actualizada(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1159
+#. Yes, it did
+#: UI/GTK2/src/mainWindow.cc:1160
 msgid "Updated document"
 msgstr "Documento actualizado"
 
-#: UI/GTK2/src/mainWindow.cc:1172
+#: UI/GTK2/src/mainWindow.cc:1173
 msgid "Indexed"
 msgstr "Indizado"
 
-#: UI/GTK2/src/mainWindow.cc:1212
+#: UI/GTK2/src/mainWindow.cc:1213
 msgid "Unindexed document(s)"
 msgstr "Documento(s) no indizado(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1253
+#: UI/GTK2/src/mainWindow.cc:1254
 msgid "Updated document properties"
 msgstr "Propiedades del documento actualizadas"
 
-#: UI/GTK2/src/mainWindow.cc:1300
+#: UI/GTK2/src/mainWindow.cc:1301
 msgid "Couldn't rename index, name"
 msgstr "No se pudo renombrar ?ndice, nombre"
 
-#: UI/GTK2/src/mainWindow.cc:1304 UI/GTK2/src/mainWindow.cc:2197
-#: UI/GTK2/src/mainWindow.cc:2708
+#: UI/GTK2/src/mainWindow.cc:1305 UI/GTK2/src/mainWindow.cc:2213
+#: UI/GTK2/src/mainWindow.cc:2724
 msgid "is already in use"
 msgstr "ya est? en uso"
 
-#: UI/GTK2/src/mainWindow.cc:1317
+#: UI/GTK2/src/mainWindow.cc:1318
 msgid "Couldn't rename index"
 msgstr "No se pudo renombrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1330
+#: UI/GTK2/src/mainWindow.cc:1331
 msgid "Edited index"
 msgstr "?ndice editado"
 
-#: UI/GTK2/src/mainWindow.cc:1694 UI/GTK2/src/mainWindow.cc:2367
+#. Find this query
+#: UI/GTK2/src/mainWindow.cc:1710 UI/GTK2/src/mainWindow.cc:2383
 msgid "Live query"
 msgstr "B?squeda activa"
 
-#: UI/GTK2/src/mainWindow.cc:1720
+#: UI/GTK2/src/mainWindow.cc:1736
 msgid "Couldn't find query"
 msgstr "No se pudo a?adir la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:1764 UI/GTK2/src/mainWindow.cc:1860
+#: UI/GTK2/src/mainWindow.cc:1780 UI/GTK2/src/mainWindow.cc:1876
 msgid "Please set a location for the index first"
 msgstr "Por favor, primero fije una localizaci?n para el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1937 UI/GTK2/src/WorkerThreads.cpp:639
-#: UI/GTK2/src/WorkerThreads.cpp:1415
+#: UI/GTK2/src/mainWindow.cc:1953 UI/GTK2/src/WorkerThreads.cpp:639
+#: UI/GTK2/src/WorkerThreads.cpp:1414
 msgid "Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1941 UI/GTK2/src/WorkerThreads.cpp:643
-#: UI/GTK2/src/WorkerThreads.cpp:1419
+#: UI/GTK2/src/mainWindow.cc:1957 UI/GTK2/src/WorkerThreads.cpp:643
+#: UI/GTK2/src/WorkerThreads.cpp:1418
 msgid "doesn't exist"
 msgstr "no existe"
 
-#: UI/GTK2/src/mainWindow.cc:2085
+#: UI/GTK2/src/mainWindow.cc:2101
 msgid "Remove this document from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:2104
+#: UI/GTK2/src/mainWindow.cc:2120
 msgid "Remove these documents from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:2148
+#: UI/GTK2/src/mainWindow.cc:2164
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Una herramienta metabuscador para el escritorio libre"
 
-#: UI/GTK2/src/mainWindow.cc:2149
+#: UI/GTK2/src/mainWindow.cc:2165
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2193
+#: UI/GTK2/src/mainWindow.cc:2209
 msgid "Index name"
 msgstr "Nombre del ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2208
+#: UI/GTK2/src/mainWindow.cc:2224
 msgid "Couldn't add index"
 msgstr "No se pudo a?adir el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2222
+#: UI/GTK2/src/mainWindow.cc:2238
 msgid "Added new index"
 msgstr "A?adido un nuevo ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2257
+#: UI/GTK2/src/mainWindow.cc:2273
 msgid "Couldn't remove index"
 msgstr "No se pudo borrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2522
+#: UI/GTK2/src/mainWindow.cc:2538
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Al menos una tarea no ha finalizado. ?Parar ahora?"
 
-#: UI/GTK2/src/mainWindow.cc:2704
+#: UI/GTK2/src/mainWindow.cc:2720
 msgid "Query name"
 msgstr "Nombre la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2731
+#: UI/GTK2/src/mainWindow.cc:2747
 msgid "Couldn't update query"
 msgstr "No se pudo actualizar la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2739
+#: UI/GTK2/src/mainWindow.cc:2755
 msgid "Edited query"
 msgstr "B?squeda editada"
 
-#: UI/GTK2/src/mainWindow.cc:2746
+#: UI/GTK2/src/mainWindow.cc:2762
 msgid "Couldn't add query"
 msgstr "No se pudo a?adir la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2754
+#: UI/GTK2/src/mainWindow.cc:2770
 msgid "Added new query"
 msgstr "A?adida una nueva b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2767
+#: UI/GTK2/src/mainWindow.cc:2783
 msgid "Query is not set"
 msgstr "B?squeda no definida"
 
-#: UI/GTK2/src/mainWindow.cc:2778
+#: UI/GTK2/src/mainWindow.cc:2794
 msgid "No search engine selected"
 msgstr "Motor de b?squeda no seleccionado"
 
-#: UI/GTK2/src/mainWindow.cc:2860
+#: UI/GTK2/src/mainWindow.cc:2876
 msgid "Please set the Google API key first"
 msgstr "Por favor, primero configure el API de Google"
 
-#: UI/GTK2/src/mainWindow.cc:2869
+#: UI/GTK2/src/mainWindow.cc:2885
 msgid "Running query"
 msgstr "Ejecutando la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:3042
+#: UI/GTK2/src/mainWindow.cc:3058
 msgid "No default application defined for type"
 msgstr "No hay aplicaci?n predefinida para el tipo"
 
@@ -414,6 +428,7 @@
 msgid "Pinot"
 msgstr "Pinot"
 
+#. Localize language names
 #: UI/GTK2/src/pinot.cc:167 UI/GTK2/src/pinot-dbus-daemon.cc:680
 msgid "Unknown"
 msgstr "Desconocido"
@@ -474,6 +489,7 @@
 msgid "Couldn't create history database"
 msgstr "No se pudo crear la base de datos del hist?rico"
 
+#. Add default labels
 #: UI/GTK2/src/PinotSettings.cpp:241
 msgid "Important"
 msgstr "Importante"
@@ -639,10 +655,15 @@
 msgid "Query parameters"
 msgstr "Par?metros de b?squeda"
 
-#: UI/GTK2/src/ResultsTree.cpp:123
+#. This is the score column
+#: UI/GTK2/src/ResultsTree.cpp:116
 msgid "Score"
 msgstr "Cuenta"
 
+#: UI/GTK2/src/ResultsTree.cpp:165
+msgid "Extract"
+msgstr "Extra?dos"
+
 #: UI/GTK2/src/WorkerThreads.cpp:302
 msgid "Can't index mail here"
 msgstr "No se pudo indizar el buzon de correo"
@@ -656,17 +677,17 @@
 msgstr "ya excluido"
 
 #: UI/GTK2/src/WorkerThreads.cpp:341 UI/GTK2/src/WorkerThreads.cpp:652
-#: UI/GTK2/src/WorkerThreads.cpp:928 UI/GTK2/src/WorkerThreads.cpp:937
-#: UI/GTK2/src/WorkerThreads.cpp:1103 UI/GTK2/src/WorkerThreads.cpp:1304
-#: UI/GTK2/src/WorkerThreads.cpp:1428
+#: UI/GTK2/src/WorkerThreads.cpp:927 UI/GTK2/src/WorkerThreads.cpp:936
+#: UI/GTK2/src/WorkerThreads.cpp:1102 UI/GTK2/src/WorkerThreads.cpp:1303
+#: UI/GTK2/src/WorkerThreads.cpp:1427
 msgid "Index error on"
 msgstr "Error en el ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:771 UI/GTK2/src/WorkerThreads.cpp:872
+#: UI/GTK2/src/WorkerThreads.cpp:771 UI/GTK2/src/WorkerThreads.cpp:871
 msgid "Couldn't create search engine"
 msgstr "No se pudo crear el motor de b?squeda"
 
-#: UI/GTK2/src/WorkerThreads.cpp:783 UI/GTK2/src/WorkerThreads.cpp:886
+#: UI/GTK2/src/WorkerThreads.cpp:783 UI/GTK2/src/WorkerThreads.cpp:885
 msgid "Couldn't run query on search engine"
 msgstr "No se pudo ejecutar la b?squeda contra el motor"
 
@@ -674,50 +695,51 @@
 msgid "No title"
 msgstr "Sin t?tulo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1016
+#: UI/GTK2/src/WorkerThreads.cpp:1015
 msgid "Couldn't obtain downloader for protocol"
 msgstr "No se pudo usar un recuperador para el protocolo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1027
+#: UI/GTK2/src/WorkerThreads.cpp:1026
 msgid "Couldn't retrieve"
 msgstr "No se pudo descargar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1153
+#: UI/GTK2/src/WorkerThreads.cpp:1152
 msgid "Cannot index document type"
 msgstr "No se pudo indizar el tipo de documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1157
+#: UI/GTK2/src/WorkerThreads.cpp:1156
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1179
+#: UI/GTK2/src/WorkerThreads.cpp:1178
 msgid "Couldn't tokenize"
 msgstr "No se pudo extraer cadenas"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1199
+#: UI/GTK2/src/WorkerThreads.cpp:1198
 msgid "Robots META tag forbids indexing"
 msgstr "La etiqueta META Robots proh?be la indizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1234
+#: UI/GTK2/src/WorkerThreads.cpp:1233
 msgid "Couldn't index"
 msgstr "No se pudo indizar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1315
+#. Be pessimistic and assume something will go wrong ;-)
+#: UI/GTK2/src/WorkerThreads.cpp:1314
 msgid "Couldn't unindex document(s)"
 msgstr "No se pudo des-indizar lo(s) documento(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1440
+#: UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Couldn't update document"
 msgstr "No se pudo actualizar el documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1616
+#: UI/GTK2/src/WorkerThreads.cpp:1615
 msgid "No monitoring handler"
 msgstr "No hay monitorizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1658
+#: UI/GTK2/src/WorkerThreads.cpp:1657
 msgid "Couldn't initialize file monitor"
 msgstr "No se puede inicializar el monitor de archivo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1940
+#: UI/GTK2/src/WorkerThreads.cpp:1939
 msgid "Couldn't open directory"
 msgstr "No se pudo abrir el directorio"

Modified: trunk/po/fr.po
===================================================================
--- trunk/po/fr.po	2006-11-14 13:23:10 UTC (rev 576)
+++ trunk/po/fr.po	2006-11-14 14:00:30 UTC (rev 577)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.49\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-11-04 13:55+0800\n"
+"POT-Creation-Date: 2006-11-14 21:46+0800\n"
 "PO-Revision-Date: 2006-11-04 21:10+0800\n"
 "Last-Translator: Fabrice Colin <fabricecolin at users.berlios.de>\n"
 "Language-Team: fr <fabricecolin at users.berlios.de>\n"
@@ -16,25 +16,30 @@
 "Content-Type: text/plain; charset=utf-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: UI/GTK2/src/EnginesTree.cpp:68
+#: UI/GTK2/src/EnginesTree.cpp:70
 msgid "Search Engines"
 msgstr "Moteurs"
 
-#: UI/GTK2/src/EnginesTree.cpp:330
+#: UI/GTK2/src/EnginesTree.cpp:328
 msgid "Current User"
 msgstr "Utilisateur"
 
-#: UI/GTK2/src/EnginesTree.cpp:341 UI/GTK2/src/mainWindow.cc:317
-#: UI/GTK2/src/mainWindow.cc:320 UI/GTK2/src/mainWindow.cc:546
-#: UI/GTK2/src/mainWindow.cc:1149 UI/GTK2/src/mainWindow.cc:1191
-#: UI/GTK2/src/mainWindow.cc:1211 UI/GTK2/src/mainWindow.cc:1242
-#: UI/GTK2/src/mainWindow.cc:1816 UI/GTK2/src/PinotSettings.cpp:235
+#. Bind the callback's parameter to the index name
+#. Enable these menu items unless it is not the documents index
+#. Internal indices
+#: UI/GTK2/src/EnginesTree.cpp:339 UI/GTK2/src/mainWindow.cc:318
+#: UI/GTK2/src/mainWindow.cc:321 UI/GTK2/src/mainWindow.cc:547
+#: UI/GTK2/src/mainWindow.cc:1150 UI/GTK2/src/mainWindow.cc:1192
+#: UI/GTK2/src/mainWindow.cc:1212 UI/GTK2/src/mainWindow.cc:1243
+#: UI/GTK2/src/mainWindow.cc:1832 UI/GTK2/src/PinotSettings.cpp:235
 #: UI/GTK2/src/PinotSettings.cpp:1222 UI/GTK2/src/PinotSettings.cpp:1278
 msgid "My Web Pages"
 msgstr "Mes Pages Web"
 
-#: UI/GTK2/src/EnginesTree.cpp:342 UI/GTK2/src/mainWindow.cc:311
-#: UI/GTK2/src/mainWindow.cc:314 UI/GTK2/src/PinotSettings.cpp:236
+#. Populate the submenu
+#. Bind the callback's parameter to the index name
+#: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:312
+#: UI/GTK2/src/mainWindow.cc:315 UI/GTK2/src/PinotSettings.cpp:236
 #: UI/GTK2/src/PinotSettings.cpp:1223 UI/GTK2/src/PinotSettings.cpp:1279
 msgid "My Documents"
 msgstr "Mes Documents"
@@ -88,17 +93,20 @@
 msgid "External index"
 msgstr "Index externe"
 
-#: UI/GTK2/src/IndexTree.cpp:66 UI/GTK2/src/queryDialog.cc:109
-#: UI/GTK2/src/ResultsTree.cpp:133
+#. The score column is used for status icons
+#. This is the title column
+#: UI/GTK2/src/IndexTree.cpp:68 UI/GTK2/src/queryDialog.cc:109
+#: UI/GTK2/src/ResultsTree.cpp:126
 msgid "Title"
 msgstr "Titre"
 
-#: UI/GTK2/src/IndexTree.cpp:71 UI/GTK2/src/queryDialog.cc:112
-#: UI/GTK2/src/ResultsTree.cpp:143
+#. The last column is for the URL
+#: UI/GTK2/src/IndexTree.cpp:73 UI/GTK2/src/queryDialog.cc:112
+#: UI/GTK2/src/ResultsTree.cpp:136
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/IndexTree.cpp:76
+#: UI/GTK2/src/IndexTree.cpp:78
 msgid "Timestamp"
 msgstr "Date"
 
@@ -126,6 +134,7 @@
 msgid "Summary"
 msgstr "Sommaire"
 
+#. Set tooltips
 #: UI/GTK2/src/mainWindow.cc:183
 msgid "Show all search engines"
 msgstr "Montrer tous les moteurs"
@@ -138,186 +147,191 @@
 msgid "Remove index"
 msgstr "Enlever un index"
 
+#. Now we are ready
 #: UI/GTK2/src/mainWindow.cc:191
 msgid "Ready"
 msgstr "Pret"
 
-#: UI/GTK2/src/mainWindow.cc:235
+#: UI/GTK2/src/mainWindow.cc:236
 msgid "N/A"
 msgstr "Inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:250
+#: UI/GTK2/src/mainWindow.cc:251
 msgid "<undefined>"
 msgstr "<inconnu>"
 
-#: UI/GTK2/src/mainWindow.cc:469
+#. Show the URL of the first result in the status bar
+#: UI/GTK2/src/mainWindow.cc:470
 msgid "Result location is"
 msgstr "Le chemin du resultat est"
 
-#: UI/GTK2/src/mainWindow.cc:556
+#. Show the URL in the status bar
+#: UI/GTK2/src/mainWindow.cc:557
 msgid "Document location is"
 msgstr "Le chemin du document is"
 
-#: UI/GTK2/src/mainWindow.cc:874
+#: UI/GTK2/src/mainWindow.cc:875
 msgid "Showing"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:879
+#: UI/GTK2/src/mainWindow.cc:880
 msgid "of"
 msgstr "documents,"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:885
 msgid "documents, starting at"
 msgstr "au total, a partir de"
 
-#: UI/GTK2/src/mainWindow.cc:917
+#: UI/GTK2/src/mainWindow.cc:918
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:921 UI/GTK2/src/mainWindow.cc:2873
+#: UI/GTK2/src/mainWindow.cc:922 UI/GTK2/src/mainWindow.cc:2889
 msgid "on"
 msgstr "sur"
 
-#: UI/GTK2/src/mainWindow.cc:925
+#: UI/GTK2/src/mainWindow.cc:926
 msgid "ended"
 msgstr "est terminee"
 
-#: UI/GTK2/src/mainWindow.cc:1014
+#: UI/GTK2/src/mainWindow.cc:1015
 msgid "More Like"
 msgstr "Similaire a"
 
-#: UI/GTK2/src/mainWindow.cc:1075
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "Updated label(s)"
 msgstr "Mis a jour l(es) etiquette(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1159
+#. Yes, it did
+#: UI/GTK2/src/mainWindow.cc:1160
 msgid "Updated document"
 msgstr "Mis a jour le document"
 
-#: UI/GTK2/src/mainWindow.cc:1172
+#: UI/GTK2/src/mainWindow.cc:1173
 msgid "Indexed"
 msgstr "Indexe"
 
-#: UI/GTK2/src/mainWindow.cc:1212
+#: UI/GTK2/src/mainWindow.cc:1213
 msgid "Unindexed document(s)"
 msgstr "Desindexe le(s) document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1253
+#: UI/GTK2/src/mainWindow.cc:1254
 msgid "Updated document properties"
 msgstr "Mis a jour les proprietes du document"
 
-#: UI/GTK2/src/mainWindow.cc:1300
+#: UI/GTK2/src/mainWindow.cc:1301
 msgid "Couldn't rename index, name"
 msgstr "N'a pas pu renommer l'index, le nom"
 
-#: UI/GTK2/src/mainWindow.cc:1304 UI/GTK2/src/mainWindow.cc:2197
-#: UI/GTK2/src/mainWindow.cc:2708
+#: UI/GTK2/src/mainWindow.cc:1305 UI/GTK2/src/mainWindow.cc:2213
+#: UI/GTK2/src/mainWindow.cc:2724
 msgid "is already in use"
 msgstr "est deja utilise"
 
-#: UI/GTK2/src/mainWindow.cc:1317
+#: UI/GTK2/src/mainWindow.cc:1318
 msgid "Couldn't rename index"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1330
+#: UI/GTK2/src/mainWindow.cc:1331
 msgid "Edited index"
 msgstr "Edite l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1694 UI/GTK2/src/mainWindow.cc:2367
+#. Find this query
+#: UI/GTK2/src/mainWindow.cc:1710 UI/GTK2/src/mainWindow.cc:2383
 msgid "Live query"
 msgstr "Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:1720
+#: UI/GTK2/src/mainWindow.cc:1736
 msgid "Couldn't find query"
 msgstr "N'a pas pu trouver"
 
-#: UI/GTK2/src/mainWindow.cc:1764 UI/GTK2/src/mainWindow.cc:1860
+#: UI/GTK2/src/mainWindow.cc:1780 UI/GTK2/src/mainWindow.cc:1876
 msgid "Please set a location for the index first"
 msgstr "Donnez un chemin a l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1937 UI/GTK2/src/WorkerThreads.cpp:639
-#: UI/GTK2/src/WorkerThreads.cpp:1415
+#: UI/GTK2/src/mainWindow.cc:1953 UI/GTK2/src/WorkerThreads.cpp:639
+#: UI/GTK2/src/WorkerThreads.cpp:1414
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:1941 UI/GTK2/src/WorkerThreads.cpp:643
-#: UI/GTK2/src/WorkerThreads.cpp:1419
+#: UI/GTK2/src/mainWindow.cc:1957 UI/GTK2/src/WorkerThreads.cpp:643
+#: UI/GTK2/src/WorkerThreads.cpp:1418
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
-#: UI/GTK2/src/mainWindow.cc:2085
+#: UI/GTK2/src/mainWindow.cc:2101
 msgid "Remove this document from the index ?"
 msgstr "Enlever ce document de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2104
+#: UI/GTK2/src/mainWindow.cc:2120
 msgid "Remove these documents from the index ?"
 msgstr "Enlever ces documents de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2148
+#: UI/GTK2/src/mainWindow.cc:2164
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Un outil de recherche pour le Bureau Libre"
 
-#: UI/GTK2/src/mainWindow.cc:2149
+#: UI/GTK2/src/mainWindow.cc:2165
 msgid "(C) 2005-2006 Fabrice Colin"
 msgstr "(C) 2005-2006 Fabrice Colin"
 
-#: UI/GTK2/src/mainWindow.cc:2193
+#: UI/GTK2/src/mainWindow.cc:2209
 msgid "Index name"
 msgstr "Nom de l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2208
+#: UI/GTK2/src/mainWindow.cc:2224
 msgid "Couldn't add index"
 msgstr "N'a pas pu ajouter l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2222
+#: UI/GTK2/src/mainWindow.cc:2238
 msgid "Added new index"
 msgstr "Ajoute un nouvel index"
 
-#: UI/GTK2/src/mainWindow.cc:2257
+#: UI/GTK2/src/mainWindow.cc:2273
 msgid "Couldn't remove index"
 msgstr "N'a pas pu enlever l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2522
+#: UI/GTK2/src/mainWindow.cc:2538
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2704
+#: UI/GTK2/src/mainWindow.cc:2720
 msgid "Query name"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2731
+#: UI/GTK2/src/mainWindow.cc:2747
 msgid "Couldn't update query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2739
+#: UI/GTK2/src/mainWindow.cc:2755
 msgid "Edited query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2746
+#: UI/GTK2/src/mainWindow.cc:2762
 msgid "Couldn't add query"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2754
+#: UI/GTK2/src/mainWindow.cc:2770
 msgid "Added new query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2767
+#: UI/GTK2/src/mainWindow.cc:2783
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2778
+#: UI/GTK2/src/mainWindow.cc:2794
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:2860
+#: UI/GTK2/src/mainWindow.cc:2876
 msgid "Please set the Google API key first"
-msgstr "Configurez la clef de l'API Google "
+msgstr "Configurez la clef de l'API Google"
 
-#: UI/GTK2/src/mainWindow.cc:2869
+#: UI/GTK2/src/mainWindow.cc:2885
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:3042
+#: UI/GTK2/src/mainWindow.cc:3058
 msgid "No default application defined for type"
 msgstr "Pas d'application definie pour le type"
 
@@ -339,7 +353,7 @@
 
 #: UI/GTK2/src/mainWindow_glade.cc:183
 msgid "Host Name"
-msgstr "Nom de machine"
+msgstr "Nom de Machine"
 
 #: UI/GTK2/src/mainWindow_glade.cc:186
 msgid "Show Extract"
@@ -414,6 +428,7 @@
 msgid "Pinot"
 msgstr "Pinot"
 
+#. Localize language names
 #: UI/GTK2/src/pinot.cc:167 UI/GTK2/src/pinot-dbus-daemon.cc:680
 msgid "Unknown"
 msgstr "Inconnu"
@@ -474,6 +489,7 @@
 msgid "Couldn't create history database"
 msgstr "N'a pas pu creer la base d'historiques"
 
+#. Add default labels
 #: UI/GTK2/src/PinotSettings.cpp:241
 msgid "Important"
 msgstr "Important"
@@ -569,7 +585,7 @@
 
 #: UI/GTK2/src/prefsDialog_glade.cc:110
 msgid "Mail boxes of type mbox can be monitored and indexed:"
-msgstr "Les boites a courrier de type mbox peuvent etre indexees"
+msgstr "Les boites de type mbox peuvent etre indexees"
 
 #: UI/GTK2/src/prefsDialog_glade.cc:123
 msgid "Specify any file pattern you wish to exclude from indexing:"
@@ -639,12 +655,16 @@
 msgid "Query parameters"
 msgstr "Parametres de la recherche"
 
-#: UI/GTK2/src/ResultsTree.cpp:123
+#. This is the score column
+#: UI/GTK2/src/ResultsTree.cpp:116
 msgid "Score"
 msgstr "Score"
 
+#: UI/GTK2/src/ResultsTree.cpp:165
+msgid "Extract"
+msgstr "Extrait"
+
 #: UI/GTK2/src/WorkerThreads.cpp:302
-#, fuzzy
 msgid "Can't index mail here"
 msgstr "Ne peut pas indexer le courrier ici"
 
@@ -657,17 +677,17 @@
 msgstr "est exclus"
 
 #: UI/GTK2/src/WorkerThreads.cpp:341 UI/GTK2/src/WorkerThreads.cpp:652
-#: UI/GTK2/src/WorkerThreads.cpp:928 UI/GTK2/src/WorkerThreads.cpp:937
-#: UI/GTK2/src/WorkerThreads.cpp:1103 UI/GTK2/src/WorkerThreads.cpp:1304
-#: UI/GTK2/src/WorkerThreads.cpp:1428
+#: UI/GTK2/src/WorkerThreads.cpp:927 UI/GTK2/src/WorkerThreads.cpp:936
+#: UI/GTK2/src/WorkerThreads.cpp:1102 UI/GTK2/src/WorkerThreads.cpp:1303
+#: UI/GTK2/src/WorkerThreads.cpp:1427
 msgid "Index error on"
 msgstr "Erreur sur l'index"
 
-#: UI/GTK2/src/WorkerThreads.cpp:771 UI/GTK2/src/WorkerThreads.cpp:872
+#: UI/GTK2/src/WorkerThreads.cpp:771 UI/GTK2/src/WorkerThreads.cpp:871
 msgid "Couldn't create search engine"
 msgstr "N'a pas pu creer le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:783 UI/GTK2/src/WorkerThreads.cpp:886
+#: UI/GTK2/src/WorkerThreads.cpp:783 UI/GTK2/src/WorkerThreads.cpp:885
 msgid "Couldn't run query on search engine"
 msgstr "N'a pas pu lancer la recherche sur le moteur"
 
@@ -675,50 +695,51 @@
 msgid "No title"
 msgstr "Pas de titre"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1016
+#: UI/GTK2/src/WorkerThreads.cpp:1015
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N'a pas pu obtenir un brouteur pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1027
+#: UI/GTK2/src/WorkerThreads.cpp:1026
 msgid "Couldn't retrieve"
 msgstr "N'a pas pu telecharger"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1153
+#: UI/GTK2/src/WorkerThreads.cpp:1152
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer ce type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1157
+#: UI/GTK2/src/WorkerThreads.cpp:1156
 msgid "at"
 msgstr "a"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1179
+#: UI/GTK2/src/WorkerThreads.cpp:1178
 msgid "Couldn't tokenize"
 msgstr "N'a pas pu extraire les termes de"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1199
+#: UI/GTK2/src/WorkerThreads.cpp:1198
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots interdit d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1234
+#: UI/GTK2/src/WorkerThreads.cpp:1233
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1315
+#. Be pessimistic and assume something will go wrong ;-)
+#: UI/GTK2/src/WorkerThreads.cpp:1314
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1440
+#: UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1616
+#: UI/GTK2/src/WorkerThreads.cpp:1615
 msgid "No monitoring handler"
 msgstr "Pas de moniteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1658
+#: UI/GTK2/src/WorkerThreads.cpp:1657
 msgid "Couldn't initialize file monitor"
 msgstr "N'a pas pu initializer le moniteur de fichiers"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1940
+#: UI/GTK2/src/WorkerThreads.cpp:1939
 msgid "Couldn't open directory"
 msgstr "N'a pas pu ouvrir le repertoire"



From fabricecolin at mail.berlios.de  Tue Nov 14 16:16:48 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 14 Nov 2006 16:16:48 +0100
Subject: [Pinot-svn] r578 - trunk/Search
Message-ID: <200611141516.kAEFGmCs030134@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-14 16:16:47 +0100 (Tue, 14 Nov 2006)
New Revision: 578

Modified:
   trunk/Search/QueryProperties.cpp
   trunk/Search/WebEngine.cpp
   trunk/Search/XapianEngine.cpp
   trunk/Search/XapianEngine.h
Log:
XapianEngine::validateQuery() is now useful :-) WebEngine is less verbose.


Modified: trunk/Search/QueryProperties.cpp
===================================================================
--- trunk/Search/QueryProperties.cpp	2006-11-14 14:00:30 UTC (rev 577)
+++ trunk/Search/QueryProperties.cpp	2006-11-14 15:16:47 UTC (rev 578)
@@ -107,10 +107,10 @@
 		return;
 	}
 
-	set<string> terms;
+	vector<string> terms;
 	if (XapianEngine::validateQuery(*this, true, terms) == true)
 	{
-		for (set<string>::const_iterator termIter = terms.begin();
+		for (vector<string>::const_iterator termIter = terms.begin();
 			termIter != terms.end(); ++termIter)
 		{
 			string term(*termIter);
@@ -120,7 +120,7 @@
 				continue;
 			}
 
-			// is this a prefixed term ?
+			// Is this a prefixed term ?
 			// The query shouldn't have the same filter twice
 			if (isupper((int)((*termIter)[0])) == 0)
 			{

Modified: trunk/Search/WebEngine.cpp
===================================================================
--- trunk/Search/WebEngine.cpp	2006-11-14 14:00:30 UTC (rev 577)
+++ trunk/Search/WebEngine.cpp	2006-11-14 15:16:47 UTC (rev 578)
@@ -212,9 +212,6 @@
 	{
 		return true;
 	}
-#ifdef DEBUG
-	cout << "WebEngine::processResult: " << extract << endl;
-#endif
 
 	Document doc;
 	doc.setData(extract.c_str(), extract.length());
@@ -245,9 +242,6 @@
 		extract += " ";
 
 		g_free(pEscToken);
-#ifdef DEBUG
-		cout << "WebEngine::processResult: " << extract << endl;
-#endif
 
 		result.setExtract(extract);
 	}

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2006-11-14 14:00:30 UTC (rev 577)
+++ trunk/Search/XapianEngine.cpp	2006-11-14 15:16:47 UTC (rev 578)
@@ -111,7 +111,7 @@
 
 /// Validates a query and extracts its terms.
 bool XapianEngine::validateQuery(QueryProperties& queryProps, bool includePrefixed,
-	set<string> &terms)
+	vector<string> &terms)
 {
 	bool goodQuery = false;
 
@@ -127,7 +127,7 @@
 				if ((includePrefixed == true) ||
 					(isupper((int)((*termIter)[0])) == 0))
 				{
-					terms.insert(*termIter);
+					terms.push_back(*termIter);
 				}
 			}
 

Modified: trunk/Search/XapianEngine.h
===================================================================
--- trunk/Search/XapianEngine.h	2006-11-14 14:00:30 UTC (rev 577)
+++ trunk/Search/XapianEngine.h	2006-11-14 15:16:47 UTC (rev 578)
@@ -36,7 +36,7 @@
 
 		/// Validates a query and extracts its terms.
 		static bool validateQuery(QueryProperties& queryProps, bool includePrefixed,
-			std::set<std::string> &terms);
+			std::vector<std::string> &terms);
 
 		/// Sets whether the query should be expanded.
 		bool setQueryExpansion(std::set<unsigned int> &relevantDocuments);



From fabricecolin at mail.berlios.de  Fri Nov 17 12:01:45 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 17 Nov 2006 12:01:45 +0100
Subject: [Pinot-svn] r579 - in trunk: . UI/GTK2/src
Message-ID: <200611171101.kAHB1j9V025642@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-17 12:01:45 +0100 (Fri, 17 Nov 2006)
New Revision: 579

Modified:
   trunk/UI/GTK2/src/Makefile.am
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
   trunk/UI/GTK2/src/pinot.cc
   trunk/configure.in
Log:
The DBus connection can be closed if dbus < 0.70 (eg Fedora Core 5).
Unreferencing is not sufficient, it will raise a SIGBART signal.
Daemon catches exceptions, UI catches const char*.


Modified: trunk/UI/GTK2/src/Makefile.am
===================================================================
--- trunk/UI/GTK2/src/Makefile.am	2006-11-14 15:16:47 UTC (rev 578)
+++ trunk/UI/GTK2/src/Makefile.am	2006-11-17 11:01:45 UTC (rev 579)
@@ -64,6 +64,7 @@
 AM_CXXFLAGS = -I$(top_srcdir)/Utils -I$(top_srcdir)/Tokenize -I$(top_srcdir)/SQL \
 	-I$(top_srcdir)/Monitor -I$(top_srcdir)/Collect -I$(top_srcdir)/Index \
 	-I$(top_srcdir)/Search -I$(top_srcdir)/Search/Google \
+	-DDBUS_GLIB_VERSION=@DBUS_GLIB_VERSION@ \
 	@SQL_CFLAGS@ @HTTP_CFLAGS@ @MIME_CFLAGS@ @XML_CFLAGS@ @SOAP_CFLAGS@ @DBUS_CFLAGS@ @INDEX_CFLAGS@ @UI_CFLAGS@
 
 pinot_LDADD = -L$(top_srcdir)/Utils -L$(top_srcdir)/Tokenize -L$(top_srcdir)/SQL -L$(top_srcdir)/Monitor \

Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-14 15:16:47 UTC (rev 578)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-17 11:01:45 UTC (rev 579)
@@ -780,16 +780,35 @@
 
 		dbus_connection_add_filter(pConnection, (DBusHandleMessageFunction)filterHandler, &server, NULL);
 
-		// Get the main loop
-		g_refMainLoop = Glib::MainLoop::create();
+		try
+		{
+			// Get the main loop
+			g_refMainLoop = Glib::MainLoop::create();
 
-		// Connect to threads' finished signal
-		server.connect();
+			// Connect to threads' finished signal
+			server.connect();
 
-		server.start();
+			server.start();
 
-		// Run the main loop
-		g_refMainLoop->run();
+			// Run the main loop
+			g_refMainLoop->run();
+
+		}
+		catch (const Glib::Exception &e)
+		{
+			cerr << e.what() << endl;
+			return EXIT_FAILURE;
+		}
+		catch (const char *pMsg)
+		{
+			cerr << pMsg << endl;
+			return EXIT_FAILURE;
+		}
+		catch (...)
+		{
+			cerr << "Unknown exception" << endl;
+			return EXIT_FAILURE;
+		}
 	}
 	else
 	{
@@ -800,7 +819,19 @@
 #ifdef DEBUG
 	cout << "Closing connection..." << endl;
 #endif
-	dbus_connection_unref(pConnection);
+	// FIXME: use our friend the preprocessor
+	if (DBUS_GLIB_VERSION < 0.7)
+	{
+		// Don't unref the connection to avoid "assertion failed "!_dbus_transport_get_is_connected
+		// (connection->transport)" file "dbus-connection.c" line 1797 function _dbus_connection_last_unref"
+		dbus_connection_close(pConnection);
+	}
+	else
+	{
+		// Don't close the connection to avoid ""Applications can not close shared connections.
+		// Please fix this in your app. Ignoring close request and continuing."
+		dbus_connection_unref(pConnection);
+	}
 	dbus_g_connection_unref(pBus);
 
 	return EXIT_SUCCESS;

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2006-11-14 15:16:47 UTC (rev 578)
+++ trunk/UI/GTK2/src/pinot.cc	2006-11-17 11:01:45 UTC (rev 579)
@@ -250,6 +250,11 @@
 		cerr << e.what() << endl;
 		return EXIT_FAILURE;
 	}
+	catch (const char *pMsg)
+	{
+		cerr << pMsg << endl;
+		return EXIT_FAILURE;
+	}
 	catch (...)
 	{
 		cerr << "Unknown exception" << endl;

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2006-11-14 15:16:47 UTC (rev 578)
+++ trunk/configure.in	2006-11-17 11:01:45 UTC (rev 579)
@@ -194,6 +194,8 @@
 PKG_CHECK_MODULES(DBUS, dbus-glib-1)
 AC_SUBST(DBUS_CFLAGS)
 AC_SUBST(DBUS_LIBS)
+DBUS_GLIB_VERSION=`pkg-config --modversion dbus-glib-1`
+AC_SUBST(DBUS_GLIB_VERSION)
 PKG_CHECK_MODULES(SIGCPP, sigc++-2.0 >= 2.0 )
 AC_SUBST(SIGCPP_CFLAGS)
 AC_SUBST(SIGCPP_LIBS)



From fabricecolin at mail.berlios.de  Fri Nov 17 12:04:31 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 17 Nov 2006 12:04:31 +0100
Subject: [Pinot-svn] r580 - trunk/Collect
Message-ID: <200611171104.kAHB4VSt025747@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-17 12:04:31 +0100 (Fri, 17 Nov 2006)
New Revision: 580

Modified:
   trunk/Collect/CurlDownloader.cpp
Log:
Watch out for NULL characters in the data received. This happens sometimes with
Yahoo! queries that return non-Latin results.


Modified: trunk/Collect/CurlDownloader.cpp
===================================================================
--- trunk/Collect/CurlDownloader.cpp	2006-11-17 11:01:45 UTC (rev 579)
+++ trunk/Collect/CurlDownloader.cpp	2006-11-17 11:04:31 UTC (rev 580)
@@ -17,6 +17,7 @@
  */
 
 #include <cstdio>
+#include <string.h>
 #include <strings.h>
 #include <stdarg.h>
 #include <iostream>
@@ -68,6 +69,17 @@
 	pInfo->m_contentLen += totalSize;
 	pInfo->m_pContent[pInfo->m_contentLen] = '\0';
 
+	if (totalSize < strlen((const char*)pData))
+	{
+		void *pBadChar = NULL;
+
+		// There's a NULL character in the buffer ? Replace it
+		while ((pBadChar = memchr((void*)pInfo->m_pContent, '\0', pInfo->m_contentLen)) != NULL)
+		{
+			((char*)pBadChar)[0] = ' ';
+		}
+	}
+
 	return totalSize;
 }
 



From fabricecolin at mail.berlios.de  Fri Nov 17 12:05:41 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 17 Nov 2006 12:05:41 +0100
Subject: [Pinot-svn] r581 - trunk/Search/Plugins
Message-ID: <200611171105.kAHB5fjp025877@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-17 12:05:41 +0100 (Fri, 17 Nov 2006)
New Revision: 581

Modified:
   trunk/Search/Plugins/Yahoo.src
Log:
Removed superfluous parameters.


Modified: trunk/Search/Plugins/Yahoo.src
===================================================================
--- trunk/Search/Plugins/Yahoo.src	2006-11-17 11:04:31 UTC (rev 580)
+++ trunk/Search/Plugins/Yahoo.src	2006-11-17 11:05:41 UTC (rev 581)
@@ -9,16 +9,8 @@
 	routeType="The Web"
 >
 
-<INPUT NAME="x" VALUE="op">
-<INPUT NAME="va" USER>
-<INPUT NAME="ve_vt" VALUE="any">
-<INPUT NAME="vst" VALUE="0">
-<INPUT NAME="vd" VALUE="all">
-<INPUT NAME="fl" VALUE="0">
-<INPUT NAME="vf" VALUE="all">
-<INPUT NAME="ei" VALUE="ISO-8859-1">
-<INPUT NAME="vm" VALUE="p">
-<INPUT NAME="n" VALUE="10">
+<INPUT NAME="p" USER>
+<INPUT NAME="ei" VALUE="UTF-8">
 <INPUTNEXT NAME="b" FACTOR="10" VALUE="1">
 
 <INTERPRET



From fabricecolin at mail.berlios.de  Fri Nov 17 12:07:54 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 17 Nov 2006 12:07:54 +0100
Subject: [Pinot-svn] r582 - trunk/Tokenize
Message-ID: <200611171107.kAHB7suL026040@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-17 12:07:53 +0100 (Fri, 17 Nov 2006)
New Revision: 582

Modified:
   trunk/Tokenize/HtmlTokenizer.cpp
   trunk/Tokenize/HtmlTokenizer.h
   trunk/Tokenize/OpenDocumentTokenizer.cpp
   trunk/Tokenize/PdfTokenizer.cpp
   trunk/Tokenize/PdfTokenizer.h
   trunk/Tokenize/RtfTokenizer.cpp
   trunk/Tokenize/TagLibTokenizer.cpp
   trunk/Tokenize/TagLibTokenizer.h
   trunk/Tokenize/Tokenizer.cpp
   trunk/Tokenize/UnknownTypeTokenizer.cpp
   trunk/Tokenize/UnknownTypeTokenizer.h
   trunk/Tokenize/XmlTokenizer.cpp
   trunk/Tokenize/XmlTokenizer.h
Log:
Fixed pretty bad memory leak. Temporary Document objects were not freed most
of the time.


Modified: trunk/Tokenize/HtmlTokenizer.cpp
===================================================================
--- trunk/Tokenize/HtmlTokenizer.cpp	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/HtmlTokenizer.cpp	2006-11-17 11:07:53 UTC (rev 582)
@@ -491,7 +491,8 @@
 
 HtmlTokenizer::HtmlTokenizer(const Document *pDocument,
 	bool validateOnly, bool findAbstract) :
-	Tokenizer(NULL)
+	Tokenizer(NULL),
+	m_pStrippedDocument(NULL)
 {
 	if (validateOnly == true)
 	{
@@ -513,21 +514,20 @@
 		}
 
 		// Pass the result to the parent class
-		Document *pStrippedDoc = new Document(m_state.m_title,
+		m_pStrippedDocument = new Document(m_state.m_title,
 			pDocument->getLocation(), pDocument->getType(),
 			pDocument->getLanguage());
-		pStrippedDoc->setData(m_state.m_text.c_str(), m_state.m_text.length());
+		m_pStrippedDocument->setData(m_state.m_text.c_str(), m_state.m_text.length());
 
-		setDocument(pStrippedDoc);
+		setDocument(m_pStrippedDocument);
 	}
 }
 
 HtmlTokenizer::~HtmlTokenizer()
 {
-	if (m_pDocument != NULL)
+	if (m_pStrippedDocument != NULL)
 	{
-		// This should have been set by setDocument()
-		delete m_pDocument;
+		delete m_pStrippedDocument;
 	}
 }
 

Modified: trunk/Tokenize/HtmlTokenizer.h
===================================================================
--- trunk/Tokenize/HtmlTokenizer.h	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/HtmlTokenizer.h	2006-11-17 11:07:53 UTC (rev 582)
@@ -98,8 +98,7 @@
 
 	protected:
 		ParserState m_state;
-		bool m_isFragment;
-		std::string m_charset;
+		Document *m_pStrippedDocument;
 
 		bool parseHTML(const Document *pDocument);
 

Modified: trunk/Tokenize/OpenDocumentTokenizer.cpp
===================================================================
--- trunk/Tokenize/OpenDocumentTokenizer.cpp	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/OpenDocumentTokenizer.cpp	2006-11-17 11:07:53 UTC (rev 582)
@@ -63,11 +63,34 @@
 }
 
 OpenDocumentTokenizer::OpenDocumentTokenizer(const Document *pDocument) :
-	XmlTokenizer(runHelperProgram(pDocument, "unzip -p", "content.xml"))
+	XmlTokenizer(NULL)
 {
+	Document *pXmlDocument = runHelperProgram(pDocument, "unzip -p", "content.xml");
+	if (pXmlDocument != NULL)
+	{
+		unsigned int length = 0;
+		const char *data = pXmlDocument->getData(length);
+
+		if ((data != NULL) &&
+			(length > 0))
+		{
+			// Remove XML tags
+			string strippedData = parseXML(data);
+
+			// Pass the result to the parent class
+			m_pStrippedDocument = new Document(pDocument->getTitle(),
+				pDocument->getLocation(), pDocument->getType(),
+				pDocument->getLanguage());
+			m_pStrippedDocument->setData(strippedData.c_str(), strippedData.length());
+			setDocument(m_pStrippedDocument);
+		}
+
+		delete pXmlDocument;
+	}
 	// FIXME: unzip meta.xml and extract document information
 }
 
 OpenDocumentTokenizer::~OpenDocumentTokenizer()
 {
+	// ~XmlTokenizer will delete m_pStrippedDocument
 }

Modified: trunk/Tokenize/PdfTokenizer.cpp
===================================================================
--- trunk/Tokenize/PdfTokenizer.cpp	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/PdfTokenizer.cpp	2006-11-17 11:07:53 UTC (rev 582)
@@ -40,16 +40,21 @@
 }
 
 PdfTokenizer::PdfTokenizer(const Document *pDocument) :
-	Tokenizer(NULL)
+	Tokenizer(NULL),
+	m_pStrippedDocument(NULL)
 {
-	Document *pTextDocument = runHelperProgram(pDocument, "pdftotext", "-");
-	if (pTextDocument != NULL)
+	m_pStrippedDocument = runHelperProgram(pDocument, "pdftotext", "-");
+	if (m_pStrippedDocument != NULL)
 	{
 		// Pass the result to the parent class
-		setDocument(pTextDocument);
+		setDocument(m_pStrippedDocument);
 	}
 }
 
 PdfTokenizer::~PdfTokenizer()
 {
+	if (m_pStrippedDocument != NULL)
+	{
+		delete m_pStrippedDocument;
+	}
 }

Modified: trunk/Tokenize/PdfTokenizer.h
===================================================================
--- trunk/Tokenize/PdfTokenizer.h	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/PdfTokenizer.h	2006-11-17 11:07:53 UTC (rev 582)
@@ -36,6 +36,9 @@
 		PdfTokenizer(const Document *pDocument);
 		virtual ~PdfTokenizer();
 
+	protected:
+		Document *m_pStrippedDocument;
+
 	private:
 		PdfTokenizer(const PdfTokenizer &other);
 		PdfTokenizer& operator=(const PdfTokenizer& other);

Modified: trunk/Tokenize/RtfTokenizer.cpp
===================================================================
--- trunk/Tokenize/RtfTokenizer.cpp	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/RtfTokenizer.cpp	2006-11-17 11:07:53 UTC (rev 582)
@@ -49,12 +49,12 @@
 		if (parseHTML(pHtmlDocument) == true)
 		{
 			// Pass the result to the parent class
-			Document *pStrippedDoc = new Document(pHtmlDocument->getTitle(),
+			m_pStrippedDocument = new Document(pHtmlDocument->getTitle(),
 				pHtmlDocument->getLocation(), pHtmlDocument->getType(),
 				pHtmlDocument->getLanguage());
-			pStrippedDoc->setData(m_state.m_text.c_str(), m_state.m_text.length());
+			m_pStrippedDocument->setData(m_state.m_text.c_str(), m_state.m_text.length());
 
-			setDocument(pStrippedDoc);
+			setDocument(m_pStrippedDocument);
 		}
 
 		delete pHtmlDocument;
@@ -63,4 +63,5 @@
 
 RtfTokenizer::~RtfTokenizer()
 {
+	// ~HtmlTokenizer will delete m_pStrippedDocument
 }

Modified: trunk/Tokenize/TagLibTokenizer.cpp
===================================================================
--- trunk/Tokenize/TagLibTokenizer.cpp	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/TagLibTokenizer.cpp	2006-11-17 11:07:53 UTC (rev 582)
@@ -49,7 +49,8 @@
 }
 
 TagLibTokenizer::TagLibTokenizer(const Document *pDocument) :
-	Tokenizer(NULL)
+	Tokenizer(NULL),
+	m_pTagDocument(NULL)
 {
 	if (pDocument != NULL)
 	{
@@ -95,21 +96,20 @@
 				trackTitle = pseudoContent = pDocument->getTitle();
 			}
 
-			pPseudoDocument = new Document(trackTitle, pDocument->getLocation(),
+			m_pTagDocument = new Document(trackTitle, pDocument->getLocation(),
 				pDocument->getType(), pDocument->getLanguage());
-			pPseudoDocument->setData(pseudoContent.c_str(), pseudoContent.length());
+			m_pTagDocument->setData(pseudoContent.c_str(), pseudoContent.length());
 
 			// Give the result to the parent class
-			setDocument(pPseudoDocument);
+			setDocument(m_pTagDocument);
 		}
 	}
 }
 
 TagLibTokenizer::~TagLibTokenizer()
 {
-	if (m_pDocument != NULL)
+	if (m_pTagDocument != NULL)
 	{
-		// This should have been set by setDocument()
-		delete m_pDocument;
+		delete m_pTagDocument;
 	}
 }

Modified: trunk/Tokenize/TagLibTokenizer.h
===================================================================
--- trunk/Tokenize/TagLibTokenizer.h	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/TagLibTokenizer.h	2006-11-17 11:07:53 UTC (rev 582)
@@ -36,6 +36,9 @@
 		TagLibTokenizer(const Document *pDocument);
 		virtual ~TagLibTokenizer();
 
+	protected:
+		Document *m_pTagDocument;
+
 	private:
 		TagLibTokenizer(const TagLibTokenizer &other);
 		TagLibTokenizer& operator=(const TagLibTokenizer& other);

Modified: trunk/Tokenize/Tokenizer.cpp
===================================================================
--- trunk/Tokenize/Tokenizer.cpp	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/Tokenizer.cpp	2006-11-17 11:07:53 UTC (rev 582)
@@ -41,6 +41,7 @@
 
 Tokenizer::~Tokenizer()
 {
+	// The document is owned by the caller
 }
 
 Document *Tokenizer::runHelperProgram(const Document *pDocument,

Modified: trunk/Tokenize/UnknownTypeTokenizer.cpp
===================================================================
--- trunk/Tokenize/UnknownTypeTokenizer.cpp	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/UnknownTypeTokenizer.cpp	2006-11-17 11:07:53 UTC (rev 582)
@@ -23,24 +23,22 @@
 using namespace std;
 
 UnknownTypeTokenizer::UnknownTypeTokenizer(const Document *pDocument) :
-	Tokenizer(NULL)
+	Tokenizer(NULL),
+	m_pStrippedDocument(NULL)
 {
-	string cmdLine("strings --bytes=6");
-
 	// Run strings
-	Document *pOutputDocument = runHelperProgram(pDocument, cmdLine);
-	if (pOutputDocument != NULL)
+	m_pStrippedDocument = runHelperProgram(pDocument, "strings --bytes=6");
+	if (m_pStrippedDocument != NULL)
 	{
 		// Give the result to the parent class
-		setDocument(pOutputDocument);
+		setDocument(m_pStrippedDocument);
 	}
 }
 
 UnknownTypeTokenizer::~UnknownTypeTokenizer()
 {
-	if (m_pDocument != NULL)
+	if (m_pStrippedDocument != NULL)
 	{
-		// This should have been set by setDocument(),
-		delete m_pDocument;
+		delete m_pStrippedDocument;
 	}
 }

Modified: trunk/Tokenize/UnknownTypeTokenizer.h
===================================================================
--- trunk/Tokenize/UnknownTypeTokenizer.h	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/UnknownTypeTokenizer.h	2006-11-17 11:07:53 UTC (rev 582)
@@ -19,6 +19,7 @@
 #ifndef _UNKNOWN_TYPE_TOKENIZER_H
 #define _UNKNOWN_TYPE_TOKENIZER_H
 
+#include "Document.h"
 #include "Tokenizer.h"
 
 class UnknownTypeTokenizer : public Tokenizer
@@ -27,6 +28,9 @@
 		UnknownTypeTokenizer(const Document *pDocument);
 		virtual ~UnknownTypeTokenizer();
 
+	protected:
+		Document *m_pStrippedDocument;
+
 	private:
 		UnknownTypeTokenizer(const UnknownTypeTokenizer &other);
 		UnknownTypeTokenizer& operator=(const UnknownTypeTokenizer& other);

Modified: trunk/Tokenize/XmlTokenizer.cpp
===================================================================
--- trunk/Tokenize/XmlTokenizer.cpp	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/XmlTokenizer.cpp	2006-11-17 11:07:53 UTC (rev 582)
@@ -29,7 +29,8 @@
 using std::string;
 
 XmlTokenizer::XmlTokenizer(const Document *pDocument) :
-	Tokenizer(NULL)
+	Tokenizer(NULL),
+	m_pStrippedDocument(NULL)
 {
 	if (pDocument != NULL)
 	{
@@ -43,22 +44,20 @@
 			string strippedData = parseXML(data);
 
 			// Pass the result to the parent class
-			Document *pStrippedDoc = new Document(pDocument->getTitle(),
+			m_pStrippedDocument = new Document(pDocument->getTitle(),
 				pDocument->getLocation(), pDocument->getType(),
 				pDocument->getLanguage());
-			pStrippedDoc->setData(strippedData.c_str(), strippedData.length());
-			setDocument(pStrippedDoc);
+			m_pStrippedDocument->setData(strippedData.c_str(), strippedData.length());
+			setDocument(m_pStrippedDocument);
 		}
 	}
 }
 
 XmlTokenizer::~XmlTokenizer()
 {
-	if (m_pDocument != NULL)
+	if (m_pStrippedDocument != NULL)
 	{
-		// This should have been set by setDocument(),
-		// called in initialize()
-		delete m_pDocument;
+		delete m_pStrippedDocument;
 	}
 }
 

Modified: trunk/Tokenize/XmlTokenizer.h
===================================================================
--- trunk/Tokenize/XmlTokenizer.h	2006-11-17 11:05:41 UTC (rev 581)
+++ trunk/Tokenize/XmlTokenizer.h	2006-11-17 11:07:53 UTC (rev 582)
@@ -34,7 +34,7 @@
 		static std::string stripTags(const std::string &str);
 
 	protected:
-		void initialize(const Document *pDocument);
+		Document *m_pStrippedDocument;
 
 		/// Parses XML; the string without tags.
 		static std::string parseXML(const std::string &str);



From fabricecolin at mail.berlios.de  Fri Nov 17 12:09:17 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 17 Nov 2006 12:09:17 +0100
Subject: [Pinot-svn] r583 - trunk/UI/GTK2/src
Message-ID: <200611171109.kAHB9HQ2026121@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-17 12:09:16 +0100 (Fri, 17 Nov 2006)
New Revision: 583

Modified:
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Added msf and sh to default filter list.
Treat documents on https as text/html if no handler application is found.


Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2006-11-17 11:07:53 UTC (rev 582)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2006-11-17 11:09:16 UTC (rev 583)
@@ -254,9 +254,11 @@
 		m_filePatternsBlackList.insert("*.png");
 		m_filePatternsBlackList.insert("*.lha");
 		m_filePatternsBlackList.insert("*.mov");
+		m_filePatternsBlackList.insert("*.msf");
 		m_filePatternsBlackList.insert("*.mpeg");
 		m_filePatternsBlackList.insert("*.mpg");
 		m_filePatternsBlackList.insert("*.rpm");
+		m_filePatternsBlackList.insert("*.sh");
 		m_filePatternsBlackList.insert("*.tar");
 		m_filePatternsBlackList.insert("*.wmv");
 		m_filePatternsBlackList.insert("*.zip");

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-11-17 11:07:53 UTC (rev 582)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-11-17 11:09:16 UTC (rev 583)
@@ -3032,7 +3032,8 @@
 				Url urlObj(url);
 				bool foundAction = false;
 
-				if (urlObj.getProtocol() == "http")
+				if ((urlObj.getProtocol() == "http") ||
+					(urlObj.getProtocol() == "https"))
 				{
 					// Chances are the web browser will be able to open this
 					type = "text/html";



From fabricecolin at mail.berlios.de  Sat Nov 18 07:17:24 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 18 Nov 2006 07:17:24 +0100
Subject: [Pinot-svn] r584 - trunk
Message-ID: <200611180617.kAI6HO82011412@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-18 07:17:18 +0100 (Sat, 18 Nov 2006)
New Revision: 584

Modified:
   trunk/AUTHORS
   trunk/TODO
Log:
Mention Nicolas Velin's contribution to the French po.
Removed from TODO a couple of items.


Modified: trunk/AUTHORS
===================================================================
--- trunk/AUTHORS	2006-11-17 11:09:16 UTC (rev 583)
+++ trunk/AUTHORS	2006-11-18 06:17:18 UTC (rev 584)
@@ -21,4 +21,4 @@
 Translations provided by :
 
 	Spanish - Jes?s Tramullas <jesus at tramullas dot com>
-
+	French (Rosetta) - Nicolas Velin <nsv at fr dot st>

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2006-11-17 11:09:16 UTC (rev 583)
+++ trunk/TODO	2006-11-18 06:17:18 UTC (rev 584)
@@ -34,8 +34,6 @@
 - Make sure Description files' SyndicationRight is not private or closed
 - Support for Google Buttons
 - Export search results as OpenSearch Response
-- Use pango_break() to tokenize abstracts
-- Use g_get_language_names() to get the locale's languages
 
 Index
 - Get hold of stopwords lists for the languages supported by Xapian's stemmers and don't index stop words
@@ -62,7 +60,6 @@
 - Keep track of attachments and avoid indexing the same file twice
 
 UI
-- Switching back and forth between grouping modes messes up results rankings : check scores
 - When sorting results by host name, give better score to results that appear several times
 - Show which threads are running, what they are doing, and allow to stop them selectively
 - Add an history window to edit Index and ViewHistory
@@ -78,7 +75,5 @@
   we are waiting for something to finish ?
 - Replace labels with tags (Leaftag, http://www.chipx86.com/wiki/Leaftag). Enable to import
   all the documents that match a specific tag
-- When switching back and forth between results tabs and another tab, why does the
-  result list get shifted right to the Title column ?
 - Make Pinot a unique app (http://guniqueapp.akl.lt/)
 



From fabricecolin at mail.berlios.de  Sat Nov 18 07:23:25 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 18 Nov 2006 07:23:25 +0100
Subject: [Pinot-svn] r585 - trunk/Utils
Message-ID: <200611180623.kAI6NPvq011783@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-18 07:23:24 +0100 (Sat, 18 Nov 2006)
New Revision: 585

Modified:
   trunk/Utils/TimeConverter.cpp
Log:
Initialize struct tm to keep valgrind happy.


Modified: trunk/Utils/TimeConverter.cpp
===================================================================
--- trunk/Utils/TimeConverter.cpp	2006-11-18 06:17:18 UTC (rev 584)
+++ trunk/Utils/TimeConverter.cpp	2006-11-18 06:23:24 UTC (rev 585)
@@ -140,6 +140,10 @@
 		return 0;
 	}
 
+	// Initialize the structure
+	timeTm.tm_sec = timeTm.tm_min = timeTm.tm_hour = timeTm.tm_mday = 0;
+	timeTm.tm_mon = timeTm.tm_year = timeTm.tm_wday = timeTm.tm_yday = timeTm.tm_isdst = 0;
+
 	// Find out if the date has an RFC-822/ISO 8601 time zone specification
 	// or a time zone name
 	// FIXME: it looks like strptime() can't diffentiate between %Z and %z



From fabricecolin at mail.berlios.de  Sat Nov 18 08:24:34 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 18 Nov 2006 08:24:34 +0100
Subject: [Pinot-svn] r586 - in trunk: . po
Message-ID: <200611180724.kAI7OYGW014608@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-18 08:24:34 +0100 (Sat, 18 Nov 2006)
New Revision: 586

Modified:
   trunk/NEWS
   trunk/configure.in
   trunk/po/es.po
   trunk/po/fr.po
Log:
Updating po and NEWS, releasing 0.63 today.


Modified: trunk/NEWS
===================================================================
--- trunk/NEWS	2006-11-18 06:23:24 UTC (rev 585)
+++ trunk/NEWS	2006-11-18 07:24:34 UTC (rev 586)
@@ -1,3 +1,16 @@
+2006/11/18 version_0_6_3
+Collect :
+ - watch out for NULL characters in data
+Tokenize :
+ - fixed memory leak. Temporary documents were not deleted most of the time.
+UI :
+ - prettified results list
+ - better abstract highlighting
+ - fixed clipboard copy of results list and abstract
+Daemon :
+ - autostart the daemon process
+ - with dbus < 0.70, close the connection
+
 2006/11/04 version_0_6_2
 General :
  - query shared-mime-info prefix, so that the applications database can be

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2006-11-18 06:23:24 UTC (rev 585)
+++ trunk/configure.in	2006-11-18 07:24:34 UTC (rev 586)
@@ -2,7 +2,7 @@
 # using glademm V2.6.0
 
 AC_PREREQ(2.50)
-AC_INIT(pinot, 0.62,[fabricecolin at users.berlios.de])
+AC_INIT(pinot, 0.63,[fabricecolin at users.berlios.de])
 AM_INIT_AUTOMAKE
 AC_CONFIG_HEADERS(config.h)
 

Modified: trunk/po/es.po
===================================================================
--- trunk/po/es.po	2006-11-18 06:23:24 UTC (rev 585)
+++ trunk/po/es.po	2006-11-18 07:24:34 UTC (rev 586)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.49\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-11-14 21:46+0800\n"
+"POT-Creation-Date: 2006-11-18 13:48+0800\n"
 "PO-Revision-Date: 2006-11-04 21:10+0800\n"
 "Last-Translator: Fabrice Colin <fabricecolin at users.berlios.de>\n"
 "Language-Team: es <fabricecolin at users.berlios.de>\n"
@@ -32,7 +32,7 @@
 #: UI/GTK2/src/mainWindow.cc:1150 UI/GTK2/src/mainWindow.cc:1192
 #: UI/GTK2/src/mainWindow.cc:1212 UI/GTK2/src/mainWindow.cc:1243
 #: UI/GTK2/src/mainWindow.cc:1832 UI/GTK2/src/PinotSettings.cpp:235
-#: UI/GTK2/src/PinotSettings.cpp:1222 UI/GTK2/src/PinotSettings.cpp:1278
+#: UI/GTK2/src/PinotSettings.cpp:1224 UI/GTK2/src/PinotSettings.cpp:1280
 msgid "My Web Pages"
 msgstr "Mis Paginas Web"
 
@@ -40,7 +40,7 @@
 #. Bind the callback's parameter to the index name
 #: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:312
 #: UI/GTK2/src/mainWindow.cc:315 UI/GTK2/src/PinotSettings.cpp:236
-#: UI/GTK2/src/PinotSettings.cpp:1223 UI/GTK2/src/PinotSettings.cpp:1279
+#: UI/GTK2/src/PinotSettings.cpp:1225 UI/GTK2/src/PinotSettings.cpp:1281
 msgid "My Documents"
 msgstr "Mis documentos"
 
@@ -331,7 +331,7 @@
 msgid "Running query"
 msgstr "Ejecutando la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:3058
+#: UI/GTK2/src/mainWindow.cc:3059
 msgid "No default application defined for type"
 msgstr "No hay aplicaci?n predefinida para el tipo"
 
@@ -502,7 +502,7 @@
 msgid "Personal"
 msgstr "Personal"
 
-#: UI/GTK2/src/PinotSettings.cpp:1047
+#: UI/GTK2/src/PinotSettings.cpp:1049
 msgid "Unclassified"
 msgstr "No clasificado"
 

Modified: trunk/po/fr.po
===================================================================
--- trunk/po/fr.po	2006-11-18 06:23:24 UTC (rev 585)
+++ trunk/po/fr.po	2006-11-18 07:24:34 UTC (rev 586)
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pinot 0.49\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2006-11-14 21:46+0800\n"
+"POT-Creation-Date: 2006-11-18 13:48+0800\n"
 "PO-Revision-Date: 2006-11-04 21:10+0800\n"
 "Last-Translator: Fabrice Colin <fabricecolin at users.berlios.de>\n"
 "Language-Team: fr <fabricecolin at users.berlios.de>\n"
@@ -32,7 +32,7 @@
 #: UI/GTK2/src/mainWindow.cc:1150 UI/GTK2/src/mainWindow.cc:1192
 #: UI/GTK2/src/mainWindow.cc:1212 UI/GTK2/src/mainWindow.cc:1243
 #: UI/GTK2/src/mainWindow.cc:1832 UI/GTK2/src/PinotSettings.cpp:235
-#: UI/GTK2/src/PinotSettings.cpp:1222 UI/GTK2/src/PinotSettings.cpp:1278
+#: UI/GTK2/src/PinotSettings.cpp:1224 UI/GTK2/src/PinotSettings.cpp:1280
 msgid "My Web Pages"
 msgstr "Mes Pages Web"
 
@@ -40,7 +40,7 @@
 #. Bind the callback's parameter to the index name
 #: UI/GTK2/src/EnginesTree.cpp:340 UI/GTK2/src/mainWindow.cc:312
 #: UI/GTK2/src/mainWindow.cc:315 UI/GTK2/src/PinotSettings.cpp:236
-#: UI/GTK2/src/PinotSettings.cpp:1223 UI/GTK2/src/PinotSettings.cpp:1279
+#: UI/GTK2/src/PinotSettings.cpp:1225 UI/GTK2/src/PinotSettings.cpp:1281
 msgid "My Documents"
 msgstr "Mes Documents"
 
@@ -331,7 +331,7 @@
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:3058
+#: UI/GTK2/src/mainWindow.cc:3059
 msgid "No default application defined for type"
 msgstr "Pas d'application definie pour le type"
 
@@ -502,7 +502,7 @@
 msgid "Personal"
 msgstr "Personnel"
 
-#: UI/GTK2/src/PinotSettings.cpp:1047
+#: UI/GTK2/src/PinotSettings.cpp:1049
 msgid "Unclassified"
 msgstr "Sans classification"
 



From fabricecolin at mail.berlios.de  Sat Nov 18 08:36:10 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 18 Nov 2006 08:36:10 +0100
Subject: [Pinot-svn] r587 - in trunk: Collect Index Search UI/GTK2/src
Message-ID: <200611180736.kAI7aAEq015235@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-18 08:36:10 +0100 (Sat, 18 Nov 2006)
New Revision: 587

Modified:
   trunk/Collect/pinot-collect.1
   trunk/Index/pinot-index.1
   trunk/Search/pinot-search.1
   trunk/UI/GTK2/src/pinot-dbus-daemon.1
   trunk/UI/GTK2/src/pinot.1
Log:
Updated version in man pages.


Modified: trunk/Collect/pinot-collect.1
===================================================================
--- trunk/Collect/pinot-collect.1	2006-11-18 07:24:34 UTC (rev 586)
+++ trunk/Collect/pinot-collect.1	2006-11-18 07:36:10 UTC (rev 587)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-COLLECT "1" "November 2006" "pinot-collect - pinot 0.62" "User Commands"
+.TH PINOT-COLLECT "1" "November 2006" "pinot-collect - pinot 0.63" "User Commands"
 .SH NAME
 pinot-collect \- Download an URL from the command-line
 .SH SYNOPSIS

Modified: trunk/Index/pinot-index.1
===================================================================
--- trunk/Index/pinot-index.1	2006-11-18 07:24:34 UTC (rev 586)
+++ trunk/Index/pinot-index.1	2006-11-18 07:36:10 UTC (rev 587)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-INDEX "1" "November 2006" "pinot-index - pinot 0.62" "User Commands"
+.TH PINOT-INDEX "1" "November 2006" "pinot-index - pinot 0.63" "User Commands"
 .SH NAME
 pinot-index \- Index documents from the command-line
 .SH SYNOPSIS

Modified: trunk/Search/pinot-search.1
===================================================================
--- trunk/Search/pinot-search.1	2006-11-18 07:24:34 UTC (rev 586)
+++ trunk/Search/pinot-search.1	2006-11-18 07:36:10 UTC (rev 587)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-SEARCH "1" "November 2006" "pinot-search - pinot 0.62" "User Commands"
+.TH PINOT-SEARCH "1" "November 2006" "pinot-search - pinot 0.63" "User Commands"
 .SH NAME
 pinot-search \- Query search engines from the command-line
 .SH SYNOPSIS

Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.1
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.1	2006-11-18 07:24:34 UTC (rev 586)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.1	2006-11-18 07:36:10 UTC (rev 587)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT-DBUS-DAEMON "1" "November 2006" "pinot-dbus-daemon - pinot 0.62" "User Commands"
+.TH PINOT-DBUS-DAEMON "1" "November 2006" "pinot-dbus-daemon - pinot 0.63" "User Commands"
 .SH NAME
 pinot-dbus-daemon \- D-Bus search and index daemon
 .SH SYNOPSIS

Modified: trunk/UI/GTK2/src/pinot.1
===================================================================
--- trunk/UI/GTK2/src/pinot.1	2006-11-18 07:24:34 UTC (rev 586)
+++ trunk/UI/GTK2/src/pinot.1	2006-11-18 07:36:10 UTC (rev 587)
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.36.
-.TH PINOT "1" "November 2006" "pinot - pinot 0.62" "User Commands"
+.TH PINOT "1" "November 2006" "pinot - pinot 0.63" "User Commands"
 .SH NAME
 pinot \- A metasearch tool for the Free Desktop
 .SH SYNOPSIS



From fabricecolin at mail.berlios.de  Sat Nov 18 08:41:48 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 18 Nov 2006 08:41:48 +0100
Subject: [Pinot-svn] r588 - tags
Message-ID: <200611180741.kAI7fmYQ015667@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-18 08:41:48 +0100 (Sat, 18 Nov 2006)
New Revision: 588

Added:
   tags/version_0_6_3/
Log:
Releasing 0.63 today.


Copied: tags/version_0_6_3 (from rev 587, trunk)



From fabricecolin at mail.berlios.de  Sun Nov 19 06:57:55 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 19 Nov 2006 06:57:55 +0100
Subject: [Pinot-svn] r589 - in trunk: . scripts scripts/bash scripts/python
Message-ID: <200611190557.kAJ5vtUo020985@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-19 06:57:54 +0100 (Sun, 19 Nov 2006)
New Revision: 589

Added:
   trunk/scripts/
   trunk/scripts/bash/
   trunk/scripts/bash/pinot-enum-index.sh
   trunk/scripts/python/
   trunk/scripts/python/pinot-live.py
Modified:
   trunk/Makefile.am
Log:
Moved pinot-live.py into scripts/python.
Bash script scripts/bash/pinot-enum-index.sh enumerates files in an index and
gives an estimate of the corresponding disk space. It needs delve, du and dc.


Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2006-11-18 07:41:48 UTC (rev 588)
+++ trunk/Makefile.am	2006-11-19 05:57:54 UTC (rev 589)
@@ -13,7 +13,7 @@
 	UI/GTK2/src/pinot-dbus-daemon.xml UI/GTK2/src/de.berlios.Pinot.service \
 	UI/GTK2/xapian-powered.png UI/GTK2/pinot.png \
 	UI/GTK2/metase-gtk2.glade UI/GTK2/metase-gtk2.gladep \
-	UI/pinot-live.py
+	scripts/python/pinot-live.py
 
 man_MANS = Collect/pinot-collect.1 Index/pinot-index.1 Search/pinot-search.1 \
 	UI/GTK2/src/pinot.1 UI/GTK2/src/pinot-dbus-daemon.1
@@ -42,7 +42,7 @@
 	$(mkinstalldirs) $(DESTDIR)${sysconfdir}/xdg/autostart
 	@desktop-file-install --vendor="" --dir=$(DESTDIR)${sysconfdir}/xdg/autostart pinot-dbus-daemon.desktop
 	$(mkinstalldirs) $(DESTDIR)$(libdir)/deskbar-applet/handlers/
-	$(INSTALL_DATA) UI/pinot-live.py $(DESTDIR)$(libdir)/deskbar-applet/handlers/
+	$(INSTALL_DATA) scripts/python/pinot-live.py $(DESTDIR)$(libdir)/deskbar-applet/handlers/
 
 ACLOCAL_AMFLAGS = -I m4
 

Added: trunk/scripts/bash/pinot-enum-index.sh
===================================================================
--- trunk/scripts/bash/pinot-enum-index.sh	2006-11-18 07:41:48 UTC (rev 588)
+++ trunk/scripts/bash/pinot-enum-index.sh	2006-11-19 05:57:54 UTC (rev 589)
@@ -0,0 +1,64 @@
+#!/bin/sh
+# A script that enumerates files in an index created by Pinot
+# and gives an estimate of how much disk space those take.
+
+if [ $# == 0 ]; then
+  echo "Usage: $0 <index>"
+  exit 1
+fi
+
+# Check programs we need are available
+WHICH_DELVE=`which delve`
+if [ $? != 0 ]; then
+  echo "Couldn't find delve. Is the xapian-core package installed ?"
+  exit 1
+fi
+WHICH_DU=`which du`
+if [ $? != 0 ]; then
+  echo "Couldn't find du. Is the coreutils package installed ?"
+  exit 1
+fi
+WHICH_DC=`which dc`
+if [ $? != 0 ]; then
+  echo "Couldn't find dc. Is the bc package installed ?"
+  exit 1
+fi
+
+if [ ! -d "$1" ]; then
+  echo "$1 is not a directory"
+  exit 1
+fi
+
+# Remove existing files
+rm -f "$1/urls.txt" "$1/filesizes.txt"
+
+# Get a list of documents
+DOCIDS=`delve -t X-MetaSE-Doc "$1"`
+if [ $? != 0 ]; then
+  echo "Couldn't query database at $1"
+fi
+
+echo "Listing documents in index"
+echo "0" >> "$1/filesizes.txt"
+for DOCID in `echo $DOCIDS | sed -e "s/[^0-9 ]//g"` ;
+do
+  FILENAME=`delve -d -r $DOCID "$1" | grep "url=file" | sed -e "s/url=\(.*\):\/\///g"`
+  if [ $? != 0 ] || [ -z "$FILENAME" ]; then
+    echo "Skipping document $DOCID, it doesn't look like a file"
+  else
+    FILESIZE=`du -b "$FILENAME" | sed -e "s/\([0-9]*\)\(.*\)/\1/g"`
+    if [ ! -z "$FILESIZE" ]; then
+      echo $FILENAME >> "$1/urls.txt"
+      echo $FILESIZE >> "$1/filesizes.txt"
+      echo "+" >> "$1/filesizes.txt"
+    fi
+  fi
+done
+echo "n" >> "$1/filesizes.txt"
+echo "List is in $1/urls.txt"
+
+echo "Summarizing disk usage for indexed documents"
+TOTALSIZE=`dc --file="$1/filesizes.txt"`
+echo "$TOTALSIZE bytes"
+
+exit 0


Property changes on: trunk/scripts/bash/pinot-enum-index.sh
___________________________________________________________________
Name: svn:executable
   + *

Copied: trunk/scripts/python/pinot-live.py (from rev 587, trunk/UI/pinot-live.py)



From fabricecolin at mail.berlios.de  Sun Nov 19 07:02:32 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 19 Nov 2006 07:02:32 +0100
Subject: [Pinot-svn] r590 - trunk/UI/GTK2/src
Message-ID: <200611190602.kAJ62W2R025222@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-19 07:02:31 +0100 (Sun, 19 Nov 2006)
New Revision: 590

Modified:
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
Log:
Set the daemon's scheduling priority to 15 (default) or any value passed with
"--priority". This already makes a big difference. Changing the I/O scheduling
class and priority may not be necessary ?


Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-19 05:57:54 UTC (rev 589)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-19 06:02:31 UTC (rev 590)
@@ -21,6 +21,8 @@
 #include <unistd.h>
 #include <libintl.h>
 #include <getopt.h>
+#include <sys/time.h>
+#include <sys/resource.h>
 #include <iostream>
 #include <fstream>
 #include <glibmm.h>
@@ -61,6 +63,7 @@
 static streambuf *g_cerrBuf = NULL;
 static struct option g_longOptions[] = {
 	{"help", 0, 0, 'h'},
+	{"priority", 1, 0, 'p'},
 	{"version", 0, 0, 'v'},
 	{0, 0, 0, 0}
 };
@@ -613,10 +616,10 @@
 {
 	string prefixDir(PREFIX);
 	struct sigaction newAction;
-	int longOptionIndex = 0;
+	int longOptionIndex = 0, priority = 15;
 
 	// Look at the options
-	int optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+	int optionChar = getopt_long(argc, argv, "hpv", g_longOptions, &longOptionIndex);
 	while (optionChar != -1)
 	{
 		switch (optionChar)
@@ -627,9 +630,21 @@
 					<< "Usage: pinot-dbus-daemon [OPTIONS]\n\n"
 					<< "Options:\n"
 					<< "  -h, --help		display this help and exit\n"
+					<< "  -p, --priority	set the daemon's priority (default 15)\n"
 					<< "  -v, --version		output version information and exit\n"
 					<< "\nReport bugs to " << PACKAGE_BUGREPORT << endl;
 				return EXIT_SUCCESS;
+			case 'p':
+				if (optarg != NULL)
+				{
+					int newPriority = atoi(optarg);
+					if ((newPriority >= -20) &&
+						(newPriority < 20))
+					{
+						priority = newPriority;
+					}
+				}
+				break;
 			case 'v':
 				cout << "pinot-dbus-daemon - " << PACKAGE_STRING << "\n\n" 
 					<< "This is free software.  You may redistribute copies of it under the terms of\n"
@@ -641,7 +656,7 @@
 		}
 
 		// Next option
-		optionChar = getopt_long(argc, argv, "hv", g_longOptions, &longOptionIndex);
+		optionChar = getopt_long(argc, argv, "hpv", g_longOptions, &longOptionIndex);
 	}
 
 #if defined(ENABLE_NLS)
@@ -739,6 +754,12 @@
 
 	atexit(closeAll);
 
+	// Change the daemon's priority
+	if (setpriority(PRIO_PROCESS, 0, priority) == -1)
+	{
+		cerr << "Couldn't set scheduling priority to " << priority << endl;
+	}
+
 	// Initialize the GType and the D-Bus thread system
 	g_type_init ();
 	dbus_g_thread_init();



From fabricecolin at mail.berlios.de  Sun Nov 19 07:03:24 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 19 Nov 2006 07:03:24 +0100
Subject: [Pinot-svn] r591 - trunk/UI
Message-ID: <200611190603.kAJ63OPi025555@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-19 07:03:24 +0100 (Sun, 19 Nov 2006)
New Revision: 591

Removed:
   trunk/UI/pinot-live.py
Log:
This was moved elsewhere.


Deleted: trunk/UI/pinot-live.py
===================================================================
--- trunk/UI/pinot-live.py	2006-11-19 06:02:31 UTC (rev 590)
+++ trunk/UI/pinot-live.py	2006-11-19 06:03:24 UTC (rev 591)
@@ -1,113 +0,0 @@
-import gnome
-
-import deskbar
-import deskbar.Handler, deskbar
-import gobject
-from gettext import gettext as _
-
-from os.path import expanduser
-HOME = expanduser ("~/")
-
-def _check_requirements ():
-	try:
-		import dbus
-		try :
-			if getattr(dbus, 'version', (0,0,0)) >= (0,41,0):
-				import dbus.glib
-		except:
-			return (deskbar.Handler.HANDLER_IS_NOT_APPLICABLE, "Python dbus.glib bindings not found.", None)
-		return (deskbar.Handler.HANDLER_IS_HAPPY, None, None)
-	except:
-		return (deskbar.Handler.HANDLER_IS_NOT_APPLICABLE, "Python dbus bindings not found.", None)
-	
-HANDLERS = {
-	"PinotFileSearchHandler" : {
-		"name": "Pinot",
-		"description": _("Search documents indexed by Pinot"),
-		"requirements" : _check_requirements,
-	}
-}
-
-class PinotFileMatch (deskbar.Match.Match):
-	def __init__(self, handler, name, url, mime_type, main_language, **args):
-		deskbar.Match.Match.__init__ (self, handler, **args)
-		# The mailbox scheme is specific to Pinot
-		self.url = url
-		url_scheme = self.url[:url.index("://")]
-		if url_scheme == "mailbox":
-			print "Mailbox hit: ", self.url
-			self.url = "file://" + url[len("mailbox://"):url.index('?')]
-			url_scheme = "file"
-
-		# Replace HOME with ~
-		file_path = self.url[self.url.index("://") + 3:]
-		if url_scheme == "file":
-			file_path = file_path.replace(HOME, "~/")
-			print "File hit: ", file_path
-
-		self.name = name + " (" + file_path + ")"
-		self.mime_type = mime_type
-		self.main_language = main_language
-		self._icon = deskbar.Utils.load_icon_for_file(self.url)
-
-	def get_verb(self):
-		return "%(name)s"
-
-	def action(self, text=None):
-		print "Opening Pinot hit: ", self.url
-		gnome.url_show (self.url)
-
-	def get_category (self):
-		return "files"
-
-class PinotFileSearchHandler(deskbar.Handler.SignallingHandler):
-	def __init__(self):
-		deskbar.Handler.SignallingHandler.__init__(self, ("system-search", "pinot"))
-
-		self.query_string = ""
-		self.results = []
-		self.results_count = 10
-
-		import dbus
-		# We have to do this or it won't work
-		if getattr(dbus, 'version', (0,0,0)) >= (0,41,0):
-			import dbus.glib
-		try:
-			# Set up the dbus connection
-			self.bus = dbus.SessionBus()
-			self.proxy_obj = self.bus.get_object('de.berlios.Pinot', '/de/berlios/Pinot')
-			self.pinot_iface = dbus.Interface(self.proxy_obj, 'de.berlios.Pinot')
-		except Exception, msg:
-			print 'Caught D-Bus exception: ', msg
-		self.set_delay (500)
-
-	def query (self, qstring, max):
-		print "SimpleQuery: ", qstring
-		doc_ids = []
-		try :
-			import dbus
-			doc_ids = self.pinot_iface.SimpleQuery (qstring, dbus.UInt32(max))
-		except Exception, msg:
-			print 'Caught D-Bus exception: ', msg
-		# Save the query's details
-		self.query_string = qstring
-		self.results = []
-		self.results_count = len(doc_ids)
-		try :
-			# Get the details of each hit
-			for doc_id in doc_ids:
-				print "Hit on document ", doc_id
-				self.pinot_iface.GetDocumentInfo (dbus.UInt32(doc_id),
-					reply_handler=self.__receive_hits, error_handler=self.__receive_error)
-		except Exception, msg:
-			print 'Caught exception: ', msg
-
-	def __receive_hits (self, name, url, mime_type, main_language):
-		self.results.append( PinotFileMatch(self, name, url, mime_type, main_language) )
-		print "Got hit ", len(self.results)
-		if len(self.results) == self.results_count:
-			self.emit_query_ready(self.query_string, self.results)
-
-	def __receive_error (self, error):
-		print 'D-Bus error: ', error
-



From fabricecolin at mail.berlios.de  Sun Nov 19 07:35:00 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 19 Nov 2006 07:35:00 +0100
Subject: [Pinot-svn] r592 - in trunk: SQL UI/GTK2/src
Message-ID: <200611190635.kAJ6Z0uk015088@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-19 07:35:00 +0100 (Sun, 19 Nov 2006)
New Revision: 592

Added:
   trunk/SQL/ActionQueue.cpp
   trunk/SQL/ActionQueue.h
Modified:
   trunk/SQL/Makefile.am
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
   trunk/UI/GTK2/src/pinot.cc
Log:
Replaced std::queue-based indexing queue with a database table appropriately
named ActionQueue. This seems to lower first-crawl memory usage a good deal.


Added: trunk/SQL/ActionQueue.cpp
===================================================================
--- trunk/SQL/ActionQueue.cpp	2006-11-19 06:03:24 UTC (rev 591)
+++ trunk/SQL/ActionQueue.cpp	2006-11-19 06:35:00 UTC (rev 592)
@@ -0,0 +1,265 @@
+/*
+ *  Copyright 2005,2006 Fabrice Colin
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <unistd.h>
+#include <iostream>
+
+#include "Url.h"
+#include "StringManip.h"
+#include "TimeConverter.h"
+#include "ActionQueue.h"
+
+using std::string;
+using std::cout;
+using std::endl;
+
+ActionQueue::ActionQueue(const string &database, const string queueId) :
+	SQLiteBase(database),
+	m_queueId(queueId)
+{
+}
+
+ActionQueue::~ActionQueue()
+{
+}
+
+string ActionQueue::typeToText(ActionType type)
+{
+	string text;
+
+	switch (type)
+	{
+		case INDEX:
+			text = "INDEX";
+			break;
+		case UNINDEX:
+			text = "UNINDEX";
+			break;
+		default:
+			break;
+	}
+
+	return text;
+}
+
+ActionQueue::ActionType ActionQueue::textToType(const string &text)
+{
+	ActionType type = INDEX;
+
+	if (text == "UNINDEX")
+	{
+		type = UNINDEX;
+	}
+
+	return type;
+}
+
+/// Creates the ActionQueue table in the database.
+bool ActionQueue::create(const string &database)
+{
+	bool success = true;
+
+	// The specified path must be a file
+	if (SQLiteBase::check(database) == false)
+	{
+		return false;
+	}
+
+	SQLiteBase db(database);
+
+	// Does ActionQueue exist ?
+	if (db.executeSimpleStatement("SELECT * FROM ActionQueue LIMIT 1;") == false)
+	{
+#ifdef DEBUG
+		cout << "ActionQueue::create: ActionQueue doesn't exist" << endl;
+#endif
+		// Create the table
+		if (db.executeSimpleStatement("CREATE TABLE ActionQueue (QueueId VARCHAR(255), \
+			Url VARCHAR(255), Type VARCHAR(255), Date INTEGER, Info TEXT, \
+			PRIMARY KEY(QueueId, Url));") == false)
+		{
+			success = false;
+		}
+	}
+
+	return success;
+}
+
+/// Pushes an item.
+bool ActionQueue::pushItem(ActionType type, const DocumentInfo &docInfo)
+{
+	string url(docInfo.getLocation());
+	string info("caption=");
+	bool update = false, success = false;
+
+	// Is there already an item for this URL ?
+	SQLiteResults *results = executeStatement("SELECT Url FROM ActionQueue \
+		WHERE QueueId='%q' AND Url='%q'",
+		m_queueId.c_str(), Url::escapeUrl(url).c_str());
+	if (results != NULL)
+	{
+		SQLiteRow *row = results->nextRow();
+		if (row != NULL)
+		{
+#ifdef DEBUG
+			cout << "ActionQueue::pushItem: item "
+				<< Url::unescapeUrl(row->getColumn(0)) << " exists" << endl;
+#endif
+			update = true;
+
+			delete row;
+		}
+
+		delete results;
+	}
+
+	// Serialize DocumentInfo
+	info += docInfo.getTitle();
+	info += "\n";
+	info += "url=";
+	info += url;
+	info += "\n";
+	info += "type=";
+	info += docInfo.getType();
+	info += "\n";
+	info += "language=";
+	info += docInfo.getLanguage();
+	info += "\n";
+	info += "modtime=";
+	info += docInfo.getTimestamp();
+	info += "\n";
+
+	if (update == false)
+	{
+		results = executeStatement("INSERT INTO ActionQueue \
+			VALUES('%q', '%q', '%q', '%d', '%q');",
+			m_queueId.c_str(), Url::escapeUrl(url).c_str(),
+			typeToText(type).c_str(), time(NULL), Url::escapeUrl(info).c_str());
+	}
+	else
+	{
+		results = executeStatement("UPDATE ActionQueue \
+			SET Type='%q', Date='%d', Info='%q' WHERE \
+			QueueId='%q' AND Url='%q';",
+			typeToText(type).c_str(), time(NULL), Url::escapeUrl(info).c_str(),
+			m_queueId.c_str(), Url::escapeUrl(url).c_str());
+	}
+	if (results != NULL)
+	{
+#ifdef DEBUG
+		cout << "ActionQueue::pushItem: queue " << m_queueId
+			<< ": " << type << " on " << url << ", " << update << endl;
+#endif
+		success = true;
+
+		delete results;
+	}
+
+	return success;
+}
+
+/// Pops and deletes the oldest item.
+bool ActionQueue::popItem(ActionType &type, DocumentInfo &docInfo)
+{
+	string url;
+	bool success = false;
+
+	if (getOldestItem(type, docInfo) == false)
+	{
+		return false;
+	}
+	url = docInfo.getLocation();
+#ifdef DEBUG
+	cout << "ActionQueue::popItem: queue " << m_queueId
+		<< ": " << type << " on " << url << endl;
+#endif
+
+	// Delete from ActionQueue
+	SQLiteResults *results = executeStatement("DELETE FROM ActionQueue \
+		WHERE QueueId='%q' AND Url='%q';",
+		m_queueId.c_str(), Url::escapeUrl(url).c_str());
+	if (results != NULL)
+	{
+		success = true;
+		delete results;
+	}
+
+	return success;
+}
+
+bool ActionQueue::getOldestItem(ActionType &type, DocumentInfo &docInfo) const
+{
+	bool success = false;
+
+	SQLiteResults *results = executeStatement("SELECT Url, Type, Info FROM ActionQueue \
+		WHERE QueueId='%q' ORDER BY Date DESC LIMIT 1",
+		m_queueId.c_str());
+	if (results != NULL)
+	{
+		SQLiteRow *row = results->nextRow();
+		if (row != NULL)
+		{
+			string url(Url::unescapeUrl(row->getColumn(0)));
+			type = textToType(row->getColumn(1));
+			string info(Url::unescapeUrl(row->getColumn(2)));
+			success = true;
+#ifdef DEBUG
+			cout << "ActionQueue::getOldestItem: " << info << endl;
+#endif
+
+			// Deserialize DocumentInfo
+			docInfo.setTitle(StringManip::extractField(info, "caption=", "\n"));
+			docInfo.setLocation(url);
+			docInfo.setType(StringManip::extractField(info, "type=", "\n"));
+			docInfo.setLanguage(StringManip::extractField(info, "language=", "\n"));
+			docInfo.setTimestamp(StringManip::extractField(info, "modtime=", "\n"));
+#ifdef DEBUG
+			cout << "ActionQueue::getOldestItem: " << docInfo.getTitle() << ", "
+				<< docInfo.getLocation() << ", "
+				<< docInfo.getType() << ", "
+				<< docInfo.getLanguage() << ", "
+				<< docInfo.getTimestamp() << endl;
+#endif
+
+			delete row;
+		}
+
+		delete results;
+	}
+
+	return success;
+}
+
+/// Expires items older than the given date.
+bool ActionQueue::expireItems(time_t expiryDate)
+{
+	bool success = false;
+
+	SQLiteResults *results = executeStatement("DELETE FROM ActionQueue \
+		WHERE QueueId='%q' AND Date<'%d';",
+		m_queueId.c_str(), expiryDate);
+	if (results != NULL)
+	{
+		success = true;
+		delete results;
+	}
+
+	return success;
+}

Added: trunk/SQL/ActionQueue.h
===================================================================
--- trunk/SQL/ActionQueue.h	2006-11-19 06:03:24 UTC (rev 591)
+++ trunk/SQL/ActionQueue.h	2006-11-19 06:35:00 UTC (rev 592)
@@ -0,0 +1,63 @@
+/*
+ *  Copyright 2005,2006 Fabrice Colin
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef _ACTION_QUEUE_H
+#define _ACTION_QUEUE_H
+
+#include <time.h>
+#include <string>
+
+#include "DocumentInfo.h"
+#include "SQLiteBase.h"
+
+class ActionQueue : public SQLiteBase
+{
+	public:
+		ActionQueue(const std::string &database, const std::string queueId);
+		virtual ~ActionQueue();
+
+		/// Creates the ActionQueue table in the database.
+		static bool create(const std::string &database);
+
+		typedef enum { INDEX = 0, UNINDEX } ActionType;
+
+		/// Pushes an item.
+		bool pushItem(ActionType type, const DocumentInfo &docInfo);
+
+		/// Pops and deletes the oldest item.
+		bool popItem(ActionType &type, DocumentInfo &docInfo);
+
+		/// Expires items older than the given date.
+		bool expireItems(time_t expiryDate);
+
+        protected:
+		std::string m_queueId;
+
+		bool getOldestItem(ActionType &type, DocumentInfo &docInfo) const;
+
+		static std::string typeToText(ActionType type);
+
+		static ActionType textToType(const std::string &text);
+
+        private:
+		ActionQueue(const ActionQueue &other);
+		ActionQueue &operator=(const ActionQueue &other);
+
+};
+
+#endif // _ACTION_QUEUE_H

Modified: trunk/SQL/Makefile.am
===================================================================
--- trunk/SQL/Makefile.am	2006-11-19 06:03:24 UTC (rev 591)
+++ trunk/SQL/Makefile.am	2006-11-19 06:35:00 UTC (rev 592)
@@ -1,6 +1,7 @@
 # Process this file with automake to produce Makefile.in
 
 noinst_HEADERS = \
+	ActionQueue.h \
 	CrawlHistory.h \
 	QueryHistory.h \
 	SQLiteBase.h \
@@ -9,6 +10,7 @@
 noinst_LTLIBRARIES = libSQL.la
 
 libSQL_la_SOURCES = \
+	ActionQueue.cpp \
 	CrawlHistory.cpp \
 	QueryHistory.cpp \
 	SQLiteBase.cpp \

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-19 06:03:24 UTC (rev 591)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-19 06:35:00 UTC (rev 592)
@@ -31,6 +31,7 @@
 #include <sigc++/class_slot.h>
 #include <sigc++/compatibility.h>
 #include <sigc++/slot.h>
+#include <glibmm/miscutils.h>
 
 #include "HtmlTokenizer.h"
 #include "XmlTokenizer.h"
@@ -40,6 +41,7 @@
 #include "TimeConverter.h"
 #include "Url.h"
 #include "XapianDatabase.h"
+#include "ActionQueue.h"
 #include "CrawlHistory.h"
 #include "QueryHistory.h"
 #include "IndexedDocument.h"
@@ -505,12 +507,9 @@
 
 	if (addToQueue == true)
 	{
-		if (write_lock_lists() == true)
-		{
-			m_indexQueue.push(docInfo);
+		ActionQueue queue(PinotSettings::getInstance().m_historyDatabase, get_application_name());
 
-			unlock_lists();
-		}
+		queue.pushItem(ActionQueue::INDEX, docInfo);
 
 		return "";
 	}
@@ -531,8 +530,6 @@
 		getItem = false;
 	}
 
-	DocumentInfo docInfo;
-
 	if (write_lock_lists() == true)
 	{
 		// Update the in-progress list
@@ -548,10 +545,16 @@
 		// Get an item ?
 		if (getItem == true)
 		{
-			while (m_indexQueue.empty() == false)
+			ActionQueue queue(PinotSettings::getInstance().m_historyDatabase, get_application_name());
+			ActionQueue::ActionType type;
+			DocumentInfo docInfo;
+
+			while (queue.popItem(type, docInfo) == true)
 			{
-				docInfo = m_indexQueue.front();
-				m_indexQueue.pop();
+				if (type != ActionQueue::INDEX)
+				{
+					continue;
+				}
 
 				ustring status = index_document(docInfo);
 				if (status.empty() == true)

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-11-19 06:03:24 UTC (rev 591)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-11-19 06:35:00 UTC (rev 592)
@@ -139,7 +139,6 @@
 		unsigned int m_backgroundThreadsCount;
 		long m_numCPUs;
 		SigC::Signal1<void, WorkerThread *> m_onThreadEndSignal;
-		std::queue<DocumentInfo> m_indexQueue;
 		std::set<std::string> m_beingIndexed;
 
 		bool read_lock_threads(void);

Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-19 06:03:24 UTC (rev 591)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-19 06:35:00 UTC (rev 592)
@@ -28,6 +28,7 @@
 #include <glibmm.h>
 #include <glibmm/thread.h>
 #include <glibmm/ustring.h>
+#include <glibmm/miscutils.h>
 #include <glibmm/convert.h>
 #include <glibmm/object.h>
 extern "C"
@@ -45,6 +46,7 @@
 #include "XapianDatabase.h"
 #include "XapianDatabaseFactory.h"
 #include "HtmlTokenizer.h"
+#include "ActionQueue.h"
 #include "CrawlHistory.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
@@ -672,6 +674,8 @@
 	HtmlTokenizer::initialize();
 	DownloaderInterface::initialize();
 	Glib::thread_init();
+	g_refMainLoop = Glib::MainLoop::create();
+	Glib::set_application_name("Pinot DBus Daemon");
 
 	// This will create the necessary directories on the first run
 	PinotSettings &settings = PinotSettings::getInstance();
@@ -734,6 +738,7 @@
 
 	// Do the same for the history database
 	if ((settings.m_historyDatabase.empty() == true) ||
+		(ActionQueue::create(settings.m_historyDatabase) == false) ||
 		(CrawlHistory::create(settings.m_historyDatabase) == false) ||
 		(QueryHistory::create(settings.m_historyDatabase) == false) ||
 		(ViewHistory::create(settings.m_historyDatabase) == false))
@@ -743,10 +748,13 @@
 	}
 	else
 	{
+		ActionQueue actionQueue(settings.m_historyDatabase, Glib::get_application_name());
 		QueryHistory queryHistory(settings.m_historyDatabase);
 		ViewHistory viewHistory(settings.m_historyDatabase);
 		time_t timeNow = time(NULL);
 
+		// Expire all actions left from last time
+		actionQueue.expireItems(timeNow);
 		// Expire items older than a month
 		queryHistory.expireItems(timeNow - 2592000);
 		viewHistory.expireItems(timeNow - 2592000);
@@ -803,8 +811,6 @@
 
 		try
 		{
-			// Get the main loop
-			g_refMainLoop = Glib::MainLoop::create();
 
 			// Connect to threads' finished signal
 			server.connect();

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2006-11-19 06:03:24 UTC (rev 591)
+++ trunk/UI/GTK2/src/pinot.cc	2006-11-19 06:35:00 UTC (rev 592)
@@ -26,6 +26,7 @@
 #include <glibmm.h>
 #include <glibmm/thread.h>
 #include <glibmm/ustring.h>
+#include <glibmm/miscutils.h>
 #include <glibmm/convert.h>
 #include <gtkmm/main.h>
 
@@ -35,6 +36,7 @@
 #include "XapianDatabase.h"
 #include "XapianDatabaseFactory.h"
 #include "HtmlTokenizer.h"
+#include "ActionQueue.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
 #include "DownloaderInterface.h"
@@ -144,6 +146,7 @@
 	DownloaderInterface::initialize();
 	Glib::thread_init();
 	Gtk::Main m(&argc, &argv);
+	Glib::set_application_name("Pinot GTK2 UI");
 
 	// This will create the necessary directories on the first run
 	PinotSettings &settings = PinotSettings::getInstance();
@@ -212,6 +215,7 @@
 
 	// Do the same for the history database
 	if ((settings.m_historyDatabase.empty() == true) ||
+		(ActionQueue::create(settings.m_historyDatabase) == false) ||
 		(QueryHistory::create(settings.m_historyDatabase) == false) ||
 		(ViewHistory::create(settings.m_historyDatabase) == false))
 	{
@@ -221,10 +225,13 @@
 	}
 	else
 	{
+		ActionQueue actionQueue(settings.m_historyDatabase, Glib::get_prgname());
 		QueryHistory queryHistory(settings.m_historyDatabase);
 		ViewHistory viewHistory(settings.m_historyDatabase);
 		time_t timeNow = time(NULL);
 
+		// Expire all actions left from last time
+		actionQueue.expireItems(timeNow);
 		// Expire items older than a month
 		queryHistory.expireItems(timeNow - 2592000);
 		viewHistory.expireItems(timeNow - 2592000);



From fabricecolin at mail.berlios.de  Tue Nov 21 12:26:47 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 21 Nov 2006 12:26:47 +0100
Subject: [Pinot-svn] r593 - trunk/UI/GTK2/src
Message-ID: <200611211126.kALBQlv6021947@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-21 12:26:46 +0100 (Tue, 21 Nov 2006)
New Revision: 593

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
Log:
Disconnect and get threads to stop before closing stuff down and exiting.
Worker threads that have a signal disconnect it in their stop() method.
DirectoryScanner didn't check whether it was supposed to exit. While crawling,
the daemon should now be able to stop gracefully, whether because it was
signalled or the Stop method was invoked.


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-19 06:35:00 UTC (rev 592)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-21 11:26:46 UTC (rev 593)
@@ -57,16 +57,30 @@
 using namespace Glib;
 using namespace std;
 
-// A function object to stop and delete threads with for_each()
-struct DeleteMapPointer
+// A function object to stop threads with for_each()
+struct StopThreadFunc
 {
 public:
 	void operator()(map<WorkerThread *, Thread *>::value_type &p)
 	{
 		p.first->stop();
 #ifdef DEBUG
-		cout << "DeleteMapPointer: waiting for thread " << p.first->getId() << endl;
+		cout << "StopThreadFunc: stopped thread " << p.first->getId() << endl;
 #endif
+	}
+};
+
+// A function object to delete threads with for_each()
+struct DeleteThreadFunc
+{
+public:
+	void operator()(map<WorkerThread *, Thread *>::value_type &p)
+	{
+#ifdef DEBUG
+		cout << "DeleteThreadFunc: waiting for thread " << p.first->getId() << endl;
+#endif
+		// FIXME: the documentation says resources of the thread, including the Thread object
+		// are released by join()
 		p.second->join();
 		delete p.first;
 	}
@@ -430,9 +444,12 @@
 {
 	if (m_threads.empty() == false)
 	{
-		if (read_lock_threads() == true)
+		if (write_lock_threads() == true)
 		{
-			for_each(m_threads.begin(), m_threads.end(), DeleteMapPointer());
+			// Stop threads
+			for_each(m_threads.begin(), m_threads.end(), StopThreadFunc());
+			// Join them
+			for_each(m_threads.begin(), m_threads.end(), DeleteThreadFunc());
 			m_threads.clear();
 
 			unlock_threads();
@@ -490,8 +507,14 @@
 	double averageLoad[3];
 	bool addToQueue = false;
 
+#ifdef DEBUG
+	cout << "ThreadsManager::queue_index: called" << endl;
+#endif
 	if (get_threads_count() >= m_maxIndexThreads)
 	{
+#ifdef DEBUG
+		cout << "ThreadsManager::queue_index: too many threads" << endl;
+#endif
 		addToQueue = true;
 	}
 	// Get the load averaged over the last minute
@@ -522,6 +545,9 @@
 	bool getItem = true;
 	bool foundItem = false;
 
+#ifdef DEBUG
+	cout << "ThreadsManager::pop_queue: called" << endl;
+#endif
 	if (get_threads_count() >= m_maxIndexThreads)
 	{
 #ifdef DEBUG
@@ -620,7 +646,19 @@
 
 bool IndexBrowserThread::stop(void)
 {
+	// Disconnect the signal
+	Signal3<void, IndexedDocument, unsigned int, string>::slot_list_type slotsList = m_signalUpdate.slots();
+	Signal3<void, IndexedDocument, unsigned int, string>::slot_list_type::iterator slotIter = slotsList.begin();
+	if (slotIter != slotsList.end())
+	{
+		if (slotIter->empty() == false)
+		{
+			slotIter->block();
+			slotIter->disconnect();
+		}
+	}
 	m_done = true;
+
 	return true;
 }
 
@@ -1487,8 +1525,20 @@
 
 bool MonitorThread::stop(void)
 {
+	// Disconnect the signal
+	Signal3<void, const string&, const std::string&, bool>::slot_list_type slotsList = m_signalDirectoryFound.slots();
+	Signal3<void, const string&, const std::string&, bool>::slot_list_type::iterator slotIter = slotsList.begin();
+	if (slotIter != slotsList.end())
+	{
+		if (slotIter->empty() == false)
+		{
+			slotIter->block();
+			slotIter->disconnect();
+		}
+	}
 	m_done = true;
 	write(m_ctrlWritePipe, "Stop", 4);
+
 	return true;
 }
 
@@ -1743,7 +1793,19 @@
 
 bool DirectoryScannerThread::stop(void)
 {
+	// Disconnect the signal
+	Signal3<void, const string&, const std::string&, bool>::slot_list_type slotsList = m_signalFileFound.slots();
+	Signal3<void, const string&, const std::string&, bool>::slot_list_type::iterator slotIter = slotsList.begin();
+	if (slotIter != slotsList.end())
+	{
+		if (slotIter->empty() == false)
+		{
+			slotIter->block();
+			slotIter->disconnect();
+		}
+	}
 	m_done = true;
+
 	return true;
 }
 
@@ -1756,7 +1818,8 @@
 {
 	char labelStr[64];
 
-	if (fileName.empty() == true)
+	if ((fileName.empty() == true) ||
+		(m_done == true))
 	{
 		return;
 	}
@@ -1944,6 +2007,14 @@
 		m_status += m_dirName;
 	}
 
+	if (m_done == true)
+	{
+#ifdef DEBUG
+		cout << "DirectoryScannerThread::doWork: leaving cleanup until next crawl" << endl;
+#endif
+		return;
+	}
+
 	// All files with status set to CRAWLING were not found in this crawl
 	// Chances are they were removed after the previous crawl
 	if ((m_pHandler != NULL) &&

Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-19 06:35:00 UTC (rev 592)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2006-11-21 11:26:46 UTC (rev 593)
@@ -769,7 +769,7 @@
 	}
 
 	// Initialize the GType and the D-Bus thread system
-	g_type_init ();
+	g_type_init();
 	dbus_g_thread_init();
 
 	GError *pError = NULL;
@@ -842,6 +842,10 @@
 		cerr << "Couldn't register object path: " << pError->message << endl;
 	}
 
+	// Stop everything before closing the connection
+	server.disconnect();
+	server.stop_threads();
+
 	dbus_error_free(&error);
 #ifdef DEBUG
 	cout << "Closing connection..." << endl;



From fabricecolin at mail.berlios.de  Wed Nov 22 14:13:44 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 22 Nov 2006 14:13:44 +0100
Subject: [Pinot-svn] r594 - in trunk/Search: . Google
Message-ID: <200611221313.kAMDDicJ000561@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-22 14:13:41 +0100 (Wed, 22 Nov 2006)
New Revision: 594

Modified:
   trunk/Search/Google/GAPIC.cpp
   trunk/Search/Google/GAPIClient.cpp
   trunk/Search/Google/GAPIClientLib.cpp
   trunk/Search/Google/GAPIGoogleSearchBindingProxy.h
   trunk/Search/Google/GAPIH.h
   trunk/Search/Google/GAPIStub.h
   trunk/Search/Google/GoogleSearch.h
   trunk/Search/Google/Makefile.am
   trunk/Search/SOAPEnvH.h
   trunk/Search/SOAPEnvStub.h
Log:
Regenerated SOAP stubs with gSOAP v2.7.8c. Applied same fixes to GAPIC.cpp as
in revision 189.


Modified: trunk/Search/Google/GAPIC.cpp
===================================================================
--- trunk/Search/Google/GAPIC.cpp	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/Google/GAPIC.cpp	2006-11-22 13:13:41 UTC (rev 594)
@@ -1,13 +1,13 @@
 /* GAPIC.cpp
-   Generated by gSOAP 2.7.6e from GoogleSearch.h
-   Copyright (C) 2000-2005, Robert van Engelen, Genivia Inc. All Rights Reserved.
+   Generated by gSOAP 2.7.8c from GoogleSearch.h
+   Copyright (C) 2000-2006, Robert van Engelen, Genivia Inc. All Rights Reserved.
    This part of the software is released under one of the following licenses:
    GPL, the gSOAP public license, or Genivia's license for commercial use.
 */
 
 #include "GAPIH.h"
 
-SOAP_SOURCE_STAMP("@(#) GAPIC.cpp ver 2.7.6e 2006-04-02 07:31:50 GMT")
+SOAP_SOURCE_STAMP("@(#) GAPIC.cpp ver 2.7.8c 2006-11-22 12:30:01 GMT")
 
 
 #ifndef WITH_NOGLOBAL
@@ -163,8 +163,6 @@
 		return soap_in_gapi1__ResultElement(soap, NULL, NULL, "gapi1:ResultElement");
 	case SOAP_TYPE_gapi1__GoogleSearchResult:
 		return soap_in_gapi1__GoogleSearchResult(soap, NULL, NULL, "gapi1:GoogleSearchResult");
-	case SOAP_TYPE__SOAP_ENC__arrayType:
-		return soap_in__SOAP_ENC__arrayType(soap, NULL, NULL, "SOAP-ENC:arrayType");
 	case SOAP_TYPE_std__string:
 		return soap_in_std__string(soap, NULL, NULL, "xsd:string");
 	case SOAP_TYPE_xsd__base64Binary:
@@ -197,11 +195,6 @@
 		return soap_in_PointerTogapi1ResultElementArray(soap, NULL, NULL, "gapi1:ResultElement");
 	case SOAP_TYPE_PointerTounsignedByte:
 		return soap_in_PointerTounsignedByte(soap, NULL, NULL, "xsd:unsignedByte");
-	case SOAP_TYPE__QName:
-	{	char **s;
-		s = soap_in__QName(soap, NULL, NULL, "QName");
-		return s ? *s : NULL;
-	}
 	case SOAP_TYPE_string:
 	{	char **s;
 		s = soap_in_string(soap, NULL, NULL, "xsd:string");
@@ -255,10 +248,6 @@
 		{	*type = SOAP_TYPE_gapi1__GoogleSearchResult;
 			return soap_in_gapi1__GoogleSearchResult(soap, NULL, NULL, NULL);
 		}
-		if (!soap_match_tag(soap, t, "SOAP-ENC:arrayType"))
-		{	*type = SOAP_TYPE__SOAP_ENC__arrayType;
-			return soap_in__SOAP_ENC__arrayType(soap, NULL, NULL, NULL);
-		}
 		if (!soap_match_tag(soap, t, "xsd:string"))
 		{	*type = SOAP_TYPE_std__string;
 			return soap_in_std__string(soap, NULL, NULL, NULL);
@@ -291,18 +280,23 @@
 		{	*type = SOAP_TYPE_gapi1__doGetCachedPageResponse;
 			return soap_in_gapi1__doGetCachedPageResponse(soap, NULL, NULL, NULL);
 		}
-		if (!soap_match_tag(soap, t, "QName"))
-		{	char **s;
-			*type = SOAP_TYPE__QName;
-			s = soap_in__QName(soap, NULL, NULL, NULL);
-			return s ? *s : NULL;
-		}
 		if (!soap_match_tag(soap, t, "xsd:string"))
 		{	char **s;
 			*type = SOAP_TYPE_string;
 			s = soap_in_string(soap, NULL, NULL, NULL);
 			return s ? *s : NULL;
 		}
+		t = soap->tag;
+		if (!soap_match_tag(soap, t, "SOAP-ENC:arrayType"))
+		{	*type = SOAP_TYPE__SOAP_ENC__arrayType;
+			return soap_in__SOAP_ENC__arrayType(soap, NULL, NULL, NULL);
+		}
+		if (!soap_match_tag(soap, t, "QName"))
+		{	char **s;
+			*type = SOAP_TYPE__QName;
+			s = soap_in__QName(soap, NULL, NULL, NULL);
+			return s ? *s : NULL;
+		}
 	}
 	}
 	soap->error = SOAP_TAG_MISMATCH;
@@ -317,7 +311,9 @@
 		if (soap->mustUnderstand && !soap->other)
 			return soap->error = SOAP_MUSTUNDERSTAND;
 		if (((soap->mode & SOAP_XML_STRICT) && soap->part != SOAP_IN_HEADER) || !soap_match_tag(soap, soap->tag, "SOAP-ENV:"))
+		{
 			return soap->error = SOAP_TAG_MISMATCH;
+		}
 		if (!*soap->id || !soap_getelement(soap, &t))
 		{	soap->peeked = 0;
 			if (soap->fignore)
@@ -671,7 +667,7 @@
 {	switch (tt)
 	{
 	default:
-		break;
+		DBGLOG(TEST, SOAP_MESSAGE(fdebug, "Could not insert type=%d in %d\n", st, tt));
 	}
 }
 
@@ -869,7 +865,7 @@
 };
 
 SOAP_FMAC3S const char* SOAP_FMAC4S soap_bool2s(struct soap *soap, bool n)
-{	const char *s = soap_str_code(soap_codes_bool, (long)n);
+{	const char *s = soap_code_str(soap_codes_bool, (long)n);
 	if (s)
 		return s;
 	return soap_long2s(soap, (long)n);
@@ -898,7 +894,7 @@
 		*a = (bool)(map->code != 0);
 	else
 	{	long n;
-		if (soap_s2long(soap, s, &n) || ((soap->mode & SOAP_XML_STRICT) && (n < 0 || n > 1)))
+		if (soap_s2long(soap, s, &n) || n < 0 || n > 1)
 			return soap->error = SOAP_TYPE;
 		*a = (bool)(n != 0);
 	}
@@ -907,9 +903,9 @@
 
 SOAP_FMAC3 bool * SOAP_FMAC4 soap_in_bool(struct soap *soap, const char *tag, bool *a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, NULL))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
+	if (*soap->type && soap_match_tag(soap, soap->type, type) && soap_match_tag(soap, soap->type, ":boolean"))
 	{	soap->error = SOAP_TYPE;
 		return NULL;
 	}
@@ -985,7 +981,7 @@
 
 SOAP_FMAC3 gapi1__DirectoryCategory * SOAP_FMAC4 soap_in_gapi1__DirectoryCategory(struct soap *soap, const char *tag, gapi1__DirectoryCategory *a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, NULL))
 		return NULL;
 	a = (gapi1__DirectoryCategory *)soap_class_id_enter(soap, soap->id, a, SOAP_TYPE_gapi1__DirectoryCategory, sizeof(gapi1__DirectoryCategory), soap->type, soap->arrayType);
 	if (!a)
@@ -1136,7 +1132,7 @@
 SOAP_FMAC3 gapi1DirectoryCategoryArray * SOAP_FMAC4 soap_in_gapi1DirectoryCategoryArray(struct soap *soap, const char *tag, gapi1DirectoryCategoryArray *a, const char *type)
 {	int i, j;
 	gapi1__DirectoryCategory **p;
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (soap_match_array(soap, type))
 	{	soap->error = SOAP_TYPE;
@@ -1300,7 +1296,7 @@
 SOAP_FMAC3 gapi1ResultElementArray * SOAP_FMAC4 soap_in_gapi1ResultElementArray(struct soap *soap, const char *tag, gapi1ResultElementArray *a, const char *type)
 {	int i, j;
 	gapi1__ResultElement **p;
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (soap_match_array(soap, type))
 	{	soap->error = SOAP_TYPE;
@@ -1475,7 +1471,7 @@
 
 SOAP_FMAC3 gapi1__ResultElement * SOAP_FMAC4 soap_in_gapi1__ResultElement(struct soap *soap, const char *tag, gapi1__ResultElement *a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, NULL))
 		return NULL;
 	a = (gapi1__ResultElement *)soap_class_id_enter(soap, soap->id, a, SOAP_TYPE_gapi1__ResultElement, sizeof(gapi1__ResultElement), soap->type, soap->arrayType);
 	if (!a)
@@ -1673,7 +1669,7 @@
 
 SOAP_FMAC3 gapi1__GoogleSearchResult * SOAP_FMAC4 soap_in_gapi1__GoogleSearchResult(struct soap *soap, const char *tag, gapi1__GoogleSearchResult *a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, NULL))
 		return NULL;
 	a = (gapi1__GoogleSearchResult *)soap_class_id_enter(soap, soap->id, a, SOAP_TYPE_gapi1__GoogleSearchResult, sizeof(gapi1__GoogleSearchResult), soap->type, soap->arrayType);
 	if (!a)
@@ -1820,6 +1816,8 @@
 }
 SOAP_FMAC3 int SOAP_FMAC4 soap_out__SOAP_ENC__arrayType(struct soap *soap, const char *tag, int id, const std::string *s, const char *type)
 {
+	if ((soap->mode & SOAP_C_NILSTRING) && s->empty())
+		return soap_element_null(soap, tag, id, type);
 	if (soap_element_begin_out(soap, tag, soap_embedded_id(soap, id, s, SOAP_TYPE__SOAP_ENC__arrayType), type) || soap_string_out(soap, s->c_str(), 0) || soap_element_end_out(soap, tag))
 		return soap->error;
 	return SOAP_OK;
@@ -1834,17 +1832,13 @@
 
 SOAP_FMAC1 std::string * SOAP_FMAC2 soap_in__SOAP_ENC__arrayType(struct soap *soap, const char *tag, std::string *s, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, type))
 		return NULL;
 	if (!s)
 		s = soap_new_std__string(soap, -1);
 	if (soap->null)
 		if (s)
 			s->erase();
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	if (soap->body && !*soap->href)
 	{	char *t;
 		s = (std::string*)soap_class_id_enter(soap, soap->id, s, SOAP_TYPE__SOAP_ENC__arrayType, sizeof(std::string), soap->type, soap->arrayType);
@@ -1910,6 +1904,8 @@
 }
 SOAP_FMAC3 int SOAP_FMAC4 soap_out_std__string(struct soap *soap, const char *tag, int id, const std::string *s, const char *type)
 {
+	if ((soap->mode & SOAP_C_NILSTRING) && s->empty())
+		return soap_element_null(soap, tag, id, type);
 	if (soap_element_begin_out(soap, tag, soap_embedded_id(soap, id, s, SOAP_TYPE_std__string), type) || soap_string_out(soap, s->c_str(), 0) || soap_element_end_out(soap, tag))
 		return soap->error;
 	return SOAP_OK;
@@ -1924,17 +1920,13 @@
 
 SOAP_FMAC1 std::string * SOAP_FMAC2 soap_in_std__string(struct soap *soap, const char *tag, std::string *s, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, type))
 		return NULL;
 	if (!s)
 		s = soap_new_std__string(soap, -1);
 	if (soap->null)
 		if (s)
 			s->erase();
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	if (soap->body && !*soap->href)
 	{	char *t;
 		s = (std::string*)soap_class_id_enter(soap, soap->id, s, SOAP_TYPE_std__string, sizeof(std::string), soap->type, soap->arrayType);
@@ -2040,7 +2032,7 @@
 
 SOAP_FMAC3 xsd__base64Binary * SOAP_FMAC4 soap_in_xsd__base64Binary(struct soap *soap, const char *tag, xsd__base64Binary *a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (*soap->type && soap_match_tag(soap, soap->type, type) && soap_match_tag(soap, soap->type, ":base64Binary") && soap_match_tag(soap, soap->type, ":base64"))
 	{	soap->error = SOAP_TYPE;
@@ -2171,12 +2163,8 @@
 SOAP_FMAC3 struct SOAP_ENV__Fault * SOAP_FMAC4 soap_in_SOAP_ENV__Fault(struct soap *soap, const char *tag, struct SOAP_ENV__Fault *a, const char *type)
 {
 	short soap_flag_faultcode = 1, soap_flag_faultstring = 1, soap_flag_faultactor = 1, soap_flag_detail = 1, soap_flag_SOAP_ENV__Code = 1, soap_flag_SOAP_ENV__Reason = 1, soap_flag_SOAP_ENV__Node = 1, soap_flag_SOAP_ENV__Role = 1, soap_flag_SOAP_ENV__Detail = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct SOAP_ENV__Fault *)soap_id_enter(soap, soap->id, a, SOAP_TYPE_SOAP_ENV__Fault, sizeof(struct SOAP_ENV__Fault), 0, NULL, NULL, NULL);
 	if (!a)
 		return NULL;
@@ -2321,12 +2309,8 @@
 SOAP_FMAC3 struct SOAP_ENV__Reason * SOAP_FMAC4 soap_in_SOAP_ENV__Reason(struct soap *soap, const char *tag, struct SOAP_ENV__Reason *a, const char *type)
 {
 	short soap_flag_SOAP_ENV__Text = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct SOAP_ENV__Reason *)soap_id_enter(soap, soap->id, a, SOAP_TYPE_SOAP_ENV__Reason, sizeof(struct SOAP_ENV__Reason), 0, NULL, NULL, NULL);
 	if (!a)
 		return NULL;
@@ -2419,7 +2403,7 @@
 {
 	soap_element_begin_out(soap, tag, soap_embedded_id(soap, id, a, SOAP_TYPE_SOAP_ENV__Detail), type);
 	soap_putelement(soap, a->fault, "fault", -1, a->__type);
-	soap_outliteral(soap, "-any", &a->__any);
+	soap_outliteral(soap, "-any", &a->__any, NULL);
 	soap_element_end_out(soap, tag);
 	return SOAP_OK;
 }
@@ -2434,12 +2418,8 @@
 SOAP_FMAC3 struct SOAP_ENV__Detail * SOAP_FMAC4 soap_in_SOAP_ENV__Detail(struct soap *soap, const char *tag, struct SOAP_ENV__Detail *a, const char *type)
 {
 	short soap_flag_fault = 1, soap_flag___any = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct SOAP_ENV__Detail *)soap_id_enter(soap, soap->id, a, SOAP_TYPE_SOAP_ENV__Detail, sizeof(struct SOAP_ENV__Detail), 0, NULL, NULL, NULL);
 	if (!a)
 		return NULL;
@@ -2553,12 +2533,8 @@
 SOAP_FMAC3 struct SOAP_ENV__Code * SOAP_FMAC4 soap_in_SOAP_ENV__Code(struct soap *soap, const char *tag, struct SOAP_ENV__Code *a, const char *type)
 {
 	short soap_flag_SOAP_ENV__Value = 1, soap_flag_SOAP_ENV__Subcode = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct SOAP_ENV__Code *)soap_id_enter(soap, soap->id, a, SOAP_TYPE_SOAP_ENV__Code, sizeof(struct SOAP_ENV__Code), 0, NULL, NULL, NULL);
 	if (!a)
 		return NULL;
@@ -2667,12 +2643,8 @@
 
 SOAP_FMAC3 struct SOAP_ENV__Header * SOAP_FMAC4 soap_in_SOAP_ENV__Header(struct soap *soap, const char *tag, struct SOAP_ENV__Header *a, const char *type)
 {;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct SOAP_ENV__Header *)soap_id_enter(soap, soap->id, a, SOAP_TYPE_SOAP_ENV__Header, sizeof(struct SOAP_ENV__Header), 0, NULL, NULL, NULL);
 	if (!a)
 		return NULL;
@@ -2794,12 +2766,8 @@
 SOAP_FMAC3 struct gapi1__doGoogleSearch * SOAP_FMAC4 soap_in_gapi1__doGoogleSearch(struct soap *soap, const char *tag, struct gapi1__doGoogleSearch *a, const char *type)
 {
 	short soap_flag_key = 1, soap_flag_q = 1, soap_flag_start = 1, soap_flag_maxResults = 1, soap_flag_filter = 1, soap_flag_restrict_ = 1, soap_flag_safeSearch = 1, soap_flag_lr = 1, soap_flag_ie = 1, soap_flag_oe = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct gapi1__doGoogleSearch *)soap_class_id_enter(soap, soap->id, a, SOAP_TYPE_gapi1__doGoogleSearch, sizeof(struct gapi1__doGoogleSearch), soap->type, soap->arrayType);
 	if (!a)
 		return NULL;
@@ -2951,12 +2919,8 @@
 SOAP_FMAC3 struct gapi1__doGoogleSearchResponse * SOAP_FMAC4 soap_in_gapi1__doGoogleSearchResponse(struct soap *soap, const char *tag, struct gapi1__doGoogleSearchResponse *a, const char *type)
 {
 	short soap_flag_return_ = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct gapi1__doGoogleSearchResponse *)soap_id_enter(soap, soap->id, a, SOAP_TYPE_gapi1__doGoogleSearchResponse, sizeof(struct gapi1__doGoogleSearchResponse), 0, NULL, NULL, NULL);
 	if (!a)
 		return NULL;
@@ -2970,6 +2934,7 @@
 				{	soap_flag_return_--;
 					continue;
 				}
+			soap_check_result(soap, "return");
 			if (soap->error == SOAP_TAG_MISMATCH)
 				soap->error = soap_ignore_element(soap);
 			if (soap->error == SOAP_NO_TAG)
@@ -3044,8 +3009,8 @@
 SOAP_FMAC3 int SOAP_FMAC4 soap_out_gapi1__doSpellingSuggestion(struct soap *soap, const char *tag, int id, const struct gapi1__doSpellingSuggestion *a, const char *type)
 {
 	soap_element_begin_out(soap, tag, soap_embedded_id(soap, id, a, SOAP_TYPE_gapi1__doSpellingSuggestion), type);
-	soap_out_std__string(soap, "key", -1, &a->key, "xsd:string");
-	soap_out_std__string(soap, "phrase", -1, &a->phrase, "xsd:string");
+	soap_out_std__string(soap, "key", -1, &a->key, "");
+	soap_out_std__string(soap, "phrase", -1, &a->phrase, "");
 	soap_element_end_out(soap, tag);
 	return SOAP_OK;
 }
@@ -3060,12 +3025,8 @@
 SOAP_FMAC3 struct gapi1__doSpellingSuggestion * SOAP_FMAC4 soap_in_gapi1__doSpellingSuggestion(struct soap *soap, const char *tag, struct gapi1__doSpellingSuggestion *a, const char *type)
 {
 	short soap_flag_key = 1, soap_flag_phrase = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct gapi1__doSpellingSuggestion *)soap_class_id_enter(soap, soap->id, a, SOAP_TYPE_gapi1__doSpellingSuggestion, sizeof(struct gapi1__doSpellingSuggestion), soap->type, soap->arrayType);
 	if (!a)
 		return NULL;
@@ -3176,12 +3137,8 @@
 SOAP_FMAC3 struct gapi1__doSpellingSuggestionResponse * SOAP_FMAC4 soap_in_gapi1__doSpellingSuggestionResponse(struct soap *soap, const char *tag, struct gapi1__doSpellingSuggestionResponse *a, const char *type)
 {
 	short soap_flag_return_ = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct gapi1__doSpellingSuggestionResponse *)soap_class_id_enter(soap, soap->id, a, SOAP_TYPE_gapi1__doSpellingSuggestionResponse, sizeof(struct gapi1__doSpellingSuggestionResponse), soap->type, soap->arrayType);
 	if (!a)
 		return NULL;
@@ -3195,6 +3152,7 @@
 				{	soap_flag_return_--;
 					continue;
 				}
+			soap_check_result(soap, "return");
 			if (soap->error == SOAP_TAG_MISMATCH)
 				soap->error = soap_ignore_element(soap);
 			if (soap->error == SOAP_NO_TAG)
@@ -3273,8 +3231,8 @@
 SOAP_FMAC3 int SOAP_FMAC4 soap_out_gapi1__doGetCachedPage(struct soap *soap, const char *tag, int id, const struct gapi1__doGetCachedPage *a, const char *type)
 {
 	soap_element_begin_out(soap, tag, soap_embedded_id(soap, id, a, SOAP_TYPE_gapi1__doGetCachedPage), type);
-	soap_out_std__string(soap, "key", -1, &a->key, "xsd:string");
-	soap_out_std__string(soap, "url", -1, &a->url, "xsd:string");
+	soap_out_std__string(soap, "key", -1, &a->key, "");
+	soap_out_std__string(soap, "url", -1, &a->url, "");
 	soap_element_end_out(soap, tag);
 	return SOAP_OK;
 }
@@ -3289,12 +3247,8 @@
 SOAP_FMAC3 struct gapi1__doGetCachedPage * SOAP_FMAC4 soap_in_gapi1__doGetCachedPage(struct soap *soap, const char *tag, struct gapi1__doGetCachedPage *a, const char *type)
 {
 	short soap_flag_key = 1, soap_flag_url = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct gapi1__doGetCachedPage *)soap_class_id_enter(soap, soap->id, a, SOAP_TYPE_gapi1__doGetCachedPage, sizeof(struct gapi1__doGetCachedPage), soap->type, soap->arrayType);
 	if (!a)
 		return NULL;
@@ -3405,12 +3359,8 @@
 SOAP_FMAC3 struct gapi1__doGetCachedPageResponse * SOAP_FMAC4 soap_in_gapi1__doGetCachedPageResponse(struct soap *soap, const char *tag, struct gapi1__doGetCachedPageResponse *a, const char *type)
 {
 	short soap_flag_return_ = 1;
-	if (soap_element_begin_in(soap, tag, 0))
+	if (soap_element_begin_in(soap, tag, 0, type))
 		return NULL;
-	if (*soap->type && soap_match_tag(soap, soap->type, type))
-	{	soap->error = SOAP_TYPE;
-		return NULL;
-	}
 	a = (struct gapi1__doGetCachedPageResponse *)soap_class_id_enter(soap, soap->id, a, SOAP_TYPE_gapi1__doGetCachedPageResponse, sizeof(struct gapi1__doGetCachedPageResponse), soap->type, soap->arrayType);
 	if (!a)
 		return NULL;
@@ -3424,6 +3374,7 @@
 				{	soap_flag_return_--;
 					continue;
 				}
+			soap_check_result(soap, "return");
 			if (soap->error == SOAP_TAG_MISMATCH)
 				soap->error = soap_ignore_element(soap);
 			if (soap->error == SOAP_NO_TAG)
@@ -3510,7 +3461,7 @@
 
 SOAP_FMAC3 struct SOAP_ENV__Reason ** SOAP_FMAC4 soap_in_PointerToSOAP_ENV__Reason(struct soap *soap, const char *tag, struct SOAP_ENV__Reason **a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (struct SOAP_ENV__Reason **)soap_malloc(soap, sizeof(struct SOAP_ENV__Reason *))))
@@ -3564,7 +3515,7 @@
 
 SOAP_FMAC3 struct SOAP_ENV__Detail ** SOAP_FMAC4 soap_in_PointerToSOAP_ENV__Detail(struct soap *soap, const char *tag, struct SOAP_ENV__Detail **a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (struct SOAP_ENV__Detail **)soap_malloc(soap, sizeof(struct SOAP_ENV__Detail *))))
@@ -3618,7 +3569,7 @@
 
 SOAP_FMAC3 struct SOAP_ENV__Code ** SOAP_FMAC4 soap_in_PointerToSOAP_ENV__Code(struct soap *soap, const char *tag, struct SOAP_ENV__Code **a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (struct SOAP_ENV__Code **)soap_malloc(soap, sizeof(struct SOAP_ENV__Code *))))
@@ -3670,7 +3621,7 @@
 
 SOAP_FMAC3 gapi1__GoogleSearchResult ** SOAP_FMAC4 soap_in_PointerTogapi1__GoogleSearchResult(struct soap *soap, const char *tag, gapi1__GoogleSearchResult **a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (gapi1__GoogleSearchResult **)soap_malloc(soap, sizeof(gapi1__GoogleSearchResult *))))
@@ -3723,7 +3674,7 @@
 
 SOAP_FMAC3 gapi1__DirectoryCategory *** SOAP_FMAC4 soap_in_PointerToPointerTogapi1__DirectoryCategory(struct soap *soap, const char *tag, gapi1__DirectoryCategory ***a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (gapi1__DirectoryCategory ***)soap_malloc(soap, sizeof(gapi1__DirectoryCategory **))))
@@ -3773,7 +3724,7 @@
 
 SOAP_FMAC3 gapi1__ResultElement *** SOAP_FMAC4 soap_in_PointerToPointerTogapi1__ResultElement(struct soap *soap, const char *tag, gapi1__ResultElement ***a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (gapi1__ResultElement ***)soap_malloc(soap, sizeof(gapi1__ResultElement **))))
@@ -3823,7 +3774,7 @@
 
 SOAP_FMAC3 gapi1__ResultElement ** SOAP_FMAC4 soap_in_PointerTogapi1__ResultElement(struct soap *soap, const char *tag, gapi1__ResultElement **a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (gapi1__ResultElement **)soap_malloc(soap, sizeof(gapi1__ResultElement *))))
@@ -3876,7 +3827,7 @@
 
 SOAP_FMAC3 gapi1__DirectoryCategory ** SOAP_FMAC4 soap_in_PointerTogapi1__DirectoryCategory(struct soap *soap, const char *tag, gapi1__DirectoryCategory **a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (gapi1__DirectoryCategory **)soap_malloc(soap, sizeof(gapi1__DirectoryCategory *))))
@@ -3929,7 +3880,7 @@
 
 SOAP_FMAC3 gapi1DirectoryCategoryArray ** SOAP_FMAC4 soap_in_PointerTogapi1DirectoryCategoryArray(struct soap *soap, const char *tag, gapi1DirectoryCategoryArray **a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (gapi1DirectoryCategoryArray **)soap_malloc(soap, sizeof(gapi1DirectoryCategoryArray *))))
@@ -3982,7 +3933,7 @@
 
 SOAP_FMAC3 gapi1ResultElementArray ** SOAP_FMAC4 soap_in_PointerTogapi1ResultElementArray(struct soap *soap, const char *tag, gapi1ResultElementArray **a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (gapi1ResultElementArray **)soap_malloc(soap, sizeof(gapi1ResultElementArray *))))
@@ -4034,7 +3985,7 @@
 
 SOAP_FMAC3 unsigned char ** SOAP_FMAC4 soap_in_PointerTounsignedByte(struct soap *soap, const char *tag, unsigned char **a, const char *type)
 {
-	if (soap_element_begin_in(soap, tag, 1))
+	if (soap_element_begin_in(soap, tag, 1, NULL))
 		return NULL;
 	if (!a)
 		if (!(a = (unsigned char **)soap_malloc(soap, sizeof(unsigned char *))))

Modified: trunk/Search/Google/GAPIClient.cpp
===================================================================
--- trunk/Search/Google/GAPIClient.cpp	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/Google/GAPIClient.cpp	2006-11-22 13:13:41 UTC (rev 594)
@@ -1,12 +1,12 @@
 /* GAPIClient.cpp
-   Generated by gSOAP 2.7.6e from GoogleSearch.h
-   Copyright (C) 2000-2005, Robert van Engelen, Genivia Inc. All Rights Reserved.
+   Generated by gSOAP 2.7.8c from GoogleSearch.h
+   Copyright (C) 2000-2006, Robert van Engelen, Genivia Inc. All Rights Reserved.
    This part of the software is released under one of the following licenses:
    GPL, the gSOAP public license, or Genivia's license for commercial use.
 */
 #include "GAPIH.h"
 
-SOAP_SOURCE_STAMP("@(#) GAPIClient.cpp ver 2.7.6e 2006-04-05 04:17:23 GMT")
+SOAP_SOURCE_STAMP("@(#) GAPIClient.cpp ver 2.7.8c 2006-11-22 12:30:01 GMT")
 
 
 SOAP_FMAC5 int SOAP_FMAC6 soap_call_gapi1__doGetCachedPage(struct soap *soap, const char *soap_endpoint, const char *soap_action, std::string key, std::string url, xsd__base64Binary &return_)

Modified: trunk/Search/Google/GAPIClientLib.cpp
===================================================================
--- trunk/Search/Google/GAPIClientLib.cpp	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/Google/GAPIClientLib.cpp	2006-11-22 13:13:41 UTC (rev 594)
@@ -1,6 +1,6 @@
 /* GAPIClientLib.cpp
-   Generated by gSOAP 2.7.6e from GoogleSearch.h
-   Copyright (C) 2000-2005, Robert van Engelen, Genivia Inc. All Rights Reserved.
+   Generated by gSOAP 2.7.8c from GoogleSearch.h
+   Copyright (C) 2000-2006, Robert van Engelen, Genivia Inc. All Rights Reserved.
    This part of the software is released under one of the following licenses:
    GPL, the gSOAP public license, or Genivia's license for commercial use.
 */

Modified: trunk/Search/Google/GAPIGoogleSearchBindingProxy.h
===================================================================
--- trunk/Search/Google/GAPIGoogleSearchBindingProxy.h	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/Google/GAPIGoogleSearchBindingProxy.h	2006-11-22 13:13:41 UTC (rev 594)
@@ -1,6 +1,6 @@
 /* GAPIGoogleSearchBindingProxy.h
-   Generated by gSOAP 2.7.6e from GoogleSearch.h
-   Copyright (C) 2000-2005, Robert van Engelen, Genivia Inc. All Rights Reserved.
+   Generated by gSOAP 2.7.8c from GoogleSearch.h
+   Copyright (C) 2000-2006, Robert van Engelen, Genivia Inc. All Rights Reserved.
    This part of the software is released under one of the following licenses:
    GPL, the gSOAP public license, or Genivia's license for commercial use.
 */

Modified: trunk/Search/Google/GAPIH.h
===================================================================
--- trunk/Search/Google/GAPIH.h	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/Google/GAPIH.h	2006-11-22 13:13:41 UTC (rev 594)
@@ -1,6 +1,6 @@
 /* GAPIH.h
-   Generated by gSOAP 2.7.6e from GoogleSearch.h
-   Copyright (C) 2000-2005, Robert van Engelen, Genivia Inc. All Rights Reserved.
+   Generated by gSOAP 2.7.8c from GoogleSearch.h
+   Copyright (C) 2000-2006, Robert van Engelen, Genivia Inc. All Rights Reserved.
    This part of the software is released under one of the following licenses:
    GPL, the gSOAP public license, or Genivia's license for commercial use.
 */

Modified: trunk/Search/Google/GAPIStub.h
===================================================================
--- trunk/Search/Google/GAPIStub.h	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/Google/GAPIStub.h	2006-11-22 13:13:41 UTC (rev 594)
@@ -1,13 +1,12 @@
 /* GAPIStub.h
-   Generated by gSOAP 2.7.6e from GoogleSearch.h
-   Copyright (C) 2000-2005, Robert van Engelen, Genivia Inc. All Rights Reserved.
+   Generated by gSOAP 2.7.8c from GoogleSearch.h
+   Copyright (C) 2000-2006, Robert van Engelen, Genivia Inc. All Rights Reserved.
    This part of the software is released under one of the following licenses:
    GPL, the gSOAP public license, or Genivia's license for commercial use.
 */
 
 #ifndef GAPIStub_H
 #define GAPIStub_H
-#include <string>
 #include <vector>
 #define WITH_NONAMESPACES
 #include "stdsoap2.h"

Modified: trunk/Search/Google/GoogleSearch.h
===================================================================
--- trunk/Search/Google/GoogleSearch.h	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/Google/GoogleSearch.h	2006-11-22 13:13:41 UTC (rev 594)
@@ -1,7 +1,7 @@
 /* GoogleSearch.h
-   Generated by wsdl2h 1.2.6e from googleapi/GoogleSearch.wsdl and typemap.dat
-   2006-04-02 07:30:36 GMT
-   Copyright (C) 2001-2005 Robert van Engelen, Genivia Inc. All Rights Reserved.
+   Generated by wsdl2h 1.2.8c from googleapi/GoogleSearch.wsdl and typemap.dat
+   2006-11-22 12:29:42 GMT
+   Copyright (C) 2001-2006 Robert van Engelen, Genivia Inc. All Rights Reserved.
    This part of the software is released under one of the following licenses:
    GPL or Genivia's license for commercial use.
 */
@@ -19,15 +19,18 @@
  - Use Doxygen (www.doxygen.org) to browse this file.
  - Use wsdl2h option -l to view the software license terms.
 
+   DO NOT include this file directly into your project.
+   Include only the soapcpp2-generated headers and source code files.
 */
 
+//gsoapopt w
+
 /******************************************************************************\
  *                                                                            *
  * urn:GoogleSearch                                                           *
  *                                                                            *
 \******************************************************************************/
 
-//gsoapopt w
 
 /******************************************************************************\
  *                                                                            *

Modified: trunk/Search/Google/Makefile.am
===================================================================
--- trunk/Search/Google/Makefile.am	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/Google/Makefile.am	2006-11-22 13:13:41 UTC (rev 594)
@@ -17,7 +17,7 @@
 	GoogleAPIEngine.cpp
 
 GoogleSearch.h :
-	wsdl2c -n gapi -o GoogleSearch.h googleapi/GoogleSearch.wsdl
+	wsdl2h -n gapi -o GoogleSearch.h googleapi/GoogleSearch.wsdl
 
 GAPIClientLib.cpp : GoogleSearch.h
 	soapcpp2 -n -pGAPI -I /usr/include/gsoap/import GoogleSearch.h

Modified: trunk/Search/SOAPEnvH.h
===================================================================
--- trunk/Search/SOAPEnvH.h	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/SOAPEnvH.h	2006-11-22 13:13:41 UTC (rev 594)
@@ -1,6 +1,6 @@
 /* SOAPEnvH.h
-   Generated by gSOAP 2.7.6e from SOAPEnv.h
-   Copyright (C) 2000-2005, Robert van Engelen, Genivia Inc. All Rights Reserved.
+   Generated by gSOAP 2.7.8c from SOAPEnv.h
+   Copyright (C) 2000-2006, Robert van Engelen, Genivia Inc. All Rights Reserved.
    This part of the software is released under one of the following licenses:
    GPL, the gSOAP public license, or Genivia's license for commercial use.
 */

Modified: trunk/Search/SOAPEnvStub.h
===================================================================
--- trunk/Search/SOAPEnvStub.h	2006-11-21 11:26:46 UTC (rev 593)
+++ trunk/Search/SOAPEnvStub.h	2006-11-22 13:13:41 UTC (rev 594)
@@ -1,6 +1,6 @@
 /* SOAPEnvStub.h
-   Generated by gSOAP 2.7.6e from SOAPEnv.h
-   Copyright (C) 2000-2005, Robert van Engelen, Genivia Inc. All Rights Reserved.
+   Generated by gSOAP 2.7.8c from SOAPEnv.h
+   Copyright (C) 2000-2006, Robert van Engelen, Genivia Inc. All Rights Reserved.
    This part of the software is released under one of the following licenses:
    GPL, the gSOAP public license, or Genivia's license for commercial use.
 */



From fabricecolin at mail.berlios.de  Thu Nov 23 14:02:57 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Thu, 23 Nov 2006 14:02:57 +0100
Subject: [Pinot-svn] r595 - in trunk: Collect Index SQL UI/GTK2/src Utils
Message-ID: <200611231302.kAND2vJg009892@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-23 14:02:56 +0100 (Thu, 23 Nov 2006)
New Revision: 595

Modified:
   trunk/Collect/XapianCollector.cpp
   trunk/Index/XapianIndex.cpp
   trunk/Index/pinot-index.cpp
   trunk/SQL/ActionQueue.cpp
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/Utils/DocumentInfo.cpp
Log:
Added file size to DocumentInfo and the index (as data).


Modified: trunk/Collect/XapianCollector.cpp
===================================================================
--- trunk/Collect/XapianCollector.cpp	2006-11-22 13:13:41 UTC (rev 594)
+++ trunk/Collect/XapianCollector.cpp	2006-11-23 13:02:56 UTC (rev 595)
@@ -171,12 +171,17 @@
 		string type = StringManip::extractField(record, "type=", "\n");
 		string timestamp = StringManip::extractField(record, "timestamp=", "\n");
 		string language = StringManip::extractField(record, "language=", "\n");
+		string bytesSize = StringManip::extractField(record, "size=", "\n");
 #ifdef DEBUG
 		cout << "XapianCollector::retrieveUrl: " << docId << " was indexed from " << location << " at " << timestamp << endl;
 #endif
 
 		pIndexedDoc = new IndexedDocument(title, url, location, type, language);
 		pIndexedDoc->setTimestamp(timestamp);
+		if (bytesSize.empty() == false)
+		{
+			pIndexedDoc->setSize((off_t)atol(bytesSize.c_str()));
+		}
 
 		// Extract document's data ?
 		if (m_getDocData == true)

Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-11-22 13:13:41 UTC (rev 594)
+++ trunk/Index/XapianIndex.cpp	2006-11-23 13:02:56 UTC (rev 595)
@@ -423,6 +423,11 @@
 		}
 	}
 	docInfo.setTimestamp(timestamp);
+	string bytesSize(StringManip::extractField(record, "size=", "\n"));
+	if (bytesSize.empty() == false)
+	{
+		docInfo.setSize((off_t )atol(bytesSize.c_str()));
+	}
 	Url urlObj(docInfo.getLocation());
 
 	// FIXME: remove terms extracted from the title if they don't have more than one posting
@@ -525,7 +530,7 @@
 {
 	string title(info.getTitle());
 	string timestamp(info.getTimestamp());
-	char timeStr[64];
+	char tmpStr[64];
 	time_t timeT = TimeConverter::fromTimestamp(timestamp);
 
 	// Add this value to allow sorting by date
@@ -555,11 +560,15 @@
 	record += info.getType();
 	// Append a timestamp, in a format compatible with Omega
 	record += "\nmodtime=";
-	snprintf(timeStr, 64, "%ld", timeT);
-	record += timeStr;
+	snprintf(tmpStr, 64, "%ld", timeT);
+	record += tmpStr;
 	// ...and the language
 	record += "\nlanguage=";
 	record += StringManip::toLowerCase(language);
+	// ...and the file size
+	record += "\nsize=";
+	snprintf(tmpStr, 64, "%ld", info.getSize());
+	record += tmpStr;
 #ifdef DEBUG
 	cout << "XapianIndex::setDocumentData: document data is " << record << endl;
 #endif
@@ -629,6 +638,11 @@
 					}
 				}
 				docInfo.setTimestamp(timestamp);
+				string bytesSize(StringManip::extractField(record, "size=", "\n"));
+				if (bytesSize.empty() == false)
+				{
+					docInfo.setSize((off_t )atol(bytesSize.c_str()));
+				}
 				foundDocument = true;
 			}
 		}
@@ -1008,6 +1022,7 @@
 		DocumentInfo docInfo(pDocument->getTitle(), pDocument->getLocation(),
 			pDocument->getType(), pDocument->getLanguage());
 		docInfo.setTimestamp(pDocument->getTimestamp());
+		docInfo.setSize(pDocument->getSize());
 		docInfo.setLocation(Url::canonicalizeUrl(docInfo.getLocation()));
 
 		const char *pData = pDocument->getData(dataLength);
@@ -1085,6 +1100,7 @@
 	DocumentInfo docInfo(pDocument->getTitle(), pDocument->getLocation(),
 		pDocument->getType(), pDocument->getLanguage());
 	docInfo.setTimestamp(pDocument->getTimestamp());
+	docInfo.setSize(pDocument->getSize());
 	docInfo.setLocation(Url::canonicalizeUrl(docInfo.getLocation()));
 
 	// Don't scan the document if a language is specified

Modified: trunk/Index/pinot-index.cpp
===================================================================
--- trunk/Index/pinot-index.cpp	2006-11-22 13:13:41 UTC (rev 594)
+++ trunk/Index/pinot-index.cpp	2006-11-23 13:02:56 UTC (rev 595)
@@ -236,6 +236,7 @@
 			cout << "Type: " << docInfo.getType() << endl;
 			cout << "Language: " << docInfo.getLanguage() << endl;
 			cout << "Timestamp: " << docInfo.getTimestamp() << endl;
+			cout << "Size: " << docInfo.getSize() << endl;
 		}
 		if (pIndex->getDocumentLabels(docId, labels) == true)
 		{

Modified: trunk/SQL/ActionQueue.cpp
===================================================================
--- trunk/SQL/ActionQueue.cpp	2006-11-22 13:13:41 UTC (rev 594)
+++ trunk/SQL/ActionQueue.cpp	2006-11-23 13:02:56 UTC (rev 595)
@@ -18,6 +18,8 @@
 
 #include <sys/types.h>
 #include <sys/stat.h>
+#include <stdio.h>
+#include <stdlib.h>
 #include <unistd.h>
 #include <iostream>
 
@@ -145,6 +147,11 @@
 	info += "modtime=";
 	info += docInfo.getTimestamp();
 	info += "\n";
+	info += "size=";
+	char sizeStr[64];
+	snprintf(sizeStr, 64, "%ld", docInfo.getSize());
+	info += sizeStr;
+	info += "\n";
 
 	if (update == false)
 	{
@@ -230,12 +237,18 @@
 			docInfo.setType(StringManip::extractField(info, "type=", "\n"));
 			docInfo.setLanguage(StringManip::extractField(info, "language=", "\n"));
 			docInfo.setTimestamp(StringManip::extractField(info, "modtime=", "\n"));
+			string bytesSize(StringManip::extractField(info, "size=", "\n"));
+			if (bytesSize.empty() == false)
+			{
+				docInfo.setSize((off_t )atol(bytesSize.c_str()));
+			}
 #ifdef DEBUG
 			cout << "ActionQueue::getOldestItem: " << docInfo.getTitle() << ", "
 				<< docInfo.getLocation() << ", "
 				<< docInfo.getType() << ", "
 				<< docInfo.getLanguage() << ", "
-				<< docInfo.getTimestamp() << endl;
+				<< docInfo.getTimestamp() << ", "
+				<< docInfo.getSize() << endl;
 #endif
 
 			delete row;

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-22 13:13:41 UTC (rev 594)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-23 13:02:56 UTC (rev 595)
@@ -742,10 +742,10 @@
 				type = "text/html";
 			}
 
-			string date = docInfo.getTimestamp();
 			IndexedDocument indexedDoc(docInfo.getTitle(), url, docInfo.getLocation(),
 				type, docInfo.getLanguage());
-			indexedDoc.setTimestamp(date);
+			indexedDoc.setTimestamp(docInfo.getTimestamp());
+			indexedDoc.setSize(docInfo.getSize());
 
 			// Signal
 			m_signalUpdate(indexedDoc, docId, m_indexName);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-11-22 13:13:41 UTC (rev 594)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-11-23 13:02:56 UTC (rev 595)
@@ -1188,6 +1188,7 @@
 						docInfo.getLocation(), docInfo.getType(),
 						docInfo.getLanguage());
 					indexedDoc.setTimestamp(docInfo.getTimestamp());
+					indexedDoc.setSize(docInfo.getSize());
 
 					append_document(pIndexPage, _("My Web Pages"), indexedDoc);
 				}
@@ -1913,6 +1914,8 @@
 		DocumentInfo docInfo(docIter->getTitle(), url,
 			docIter->getType(), docIter->getLanguage());
 		docInfo.setTimestamp(docIter->getTimestamp());
+		docInfo.setSize(docIter->getSize());
+
 		ustring status = m_state.queue_index(docInfo);
 		if (status.empty() == false)
 		{

Modified: trunk/Utils/DocumentInfo.cpp
===================================================================
--- trunk/Utils/DocumentInfo.cpp	2006-11-22 13:13:41 UTC (rev 594)
+++ trunk/Utils/DocumentInfo.cpp	2006-11-23 13:02:56 UTC (rev 595)
@@ -24,18 +24,20 @@
 using std::copy;
 using std::inserter;
 
-DocumentInfo::DocumentInfo()
+DocumentInfo::DocumentInfo() :
+	m_size(0)
 {
 	m_timestamp = TimeConverter::toTimestamp(time(NULL));
 }
 
 DocumentInfo::DocumentInfo(const string &title, const string &location,
-	const string &type, const string &language)
+	const string &type, const string &language) :
+	m_title(title),
+	m_location(location),
+	m_type(type),
+	m_language(language),
+	m_size(0)
 {
-	m_title = title;
-	m_location = location;
-	m_type = type;
-	m_language = language;
 	m_timestamp = TimeConverter::toTimestamp(time(NULL));
 }
 
@@ -44,7 +46,8 @@
 	m_location(other.m_location),
 	m_type(other.m_type),
 	m_language(other.m_language),
-	m_timestamp(other.m_timestamp)
+	m_timestamp(other.m_timestamp),
+	m_size(other.m_size)
 {
 	copy(other.m_labels.begin(), other.m_labels.end(),
 		inserter(m_labels, m_labels.begin()));
@@ -63,6 +66,7 @@
 		m_type = other.m_type;
 		m_language = other.m_language;
 		m_timestamp = other.m_timestamp;
+		m_size = other.m_size;
 		m_labels.clear();
 		copy(other.m_labels.begin(), other.m_labels.end(),
 			inserter(m_labels, m_labels.begin()));
@@ -140,6 +144,19 @@
 {
 	return m_timestamp;
 }
+
+/// Sets the document's size in bytes.
+void DocumentInfo::setSize(off_t size)
+{
+	m_size = size;
+}
+
+/// Returns the document's size in bytes.
+off_t DocumentInfo::getSize(void) const
+{
+	return m_size;
+}
+
 /// Sets the document's labels.
 void DocumentInfo::setLabels(const set<string> &labels)
 {



From fabricecolin at mail.berlios.de  Thu Nov 23 14:04:12 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Thu, 23 Nov 2006 14:04:12 +0100
Subject: [Pinot-svn] r596 - trunk/Utils
Message-ID: <200611231304.kAND4Cio010025@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-23 14:04:12 +0100 (Thu, 23 Nov 2006)
New Revision: 596

Modified:
   trunk/Utils/DocumentInfo.h
Log:
Missed this in previous commit.


Modified: trunk/Utils/DocumentInfo.h
===================================================================
--- trunk/Utils/DocumentInfo.h	2006-11-23 13:02:56 UTC (rev 595)
+++ trunk/Utils/DocumentInfo.h	2006-11-23 13:04:12 UTC (rev 596)
@@ -65,6 +65,12 @@
 		/// Returns the document's timestamp.
 		virtual std::string getTimestamp(void) const;
 
+		/// Sets the document's size in bytes.
+		virtual void setSize(off_t size);
+
+		/// Returns the document's size in bytes.
+		virtual off_t getSize(void) const;
+
 		/// Sets the document's labels.
 		virtual void setLabels(const std::set<std::string> &labels);
 
@@ -77,6 +83,7 @@
 		std::string m_type;
 		std::string m_language;
 		std::string m_timestamp;
+		off_t m_size;
 		std::set<std::string> m_labels;
 
 };



From fabricecolin at mail.berlios.de  Sat Nov 25 06:47:33 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 25 Nov 2006 06:47:33 +0100
Subject: [Pinot-svn] r597 - in trunk: Index Search UI/GTK2/src
Message-ID: <200611250547.kAP5lXDW014900@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-25 06:47:31 +0100 (Sat, 25 Nov 2006)
New Revision: 597

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/Search/XapianEngine.cpp
   trunk/UI/GTK2/src/queryDialog.cc
Log:
File extension stored in the index with prefix XEXT.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2006-11-23 13:04:12 UTC (rev 596)
+++ trunk/Index/XapianIndex.cpp	2006-11-25 05:47:31 UTC (rev 597)
@@ -381,7 +381,18 @@
 	string fileName(urlObj.getFile());
 	if (fileName.empty() == false)
 	{
+		string extension;
+
 		doc.add_term(limitTermLength(string("P") + StringManip::toLowerCase(fileName), true));
+
+		// Does it have an extension ?
+		string::size_type extPos = fileName.rfind('.');
+		if ((extPos != string::npos) &&
+			(extPos + 1 < fileName.length()))
+		{
+			extension = StringManip::toLowerCase(fileName.substr(extPos + 1));
+		}
+		doc.add_term(limitTermLength(string("XEXT:") + extension));
 	}
 	// Finally, add the language code with prefix L
 	doc.add_term(string("L") + Languages::toCode(m_stemLanguage));
@@ -476,7 +487,18 @@
 	string fileName(urlObj.getFile());
 	if (fileName.empty() == false)
 	{
+		string extension;
+
 		doc.remove_term(limitTermLength(string("P") + StringManip::toLowerCase(fileName), true));
+
+		// Does it have an extension ?
+		string::size_type extPos = fileName.rfind('.');
+		if ((extPos != string::npos) &&
+			(extPos + 1 < fileName.length()))
+		{
+			extension = StringManip::toLowerCase(fileName.substr(extPos + 1));
+		}
+		doc.remove_term(limitTermLength(string("XEXT:") + extension));
 	}
 	// Language code
 	doc.remove_term(string("L") + Languages::toCode(language));

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2006-11-23 13:04:12 UTC (rev 596)
+++ trunk/Search/XapianEngine.cpp	2006-11-25 05:47:31 UTC (rev 597)
@@ -97,6 +97,7 @@
 	// X prefixes should always include a colon
 	parser.add_boolean_prefix("site", "H");
 	parser.add_boolean_prefix("file", "P");
+	parser.add_boolean_prefix("ext", "XEXT:");
 	parser.add_boolean_prefix("title", "S");
 	parser.add_boolean_prefix("url", "U");
 	parser.add_boolean_prefix("dir", "XDIR:");

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2006-11-23 13:04:12 UTC (rev 596)
+++ trunk/UI/GTK2/src/queryDialog.cc	2006-11-25 05:47:31 UTC (rev 597)
@@ -106,6 +106,9 @@
 	row[m_filterColumns.m_name] = _("File name");
 	iter = m_refFilterTree->append();
 	row = *iter;
+	row[m_filterColumns.m_name] = _("File extension");
+	iter = m_refFilterTree->append();
+	row = *iter;
 	row[m_filterColumns.m_name] = _("Title");
 	iter = m_refFilterTree->append();
 	row = *iter;
@@ -201,21 +204,24 @@
 			filter = "file";
 			break;
 		case 2:
+			filter = "ext";
+			break;
+		case 3:
 			filter = "title";
 			break;
-		case 3:
+		case 4:
 			filter = "url";
 			break;
-		case 4:
+		case 5:
 			filter = "dir";
 			break;
-		case 5:
+		case 6:
 			filter = "lang";
 			break;
-		case 6:
+		case 7:
 			filter = "type";
 			break;
-		case 7:
+		case 8:
 			filter = "label";
 			break;
 		default:



From fabricecolin at mail.berlios.de  Sat Nov 25 06:57:12 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 25 Nov 2006 06:57:12 +0100
Subject: [Pinot-svn] r598 - trunk/Utils
Message-ID: <200611250557.kAP5vC6B026281@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-25 06:57:11 +0100 (Sat, 25 Nov 2006)
New Revision: 598

Modified:
   trunk/Utils/CommandLine.cpp
   trunk/Utils/CommandLine.h
Log:
Static method to shell-quote strings.


Modified: trunk/Utils/CommandLine.cpp
===================================================================
--- trunk/Utils/CommandLine.cpp	2006-11-25 05:47:31 UTC (rev 597)
+++ trunk/Utils/CommandLine.cpp	2006-11-25 05:57:11 UTC (rev 598)
@@ -37,6 +37,12 @@
 {
 }
 
+/// Quotes a string so that the shell will interpret the quoted string to mean str.
+string CommandLine::quote(const string &str)
+{
+	return Glib::shell_quote(str);
+}
+
 /// Runs a command synchronously.
 bool CommandLine::runSync(const string &commandLine, string &output)
 {
@@ -53,7 +59,8 @@
 		return true;
 	}
 #ifdef DEBUG
-	cout << "CommandLine::runSync: exit status is " << exitStatus << endl;
+	cout << "CommandLine::runSync: exit status is " << exitStatus
+		<< " for \"" << commandLine << "\"" << endl;
 #endif
 
 	return false;

Modified: trunk/Utils/CommandLine.h
===================================================================
--- trunk/Utils/CommandLine.h	2006-11-25 05:47:31 UTC (rev 597)
+++ trunk/Utils/CommandLine.h	2006-11-25 05:57:11 UTC (rev 598)
@@ -29,6 +29,9 @@
 	public:
 		~CommandLine();
 
+		/// Quotes a string so that the shell will interpret the quoted string to mean str.
+		static std::string quote(const std::string &str);
+
 		/// Runs a command synchronously.
 		static bool runSync(const std::string &commandLine, std::string &output);
 



From fabricecolin at mail.berlios.de  Sat Nov 25 07:04:38 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 25 Nov 2006 07:04:38 +0100
Subject: [Pinot-svn] r599 - in trunk: Collect Tokenize UI/GTK2/src Utils
Message-ID: <200611250604.kAP64cju000390@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-25 07:04:36 +0100 (Sat, 25 Nov 2006)
New Revision: 599

Modified:
   trunk/Collect/CurlDownloader.cpp
   trunk/Tokenize/HtmlTokenizer.cpp
   trunk/Tokenize/OpenDocumentTokenizer.cpp
   trunk/Tokenize/OpenDocumentTokenizer.h
   trunk/Tokenize/PdfTokenizer.cpp
   trunk/Tokenize/PdfTokenizer.h
   trunk/Tokenize/RtfTokenizer.cpp
   trunk/Tokenize/RtfTokenizer.h
   trunk/Tokenize/TagLibTokenizer.cpp
   trunk/Tokenize/TagLibTokenizer.h
   trunk/Tokenize/Tokenizer.cpp
   trunk/Tokenize/Tokenizer.h
   trunk/Tokenize/TokenizerFactory.cpp
   trunk/Tokenize/TokenizerFactory.h
   trunk/Tokenize/WordTokenizer.cpp
   trunk/Tokenize/WordTokenizer.h
   trunk/Tokenize/XmlTokenizer.cpp
   trunk/UI/GTK2/src/DaemonState.cpp
   trunk/UI/GTK2/src/DaemonState.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/Utils/MboxParser.cpp
   trunk/Utils/MboxParser.h
Log:
Preserve size and timestamp attributes determined when documents are retrieved,
by a crawl, a download or an adapter.
Don't load files that are going to be handled by helper applications that can
access them directly.


Modified: trunk/Collect/CurlDownloader.cpp
===================================================================
--- trunk/Collect/CurlDownloader.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Collect/CurlDownloader.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -183,6 +183,7 @@
 				pDocument = new Document(docInfo);
 				pDocument->setData(pContentInfo->m_pContent, pContentInfo->m_contentLen);
 				pDocument->setLocation(url);
+				pDocument->setSize((off_t )pContentInfo->m_contentLen);
 
 				// What's the Content-Type ?
 				res = curl_easy_getinfo(pCurlHandler, CURLINFO_CONTENT_TYPE, &pContentType);

Modified: trunk/Tokenize/HtmlTokenizer.cpp
===================================================================
--- trunk/Tokenize/HtmlTokenizer.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/HtmlTokenizer.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -518,6 +518,8 @@
 			pDocument->getLocation(), pDocument->getType(),
 			pDocument->getLanguage());
 		m_pStrippedDocument->setData(m_state.m_text.c_str(), m_state.m_text.length());
+		m_pStrippedDocument->setTimestamp(pDocument->getTimestamp());
+		m_pStrippedDocument->setSize(pDocument->getSize());
 
 		setDocument(m_pStrippedDocument);
 	}

Modified: trunk/Tokenize/OpenDocumentTokenizer.cpp
===================================================================
--- trunk/Tokenize/OpenDocumentTokenizer.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/OpenDocumentTokenizer.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -56,6 +56,12 @@
 	return true;
 }
 
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void)
+{
+	return Tokenizer::ALL_BUT_FILES;
+}
+
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument)
 {
@@ -82,6 +88,9 @@
 				pDocument->getLocation(), pDocument->getType(),
 				pDocument->getLanguage());
 			m_pStrippedDocument->setData(strippedData.c_str(), strippedData.length());
+			m_pStrippedDocument->setTimestamp(pDocument->getTimestamp());
+			m_pStrippedDocument->setSize(pDocument->getSize());
+
 			setDocument(m_pStrippedDocument);
 		}
 

Modified: trunk/Tokenize/OpenDocumentTokenizer.h
===================================================================
--- trunk/Tokenize/OpenDocumentTokenizer.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/OpenDocumentTokenizer.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -27,6 +27,8 @@
 
 /// This returns the MIME types supported by the library's tokenizer.
 bool getTokenizerTypes(std::set<std::string> &types);
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void);
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument);
 

Modified: trunk/Tokenize/PdfTokenizer.cpp
===================================================================
--- trunk/Tokenize/PdfTokenizer.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/PdfTokenizer.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -33,6 +33,12 @@
 	return true;
 }
 
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void)
+{
+	return Tokenizer::ALL_BUT_FILES;
+}
+
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument)
 {

Modified: trunk/Tokenize/PdfTokenizer.h
===================================================================
--- trunk/Tokenize/PdfTokenizer.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/PdfTokenizer.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -27,6 +27,8 @@
 
 /// This returns the MIME types supported by the library's tokenizer.
 bool getTokenizerTypes(std::set<std::string> &types);
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void);
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument);
 

Modified: trunk/Tokenize/RtfTokenizer.cpp
===================================================================
--- trunk/Tokenize/RtfTokenizer.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/RtfTokenizer.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -34,6 +34,12 @@
 	return true;
 }
 
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void)
+{
+	return Tokenizer::ALL_BUT_FILES;
+}
+
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument)
 {
@@ -53,6 +59,8 @@
 				pHtmlDocument->getLocation(), pHtmlDocument->getType(),
 				pHtmlDocument->getLanguage());
 			m_pStrippedDocument->setData(m_state.m_text.c_str(), m_state.m_text.length());
+			m_pStrippedDocument->setTimestamp(pHtmlDocument->getTimestamp());
+			m_pStrippedDocument->setSize(pHtmlDocument->getSize());
 
 			setDocument(m_pStrippedDocument);
 		}

Modified: trunk/Tokenize/RtfTokenizer.h
===================================================================
--- trunk/Tokenize/RtfTokenizer.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/RtfTokenizer.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -27,6 +27,8 @@
 
 /// This returns the MIME types supported by the library's tokenizer.
 bool getTokenizerTypes(std::set<std::string> &types);
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void);
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument);
 

Modified: trunk/Tokenize/TagLibTokenizer.cpp
===================================================================
--- trunk/Tokenize/TagLibTokenizer.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/TagLibTokenizer.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -42,6 +42,12 @@
 	return true;
 }
 
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void)
+{
+	return Tokenizer::ALL_DOCUMENTS;
+}
+
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument)
 {
@@ -99,6 +105,8 @@
 			m_pTagDocument = new Document(trackTitle, pDocument->getLocation(),
 				pDocument->getType(), pDocument->getLanguage());
 			m_pTagDocument->setData(pseudoContent.c_str(), pseudoContent.length());
+			m_pTagDocument->setTimestamp(pDocument->getTimestamp());
+			m_pTagDocument->setSize(pDocument->getSize());
 
 			// Give the result to the parent class
 			setDocument(m_pTagDocument);

Modified: trunk/Tokenize/TagLibTokenizer.h
===================================================================
--- trunk/Tokenize/TagLibTokenizer.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/TagLibTokenizer.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -27,6 +27,8 @@
 
 /// This returns the MIME types supported by the library's tokenizer.
 bool getTokenizerTypes(std::set<std::string> &types);
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void);
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument);
 

Modified: trunk/Tokenize/Tokenizer.cpp
===================================================================
--- trunk/Tokenize/Tokenizer.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/Tokenizer.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -49,6 +49,7 @@
 {
 	Document *pOutputDocument = NULL;
 	char inTemplate[15] = "/tmp/tokXXXXXX";
+	bool deleteInFile = false;
 
 	if ((pDocument == NULL) ||
 		(programName.empty() == true))
@@ -56,49 +57,75 @@
 		return NULL;
 	}
 
-	int inFd = mkstemp(inTemplate);
-	if (inFd != -1)
+	string cmdLine(programName);
+	string output;
+	unsigned int dataLength = 0;
+	const char *pData = pDocument->getData(dataLength);
+
+	cmdLine += " ";
+	if (pData == NULL)
 	{
-		unsigned int dataLength = 0;
-		const char *pData = pDocument->getData(dataLength);
+		Url urlObj(pDocument->getLocation());
 
-		// Save the data into a temporary file
-		if (write(inFd, (const void*)pData, dataLength) != -1)
+		if (urlObj.getProtocol() != "file")
 		{
-			string cmdLine(programName);
-			string output;
+			// Not much we can do I am afraid
+			return NULL;
+		}
 
-			cmdLine += " ";
-			cmdLine += inTemplate;
-			if (arguments.empty() == false)
+		// Point the helper program to the actual file
+		string fileName(urlObj.getLocation());
+		fileName += "/";
+		fileName += urlObj.getFile();
+		cmdLine += CommandLine::quote(fileName);
+	}
+	else
+	{
+		int inFd = mkstemp(inTemplate);
+
+		if (inFd != -1)
+		{
+			// Save the data into a temporary file
+			if (write(inFd, (const void*)pData, dataLength) != -1)
 			{
-				cmdLine += " ";
-				cmdLine += arguments;
-				cmdLine += " ";
+				cmdLine += inTemplate;
 			}
 
-			// Run the helper program
-			if ((CommandLine::runSync(cmdLine, output) == true) &&
-				(output.empty() == false))
-			{
-				// Pass the result to the parent class
-				pOutputDocument = new Document(pDocument->getTitle(),
-					pDocument->getLocation(), pDocument->getType(),
-					pDocument->getLanguage());
-				pOutputDocument->setData(output.c_str(), output.length());
-#ifdef DEBUG_TOKENIZER
-				cout << "Tokenizer::runHelperProgram: set " << output.length()
-					<< " bytes of data" << endl;
-#endif
-			}
+			deleteInFile = true;
+			close(inFd);
 		}
 	}
 
-	close(inFd);
+	// Any argument ?
+	if (arguments.empty() == false)
+	{
+		cmdLine += " ";
+		cmdLine += arguments;
+		cmdLine += " ";
+	}
 
-	if (unlink(inTemplate) != 0)
+	// Run the helper program
+	if ((CommandLine::runSync(cmdLine, output) == true) &&
+		(output.empty() == false))
 	{
+		// Pass the result to the parent class
+		pOutputDocument = new Document(pDocument->getTitle(),
+			pDocument->getLocation(), pDocument->getType(),
+			pDocument->getLanguage());
+		pOutputDocument->setData(output.c_str(), output.length());
+		pOutputDocument->setTimestamp(pDocument->getTimestamp());
+		pOutputDocument->setSize(pDocument->getSize());
+
 #ifdef DEBUG_TOKENIZER
+		cout << "Tokenizer::runHelperProgram: set " << output.length()
+			<< " bytes of data" << endl;
+#endif
+	}
+
+	if ((deleteInFile == true) &&
+		(unlink(inTemplate) != 0))
+	{
+#ifdef DEBUG_TOKENIZER
 		cout << "Tokenizer::runHelperProgram: couldn't delete temporary file" << endl;
 #endif
 	}

Modified: trunk/Tokenize/Tokenizer.h
===================================================================
--- trunk/Tokenize/Tokenizer.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/Tokenizer.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -29,6 +29,8 @@
 		Tokenizer(const Document *pDocument);
 		virtual ~Tokenizer();
 
+		typedef enum { ALL_DOCUMENTS = 0, ALL_BUT_FILES } DataNeeds;
+
 		/// Converts a document using an helper program.
 		static Document *runHelperProgram(const Document *pDocument,
 			const std::string &programName, const std::string &arguments = "");

Modified: trunk/Tokenize/TokenizerFactory.cpp
===================================================================
--- trunk/Tokenize/TokenizerFactory.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/TokenizerFactory.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -41,6 +41,7 @@
 #endif
 
 #define GETTOKENIZERTYPES	"_Z17getTokenizerTypesRSt3setISsSt4lessISsESaISsEE"
+#define GETTOKENIZERDATANEEDS	"_Z21getTokenizerDataNeedsv"
 #define GETTOKENIZER		"_Z12getTokenizerPK8Document"
 
 using std::cout;
@@ -52,6 +53,7 @@
 
 map<string, string> TokenizerFactory::m_types;
 map<string, void *> TokenizerFactory::m_handles;
+map<string, Tokenizer::DataNeeds> TokenizerFactory::m_dataNeeds;
 
 TokenizerFactory::TokenizerFactory()
 {
@@ -161,13 +163,23 @@
 					void *pHandle = dlopen(fileName.c_str(), DLOPEN_FLAGS);
 					if (pHandle != NULL)
 					{
+						Tokenizer::DataNeeds dataNeeds = Tokenizer::ALL_DOCUMENTS;
+
+						// What documents's data does it need ?
+						getTokenizerDataNeedsFunc *pDataFunc = (getTokenizerDataNeedsFunc *)dlsym(pHandle,
+							GETTOKENIZERDATANEEDS);
+						if (pDataFunc != NULL)
+						{
+							dataNeeds = (Tokenizer::DataNeeds )(*pDataFunc)();
+						}
+
 						// What type(s) does this support ?
-						getTokenizerTypesFunc *pFunc = (getTokenizerTypesFunc *)dlsym(pHandle,
+						getTokenizerTypesFunc *pTypesFunc = (getTokenizerTypesFunc *)dlsym(pHandle,
 								GETTOKENIZERTYPES);
-						if (pFunc != NULL)
+						if (pTypesFunc != NULL)
 						{
 							set<string> types;
-							bool tokenizerOkay = (*pFunc)(types);
+							bool tokenizerOkay = (*pTypesFunc)(types);
 
 							if (tokenizerOkay == true)
 							{
@@ -178,11 +190,13 @@
 									m_types[*typeIter] = fileName;
 #ifdef DEBUG
 									cout << "TokenizerFactory::loadTokenizers: type "
-										<< *typeIter << " supported by " << pEntryName << endl;
+										<< *typeIter << ", " << dataNeeds
+										<< " is supported by " << pEntryName << endl;
 #endif
 								}
 
 								m_handles[fileName] = pHandle;
+								m_dataNeeds[fileName] = dataNeeds;
 							}
 						}
 						else cerr << "TokenizerFactory::loadTokenizers: " << dlerror() << endl;
@@ -293,19 +307,18 @@
 	}
 }
 
-bool TokenizerFactory::isSupportedType(const string &type)
+bool TokenizerFactory::isSupportedType(const string &type, Tokenizer::DataNeeds &dataNeeds)
 {
 	string typeOnly = type;
 	string::size_type semiColonPos = type.find(";");
 
+	dataNeeds = Tokenizer::ALL_DOCUMENTS;
+
 	// Remove the charset, if any
 	if (semiColonPos != string::npos)
 	{
 		typeOnly = type.substr(0, semiColonPos);
 	}
-#ifdef DEBUG
-	cout << "TokenizerFactory::isSupportedType: file type is " << typeOnly << endl;
-#endif
 
 	// Is it a built-in type ?
 	if ((typeOnly == "text/html") ||
@@ -320,6 +333,17 @@
 	map<string, string>::iterator typeIter = m_types.find(typeOnly);
 	if (typeIter != m_types.end())
 	{
+		// What does it need ?
+		map<string, Tokenizer::DataNeeds>::iterator dataNeedsIter = m_dataNeeds.find(typeIter->second);
+		if (dataNeedsIter != m_dataNeeds.end())
+		{
+			dataNeeds = dataNeedsIter->second;
+		}
+#ifdef DEBUG
+		cout << "TokenizerFactory::isSupportedType: library-handled type "
+			<< typeOnly << " " << dataNeeds << endl;
+#endif
+
 		return true;
 	}
 

Modified: trunk/Tokenize/TokenizerFactory.h
===================================================================
--- trunk/Tokenize/TokenizerFactory.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/TokenizerFactory.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -35,6 +35,8 @@
 		  * The character string is allocated with new[].
 		  */
 		typedef bool (getTokenizerTypesFunc)(std::set<std::string> &);
+		/// This returns the data needs of the provided Tokenizer(s).
+		typedef int (getTokenizerDataNeedsFunc)(void);
 		/// This returns a pointer to a Tokenizer, allocated with new.
 		typedef Tokenizer *(getTokenizerFunc)(const Document *);
 
@@ -51,7 +53,7 @@
 		static void getSupportedTypes(std::set<std::string> &types);
 
 		/// Indicates whether a MIME type is supported or not.
-		static bool isSupportedType(const std::string &type);
+		static bool isSupportedType(const std::string &type, Tokenizer::DataNeeds &dataNeeds);
 
 		/// Unloads all tokenizer libraries.
 		static void unloadTokenizers(void);
@@ -59,6 +61,7 @@
 	protected:
 		static std::map<std::string, std::string> m_types;
 		static std::map<std::string, void *> m_handles;
+		static std::map<std::string, Tokenizer::DataNeeds> m_dataNeeds;
 
 		TokenizerFactory();
 

Modified: trunk/Tokenize/WordTokenizer.cpp
===================================================================
--- trunk/Tokenize/WordTokenizer.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/WordTokenizer.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -33,6 +33,12 @@
 	return true;
 }
 
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void)
+{
+	return Tokenizer::ALL_BUT_FILES;
+}
+
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument)
 {
@@ -40,22 +46,22 @@
 }
 
 WordTokenizer::WordTokenizer(const Document *pDocument) :
-	Tokenizer(NULL)
+	Tokenizer(NULL),
+	m_pStrippedDocument(NULL)
 {
 	// Run antiword
-	Document *pOutputDocument = runHelperProgram(pDocument, "antiword");
-	if (pOutputDocument != NULL)
+	m_pStrippedDocument = runHelperProgram(pDocument, "antiword");
+	if (m_pStrippedDocument != NULL)
 	{
 		// Give the result to the parent class
-		setDocument(pOutputDocument);
+		setDocument(m_pStrippedDocument);
 	}
 }
 
 WordTokenizer::~WordTokenizer()
 {
-	if (m_pDocument != NULL)
+	if (m_pStrippedDocument != NULL)
 	{
-		// This should have been set by setDocument()
-		delete m_pDocument;
+		delete m_pStrippedDocument;
 	}
 }

Modified: trunk/Tokenize/WordTokenizer.h
===================================================================
--- trunk/Tokenize/WordTokenizer.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/WordTokenizer.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -27,6 +27,8 @@
 
 /// This returns the MIME types supported by the library's tokenizer.
 bool getTokenizerTypes(std::set<std::string> &types);
+/// This returns the data needs of the provided Tokenizer(s).
+int getTokenizerDataNeeds(void);
 /// This returns a pointer to a Tokenizer, allocated with new.
 Tokenizer *getTokenizer(const Document *pDocument);
 
@@ -36,6 +38,9 @@
 		WordTokenizer(const Document *pDocument);
 		virtual ~WordTokenizer();
 
+	protected:
+		Document *m_pStrippedDocument;
+
 	private:
 		WordTokenizer(const WordTokenizer &other);
 		WordTokenizer& operator=(const WordTokenizer& other);

Modified: trunk/Tokenize/XmlTokenizer.cpp
===================================================================
--- trunk/Tokenize/XmlTokenizer.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Tokenize/XmlTokenizer.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -48,6 +48,9 @@
 				pDocument->getLocation(), pDocument->getType(),
 				pDocument->getLanguage());
 			m_pStrippedDocument->setData(strippedData.c_str(), strippedData.length());
+			m_pStrippedDocument->setTimestamp(pDocument->getTimestamp());
+			m_pStrippedDocument->setSize(pDocument->getSize());
+
 			setDocument(m_pStrippedDocument);
 		}
 	}

Modified: trunk/UI/GTK2/src/DaemonState.cpp
===================================================================
--- trunk/UI/GTK2/src/DaemonState.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/UI/GTK2/src/DaemonState.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -218,22 +218,23 @@
 	pop_queue(indexedUrl);
 }
 
-void DaemonState::on_message_filefound(const string &location, const string &sourceLabel, bool isDirectory)
+void DaemonState::on_message_filefound(const DocumentInfo &docInfo, const string &sourceLabel, bool isDirectory)
 {
 	if (isDirectory == false)
 	{
-		Url urlObj(location);
-		DocumentInfo docInfo(urlObj.getFile(), location, "", "");
+		DocumentInfo docCopy(docInfo);
 		set<string> labels;
 
 		// Insert a label that identifies the source
 		labels.insert(sourceLabel);
-		docInfo.setLabels(labels);
+		docCopy.setLabels(labels);
 
-		queue_index(docInfo);
+		queue_index(docCopy);
 	}
 	else
 	{
+		string location(docInfo.getLocation());
+
 		crawlLocation(location.substr(7), false, true);
 #ifdef DEBUG
 		cout << "DaemonState::on_message_filefound: new directory " << location.substr(7) << endl;

Modified: trunk/UI/GTK2/src/DaemonState.h
===================================================================
--- trunk/UI/GTK2/src/DaemonState.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/UI/GTK2/src/DaemonState.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -39,7 +39,7 @@
 
 		void on_thread_end(WorkerThread *pThread);
 
-		void on_message_filefound(const std::string &location, const std::string &sourceLabel,
+		void on_message_filefound(const DocumentInfo &docInfo, const std::string &sourceLabel,
 			bool isDirectory);
 
 	protected:

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -1135,6 +1135,9 @@
 void IndexingThread::doWork(void)
 {
 	IndexInterface *pIndex = PinotSettings::getInstance().getIndex(m_indexLocation);
+	Url thisUrl(m_docInfo.getLocation());
+	Tokenizer::DataNeeds dataNeeds;
+	bool doDownload = true;
 
 	// First things first, get the index
 	if ((pIndex == NULL) ||
@@ -1150,10 +1153,50 @@
 		return;
 	}
 
-	DownloadingThread::doWork();
+	// We may not have to download the document
+	if (thisUrl.getProtocol() == "file")
+	{
+		// If coming from a crawl, this will be empty
+		if (m_docInfo.getType().empty() == true)
+		{
+			m_docInfo.setType(MIMEScanner::scanFile(m_docInfo.getLocation()));
+		}
+
+		if (TokenizerFactory::isSupportedType(m_docInfo.getType(), dataNeeds) == false)
+		{
+			// Skip unsupported types ?
+			if (m_allowAllMIMETypes == false)
+			{
+				m_status = _("Cannot index document type");
+				m_status += " ";
+				m_status += m_docInfo.getType();
+				m_status += " ";
+				m_status += _("at");
+				m_status += " ";
+				m_status += m_docInfo.getLocation();
+				return;
+			}
+		}
+		else if (dataNeeds == Tokenizer::ALL_BUT_FILES)
+		{
+			doDownload = false;
+		}
+	}
+
+	if (doDownload == true)
+	{
+		DownloadingThread::doWork();
 #ifdef DEBUG
-	cout << "IndexingThread::doWork: downloaded " << m_docInfo.getLocation() << endl;
+		cout << "IndexingThread::doWork: downloaded " << m_docInfo.getLocation() << endl;
 #endif
+	}
+	else
+	{
+		m_pDoc = new Document(m_docInfo);
+#ifdef DEBUG
+		cout << "IndexingThread::doWork: skipped download of " << m_docInfo.getLocation() << endl;
+#endif
+	}
 
 	if (m_pDoc != NULL)
 	{
@@ -1185,7 +1228,8 @@
 		cout << "IndexingThread::doWork: title is " << m_pDoc->getTitle() << endl;
 #endif
 
-		if (TokenizerFactory::isSupportedType(m_docInfo.getType()) == false)
+		// Check again as the downloader may have altered the MIME type
+		if (TokenizerFactory::isSupportedType(m_docInfo.getType(), dataNeeds) == false)
 		{
 			// Skip unsupported types ?
 			if (m_allowAllMIMETypes == false)
@@ -1526,8 +1570,8 @@
 bool MonitorThread::stop(void)
 {
 	// Disconnect the signal
-	Signal3<void, const string&, const std::string&, bool>::slot_list_type slotsList = m_signalDirectoryFound.slots();
-	Signal3<void, const string&, const std::string&, bool>::slot_list_type::iterator slotIter = slotsList.begin();
+	Signal3<void, const DocumentInfo&, const std::string&, bool>::slot_list_type slotsList = m_signalDirectoryFound.slots();
+	Signal3<void, const DocumentInfo&, const std::string&, bool>::slot_list_type::iterator slotIter = slotsList.begin();
 	if (slotIter != slotsList.end())
 	{
 		if (slotIter->empty() == false)
@@ -1542,7 +1586,7 @@
 	return true;
 }
 
-Signal3<void, const string&, const std::string&, bool>& MonitorThread::getDirectoryFoundSignal(void)
+Signal3<void, const DocumentInfo&, const std::string&, bool>& MonitorThread::getDirectoryFoundSignal(void)
 {
 	return m_signalDirectoryFound;
 }
@@ -1600,8 +1644,10 @@
 			}
 			else
 			{
+				DocumentInfo docInfo("", string("file://") + event.m_location, "", "");
+
 				// Report this directory so that it is crawled
-				m_signalDirectoryFound(string("file://") + event.m_location, "", true);
+				m_signalDirectoryFound(docInfo, "", true);
 			}
 		}
 		else if (event.m_type == MonitorEvent::WRITE_CLOSED)
@@ -1794,8 +1840,8 @@
 bool DirectoryScannerThread::stop(void)
 {
 	// Disconnect the signal
-	Signal3<void, const string&, const std::string&, bool>::slot_list_type slotsList = m_signalFileFound.slots();
-	Signal3<void, const string&, const std::string&, bool>::slot_list_type::iterator slotIter = slotsList.begin();
+	Signal3<void, const DocumentInfo&, const std::string&, bool>::slot_list_type slotsList = m_signalFileFound.slots();
+	Signal3<void, const DocumentInfo&, const std::string&, bool>::slot_list_type::iterator slotIter = slotsList.begin();
 	if (slotIter != slotsList.end())
 	{
 		if (slotIter->empty() == false)
@@ -1809,16 +1855,16 @@
 	return true;
 }
 
-Signal3<void, const string&, const std::string&, bool>& DirectoryScannerThread::getFileFoundSignal(void)
+Signal3<void, const DocumentInfo&, const std::string&, bool>& DirectoryScannerThread::getFileFoundSignal(void)
 {
 	return m_signalFileFound;
 }
 
-void DirectoryScannerThread::foundFile(const string &fileName)
+void DirectoryScannerThread::foundFile(const DocumentInfo &docInfo)
 {
 	char labelStr[64];
 
-	if ((fileName.empty() == true) ||
+	if ((docInfo.getLocation().empty() == true) ||
 		(m_done == true))
 	{
 		return;
@@ -1827,7 +1873,7 @@
 	// This identifies the source
 	snprintf(labelStr, 64, "SOURCE%u", m_sourceId);
 
-	m_signalFileFound(string("file://") + fileName, labelStr, false);
+	m_signalFileFound(docInfo, labelStr, false);
 }
 
 bool DirectoryScannerThread::scanEntry(const string &entryName)
@@ -1875,8 +1921,11 @@
 	}
 	else if (S_ISREG(fileStat.st_mode))
 	{
+		DocumentInfo docInfo;
 		bool reportFile = false;
 
+		docInfo.setLocation("file://" + entryName);
+
 		// Is this file blacklisted ?
 		// We have to check early so that if necessary the file's status stays at CRAWLING 
 		// and it is removed from the index at the end of this crawl
@@ -1885,7 +1934,7 @@
 			if (itemExists == false)
 			{
 				// Record it
-				history.insertItem("file://" + entryName, CrawlHistory::CRAWLED, m_sourceId, fileStat.st_mtime);
+				history.insertItem(docInfo.getLocation(), CrawlHistory::CRAWLED, m_sourceId, fileStat.st_mtime);
 #ifdef DEBUG
 				cout << "DirectoryScannerThread::scanEntry: reporting new file " << entryName << endl;
 #endif
@@ -1894,7 +1943,7 @@
 			else
 			{
 				// Update the record
-				history.updateItem("file://" + entryName, CrawlHistory::CRAWLED, fileStat.st_mtime);
+				history.updateItem(docInfo.getLocation(), CrawlHistory::CRAWLED, fileStat.st_mtime);
 
 				// Was it last crawled after it was modified ?
 				if (itemDate < fileStat.st_mtime)
@@ -1910,7 +1959,13 @@
 
 		if (reportFile == true)
 		{
-			foundFile(entryName);
+			Url urlObj(docInfo.getLocation());
+
+			docInfo.setTitle(urlObj.getFile());
+			docInfo.setTimestamp(TimeConverter::toTimestamp(fileStat.st_mtime));
+			docInfo.setSize(fileStat.st_size);
+
+			foundFile(docInfo);
 		}
 	}
 	else if (S_ISDIR(fileStat.st_mode))

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -405,14 +405,14 @@
 
 		virtual bool stop(void);
 
-		SigC::Signal3<void, const std::string&, const std::string&, bool>& getDirectoryFoundSignal(void);
+		SigC::Signal3<void, const DocumentInfo&, const std::string&, bool>& getDirectoryFoundSignal(void);
 
 	protected:
 		int m_ctrlReadPipe;
 		int m_ctrlWritePipe;
 		MonitorInterface *m_pMonitor;
 		MonitorHandler *m_pHandler;
-		SigC::Signal3<void, const std::string&, const std::string&, bool> m_signalDirectoryFound;
+		SigC::Signal3<void, const DocumentInfo&, const std::string&, bool> m_signalDirectoryFound;
 
 		void processEvents(void);
 		virtual void doWork(void);
@@ -437,7 +437,7 @@
 
 		virtual bool stop(void);
 
-		SigC::Signal3<void, const std::string&, const std::string&, bool>& getFileFoundSignal(void);
+		SigC::Signal3<void, const DocumentInfo&, const std::string&, bool>& getFileFoundSignal(void);
 
 	protected:
 		std::string m_dirName;
@@ -447,9 +447,9 @@
 		MonitorHandler *m_pHandler;
 		unsigned int m_currentLevel;
 		unsigned int m_sourceId;
-		SigC::Signal3<void, const std::string&, const std::string&, bool> m_signalFileFound;
+		SigC::Signal3<void, const DocumentInfo&, const std::string&, bool> m_signalFileFound;
 
-		void foundFile(const std::string &fileName);
+		void foundFile(const DocumentInfo &docInfo);
 		bool scanEntry(const std::string &entryName);
 		virtual void doWork(void);
 

Modified: trunk/Utils/MboxParser.cpp
===================================================================
--- trunk/Utils/MboxParser.cpp	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Utils/MboxParser.cpp	2006-11-25 06:04:36 UTC (rev 599)
@@ -42,8 +42,7 @@
 	m_partsCount(-1),
 	m_partNum(partNum),
 	m_messageStart(mboxOffset),
-	m_pCurrentDocument(NULL),
-	m_messageDate(0)
+	m_pCurrentDocument(NULL)
 {
 	if (initialize() == true)
 	{
@@ -302,11 +301,11 @@
 				const char *pDate = g_mime_message_get_header(m_pMimeMessage, "Date");
 				if (pDate != NULL)
 				{
-					m_messageDate = TimeConverter::fromTimestamp(pDate);
+					m_messageDate = pDate;
 				}
 				else
 				{
-					m_messageDate = 0;
+					m_messageDate = TimeConverter::toTimestamp(time(NULL));
 				}
 #ifdef DEBUG
 				cout << "MboxParser::extractMessage: message date is " << m_messageDate << endl;
@@ -354,6 +353,8 @@
 					// New document
 					m_pCurrentDocument = new Document(msgSubject, location, contentType, "");
 					m_pCurrentDocument->setData(pPart, (unsigned int)partLength);
+					m_pCurrentDocument->setTimestamp(m_messageDate);
+					m_pCurrentDocument->setSize((off_t )partLength);
 
 					free(pPart);
 					g_mime_object_unref(pMimePart);
@@ -375,12 +376,6 @@
 	return false;
 }
 
-/// Gets the current message's date.
-time_t MboxParser::getDate(void) const
-{
-	return m_messageDate;
-}
-
 /// Jumps to the next message.
 bool MboxParser::nextMessage(void)
 {

Modified: trunk/Utils/MboxParser.h
===================================================================
--- trunk/Utils/MboxParser.h	2006-11-25 05:57:11 UTC (rev 598)
+++ trunk/Utils/MboxParser.h	2006-11-25 06:04:36 UTC (rev 599)
@@ -46,9 +46,6 @@
 		MboxParser(const string &fileName, off_t mboxOffset = 0, int partNum = -1);
 		virtual ~MboxParser();
 
-		/// Gets the current message's date.
-		time_t getDate(void) const;
-
 		/// Jumps to the next message.
 		bool nextMessage(void);
 
@@ -65,7 +62,7 @@
 		int m_partNum;
 		off_t m_messageStart;
 		Document *m_pCurrentDocument;
-		time_t m_messageDate;
+		string m_messageDate;
 
 		bool initialize(void);
 



From fabricecolin at mail.berlios.de  Mon Nov 27 13:54:23 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Mon, 27 Nov 2006 13:54:23 +0100
Subject: [Pinot-svn] r600 - trunk/UI/GTK2/src
Message-ID: <200611271254.kARCsNQN032661@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-27 13:54:22 +0100 (Mon, 27 Nov 2006)
New Revision: 600

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
Log:
Found out that SigC::Object/sigc::trackable doesn't have a virtual destructor
for some obscure reason and that it should be inherited from virtually.
Fixing this can only be a good thing...


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-25 06:04:36 UTC (rev 599)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-11-27 12:54:22 UTC (rev 600)
@@ -149,11 +149,6 @@
 	return m_done;
 }
 
-void WorkerThread::reset(void)
-{
-	m_done = false;
-}
-
 string WorkerThread::getStatus(void) const
 {
 	return m_status;
@@ -189,7 +184,6 @@
 
 ThreadsManager::ThreadsManager(const string &defaultIndexLocation,
 	unsigned int maxIndexThreads) :
-	SigC::Object(),
 	m_defaultIndexLocation(defaultIndexLocation),
 	m_maxIndexThreads(maxIndexThreads),
 	m_nextThreadId(1),

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-11-25 06:04:36 UTC (rev 599)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-11-27 12:54:22 UTC (rev 600)
@@ -69,8 +69,6 @@
 
 		bool isDone(void) const;
 
-		void reset(void);
-
 		std::string getStatus(void) const;
 
 	protected:
@@ -95,7 +93,7 @@
 
 };
 
-class ThreadsManager : public SigC::Object
+class ThreadsManager : virtual public SigC::Object
 {
 	public:
 		ThreadsManager(const std::string &defaultIndexLocation,



From fabricecolin at mail.berlios.de  Mon Nov 27 15:25:47 2006
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Mon, 27 Nov 2006 15:25:47 +0100
Subject: [Pinot-svn] r601 - in trunk: UI/GTK2/src Utils
Message-ID: <200611271425.kAREPlQa032698@sheep.berlios.de>

Author: fabricecolin
Date: 2006-11-27 15:25:46 +0100 (Mon, 27 Nov 2006)
New Revision: 601

Modified:
   trunk/UI/GTK2/src/DaemonState.cpp
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/Utils/MboxParser.h
Log:
Cosmetic mods.


Modified: trunk/UI/GTK2/src/DaemonState.cpp
===================================================================
--- trunk/UI/GTK2/src/DaemonState.cpp	2006-11-27 12:54:22 UTC (rev 600)
+++ trunk/UI/GTK2/src/DaemonState.cpp	2006-11-27 14:25:46 UTC (rev 601)
@@ -212,7 +212,7 @@
 	}
 
 	// Delete the thread
-	delete pThread;;
+	delete pThread;
 
 	// We might be able to run a queued action
 	pop_queue(indexedUrl);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-11-27 12:54:22 UTC (rev 600)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-11-27 14:25:46 UTC (rev 601)
@@ -35,14 +35,12 @@
 #include <gtkmm/main.h>
 
 #include "CommandLine.h"
-#include "HtmlTokenizer.h"
 #include "IndexedDocument.h"
 #include "StringManip.h"
 #include "TimeConverter.h"
 #include "MIMEScanner.h"
 #include "Url.h"
 #include "XapianDatabase.h"
-#include "TokenizerFactory.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
 #include "DownloaderFactory.h"

Modified: trunk/Utils/MboxParser.h
===================================================================
--- trunk/Utils/MboxParser.h	2006-11-27 12:54:22 UTC (rev 600)
+++ trunk/Utils/MboxParser.h	2006-11-27 14:25:46 UTC (rev 601)
@@ -19,7 +19,6 @@
 #ifndef _MBOX_PARSER_H
 #define _MBOX_PARSER_H
 
-#include <time.h>
 #include <string>
 #include <map>
 #include <utility>



