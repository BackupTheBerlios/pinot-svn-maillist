From fabricecolin at mail.berlios.de  Sat Sep  1 05:48:50 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 1 Sep 2007 05:48:50 +0200
Subject: [Pinot-svn] r955 - in trunk: Index Search
Message-ID: <200709010348.l813moBv026296@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-01 05:48:49 +0200 (Sat, 01 Sep 2007)
New Revision: 955

Modified:
   trunk/Index/Makefile.am
   trunk/Search/Makefile.am
Log:
Applied patch by Gabriel C to fix dependencies, and hopefully, SMP builds.


Modified: trunk/Index/Makefile.am
===================================================================
--- trunk/Index/Makefile.am	2007-08-26 14:13:41 UTC (rev 954)
+++ trunk/Index/Makefile.am	2007-09-01 03:48:49 UTC (rev 955)
@@ -12,8 +12,6 @@
 
 noinst_LTLIBRARIES = libIndex.la
 
-bin_PROGRAMS = pinot-index
-
 libIndex_la_SOURCES = \
 	DBusXapianIndex.cpp \
 	FilterWrapper.cpp \
@@ -23,13 +21,17 @@
 	XapianDatabaseFactory.cpp \
 	XapianIndex.cpp
 
-pinot_index_SOURCES = \
-	pinot-index.cpp
+bin_PROGRAMS = pinot-index
 
 pinot_index_LDADD = -L../Utils -L../Tokenize -L../Collect \
 	-lIndex -lCollect -lTokenize -lBasicUtils -lUtils \
 	@GLIBMM_LIBS@ @INDEX_LIBS@ @DBUS_LIBS@ @XML_LIBS@ @GMIME_LIBS@ @HTTP_LIBS@ @MISC_LIBS@
 
+pinot_index_SOURCES = \
+	pinot-index.cpp
+
+pinot_index_DEPENDENCIES = libIndex.la
+
 AM_CXXFLAGS = -I$(srcdir)/../Utils -I$(srcdir)/../Tokenize -I$(srcdir)/../Tokenize/filters \
 	-I$(srcdir)/../Collect @HTTP_CFLAGS@ @GMIME_CFLAGS@ @XML_CFLAGS@ @DBUS_CFLAGS@ @INDEX_CFLAGS@
 

Modified: trunk/Search/Makefile.am
===================================================================
--- trunk/Search/Makefile.am	2007-08-26 14:13:41 UTC (rev 954)
+++ trunk/Search/Makefile.am	2007-09-01 03:48:49 UTC (rev 955)
@@ -28,8 +28,6 @@
 noinst_LTLIBRARIES = libSearch.la
 endif
 
-bin_PROGRAMS = pinot-search
-
 libSearch_la_SOURCES = \
 	AbstractGenerator.cpp \
 	OpenSearchParser.cpp \
@@ -55,13 +53,21 @@
 	SOAPEnvNS.cpp
 endif
 
-pinot_search_SOURCES = \
-	pinot-search.cpp
+bin_PROGRAMS = pinot-search
 
 pinot_search_LDADD = -L../Utils -L../Tokenize -L../Collect -L../Index -LGoogle -Lxesam \
 	@SEARCH_LIBS@ -lIndex -lCollect -lTokenize -lUtils -lBasicUtils \
 	@GLIBMM_LIBS@ @INDEX_LIBS@ @SOAP_LIBS@ @XML_LIBS@ @GMIME_LIBS@ @HTTP_LIBS@ @MISC_LIBS@
 
+pinot_search_SOURCES = \
+	pinot-search.cpp
+
+if HAVE_SOAP
+pinot_search_DEPENDENCIES = libSearch.la libSearchSOAP.la
+else
+pinot_search_DEPENDENCIES = libSearch.la
+endif
+
 SOAPEnvC.cpp : SOAPEnv.h
 	soapcpp2 -pSOAPEnv SOAPEnv.h
 



From fabricecolin at mail.berlios.de  Sat Sep  1 05:59:46 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 1 Sep 2007 05:59:46 +0200
Subject: [Pinot-svn] r956 - in trunk: Index UI/GTK2/src
Message-ID: <200709010359.l813xkXX026692@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-01 05:59:45 +0200 (Sat, 01 Sep 2007)
New Revision: 956

Modified:
   trunk/Index/DBusXapianIndex.cpp
   trunk/Index/DBusXapianIndex.h
   trunk/UI/GTK2/src/pinot.cc
Log:
Include config.h before checking DBUS_VERSION as it's defined there.


Modified: trunk/Index/DBusXapianIndex.cpp
===================================================================
--- trunk/Index/DBusXapianIndex.cpp	2007-09-01 03:48:49 UTC (rev 955)
+++ trunk/Index/DBusXapianIndex.cpp	2007-09-01 03:59:45 UTC (rev 956)
@@ -17,15 +17,6 @@
  */
 
 #include <iostream>
-extern "C"
-{
-#if DBUS_VERSION < 1000000
-#define DBUS_API_SUBJECT_TO_CHANGE
-#endif
-#include <dbus/dbus.h>
-#include <dbus/dbus-glib.h>
-#include <dbus/dbus-glib-lowlevel.h>
-}
 
 #include "Languages.h"
 #include "XapianDatabaseFactory.h"

Modified: trunk/Index/DBusXapianIndex.h
===================================================================
--- trunk/Index/DBusXapianIndex.h	2007-09-01 03:48:49 UTC (rev 955)
+++ trunk/Index/DBusXapianIndex.h	2007-09-01 03:59:45 UTC (rev 956)
@@ -21,12 +21,15 @@
 
 #include <string>
 #include <set>
+#include "config.h"
 extern "C"
 {
 #if DBUS_VERSION < 1000000
 #define DBUS_API_SUBJECT_TO_CHANGE
 #endif
 #include <dbus/dbus.h>
+#include <dbus/dbus-glib.h>
+#include <dbus/dbus-glib-lowlevel.h>
 }
 
 #include "XapianIndex.h"

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2007-09-01 03:48:49 UTC (rev 955)
+++ trunk/UI/GTK2/src/pinot.cc	2007-09-01 03:59:45 UTC (rev 956)
@@ -29,6 +29,7 @@
 #include <glibmm/ustring.h>
 #include <glibmm/miscutils.h>
 #include <glibmm/convert.h>
+#include "config.h"
 extern "C"
 {
 #if DBUS_VERSION < 1000000
@@ -50,7 +51,6 @@
 #include "ViewHistory.h"
 #include "DownloaderInterface.h"
 #include "XapianIndex.h"
-#include "config.h"
 #include "NLS.h"
 #include "PinotSettings.h"
 #include "mainWindow.hh"



From fabricecolin at mail.berlios.de  Sat Sep  1 07:05:23 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 1 Sep 2007 07:05:23 +0200
Subject: [Pinot-svn] r957 - trunk
Message-ID: <200709010505.l8155N0Q019048@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-01 07:05:22 +0200 (Sat, 01 Sep 2007)
New Revision: 957

Modified:
   trunk/pinot.spec.in
Log:
No need to list files under %{_datadir}/pinot.


Modified: trunk/pinot.spec.in
===================================================================
--- trunk/pinot.spec.in	2007-09-01 03:59:45 UTC (rev 956)
+++ trunk/pinot.spec.in	2007-09-01 05:05:22 UTC (rev 957)
@@ -105,10 +105,6 @@
 %{_bindir}/pinot-search
 %{_libdir}/pinot/filters/libexternalfilter.so*
 %{_libdir}/pinot/filters/libmboxfilter.so*
-%{_datadir}/pinot/xapian-powered.png
-%{_datadir}/pinot/metase-gtk2.glade
-%{_datadir}/pinot/metase-gtk2.gladep
-%{_datadir}/pinot/pinot-dbus-daemon.xml
 %{_datadir}/dbus-1/services/de.berlios.Pinot.service
 %{_datadir}/pinot/
 %{_datadir}/icons/hicolor/48x48/apps/pinot.png



From fabricecolin at mail.berlios.de  Sat Sep  1 07:07:43 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 1 Sep 2007 07:07:43 +0200
Subject: [Pinot-svn] r958 - in trunk: Search Utils
Message-ID: <200709010507.l8157hd2021173@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-01 07:07:38 +0200 (Sat, 01 Sep 2007)
New Revision: 958

Modified:
   trunk/Search/OpenSearchParser.cpp
   trunk/Utils/StringManip.cpp
   trunk/Utils/Url.cpp
Log:
Fixed variable shadowing.


Modified: trunk/Search/OpenSearchParser.cpp
===================================================================
--- trunk/Search/OpenSearchParser.cpp	2007-09-01 05:05:22 UTC (rev 957)
+++ trunk/Search/OpenSearchParser.cpp	2007-09-01 05:07:38 UTC (rev 958)
@@ -185,11 +185,10 @@
 		for (Node::NodeList::const_iterator iter = childNodes.begin();
 			iter != childNodes.end(); ++iter)
 		{
-			Node *pNode = (*iter);
+			Node *pChildNode = (*iter);
+			ustring nodeName(pChildNode->get_name());
+			ustring nodeContent(getNodeContent(pChildNode));
 
-			ustring nodeName = pNode->get_name();
-			ustring nodeContent = getNodeContent(pNode);
-
 			// Is this an OpenSearch extension ?
 			// FIXME: make sure namespace is opensearch
 			if (nodeName == "totalResults")
@@ -222,7 +221,7 @@
 
 			// Go through the item's subnodes
 			ustring title, url, extract;
-			const Node::NodeList itemChildNodes = pNode->get_children();
+			const Node::NodeList itemChildNodes = pChildNode->get_children();
 			for (Node::NodeList::const_iterator itemIter = itemChildNodes.begin();
 				itemIter != itemChildNodes.end(); ++itemIter)
 			{
@@ -342,15 +341,16 @@
 		{
 			for (Node::NodeList::const_iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 			{
-				Node *pNode = (*iter);
-				Element *pElem = dynamic_cast<Element*>(pNode);
+				Node *pChildNode = (*iter);
+				Element *pElem = dynamic_cast<Element*>(pChildNode);
 				if (pElem == NULL)
 				{
 					continue;
 				}
 
-				ustring nodeName = pNode->get_name();
-				ustring nodeContent = getNodeContent(pNode);
+				ustring nodeName(pChildNode->get_name());
+				ustring nodeContent(getNodeContent(pChildNode));
+
 				if (nodeName == "ShortName")
 				{
 					properties.m_name = nodeContent;

Modified: trunk/Utils/StringManip.cpp
===================================================================
--- trunk/Utils/StringManip.cpp	2007-09-01 05:05:22 UTC (rev 957)
+++ trunk/Utils/StringManip.cpp	2007-09-01 05:07:38 UTC (rev 958)
@@ -223,7 +223,7 @@
 /// Trims spaces at the start and end of a string.
 unsigned int StringManip::trimSpaces(string &str)
 {
-	unsigned int pos = 0;
+	string::size_type pos = 0;
 	unsigned int count = 0;
 
 	while ((str.empty() == false) && (pos < str.length()))
@@ -238,7 +238,7 @@
 		++count;
 	}
 
-	for (unsigned int pos = str.length() - 1;
+	for (pos = str.length() - 1;
 		(str.empty() == false) && (pos >= 0); --pos)
 	{
 		if (isspace(str[pos]) == 0)

Modified: trunk/Utils/Url.cpp
===================================================================
--- trunk/Utils/Url.cpp	2007-09-01 05:05:22 UTC (rev 957)
+++ trunk/Utils/Url.cpp	2007-09-01 05:07:38 UTC (rev 958)
@@ -357,9 +357,9 @@
 		}
 		else
 		{
-			string level(hostName.substr(pos + 1, endPos - pos));
-			level += reducedHost;
-			reducedHost = level;
+			string levelled(hostName.substr(pos + 1, endPos - pos));
+			levelled += reducedHost;
+			reducedHost = levelled;
 		}
 
 		// Next



From fabricecolin at mail.berlios.de  Sat Sep  1 07:12:25 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 1 Sep 2007 07:12:25 +0200
Subject: [Pinot-svn] r959 - trunk/UI/GTK2/src
Message-ID: <200709010512.l815CP1J026547@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-01 07:12:21 +0200 (Sat, 01 Sep 2007)
New Revision: 959

Modified:
   trunk/UI/GTK2/src/EnginesTree.cpp
   trunk/UI/GTK2/src/EnginesTree.h
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/PinotUtils.h
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/prefsDialog.cc
   trunk/UI/GTK2/src/propertiesDialog.cc
   trunk/UI/GTK2/src/queryDialog.cc
Log:
Fixed warnings about shadowed variables.


Modified: trunk/UI/GTK2/src/EnginesTree.cpp
===================================================================
--- trunk/UI/GTK2/src/EnginesTree.cpp	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/EnginesTree.cpp	2007-09-01 05:12:21 UTC (rev 959)
@@ -108,15 +108,15 @@
 		if (row[m_enginesColumns.m_type] == EnginesModelColumns::ENGINE_FOLDER)
 		{
 			ustring channelName(row[m_enginesColumns.m_name]);
-			TreeModel::Path path = m_refStore->get_path(iter);
+			TreeModel::Path channelPath = m_refStore->get_path(iter);
 
 			std::map<string, bool>::iterator channelIter = channels.find(from_utf8(channelName));
 			if (channelIter != channels.end())
 			{
 #ifdef DEBUG
-				cout << "EnginesTree::save: " << channelName << " is " << row_expanded(path) << endl;
+				cout << "EnginesTree::save: " << channelName << " is " << row_expanded(channelPath) << endl;
 #endif
-				channelIter->second = row_expanded(path);
+				channelIter->second = row_expanded(channelPath);
 			}
 		}
 	}
@@ -203,7 +203,7 @@
 // Handles attempts to select rows.
 //
 bool EnginesTree::onSelectionSelect(const RefPtr<TreeModel>& model,
-		const TreeModel::Path& path, bool path_currently_selected)
+		const TreeModel::Path& node_path, bool path_currently_selected)
 {
 	// All nodes can be selected
 	return true;
@@ -341,11 +341,11 @@
 		}
 
 		TreeModel::iterator iter = m_refStore->append(localIter->children());
-		TreeModel::Row row = *iter;
-		row[m_enginesColumns.m_name] = indexName;
-		row[m_enginesColumns.m_engineName] = "xapian";
-		row[m_enginesColumns.m_option] = to_utf8(indexIter->second);
-		row[m_enginesColumns.m_type] = indexType;
+		TreeModel::Row childRow = *iter;
+		childRow[m_enginesColumns.m_name] = indexName;
+		childRow[m_enginesColumns.m_engineName] = "xapian";
+		childRow[m_enginesColumns.m_option] = to_utf8(indexIter->second);
+		childRow[m_enginesColumns.m_type] = indexType;
 	}
 
 	// Expand this

Modified: trunk/UI/GTK2/src/EnginesTree.h
===================================================================
--- trunk/UI/GTK2/src/EnginesTree.h	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/EnginesTree.h	2007-09-01 05:12:21 UTC (rev 959)
@@ -81,7 +81,7 @@
 
 		/// Handles attempts to select rows.
 		bool onSelectionSelect(const Glib::RefPtr<Gtk::TreeModel>& model,
-			const Gtk::TreeModel::Path& path, bool path_currently_selected);
+			const Gtk::TreeModel::Path& node_path, bool path_currently_selected);
 
 		/// Handles GTK style changes.
 		void onStyleChanged(const Glib::RefPtr<Gtk::Style> &previous_style);

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2007-09-01 05:12:21 UTC (rev 959)
@@ -513,14 +513,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 		if (nodeName == "xpos")
 		{
 			m_xPos = atoi(nodeContent.c_str());
@@ -586,14 +586,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 		if (nodeName == "name")
 		{
 			indexName = nodeContent;
@@ -629,14 +629,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 		if (nodeName == "name")
 		{
 			std::map<string, bool>::iterator channelIter = m_engineChannels.find(nodeContent);
@@ -676,14 +676,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 		if (nodeName == "name")
 		{
 			queryProps.setName(nodeContent);
@@ -851,14 +851,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 
 		if (nodeName == "name")
 		{
@@ -887,14 +887,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 		gushort value = (gushort)atoi(nodeContent.c_str());
 
 		if (nodeName == "red")
@@ -930,14 +930,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 
 		if (nodeName == "address")
 		{
@@ -986,14 +986,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 
 		if (nodeName == "name")
 		{
@@ -1037,14 +1037,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 
 		if (nodeName == "pattern")
 		{
@@ -1085,14 +1085,14 @@
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
 		Node *pNode = (*iter);
-		Element *pElem = dynamic_cast<Element*>(pNode);
-		if (pElem == NULL)
+		Element *pChildElem = dynamic_cast<Element*>(pNode);
+		if (pChildElem == NULL)
 		{
 			continue;
 		}
 
-		string nodeName = pElem->get_name();
-		string nodeContent = getElementContent(pElem);
+		string nodeName(pChildElem->get_name());
+		string nodeContent(getElementContent(pChildElem));
 
 		if (nodeName == "name")
 		{

Modified: trunk/UI/GTK2/src/PinotUtils.h
===================================================================
--- trunk/UI/GTK2/src/PinotUtils.h	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/PinotUtils.h	2007-09-01 05:12:21 UTC (rev 959)
@@ -20,6 +20,7 @@
 #define _PINOTUTILS_HH
 
 #include <string>
+#include <gtkmmconfig.h>
 #if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
 #include <sigc++/compatibility.h>
 #endif

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2007-09-01 05:12:21 UTC (rev 959)
@@ -368,9 +368,9 @@
 }
 
 bool ResultsTree::onSelectionSelect(const RefPtr<TreeModel>& model,
-	const TreeModel::Path& path, bool path_currently_selected)
+	const TreeModel::Path& node_path, bool path_currently_selected)
 {
-	const TreeModel::iterator iter = model->get_iter(path);
+	const TreeModel::iterator iter = model->get_iter(node_path);
 	const TreeModel::Row row = *iter;
 
 	m_indexNames.clear();
@@ -389,8 +389,8 @@
 			cout << "ResultsTree::onSelectionSelect: extract for " << row[m_resultsColumns.m_text] << endl;
 #endif
 
-			TreeModel::iterator iter = m_refExtractStore->append();
-			TreeModel::Row extractRow = *iter;
+			TreeModel::iterator extractIter = m_refExtractStore->append();
+			TreeModel::Row extractRow = *extractIter;
 			extractRow[m_extractColumns.m_name] = findResultsExtract(row);
 		}
 	}
@@ -750,10 +750,10 @@
 						// Add entries for each index name so that we can loop once on engine names
 						set<string> indexNames;
 						m_settings.getIndexNames(indexIds, indexNames);
-						for (set<string>::iterator iter = indexNames.begin();
-							iter != indexNames.end(); ++iter)
+						for (set<string>::iterator indexIter = indexNames.begin();
+							indexIter != indexNames.end(); ++indexIter)
 						{
-							string indexName(*iter);
+							string indexName(*indexIter);
 							engineNames.insert(indexName);
 #ifdef DEBUG
 							cout << "ResultsTree::setGroupMode: row is for index " << indexName << endl;
@@ -761,10 +761,10 @@
 						}
 					}
 
-					for (set<string>::iterator iter = engineNames.begin();
-						iter != engineNames.end(); ++iter)
+					for (set<string>::iterator engineIter = engineNames.begin();
+						engineIter != engineNames.end(); ++engineIter)
 					{
-						string engineName(*iter);
+						string engineName(*engineIter);
 						unsigned int indexId = 0;
 						unsigned int engineId = m_settings.getEngineId(engineName);
 
@@ -800,7 +800,7 @@
 								engineId, indexId,
 								newIter, groupIter, true);
 #ifdef DEBUG
-							cout << "ResultsTree::setGroupMode: row for " << *iter << endl;
+							cout << "ResultsTree::setGroupMode: row for " << engineName << endl;
 #endif
 						}
 					}
@@ -1171,9 +1171,9 @@
 //
 // Shows or hides the extract field.
 //
-void ResultsTree::showExtract(bool show)
+void ResultsTree::showExtract(bool showExtract)
 {
-	m_showExtract = show;
+	m_showExtract = showExtract;
 	if (m_showExtract == true)
 	{
 		// Show the extract
@@ -1250,13 +1250,13 @@
 			childIter != groupChildren.end(); ++childIter)
 		{
 			set<string> engineNames, indexNames;
-			TreeModel::Row row = *childIter;
-			DocumentInfo result(from_utf8(row[m_resultsColumns.m_text]),
-				from_utf8(row[m_resultsColumns.m_url]),
-				from_utf8(row[m_resultsColumns.m_type]), "");
+			TreeModel::Row childRow = *childIter;
+			DocumentInfo result(from_utf8(childRow[m_resultsColumns.m_text]),
+				from_utf8(childRow[m_resultsColumns.m_url]),
+				from_utf8(childRow[m_resultsColumns.m_type]), "");
 			string engineName, charset;
-			unsigned int engineIds = row[m_resultsColumns.m_engines];
-			unsigned int indexIds = row[m_resultsColumns.m_indexes];
+			unsigned int engineIds = childRow[m_resultsColumns.m_engines];
+			unsigned int indexIds = childRow[m_resultsColumns.m_indexes];
 
 #ifdef DEBUG
 			cout << "ResultsTree::exportResults: engines " << engineIds << ", indexes " << indexIds << endl;

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/ResultsTree.h	2007-09-01 05:12:21 UTC (rev 959)
@@ -100,7 +100,7 @@
 		void clear(void);
 
 		/// Shows or hides the extract field.
-		void showExtract(bool show = true);
+		void showExtract(bool showExtract = true);
 
 		/// Exports results to a file.
 		void exportResults(const std::string &fileName, bool csvFormat);
@@ -148,7 +148,7 @@
 		void onSelectionChanged(void);
 
 		bool onSelectionSelect(const Glib::RefPtr<Gtk::TreeModel>& model,
-			const Gtk::TreeModel::Path& path, bool path_currently_selected);
+			const Gtk::TreeModel::Path& node_path, bool path_currently_selected);
 
 		/// Handles GTK style changes.
 		void onStyleChanged(const Glib::RefPtr<Gtk::Style> &previous_style);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-01 05:12:21 UTC (rev 959)
@@ -262,9 +262,9 @@
 			(queryName == selectedQueryName))
 		{
 			// Select and scroll to this query
-			TreeModel::Path path = m_refQueryTree->get_path(iter);
-			queryTreeview->get_selection()->select(path);
-			queryTreeview->scroll_to_row(path);
+			TreeModel::Path queryPath = m_refQueryTree->get_path(iter);
+			queryTreeview->get_selection()->select(queryPath);
+			queryTreeview->scroll_to_row(queryPath);
 		}
 	}
 }
@@ -353,11 +353,11 @@
 			cacheIter != m_settings.m_cacheProviders.end(); ++cacheIter)
 		{
 			m_pCacheMenu->items().push_back(Menu_Helpers::MenuElem(cacheIter->m_name));
-			MenuItem *pMenuItem = &m_pCacheMenu->items().back();
+			MenuItem *pCacheMenuItem = &m_pCacheMenu->items().back();
 
 			// Bind the callback's parameter to the cache provider
-			SigC::Slot0<void> documentsActivateSlot = sigc::bind(cacheSlot, (*cacheIter));
-			pMenuItem->signal_activate().connect(documentsActivateSlot);
+			SigC::Slot0<void> cachedDocumentsActivateSlot = sigc::bind(cacheSlot, (*cacheIter));
+			pCacheMenuItem->signal_activate().connect(cachedDocumentsActivateSlot);
 		}
 	}
 }
@@ -438,7 +438,6 @@
 void mainWindow::on_resultsTreeviewSelection_changed(ustring queryName)
 {
 	vector<DocumentInfo> resultsList;
-	string url;
 	bool hasSelection = false;
 
 	NotebookPageBox *pNotebookPage = get_page(queryName, NotebookPageBox::RESULTS_PAGE);
@@ -2153,7 +2152,7 @@
 				docIter != documentsList.end(); ++docIter)
 			{
 				unsigned int indexId = 0;
-				unsigned int docId = docIter->getIsIndexed(indexId);
+				docId = docIter->getIsIndexed(indexId);
 
 				docIter->setLanguage(newLanguage);
 
@@ -2520,9 +2519,9 @@
 
 			// Select another row
 			queryTreeview->get_selection()->unselect(iter);
-			TreeModel::Path path = m_refQueryTree->get_path(iter);
-			path.next();
-			queryTreeview->get_selection()->select(path);
+			TreeModel::Path queryPath = m_refQueryTree->get_path(iter);
+			queryPath.next();
+			queryTreeview->get_selection()->select(queryPath);
 			// Erase
 			m_refQueryTree->erase(row);
 
@@ -2954,8 +2953,8 @@
 			{
 				TreeModel::Row folderEngineRow = *folderEngineIter;
 
-				EnginesModelColumns::EngineType engineType = engineRow[engineColumns.m_type];
-				if (engineType < EnginesModelColumns::ENGINE_FOLDER)
+				EnginesModelColumns::EngineType folderEngineType = folderEngineRow[engineColumns.m_type];
+				if (folderEngineType < EnginesModelColumns::ENGINE_FOLDER)
 				{
 					// Skip
 					continue;
@@ -3109,7 +3108,6 @@
 {
 	ViewHistory viewHistory(m_settings.getHistoryDatabaseName());
 	multimap<string, string> locationsByType;
-	vector<DocumentInfo>::iterator docIter = documentsList.begin();
 
 	for (vector<DocumentInfo>::iterator docIter = documentsList.begin();
 		docIter != documentsList.end(); ++docIter)
@@ -3143,8 +3141,6 @@
 		// What's the MIME type ?
 		if (mimeType.empty() == true)
 		{
-			Url urlObj(url);
-
 			// Scan for the MIME type
 			mimeType = MIMEScanner::scanUrl(urlObj);
 		}

Modified: trunk/UI/GTK2/src/prefsDialog.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog.cc	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/prefsDialog.cc	2007-09-01 05:12:21 UTC (rev 959)
@@ -420,9 +420,9 @@
 		// Unselect
 		labelsTreeview->get_selection()->unselect(iter);
 		// Select another row
-		TreeModel::Path path = m_refLabelsTree->get_path(iter);
-		path.next();
-		labelsTreeview->get_selection()->select(path);
+		TreeModel::Path labelPath = m_refLabelsTree->get_path(iter);
+		labelPath.next();
+		labelsTreeview->get_selection()->select(labelPath);
 		// Erase
 		TreeModel::Row row = *iter;
 		m_deletedLabels.insert(from_utf8(row[m_labelsColumns.m_name]));
@@ -476,9 +476,9 @@
 		// Unselect
 		directoriesTreeview->get_selection()->unselect(iter);
 		// Select another row
-		TreeModel::Path path = m_refDirectoriesTree->get_path(iter);
-		path.next();
-		directoriesTreeview->get_selection()->select(path);
+		TreeModel::Path dirPath = m_refDirectoriesTree->get_path(iter);
+		dirPath.next();
+		directoriesTreeview->get_selection()->select(dirPath);
 
 		// Erase
 		TreeModel::Row row = *iter;
@@ -528,8 +528,8 @@
 	TreeViewColumn *pColumn = patternsTreeview->get_column(0);
 	if (pColumn != NULL)
 	{
-		TreeModel::Path path = m_refPatternsTree->get_path(iter);
-		patternsTreeview->set_cursor(path, *pColumn, true);
+		TreeModel::Path patternPath = m_refPatternsTree->get_path(iter);
+		patternsTreeview->set_cursor(patternPath, *pColumn, true);
 	}
 
 	if (wasEmpty == true)
@@ -548,9 +548,9 @@
 		// Unselect
 		patternsTreeview->get_selection()->unselect(iter);
 		// Select another row
-		TreeModel::Path path = m_refPatternsTree->get_path(iter);
-		path.next();
-		patternsTreeview->get_selection()->select(path);
+		TreeModel::Path patternPath = m_refPatternsTree->get_path(iter);
+		patternPath.next();
+		patternsTreeview->get_selection()->select(patternPath);
 
 		// Erase
 		TreeModel::Row row = *iter;

Modified: trunk/UI/GTK2/src/propertiesDialog.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.cc	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/propertiesDialog.cc	2007-09-01 05:12:21 UTC (rev 959)
@@ -164,8 +164,8 @@
 
 		row[m_labelsColumns.m_name] = labelName;
 		// Is it in the document labels list ?
-		set<string>::const_iterator iter = find(docLabels.begin(), docLabels.end(), labelName);
-		if (iter != docLabels.end())
+		set<string>::const_iterator docLabelIter = find(docLabels.begin(), docLabels.end(), labelName);
+		if (docLabelIter != docLabels.end())
 		{
 			// Yup
 			row[m_labelsColumns.m_enabled] = true;

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2007-09-01 05:07:38 UTC (rev 958)
+++ trunk/UI/GTK2/src/queryDialog.cc	2007-09-01 05:12:21 UTC (rev 959)
@@ -97,8 +97,8 @@
 {
 	if (iter)
 	{
-		const TreeModel::Path path = model->get_path(iter);
-		string rowPath(from_utf8(path.to_string()));
+		const TreeModel::Path queryPath = model->get_path(iter);
+		string rowPath(from_utf8(queryPath.to_string()));
 		unsigned int rowPos = 0;
 
 		// FIXME: this is extremely hacky !



From fabricecolin at mail.berlios.de  Mon Sep  3 13:12:40 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Mon, 3 Sep 2007 13:12:40 +0200
Subject: [Pinot-svn] r960 - trunk/Index
Message-ID: <200709031112.l83BCen7023149@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-03 13:12:38 +0200 (Mon, 03 Sep 2007)
New Revision: 960

Modified:
   trunk/Index/XapianIndex.cpp
Log:
With Xapian 1.0, we can list all documents by getting a postlist of the empty
term. This will let us browse indexes that don't have the "magic term", i.e.
indexes not built with Pinot.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2007-09-01 05:12:21 UTC (rev 959)
+++ trunk/Index/XapianIndex.cpp	2007-09-03 11:12:38 UTC (rev 960)
@@ -1136,7 +1136,7 @@
 	unsigned int maxDocsCount, unsigned int startDoc) const
 {
 	// All documents have the magic term
-	return listDocumentsWithTerm(MAGIC_TERM, docIds, maxDocsCount, startDoc);
+	return listDocumentsWithTerm("", docIds, maxDocsCount, startDoc);
 }
 
 /// Lists documents.



From fabricecolin at mail.berlios.de  Mon Sep  3 14:14:50 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Mon, 3 Sep 2007 14:14:50 +0200
Subject: [Pinot-svn] r961 - trunk
Message-ID: <200709031214.l83CEoRT021357@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-03 14:14:49 +0200 (Mon, 03 Sep 2007)
New Revision: 961

Added:
   trunk/FAQ
Modified:
   trunk/Makefile.am
   trunk/README
Log:
Moved FAQ to separate file.


Added: trunk/FAQ
===================================================================
--- trunk/FAQ	2007-09-03 11:12:38 UTC (rev 960)
+++ trunk/FAQ	2007-09-03 12:14:49 UTC (rev 961)
@@ -0,0 +1,47 @@
+  * At startup, when listing an index or indexing documents, Pinot complains
+    of an "index error"
+    This is likely because a previous instance didn't exit properly and one
+    (or more) index is still locked. Quit Pinot and look for a "db_lock" file
+    in "~/.pinot/index". If it's there, delete it and restart Pinot.
+    Starting with 0.60, indexes are created with the newer Flint back-end
+    which is immune to this issue.
+
+  * When compiling from source, you may run into linking problems related to
+    libstdc++.la. Try patching xapian-config as explained in the post at
+    http://lists.tartarus.org/pipermail/xapian-devel/2006-January/000293.html
+
+  * If you experience segfaults at startup and you are on Fedora, chances are
+    it's because of libxml++/libsigc++. See this Bugzilla entry :
+    https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=178592
+    The latest version seems to fix this issue.
+
+  * If the daemon crashes seemingly randomly while indexing, it may be because
+    SQLite wasn't built thread-safe. I have witnessed this mostly on dual CPU
+    machines, but others are not immune. Try rebuilding SQLite by passing
+    "--enable-threadsafe --enable-threads-override-locks" to configure.
+
+  * If you have built Pinot from source, make sure you have done a "make install".
+    Pinot will fail to start if it can't find stuff it needs, its icon for
+    instance.
+
+  * If "make install" fails with an error about Categories in pinot.desktop
+    and you have desktop-file-utils 0.11, either downgrade to 0.10 or upgrade
+    to 0.12 if possible, or edit the top-level Makefile and replace the line
+     @desktop-file-install --vendor="" --dir=$(DESTDIR)$(datadir)/applications pinot.desktop
+    with
+     $(INSTALL_DATA) pinot.desktop $(DESTDIR)$(datadir)/applications/pinot.desktop
+    and run "make install" again.
+
+  * In stored queries, the directory filter doesn't work as expected if the
+    directory name starts with a non alpha-numeric character. This has been
+    fixed in Xapian 0.9.8.
+
+  * On FreeBSD, threading issues may cause the daemon to crash unexpectedly.
+    A fix is to add the following lines to /etc/libmap.conf (which may not exist) :
+     [/usr/local/bin/pinot-dbus-daemon]
+     libpthread.so.2         libc_r.so.6
+     libpthread.so           libc_r.so
+
+     [/usr/local/bin/pinot]
+     libpthread.so.2         libc_r.so.6
+     libpthread.so           libc_r.so

Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2007-09-03 11:12:38 UTC (rev 960)
+++ trunk/Makefile.am	2007-09-03 12:14:49 UTC (rev 961)
@@ -1,7 +1,7 @@
 
 SUBDIRS = po Utils Tokenize SQL Collect Index @SOAP_SUBDIRS@ Search Monitor UI/GTK2/src
 
-EXTRA_DIST = AUTHORS ChangeLog ChangeLog-dijon NEWS README TODO mkinstalldirs \
+EXTRA_DIST = AUTHORS ChangeLog ChangeLog-dijon FAQ NEWS README TODO mkinstalldirs \
 	Tokenize/filters/external-filters.xml globalconfig.xml \
 	textcat_conf.txt textcat3_conf.txt \
 	pinot.desktop pinot-dbus-daemon.desktop pinot.spec \

Modified: trunk/README
===================================================================
--- trunk/README	2007-09-03 11:12:38 UTC (rev 960)
+++ trunk/README	2007-09-03 12:14:49 UTC (rev 961)
@@ -18,7 +18,6 @@
 13. Deskbar Applet plugin
 14. How to reset indexes
 15. Dependencies
-16. FAQ
 
 
 1. What is Pinot
@@ -437,67 +436,3 @@
 (4) experimental - required only if _SSH_TUNNEL is set
 ---------------------------------------------------------------
 
-
-16. FAQ
-
-
-  * At startup, when listing an index or indexing documents, Pinot complains
-    of an "index error"
-    This is likely because a previous instance didn't exit properly and one
-    (or more) index is still locked. Quit Pinot and look for a "db_lock" file
-    in "~/.pinot/index". If it's there, delete it and restart Pinot.
-    Starting with 0.60, indexes are created with the newer Flint back-end
-    which is immune to this issue.
-
-  * When compiling from source, you may run into linking problems related to
-    libstdc++.la. Try patching xapian-config as explained in the post at
-    http://lists.tartarus.org/pipermail/xapian-devel/2006-January/000293.html
-
-  * If you experience segfaults at startup and you are on Fedora, chances are
-    it's because of libxml++/libsigc++. See this Bugzilla entry :
-    https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=178592
-    The latest version seems to fix this issue.
-
-  * If the daemon crashes seemingly randomly while indexing, it may be because
-    SQLite wasn't built thread-safe. I have witnessed this mostly on dual CPU
-    machines, but others are not immune. Try rebuilding SQLite by passing
-    "--enable-threadsafe --enable-threads-override-locks" to configure.
-
-  * If you have built Pinot from source, make sure you have done a "make install".
-    Pinot will fail to start if it can't find stuff it needs, its icon for
-    instance.
-
-  * If "make install" fails with an error about Categories in pinot.desktop
-    and you have desktop-file-utils 0.11, either downgrade to 0.10 or upgrade
-    to 0.12 if possible, or edit the top-level Makefile and replace the line
-     @desktop-file-install --vendor="" --dir=$(DESTDIR)$(datadir)/applications pinot.desktop
-    with
-     $(INSTALL_DATA) pinot.desktop $(DESTDIR)$(datadir)/applications/pinot.desktop
-    and run "make install" again.
-
-  * In stored queries, the directory filter doesn't work as expected if the
-    directory name starts with a non alpha-numeric character. This has been
-    fixed in Xapian 0.9.8.
-
-  * On FreeBSD, threading issues may cause the daemon to crash unexpectedly.
-    A fix is to add the following lines to /etc/libmap.conf (which may not exist) :
-     [/usr/local/bin/pinot-dbus-daemon]
-     libpthread.so.2         libc_r.so.6
-     libpthread.so           libc_r.so
-
-     [/usr/local/bin/pinot]
-     libpthread.so.2         libc_r.so.6
-     libpthread.so           libc_r.so
-    Refer to the libmap.conf(5) man page for details.
-
-  * Upgrading from Xapian 0.9 or older to 1.0 is handled automatically, but
-    downgrading back to 0.9 requires resetting the indexes manually. 
-
-  * If you see the message "Failed to open fingerprint file
-    '/usr/share/libtextcat/LM/danish.lm'" or similar in the output of
-    pinot-index, or in one of the logs in ~/.pinot, this means the language
-    models required by libtextcat are not in the expected location. You
-    should edit the file /etc/pinot/textcat_conf.txt and modify the paths to
-    the language models. By default, they are looked for under the directory
-    /usr/share/libtextcat/
-



From fabricecolin at mail.berlios.de  Tue Sep  4 13:30:22 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 4 Sep 2007 13:30:22 +0200
Subject: [Pinot-svn] r962 - trunk/UI/GTK2/src
Message-ID: <200709041130.l84BUMNs010631@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-04 13:30:21 +0200 (Tue, 04 Sep 2007)
New Revision: 962

Modified:
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
Log:
Show external indexes in the List Contents Of menu, repopulate when one is
added/edited/removed. Properties of documents from external indexes are
-for the time being- not shown.


Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-03 12:14:49 UTC (rev 961)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-04 11:30:21 UTC (rev 962)
@@ -157,7 +157,8 @@
 	populate_queryTreeview("");
 
 	// Populate the menus
-	populate_menus();
+	populate_cacheMenu();
+	populate_indexMenu();
 
 	// Create a notebook, without any page initially
 	m_pNotebook = manage(new Notebook());
@@ -298,36 +299,10 @@
 }
 
 //
-// Populate menus
+// Populate the cache menu
 //
-void mainWindow::populate_menus()
+void mainWindow::populate_cacheMenu()
 {
-	if (m_pIndexMenu == NULL)
-	{
-		m_pIndexMenu = manage(new Menu());
-		list1->set_submenu(*m_pIndexMenu);
-	}
-	else
-	{
-		// Clear the submenu
-		m_pIndexMenu->items().clear();
-	}
-
-	SigC::Slot1<void, ustring> indexSlot = SigC::slot(*this, &mainWindow::on_index_changed);
-
-	// Populate the submenu
-	m_pIndexMenu->items().push_back(Menu_Helpers::MenuElem(_("My Documents")));
-	MenuItem *pMenuItem = &m_pIndexMenu->items().back();
-	// Bind the callback's parameter to the index name
-	SigC::Slot0<void> daemonActivateSlot = sigc::bind(indexSlot, _("My Documents"));
-	pMenuItem->signal_activate().connect(daemonActivateSlot);
-
-	m_pIndexMenu->items().push_back(Menu_Helpers::MenuElem(_("My Web Pages")));
-	pMenuItem = &m_pIndexMenu->items().back();
-	// Bind the callback's parameter to the index name
-	SigC::Slot0<void> documentsActivateSlot = sigc::bind(indexSlot, _("My Web Pages"));
-	pMenuItem->signal_activate().connect(documentsActivateSlot);
-
 	if (m_pCacheMenu == NULL)
 	{
 		m_pCacheMenu = manage(new Menu());
@@ -363,6 +338,38 @@
 }
 
 //
+// Populate the index menu
+//
+void mainWindow::populate_indexMenu()
+{
+	if (m_pIndexMenu == NULL)
+	{
+		m_pIndexMenu = manage(new Menu());
+		list1->set_submenu(*m_pIndexMenu);
+	}
+	else
+	{
+		// Clear the submenu
+		m_pIndexMenu->items().clear();
+	}
+
+	SigC::Slot1<void, ustring> indexSlot = SigC::slot(*this, &mainWindow::on_index_changed);
+
+	std::map<std::string, std::string> indexes = m_settings.getIndexes();
+	for (std::map<std::string, std::string>::const_iterator indexIter = indexes.begin();
+		indexIter != indexes.end(); ++indexIter)
+	{
+		ustring indexName(to_utf8(indexIter->first));
+
+		m_pIndexMenu->items().push_back(Menu_Helpers::MenuElem(indexName));
+		MenuItem &menuItem = m_pIndexMenu->items().back();
+		// Bind the callback's parameter to the index name
+		SigC::Slot0<void> menuItemSlot = sigc::bind(indexSlot, indexName);
+		menuItem.signal_activate().connect(menuItemSlot);
+	}
+}
+
+//
 // Query list selection changed
 //
 void mainWindow::on_queryTreeviewSelection_changed()
@@ -535,16 +542,21 @@
 		if (url.empty() == false)
 		{
 			bool isDocumentsIndex = true;
+			bool editDocument = true;
 
 			// Enable these menu items unless it is not the documents index
 			if (indexName != _("My Web Pages"))
 			{
 				isDocumentsIndex = false;
+				if (indexName != _("My Documents"))
+				{
+					editDocument = false;
+				}
 			}
 			viewfromindex1->set_sensitive(true);
 			refreshindex1->set_sensitive(isDocumentsIndex);
 			unindex1->set_sensitive(isDocumentsIndex);
-			showfromindex1->set_sensitive(true);
+			showfromindex1->set_sensitive(editDocument);
 
 			// Show the URL in the status bar
 			ustring statusText = _("Document location is");
@@ -1383,6 +1395,8 @@
 
 		// Refresh the engines list
 		m_pEnginesTree->populate();
+		// ...and the index menu
+		populate_indexMenu();
 	}
 
 	set_status(_("Edited index"));
@@ -2014,6 +2028,13 @@
 		pResultsTree = pIndexPage->getTree();
 	}
 
+	// Allow this only for internal indexes
+	if ((indexName != _("My Web Pages")) &&
+		(indexName != _("My Documents")))
+	{
+		return;
+	}
+
 	const std::map<string, string> &indexesMap = m_settings.getIndexes();
 	std::map<string, string>::const_iterator mapIter = indexesMap.find(indexName);
 	if (mapIter == indexesMap.end())
@@ -2315,6 +2336,8 @@
 		// Refresh the indexes list
 		removeIndexButton->set_sensitive(false);
 		m_pEnginesTree->populate();
+		// ...and the index menu
+		populate_indexMenu();
 	}
 
 	set_status(_("Added new index"));
@@ -2364,6 +2387,8 @@
 			// Refresh the indexes list
 			removeIndexButton->set_sensitive(false);
 			m_pEnginesTree->populate();
+			// ...and the index menu
+			populate_indexMenu();
 		}
 	}
 }

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2007-09-03 12:14:49 UTC (rev 961)
+++ trunk/UI/GTK2/src/mainWindow.hh	2007-09-04 11:30:21 UTC (rev 962)
@@ -58,7 +58,8 @@
 	// Utility methods
 	void populate_queryTreeview(const std::string &selectedQueryName);
 	void save_queryTreeview();
-	void populate_menus();
+	void populate_cacheMenu();
+	void populate_indexMenu();
 
 	// Handlers
 	bool on_queryCompletion_match(const Glib::ustring &key, const Gtk::TreeModel::const_iterator &iter);



From fabricecolin at mail.berlios.de  Tue Sep  4 13:33:47 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 4 Sep 2007 13:33:47 +0200
Subject: [Pinot-svn] r963 - trunk
Message-ID: <200709041133.l84BXlCD010775@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-04 13:33:47 +0200 (Tue, 04 Sep 2007)
New Revision: 963

Added:
   trunk/ChangeLog
   trunk/INSTALL
Log:
These two files should be in the source tree.


Added: trunk/ChangeLog
===================================================================

Added: trunk/INSTALL
===================================================================
--- trunk/INSTALL	2007-09-04 11:30:21 UTC (rev 962)
+++ trunk/INSTALL	2007-09-04 11:33:47 UTC (rev 963)
@@ -0,0 +1,236 @@
+Installation Instructions
+*************************
+
+Copyright (C) 1994, 1995, 1996, 1999, 2000, 2001, 2002, 2004, 2005 Free
+Software Foundation, Inc.
+
+This file is free documentation; the Free Software Foundation gives
+unlimited permission to copy, distribute and modify it.
+
+Basic Installation
+==================
+
+These are generic installation instructions.
+
+   The `configure' shell script attempts to guess correct values for
+various system-dependent variables used during compilation.  It uses
+those values to create a `Makefile' in each directory of the package.
+It may also create one or more `.h' files containing system-dependent
+definitions.  Finally, it creates a shell script `config.status' that
+you can run in the future to recreate the current configuration, and a
+file `config.log' containing compiler output (useful mainly for
+debugging `configure').
+
+   It can also use an optional file (typically called `config.cache'
+and enabled with `--cache-file=config.cache' or simply `-C') that saves
+the results of its tests to speed up reconfiguring.  (Caching is
+disabled by default to prevent problems with accidental use of stale
+cache files.)
+
+   If you need to do unusual things to compile the package, please try
+to figure out how `configure' could check whether to do them, and mail
+diffs or instructions to the address given in the `README' so they can
+be considered for the next release.  If you are using the cache, and at
+some point `config.cache' contains results you don't want to keep, you
+may remove or edit it.
+
+   The file `configure.ac' (or `configure.in') is used to create
+`configure' by a program called `autoconf'.  You only need
+`configure.ac' if you want to change it or regenerate `configure' using
+a newer version of `autoconf'.
+
+The simplest way to compile this package is:
+
+  1. `cd' to the directory containing the package's source code and type
+     `./configure' to configure the package for your system.  If you're
+     using `csh' on an old version of System V, you might need to type
+     `sh ./configure' instead to prevent `csh' from trying to execute
+     `configure' itself.
+
+     Running `configure' takes awhile.  While running, it prints some
+     messages telling which features it is checking for.
+
+  2. Type `make' to compile the package.
+
+  3. Optionally, type `make check' to run any self-tests that come with
+     the package.
+
+  4. Type `make install' to install the programs and any data files and
+     documentation.
+
+  5. You can remove the program binaries and object files from the
+     source code directory by typing `make clean'.  To also remove the
+     files that `configure' created (so you can compile the package for
+     a different kind of computer), type `make distclean'.  There is
+     also a `make maintainer-clean' target, but that is intended mainly
+     for the package's developers.  If you use it, you may have to get
+     all sorts of other programs in order to regenerate files that came
+     with the distribution.
+
+Compilers and Options
+=====================
+
+Some systems require unusual options for compilation or linking that the
+`configure' script does not know about.  Run `./configure --help' for
+details on some of the pertinent environment variables.
+
+   You can give `configure' initial values for configuration parameters
+by setting variables in the command line or in the environment.  Here
+is an example:
+
+     ./configure CC=c89 CFLAGS=-O2 LIBS=-lposix
+
+   *Note Defining Variables::, for more details.
+
+Compiling For Multiple Architectures
+====================================
+
+You can compile the package for more than one kind of computer at the
+same time, by placing the object files for each architecture in their
+own directory.  To do this, you must use a version of `make' that
+supports the `VPATH' variable, such as GNU `make'.  `cd' to the
+directory where you want the object files and executables to go and run
+the `configure' script.  `configure' automatically checks for the
+source code in the directory that `configure' is in and in `..'.
+
+   If you have to use a `make' that does not support the `VPATH'
+variable, you have to compile the package for one architecture at a
+time in the source code directory.  After you have installed the
+package for one architecture, use `make distclean' before reconfiguring
+for another architecture.
+
+Installation Names
+==================
+
+By default, `make install' installs the package's commands under
+`/usr/local/bin', include files under `/usr/local/include', etc.  You
+can specify an installation prefix other than `/usr/local' by giving
+`configure' the option `--prefix=PREFIX'.
+
+   You can specify separate installation prefixes for
+architecture-specific files and architecture-independent files.  If you
+pass the option `--exec-prefix=PREFIX' to `configure', the package uses
+PREFIX as the prefix for installing programs and libraries.
+Documentation and other data files still use the regular prefix.
+
+   In addition, if you use an unusual directory layout you can give
+options like `--bindir=DIR' to specify different values for particular
+kinds of files.  Run `configure --help' for a list of the directories
+you can set and what kinds of files go in them.
+
+   If the package supports it, you can cause programs to be installed
+with an extra prefix or suffix on their names by giving `configure' the
+option `--program-prefix=PREFIX' or `--program-suffix=SUFFIX'.
+
+Optional Features
+=================
+
+Some packages pay attention to `--enable-FEATURE' options to
+`configure', where FEATURE indicates an optional part of the package.
+They may also pay attention to `--with-PACKAGE' options, where PACKAGE
+is something like `gnu-as' or `x' (for the X Window System).  The
+`README' should mention any `--enable-' and `--with-' options that the
+package recognizes.
+
+   For packages that use the X Window System, `configure' can usually
+find the X include and library files automatically, but if it doesn't,
+you can use the `configure' options `--x-includes=DIR' and
+`--x-libraries=DIR' to specify their locations.
+
+Specifying the System Type
+==========================
+
+There may be some features `configure' cannot figure out automatically,
+but needs to determine by the type of machine the package will run on.
+Usually, assuming the package is built to be run on the _same_
+architectures, `configure' can figure that out, but if it prints a
+message saying it cannot guess the machine type, give it the
+`--build=TYPE' option.  TYPE can either be a short name for the system
+type, such as `sun4', or a canonical name which has the form:
+
+     CPU-COMPANY-SYSTEM
+
+where SYSTEM can have one of these forms:
+
+     OS KERNEL-OS
+
+   See the file `config.sub' for the possible values of each field.  If
+`config.sub' isn't included in this package, then this package doesn't
+need to know the machine type.
+
+   If you are _building_ compiler tools for cross-compiling, you should
+use the option `--target=TYPE' to select the type of system they will
+produce code for.
+
+   If you want to _use_ a cross compiler, that generates code for a
+platform different from the build platform, you should specify the
+"host" platform (i.e., that on which the generated programs will
+eventually be run) with `--host=TYPE'.
+
+Sharing Defaults
+================
+
+If you want to set default values for `configure' scripts to share, you
+can create a site shell script called `config.site' that gives default
+values for variables like `CC', `cache_file', and `prefix'.
+`configure' looks for `PREFIX/share/config.site' if it exists, then
+`PREFIX/etc/config.site' if it exists.  Or, you can set the
+`CONFIG_SITE' environment variable to the location of the site script.
+A warning: not all `configure' scripts look for a site script.
+
+Defining Variables
+==================
+
+Variables not defined in a site shell script can be set in the
+environment passed to `configure'.  However, some packages may run
+configure again during the build, and the customized values of these
+variables may be lost.  In order to avoid this problem, you should set
+them in the `configure' command line, using `VAR=value'.  For example:
+
+     ./configure CC=/usr/local2/bin/gcc
+
+causes the specified `gcc' to be used as the C compiler (unless it is
+overridden in the site shell script).  Here is a another example:
+
+     /bin/bash ./configure CONFIG_SHELL=/bin/bash
+
+Here the `CONFIG_SHELL=/bin/bash' operand causes subsequent
+configuration-related scripts to be executed by `/bin/bash'.
+
+`configure' Invocation
+======================
+
+`configure' recognizes the following options to control how it operates.
+
+`--help'
+`-h'
+     Print a summary of the options to `configure', and exit.
+
+`--version'
+`-V'
+     Print the version of Autoconf used to generate the `configure'
+     script, and exit.
+
+`--cache-file=FILE'
+     Enable the cache: use and save the results of the tests in FILE,
+     traditionally `config.cache'.  FILE defaults to `/dev/null' to
+     disable caching.
+
+`--config-cache'
+`-C'
+     Alias for `--cache-file=config.cache'.
+
+`--quiet'
+`--silent'
+`-q'
+     Do not print messages saying which checks are being made.  To
+     suppress all normal output, redirect it to `/dev/null' (any error
+     messages will still be shown).
+
+`--srcdir=DIR'
+     Look for the package's source code in directory DIR.  Usually
+     `configure' can determine that directory automatically.
+
+`configure' also accepts some other, not widely useful, options.  Run
+`configure --help' for more details.
+



From fabricecolin at mail.berlios.de  Tue Sep  4 14:00:45 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 4 Sep 2007 14:00:45 +0200
Subject: [Pinot-svn] r964 - trunk
Message-ID: <200709041200.l84C0jbP012080@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-04 14:00:45 +0200 (Tue, 04 Sep 2007)
New Revision: 964

Modified:
   trunk/pinot.spec.in
Log:
Install the FAQ file.


Modified: trunk/pinot.spec.in
===================================================================
--- trunk/pinot.spec.in	2007-09-04 11:33:47 UTC (rev 963)
+++ trunk/pinot.spec.in	2007-09-04 12:00:45 UTC (rev 964)
@@ -73,7 +73,7 @@
 
 %build
 %configure %{?_with_soap:--enable-soap=yes} %{?_with_debug:--enable-debug=yes}
-make
+make %{?_smp_mflags}
 
 %install
 [ -n "$RPM_BUILD_ROOT" -a "$RPM_BUILD_ROOT" != / ] && rm -rf $RPM_BUILD_ROOT
@@ -97,7 +97,7 @@
 
 %files -f %{name}.lang
 %defattr(-, root, root, -)
-%doc AUTHORS ChangeLog ChangeLog-dijon COPYING NEWS README TODO
+%doc AUTHORS ChangeLog ChangeLog-dijon COPYING FAQ NEWS README TODO
 %config(noreplace) %{_sysconfdir}/pinot/
 %{_bindir}/pinot
 %{_bindir}/pinot-dbus-daemon



From fabricecolin at mail.berlios.de  Tue Sep  4 14:07:19 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 4 Sep 2007 14:07:19 +0200
Subject: [Pinot-svn] r965 - in trunk: Search Tokenize
Message-ID: <200709041207.l84C7JAs012453@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-04 14:07:18 +0200 (Tue, 04 Sep 2007)
New Revision: 965

Removed:
   trunk/Search/xesam/
   trunk/Tokenize/filters/
Log:
Will replace these directories with externals.




From fabricecolin at mail.berlios.de  Tue Sep  4 14:14:43 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 4 Sep 2007 14:14:43 +0200
Subject: [Pinot-svn] r966 - trunk
Message-ID: <200709041214.l84CEhek012920@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-04 14:14:42 +0200 (Tue, 04 Sep 2007)
New Revision: 966

Modified:
   trunk/
   trunk/TODO
Log:
Replaced Search/xesam and Tokenize/filters with externals.
More stuff to do...



Property changes on: trunk
___________________________________________________________________
Name: svn:externals
   + Search/xesam		svn://svn.berlios.de/dijon/branches/pinot/xesam
Tokenize/filters	svn://svn.berlios.de/dijon/branches/pinot/filters


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2007-09-04 12:07:18 UTC (rev 965)
+++ trunk/TODO	2007-09-04 12:14:42 UTC (rev 966)
@@ -17,6 +17,9 @@
 - Extend metadata beyond title,location,language,type,timestamp,size
 - Sync with gtk+'s xdgmime
 - Build against Fedora's patched libtextcat
+- Remove Pinot dependencies from Dijon, move code to trunk
+- Don't package gmo files, they are platform dependent
+- Use po/LINGUAS
 
 Tokenize
 - Allow to cache documents that had to be converted ? eg PDF, MS Word
@@ -67,8 +70,6 @@
 - Index Nautilus metadata (http://linuxboxadmin.com/articles/nautilus.php)
 - Reverse terms so that left wildcards can be applied ?
 - XapianIndex could do with some common code refactoring
-- With Xapian >= 1.0, all indexes can be browsed with the new global posting list, ie
-  Xapian::Database::postlist_begin("")
 - Xapian > 1.0 has a version of Xapian::Database::allterms_begin() that takes a prefix
 - With Xapian > 1.0.2, for date ranges, use QueryParser::add_valuerangeprocessor()
  NumberValueRangeProcessor and sortable_serialise()
@@ -131,5 +132,6 @@
 - Show which stored queries are fully, partially or not at all Web friendly
 - List viewed URLs
 - Unify ExpandQuery and Querying threads !
-- Keep a list of recently used URLs, eg in the import dialog
+- Suggest links from previous results when importing, as done for terms
+- Let queries index only new results
 



From fabricecolin at mail.berlios.de  Sat Sep  8 12:58:58 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 8 Sep 2007 12:58:58 +0200
Subject: [Pinot-svn] r967 - in trunk: Index Search UI/GTK2/src Utils
Message-ID: <200709081058.l88AwwT5009319@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-08 12:58:49 +0200 (Sat, 08 Sep 2007)
New Revision: 967

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/Search/QueryProperties.cpp
   trunk/Search/QueryProperties.h
   trunk/Search/XapianEngine.cpp
   trunk/Search/XapianEngine.h
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/queryDialog.cc
   trunk/UI/GTK2/src/queryDialog.hh
   trunk/UI/GTK2/src/queryDialog_glade.cc
   trunk/UI/GTK2/src/queryDialog_glade.hh
   trunk/Utils/StringManip.cpp
   trunk/Utils/StringManip.h
Log:
Date ranges are now part of the query string in the form "yyyymmdd..yyyymmdd"
and processed with a DateValueRangeProcessor. Users can use the query dialog's
new "Date range" filter.
D, M and Y terms need not be generated for each document.
If Xapian > 1.0.2, spelling correction is enabled. Whenever a query on an index
doesn't return anything, the UI creates a new query (prefixed with "Corrected ")
that suggests replacement terms.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/Index/XapianIndex.cpp	2007-09-08 10:58:49 UTC (rev 967)
@@ -417,16 +417,6 @@
 		}
 		doc.add_term(string("XEXT:") + XapianDatabase::limitTermLength(extension));
 	}
-	// Add the date terms D, M and Y
-	time_t timeT = TimeConverter::fromTimestamp(info.getTimestamp());
-	struct tm *tm = localtime(&timeT);
-	string yyyymmdd = TimeConverter::toYYYYMMDDString(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday);
-	if (yyyymmdd.length() == 8)
-	{
-		doc.add_term(string("D") + yyyymmdd);
-		doc.add_term(string("M") + yyyymmdd.substr(0, 6));
-		doc.add_term(string("Y") + yyyymmdd.substr(0, 4));
-	}
 	// Finally, add the language code with prefix L
 	doc.add_term(string("L") + Languages::toCode(m_stemLanguage));
 	// ...and the MIME type with prefix T
@@ -551,16 +541,6 @@
 		}
 		commonTerms.insert(string("XEXT:") + XapianDatabase::limitTermLength(extension));
 	}
-	// Date terms
-	time_t timeT = TimeConverter::fromTimestamp(docInfo.getTimestamp());
-	struct tm *tm = localtime(&timeT);
-	string yyyymmdd = TimeConverter::toYYYYMMDDString(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday);
-	if (yyyymmdd.length() == 8)
-	{
-		commonTerms.insert(string("D") + yyyymmdd);
-		commonTerms.insert(string("M") + yyyymmdd.substr(0, 6));
-		commonTerms.insert(string("Y") + yyyymmdd.substr(0, 4));
-	}
 	// Language code
 	commonTerms.insert(string("L") + Languages::toCode(language));
 	// MIME type
@@ -626,9 +606,12 @@
 	const string &language) const
 {
 	time_t timeT = TimeConverter::fromTimestamp(info.getTimestamp());
+	struct tm *tm = localtime(&timeT);
+	string yyyymmdd(TimeConverter::toYYYYMMDDString(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday));
 
 	// Add this value to allow sorting by date
-	doc.add_value(0, StringManip::integerToBinaryString((uint32_t)timeT));
+	doc.add_value(0, yyyymmdd);
+	// FIXME: add a value for size
 
 	DocumentInfo docCopy(info);
 	docCopy.setLanguage(language);

Modified: trunk/Search/QueryProperties.cpp
===================================================================
--- trunk/Search/QueryProperties.cpp	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/Search/QueryProperties.cpp	2007-09-08 10:58:49 UTC (rev 967)
@@ -29,14 +29,6 @@
 QueryProperties::QueryProperties() :
 	m_type(XAPIAN_QP),
 	m_resultsCount(10),
-	m_enableMinDate(false),
-	m_minDay(0),
-	m_minMonth(0),
-	m_minYear(0),
-	m_enableMaxDate(false),
-	m_maxDay(0),
-	m_maxMonth(0),
-	m_maxYear(0),
 	m_indexResults(false)
 {
 }
@@ -47,14 +39,6 @@
 	m_type(type),
 	m_freeQuery(freeQuery),
 	m_resultsCount(10),
-	m_enableMinDate(false),
-	m_minDay(0),
-	m_minMonth(0),
-	m_minYear(0),
-	m_enableMaxDate(false),
-	m_maxDay(0),
-	m_maxMonth(0),
-	m_maxYear(0),
 	m_indexResults(false)
 {
 	removeFilters();
@@ -69,14 +53,6 @@
 	m_hostFilter(other.m_hostFilter),
 	m_fileFilter(other.m_fileFilter),
 	m_resultsCount(other.m_resultsCount),
-	m_enableMinDate(other.m_enableMinDate),
-	m_minDay(other.m_minDay),
-	m_minMonth(other.m_minMonth),
-	m_minYear(other.m_minYear),
-	m_enableMaxDate(other.m_enableMaxDate),
-	m_maxDay(other.m_maxDay),
-	m_maxMonth(other.m_maxMonth),
-	m_maxYear(other.m_maxYear),
 	m_indexResults(other.m_indexResults),
 	m_labelName(other.m_labelName)
 {
@@ -98,14 +74,6 @@
 		m_hostFilter = other.m_hostFilter;
 		m_fileFilter = other.m_fileFilter;
 		m_resultsCount = other.m_resultsCount;
-		m_enableMinDate = other.m_enableMinDate;
-		m_minDay = other.m_minDay;
-		m_minMonth = other.m_minMonth;
-		m_minYear = other.m_minYear;
-		m_enableMaxDate = other.m_enableMaxDate;
-		m_maxDay = other.m_maxDay;
-		m_maxMonth = other.m_maxMonth;
-		m_maxYear = other.m_maxYear;
 		m_indexResults = other.m_indexResults;
 		m_labelName = other.m_labelName;
 	}
@@ -270,44 +238,6 @@
 	return m_resultsCount;
 }
 
-/// Sets the minimum date.
-void QueryProperties::setMinimumDate(bool enable, unsigned int day, unsigned int month, unsigned int year)
-{
-	m_enableMinDate = enable;
-	m_minDay = day;
-	m_minMonth = month;
-	m_minYear = year;
-}
-
-/// Gets the minimum date.
-bool QueryProperties::getMinimumDate(unsigned int &day, unsigned int &month, unsigned int &year) const
-{
-	day = m_minDay;
-	month = m_minMonth;
-	year = m_minYear;
-
-	return m_enableMinDate;
-}
-
-/// Sets the maximum date.
-void QueryProperties::setMaximumDate(bool enable, unsigned int day, unsigned int month, unsigned int year)
-{
-	m_enableMaxDate = enable;
-	m_maxDay = day;
-	m_maxMonth = month;
-	m_maxYear = year;
-}
-
-/// Gets the maximum date.
-bool QueryProperties::getMaximumDate(unsigned int &day, unsigned int &month, unsigned int &year) const
-{
-	day = m_maxDay;
-	month = m_maxMonth;
-	year = m_maxYear;
-
-	return m_enableMaxDate;
-}
-
 /// Sets whether results should be indexed.
 void QueryProperties::setIndexResults(bool index)
 {
@@ -352,9 +282,7 @@
 /// Returns whether the query is empty.
 bool QueryProperties::isEmpty() const
 {
-	if ((m_freeQuery.empty() == true) &&
-		(m_enableMinDate == false) &&
-		(m_enableMaxDate == false))
+	if (m_freeQuery.empty() == true)
 	{
 		return true;
 	}

Modified: trunk/Search/QueryProperties.h
===================================================================
--- trunk/Search/QueryProperties.h	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/Search/QueryProperties.h	2007-09-08 10:58:49 UTC (rev 967)
@@ -69,16 +69,6 @@
 		/// Gets the maximum number of results.
 		unsigned int getMaximumResultsCount(void) const;
 
-		/// Sets the minimum date.
-		void setMinimumDate(bool enable, unsigned int day, unsigned int month, unsigned int year);
-		/// Gets the minimum date.
-		bool getMinimumDate(unsigned int &day, unsigned int &month, unsigned int &year) const;
-
-		/// Sets the maximum date.
-		void setMaximumDate(bool enable, unsigned int day, unsigned int month, unsigned int year);
-		/// Gets the maximum date.
-		bool getMaximumDate(unsigned int &day, unsigned int &month, unsigned int &year) const;
-
 		/// Sets whether results should be indexed.
 		void setIndexResults(bool index);
 		/// Gets whether results should be indexed
@@ -104,14 +94,6 @@
 		string m_hostFilter;
 		string m_fileFilter;
 		unsigned int m_resultsCount;
-		bool m_enableMinDate;
-		unsigned int m_minDay;
-		unsigned int m_minMonth;
-		unsigned int m_minYear;
-		bool m_enableMaxDate;
-		unsigned int m_maxDay;
-		unsigned int m_maxMonth;
-		unsigned int m_maxYear;
 		bool m_indexResults;
 		string m_labelName;
 

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/Search/XapianEngine.cpp	2007-09-08 10:58:49 UTC (rev 967)
@@ -112,85 +112,6 @@
 {
 }
 
-Xapian::Query XapianEngine::dateFilter(unsigned int minDay, unsigned int minMonth, unsigned int minYear,
-	unsigned int maxDay, unsigned int maxMonth, unsigned int maxYear)
-{
-	// The following was lifted from Xapian's date_range_filter() in
-	// xapian-applications/omega/date.cc and prettified slightly
-	vector<Xapian::Query> v;
-	char buf[10];
-
-	snprintf(buf, 10, "D%04d%02d", minYear, minMonth);
-	int d_last = lastDay(minYear, minMonth);
-	int d_end = d_last;
-	if (minYear == maxYear && minMonth == maxMonth && maxDay < d_last)
-	{
-		d_end = maxDay;
-	}
-	// Deal with any initial partial month
-	if (minDay > 1 || d_end < d_last)
-	{
-		for ( ; minDay <= d_end ; minDay++)
-		{
-			snprintf(buf + 7, 3, "%02d", minDay);
-			v.push_back(Xapian::Query(buf));
-		}
-	} else {
-		buf[0] = 'M';
-		v.push_back(Xapian::Query(buf));
-	}
-	
-	if (minYear == maxYear && minMonth == maxMonth)
-	{
-		return Xapian::Query(Xapian::Query::OP_OR, v.begin(), v.end());
-	}
-
-	int m_last = (minYear < maxYear) ? 12 : maxMonth - 1;
-	while (++minMonth <= m_last)
-	{
-		snprintf(buf + 5, 5, "%02d", minMonth);
-		buf[0] = 'M';
-		v.push_back(Xapian::Query(buf));
-	}
-	
-	if (minYear < maxYear)
-	{
-		while (++minYear < maxYear)
-		{
-			snprintf(buf + 1, 9, "%04d", minYear);
-			buf[0] = 'Y';
-			v.push_back(Xapian::Query(buf));
-		}
-		snprintf(buf + 1, 9, "%04d", maxYear);
-		buf[0] = 'M';
-		for (minMonth = 1; minMonth < maxMonth; minMonth++)
-		{
-			snprintf(buf + 5, 5, "%02d", minMonth);
-			v.push_back(Xapian::Query(buf));
-		}
-	}
-	
-	snprintf(buf + 5, 5, "%02d", maxMonth);
-
-	// Deal with any final partial month
-	if (maxDay < lastDay(maxYear, maxMonth))
-	{
-		buf[0] = 'D';
-		for (minDay = 1 ; minDay <= maxDay; minDay++)
-		{
-			snprintf(buf + 7, 3, "%02d", minDay);
-			v.push_back(Xapian::Query(buf));
-		}
-	}
-	else
-	{
-		buf[0] = 'M';
-		v.push_back(Xapian::Query(buf));
-	}
-
-	return Xapian::Query(Xapian::Query::OP_OR, v.begin(), v.end());
-}
-
 Xapian::Query XapianEngine::parseQuery(Xapian::Database *pIndex, const QueryProperties &queryProps,
 	const string &stemLanguage, DefaultOperator defaultOperator,
 	string &correctedFreeQuery, bool minimal)
@@ -343,11 +264,15 @@
 	if (minimal == false)
 	{
 		flags |= Xapian::QueryParser::FLAG_WILDCARD;
-#if 0
+#if ENABLE_XAPIAN_SPELLING_CORRECTION>0
 		flags |= Xapian::QueryParser::FLAG_SPELLING_CORRECTION;
 #endif
 	}
 
+	// Date range
+	Xapian::DateValueRangeProcessor dateProcessor(0);
+	parser.add_valuerangeprocessor(&dateProcessor);
+
 	// Parse the query string
 	Xapian::Query parsedQuery = parser.parse_query(freeQuery, flags);
 	if (minimal == true)
@@ -355,7 +280,7 @@
 		return parsedQuery;
 	}
 
-#if 0
+#if ENABLE_XAPIAN_SPELLING_CORRECTION>0
 	// Any correction ?
 	correctedFreeQuery = parser.get_corrected_query_string();
 #ifdef DEBUG
@@ -363,60 +288,6 @@
 #endif
 #endif
 
-	// Apply a date range ?
-	bool enableMin = queryProps.getMinimumDate(minDay, minMonth, minYear);
-	bool enableMax = queryProps.getMaximumDate(maxDay, maxMonth, maxYear);
-	if ((enableMin == false) && 
-		(enableMax == false))
-	{
-		// No
-		return parsedQuery;
-	}
-
-	// Anyone going as far back as Year 0 is taking the piss :-)
-	if ((enableMin == false) ||
-		(minYear == 0))
-	{
-		minDay = minMonth = 1;
-		minYear = 1970;
-	}
-	// If the second date is older than the Epoch, the first date should be set too
-	if ((enableMax == false) ||
-		(maxYear == 0))
-	{
-		time_t nowTime = time(NULL);
-		struct tm *timeTm = localtime(&nowTime);
-		maxYear = timeTm->tm_year + 1900;
-		maxMonth = timeTm->tm_mon + 1;
-		maxDay = timeTm->tm_mday;
-	}
-
-	string yyyymmddMin(TimeConverter::toYYYYMMDDString(minYear, minMonth, minDay));
-	string yyyymmddMax(TimeConverter::toYYYYMMDDString(maxYear, maxMonth, maxDay));
-	time_t startTime = TimeConverter::fromYYYYMMDDString(yyyymmddMin);
-	time_t endTime = TimeConverter::fromYYYYMMDDString(yyyymmddMax);
- 
-	double diffTime = difftime(endTime, startTime);
-	if (diffTime > 0)
-	{
-		Xapian::Query dateQuery = dateFilter(minDay, minMonth, minYear, maxDay, maxMonth, maxYear);
-
-#ifdef DEBUG
-		cout << "XapianEngine::parseQuery: applied date range ("
-			<< yyyymmddMax << " <= " << yyyymmddMin << ")" << endl;
-#endif
-		if (parsedQuery.empty() == false)
-		{
-			return Xapian::Query(Xapian::Query::OP_FILTER, parsedQuery, dateQuery);
-		}
-
-		return dateQuery;
-	}
-#ifdef DEBUG
-	else cout << "XapianEngine::parseQuery: date range is zero or bogus ("
-		<< yyyymmddMax << " <= " << yyyymmddMin << ")" << endl;
-#endif
-
 	return parsedQuery;
 }
 

Modified: trunk/Search/XapianEngine.h
===================================================================
--- trunk/Search/XapianEngine.h	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/Search/XapianEngine.h	2007-09-08 10:58:49 UTC (rev 967)
@@ -28,6 +28,21 @@
 #include "SearchEngineInterface.h"
 #include "DownloaderFactory.h"
 
+// Spelling correction in Xapian <= 1.0.2 may cause a crash
+// See http://www.xapian.org/cgi-bin/bugzilla/show_bug.cgi?id=194
+#define ENABLE_XAPIAN_SPELLING_CORRECTION 0
+#if XAPIAN_MAJOR_VERSION>1
+#define ENABLE_XAPIAN_SPELLING_CORRECTION 1
+#elif XAPIAN_MAJOR_VERSION==1
+#if XAPIAN_MINOR_VERSION>0
+#define ENABLE_XAPIAN_SPELLING_CORRECTION 1
+#else
+#if XAPIAN_REVISION>2
+#define ENABLE_XAPIAN_SPELLING_CORRECTION 1
+#endif
+#endif
+#endif
+
 /// Wraps Xapian's search funtionality.
 class XapianEngine : public SearchEngineInterface
 {
@@ -53,9 +68,6 @@
 		bool queryDatabase(Xapian::Database *pIndex, Xapian::Query &query,
 			unsigned int startDoc, unsigned int maxResultsCount);
 
-		static Xapian::Query dateFilter(unsigned int minDay, unsigned int minMonth, unsigned int minYear,
-		        unsigned int maxDay, unsigned int maxMonth, unsigned int maxYear);
-
 		static Xapian::Query parseQuery(Xapian::Database *pIndex, const QueryProperties &queryProps,
 			const string &stemLanguage, DefaultOperator defaultOperator,
 			string &correctedFreeQuery, bool minimal = false);

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2007-09-08 10:58:49 UTC (rev 967)
@@ -666,12 +666,9 @@
 
 	QueryProperties queryProps;
 	Date minDate, maxDate;
-	string backCompatString;
+	string freeQuery;
 	bool enableMinDate = false, enableMaxDate = false;
 
-	minDate.set_time(time(NULL));
-	maxDate.set_time(time(NULL));
-
 	// Load the query's properties
 	for (Node::NodeList::iterator iter = childNodes.begin(); iter != childNodes.end(); ++iter)
 	{
@@ -690,88 +687,88 @@
 		}
 		else if (nodeName == "text")
 		{
-			queryProps.setFreeQuery(nodeContent);
+			freeQuery = nodeContent;
 		}
 		else if ((nodeName == "and") &&
 			(nodeContent.empty() == false))
 		{
-			if (backCompatString.empty() == false)
+			if (freeQuery.empty() == false)
 			{
-				backCompatString += " ";
+				freeQuery += " ";
 			}
-			backCompatString += nodeContent;
+			freeQuery += nodeContent;
 		}
 		else if ((nodeName == "phrase") &&
 			(nodeContent.empty() == false))
 		{
-			if (backCompatString.empty() == false)
+			if (freeQuery.empty() == false)
 			{
-				backCompatString += " ";
+				freeQuery += " ";
 			}
-			backCompatString += "\"";
-			backCompatString += nodeContent;
-			backCompatString += "\"";
+			freeQuery += "\"";
+			freeQuery += nodeContent;
+			freeQuery += "\"";
 		}
 		else if ((nodeName == "any") &&
 			(nodeContent.empty() == false))
 		{
 			// FIXME: don't be lazy and add those correctly
-			if (backCompatString.empty() == false)
+			if (freeQuery.empty() == false)
 			{
-				backCompatString += " ";
+				freeQuery += " ";
 			}
-			backCompatString += nodeContent;
+			freeQuery += nodeContent;
 		}
 		else if ((nodeName == "not") &&
 			(nodeContent.empty() == false))
 		{
-			if (backCompatString.empty() == false)
+			if (freeQuery.empty() == false)
 			{
-				backCompatString += " ";
+				freeQuery += " ";
 			}
-			backCompatString += "-(";
-			backCompatString += nodeContent;
-			backCompatString += ")";
+			freeQuery += "-(";
+			freeQuery += nodeContent;
+			freeQuery += ")";
 		}
 		else if ((nodeName == "language") &&
 			(nodeContent.empty() == false))
 		{
-			if (backCompatString.empty() == false)
+			if (freeQuery.empty() == false)
 			{
-				backCompatString += " ";
+				freeQuery += " ";
 			}
-			backCompatString += "language:";
-			backCompatString += nodeContent;
+			freeQuery += "language:";
+			freeQuery += nodeContent;
 		}
 		else if ((nodeName == "hostfilter") &&
 			(nodeContent.empty() == false))
 		{
-			if (backCompatString.empty() == false)
+			if (freeQuery.empty() == false)
 			{
-				backCompatString += " ";
+				freeQuery += " ";
 			}
-			backCompatString += "site:";
-			backCompatString += nodeContent;
+			freeQuery += "site:";
+			freeQuery += nodeContent;
 		}
 		else if ((nodeName == "filefilter") &&
 			(nodeContent.empty() == false))
 		{
-			if (backCompatString.empty() == false)
+			if (freeQuery.empty() == false)
 			{
-				backCompatString += " ";
+				freeQuery += " ";
 			}
-			backCompatString += "file:";
-			backCompatString += nodeContent;
+			freeQuery += "file:";
+			freeQuery += nodeContent;
 		}
 		else if ((nodeName == "labelfilter") &&
 			(nodeContent.empty() == false))
 		{
-			if (backCompatString.empty() == false)
+			if (freeQuery.empty() == false)
 			{
-				backCompatString += " ";
+				freeQuery += " ";
 			}
-			backCompatString += "label:";
-			backCompatString += nodeContent;
+			freeQuery += "label:";
+			freeQuery += nodeContent;
 		}
 		else if (nodeName == "maxresults")
 		{
@@ -784,12 +781,10 @@
 			{
 				enableMinDate = true;
 			}
-			queryProps.setMinimumDate(enableMinDate, minDate.get_day(), minDate.get_month(), minDate.get_year());
 		}
 		else if (nodeName == "mindate")
 		{
 			minDate.set_parse(nodeContent);
-			queryProps.setMinimumDate(enableMinDate, minDate.get_day(), minDate.get_month(), minDate.get_year());
 		}
 		else if (nodeName == "enablemaxdate")
 		{
@@ -797,12 +792,10 @@
 			{
 				enableMaxDate = true;
 			}
-			queryProps.setMaximumDate(enableMaxDate, maxDate.get_day(), maxDate.get_month(), maxDate.get_year());
 		}
 		else if (nodeName == "maxdate")
 		{
 			maxDate.set_parse(nodeContent);
-			queryProps.setMaximumDate(enableMaxDate, maxDate.get_day(), maxDate.get_month(), maxDate.get_year());
 		}
 		else if (nodeName == "index")
 		{
@@ -821,12 +814,42 @@
 		}
 	}
 
+	// Are pre-0.80 dates specified ?
+	if ((enableMinDate == true) ||
+		(enableMaxDate == true))
+	{
+		// Provide reasonable defaults
+		if (enableMinDate == false)
+		{
+			minDate.set_day(1);
+			minDate.set_month(Date::JANUARY);
+			minDate.set_year(1970);
+		}
+		if (enableMaxDate == false)
+		{
+			maxDate.set_day(31);
+			maxDate.set_month(Date::DECEMBER);
+			maxDate.set_year(2099);
+		}
+
+		ustring minDateStr(minDate.format_string("%Y%m%d"));
+		ustring maxDateStr(maxDate.format_string("%Y%m%d"));
+
+#ifdef DEBUG
+		cout << "PinotSettings::loadQueries: date range " << minDateStr << " to " << maxDateStr << endl;
+#endif
+		freeQuery += " ";
+		freeQuery += minDateStr;
+		freeQuery += "..";
+		freeQuery += maxDateStr;
+	}
+
 	// We need at least a name
 	if (queryProps.getName().empty() == false)
 	{
-		if (backCompatString.empty() == false)
+		if (freeQuery.empty() == false)
 		{
-			queryProps.setFreeQuery(backCompatString);
+			queryProps.setFreeQuery(freeQuery);
 		}
 		m_queries[queryProps.getName()] = queryProps;
 	}
@@ -1268,27 +1291,12 @@
 				return false;
 			}
 
-			Date aDate;
 			unsigned int day, month, year;
 
 			addChildElement(pElem, "name", queryIter->first);
 			addChildElement(pElem, "text", queryIter->second.getFreeQuery());
 			sprintf(numStr, "%u", queryIter->second.getMaximumResultsCount());
 			addChildElement(pElem, "maxresults", numStr);
-			bool enable = queryIter->second.getMinimumDate(day, month, year);
-			if (year > 0)
-			{
-				addChildElement(pElem, "enablemindate", (enable ? "YES" : "NO"));
-				aDate.set_dmy((Date::Day )day, (Date::Month )month, (Date::Year )year);
-				addChildElement(pElem, "mindate", aDate.format_string("%F"));
-			}
-			enable = queryIter->second.getMaximumDate(day, month, year);
-			if (year > 0)
-			{
-				addChildElement(pElem, "enablemaxdate", (enable ? "YES" : "NO"));
-				aDate.set_dmy((Date::Day )day, (Date::Month )month, (Date::Year )year);
-				addChildElement(pElem, "maxdate", aDate.format_string("%F"));
-			}
 			addChildElement(pElem, "index", (queryIter->second.getIndexResults() ? "ALL" : "NONE"));
 			addChildElement(pElem, "label", queryIter->second.getLabelName());
 		}

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-08 10:58:49 UTC (rev 967)
@@ -370,6 +370,45 @@
 }
 
 //
+// Add a query
+//
+void mainWindow::add_query(QueryProperties &queryProps, bool mergeQueries)
+{
+	ustring queryName(queryProps.getName());
+
+	// Does such a query already exist ?
+	TreeModel::Children children = m_refQueryTree->children();
+	for (TreeModel::Children::iterator iter = children.begin();
+		iter != children.end(); ++iter)
+	{
+		TreeModel::Row row = *iter;
+
+		if (queryName == from_utf8(row[m_queryColumns.m_name]))
+		{
+			if (mergeQueries == true)
+			{
+				QueryProperties existingQueryProps = row[m_queryColumns.m_properties];
+				ustring freeQuery(existingQueryProps.getFreeQuery());
+
+				if (freeQuery != queryProps.getFreeQuery())
+				{
+					queryProps.setFreeQuery(freeQuery + " | " + queryProps.getFreeQuery());
+				}
+			}
+			m_settings.removeQuery(queryName);
+			break;
+		}
+	}
+
+	// Update everything
+	if (m_settings.addQuery(queryProps) == true)
+	{
+		populate_queryTreeview(queryName);
+		queryExpander->set_expanded(true);
+	}	
+}
+
+//
 // Query list selection changed
 //
 void mainWindow::on_queryTreeviewSelection_changed()
@@ -1000,8 +1039,25 @@
 			pResultsTree->deleteResults(engineName);
 			pResultsTree->addResults(engineName, resultsList,
 				resultsCharset);
+		}
 
-			// FIXME: if wasCorrected is true, suggest the correction to the user
+		// Suggest the correction to the user
+		if (wasCorrected == true)
+		{
+			ustring correctedQueryName(_("Corrected"));
+
+			if (queryName.empty() == true)
+			{
+				correctedQueryName += "...";
+			}
+			else
+			{
+				correctedQueryName += " ";
+				correctedQueryName += queryName;
+			}
+			queryProps.setName(correctedQueryName);
+
+			add_query(queryProps, true);
 		}
 
 		// Index results ?
@@ -1092,6 +1148,8 @@
 		{
 			moreLike = " ";
 		}
+
+		// Add the expand terms
 		for (set<string>::const_iterator termIter = expandTerms.begin();
 			termIter != expandTerms.end(); ++termIter)
 		{
@@ -1101,30 +1159,9 @@
 			}
 			moreLike += *termIter;
 		}
-
-		// Does such a query already exist ?
-		TreeModel::Children children = m_refQueryTree->children();
-		for (TreeModel::Children::iterator iter = children.begin();
-			iter != children.end(); ++iter)
-		{
-			TreeModel::Row row = *iter;
-
-			if (queryName == from_utf8(row[m_queryColumns.m_name]))
-			{
-				m_settings.removeQuery(queryName);
-				break;
-			}
-		}
-
-		// Add these terms
 		queryProps.setFreeQuery(queryProps.getFreeQuery() + moreLike);
 
-		// Update everything
-		if (m_settings.addQuery(queryProps) == true)
-		{
-			populate_queryTreeview(queryName);
-			queryExpander->set_expanded(true);
-		}
+		add_query(queryProps, false);
 	}
 	else if (type == "LabelUpdateThread")
 	{
@@ -1395,8 +1432,6 @@
 
 		// Refresh the engines list
 		m_pEnginesTree->populate();
-		// ...and the index menu
-		populate_indexMenu();
 	}
 
 	set_status(_("Edited index"));

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/UI/GTK2/src/mainWindow.hh	2007-09-08 10:58:49 UTC (rev 967)
@@ -60,6 +60,7 @@
 	void save_queryTreeview();
 	void populate_cacheMenu();
 	void populate_indexMenu();
+	void add_query(QueryProperties &queryProps, bool mergeQueries);
 
 	// Handlers
 	bool on_queryCompletion_match(const Glib::ustring &key, const Gtk::TreeModel::const_iterator &iter);

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/UI/GTK2/src/queryDialog.cc	2007-09-08 10:58:49 UTC (rev 967)
@@ -27,7 +27,6 @@
 #include "TimeConverter.h"
 #include "PinotUtils.h"
 #include "queryDialog.hh"
-#include "dateDialog.hh"
 
 using namespace std;
 using namespace Glib;
@@ -59,29 +58,6 @@
 	}
 	// Maximum number of results
 	resultsCountSpinbutton->set_value((double)m_properties.getMaximumResultsCount());
-	// Date range
-	bool enable = m_properties.getMinimumDate(day, month, year);
-	if (year > 0)
-	{
-		m_fromDate.set_dmy((Date::Day )day, (Date::Month )month, (Date::Year )year);
-	}
-	else
-	{
-		m_fromDate.set_time(time(NULL));
-	}
-	fromCheckbutton->set_active(enable);
-	fromButton->set_label(m_fromDate.format_string("%x"));
-	enable = m_properties.getMaximumDate(day, month, year);
-	if (year > 0)
-	{
-		m_toDate.set_dmy((Date::Day )day, (Date::Month )month, (Date::Year )year);
-	}
-	else
-	{
-		m_toDate.set_time(time(NULL));
-	}
-	toCheckbutton->set_active(enable);
-	toButton->set_label(m_toDate.format_string("%x"));
 	// Index all results
 	indexCheckbutton->set_active(m_properties.getIndexResults());
 
@@ -146,6 +122,7 @@
 	filterCombobox->append_text(_("Language code"));
 	filterCombobox->append_text(_("MIME type"));
 	filterCombobox->append_text(_("Label"));
+	filterCombobox->append_text(_("Date range"));
 	filterCombobox->set_active(0);
 }
 
@@ -186,9 +163,6 @@
 	}
 	// Maximum number of results
 	m_properties.setMaximumResultsCount((unsigned int)resultsCountSpinbutton->get_value());
-	// Date range
-	m_properties.setMinimumDate(fromCheckbutton->get_active(), m_fromDate.get_day(), m_fromDate.get_month(), m_fromDate.get_year());
-	m_properties.setMaximumDate(toCheckbutton->get_active(), m_toDate.get_day(), m_toDate.get_month(), m_toDate.get_year());
 	// Index all results
 	m_properties.setIndexResults(indexCheckbutton->get_active());
 	// Index label
@@ -216,6 +190,9 @@
 void queryDialog::on_addFilterButton_clicked()
 {
 	ustring filter;
+	time_t timeT = time(NULL);
+	struct tm *tm = localtime(&timeT);
+	bool isDateRange = false;
 
 	// What's the corresponding filter ?
 	int chosenFilter = filterCombobox->get_active_row_number();
@@ -252,6 +229,11 @@
 		case 9:
 			filter = "label";
 			break;
+		case 10:
+			filter = TimeConverter::toYYYYMMDDString(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday);
+			filter += "..20991231";
+			isDateRange = true;
+			break;
 		default:
 			break;
 	}
@@ -262,38 +244,11 @@
 		ustring queryText = refBuffer->get_text();
 		queryText += " ";
 		queryText += filter;
-		queryText += ":xxx";
+		if (isDateRange == false)
+		{
+			queryText += ":xxx";
+		}
 		refBuffer->set_text(queryText);
 	}
 }
 
-void queryDialog::on_fromButton_clicked()
-{
-	dateDialog datePicker(_("Start date"), m_fromDate);
-
-#ifdef DEBUG
-	cout << "queryDialog::on_fromButton_clicked: start date is " << m_fromDate.format_string("%x") << endl;
-#endif
-	datePicker.show();
-	if (datePicker.run() == RESPONSE_OK)
-	{
-		datePicker.getChoice(m_fromDate);
-		fromButton->set_label(m_fromDate.format_string("%x"));
-	}
-}
-
-void queryDialog::on_toButton_clicked()
-{
-	dateDialog datePicker(_("End date"), m_toDate);
-
-#ifdef DEBUG
-	cout << "queryDialog::on_toButton_clicked: end date is " << m_toDate.format_string("%x") << endl;
-#endif
-	datePicker.show();
-	if (datePicker.run() == RESPONSE_OK)
-	{
-		datePicker.getChoice(m_toDate);
-	        toButton->set_label(m_toDate.format_string("%x"));
-	}
-}
-

Modified: trunk/UI/GTK2/src/queryDialog.hh
===================================================================
--- trunk/UI/GTK2/src/queryDialog.hh	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/UI/GTK2/src/queryDialog.hh	2007-09-08 10:58:49 UTC (rev 967)
@@ -52,8 +52,6 @@
 	virtual void on_queryOkbutton_clicked();
 	virtual void on_nameEntry_changed();
 	virtual void on_addFilterButton_clicked();
-        virtual void on_fromButton_clicked();
-        virtual void on_toButton_clicked();
 
 };
 #endif

Modified: trunk/UI/GTK2/src/queryDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog_glade.cc	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/UI/GTK2/src/queryDialog_glade.cc	2007-09-08 10:58:49 UTC (rev 967)
@@ -1,4 +1,4 @@
-// generated 2007/8/3 22:14:46 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/7 23:17:50 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -86,10 +86,6 @@
    Gtk::Label *resultsCountLabel = Gtk::manage(new class Gtk::Label(_("Number of results:")));
    Gtk::Adjustment *resultsCountSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(10, 10, 100, 10, 20, 20));
    resultsCountSpinbutton = Gtk::manage(new class Gtk::SpinButton(*resultsCountSpinbutton_adj, 1, 0));
-   fromCheckbutton = Gtk::manage(new class Gtk::CheckButton(_("Start date:")));
-   toCheckbutton = Gtk::manage(new class Gtk::CheckButton(_("End date:")));
-   fromButton = Gtk::manage(new class Gtk::Button(_("Date")));
-   toButton = Gtk::manage(new class Gtk::Button(_("Date")));
    
    Gtk::Table *actionsTable = Gtk::manage(new class Gtk::Table(2, 2, false));
    Gtk::VBox *queryVbox = Gtk::manage(new class Gtk::VBox(false, 0));
@@ -169,28 +165,12 @@
    resultsCountSpinbutton->set_numeric(false);
    resultsCountSpinbutton->set_digits(0);
    resultsCountSpinbutton->set_wrap(false);
-   fromCheckbutton->set_flags(Gtk::CAN_FOCUS);
-   fromCheckbutton->set_relief(Gtk::RELIEF_NORMAL);
-   fromCheckbutton->set_mode(true);
-   fromCheckbutton->set_active(false);
-   toCheckbutton->set_flags(Gtk::CAN_FOCUS);
-   toCheckbutton->set_relief(Gtk::RELIEF_NORMAL);
-   toCheckbutton->set_mode(true);
-   toCheckbutton->set_active(false);
-   fromButton->set_flags(Gtk::CAN_FOCUS);
-   fromButton->set_relief(Gtk::RELIEF_NORMAL);
-   toButton->set_flags(Gtk::CAN_FOCUS);
-   toButton->set_relief(Gtk::RELIEF_NORMAL);
    actionsTable->set_row_spacings(0);
    actionsTable->set_col_spacings(0);
-   actionsTable->attach(*indexCheckbutton, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 4, 4);
-   actionsTable->attach(*labelNameCombobox, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   actionsTable->attach(*indexCheckbutton, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 4, 4);
+   actionsTable->attach(*labelNameCombobox, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    actionsTable->attach(*resultsCountLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 4, 4);
    actionsTable->attach(*resultsCountSpinbutton, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   actionsTable->attach(*fromCheckbutton, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 4, 4);
-   actionsTable->attach(*toCheckbutton, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 4, 4);
-   actionsTable->attach(*fromButton, 1, 2, 1, 2, Gtk::FILL, Gtk::FILL, 4, 4);
-   actionsTable->attach(*toButton, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL, 4, 4);
    queryVbox->pack_start(*nameTable, Gtk::PACK_SHRINK, 0);
    queryVbox->pack_start(*queryHbox, Gtk::PACK_SHRINK, 0);
    queryVbox->pack_start(*queryFrame, Gtk::PACK_EXPAND_WIDGET, 4);
@@ -224,18 +204,12 @@
    labelNameCombobox->show();
    resultsCountLabel->show();
    resultsCountSpinbutton->show();
-   fromCheckbutton->show();
-   toCheckbutton->show();
-   fromButton->show();
-   toButton->show();
    actionsTable->show();
    queryVbox->show();
    queryDialog->show();
    queryOkbutton->signal_clicked().connect(SigC::slot(*this, &queryDialog_glade::on_queryOkbutton_clicked), false);
    nameEntry->signal_changed().connect(SigC::slot(*this, &queryDialog_glade::on_nameEntry_changed), false);
    addFilterButton->signal_clicked().connect(SigC::slot(*this, &queryDialog_glade::on_addFilterButton_clicked), false);
-   fromButton->signal_clicked().connect(SigC::slot(*this, &queryDialog_glade::on_fromButton_clicked), false);
-   toButton->signal_clicked().connect(SigC::slot(*this, &queryDialog_glade::on_toButton_clicked), false);
 }
 
 queryDialog_glade::~queryDialog_glade()

Modified: trunk/UI/GTK2/src/queryDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/queryDialog_glade.hh	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/UI/GTK2/src/queryDialog_glade.hh	2007-09-08 10:58:49 UTC (rev 967)
@@ -1,9 +1,9 @@
-// generated 2007/1/11 21:02:42 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/7 23:17:50 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.4 and gtkmm 2.10.5
+// for gtk 2.10.14 and gtkmm 2.10.9
 //
 // Please modify the corresponding derived classes in ./src/queryDialog.hh and./src/queryDialog.cc
 
@@ -53,10 +53,6 @@
         class Gtk::CheckButton * indexCheckbutton;
         class Gtk::ComboBoxText * labelNameCombobox;
         class Gtk::SpinButton * resultsCountSpinbutton;
-        class Gtk::CheckButton * fromCheckbutton;
-        class Gtk::CheckButton * toCheckbutton;
-        class Gtk::Button * fromButton;
-        class Gtk::Button * toButton;
         
         queryDialog_glade();
         
@@ -65,7 +61,5 @@
         virtual void on_queryOkbutton_clicked() = 0;
         virtual void on_nameEntry_changed() = 0;
         virtual void on_addFilterButton_clicked() = 0;
-        virtual void on_fromButton_clicked() = 0;
-        virtual void on_toButton_clicked() = 0;
 };
 #endif

Modified: trunk/Utils/StringManip.cpp
===================================================================
--- trunk/Utils/StringManip.cpp	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/Utils/StringManip.cpp	2007-09-08 10:58:49 UTC (rev 967)
@@ -24,12 +24,6 @@
 #else
 #include <unistd.h>
 #endif
-#ifdef HAVE_ARPA_INET_H
-# include <arpa/inet.h>
-#endif
-#ifdef HAVE_NETINET_IN_H
-# include <netinet/in.h>
-#endif
 #include <ctype.h>
 #include <algorithm>
 
@@ -338,28 +332,3 @@
 	return result;
 }
 
-/// Converts a binary string to an integer.
-uint32_t StringManip::binaryStringToInteger(const string &str)
-{
-	uint32_t value;
-
-	// This is from from Xapian's xapian-applications/omega/values.h
-	if (str.size() != 4)
-	{
-		return (uint32_t)-1;
-	}
-
-	memcpy(&value, str.data(), 4);
-
-	return ntohl(value);
-}
-
-/// Converts an integer to a binary string.
-string StringManip::integerToBinaryString(uint32_t value)
-{
-	// This is from from Xapian's xapian-applications/omega/values.h
-	value = htonl(value);
-
-	return string(reinterpret_cast<const char*>(&value), 4);
-}
-

Modified: trunk/Utils/StringManip.h
===================================================================
--- trunk/Utils/StringManip.h	2007-09-04 12:14:42 UTC (rev 966)
+++ trunk/Utils/StringManip.h	2007-09-08 10:58:49 UTC (rev 967)
@@ -58,12 +58,6 @@
 		/// Hashes a string so that it is no longer than maxLength.
 		static std::string hashString(const std::string &str, unsigned int maxLength);
 
-		/// Converts a binary string to an integer.
-		static uint32_t binaryStringToInteger(const std::string &str);
-
-		/// Converts an integer to a binary string.
-		static std::string integerToBinaryString(uint32_t value);
-
 	protected:
 		StringManip();
 



From fabricecolin at mail.berlios.de  Sat Sep  8 13:04:49 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 8 Sep 2007 13:04:49 +0200
Subject: [Pinot-svn] r968 - in trunk: UI/GTK2 UI/GTK2/src po
Message-ID: <200709081104.l88B4nt5011103@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-08 13:04:46 +0200 (Sat, 08 Sep 2007)
New Revision: 968

Removed:
   trunk/UI/GTK2/src/dateDialog.cc
   trunk/UI/GTK2/src/dateDialog.hh
   trunk/UI/GTK2/src/dateDialog_glade.cc
   trunk/UI/GTK2/src/dateDialog_glade.hh
Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/Makefile.am
   trunk/po/POTFILES.in
Log:
Trimmed down queryDialog, obsoleted dateDialog.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2007-09-08 10:58:49 UTC (rev 967)
+++ trunk/UI/GTK2/metase-gtk2.glade	2007-09-08 11:04:46 UTC (rev 968)
@@ -2531,7 +2531,7 @@
 	  <child>
 	    <widget class="GtkTable" id="actionsTable">
 	      <property name="visible">True</property>
-	      <property name="n_rows">4</property>
+	      <property name="n_rows">2</property>
 	      <property name="n_columns">2</property>
 	      <property name="homogeneous">False</property>
 	      <property name="row_spacing">0</property>
@@ -2553,8 +2553,8 @@
 		<packing>
 		  <property name="left_attach">0</property>
 		  <property name="right_attach">1</property>
-		  <property name="top_attach">3</property>
-		  <property name="bottom_attach">4</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
 		  <property name="x_padding">4</property>
 		  <property name="y_padding">4</property>
 		  <property name="x_options">fill</property>
@@ -2572,8 +2572,8 @@
 		<packing>
 		  <property name="left_attach">1</property>
 		  <property name="right_attach">2</property>
-		  <property name="top_attach">3</property>
-		  <property name="bottom_attach">4</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
 		  <property name="x_padding">4</property>
 		  <property name="y_padding">4</property>
 		  <property name="y_options">fill</property>
@@ -2633,102 +2633,6 @@
 		  <property name="y_options">fill</property>
 		</packing>
 	      </child>
-
-	      <child>
-		<widget class="GtkCheckButton" id="fromCheckbutton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="label" translatable="yes">Start date:</property>
-		  <property name="use_underline">True</property>
-		  <property name="relief">GTK_RELIEF_NORMAL</property>
-		  <property name="focus_on_click">True</property>
-		  <property name="active">False</property>
-		  <property name="inconsistent">False</property>
-		  <property name="draw_indicator">True</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">1</property>
-		  <property name="bottom_attach">2</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="x_options">fill</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkCheckButton" id="toCheckbutton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="label" translatable="yes">End date:</property>
-		  <property name="use_underline">True</property>
-		  <property name="relief">GTK_RELIEF_NORMAL</property>
-		  <property name="focus_on_click">True</property>
-		  <property name="active">False</property>
-		  <property name="inconsistent">False</property>
-		  <property name="draw_indicator">True</property>
-		</widget>
-		<packing>
-		  <property name="left_attach">0</property>
-		  <property name="right_attach">1</property>
-		  <property name="top_attach">2</property>
-		  <property name="bottom_attach">3</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="x_options">fill</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkButton" id="fromButton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="label" translatable="yes">Date</property>
-		  <property name="use_underline">True</property>
-		  <property name="relief">GTK_RELIEF_NORMAL</property>
-		  <property name="focus_on_click">True</property>
-		  <signal name="clicked" handler="on_fromButton_clicked" last_modification_time="Thu, 11 Jan 2007 13:01:07 GMT"/>
-		</widget>
-		<packing>
-		  <property name="left_attach">1</property>
-		  <property name="right_attach">2</property>
-		  <property name="top_attach">1</property>
-		  <property name="bottom_attach">2</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="x_options">fill</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
-
-	      <child>
-		<widget class="GtkButton" id="toButton">
-		  <property agent="glademm" name="cxx_visibility">protected</property>
-		  <property name="visible">True</property>
-		  <property name="can_focus">True</property>
-		  <property name="label" translatable="yes">Date</property>
-		  <property name="use_underline">True</property>
-		  <property name="relief">GTK_RELIEF_NORMAL</property>
-		  <property name="focus_on_click">True</property>
-		  <signal name="clicked" handler="on_toButton_clicked" last_modification_time="Thu, 11 Jan 2007 13:00:57 GMT"/>
-		</widget>
-		<packing>
-		  <property name="left_attach">1</property>
-		  <property name="right_attach">2</property>
-		  <property name="top_attach">2</property>
-		  <property name="bottom_attach">3</property>
-		  <property name="x_padding">4</property>
-		  <property name="y_padding">4</property>
-		  <property name="x_options">fill</property>
-		  <property name="y_options">fill</property>
-		</packing>
-	      </child>
 	    </widget>
 	    <packing>
 	      <property name="padding">0</property>
@@ -4102,83 +4006,4 @@
   </child>
 </widget>
 
-<widget class="GtkDialog" id="dateDialog">
-  <property name="visible">True</property>
-  <property name="title" translatable="yes">Date</property>
-  <property name="type">GTK_WINDOW_TOPLEVEL</property>
-  <property name="window_position">GTK_WIN_POS_NONE</property>
-  <property name="modal">False</property>
-  <property name="resizable">True</property>
-  <property name="destroy_with_parent">False</property>
-  <property name="decorated">True</property>
-  <property name="skip_taskbar_hint">False</property>
-  <property name="skip_pager_hint">False</property>
-  <property name="type_hint">GDK_WINDOW_TYPE_HINT_DIALOG</property>
-  <property name="gravity">GDK_GRAVITY_NORTH_WEST</property>
-  <property name="focus_on_map">True</property>
-  <property name="urgency_hint">False</property>
-  <property name="has_separator">True</property>
-
-  <child internal-child="vbox">
-    <widget class="GtkVBox" id="dialog-vbox10">
-      <property name="visible">True</property>
-      <property name="homogeneous">False</property>
-      <property name="spacing">0</property>
-
-      <child internal-child="action_area">
-	<widget class="GtkHButtonBox" id="dialog-action_area10">
-	  <property name="visible">True</property>
-	  <property name="layout_style">GTK_BUTTONBOX_END</property>
-
-	  <child>
-	    <widget class="GtkButton" id="cancelbutton4">
-	      <property name="visible">True</property>
-	      <property name="can_default">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="label">gtk-cancel</property>
-	      <property name="use_stock">True</property>
-	      <property name="relief">GTK_RELIEF_NORMAL</property>
-	      <property name="focus_on_click">True</property>
-	      <property name="response_id">-6</property>
-	    </widget>
-	  </child>
-
-	  <child>
-	    <widget class="GtkButton" id="okbutton2">
-	      <property name="visible">True</property>
-	      <property name="can_default">True</property>
-	      <property name="can_focus">True</property>
-	      <property name="label">gtk-ok</property>
-	      <property name="use_stock">True</property>
-	      <property name="relief">GTK_RELIEF_NORMAL</property>
-	      <property name="focus_on_click">True</property>
-	      <property name="response_id">-5</property>
-	    </widget>
-	  </child>
-	</widget>
-	<packing>
-	  <property name="padding">0</property>
-	  <property name="expand">False</property>
-	  <property name="fill">True</property>
-	  <property name="pack_type">GTK_PACK_END</property>
-	</packing>
-      </child>
-
-      <child>
-	<widget class="GtkCalendar" id="dateCalendar">
-	  <property agent="glademm" name="cxx_visibility">protected</property>
-	  <property name="visible">True</property>
-	  <property name="can_focus">True</property>
-	  <property name="display_options">GTK_CALENDAR_SHOW_HEADING|GTK_CALENDAR_SHOW_DAY_NAMES|GTK_CALENDAR_SHOW_WEEK_NUMBERS</property>
-	</widget>
-	<packing>
-	  <property name="padding">0</property>
-	  <property name="expand">True</property>
-	  <property name="fill">True</property>
-	</packing>
-      </child>
-    </widget>
-  </child>
-</widget>
-
 </glade-interface>

Modified: trunk/UI/GTK2/src/Makefile.am
===================================================================
--- trunk/UI/GTK2/src/Makefile.am	2007-09-08 10:58:49 UTC (rev 967)
+++ trunk/UI/GTK2/src/Makefile.am	2007-09-08 11:04:46 UTC (rev 968)
@@ -1,8 +1,6 @@
 # Process this file with automake to produce Makefile.in
 
 noinst_HEADERS = \
-	dateDialog_glade.hh \
-	dateDialog.hh \
 	importDialog_glade.hh \
 	importDialog.hh \
 	indexDialog_glade.hh \
@@ -33,8 +31,6 @@
 
 pinot_SOURCES = \
 	pinot.cc \
-	dateDialog_glade.cc \
-	dateDialog.cc \
 	importDialog_glade.cc \
 	importDialog.cc \
 	indexDialog_glade.cc \

Deleted: trunk/UI/GTK2/src/dateDialog.cc
===================================================================
--- trunk/UI/GTK2/src/dateDialog.cc	2007-09-08 10:58:49 UTC (rev 967)
+++ trunk/UI/GTK2/src/dateDialog.cc	2007-09-08 11:04:46 UTC (rev 968)
@@ -1,61 +0,0 @@
-/*
- *  Copyright 2005,2006 Fabrice Colin
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-#include <iostream>
-#include <utility>
-#include <string>
-#include <glibmm/ustring.h>
-#include <sigc++/slot.h>
-
-#include "config.h"
-#include "NLS.h"
-#include "PinotSettings.h"
-#include "PinotUtils.h"
-#include "dateDialog.hh"
-
-using namespace std;
-using namespace Glib;
-using namespace Gtk;
-
-dateDialog::dateDialog(const ustring &title, const Date &date) :
-	dateDialog_glade()
-{
-	int month = (int )date.get_month();
-
-	set_title(title);
-
-	dateCalendar->select_month((guint )max(--month, 0), (guint )date.get_year());
-	dateCalendar->select_day((guint )date.get_day());
-}
-
-dateDialog::~dateDialog()
-{
-}
-
-void dateDialog::getChoice(Date &chosenDate) const
-{
-	Date dateNow;
-	guint year, month, day;
-
-	dateNow.set_time(time(NULL));
-	dateCalendar->get_date(year, month, day);
-#ifdef DEBUG
-	cout << "dateDialog::getChoice: selected " << year << " " << month << " " << day << endl;
-#endif
-	chosenDate.set_dmy((Date::Day )day, (Date::Month )++month, (Date::Year )year);
-}
-

Deleted: trunk/UI/GTK2/src/dateDialog.hh
===================================================================
--- trunk/UI/GTK2/src/dateDialog.hh	2007-09-08 10:58:49 UTC (rev 967)
+++ trunk/UI/GTK2/src/dateDialog.hh	2007-09-08 11:04:46 UTC (rev 968)
@@ -1,36 +0,0 @@
-/*
- *  Copyright 2005,2006 Fabrice Colin
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-#ifndef _DATEDIALOG_HH
-#define _DATEDIALOG_HH
-
-#include <glibmm/date.h>
-#include <glibmm/ustring.h>
-
-#include "dateDialog_glade.hh"
-
-class dateDialog : public dateDialog_glade
-{
-public:
-	dateDialog(const Glib::ustring &title, const Glib::Date &date);
-	virtual ~dateDialog();
-
-	void getChoice(Glib::Date &chosenDate) const;
-
-};
-#endif

Deleted: trunk/UI/GTK2/src/dateDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/dateDialog_glade.cc	2007-09-08 10:58:49 UTC (rev 967)
+++ trunk/UI/GTK2/src/dateDialog_glade.cc	2007-09-08 11:04:46 UTC (rev 968)
@@ -1,92 +0,0 @@
-// generated 2007/1/11 20:22:49 SGT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.12.1
-//
-// DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.4 and gtkmm 2.10.5
-//
-// Please modify the corresponding derived classes in ./src/dateDialog.cc
-
-
-#if defined __GNUC__ && __GNUC__ < 3
-#error This program will crash if compiled with g++ 2.x
-// see the dynamic_cast bug in the gtkmm FAQ
-#endif //
-#include "config.h"
-/*
- * Standard gettext macros.
- */
-#ifdef ENABLE_NLS
-#  include <libintl.h>
-#  undef _
-#  define _(String) dgettext (GETTEXT_PACKAGE, String)
-#  ifdef gettext_noop
-#    define N_(String) gettext_noop (String)
-#  else
-#    define N_(String) (String)
-#  endif
-#endif
-#include <gtkmmconfig.h>
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>2
-#include <sigc++/compatibility.h>
-#include <sigc++/bind.h>
-#define GMM_GTKMM_22_24(a,b) b
-#else //gtkmm 2.2
-#define GMM_GTKMM_22_24(a,b) a
-#endif //
-#include "dateDialog_glade.hh"
-#include <gdk/gdkkeysyms.h>
-#include <gtkmm/accelgroup.h>
-#include <gtkmm/button.h>
-#include <gtkmm/buttonbox.h>
-#include <gtkmm/box.h>
-#ifndef ENABLE_NLS
-#  define textdomain(String) (String)
-#  define gettext(String) (String)
-#  define dgettext(Domain,Message) (Message)
-#  define dcgettext(Domain,Message,Type) (Message)
-#  define bindtextdomain(Domain,Directory) (Domain)
-#  define _(String) (String)
-#  define N_(String) (String)
-#endif
-
-
-dateDialog_glade::dateDialog_glade(
-)
-{  
-   
-   Gtk::Dialog *dateDialog = this;
-   gmm_data = new GlademmData(get_accel_group());
-   
-   Gtk::Button *cancelbutton4 = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-cancel")));
-   Gtk::Button *okbutton2 = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-ok")));
-   dateCalendar = Gtk::manage(new class Gtk::Calendar());
-   cancelbutton4->set_flags(Gtk::CAN_FOCUS);
-   cancelbutton4->set_flags(Gtk::CAN_DEFAULT);
-   cancelbutton4->set_relief(Gtk::RELIEF_NORMAL);
-   okbutton2->set_flags(Gtk::CAN_FOCUS);
-   okbutton2->set_flags(Gtk::CAN_DEFAULT);
-   okbutton2->set_relief(Gtk::RELIEF_NORMAL);
-   dateDialog->get_action_area()->property_layout_style().set_value(Gtk::BUTTONBOX_END);
-   dateCalendar->set_flags(Gtk::CAN_FOCUS);
-   dateCalendar->display_options(Gtk::CALENDAR_SHOW_HEADING|Gtk::CALENDAR_SHOW_DAY_NAMES);
-   dateDialog->get_vbox()->set_homogeneous(false);
-   dateDialog->get_vbox()->set_spacing(0);
-   dateDialog->get_vbox()->pack_start(*dateCalendar);
-   dateDialog->set_title(_("Date"));
-   dateDialog->set_modal(false);
-   dateDialog->property_window_position().set_value(Gtk::WIN_POS_NONE);
-   dateDialog->set_resizable(true);
-   dateDialog->property_destroy_with_parent().set_value(false);
-   dateDialog->set_has_separator(true);
-   dateDialog->add_action_widget(*cancelbutton4, -6);
-   dateDialog->add_action_widget(*okbutton2, -5);
-   cancelbutton4->show();
-   okbutton2->show();
-   dateCalendar->show();
-   dateDialog->show();
-}
-
-dateDialog_glade::~dateDialog_glade()
-{  delete gmm_data;
-}

Deleted: trunk/UI/GTK2/src/dateDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/dateDialog_glade.hh	2007-09-08 10:58:49 UTC (rev 967)
+++ trunk/UI/GTK2/src/dateDialog_glade.hh	2007-09-08 11:04:46 UTC (rev 968)
@@ -1,48 +0,0 @@
-// generated 2007/1/11 20:22:49 SGT by fabrice at amra.dyndns.org.(none)
-// using glademm V2.12.1
-//
-// DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.4 and gtkmm 2.10.5
-//
-// Please modify the corresponding derived classes in ./src/dateDialog.hh and./src/dateDialog.cc
-
-#ifndef _DATEDIALOG_GLADE_HH
-#  define _DATEDIALOG_GLADE_HH
-
-
-#if !defined(GLADEMM_DATA)
-#define GLADEMM_DATA 
-#include <gtkmm/accelgroup.h>
-
-class GlademmData
-{  
-        
-        Glib::RefPtr<Gtk::AccelGroup> accgrp;
-public:
-        
-        GlademmData(Glib::RefPtr<Gtk::AccelGroup> ag) : accgrp(ag)
-        {  
-        }
-        
-        Glib::RefPtr<Gtk::AccelGroup>  getAccelGroup()
-        {  return accgrp;
-        }
-};
-#endif //GLADEMM_DATA
-
-#include <gtkmm/dialog.h>
-#include <gtkmm/calendar.h>
-
-class dateDialog_glade : public Gtk::Dialog
-{  
-        
-        GlademmData *gmm_data;
-protected:
-        class Gtk::Calendar * dateCalendar;
-        
-        dateDialog_glade();
-        
-        ~dateDialog_glade();
-};
-#endif

Modified: trunk/po/POTFILES.in
===================================================================
--- trunk/po/POTFILES.in	2007-09-08 10:58:49 UTC (rev 967)
+++ trunk/po/POTFILES.in	2007-09-08 11:04:46 UTC (rev 968)
@@ -1,8 +1,6 @@
 # List of source files containing translatable strings.
 UI/GTK2/src/DaemonState.cpp
 UI/GTK2/src/EnginesTree.cpp
-UI/GTK2/src/dateDialog.cc
-UI/GTK2/src/dateDialog_glade.cc
 UI/GTK2/src/indexDialog.cc
 UI/GTK2/src/indexDialog_glade.cc
 UI/GTK2/src/importDialog.cc



From fabricecolin at mail.berlios.de  Tue Sep 11 14:48:03 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 11 Sep 2007 14:48:03 +0200
Subject: [Pinot-svn] r969 - in trunk: Index Search UI/GTK2/src
Message-ID: <200709111248.l8BCm36S017712@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-11 14:48:02 +0200 (Tue, 11 Sep 2007)
New Revision: 969

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/Search/XapianEngine.cpp
   trunk/UI/GTK2/src/queryDialog.cc
Log:
Store documents' size, in bytes, in value 2. Ranges with suffix 'b' will be
applied on that value.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2007-09-08 11:04:46 UTC (rev 968)
+++ trunk/Index/XapianIndex.cpp	2007-09-11 12:48:02 UTC (rev 969)
@@ -611,7 +611,9 @@
 
 	// Add this value to allow sorting by date
 	doc.add_value(0, yyyymmdd);
-	// FIXME: add a value for size
+	// FIXME: checksum in value 1
+	// Size goes in value 2
+	doc.add_value(2, Xapian::sortable_serialise((double )info.getSize()));
 
 	DocumentInfo docCopy(info);
 	docCopy.setLanguage(language);

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2007-09-08 11:04:46 UTC (rev 968)
+++ trunk/Search/XapianEngine.cpp	2007-09-11 12:48:02 UTC (rev 969)
@@ -273,6 +273,20 @@
 	Xapian::DateValueRangeProcessor dateProcessor(0);
 	parser.add_valuerangeprocessor(&dateProcessor);
 
+	// Size with a "b" suffix, ie 1024..10240b
+#if XAPIAN_MAJOR_VERSION>1
+	Xapian::NumberValueRangeProcessor sizeProcessor(2, "b", false);
+	parser.add_valuerangeprocessor(&sizeProcessor);
+#elif XAPIAN_MAJOR_VERSION==1
+#if XAPIAN_MINOR_VERSION>0
+	Xapian::NumberValueRangeProcessor sizeProcessor(2, "b", false);
+#else
+	// Xapian 1.02 is the bare minimum
+	Xapian::v102::NumberValueRangeProcessor sizeProcessor(2, "b", false);
+#endif
+	parser.add_valuerangeprocessor(&sizeProcessor);
+#endif
+
 	// Parse the query string
 	Xapian::Query parsedQuery = parser.parse_query(freeQuery, flags);
 	if (minimal == true)

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2007-09-08 11:04:46 UTC (rev 968)
+++ trunk/UI/GTK2/src/queryDialog.cc	2007-09-11 12:48:02 UTC (rev 969)
@@ -123,6 +123,7 @@
 	filterCombobox->append_text(_("MIME type"));
 	filterCombobox->append_text(_("Label"));
 	filterCombobox->append_text(_("Date range"));
+	filterCombobox->append_text(_("Size"));
 	filterCombobox->set_active(0);
 }
 
@@ -192,7 +193,7 @@
 	ustring filter;
 	time_t timeT = time(NULL);
 	struct tm *tm = localtime(&timeT);
-	bool isDateRange = false;
+	bool hasValue = true;
 
 	// What's the corresponding filter ?
 	int chosenFilter = filterCombobox->get_active_row_number();
@@ -232,8 +233,12 @@
 		case 10:
 			filter = TimeConverter::toYYYYMMDDString(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday);
 			filter += "..20991231";
-			isDateRange = true;
+			hasValue = false;
 			break;
+		case 11:
+			filter += "0..10240b";
+			hasValue = false;
+			break;
 		default:
 			break;
 	}
@@ -244,7 +249,7 @@
 		ustring queryText = refBuffer->get_text();
 		queryText += " ";
 		queryText += filter;
-		if (isDateRange == false)
+		if (hasValue == true)
 		{
 			queryText += ":xxx";
 		}



From fabricecolin at mail.berlios.de  Tue Sep 11 14:53:12 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 11 Sep 2007 14:53:12 +0200
Subject: [Pinot-svn] r970 - trunk/UI/GTK2/src
Message-ID: <200709111253.l8BCrCSn018349@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-11 14:53:12 +0200 (Tue, 11 Sep 2007)
New Revision: 970

Modified:
   trunk/UI/GTK2/src/PinotSettings.cpp
Log:
Method getHomeDirectory() returns ~ as a last resort if unable to determine the
user's home.


Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2007-09-11 12:48:02 UTC (rev 969)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2007-09-11 12:53:12 UTC (rev 970)
@@ -168,7 +168,7 @@
 		}
 	}
 
-	return "";
+	return "~";
 }
 
 string PinotSettings::getConfigurationDirectory(void)



From fabricecolin at mail.berlios.de  Tue Sep 11 15:28:43 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 11 Sep 2007 15:28:43 +0200
Subject: [Pinot-svn] r971 - in trunk: Index Search UI/GTK2/src Utils
Message-ID: <200709111328.l8BDSh1V020690@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-11 15:28:42 +0200 (Tue, 11 Sep 2007)
New Revision: 971

Modified:
   trunk/Index/pinot-index.cpp
   trunk/Search/pinot-search.cpp
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
   trunk/UI/GTK2/src/pinot.cc
   trunk/Utils/MIMEScanner.cpp
   trunk/Utils/MIMEScanner.h
Log:
Applied patch by Lee Marks. The contents of defaults.list has priority over that
of mimeinfo.cache. User-specific settings found in ~/.local -which may point to
desktop files in the same directory- are loaded before system-wide settings.
Desktop files are cached for the duration of load() to avoid having to read the
same file several times.
While pinot and pinot-dbus-daemon fully initialize MIMEScanner, pinot-index and
pinot-search don't, as they only need to query files' types, not launch viewers.
Also added a getParentTypes() method that will be useful for filtering.


Modified: trunk/Index/pinot-index.cpp
===================================================================
--- trunk/Index/pinot-index.cpp	2007-09-11 12:53:12 UTC (rev 970)
+++ trunk/Index/pinot-index.cpp	2007-09-11 13:28:42 UTC (rev 971)
@@ -157,9 +157,7 @@
 		return EXIT_FAILURE;
 	}
 
-	string desktopFilesDirectory(SHARED_MIME_INFO_PREFIX);
-	desktopFilesDirectory += "/share/applications/";
-	MIMEScanner::initialize(desktopFilesDirectory, desktopFilesDirectory + "mimeinfo.cache");
+	MIMEScanner::initialize("", "");
 	DownloaderInterface::initialize();
 	Dijon::HtmlFilter::initialize();
 	Dijon::FilterFactory::loadFilters(string(LIBDIR) + string("/pinot/filters"));

Modified: trunk/Search/pinot-search.cpp
===================================================================
--- trunk/Search/pinot-search.cpp	2007-09-11 12:53:12 UTC (rev 970)
+++ trunk/Search/pinot-search.cpp	2007-09-11 13:28:42 UTC (rev 971)
@@ -198,9 +198,7 @@
 		return EXIT_FAILURE;
 	}
 
-	string desktopFilesDirectory(SHARED_MIME_INFO_PREFIX);
-	desktopFilesDirectory += "/share/applications/";
-	MIMEScanner::initialize(desktopFilesDirectory, desktopFilesDirectory + "mimeinfo.cache");
+	MIMEScanner::initialize("", "");
 	DownloaderInterface::initialize();
 
 	engineType = argv[optind];

Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2007-09-11 12:53:12 UTC (rev 970)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2007-09-11 13:28:42 UTC (rev 971)
@@ -314,16 +314,9 @@
 	}
 
 	// Initialize utility classes
-	string desktopFilesDirectory(SHARED_MIME_INFO_PREFIX);
-	desktopFilesDirectory += "/share/applications/";
-	string homeDirectory(PinotSettings::getHomeDirectory());
-	if (homeDirectory.empty() == true)
+	if (MIMEScanner::initialize(PinotSettings::getHomeDirectory() + "/.local/share/applications/",
+		string(SHARED_MIME_INFO_PREFIX) + "/share/applications/") == false)
 	{
-		homeDirectory = "~/";
-	}
-	MIMEScanner::initialize(desktopFilesDirectory, homeDirectory + "/.local/share/applications/mimeinfo.cache", 10);
-	if (MIMEScanner::initialize(desktopFilesDirectory, desktopFilesDirectory + "mimeinfo.cache") == false)
-	{
 		cerr << "Couldn't load MIME settings" << endl;
 	}
 	DownloaderInterface::initialize();

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2007-09-11 12:53:12 UTC (rev 970)
+++ trunk/UI/GTK2/src/pinot.cc	2007-09-11 13:28:42 UTC (rev 971)
@@ -238,16 +238,9 @@
 	}
 
 	// Initialize utility classes
-	string desktopFilesDirectory(SHARED_MIME_INFO_PREFIX);
-	desktopFilesDirectory += "/share/applications/";
-	string homeDirectory(PinotSettings::getHomeDirectory());
-	if (homeDirectory.empty() == true)
+	if (MIMEScanner::initialize(PinotSettings::getHomeDirectory() + "/.local/share/applications/",
+		string(SHARED_MIME_INFO_PREFIX) + "/share/applications/") == false)
 	{
-		homeDirectory = "~/";
-	}
-	MIMEScanner::initialize(desktopFilesDirectory, homeDirectory + "/.local/share/applications/mimeinfo.cache", 10);
-	if (MIMEScanner::initialize(desktopFilesDirectory, desktopFilesDirectory + "mimeinfo.cache") == false)
-	{
 		cerr << "Couldn't load MIME settings" << endl;
 	}
 

Modified: trunk/Utils/MIMEScanner.cpp
===================================================================
--- trunk/Utils/MIMEScanner.cpp	2007-09-11 12:53:12 UTC (rev 970)
+++ trunk/Utils/MIMEScanner.cpp	2007-09-11 13:28:42 UTC (rev 971)
@@ -17,6 +17,7 @@
  */
 
 #include <strings.h>
+#include <unistd.h>
 #include <glib.h>
 #include <iostream>
 
@@ -26,13 +27,18 @@
 #include "StringManip.h"
 #include "Url.h"
 
-// FIXME: "Default Applications" here ?
-#define MIME_DEFAULTS_SECTION "MIME Cache"
+#define MIME_DEFAULTS_LIST	"defaults.list"
+#define MIME_DEFAULTS_SECTION	"Default Applications"
+#define MIME_CACHE		"mimeinfo.cache"
+#define MIME_CACHE_SECTION	"MIME Cache"
 
 using std::cout;
 using std::endl;
 using std::string;
+using std::list;
+using std::map;
 using std::multimap;
+using std::set;
 using std::vector;
 using std::pair;
 
@@ -69,8 +75,7 @@
 
 MIMEAction::MIMEAction() :
 	m_multipleArgs(false),
-	m_localOnly(true),
-	m_priority(0)
+	m_localOnly(true)
 {
 }
 
@@ -78,8 +83,7 @@
 	m_multipleArgs(false),
 	m_localOnly(true),
 	m_name(name),
-	m_exec(cmdLine),
-	m_priority(0)
+	m_exec(cmdLine)
 {
 	parseExec();
 }
@@ -87,34 +91,9 @@
 MIMEAction::MIMEAction(const string &desktopFile) :
 	m_multipleArgs(false),
 	m_localOnly(true),
-	m_location(desktopFile),
-	m_priority(0)
+	m_location(desktopFile)
 {
-	GKeyFile *pDesktopFile = g_key_file_new();
-	GError *pError = NULL;
-
-	if (pDesktopFile != NULL)
-	{
-		g_key_file_load_from_file(pDesktopFile, (const gchar *)desktopFile.c_str(),
-			G_KEY_FILE_NONE, &pError);
-		if (pError == NULL)
-		{
-			m_name = getKeyValue(pDesktopFile, "Name");
-			// This may contain parameters described here :
-			// http://standards.freedesktop.org/desktop-entry-spec/latest/ar01s06.html
-			m_exec = getKeyValue(pDesktopFile, "Exec");
-			m_icon = getKeyValue(pDesktopFile, "Icon");
-			m_device = getKeyValue(pDesktopFile, "Device");
-
-			parseExec();
-		}
-		else
-		{
-			g_error_free(pError);
-		}
-
-		g_key_file_free(pDesktopFile);
-	}
+	load();
 }
 
 MIMEAction::MIMEAction(const MIMEAction &other) :
@@ -124,8 +103,7 @@
 	m_location(other.m_location),
 	m_exec(other.m_exec),
 	m_icon(other.m_icon),
-	m_device(other.m_device),
-	m_priority(other.m_priority)
+	m_device(other.m_device)
 {
 }
 
@@ -135,17 +113,10 @@
 
 bool MIMEAction::operator<(const MIMEAction &other) const
 {
-	if (m_priority < other.m_priority)
+	if (m_name < other.m_name)
 	{
 		return true;
 	}
-	else if (m_priority == other.m_priority)
-	{
-		if (m_name < other.m_name)
-		{
-			return true;
-		}
-	}
 
 	return false;
 }
@@ -166,6 +137,34 @@
 	return *this;
 }
 
+void MIMEAction::load(void)
+{
+	GKeyFile *pDesktopFile = g_key_file_new();
+	GError *pError = NULL;
+
+	if (pDesktopFile != NULL)
+	{
+		g_key_file_load_from_file(pDesktopFile, (const gchar *)m_location.c_str(),
+			G_KEY_FILE_NONE, &pError);
+		if (pError == NULL)
+		{
+			m_name = getKeyValue(pDesktopFile, "Name");
+			// This may contain parameters described here :
+			// http://standards.freedesktop.org/desktop-entry-spec/latest/ar01s06.html
+			m_exec = getKeyValue(pDesktopFile, "Exec");
+			m_icon = getKeyValue(pDesktopFile, "Icon");
+			m_device = getKeyValue(pDesktopFile, "Device");
+			parseExec();
+		}
+		else
+		{
+			g_error_free(pError);
+		}
+
+		g_key_file_free(pDesktopFile);
+	}
+}
+
 void MIMEAction::parseExec(void)
 {
 	// Does it support multiple arguments ?
@@ -186,43 +185,119 @@
 	}
 }
 
-multimap<string, MIMEAction> MIMEScanner::m_defaultActions;
+MIMECache::MIMECache()
+{
+}
 
-pthread_mutex_t MIMEScanner::m_mutex = PTHREAD_MUTEX_INITIALIZER;
+MIMECache::MIMECache(const string &file, const string &section) :
+	m_file(file),
+	m_section(section)
+{
+}
 
-MIMEScanner::MIMEScanner()
+MIMECache::MIMECache(const MIMECache &other) :
+	m_file(other.m_file),
+	m_section(other.m_section),
+	m_defaultActions(other.m_defaultActions)
 {
 }
 
-MIMEScanner::~MIMEScanner()
+MIMECache::~MIMECache()
 {
 }
 
-bool MIMEScanner::initialize(const string &desktopFilesDirectory, const string &mimeInfoCache,
-	unsigned int priority)
+bool MIMECache::operator<(const MIMECache &other) const
 {
-	GError *pError = NULL;
-	bool foundActions = false;
+	if (m_file < other.m_file)
+	{
+		return true;
+	}
 
-	if ((desktopFilesDirectory.empty() == true) ||
-		(mimeInfoCache.empty() == true))
+	return false;
+}
+
+MIMECache& MIMECache::operator=(const MIMECache &other)
+{
+	if (this != &other)
 	{
-		return false;
+		m_file = other.m_file;
+		m_section = other.m_section;
+		m_defaultActions = other.m_defaultActions;
 	}
 
+	return *this;
+}
+
+bool MIMECache::findDesktopFile(const string &desktopFile, const string &mimeType,
+	map<string, MIMEAction> &loadedActions)
+{
+	// Has already been loaded ?
+	map<string, MIMEAction>::const_iterator actionIter = loadedActions.find(desktopFile);
+	if (actionIter != loadedActions.end())
+	{
+		// Yes, it was so just copy it
+		m_defaultActions.insert(pair<string, MIMEAction>(mimeType, actionIter->second));
+#ifdef DEBUG
+		cout << "MIMECache::findDesktopFile: copied " << desktopFile << endl;
+#endif
+
+		return true;
+	}
+	// Does it exist in that path ?
+	else if (access(desktopFile.c_str(), F_OK) == 0)
+	{
+		// It's here, we need to read it off the disk
+		MIMEAction typeAction(desktopFile);
+#ifdef DEBUG
+		cout << "MIMECache::findDesktopFile: read " << desktopFile << endl;
+#endif
+
+		if (typeAction.m_exec.empty() == false)
+		{
+			m_defaultActions.insert(pair<string, MIMEAction>(mimeType, typeAction));
+			loadedActions.insert(pair<string, MIMEAction>(desktopFile, typeAction));
+
+			return true;
+		}
+	}
+
+	return false;
+}
+
+void MIMECache::reload(const list<string> &desktopFilesPaths)
+{
+	if (m_file.empty() == true)
+	{
+		// We can't reload anything !
+		return;
+	}
+
+	m_defaultActions.clear();
+	load(desktopFilesPaths);
+}
+
+bool MIMECache::load(const list<string> &desktopFilesPaths)
+{
+	map<string, MIMEAction> loadedActions;
+	GError *pError = NULL;
+	bool foundActions = false;
+
 	GKeyFile *pDefaults = g_key_file_new();
 	if (pDefaults == NULL)
 	{
 		return false;
 	}
 
-	g_key_file_load_from_file(pDefaults, (const gchar *)mimeInfoCache.c_str(),
+	g_key_file_load_from_file(pDefaults, (const gchar *)m_file.c_str(),
 		G_KEY_FILE_NONE, &pError);
 	if (pError == NULL)
 	{
-		gchar **pMimeTypes = g_key_file_get_keys(pDefaults, MIME_DEFAULTS_SECTION,
+#ifdef DEBUG
+		cout << "MIMECache::load: loaded " << m_file << endl;
+#endif
+
+		gchar **pMimeTypes = g_key_file_get_keys(pDefaults, m_section.c_str(),
 			NULL, &pError);
-
 		if (pMimeTypes != NULL)
 		{
 			if (pError == NULL)
@@ -230,7 +305,7 @@
 				for (unsigned int i = 0; pMimeTypes[i] != NULL; ++i)
 				{
 					gchar **pDesktopFiles = g_key_file_get_string_list(pDefaults,
-						MIME_DEFAULTS_SECTION, pMimeTypes[i], NULL, &pError);
+						m_section.c_str(), pMimeTypes[i], NULL, &pError);
 
 					if (pDesktopFiles == NULL)
 					{
@@ -242,16 +317,19 @@
 						continue;
 					}
 
+					// Register all applications for that type
 					for (unsigned int j = 0; pDesktopFiles[j] != NULL; ++j)
 					{
-						MIMEAction typeAction(desktopFilesDirectory + string(pDesktopFiles[j]));
-
-						// Register all applications for that type
-						if (typeAction.m_exec.empty() == false)
+						// Search the paths for this desktop file
+						for (list<string>::const_iterator iter = desktopFilesPaths.begin();
+							iter != desktopFilesPaths.end(); ++iter)
 						{
-							typeAction.m_priority = priority;
-							m_defaultActions.insert(pair<string, MIMEAction>(pMimeTypes[i], typeAction));
-							foundActions = true;
+							if (findDesktopFile(*iter + pDesktopFiles[j], pMimeTypes[i],
+								loadedActions) == true)
+							{
+								foundActions = true;
+								break;
+							}
 						}
 					}
 
@@ -268,6 +346,9 @@
 	}
 	else
 	{
+#ifdef DEBUG
+		cout << "MIMECache::load: failed to load " << m_file << endl;
+#endif
 		g_error_free(pError);
 	}
 	g_key_file_free(pDefaults);
@@ -275,6 +356,70 @@
 	return foundActions;
 }
 
+pthread_mutex_t MIMEScanner::m_mutex = PTHREAD_MUTEX_INITIALIZER;
+list<MIMECache> MIMEScanner::m_caches;
+
+MIMEScanner::MIMEScanner()
+{
+}
+
+MIMEScanner::~MIMEScanner()
+{
+}
+
+bool MIMEScanner::initialize(const string &userDirectory, const string &systemDirectory)
+{
+	list<string> desktopFilesPaths;
+	bool foundActions = false;
+
+	if (systemDirectory.empty() == false)
+	{
+		// User-specific actions may point to desktop files in this path, so add it in
+		desktopFilesPaths.push_front(systemDirectory);
+	}
+
+	// Load user-specific settings first
+	if (userDirectory.empty() == false)
+	{
+		// Add the user's directory to the paths list
+		desktopFilesPaths.push_front(userDirectory);
+
+#ifdef DEBUG
+		cout << "MIMEScanner::initialize: user-specific directory " << userDirectory << endl;
+#endif
+		foundActions |= addCache(userDirectory + MIME_DEFAULTS_LIST,
+			MIME_DEFAULTS_SECTION, desktopFilesPaths);
+		foundActions |= addCache(userDirectory + MIME_CACHE,
+			MIME_CACHE_SECTION, desktopFilesPaths);
+	}
+
+	// Then load system-wide settings
+	if (systemDirectory.empty() == false)
+	{
+		// Make sure only the system directory is in the list
+		desktopFilesPaths.clear();
+		desktopFilesPaths.push_front(systemDirectory);
+
+#ifdef DEBUG
+		cout << "MIMEScanner::initialize: system-wide directory " << systemDirectory << endl;
+#endif
+		foundActions |= addCache(systemDirectory + MIME_DEFAULTS_LIST,
+			MIME_DEFAULTS_SECTION, desktopFilesPaths);
+		foundActions |= addCache(systemDirectory + MIME_CACHE,
+			MIME_CACHE_SECTION, desktopFilesPaths);
+	}
+
+	return foundActions;
+}
+
+bool MIMEScanner::addCache(const string &file, const string &section,
+	const list<string> &desktopFilesPaths)
+{
+	m_caches.push_back(MIMECache(file, section));
+
+	return m_caches.back().load(desktopFilesPaths);
+}
+
 void MIMEScanner::shutdown(void)
 {
 	xdg_mime_shutdown();
@@ -380,21 +525,82 @@
 	return mimeType;
 }
 
+/// Gets parent MIME types.
+bool MIMEScanner::getParentTypes(const string &mimeType, set<string> &parentMimeTypes)
+{
+	if (mimeType.empty() == true)
+	{
+		return false;
+	}
+
+	char **pParentTypes = xdg_mime_list_mime_parents(mimeType.c_str());
+	if ((pParentTypes != NULL) &&
+		(pParentTypes[0] != NULL))
+	{
+		for (unsigned int i = 0; pParentTypes[i] != NULL; ++i)
+		{
+			parentMimeTypes.insert(pParentTypes[i]);
+		}
+
+		free(pParentTypes);
+
+		return true;
+	}
+
+	return false;
+}
+
 /// Adds a user-defined action for the given type.
-void MIMEScanner::addDefaultAction(const std::string &mimeType, const MIMEAction &typeAction)
+void MIMEScanner::addDefaultAction(const string &mimeType, const MIMEAction &typeAction)
 {
-	m_defaultActions.insert(pair<string, MIMEAction>(mimeType, typeAction));
+	// Custom actions get stored in a cache object which is not connected to a file
+	// We need to create this object the first time a custom action gets added
+	if ((m_caches.empty() == true) ||
+		(m_caches.front().m_file.empty() == false))
+	{
+		m_caches.push_front(MIMECache());
+	}
+
+	m_caches.front().m_defaultActions.insert(pair<string, MIMEAction>(mimeType, typeAction));
 }
 
+bool MIMEScanner::getDefaultActionsForType(const string &mimeType, vector<MIMEAction> &typeActions)
+{
+	bool foundAction = false;
+
+	// Each cache may have more than one action for this type
+	for (list<MIMECache>::iterator cacheIter = m_caches.begin(); cacheIter != m_caches.end(); ++cacheIter)
+	{
+		MIMECache &cache = *cacheIter;
+		multimap<string, MIMEAction> &defaultActions = cache.m_defaultActions;
+		multimap<string, MIMEAction>::const_iterator actionIter = defaultActions.lower_bound(mimeType);
+		multimap<string, MIMEAction>::const_iterator endActionIter = defaultActions.upper_bound(mimeType);
+
+		// Found anything ?
+		for (; actionIter != endActionIter; ++actionIter)
+		{
+#ifdef DEBUG
+			cout << "MIMEScanner::getDefaultActions: action " << actionIter->second.m_name
+				<< " at " << actionIter->second.m_location << endl;
+#endif
+			typeActions.push_back(actionIter->second);
+			foundAction = true;
+		}
+	}
+  
+	return foundAction;
+}
+
 /// Determines the default action(s) for the given type.
 bool MIMEScanner::getDefaultActions(const string &mimeType, vector<MIMEAction> &typeActions)
 {
-	multimap<string, MIMEAction>::const_iterator actionIter = m_defaultActions.lower_bound(mimeType);
-	multimap<string, MIMEAction>::const_iterator endActionIter = m_defaultActions.upper_bound(mimeType);
-	bool foundAction = false;
-
 	typeActions.clear();
-	if (actionIter == m_defaultActions.end())
+  
+#ifdef DEBUG
+	cout << "MIMEScanner::getDefaultActions: searching for " << mimeType << endl;
+#endif
+	bool foundAction = getDefaultActionsForType(mimeType, typeActions);
+	if (foundAction == false)
 	{
 		// Is there an action for any of this type's parents ?
 		char **pParentTypes = xdg_mime_list_mime_parents(mimeType.c_str());
@@ -403,14 +609,12 @@
 		{
 			for (unsigned int i = 0; pParentTypes[i] != NULL; ++i)
 			{
-				actionIter = m_defaultActions.lower_bound(pParentTypes[i]);
-				endActionIter = m_defaultActions.upper_bound(pParentTypes[i]);
-				if (actionIter != m_defaultActions.end())
-				{
 #ifdef DEBUG
-					cout << "MIMEScanner::getDefaultActions: " << mimeType << " has parent type " << pParentTypes[i] << endl;
+				cout << "MIMEScanner::getDefaultActions: searching for parent type " << pParentTypes[i] << endl;
 #endif
-					typeActions.reserve(m_defaultActions.count(pParentTypes[i]));
+				foundAction = getDefaultActionsForType(string(pParentTypes[i]), typeActions);
+				if (foundAction)
+				{
 					break;
 				}
 			}
@@ -421,21 +625,7 @@
 		else cout << "MIMEScanner::getDefaultActions: " << mimeType << " has no parent types" << endl;
 #endif
 	}
-	else
-	{
-		typeActions.reserve(m_defaultActions.count(mimeType));
-	}
 
-	// Found anything ?
-	for (; actionIter != endActionIter; ++actionIter)
-	{
-#ifdef DEBUG
-		cout << "MIMEScanner::getDefaultActions: action " << actionIter->second.m_name
-			<< ", " << actionIter->second.m_priority << endl;
-#endif
-		typeActions.push_back(actionIter->second);
-		foundAction = true;
-	}
-
 	return foundAction;
 }
+

Modified: trunk/Utils/MIMEScanner.h
===================================================================
--- trunk/Utils/MIMEScanner.h	2007-09-11 12:53:12 UTC (rev 970)
+++ trunk/Utils/MIMEScanner.h	2007-09-11 13:28:42 UTC (rev 971)
@@ -21,7 +21,9 @@
 
 #include <pthread.h>
 #include <string>
+#include <list>
 #include <map>
+#include <set>
 #include <vector>
 
 #include "Url.h"
@@ -43,6 +45,7 @@
 
 		MIMEAction &operator=(const MIMEAction &other);
 
+		void load(void);
 		void parseExec(void);
 
 		bool m_multipleArgs;
@@ -52,10 +55,37 @@
 		std::string m_exec;
 		std::string m_icon;
 		std::string m_device;
-		unsigned int m_priority;
 
 };
 
+/** Caching of MIME type information.
+  * A cache can be reloaded as required.
+  */
+class MIMECache
+{
+	public:
+		MIMECache();
+		MIMECache(const std::string &file, const std::string &section);
+		MIMECache(const MIMECache& other);
+		~MIMECache();
+
+		bool operator<(const MIMECache &other) const;
+
+		MIMECache &operator=(const MIMECache &other);
+
+		bool load(const std::list<std::string> &desktopFilesPaths);
+		void reload(const std::list<std::string> &desktopFilesPaths);
+  
+		std::string m_file;
+		std::string m_section;
+		std::multimap<std::string, MIMEAction> m_defaultActions;
+
+	protected:
+		bool findDesktopFile(const std::string &desktopFile, const std::string &mimeType,
+			std::map<std::string, MIMEAction> &loadedActions);
+
+};
+
 /**
   * Utility class to get a file's MIME type and the default application associated with it.
   */
@@ -65,9 +95,8 @@
 		~MIMEScanner();
 
 		/// Initializes the MIME system.
-		static bool initialize(const std::string &desktopFilesDirectory,
-			const std::string &mimeInfoCache, unsigned int priority = 0);
-
+		static bool initialize(const std::string &userDirectory, const std::string &systemDirectory);
+  
 		/// Shutdowns the MIME system.
 		static void shutdown(void);
 
@@ -77,6 +106,9 @@
 		/// Finds out the given URL's MIME type.
 		static std::string scanUrl(const Url &urlObj);
 
+		/// Gets parent MIME types.
+		static bool getParentTypes(const std::string &mimeType, std::set<std::string> &parentMimeTypes);
+
 		/// Adds a user-defined action for the given type.
 		static void addDefaultAction(const std::string &mimeType, const MIMEAction &typeAction);
 
@@ -84,12 +116,19 @@
 		static bool getDefaultActions(const std::string &mimeType, std::vector<MIMEAction> &typeActions);
 
 	protected:
+		/// Mutex to protect access to xdgmime.
 		static pthread_mutex_t m_mutex;
-		static std::multimap<std::string, MIMEAction> m_defaultActions;
+		/// MIME type caches, ordered by decreasing priority.
+		static std::list<MIMECache> m_caches;
 
 		MIMEScanner();
 
 		static std::string scanFileType(const std::string &fileName);
+  
+		static bool addCache(const std::string &file, const std::string &section,
+			const std::list<std::string> &desktopFilesPaths);
+  
+		static bool getDefaultActionsForType(const std::string &mimeType, std::vector<MIMEAction> &typeActions);
 
 	private:
 		MIMEScanner(const MIMEScanner &other);



From fabricecolin at mail.berlios.de  Tue Sep 11 15:42:27 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 11 Sep 2007 15:42:27 +0200
Subject: [Pinot-svn] r972 - in trunk: Index Tokenize UI/GTK2/src
Message-ID: <200709111342.l8BDgRpF021519@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-11 15:42:26 +0200 (Tue, 11 Sep 2007)
New Revision: 972

Modified:
   trunk/Index/FilterWrapper.cpp
   trunk/Tokenize/FilterUtils.cpp
   trunk/Tokenize/FilterUtils.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
Log:
If a type has no filter defined, FilterUtils::getFilter() tries its parent
types, obtained from MIMEScanner.


Modified: trunk/Index/FilterWrapper.cpp
===================================================================
--- trunk/Index/FilterWrapper.cpp	2007-09-11 13:28:42 UTC (rev 971)
+++ trunk/Index/FilterWrapper.cpp	2007-09-11 13:42:26 UTC (rev 972)
@@ -84,7 +84,7 @@
 bool FilterWrapper::filterDocument(const Document &doc, const string &originalType,
 	const set<string> &labels, unsigned int &docId, bool doUpdate)
 {
-	Filter *pFilter = FilterFactory::getFilter(doc.getType());
+	Filter *pFilter = FilterUtils::getFilter(doc.getType());
 	bool fedFilter = false, docSuccess = false, finalSuccess = false;
 
 	if (pFilter != NULL)

Modified: trunk/Tokenize/FilterUtils.cpp
===================================================================
--- trunk/Tokenize/FilterUtils.cpp	2007-09-11 13:28:42 UTC (rev 971)
+++ trunk/Tokenize/FilterUtils.cpp	2007-09-11 13:42:26 UTC (rev 972)
@@ -19,8 +19,9 @@
 #include <stdlib.h>
 #include <unistd.h> 
 #include <iostream>
-#include <map>
+#include <set>
 
+#include "MIMEScanner.h"
 #include "StringManip.h"
 #include "Url.h"
 #include "FilterFactory.h"
@@ -32,8 +33,9 @@
 using std::string;
 using std::set;
 using std::map;
-using namespace Dijon;
 
+map<string, string> FilterUtils::m_typeAliases;
+
 FilterUtils::FilterUtils()
 {
 }
@@ -42,6 +44,49 @@
 {
 }
 
+Dijon::Filter *FilterUtils::getFilter(const string &mimeType)
+{
+	Dijon::Filter *pFilter = NULL;
+
+	// Is this type aliased ?
+	map<string, string>::const_iterator aliasIter = m_typeAliases.find(mimeType);
+	if (aliasIter != m_typeAliases.end())
+	{
+		pFilter = Dijon::FilterFactory::getFilter(aliasIter->second);
+	}
+	else
+	{
+		// Is there a filter for this type ?
+		pFilter = Dijon::FilterFactory::getFilter(mimeType);
+	}
+
+	if (pFilter != NULL)
+	{
+		return pFilter;
+	}
+
+	if (mimeType.empty() == false)
+	{
+		set<string> parentTypes;
+
+		// Try that type's parents
+		MIMEScanner::getParentTypes(mimeType, parentTypes);
+		for (set<string>::const_iterator parentIter = parentTypes.begin();
+			parentIter != parentTypes.end(); ++parentIter)
+		{
+			pFilter = Dijon::FilterFactory::getFilter(*parentIter);
+			if (pFilter != NULL)
+			{
+				// Add an alias
+				m_typeAliases[mimeType] = *parentIter;
+				return pFilter;
+			}
+		}
+	}
+
+	return NULL;
+}
+
 bool FilterUtils::feedFilter(const Document &doc, Dijon::Filter *pFilter)
 {
 	string location(doc.getLocation());
@@ -64,7 +109,7 @@
 
 	// Prefer feeding the data
 	if (((dataLength > 0) && (pData != NULL)) &&
-		(pFilter->is_data_input_ok(Filter::DOCUMENT_DATA) == true))
+		(pFilter->is_data_input_ok(Dijon::Filter::DOCUMENT_DATA) == true))
 	{
 #ifdef DEBUG
 		cout << "FilterUtils::feedFilter: feeding " << dataLength << " bytes of data from " << location << endl;
@@ -75,7 +120,7 @@
 	if ((fedInput == false) &&
 		(fileName.empty() == false))
 	{ 
-		if (pFilter->is_data_input_ok(Filter::DOCUMENT_FILE_NAME) == true)
+		if (pFilter->is_data_input_ok(Dijon::Filter::DOCUMENT_FILE_NAME) == true)
 		{
 #ifdef DEBUG
 			cout << "FilterUtils::feedFilter: feeding file " << fileName << endl;
@@ -84,7 +129,7 @@
 		}
 		// ...and to feeding the file's contents
 		if ((fedInput == false) &&
-			(pFilter->is_data_input_ok(Filter::DOCUMENT_DATA) == true))
+			(pFilter->is_data_input_ok(Dijon::Filter::DOCUMENT_DATA) == true))
 		{
 			Document docCopy(doc);
 
@@ -114,7 +159,7 @@
 	// ... to feeding data through a temporary file
 	if ((fedInput == false) &&
 		((dataLength > 0) && (pData != NULL)) &&
-		(pFilter->is_data_input_ok(Filter::DOCUMENT_FILE_NAME) == true))
+		(pFilter->is_data_input_ok(Dijon::Filter::DOCUMENT_FILE_NAME) == true))
 	{
 		char inTemplate[18] = "/tmp/filterXXXXXX";
 

Modified: trunk/Tokenize/FilterUtils.h
===================================================================
--- trunk/Tokenize/FilterUtils.h	2007-09-11 13:28:42 UTC (rev 971)
+++ trunk/Tokenize/FilterUtils.h	2007-09-11 13:42:26 UTC (rev 972)
@@ -20,7 +20,7 @@
 #define _FILTER_UTILS_H
 
 #include <string>
-#include <set>
+#include <map>
 
 #include "Document.h"
 #include "Filter.h"
@@ -31,6 +31,9 @@
 	public:
 		virtual ~FilterUtils();
 
+		/// Returns a Filter that handles the given MIME type, or one of its parents.
+		static Dijon::Filter *getFilter(const std::string &mimeType);
+
 		/// Feeds a document's data to a filter.
 		static bool feedFilter(const Document &doc, Dijon::Filter *pFilter);
 
@@ -41,6 +44,8 @@
 		static std::string stripMarkup(const std::string &text);
 
 	protected:
+		static std::map<std::string, std::string> m_typeAliases;
+
 		FilterUtils();
 
 	private:

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-11 13:28:42 UTC (rev 971)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-11 13:42:26 UTC (rev 972)
@@ -1368,7 +1368,7 @@
 	}
 	else
 	{
-		Dijon::Filter *pFilter = Dijon::FilterFactory::getFilter(m_docInfo.getType());
+		Dijon::Filter *pFilter = FilterUtils::getFilter(m_docInfo.getType());
 
 		if (pFilter != NULL)
 		{



From fabricecolin at mail.berlios.de  Tue Sep 11 15:52:46 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 11 Sep 2007 15:52:46 +0200
Subject: [Pinot-svn] r973 - trunk/UI/GTK2/src
Message-ID: <200709111352.l8BDqkck022073@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-11 15:52:46 +0200 (Tue, 11 Sep 2007)
New Revision: 973

Modified:
   trunk/UI/GTK2/src/ServerThreads.h
Log:
Always check DBUS_VERSION before defining DBUS_API_SUBJECT_TO_CHANGE !


Modified: trunk/UI/GTK2/src/ServerThreads.h
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.h	2007-09-11 13:42:26 UTC (rev 972)
+++ trunk/UI/GTK2/src/ServerThreads.h	2007-09-11 13:52:46 UTC (rev 973)
@@ -23,7 +23,9 @@
 #include <vector>
 extern "C"
 {
+#if DBUS_VERSION < 1000000
 #define DBUS_API_SUBJECT_TO_CHANGE
+#endif
 #include <dbus/dbus.h>
 #include <dbus/dbus-glib.h>
 #include <dbus/dbus-glib-lowlevel.h>



From fabricecolin at mail.berlios.de  Tue Sep 11 15:54:26 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 11 Sep 2007 15:54:26 +0200
Subject: [Pinot-svn] r974 - trunk
Message-ID: <200709111354.l8BDsQ8s022160@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-11 15:54:26 +0200 (Tue, 11 Sep 2007)
New Revision: 974

Modified:
   trunk/Makefile.am
Log:
Use mkdir, not mkinstalldirs.


Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2007-09-11 13:52:46 UTC (rev 973)
+++ trunk/Makefile.am	2007-09-11 13:54:26 UTC (rev 974)
@@ -19,39 +19,39 @@
 	UI/GTK2/src/pinot.1 UI/GTK2/src/pinot-dbus-daemon.1
 
 install-data-local:
-	$(mkinstalldirs) $(DESTDIR)$(sysconfdir)/pinot
+	@mkdir -p $(DESTDIR)$(sysconfdir)/pinot
 	$(INSTALL_DATA) Tokenize/filters/external-filters.xml $(DESTDIR)$(sysconfdir)/pinot/external-filters.xml
 	$(INSTALL_DATA) globalconfig.xml $(DESTDIR)$(sysconfdir)/pinot/globalconfig.xml
 	$(INSTALL_DATA) textcat_conf.txt $(DESTDIR)$(sysconfdir)/pinot/textcat_conf.txt
 	$(INSTALL_DATA) textcat3_conf.txt $(DESTDIR)$(sysconfdir)/pinot/textcat3_conf.txt
-	$(mkinstalldirs) $(DESTDIR)$(datadir)/pinot $(DESTDIR)$(datadir)/dbus-1/services
+	@mkdir -p $(DESTDIR)$(datadir)/pinot $(DESTDIR)$(datadir)/dbus-1/services
 	$(INSTALL_DATA) UI/GTK2/xapian-powered.png $(DESTDIR)$(datadir)/pinot/xapian-powered.png
 	$(INSTALL_DATA) UI/GTK2/metase-gtk2.glade $(DESTDIR)$(datadir)/pinot/metase-gtk2.glade
 	$(INSTALL_DATA) UI/GTK2/metase-gtk2.gladep $(DESTDIR)$(datadir)/pinot/metase-gtk2.gladep
 	$(INSTALL_DATA) UI/GTK2/src/pinot-dbus-daemon.xml $(DESTDIR)$(datadir)/pinot/pinot-dbus-daemon.xml
 	$(INSTALL_DATA) UI/GTK2/src/de.berlios.Pinot.service $(DESTDIR)$(datadir)/dbus-1/services/de.berlios.Pinot.service
-	$(mkinstalldirs) $(DESTDIR)$(datadir)/pinot/engines
+	@mkdir -p $(DESTDIR)$(datadir)/pinot/engines
 	$(INSTALL_DATA) Search/Plugins/*.src $(DESTDIR)$(datadir)/pinot/engines/
 	@mv $(DESTDIR)$(datadir)/pinot/engines/AmazonAPI.src $(DESTDIR)$(datadir)/pinot/
 	$(INSTALL_DATA) Search/Plugins/*.xml $(DESTDIR)$(datadir)/pinot/engines/
-	$(mkinstalldirs) $(DESTDIR)$(libdir)/pinot/filters
+	@mkdir -p $(DESTDIR)$(libdir)/pinot/filters
 	@rm $(DESTDIR)$(libdir)/lib*filter.a $(DESTDIR)$(libdir)/lib*filter.la
 	@mv $(DESTDIR)$(libdir)/lib*filter* $(DESTDIR)$(libdir)/pinot/filters/
-	$(mkinstalldirs) $(DESTDIR)$(datadir)/icons/hicolor/48x48/apps/
+	@mkdir -p $(DESTDIR)$(datadir)/icons/hicolor/48x48/apps/
 	$(INSTALL_DATA) UI/icons/48x48/pinot.png $(DESTDIR)$(datadir)/icons/hicolor/48x48/apps/pinot.png
-	$(mkinstalldirs) $(DESTDIR)$(datadir)/icons/hicolor/32x32/apps/
+	@mkdir -p $(DESTDIR)$(datadir)/icons/hicolor/32x32/apps/
 	$(INSTALL_DATA) UI/icons/32x32/pinot.png $(DESTDIR)$(datadir)/icons/hicolor/32x32/apps/pinot.png
-	$(mkinstalldirs) $(DESTDIR)$(datadir)/icons/hicolor/24x24/apps/
+	@mkdir -p $(DESTDIR)$(datadir)/icons/hicolor/24x24/apps/
 	$(INSTALL_DATA) UI/icons/24x24/pinot.png $(DESTDIR)$(datadir)/icons/hicolor/24x24/apps/pinot.png
-	$(mkinstalldirs) $(DESTDIR)$(datadir)/icons/hicolor/22x22/apps/
+	@mkdir -p $(DESTDIR)$(datadir)/icons/hicolor/22x22/apps/
 	$(INSTALL_DATA) UI/icons/22x22/pinot.png $(DESTDIR)$(datadir)/icons/hicolor/22x22/apps/pinot.png
-	$(mkinstalldirs) $(DESTDIR)$(datadir)/icons/hicolor/16x16/apps/
+	@mkdir -p $(DESTDIR)$(datadir)/icons/hicolor/16x16/apps/
 	$(INSTALL_DATA) UI/icons/16x16/pinot.png $(DESTDIR)$(datadir)/icons/hicolor/16x16/apps/pinot.png
-	$(mkinstalldirs) $(DESTDIR)$(datadir)/applications
+	@mkdir -p $(DESTDIR)$(datadir)/applications
 	@desktop-file-install --vendor="" --dir=$(DESTDIR)$(datadir)/applications pinot.desktop
-	$(mkinstalldirs) $(DESTDIR)${sysconfdir}/xdg/autostart
+	@mkdir -p $(DESTDIR)${sysconfdir}/xdg/autostart
 	@desktop-file-install --vendor="" --dir=$(DESTDIR)${sysconfdir}/xdg/autostart pinot-dbus-daemon.desktop
-	$(mkinstalldirs) $(DESTDIR)$(libdir)/deskbar-applet/handlers/
+	@mkdir -p $(DESTDIR)$(libdir)/deskbar-applet/handlers/
 	$(INSTALL_DATA) scripts/python/pinot-live.py $(DESTDIR)$(libdir)/deskbar-applet/handlers/
 
 uninstall-local:



From fabricecolin at mail.berlios.de  Wed Sep 12 16:49:25 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 12 Sep 2007 16:49:25 +0200
Subject: [Pinot-svn] r975 - in trunk: SQL UI/GTK2/src
Message-ID: <200709121449.l8CEnP5D020156@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-12 16:49:24 +0200 (Wed, 12 Sep 2007)
New Revision: 975

Modified:
   trunk/SQL/QueryHistory.cpp
   trunk/SQL/QueryHistory.h
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
Log:
In importDialog, the location field suggests URLs pulled from QueryHistory,
based on what the user entered, similarly to terms suggestion on the live query
field.
Removed unnecessary match method in mainWindow.


Modified: trunk/SQL/QueryHistory.cpp
===================================================================
--- trunk/SQL/QueryHistory.cpp	2007-09-11 13:54:26 UTC (rev 974)
+++ trunk/SQL/QueryHistory.cpp	2007-09-12 14:49:24 UTC (rev 975)
@@ -71,14 +71,13 @@
 	const string &title, const string &extract, const string &charset, float score)
 {
 	Url urlObj(url);
-	string hostName = urlObj.getHost();
-	string escapedUrl = Url::escapeUrl(url);
+	string hostName(urlObj.getHost());
 	bool success = false;
 
 	SQLiteResults *results = executeStatement("INSERT INTO QueryHistory \
 		VALUES('%q', '%q', '%q', '%q', '%q', '%q', '%q', '%f', '0.0', '%d');",
 		queryName.c_str(), engineName.c_str(), hostName.c_str(),
-		escapedUrl.c_str(), title.c_str(), extract.c_str(), charset.c_str(),
+		Url::escapeUrl(url).c_str(), title.c_str(), extract.c_str(), charset.c_str(),
 		score, time(NULL));
 	if (results != NULL)
 	{
@@ -198,6 +197,41 @@
 	return extract;
 }
 
+/// Finds URLs.
+bool QueryHistory::findUrlsLike(const string &url, unsigned int count, set<string> &urls)
+{
+	bool success = false;
+
+	if (url.empty() == true)
+	{
+		return false; 
+	}
+
+	SQLiteResults *results = executeStatement("SELECT Url FROM QueryHistory \
+		WHERE Url LIKE '%q%%' ORDER BY Url LIMIT %u",
+		Url::escapeUrl(url).c_str(), count);
+	if (results != NULL)
+	{
+		while (results->hasMoreRows() == true)
+		{
+			SQLiteRow *row = results->nextRow();
+			if (row == NULL)
+			{
+				break;
+			}
+
+			urls.insert(Url::unescapeUrl(row->getColumn(0)));
+			success = true;
+
+			delete row;
+		}
+
+		delete results;
+	}
+
+	return success;
+}
+
 /// Gets a query's last run time.
 string QueryHistory::getLastRun(const string &queryName, const string &engineName)
 {
@@ -206,7 +240,7 @@
 
 	if (queryName.empty() == true)
 	{
-		return lastRun;
+		return "";
 	}
 
 	if (engineName.empty() == true)

Modified: trunk/SQL/QueryHistory.h
===================================================================
--- trunk/SQL/QueryHistory.h	2007-09-11 13:54:26 UTC (rev 974)
+++ trunk/SQL/QueryHistory.h	2007-09-12 14:49:24 UTC (rev 975)
@@ -21,6 +21,7 @@
 
 #include <string>
 #include <vector>
+#include <set>
 
 #include "DocumentInfo.h"
 #include "SQLiteBase.h"
@@ -60,6 +61,10 @@
 		string getItemExtract(const string &queryName, const string &engineName,
 			const string &url, string &charset);
 
+		/// Finds URLs.
+		bool findUrlsLike(const string &url, unsigned int count,
+			set<string> &urls);
+
 		/// Gets a query's last run time.
 		string getLastRun(const string &queryName, const string &engineName = "");
 

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2007-09-11 13:54:26 UTC (rev 974)
+++ trunk/UI/GTK2/src/importDialog.cc	2007-09-12 14:49:24 UTC (rev 975)
@@ -30,6 +30,7 @@
 #include "MIMEScanner.h"
 #include "NLS.h"
 #include "Url.h"
+#include "QueryHistory.h"
 #include "PinotSettings.h"
 #include "PinotUtils.h"
 #include "importDialog.hh"
@@ -40,6 +41,7 @@
 
 importDialog::InternalState::InternalState(unsigned int maxIndexThreads, importDialog *pWindow) :
 	ThreadsManager(PinotSettings::getInstance().m_docsIndexLocation, maxIndexThreads),
+	m_locationLength(0),
 	m_importing(false)
 {
 	m_onThreadEndSignal.connect(SigC::slot(*pWindow, &importDialog::on_thread_end));
@@ -54,6 +56,15 @@
 	m_docsCount(0),
 	m_state(10, this)
 {
+	// Enable completion on the location field
+	m_refLocationList = ListStore::create(m_locationColumns);
+	m_refLocationCompletion = EntryCompletion::create();
+	m_refLocationCompletion->set_model(m_refLocationList);
+	m_refLocationCompletion->set_text_column(m_locationColumns.m_name);
+	m_refLocationCompletion->set_minimum_key_length(8);
+	m_refLocationCompletion->set_popup_completion(true);
+	locationEntry->set_completion(m_refLocationCompletion);
+
 	// Populate
 	populate_comboboxes();
 
@@ -216,6 +227,36 @@
 		enableImport = false;
 	}
 	importButton->set_sensitive(enableImport);
+
+	unsigned int locationLength = fileName.length();
+
+	// Reset the list
+	m_refLocationList->clear();
+
+	// If characters are being deleted or if the location is too short, don't
+	// attempt to offer suggestions
+	if ((m_state.m_locationLength > locationLength) ||
+		(fileName.empty() == true) ||
+		(m_refLocationCompletion->get_minimum_key_length() > fileName.length()))
+	{
+		m_state.m_locationLength = locationLength;
+		return;
+	}
+	m_state.m_locationLength = locationLength;
+
+	// Get 10 URLs like this one
+	QueryHistory history(PinotSettings::getInstance().getHistoryDatabaseName());
+	set<string> suggestedUrls;
+	history.findUrlsLike(fileName, 10, suggestedUrls);
+	// Populate the list
+	for (set<string>::iterator urlIter = suggestedUrls.begin();
+		urlIter != suggestedUrls.end(); ++urlIter)
+	{
+		TreeModel::iterator iter = m_refLocationList->append();
+		TreeModel::Row row = *iter;
+
+		row[m_locationColumns.m_name] = to_utf8(*urlIter);
+	}
 }
 
 void importDialog::on_importButton_clicked()

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2007-09-11 13:54:26 UTC (rev 974)
+++ trunk/UI/GTK2/src/importDialog.hh	2007-09-12 14:49:24 UTC (rev 975)
@@ -23,8 +23,11 @@
 #include <set>
 #include <sigc++/slot.h>
 #include <sigc++/connection.h>
+#include <gtkmm/entrycompletion.h>
+#include <gtkmm/liststore.h>
 #include <glibmm/ustring.h>
 
+#include "ModelColumns.h"
 #include "WorkerThreads.h"
 #include "importDialog_glade.hh"
 
@@ -47,6 +50,9 @@
 	void on_thread_end(WorkerThread *pThread);
 
 private:
+	ComboModelColumns m_locationColumns;
+	Glib::RefPtr<Gtk::ListStore> m_refLocationList;
+	Glib::RefPtr<Gtk::EntryCompletion> m_refLocationCompletion;
 	unsigned int m_docsCount;
 	// Activity timeout
 	SigC::Connection m_timeoutConnection;
@@ -57,6 +63,7 @@
 			InternalState(unsigned int maxIndexThreads, importDialog *pWindow);
 			~InternalState();
 
+			unsigned int m_locationLength;
 			bool m_importing;
 
 	} m_state;

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-11 13:54:26 UTC (rev 974)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-12 14:49:24 UTC (rev 975)
@@ -130,8 +130,6 @@
 	m_refLiveQueryCompletion->set_text_column(m_liveQueryColumns.m_name);
 	m_refLiveQueryCompletion->set_minimum_key_length(3);
 	m_refLiveQueryCompletion->set_popup_completion(true);
-	m_refLiveQueryCompletion->set_match_func(
-		SigC::slot(*this, &mainWindow::on_queryCompletion_match));
 	liveQueryEntry->set_completion(m_refLiveQueryCompletion);
 
 	// Associate the columns model to the query tree
@@ -431,15 +429,6 @@
 	}
 }
 
-bool mainWindow::on_queryCompletion_match(const ustring &key, const TreeModel::const_iterator &iter)
-{
-	TreeModel::Row row = *iter;
-
-	ustring match = row[m_liveQueryColumns.m_name];
-
-	return true;
-}
-
 //
 // Engines tree selection changed
 //

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2007-09-11 13:54:26 UTC (rev 974)
+++ trunk/UI/GTK2/src/mainWindow.hh	2007-09-12 14:49:24 UTC (rev 975)
@@ -63,7 +63,6 @@
 	void add_query(QueryProperties &queryProps, bool mergeQueries);
 
 	// Handlers
-	bool on_queryCompletion_match(const Glib::ustring &key, const Gtk::TreeModel::const_iterator &iter);
 	void on_enginesTreeviewSelection_changed();
 	void on_queryTreeviewSelection_changed();
 	void on_resultsTreeviewSelection_changed(Glib::ustring queryName);



From fabricecolin at mail.berlios.de  Wed Sep 12 17:03:06 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 12 Sep 2007 17:03:06 +0200
Subject: [Pinot-svn] r976 - trunk
Message-ID: <200709121503.l8CF36N1021211@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-12 17:03:04 +0200 (Wed, 12 Sep 2007)
New Revision: 976

Modified:
   trunk/configure.in
Log:
Help output wasn't pretty. Reported by Reuben Thomas.


Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2007-09-12 14:49:24 UTC (rev 975)
+++ trunk/configure.in	2007-09-12 15:03:04 UTC (rev 976)
@@ -72,7 +72,9 @@
 
 dnl DEBUG mode
 AC_MSG_CHECKING(whether to enable DEBUG mode)
-AC_ARG_ENABLE(debug, [  --enable-debug Enable debug],,[enable_debug=no])
+AC_ARG_ENABLE(debug,
+   [AS_HELP_STRING([--enable-debug], [enable debug [default=no]])],
+   ,[enable_debug=no])
 if test "x$enable_debug" = "xyes"; then
    if test "x$GCC" = "xyes"; then
       CXXFLAGS="$CXXFLAGS -ggdb3 -O0 -DDEBUG"
@@ -85,7 +87,9 @@
 
 dnl SOAP API support
 AC_MSG_CHECKING(whether to enable SOAP support)
-AC_ARG_ENABLE(soap, [ --enable-soap Enable SOAP support],,[enable_soap=no])
+AC_ARG_ENABLE(soap,
+   [AS_HELP_STRING([--enable-soap], [enable SOAP support [default=no]])],
+   ,[enable_soap=no])
 if test "x$enable_soap" != "xyes"; then
    SOAP_CFLAGS=""
    SOAP_LIBS=""
@@ -110,8 +114,8 @@
 
 dnl Neon or Curl ?
 AC_MSG_CHECKING(which HTTP library to use)
-AC_ARG_WITH(http, AS_HELP_STRING(--with-http@<:@=neon|curl@:>@,
-   which HTTP library to use (default: curl)))
+AC_ARG_WITH(http,
+   [AS_HELP_STRING([--with-http@<:@=neon|curl@:>@], [which HTTP library to use [default=curl]])])
 httplibrary=$with_http
 if test "x$httplibrary" = "x"; then
    httplibrary="curl"



From fabricecolin at mail.berlios.de  Wed Sep 19 17:32:20 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 19 Sep 2007 17:32:20 +0200
Subject: [Pinot-svn] r977 - trunk/Utils
Message-ID: <200709191532.l8JFWK03002530@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-19 17:32:19 +0200 (Wed, 19 Sep 2007)
New Revision: 977

Modified:
   trunk/Utils/MIMEScanner.cpp
   trunk/Utils/MIMEScanner.h
Log:
Support for reinitialization.
Protect the caches list with a read/write lock as it can be emptied or appended
to while being read.
Prevent getDefaultActions() from returning the same action more than once.


Modified: trunk/Utils/MIMEScanner.cpp
===================================================================
--- trunk/Utils/MIMEScanner.cpp	2007-09-12 15:03:04 UTC (rev 976)
+++ trunk/Utils/MIMEScanner.cpp	2007-09-19 15:32:19 UTC (rev 977)
@@ -356,7 +356,8 @@
 	return foundActions;
 }
 
-pthread_mutex_t MIMEScanner::m_mutex = PTHREAD_MUTEX_INITIALIZER;
+pthread_mutex_t MIMEScanner::m_xdgMutex = PTHREAD_MUTEX_INITIALIZER;
+pthread_rwlock_t MIMEScanner::m_cachesLock = PTHREAD_RWLOCK_INITIALIZER;
 list<MIMECache> MIMEScanner::m_caches;
 
 MIMEScanner::MIMEScanner()
@@ -372,6 +373,15 @@
 	list<string> desktopFilesPaths;
 	bool foundActions = false;
 
+	// This may be a re-initialize
+	if (pthread_rwlock_wrlock(&m_cachesLock) == 0)
+	{
+		// Empty the caches list
+		m_caches.clear();
+
+		pthread_rwlock_unlock(&m_cachesLock);
+	}
+
 	if (systemDirectory.empty() == false)
 	{
 		// User-specific actions may point to desktop files in this path, so add it in
@@ -415,9 +425,18 @@
 bool MIMEScanner::addCache(const string &file, const string &section,
 	const list<string> &desktopFilesPaths)
 {
-	m_caches.push_back(MIMECache(file, section));
+	bool addedCache = false;
 
-	return m_caches.back().load(desktopFilesPaths);
+	if (pthread_rwlock_wrlock(&m_cachesLock) == 0)
+	{
+		m_caches.push_back(MIMECache(file, section));
+
+		addedCache = m_caches.back().load(desktopFilesPaths);
+
+		pthread_rwlock_unlock(&m_cachesLock);
+	}
+
+	return addedCache;
 }
 
 void MIMEScanner::shutdown(void)
@@ -435,11 +454,11 @@
 	}
 
 	// Does it have an obvious extension ?
-	if (pthread_mutex_lock(&m_mutex) == 0)
+	if (pthread_mutex_lock(&m_xdgMutex) == 0)
 	{
 		pType = xdg_mime_get_mime_type_from_file_name(fileName.c_str());
 
-		pthread_mutex_unlock(&m_mutex);
+		pthread_mutex_unlock(&m_xdgMutex);
 	}
 
 	if ((pType == NULL) ||
@@ -466,11 +485,11 @@
 		const char *pType = NULL;
 
 		// Have a peek at the file
-		if (pthread_mutex_lock(&m_mutex) == 0)
+		if (pthread_mutex_lock(&m_xdgMutex) == 0)
 		{
 			pType = xdg_mime_get_mime_type_for_file(fileName.c_str(), NULL);
 
-			pthread_mutex_unlock(&m_mutex);
+			pthread_mutex_unlock(&m_xdgMutex);
 		}
 
 		if (pType != NULL)
@@ -555,19 +574,30 @@
 {
 	// Custom actions get stored in a cache object which is not connected to a file
 	// We need to create this object the first time a custom action gets added
-	if ((m_caches.empty() == true) ||
-		(m_caches.front().m_file.empty() == false))
+	if (pthread_rwlock_wrlock(&m_cachesLock) == 0)
 	{
-		m_caches.push_front(MIMECache());
+		if ((m_caches.empty() == true) ||
+			(m_caches.front().m_file.empty() == false))
+		{
+			m_caches.push_front(MIMECache());
+		}
+
+		m_caches.front().m_defaultActions.insert(pair<string, MIMEAction>(mimeType, typeAction));
+
+		pthread_rwlock_unlock(&m_cachesLock);
 	}
-
-	m_caches.front().m_defaultActions.insert(pair<string, MIMEAction>(mimeType, typeAction));
 }
 
-bool MIMEScanner::getDefaultActionsForType(const string &mimeType, vector<MIMEAction> &typeActions)
+bool MIMEScanner::getDefaultActionsForType(const string &mimeType, set<string> &actionNames,
+	vector<MIMEAction> &typeActions)
 {
 	bool foundAction = false;
 
+	if (pthread_rwlock_rdlock(&m_cachesLock) != 0)
+	{
+		return false;
+	}
+
 	// Each cache may have more than one action for this type
 	for (list<MIMECache>::iterator cacheIter = m_caches.begin(); cacheIter != m_caches.end(); ++cacheIter)
 	{
@@ -579,27 +609,36 @@
 		// Found anything ?
 		for (; actionIter != endActionIter; ++actionIter)
 		{
+			// The same action may be defined for another type
+			if (actionNames.find(actionIter->second.m_name) == actionNames.end())
+			{
 #ifdef DEBUG
-			cout << "MIMEScanner::getDefaultActions: action " << actionIter->second.m_name
-				<< " at " << actionIter->second.m_location << endl;
+				cout << "MIMEScanner::getDefaultActions: action " << actionIter->second.m_name
+					<< " at " << actionIter->second.m_location << endl;
 #endif
-			typeActions.push_back(actionIter->second);
-			foundAction = true;
+				actionNames.insert(actionIter->second.m_name);
+				typeActions.push_back(actionIter->second);
+				foundAction = true;
+			}
 		}
 	}
   
+	pthread_rwlock_unlock(&m_cachesLock);
+
 	return foundAction;
 }
 
 /// Determines the default action(s) for the given type.
 bool MIMEScanner::getDefaultActions(const string &mimeType, vector<MIMEAction> &typeActions)
 {
+	set<string> actionNames;
+	
 	typeActions.clear();
   
 #ifdef DEBUG
 	cout << "MIMEScanner::getDefaultActions: searching for " << mimeType << endl;
 #endif
-	bool foundAction = getDefaultActionsForType(mimeType, typeActions);
+	bool foundAction = getDefaultActionsForType(mimeType, actionNames, typeActions);
 	if (foundAction == false)
 	{
 		// Is there an action for any of this type's parents ?
@@ -609,10 +648,12 @@
 		{
 			for (unsigned int i = 0; pParentTypes[i] != NULL; ++i)
 			{
+				string parentType(pParentTypes[i]);
+
 #ifdef DEBUG
-				cout << "MIMEScanner::getDefaultActions: searching for parent type " << pParentTypes[i] << endl;
+				cout << "MIMEScanner::getDefaultActions: searching for parent type " << parentType << endl;
 #endif
-				foundAction = getDefaultActionsForType(string(pParentTypes[i]), typeActions);
+				foundAction = getDefaultActionsForType(parentType, actionNames, typeActions);
 				if (foundAction)
 				{
 					break;

Modified: trunk/Utils/MIMEScanner.h
===================================================================
--- trunk/Utils/MIMEScanner.h	2007-09-12 15:03:04 UTC (rev 976)
+++ trunk/Utils/MIMEScanner.h	2007-09-19 15:32:19 UTC (rev 977)
@@ -117,7 +117,9 @@
 
 	protected:
 		/// Mutex to protect access to xdgmime.
-		static pthread_mutex_t m_mutex;
+		static pthread_mutex_t m_xdgMutex;
+		/// Lock to protect access to caches.
+		static pthread_rwlock_t m_cachesLock;
 		/// MIME type caches, ordered by decreasing priority.
 		static std::list<MIMECache> m_caches;
 
@@ -128,7 +130,8 @@
 		static bool addCache(const std::string &file, const std::string &section,
 			const std::list<std::string> &desktopFilesPaths);
   
-		static bool getDefaultActionsForType(const std::string &mimeType, std::vector<MIMEAction> &typeActions);
+		static bool getDefaultActionsForType(const std::string &mimeType, std::set<std::string> &actionNames,
+			std::vector<MIMEAction> &typeActions);
 
 	private:
 		MIMEScanner(const MIMEScanner &other);



From fabricecolin at mail.berlios.de  Wed Sep 19 17:34:50 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 19 Sep 2007 17:34:50 +0200
Subject: [Pinot-svn] r978 - in trunk: Tokenize UI/GTK2/src
Message-ID: <200709191534.l8JFYoik002708@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-19 17:34:50 +0200 (Wed, 19 Sep 2007)
New Revision: 978

Modified:
   trunk/Tokenize/FilterUtils.cpp
   trunk/Tokenize/FilterUtils.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
Log:
Just like with getFilter(), we need a version of isSupportedType() that knows
about parent types.


Modified: trunk/Tokenize/FilterUtils.cpp
===================================================================
--- trunk/Tokenize/FilterUtils.cpp	2007-09-19 15:32:19 UTC (rev 977)
+++ trunk/Tokenize/FilterUtils.cpp	2007-09-19 15:34:50 UTC (rev 978)
@@ -87,6 +87,38 @@
 	return NULL;
 }
 
+bool FilterUtils::isSupportedType(const string &mimeType)
+{
+	// Is this type aliased ?
+	map<string, string>::const_iterator aliasIter = m_typeAliases.find(mimeType);
+	if (aliasIter != m_typeAliases.end())
+	{
+		// There's an alias because we were able to get a filter for this parent type
+		// or a previous call to isSupportedType() succeeded
+		return true;
+	}
+
+	if (Dijon::FilterFactory::isSupportedType(mimeType) == false)
+	{
+		set<string> parentTypes;
+
+		// Try that type's parents
+		MIMEScanner::getParentTypes(mimeType, parentTypes);
+		for (set<string>::const_iterator parentIter = parentTypes.begin();
+			parentIter != parentTypes.end(); ++parentIter)
+		{
+			if (Dijon::FilterFactory::isSupportedType(*parentIter) == true)
+			{
+				// Add an alias
+				m_typeAliases[mimeType] = *parentIter;
+				return true;
+			}
+		}
+	}
+
+	return false;
+}
+
 bool FilterUtils::feedFilter(const Document &doc, Dijon::Filter *pFilter)
 {
 	string location(doc.getLocation());

Modified: trunk/Tokenize/FilterUtils.h
===================================================================
--- trunk/Tokenize/FilterUtils.h	2007-09-19 15:32:19 UTC (rev 977)
+++ trunk/Tokenize/FilterUtils.h	2007-09-19 15:34:50 UTC (rev 978)
@@ -34,6 +34,9 @@
 		/// Returns a Filter that handles the given MIME type, or one of its parents.
 		static Dijon::Filter *getFilter(const std::string &mimeType);
 
+		/// Indicates whether a MIME type is supported or not.
+		static bool isSupportedType(const std::string &mimeType);
+
 		/// Feeds a document's data to a filter.
 		static bool feedFilter(const Document &doc, Dijon::Filter *pFilter);
 

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-19 15:32:19 UTC (rev 977)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-19 15:34:50 UTC (rev 978)
@@ -1351,7 +1351,7 @@
 		m_docInfo.setType(MIMEScanner::scanUrl(thisUrl));
 	}
 
-	if (Dijon::FilterFactory::isSupportedType(m_docInfo.getType()) == false)
+	if (FilterUtils::isSupportedType(m_docInfo.getType()) == false)
 	{
 		// Skip unsupported types ?
 		if (m_allowAllMIMETypes == false)
@@ -1430,7 +1430,7 @@
 #endif
 
 		// Check again as the downloader may have altered the MIME type
-		if (Dijon::FilterFactory::isSupportedType(m_docInfo.getType()) == false)
+		if (FilterUtils::isSupportedType(m_docInfo.getType()) == false)
 		{
 			// Skip unsupported types ?
 			if (m_allowAllMIMETypes == false)



From fabricecolin at mail.berlios.de  Wed Sep 19 17:36:45 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 19 Sep 2007 17:36:45 +0200
Subject: [Pinot-svn] r979 - trunk/UI/GTK2/src
Message-ID: <200709191536.l8JFaj1K002939@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-19 17:36:45 +0200 (Wed, 19 Sep 2007)
New Revision: 979

Modified:
   trunk/UI/GTK2/src/ServerThreads.cpp
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
Log:
Don't refer to XapianEngine directly.


Modified: trunk/UI/GTK2/src/ServerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.cpp	2007-09-19 15:34:50 UTC (rev 978)
+++ trunk/UI/GTK2/src/ServerThreads.cpp	2007-09-19 15:36:45 UTC (rev 979)
@@ -40,7 +40,7 @@
 #include "Url.h"
 #include "DBusXapianIndex.h"
 #include "XapianIndex.h"
-#include "XapianEngine.h"
+#include "SearchEngineFactory.h"
 #include "config.h"
 #include "NLS.h"
 #include "DaemonState.h"
@@ -816,27 +816,36 @@
 
 bool DBusServletThread::runQuery(QueryProperties &queryProps, vector<string> &docIds)
 {
-	XapianEngine engine(PinotSettings::getInstance().m_daemonIndexLocation);
-
 	docIds.clear();
 
+	SearchEngineInterface *pEngine = SearchEngineFactory::getSearchEngine("xapian",
+		PinotSettings::getInstance().m_daemonIndexLocation);
+	if (pEngine == NULL)
+	{
+		return false;
+	}
+
 	// Run the query
-	engine.setDefaultOperator(SearchEngineInterface::DEFAULT_OP_AND);
-	if (engine.runQuery(queryProps) == false)
+	pEngine->setDefaultOperator(SearchEngineInterface::DEFAULT_OP_AND);
+	if (pEngine->runQuery(queryProps) == false)
 	{
+		delete pEngine;
+
 		return false;
 	}
 
-	const vector<DocumentInfo> &resultsList = engine.getResults();
+	const vector<DocumentInfo> &resultsList = pEngine->getResults();
 	if (resultsList.empty() == true)
 	{
 #ifdef DEBUG
 		cout << "DBusServletThread::runQuery: trying again" << endl;
 #endif
 		// Try again, this time with OR as default operator
-		engine.setDefaultOperator(SearchEngineInterface::DEFAULT_OP_OR);
-		if (engine.runQuery(queryProps) == false)
+		pEngine->setDefaultOperator(SearchEngineInterface::DEFAULT_OP_OR);
+		if (pEngine->runQuery(queryProps) == false)
 		{
+			delete pEngine;
+
 			return false;
 		}
 	}
@@ -857,6 +866,8 @@
 		}
 	}
 
+	delete pEngine;
+
 	return true;
 }
 

Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2007-09-19 15:34:50 UTC (rev 978)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2007-09-19 15:36:45 UTC (rev 979)
@@ -45,7 +45,6 @@
 #include "ViewHistory.h"
 #include "DownloaderInterface.h"
 #include "XapianIndex.h"
-#include "XapianEngine.h"
 #include "config.h"
 #include "NLS.h"
 #include "DaemonState.h"



From fabricecolin at mail.berlios.de  Fri Sep 21 18:41:12 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 21 Sep 2007 18:41:12 +0200
Subject: [Pinot-svn] r980 - in trunk: UI/GTK2/src Utils
Message-ID: <200709211641.l8LGfCYP022628@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-21 18:41:09 +0200 (Fri, 21 Sep 2007)
New Revision: 980

Modified:
   trunk/UI/GTK2/src/OnDiskHandler.cpp
   trunk/UI/GTK2/src/OnDiskHandler.h
   trunk/UI/GTK2/src/ServerThreads.cpp
   trunk/UI/GTK2/src/ServerThreads.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
   trunk/UI/GTK2/src/pinot.cc
   trunk/Utils/MIMEScanner.cpp
   trunk/Utils/MIMEScanner.h
Log:
MIMEScanner::initialize() takes prefixes (eg /usr /home/bozo/.local) instead of
directories. Method listConfigurationFiles() returns files to monitor for
modifications. Those are monitored by the UI and modifications trigger a
re-initialization of MIMEScanner.
Moved MonitorThread from ServerThreads to WorkerThreads.


Modified: trunk/UI/GTK2/src/OnDiskHandler.cpp
===================================================================
--- trunk/UI/GTK2/src/OnDiskHandler.cpp	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/OnDiskHandler.cpp	2007-09-21 16:41:09 UTC (rev 980)
@@ -35,7 +35,6 @@
 #include "OnDiskHandler.h"
 
 using namespace std;
-using namespace SigC;
 
 OnDiskHandler::OnDiskHandler() :
 	MonitorHandler(),

Modified: trunk/UI/GTK2/src/OnDiskHandler.h
===================================================================
--- trunk/UI/GTK2/src/OnDiskHandler.h	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/OnDiskHandler.h	2007-09-21 16:41:09 UTC (rev 980)
@@ -23,7 +23,6 @@
 #include <pthread.h>
 #include <string>
 #include <map>
-#include <sigc++/slot.h>
 
 #include "CrawlHistory.h"
 #include "MonitorHandler.h"

Modified: trunk/UI/GTK2/src/ServerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.cpp	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/ServerThreads.cpp	2007-09-21 16:41:09 UTC (rev 980)
@@ -108,250 +108,6 @@
 	return readFile;
 }
 
-MonitorThread::MonitorThread(MonitorInterface *pMonitor, MonitorHandler *pHandler) :
-	WorkerThread(),
-	m_ctrlReadPipe(-1),
-	m_ctrlWritePipe(-1),
-	m_pMonitor(pMonitor),
-	m_pHandler(pHandler)
-{
-	int pipeFds[2];
-
-	if (pipe(pipeFds) == 0)
-	{
-		// This pipe will allow to stop select()
-		m_ctrlReadPipe = pipeFds[0];
-		m_ctrlWritePipe = pipeFds[1];
-	}
-}
-
-MonitorThread::~MonitorThread()
-{
-	close(m_ctrlReadPipe);
-	close(m_ctrlWritePipe);
-}
-
-string MonitorThread::getType(void) const
-{
-	return "MonitorThread";
-}
-
-bool MonitorThread::stop(void)
-{
-	// Disconnect the signal
-	Signal3<void, const DocumentInfo&, const std::string&, bool>::slot_list_type slotsList = m_signalDirectoryFound.slots();
-	Signal3<void, const DocumentInfo&, const std::string&, bool>::slot_list_type::iterator slotIter = slotsList.begin();
-	if (slotIter != slotsList.end())
-	{
-		if (slotIter->empty() == false)
-		{
-			slotIter->block();
-			slotIter->disconnect();
-		}
-	}
-	m_done = true;
-	write(m_ctrlWritePipe, "X", 1);
-
-	return true;
-}
-
-Signal3<void, const DocumentInfo&, const std::string&, bool>& MonitorThread::getDirectoryFoundSignal(void)
-{
-	return m_signalDirectoryFound;
-}
-
-void MonitorThread::processEvents(void)
-{
-	CrawlHistory history(PinotSettings::getInstance().getHistoryDatabaseName());
-	queue<MonitorEvent> events;
-
-#ifdef DEBUG
-	cout << "MonitorThread::processEvents: checking for events" << endl;
-#endif
-	if ((m_pMonitor == NULL) ||
-		(m_pMonitor->retrievePendingEvents(events) == false))
-	{
-#ifdef DEBUG
-		cout << "MonitorThread::processEvents: failed to retrieve pending events" << endl;
-#endif
-		return;
-	}
-#ifdef DEBUG
-	cout << "MonitorThread::processEvents: retrieved " << events.size() << " events" << endl;
-#endif
-
-	while ((events.empty() == false) &&
-		(m_done == false))
-	{
-		MonitorEvent &event = events.front();
-
-		if ((event.m_location.empty() == true) ||
-			(event.m_type == MonitorEvent::UNKNOWN))
-		{
-			// Next
-			events.pop();
-			continue;
-		}
-#ifdef DEBUG
-		cout << "MonitorThread::processEvents: event " << event.m_type << " on "
-			<< event.m_location << " " << event.m_isDirectory << endl;
-#endif
-
-		// Skip dotfiles and blacklisted files
-		Url urlObj("file://" + event.m_location);
-		if ((urlObj.getFile()[0] == '.') ||
-			(PinotSettings::getInstance().isBlackListed(event.m_location) == true))
-		{
-			// Next
-			events.pop();
-			continue;
-		}
-
-		// What's the event code ?
-		if (event.m_type == MonitorEvent::EXISTS)
-		{
-			if (event.m_isDirectory == false)
-			{
-				m_pHandler->fileExists(event.m_location);
-			}
-		}
-		else if (event.m_type == MonitorEvent::CREATED)
-		{
-			if (event.m_isDirectory == false)
-			{
-				m_pHandler->fileCreated(event.m_location);
-			}
-			else
-			{
-				DocumentInfo docInfo("", string("file://") + event.m_location, "", "");
-
-				// Report this directory so that it is crawled
-				m_signalDirectoryFound(docInfo, "", true);
-			}
-		}
-		else if (event.m_type == MonitorEvent::WRITE_CLOSED)
-		{
-			if (event.m_isDirectory == false)
-			{
-				CrawlHistory::CrawlStatus status = CrawlHistory::UNKNOWN;
-				struct stat fileStat;
-				time_t itemDate;
-
-				if (history.hasItem("file://" + event.m_location, status, itemDate) == true)
-				{
-					// Was the file actually modified ?
-					if ((stat(event.m_location.c_str(), &fileStat) == 0) &&
-						(itemDate < fileStat.st_mtime))
-					{
-						m_pHandler->fileModified(event.m_location);
-					}
-#ifdef DEBUG
-					else cout << "MonitorThread::processEvents: file wasn't modified" << endl;
-#endif
-				}
-#ifdef DEBUG
-				else cout << "MonitorThread::processEvents: file wasn't crawled" << endl;
-#endif
-			}
-		}
-		else if (event.m_type == MonitorEvent::MOVED)
-		{
-			if (event.m_isDirectory == false)
-			{
-				m_pHandler->fileMoved(event.m_location, event.m_previousLocation);
-			}
-			else
-			{
-				// We should receive this only if the destination directory is monitored too
-				m_pHandler->directoryMoved(event.m_location, event.m_previousLocation);
-			}
-		}
-		else if (event.m_type == MonitorEvent::DELETED)
-		{
-			if (event.m_isDirectory == false)
-			{
-				m_pHandler->fileDeleted(event.m_location);
-			}
-			else
-			{
-				// The monitor should have stopped monitoring this
-				// In practice, events for the files in this directory will already have been received 
-				m_pHandler->directoryDeleted(event.m_location);
-			}
-		}
-
-		// Next
-		events.pop();
-	}
-}
-
-void MonitorThread::doWork(void)
-{
-	if ((m_pHandler == NULL) ||
-		(m_pMonitor == NULL))
-	{
-		m_status = _("No monitoring handler");
-		return;
-	}
-
-	// Initialize the handler
-	m_pHandler->initialize();
-
-	// Get the list of files to monitor
-	const set<string> &fileNames = m_pHandler->getFileNames();
-	for (set<string>::const_iterator fileIter = fileNames.begin();
-		fileIter != fileNames.end(); ++fileIter)
-	{
-		m_pMonitor->addLocation(*fileIter, false);
-	}
-	// Directories, if any, are set elsewhere
-	// In the case of OnDiskHandler, they are set by DirectoryScannerThread
-
-	// There might already be events that need processing
-	processEvents();
-
-	// Wait for something to happen
-	while (m_done == false)
-	{
-		struct timeval selectTimeout;
-		fd_set listenSet;
-
-		selectTimeout.tv_sec = 60;
-		selectTimeout.tv_usec = 0;
-
-		FD_ZERO(&listenSet);
-		if (m_ctrlReadPipe >= 0)
-		{
-			FD_SET(m_ctrlReadPipe, &listenSet);
-		}
-
-		m_pHandler->flushIndex();
-
-		// The file descriptor may change over time
-		int monitorFd = m_pMonitor->getFileDescriptor();
-		FD_SET(monitorFd, &listenSet);
-		if (monitorFd < 0)
-		{
-			m_status = _("Couldn't initialize file monitor");
-			return;
-		}
-
-		int fdCount = select(max(monitorFd, m_ctrlReadPipe) + 1, &listenSet, NULL, NULL, &selectTimeout);
-		if ((fdCount < 0) &&
-			(errno != EINTR))
-		{
-#ifdef DEBUG
-			cout << "MonitorThread::doWork: select() failed" << endl;
-#endif
-			break;
-		}
-		else if (FD_ISSET(monitorFd, &listenSet))
-		{
-			processEvents();
-		}
-	}
-}
-
 DirectoryScannerThread::DirectoryScannerThread(const string &dirName, bool isSource,
 	bool fullScan, MonitorInterface *pMonitor, MonitorHandler *pHandler,
 	unsigned int maxLevel, bool followSymLinks) :

Modified: trunk/UI/GTK2/src/ServerThreads.h
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.h	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/ServerThreads.h	2007-09-21 16:41:09 UTC (rev 980)
@@ -43,34 +43,6 @@
 #include "DaemonState.h"
 #include "WorkerThreads.h"
 
-class MonitorThread : public WorkerThread
-{
-	public:
-		MonitorThread(MonitorInterface *pMonitor, MonitorHandler *pHandler);
-		virtual ~MonitorThread();
-
-		virtual std::string getType(void) const;
-
-		virtual bool stop(void);
-
-		SigC::Signal3<void, const DocumentInfo&, const std::string&, bool>& getDirectoryFoundSignal(void);
-
-	protected:
-		int m_ctrlReadPipe;
-		int m_ctrlWritePipe;
-		MonitorInterface *m_pMonitor;
-		MonitorHandler *m_pHandler;
-		SigC::Signal3<void, const DocumentInfo&, const std::string&, bool> m_signalDirectoryFound;
-
-		void processEvents(void);
-		virtual void doWork(void);
-
-	private:
-		MonitorThread(const MonitorThread &other);
-		MonitorThread &operator=(const MonitorThread &other);
-
-};
-
 class DirectoryScannerThread : public WorkerThread
 {
 	public:

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-21 16:41:09 UTC (rev 980)
@@ -22,6 +22,7 @@
 #include <fcntl.h>
 #include <string.h>
 #include <signal.h>
+#include <errno.h>
 #include <exception>
 #include <iostream>
 #include <fstream>
@@ -1789,3 +1790,253 @@
 	}
 }
 
+MonitorThread::MonitorThread(MonitorInterface *pMonitor, MonitorHandler *pHandler,
+	bool checkHistory) :
+	WorkerThread(),
+	m_ctrlReadPipe(-1),
+	m_ctrlWritePipe(-1),
+	m_pMonitor(pMonitor),
+	m_pHandler(pHandler),
+	m_checkHistory(checkHistory)
+{
+	int pipeFds[2];
+
+	if (pipe(pipeFds) == 0)
+	{
+		// This pipe will allow to stop select()
+		m_ctrlReadPipe = pipeFds[0];
+		m_ctrlWritePipe = pipeFds[1];
+	}
+}
+
+MonitorThread::~MonitorThread()
+{
+	close(m_ctrlReadPipe);
+	close(m_ctrlWritePipe);
+}
+
+string MonitorThread::getType(void) const
+{
+	return "MonitorThread";
+}
+
+bool MonitorThread::stop(void)
+{
+	// Disconnect the signal
+	Signal3<void, const DocumentInfo&, const std::string&, bool>::slot_list_type slotsList = m_signalDirectoryFound.slots();
+	Signal3<void, const DocumentInfo&, const std::string&, bool>::slot_list_type::iterator slotIter = slotsList.begin();
+	if (slotIter != slotsList.end())
+	{
+		if (slotIter->empty() == false)
+		{
+			slotIter->block();
+			slotIter->disconnect();
+		}
+	}
+	m_done = true;
+	write(m_ctrlWritePipe, "X", 1);
+
+	return true;
+}
+
+Signal3<void, const DocumentInfo&, const std::string&, bool>& MonitorThread::getDirectoryFoundSignal(void)
+{
+	return m_signalDirectoryFound;
+}
+
+void MonitorThread::processEvents(void)
+{
+	CrawlHistory history(PinotSettings::getInstance().getHistoryDatabaseName());
+	queue<MonitorEvent> events;
+
+#ifdef DEBUG
+	cout << "MonitorThread::processEvents: checking for events" << endl;
+#endif
+	if ((m_pMonitor == NULL) ||
+		(m_pMonitor->retrievePendingEvents(events) == false))
+	{
+#ifdef DEBUG
+		cout << "MonitorThread::processEvents: failed to retrieve pending events" << endl;
+#endif
+		return;
+	}
+#ifdef DEBUG
+	cout << "MonitorThread::processEvents: retrieved " << events.size() << " events" << endl;
+#endif
+
+	while ((events.empty() == false) &&
+		(m_done == false))
+	{
+		MonitorEvent &event = events.front();
+
+		if ((event.m_location.empty() == true) ||
+			(event.m_type == MonitorEvent::UNKNOWN))
+		{
+			// Next
+			events.pop();
+			continue;
+		}
+#ifdef DEBUG
+		cout << "MonitorThread::processEvents: event " << event.m_type << " on "
+			<< event.m_location << " " << event.m_isDirectory << endl;
+#endif
+
+		// Skip dotfiles and blacklisted files
+		Url urlObj("file://" + event.m_location);
+		if ((urlObj.getFile()[0] == '.') ||
+			(PinotSettings::getInstance().isBlackListed(event.m_location) == true))
+		{
+			// Next
+			events.pop();
+			continue;
+		}
+
+		// What's the event code ?
+		if (event.m_type == MonitorEvent::EXISTS)
+		{
+			if (event.m_isDirectory == false)
+			{
+				m_pHandler->fileExists(event.m_location);
+			}
+		}
+		else if (event.m_type == MonitorEvent::CREATED)
+		{
+			if (event.m_isDirectory == false)
+			{
+				m_pHandler->fileCreated(event.m_location);
+			}
+			else
+			{
+				DocumentInfo docInfo("", string("file://") + event.m_location, "", "");
+
+				// Report this directory so that it is crawled
+				m_signalDirectoryFound(docInfo, "", true);
+			}
+		}
+		else if (event.m_type == MonitorEvent::WRITE_CLOSED)
+		{
+			if (event.m_isDirectory == false)
+			{
+				CrawlHistory::CrawlStatus status = CrawlHistory::UNKNOWN;
+				struct stat fileStat;
+				time_t itemDate = 0;
+
+				if (m_checkHistory == false)
+				{
+					m_pHandler->fileModified(event.m_location);
+				}
+				else if (history.hasItem("file://" + event.m_location, status, itemDate) == true)
+				{
+					// Was the file actually modified ?
+					if ((stat(event.m_location.c_str(), &fileStat) == 0) &&
+						(itemDate < fileStat.st_mtime))
+					{
+						m_pHandler->fileModified(event.m_location);
+					}
+#ifdef DEBUG
+					else cout << "MonitorThread::processEvents: file wasn't modified" << endl;
+#endif
+				}
+#ifdef DEBUG
+				else cout << "MonitorThread::processEvents: file wasn't crawled" << endl;
+#endif
+			}
+		}
+		else if (event.m_type == MonitorEvent::MOVED)
+		{
+			if (event.m_isDirectory == false)
+			{
+				m_pHandler->fileMoved(event.m_location, event.m_previousLocation);
+			}
+			else
+			{
+				// We should receive this only if the destination directory is monitored too
+				m_pHandler->directoryMoved(event.m_location, event.m_previousLocation);
+			}
+		}
+		else if (event.m_type == MonitorEvent::DELETED)
+		{
+			if (event.m_isDirectory == false)
+			{
+				m_pHandler->fileDeleted(event.m_location);
+			}
+			else
+			{
+				// The monitor should have stopped monitoring this
+				// In practice, events for the files in this directory will already have been received 
+				m_pHandler->directoryDeleted(event.m_location);
+			}
+		}
+
+		// Next
+		events.pop();
+	}
+}
+
+void MonitorThread::doWork(void)
+{
+	if ((m_pHandler == NULL) ||
+		(m_pMonitor == NULL))
+	{
+		m_status = _("No monitoring handler");
+		return;
+	}
+
+	// Initialize the handler
+	m_pHandler->initialize();
+
+	// Get the list of files to monitor
+	const set<string> &fileNames = m_pHandler->getFileNames();
+	for (set<string>::const_iterator fileIter = fileNames.begin();
+		fileIter != fileNames.end(); ++fileIter)
+	{
+		m_pMonitor->addLocation(*fileIter, false);
+	}
+	// Directories, if any, are set elsewhere
+	// In the case of OnDiskHandler, they are set by DirectoryScannerThread
+
+	// There might already be events that need processing
+	processEvents();
+
+	// Wait for something to happen
+	while (m_done == false)
+	{
+		struct timeval selectTimeout;
+		fd_set listenSet;
+
+		selectTimeout.tv_sec = 60;
+		selectTimeout.tv_usec = 0;
+
+		FD_ZERO(&listenSet);
+		if (m_ctrlReadPipe >= 0)
+		{
+			FD_SET(m_ctrlReadPipe, &listenSet);
+		}
+
+		m_pHandler->flushIndex();
+
+		// The file descriptor may change over time
+		int monitorFd = m_pMonitor->getFileDescriptor();
+		FD_SET(monitorFd, &listenSet);
+		if (monitorFd < 0)
+		{
+			m_status = _("Couldn't initialize file monitor");
+			return;
+		}
+
+		int fdCount = select(max(monitorFd, m_ctrlReadPipe) + 1, &listenSet, NULL, NULL, &selectTimeout);
+		if ((fdCount < 0) &&
+			(errno != EINTR))
+		{
+#ifdef DEBUG
+			cout << "MonitorThread::doWork: select() failed" << endl;
+#endif
+			break;
+		}
+		else if (FD_ISSET(monitorFd, &listenSet))
+		{
+			processEvents();
+		}
+	}
+}
+

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2007-09-21 16:41:09 UTC (rev 980)
@@ -35,6 +35,8 @@
 
 #include "Document.h"
 #include "DownloaderInterface.h"
+#include "MonitorInterface.h"
+#include "MonitorHandler.h"
 #include "QueryProperties.h"
 
 class WorkerThread
@@ -440,4 +442,34 @@
 
 };
 
+class MonitorThread : public WorkerThread
+{
+	public:
+		MonitorThread(MonitorInterface *pMonitor, MonitorHandler *pHandler,
+			bool checkHistory = true);
+		virtual ~MonitorThread();
+
+		virtual std::string getType(void) const;
+
+		virtual bool stop(void);
+
+		SigC::Signal3<void, const DocumentInfo&, const std::string&, bool>& getDirectoryFoundSignal(void);
+
+	protected:
+		int m_ctrlReadPipe;
+		int m_ctrlWritePipe;
+		MonitorInterface *m_pMonitor;
+		MonitorHandler *m_pHandler;
+		bool m_checkHistory;
+		SigC::Signal3<void, const DocumentInfo&, const std::string&, bool> m_signalDirectoryFound;
+
+		void processEvents(void);
+		virtual void doWork(void);
+
+	private:
+		MonitorThread(const MonitorThread &other);
+		MonitorThread &operator=(const MonitorThread &other);
+
+};
+
 #endif // _WORKERTHREADS_HH

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-21 16:41:09 UTC (rev 980)
@@ -41,6 +41,7 @@
 #include "MIMEScanner.h"
 #include "Url.h"
 #include "XapianDatabase.h"
+#include "MonitorFactory.h"
 #include "QueryHistory.h"
 #include "ViewHistory.h"
 #include "DownloaderFactory.h"
@@ -62,6 +63,76 @@
 using namespace Gdk;
 using namespace Gtk;
 
+class ReloadHandler : public MonitorHandler
+{
+	public:
+		ReloadHandler() : MonitorHandler() {}
+		virtual ~ReloadHandler() {}
+
+		/// Initializes things before starting monitoring.
+		virtual void initialize(void) {}
+
+		/// Handles flushing the index.
+		virtual void flushIndex(void) {}
+
+		/// Handles file existence events.
+		virtual bool fileExists(const std::string &fileName)
+		{
+			// Nothing to do here
+			return true; 
+		}
+
+		/// Handles file creation events.
+		virtual bool fileCreated(const std::string &fileName)
+		{
+			// Nothing to do here
+			return true; 
+		}
+
+		/// Handles file modified events.
+		virtual bool fileModified(const std::string &fileName)
+		{
+			// Re-initialize the MIME sub-system
+			return MIMEScanner::initialize(PinotSettings::getHomeDirectory() + "/.local",
+				string(SHARED_MIME_INFO_PREFIX));
+		}
+
+		/// Handles file moved events.
+		virtual bool fileMoved(const std::string &fileName,
+			const std::string &previousFileName)
+		{
+			// Nothing to do here
+			return true; 
+		}
+
+		/// Handles directory moved events.
+		virtual bool directoryMoved(const std::string &dirName,
+			const std::string &previousDirName)
+		{
+			// Nothing to do here
+			return true; 
+		}
+
+		/// Handles file deleted events.
+		virtual bool fileDeleted(const std::string &fileName)
+		{
+			// Nothing to do here
+			return true; 
+		}
+
+		/// Handles directory deleted events.
+		virtual bool directoryDeleted(const std::string &dirName)
+		{
+			// Nothing to do here
+			return true; 
+		}
+
+	private:
+		ReloadHandler(const ReloadHandler &other);
+		ReloadHandler &operator=(const ReloadHandler &other);
+
+};
+
 // FIXME: this ought to be configurable
 unsigned int mainWindow::m_maxDocsCount = 100;
 unsigned int mainWindow::m_maxIndexThreads = 2;
@@ -89,6 +160,8 @@
 	m_pNotebook(NULL),
 	m_pIndexMenu(NULL),
 	m_pCacheMenu(NULL),
+	m_pSettingsMonitor(MonitorFactory::getMonitor()),
+	m_pSettingsHandler(NULL),
 	m_state(m_maxIndexThreads, this)
 {
 	// Reposition and resize the window
@@ -186,6 +259,19 @@
 	// Connect to threads' finished signal
 	m_state.connect();
 
+	// Monitor MIME settings files for changes in the background
+	set<string> mimeFiles;
+	MIMEScanner::listConfigurationFiles(PinotSettings::getHomeDirectory() + "/.local", mimeFiles);
+	MIMEScanner::listConfigurationFiles(string(SHARED_MIME_INFO_PREFIX), mimeFiles);
+	for (set<string>::const_iterator fileIter = mimeFiles.begin();
+		fileIter != mimeFiles.end(); ++fileIter)
+	{
+		m_pSettingsMonitor->addLocation(*fileIter, false);
+	}
+	m_pSettingsHandler = new ReloadHandler();
+	MonitorThread *pSettingsMonitorThread = new MonitorThread(m_pSettingsMonitor, m_pSettingsHandler, false);
+	start_thread(pSettingsMonitorThread, true);
+
 	// Now we are ready
 	set_status(_("Ready"));
 	m_pNotebook->show();
@@ -206,6 +292,15 @@
 {
 	// FIXME: delete all "ignored" threads when exiting !!!
 
+	if (m_pSettingsMonitor != NULL)
+	{
+		delete m_pSettingsMonitor;
+	}
+	if (m_pSettingsHandler != NULL)
+	{
+		delete m_pSettingsHandler;
+	}
+
 	// Save engines
 	m_pEnginesTree->save();
 

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/mainWindow.hh	2007-09-21 16:41:09 UTC (rev 980)
@@ -37,6 +37,8 @@
 
 #include "DocumentInfo.h"
 #include "QueryProperties.h"
+#include "MonitorInterface.h"
+#include "MonitorHandler.h"
 #include "EnginesTree.h"
 #include "IndexPage.h"
 #include "ModelColumns.h"
@@ -164,6 +166,9 @@
 	SigC::Connection m_pageSwitchConnection;
 	// Activity timeout
 	SigC::Connection m_timeoutConnection;
+	// Monitoring
+	MonitorInterface *m_pSettingsMonitor;
+	MonitorHandler *m_pSettingsHandler;
 	// Internal state
 	class InternalState : public ThreadsManager
 	{

Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2007-09-21 16:41:09 UTC (rev 980)
@@ -313,8 +313,8 @@
 	}
 
 	// Initialize utility classes
-	if (MIMEScanner::initialize(PinotSettings::getHomeDirectory() + "/.local/share/applications/",
-		string(SHARED_MIME_INFO_PREFIX) + "/share/applications/") == false)
+	if (MIMEScanner::initialize(PinotSettings::getHomeDirectory() + "/.local",
+		string(SHARED_MIME_INFO_PREFIX)) == false)
 	{
 		cerr << "Couldn't load MIME settings" << endl;
 	}

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/UI/GTK2/src/pinot.cc	2007-09-21 16:41:09 UTC (rev 980)
@@ -238,8 +238,8 @@
 	}
 
 	// Initialize utility classes
-	if (MIMEScanner::initialize(PinotSettings::getHomeDirectory() + "/.local/share/applications/",
-		string(SHARED_MIME_INFO_PREFIX) + "/share/applications/") == false)
+	if (MIMEScanner::initialize(PinotSettings::getHomeDirectory() + "/.local",
+		string(SHARED_MIME_INFO_PREFIX)) == false)
 	{
 		cerr << "Couldn't load MIME settings" << endl;
 	}

Modified: trunk/Utils/MIMEScanner.cpp
===================================================================
--- trunk/Utils/MIMEScanner.cpp	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/Utils/MIMEScanner.cpp	2007-09-21 16:41:09 UTC (rev 980)
@@ -27,6 +27,7 @@
 #include "StringManip.h"
 #include "Url.h"
 
+#define APPLICATIONS_DIRECTORY	"/share/applications/"
 #define MIME_DEFAULTS_LIST	"defaults.list"
 #define MIME_DEFAULTS_SECTION	"Default Applications"
 #define MIME_CACHE		"mimeinfo.cache"
@@ -237,9 +238,6 @@
 	{
 		// Yes, it was so just copy it
 		m_defaultActions.insert(pair<string, MIMEAction>(mimeType, actionIter->second));
-#ifdef DEBUG
-		cout << "MIMECache::findDesktopFile: copied " << desktopFile << endl;
-#endif
 
 		return true;
 	}
@@ -368,9 +366,11 @@
 {
 }
 
-bool MIMEScanner::initialize(const string &userDirectory, const string &systemDirectory)
+bool MIMEScanner::initialize(const string &userPrefix, const string &systemPrefix)
 {
 	list<string> desktopFilesPaths;
+	string userDirectory(userPrefix + APPLICATIONS_DIRECTORY);
+	string systemDirectory(systemPrefix + APPLICATIONS_DIRECTORY);
 	bool foundActions = false;
 
 	// This may be a re-initialize
@@ -444,6 +444,15 @@
 	xdg_mime_shutdown();
 }
 
+void MIMEScanner::listConfigurationFiles(const string &prefix, set<string> &files)
+{
+	if (prefix.empty() == false)
+	{
+		files.insert(prefix + APPLICATIONS_DIRECTORY + MIME_DEFAULTS_LIST);
+		files.insert(prefix + APPLICATIONS_DIRECTORY + MIME_CACHE);
+	}
+}
+
 string MIMEScanner::scanFileType(const string &fileName)
 {
 	const char *pType = NULL;

Modified: trunk/Utils/MIMEScanner.h
===================================================================
--- trunk/Utils/MIMEScanner.h	2007-09-19 15:36:45 UTC (rev 979)
+++ trunk/Utils/MIMEScanner.h	2007-09-21 16:41:09 UTC (rev 980)
@@ -95,11 +95,14 @@
 		~MIMEScanner();
 
 		/// Initializes the MIME system.
-		static bool initialize(const std::string &userDirectory, const std::string &systemDirectory);
+		static bool initialize(const std::string &userPrefix, const std::string &systemPrefix);
   
 		/// Shutdowns the MIME system.
 		static void shutdown(void);
 
+		/// Lists MIME configuration files under the given prefix.
+		static void listConfigurationFiles(const std::string &prefix, std::set<std::string> &files);
+
 		/// Finds out the given file's MIME type.
 		static std::string scanFile(const std::string &fileName);
 



From fabricecolin at mail.berlios.de  Fri Sep 21 18:45:11 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 21 Sep 2007 18:45:11 +0200
Subject: [Pinot-svn] r981 - trunk/Utils
Message-ID: <200709211645.l8LGjBjY028111@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-21 18:45:10 +0200 (Fri, 21 Sep 2007)
New Revision: 981

Modified:
   trunk/Utils/StringManip.cpp
   trunk/Utils/StringManip.h
Log:
Methods replaceEntities() and removeCharacters() were moved elsewhere.


Modified: trunk/Utils/StringManip.cpp
===================================================================
--- trunk/Utils/StringManip.cpp	2007-09-21 16:41:09 UTC (rev 980)
+++ trunk/Utils/StringManip.cpp	2007-09-21 16:45:10 UTC (rev 981)
@@ -109,62 +109,6 @@
 	return fieldValue;
 }
 
-/// Replaces entities.
-string StringManip::replaceEntities(const string &str)
-{
-	// FIXME: replace all
-	static const char *escapedChars[] = { "quot", "amp", "lt", "gt", "nbsp", "eacute", "egrave", "agrave", "ccedil"};
-	static const char *unescapedChars[] = { "\"", "&", "<", ">", " ", "e", "e", "a", "c"};
-	static const unsigned int escapedCharsCount = 9;
-	string unescapedStr;
-	string::size_type startPos = 0;
-
-	string::size_type pos = str.find("&");
-	while (pos != string::npos)
-	{
-		unescapedStr += str.substr(startPos, pos - startPos);
-
-		startPos = pos + 1;
-		pos = str.find(";", startPos);
-		if ((pos != string::npos) &&
-			(pos < startPos + 10))
-		{
-			string escapedChar(str.substr(startPos, pos - startPos));
-			bool replacedChar = false;
-
-			// See if we can replace this with an actual character
-			for (unsigned int count = 0; count < escapedCharsCount; ++count)
-			{
-				if (escapedChar == escapedChars[count])
-				{
-					unescapedStr += unescapedChars[count];
-					replacedChar = true;
-					break;
-				}
-			}
-
-			if (replacedChar == false)
-			{
-				// This couldn't be replaced, leave it as it is...
-				unescapedStr += "&";
-				unescapedStr += escapedChar;
-				unescapedStr += ";";
-			}
-
-			startPos = pos + 1;
-		}
-
-		// Next
-		pos = str.find("&", startPos);
-	}
-	if (startPos < str.length())
-	{
-		unescapedStr  += str.substr(startPos);
-	}
-
-	return unescapedStr;
-}
-
 /// Replaces a sub-string.
 string StringManip::replaceSubString(const string &str, const std::string &substr, const std::string &rep)
 {
@@ -197,23 +141,6 @@
 	return cleanStr;
 }
 
-/// Removes characters from a string.
-unsigned int StringManip::removeCharacters(string &str, const string &characters)
-{
-	unsigned int count = 0;
-
-	string::size_type charPos = str.find_first_of(characters.c_str());
-	while (charPos != string::npos)
-	{
-		str.erase(charPos, 1);
-		++count;
-
-		charPos = str.find_first_of(characters.c_str(), charPos);
-	}
-
-	return count;	
-}
-
 /// Trims spaces at the start and end of a string.
 unsigned int StringManip::trimSpaces(string &str)
 {

Modified: trunk/Utils/StringManip.h
===================================================================
--- trunk/Utils/StringManip.h	2007-09-21 16:41:09 UTC (rev 980)
+++ trunk/Utils/StringManip.h	2007-09-21 16:45:10 UTC (rev 981)
@@ -36,16 +36,10 @@
 		static std::string extractField(const std::string &str, const std::string &start,
 			const std::string &end, std::string::size_type &endPos, bool anyCharacterOfEnd = false);
 
-		/// Replaces entities.
-		static std::string replaceEntities(const std::string &str);
-
 		/// Replaces a sub-string.
 		static std::string replaceSubString(const std::string &str, const std::string &substr,
 			const std::string &rep);
 
-		/// Removes characters from a string.
-		static unsigned int removeCharacters(std::string &str, const std::string &characters);
-
 		/// Removes double and single quotes.
 		static std::string removeQuotes(const std::string &str);
 



From fabricecolin at mail.berlios.de  Fri Sep 21 18:51:47 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Fri, 21 Sep 2007 18:51:47 +0200
Subject: [Pinot-svn] r982 - trunk
Message-ID: <200709211651.l8LGpl4t001750@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-21 18:51:46 +0200 (Fri, 21 Sep 2007)
New Revision: 982

Modified:
   trunk/TODO
Log:
Removed a bunch of stuff, added some more.


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2007-09-21 16:45:10 UTC (rev 981)
+++ trunk/TODO	2007-09-21 16:51:46 UTC (rev 982)
@@ -1,19 +1,17 @@
 Documentation
 - List what files from libtextcat 2.2 go where ?
+- Say where libtextcat 3.0 can (and cannot ;-) be found
 - MIME type should be as returned by xdg-utils' 'xdg-mime query filetype ...'
 - Try listing names of dependency packages for most distros
 - How to trouble-shoot with delve, get to a file with filters and labels
 - Explain when indexing and updating are done, eg in the results list, Index on
  a result already indexed doesn't update it
+- Document which query parameters apply to Web engines
 
 General
 - Fix the FIXMEs
 - Get rid of dead code/classes/methods...
 - Advertise service via Rendezvous
-- MIMEScanner should also return parent types so that we don't filter out types unnecessarily
-- Load desktop files from /usr/share/applications/kde ?
-- DBUS_API_SUBJECT_TO_CHANGE only needed for DBus < 1.0
-- Document which query parameters apply to Web engines
 - Extend metadata beyond title,location,language,type,timestamp,size
 - Sync with gtk+'s xdgmime
 - Build against Fedora's patched libtextcat
@@ -54,11 +52,11 @@
 - Make sure Description files' SyndicationRight is not private or closed
 - Get hold of stopwords lists for the languages supported by Xapian's stemmers
  and remove stopwords from queries as first step of search
-- If a Web query fails, get spelling suggestions from the MERGED database
-- Unify spelling suggestions, terms expansion and default-to-OR search as user feedback
 - Enable to search in results, either by combining queries or via a results set
 - The ext filter should apply to all engines
 - Google and maybe others support the site filter so don't remove it from queries
+- Isolate dependencies on Xapian so that it can eventually be moved into a .so
+- Filter on time
 
 Index
 - Play around with the XAPIAN_FLUSH_THRESHOLD env var
@@ -70,13 +68,11 @@
 - Index Nautilus metadata (http://linuxboxadmin.com/articles/nautilus.php)
 - Reverse terms so that left wildcards can be applied ?
 - XapianIndex could do with some common code refactoring
-- Xapian > 1.0 has a version of Xapian::Database::allterms_begin() that takes a prefix
-- With Xapian > 1.0.2, for date ranges, use QueryParser::add_valuerangeprocessor()
- NumberValueRangeProcessor and sortable_serialise()
 - Automatically categorize documents based on MIME type and source into picture, video, etc...
 - DBusXapianIndex to use D-Bus method Index
 - pinot-index to instantiate a DBusXapianIndex if dealing with the daemon index
 - After indexing or updating a document, a call to getDocumentInfo() shouldn't be necessary
+- Add a value for time
 
 Mail
 - Find out what kind of locking scheme Mozilla uses (POSIX lock ?) and use that
@@ -98,10 +94,10 @@
 - Labels should be managed by the daemon, and not saved to the configuration file
 - DBus SetDocument[s]Labels should create labels if necessary
 - Reintroduce Index method in D-Bus interface
+- Export term suggestion over D-Bus
 - There's currently no way to get a document's ID without running a search
 - Follow updates to Xesam specs
 - Enable to deactivate D-Bus interface
-- Force full scans on Reload ?
 
 UI
 - When sorting results by host name, give better score to results that appear
@@ -118,7 +114,6 @@
 - When viewing a result, all rows for that same URL should be updated with the
  Viewed icon
 - Set results' indexed status after IndexingThread returns
-- Show date ranges in queries summary
 - Make use of GTKmm 2.10 StatusIcon
 - Query expansion should be interactive
 - UI doesn't show documents indexed by the daemon the very first time it's run,
@@ -128,10 +123,10 @@
 - Show whether Pinot was built with boost Spirit and how many plugins of each
  type there are
 - Delete all temporary files when exiting
-- Add less than, equal to, greater than filters on size for stored queries
 - Show which stored queries are fully, partially or not at all Web friendly
 - List viewed URLs
-- Unify ExpandQuery and Querying threads !
-- Suggest links from previous results when importing, as done for terms
 - Let queries index only new results
+- Show a query's latest results, as cached in the history database
+- Query correction should be optional
+- Default cache provider should be configurable
 



From fabricecolin at mail.berlios.de  Sun Sep 23 12:22:51 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 23 Sep 2007 12:22:51 +0200
Subject: [Pinot-svn] r983 - trunk/UI/GTK2/src
Message-ID: <200709231022.l8NAMppY007114@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-23 12:22:50 +0200 (Sun, 23 Sep 2007)
New Revision: 983

Modified:
   trunk/UI/GTK2/src/mainWindow.cc
Log:
Better check whether we actually obtained a Monitor.


Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-21 16:51:46 UTC (rev 982)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-23 10:22:50 UTC (rev 983)
@@ -259,18 +259,24 @@
 	// Connect to threads' finished signal
 	m_state.connect();
 
-	// Monitor MIME settings files for changes in the background
-	set<string> mimeFiles;
-	MIMEScanner::listConfigurationFiles(PinotSettings::getHomeDirectory() + "/.local", mimeFiles);
-	MIMEScanner::listConfigurationFiles(string(SHARED_MIME_INFO_PREFIX), mimeFiles);
-	for (set<string>::const_iterator fileIter = mimeFiles.begin();
-		fileIter != mimeFiles.end(); ++fileIter)
+	if (m_pSettingsMonitor != NULL)
 	{
-		m_pSettingsMonitor->addLocation(*fileIter, false);
+		set<string> mimeFiles;
+
+		// Monitor MIME settings files for changes
+		MIMEScanner::listConfigurationFiles(PinotSettings::getHomeDirectory() + "/.local", mimeFiles);
+		MIMEScanner::listConfigurationFiles(string(SHARED_MIME_INFO_PREFIX), mimeFiles);
+		for (set<string>::const_iterator fileIter = mimeFiles.begin();
+			fileIter != mimeFiles.end(); ++fileIter)
+		{
+			m_pSettingsMonitor->addLocation(*fileIter, false);
+		}
+
+		// Run this in the background
+		m_pSettingsHandler = new ReloadHandler();
+		MonitorThread *pSettingsMonitorThread = new MonitorThread(m_pSettingsMonitor, m_pSettingsHandler, false);
+		start_thread(pSettingsMonitorThread, true);
 	}
-	m_pSettingsHandler = new ReloadHandler();
-	MonitorThread *pSettingsMonitorThread = new MonitorThread(m_pSettingsMonitor, m_pSettingsHandler, false);
-	start_thread(pSettingsMonitorThread, true);
 
 	// Now we are ready
 	set_status(_("Ready"));



From fabricecolin at mail.berlios.de  Sun Sep 23 12:30:34 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 23 Sep 2007 12:30:34 +0200
Subject: [Pinot-svn] r984 - in trunk: Index Search UI/GTK2 UI/GTK2/src Utils
Message-ID: <200709231030.l8NAUYH2009773@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-23 12:30:25 +0200 (Sun, 23 Sep 2007)
New Revision: 984

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/Search/XapianEngine.cpp
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/queryDialog.cc
   trunk/UI/GTK2/src/queryDialog_glade.cc
   trunk/Utils/TimeConverter.cpp
   trunk/Utils/TimeConverter.h
Log:
Support for time ranges (value 3). Tweaked the query properties dialog.
In XapianEngine, get Enquire::get_mset() to check at least maxResultsCount + 1
so that the total results estimate is determined correctly if between 0 to
maxResultsCount.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2007-09-23 10:22:50 UTC (rev 983)
+++ trunk/Index/XapianIndex.cpp	2007-09-23 10:30:25 UTC (rev 984)
@@ -608,12 +608,15 @@
 	time_t timeT = TimeConverter::fromTimestamp(info.getTimestamp());
 	struct tm *tm = localtime(&timeT);
 	string yyyymmdd(TimeConverter::toYYYYMMDDString(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday));
+	string hhmmss(TimeConverter::toHHMMSSString(tm->tm_hour, tm->tm_min, tm->tm_sec));
 
 	// Add this value to allow sorting by date
 	doc.add_value(0, yyyymmdd);
 	// FIXME: checksum in value 1
 	// Size goes in value 2
 	doc.add_value(2, Xapian::sortable_serialise((double )info.getSize()));
+	// Time goes in value 3
+	doc.add_value(3, hhmmss);
 
 	DocumentInfo docCopy(info);
 	docCopy.setLanguage(language);

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2007-09-23 10:22:50 UTC (rev 983)
+++ trunk/Search/XapianEngine.cpp	2007-09-23 10:30:25 UTC (rev 984)
@@ -45,21 +45,6 @@
 using std::inserter;
 using namespace Dijon;
 
-// The following function was lifted from Xapian's xapian-applications/omega/date.cc
-// where it's called last_day(), and prettified slightly
-static int lastDay(int year, int month)
-{
-	static const int lastDays[13] = { 0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 };
-
-	if (month != 2)
-	{
-		return lastDays[month];
-	}
-
-	// Good until 2100
-	return 28 + (year % 4 == 0);
-}
-
 static void checkFilter(const string &freeQuery, string::size_type filterValueStart,
 	bool &escapeValue, bool &hashValue)
 {
@@ -94,6 +79,48 @@
 	}
 }
 
+class TimeValueRangeProcessor : public Xapian::ValueRangeProcessor
+{
+	public:
+		TimeValueRangeProcessor(Xapian::valueno valno) : Xapian::ValueRangeProcessor(), m_valueNumber(valno) { }
+
+		Xapian::valueno operator()(string &begin, string &end)
+		{
+			if ((begin.size() == 6) &&
+					(end.size() == 6))
+			{
+				// HHMMSS
+#ifdef DEBUG
+				cout << "TimeValueRangeProcessor::operator: accepting " << begin << ".." << end << endl;
+#endif
+				return m_valueNumber;
+			}
+			if ((begin.size() == 8) && (end.size() == 8) &&
+					(begin[2] == begin[5]) && (end[2] == end[5]) && (begin[2] == end[2]) &&
+					(end[4] == ':'))
+			{
+				// HH:MM:SS
+				begin.erase(2, 1);
+				begin.erase(5, 1);
+				end.erase(2, 1);
+				end.erase(5, 1);
+#ifdef DEBUG
+				cout << "TimeValueRangeProcessor::operator: accepting " << begin << ".." << end << endl;
+#endif
+				return m_valueNumber;
+			}
+#ifdef DEBUG
+			cout << "TimeValueRangeProcessor::operator: rejecting " << begin << ".." << end << endl;
+#endif
+
+			return Xapian::BAD_VALUENO;
+		}
+
+	protected:
+		Xapian::valueno m_valueNumber;
+
+};
+
 XapianEngine::XapianEngine(const string &database) :
 	SearchEngineInterface()
 {
@@ -287,6 +314,10 @@
 	parser.add_valuerangeprocessor(&sizeProcessor);
 #endif
 
+	// Time range
+	TimeValueRangeProcessor timeProcessor(3);
+	parser.add_valuerangeprocessor(&timeProcessor);
+
 	// Parse the query string
 	Xapian::Query parsedQuery = parser.parse_query(freeQuery, flags);
 	if (minimal == true)
@@ -364,7 +395,7 @@
 		enquire.set_query(query);
 
 		// Get the top results of the query
-		Xapian::MSet matches = enquire.get_mset(startDoc, maxResultsCount);
+		Xapian::MSet matches = enquire.get_mset(startDoc, maxResultsCount, maxResultsCount + 1);
 		if (matches.empty() == false)
 		{
 			m_resultsCountEstimate = matches.get_matches_estimated();

Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2007-09-23 10:22:50 UTC (rev 983)
+++ trunk/UI/GTK2/metase-gtk2.glade	2007-09-23 10:30:25 UTC (rev 984)
@@ -2384,7 +2384,7 @@
 	      <child>
 		<widget class="GtkLabel" id="filterLabel">
 		  <property name="visible">True</property>
-		  <property name="label" translatable="yes">New filter:</property>
+		  <property name="label" translatable="yes">New filter or range:</property>
 		  <property name="use_underline">False</property>
 		  <property name="use_markup">False</property>
 		  <property name="justify">GTK_JUSTIFY_LEFT</property>

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2007-09-23 10:22:50 UTC (rev 983)
+++ trunk/UI/GTK2/src/queryDialog.cc	2007-09-23 10:30:25 UTC (rev 984)
@@ -79,7 +79,7 @@
 
 		// FIXME: this is extremely hacky !
 		if ((sscanf(rowPath.c_str(), "%u", &rowPos) == 1) &&
-			(rowPos == 2))
+			((rowPos == 2) || (rowPos == 10)))
 		{
 			return true;
 		}
@@ -122,7 +122,10 @@
 	filterCombobox->append_text(_("Language code"));
 	filterCombobox->append_text(_("MIME type"));
 	filterCombobox->append_text(_("Label"));
-	filterCombobox->append_text(_("Date range"));
+	// And separate numerical ranges
+	filterCombobox->append_text("===");
+	filterCombobox->append_text(_("Date"));
+	filterCombobox->append_text(_("Time"));
 	filterCombobox->append_text(_("Size"));
 	filterCombobox->set_active(0);
 }
@@ -231,11 +234,19 @@
 			filter = "label";
 			break;
 		case 10:
+			// Separator
+			break;
+		case 11:
 			filter = TimeConverter::toYYYYMMDDString(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday);
 			filter += "..20991231";
 			hasValue = false;
 			break;
-		case 11:
+		case 12:
+			filter = TimeConverter::toHHMMSSString(tm->tm_hour, tm->tm_min, tm->tm_sec);
+			filter += "..235959";
+			hasValue = false;
+			break;
+		case 13:
 			filter += "0..10240b";
 			hasValue = false;
 			break;

Modified: trunk/UI/GTK2/src/queryDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog_glade.cc	2007-09-23 10:22:50 UTC (rev 983)
+++ trunk/UI/GTK2/src/queryDialog_glade.cc	2007-09-23 10:30:25 UTC (rev 984)
@@ -69,7 +69,7 @@
    nameEntry = Gtk::manage(new class Gtk::Entry());
    
    Gtk::Table *nameTable = Gtk::manage(new class Gtk::Table(2, 2, false));
-   Gtk::Label *filterLabel = Gtk::manage(new class Gtk::Label(_("New filter:")));
+   Gtk::Label *filterLabel = Gtk::manage(new class Gtk::Label(_("New filter or range:")));
    filterCombobox = Gtk::manage(new class Gtk::ComboBoxText());
    
    Gtk::Button *addFilterButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-add")));

Modified: trunk/Utils/TimeConverter.cpp
===================================================================
--- trunk/Utils/TimeConverter.cpp	2007-09-23 10:22:50 UTC (rev 983)
+++ trunk/Utils/TimeConverter.cpp	2007-09-23 10:30:25 UTC (rev 984)
@@ -243,7 +243,7 @@
 /// Converts to a YYYYMMDD-formatted string.
 string TimeConverter::toYYYYMMDDString(int year, int month, int day)
 {
-	char timeStr[64];
+	char dateStr[64];
 
 	if (year < 0)
 	{
@@ -270,9 +270,9 @@
 		day = 31;
 	}
 
-	if (snprintf(timeStr, 63, "%04d%02d%02d", year, month, day) > 0)
+	if (snprintf(dateStr, 63, "%04d%02d%02d", year, month, day) > 0)
 	{
-		return timeStr;
+		return dateStr;
 	}
 
 	return "";
@@ -304,3 +304,67 @@
 	return gmTime;
 }
 
+/// Converts to a HHMMSS-formatted string.
+string TimeConverter::toHHMMSSString(int hours, int minutes, int seconds)
+{
+	char timeStr[64];
+
+	if (hours < 0)
+	{
+		hours = 0;
+	}
+	else if (hours > 23)
+	{
+		hours = 23;
+	}
+	if (minutes < 0)
+	{
+		minutes = 0;
+	}
+	else if (minutes > 59)
+	{
+		minutes = 59;
+	}
+	if (seconds < 0)
+	{
+		seconds = 0;
+	}
+	else if (seconds > 59)
+	{
+		seconds = 59;
+	}
+
+	if (snprintf(timeStr, 63, "%02d%02d%02d", hours, minutes, seconds) > 0)
+	{
+		return timeStr;
+	}
+
+	return "";
+}
+
+/// Converts from a HHMMSS-formatted string.
+time_t TimeConverter::fromHHMMSSString(const string &hhmmss, bool inGMTime)
+{
+	struct tm timeTm;
+	time_t gmTime = 0;
+
+	// Initialize the structure
+	timeTm.tm_sec = timeTm.tm_min = timeTm.tm_hour = timeTm.tm_mday = 0;
+	timeTm.tm_mon = timeTm.tm_year = timeTm.tm_wday = timeTm.tm_yday = timeTm.tm_isdst = 0;
+
+	strptime(hhmmss.c_str(), "%H%M%S", &timeTm);
+#ifdef DEBUG
+	cout << "TimeConverter::fromHHMMSSString: " << timeTm.tm_hour << " " << timeTm.tm_min << " " << timeTm.tm_sec << endl;
+#endif
+	if (inGMTime == true)
+	{
+		gmTime = timegm(&timeTm);
+	}
+	else
+	{
+		gmTime = mktime(&timeTm);
+	}
+
+	return gmTime;
+}
+

Modified: trunk/Utils/TimeConverter.h
===================================================================
--- trunk/Utils/TimeConverter.h	2007-09-23 10:22:50 UTC (rev 983)
+++ trunk/Utils/TimeConverter.h	2007-09-23 10:30:25 UTC (rev 984)
@@ -37,6 +37,12 @@
 		/// Converts from a YYYYMMDD-formatted string.
 		static time_t fromYYYYMMDDString(const std::string &yyyymmdd, bool inGMTime = false);
 
+		/// Converts to a HHMMSS-formatted string.
+		static std::string toHHMMSSString(int hours, int minutes, int seconds);
+
+		/// Converts from a HHMMSS-formatted string.
+		static time_t fromHHMMSSString(const std::string &hhmmss, bool inGMTime = false);
+
 	protected:
 		TimeConverter();
 



From fabricecolin at mail.berlios.de  Sun Sep 23 13:19:41 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 23 Sep 2007 13:19:41 +0200
Subject: [Pinot-svn] r985 - in trunk: Search Search/Google Tokenize
	UI/GTK2/src
Message-ID: <200709231119.l8NBJfgj027450@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-23 13:19:37 +0200 (Sun, 23 Sep 2007)
New Revision: 985

Modified:
   trunk/Search/Google/GoogleAPIEngine.cpp
   trunk/Search/PluginWebEngine.cpp
   trunk/Search/QueryProperties.cpp
   trunk/Search/QueryProperties.h
   trunk/Search/WebEngine.cpp
   trunk/Search/WebEngine.h
   trunk/Search/XapianEngine.cpp
   trunk/Tokenize/Tokenizer.cpp
   trunk/Tokenize/Tokenizer.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
Log:
Don't bother extracting host and file filters from queries and applying them to
Web results. A better way to do it would be to pass them directly to the Web
engine, as most of them supports those filters natively. Hopefully, this will
be implemented soon-ish.


Modified: trunk/Search/Google/GoogleAPIEngine.cpp
===================================================================
--- trunk/Search/Google/GoogleAPIEngine.cpp	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/Search/Google/GoogleAPIEngine.cpp	2007-09-23 11:19:37 UTC (rev 985)
@@ -97,8 +97,6 @@
 		return false;
 	}
 
-	setHostNameFilter(queryProps.getHostFilter());
-	setFileNameFilter(queryProps.getFileFilter());
 	setQuery(queryProps);
 
 	if (m_key.empty() == true)

Modified: trunk/Search/PluginWebEngine.cpp
===================================================================
--- trunk/Search/PluginWebEngine.cpp	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/Search/PluginWebEngine.cpp	2007-09-23 11:19:37 UTC (rev 985)
@@ -256,8 +256,6 @@
 		formattedQuery += m_properties.m_parametersRemainder;
 	}
 
-	setHostNameFilter(queryProps.getHostFilter());
-	setFileNameFilter(queryProps.getFileFilter());
 	setQuery(queryProps);
 
 #ifdef DEBUG

Modified: trunk/Search/QueryProperties.cpp
===================================================================
--- trunk/Search/QueryProperties.cpp	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/Search/QueryProperties.cpp	2007-09-23 11:19:37 UTC (rev 985)
@@ -23,7 +23,6 @@
 #include <utility>
 
 #include "Tokenizer.h"
-#include "XapianEngine.h"
 #include "QueryProperties.h"
 
 QueryProperties::QueryProperties() :
@@ -49,9 +48,6 @@
 	m_type(other.m_type),
 	m_freeQuery(other.m_freeQuery),
 	m_freeQueryWithoutFilters(other.m_freeQueryWithoutFilters),
-	m_language(other.m_language),
-	m_hostFilter(other.m_hostFilter),
-	m_fileFilter(other.m_fileFilter),
 	m_resultsCount(other.m_resultsCount),
 	m_indexResults(other.m_indexResults),
 	m_labelName(other.m_labelName)
@@ -70,9 +66,6 @@
 		m_type = other.m_type;
 		m_freeQuery = other.m_freeQuery;
 		m_freeQueryWithoutFilters = other.m_freeQueryWithoutFilters;
-		m_language = other.m_language;
-		m_hostFilter = other.m_hostFilter;
-		m_fileFilter = other.m_fileFilter;
 		m_resultsCount = other.m_resultsCount;
 		m_indexResults = other.m_indexResults;
 		m_labelName = other.m_labelName;
@@ -104,9 +97,6 @@
 void QueryProperties::removeFilters(void)
 {
 	m_freeQueryWithoutFilters.clear();
-	m_language.clear();
-	m_hostFilter.clear();
-	m_fileFilter.clear();
 
 	if (m_freeQuery.empty() == true)
 	{
@@ -116,50 +106,29 @@
 	if (m_type != XAPIAN_QP)
 	{
 		m_freeQueryWithoutFilters = m_freeQuery.substr(0, min(20, (int)m_freeQuery.length()));
+		return;
 	}
 
-	vector<string> terms;
-	if (XapianEngine::validateQuery(*this, true, terms) == true)
+	Document doc;
+
+	doc.setData(m_freeQuery.c_str(), m_freeQuery.length());
+	Tokenizer tokens(&doc);
+
+	string token;
+	while (tokens.nextToken(token) == true)
 	{
-		for (vector<string>::const_iterator termIter = terms.begin();
-			termIter != terms.end(); ++termIter)
+		if ((token.find(':') != string::npos) ||
+			(token.find("..") != string::npos))
 		{
-			string term(*termIter);
+			// It's a filter or a range
+			continue;
+		}
 
-			if (term.empty() == true)
-			{
-				continue;
-			}
-
-			// Is this a prefixed term ?
-			// The query shouldn't have the same filter twice
-			if (isupper((int)((*termIter)[0])) == 0)
-			{
-				// FIXME: operators have been lost !
-				if (m_freeQueryWithoutFilters.empty() == false)
-				{
-					m_freeQueryWithoutFilters += " ";
-				}
-				m_freeQueryWithoutFilters += term;
-			}
-			else
-			{
-				switch (term[0])
-				{
-					case 'L':
-						m_language = term.substr(1);
-						break;
-					case 'H':
-						m_hostFilter = term.substr(1);
-						break;
-					case 'P':
-						m_fileFilter = term.substr(1);
-						break;
-					default:
-						break;
-				}
-			}
+		if (m_freeQueryWithoutFilters.empty() == false)
+		{
+			m_freeQueryWithoutFilters += " ";
 		}
+		m_freeQueryWithoutFilters += token;
 	}
 }
 
@@ -209,21 +178,37 @@
 }
 
 /// Gets the query's language.
-string QueryProperties::getLanguage(void) const
+string QueryProperties::getFilter(const string &filterStr)
 {
-	return m_language;
-}
+	if ((m_freeQuery.empty() == true) ||
+		(filterStr.empty() == true))
+	{
+		return "";
+	}
 
-/// Gets the query's host filter.
-string QueryProperties::getHostFilter(void) const
-{
-	return m_hostFilter;
-}
+	Document doc;
 
-/// Gets the query's file filter.
-string QueryProperties::getFileFilter(void) const
-{
-	return m_fileFilter;
+	doc.setData(m_freeQuery.c_str(), m_freeQuery.length());
+	Tokenizer tokens(&doc, true);
+
+	string token;
+	while (tokens.nextToken(token) == true)
+	{
+		string::size_type langPos = token.find(filterStr + ":");
+
+		// Is it the language filter ?
+		if (langPos != string::npos)
+		{
+			string filterValue(token.substr(langPos + filterStr.length() + 1));
+
+#ifdef DEBUG
+			cout << "QueryProperties::getFilter: " << filterStr << "=" << filterValue << endl;
+#endif
+			return filterValue;
+		}
+	}
+
+	return "";
 }
 
 /// Sets the maximum number of results.

Modified: trunk/Search/QueryProperties.h
===================================================================
--- trunk/Search/QueryProperties.h	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/Search/QueryProperties.h	2007-09-23 11:19:37 UTC (rev 985)
@@ -55,15 +55,9 @@
 		/// Gets the query string.
 		string getFreeQuery(bool withoutFilters = false) const;
 
-		/// Gets the query's language.
-		string getLanguage(void) const;
+		/// Gets the value of a specific filter.
+		string getFilter(const string &filterStr);
 
-		/// Gets the query's host filter.
-		string getHostFilter(void) const;
-
-		/// Gets the query's file filter.
-		string getFileFilter(void) const;
-
 		/// Sets the maximum number of results.
 		void setMaximumResultsCount(unsigned int count);
 		/// Gets the maximum number of results.
@@ -90,9 +84,6 @@
 		QueryType m_type;
 		string m_freeQuery;
 		string m_freeQueryWithoutFilters;
-		string m_language;
-		string m_hostFilter;
-		string m_fileFilter;
 		unsigned int m_resultsCount;
 		bool m_indexResults;
 		string m_labelName;

Modified: trunk/Search/WebEngine.cpp
===================================================================
--- trunk/Search/WebEngine.cpp	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/Search/WebEngine.cpp	2007-09-23 11:19:37 UTC (rev 985)
@@ -95,16 +95,6 @@
 	return pDoc;
 }
 
-void WebEngine::setHostNameFilter(const string &filter)
-{
-	m_hostFilter = filter;
-}
-
-void WebEngine::setFileNameFilter(const string &filter)
-{
-	m_fileFilter = filter;
-}
-
 void WebEngine::setQuery(const QueryProperties &queryProps)
 {
 	queryProps.getTerms(m_queryTerms);
@@ -144,24 +134,6 @@
 
 	Url resultUrlObj(resultUrl);
 
-	if ((m_hostFilter.empty() == false) &&
-		(resultUrlObj.getHost() != m_hostFilter))
-	{
-#ifdef DEBUG
-		cout << "WebEngine::processResult: skipping " << resultUrl << endl;
-#endif
-		return false;
-	}
-
-	if ((m_fileFilter.empty() == false) &&
-		(resultUrlObj.getFile() != m_fileFilter))
-	{
-#ifdef DEBUG
-		cout << "WebEngine::processResult: skipping " << resultUrl << endl;
-#endif
-		return false;
-	}
-
 	// Is the result's host name the same as the search engine's ?
 	// FIXME: not all TLDs have leafs at level 2
 	if (queryHost == Url::reduceHost(resultUrlObj.getHost(), 2))

Modified: trunk/Search/WebEngine.h
===================================================================
--- trunk/Search/WebEngine.h	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/Search/WebEngine.h	2007-09-23 11:19:37 UTC (rev 985)
@@ -38,8 +38,6 @@
 
 	protected:
 		DownloaderInterface *m_pDownloader;
-		std::string m_hostFilter;
-		std::string m_fileFilter;
 		std::set<std::string> m_queryTerms;
 
 		Document *downloadPage(const DocumentInfo &docInfo);

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/Search/XapianEngine.cpp	2007-09-23 11:19:37 UTC (rev 985)
@@ -336,43 +336,6 @@
 	return parsedQuery;
 }
 
-/// Validates a query and extracts its terms.
-bool XapianEngine::validateQuery(QueryProperties& queryProps, bool includePrefixed,
-	vector<string> &terms)
-{
-	bool goodQuery = false;
-
-	try
-	{
-		string correctedSpelling;
-		// Do minimal parsing
-		Xapian::Query fullQuery = parseQuery(NULL, queryProps, "",
-			DEFAULT_OP_AND, correctedSpelling, true);
-
-		if (fullQuery.empty() == false)
-		{
-			for (Xapian::TermIterator termIter = fullQuery.get_terms_begin();
-				termIter != fullQuery.get_terms_end(); ++termIter)
-			{
-				// Skip prefixed terms unless instructed otherwise
-				if ((includePrefixed == true) ||
-					(isupper((int)((*termIter)[0])) == 0))
-				{
-					terms.push_back(*termIter);
-				}
-			}
-
-			goodQuery = true;
-		}
-	}
-	catch (const Xapian::Error &error)
-	{
-		cerr << "XapianEngine::validateQuery: " << error.get_type() << ": " << error.get_msg() << endl;
-	}
-
-	return goodQuery;
-}
-
 bool XapianEngine::queryDatabase(Xapian::Database *pIndex, Xapian::Query &query,
 	unsigned int startDoc, unsigned int maxResultsCount)
 {
@@ -535,7 +498,7 @@
 	Xapian::Database *pIndex = pDatabase->readLock();
 	try
 	{
-		string stemLanguage(queryProps.getLanguage());
+		string stemLanguage(queryProps.getFilter("lang"));
 		unsigned int searchStep = 1;
 
 		// Searches are run in this order :

Modified: trunk/Tokenize/Tokenizer.cpp
===================================================================
--- trunk/Tokenize/Tokenizer.cpp	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/Tokenize/Tokenizer.cpp	2007-09-23 11:19:37 UTC (rev 985)
@@ -32,7 +32,10 @@
 using std::endl;
 using std::string;
 
-Tokenizer::Tokenizer(const Document *pDocument)
+Tokenizer::Tokenizer(const Document *pDocument, bool splitOnSpaces) :
+	m_pDocument(NULL),
+	m_splitOnSpaces(splitOnSpaces),
+	m_currentPos(0)
 {
 	setDocument(pDocument);
 	rewind();
@@ -92,7 +95,8 @@
 #endif
 	while (pos < dataLength)
 	{
-		if (isalnum(pData[pos]) != 0)
+		if (((m_splitOnSpaces == false) && (isalnum(pData[pos]) != 0)) ||
+			((m_splitOnSpaces == true) && (isspace(pData[pos]) == 0)))
 		{
 			if (bStarted == false)
 			{

Modified: trunk/Tokenize/Tokenizer.h
===================================================================
--- trunk/Tokenize/Tokenizer.h	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/Tokenize/Tokenizer.h	2007-09-23 11:19:37 UTC (rev 985)
@@ -29,7 +29,8 @@
 class Tokenizer
 {
 	public:
-		Tokenizer(const Document *pDocument);
+		Tokenizer(const Document *pDocument,
+			bool splitOnSpaces = false);
 		virtual ~Tokenizer();
 
 		/// Returns a pointer to the document being tokenized.
@@ -43,6 +44,7 @@
 
 	protected:
 		const Document *m_pDocument;
+		bool m_splitOnSpaces;
 		unsigned int m_currentPos;
 
 		void setDocument(const Document *pDocument);

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-23 10:30:25 UTC (rev 984)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-23 11:19:37 UTC (rev 985)
@@ -840,18 +840,18 @@
 	for (vector<DocumentInfo>::const_iterator resultIter = resultsList.begin();
 		resultIter != resultsList.end(); ++resultIter)
 	{
-		DocumentInfo current(*resultIter);
+		DocumentInfo currentDoc(*resultIter);
 		string title(_("No title"));
-		string location(current.getLocation());
-		string language(current.getLanguage());
+		string location(currentDoc.getLocation());
+		string language(currentDoc.getLanguage());
 		unsigned int docId = 0;
 
 		// The title may contain formatting
-		if (current.getTitle().empty() == false)
+		if (currentDoc.getTitle().empty() == false)
 		{
-			title = FilterUtils::stripMarkup(current.getTitle());
+			title = FilterUtils::stripMarkup(currentDoc.getTitle());
 		}
-		current.setTitle(title);
+		currentDoc.setTitle(title);
 #ifdef DEBUG
 		cout << "QueryingThread::processResults: title is " << title << endl;
 #endif
@@ -859,16 +859,16 @@
 		// Use the query's language if the result's is unknown
 		if (language.empty() == true)
 		{
-			language = m_queryProps.getLanguage();
+			language = m_queryProps.getFilter("lang");
 		}
-		current.setLanguage(language);
+		currentDoc.setLanguage(language);
 
 		if (isIndexQuery == true)
 		{
 			unsigned int tmpId = 0;
 
 			// The index engine should have set this
-			docId = current.getIsIndexed(tmpId);
+			docId = currentDoc.getIsIndexed(tmpId);
 		}
 
 		// Is this in one of the indexes ?
@@ -894,7 +894,7 @@
 
 		if (docId > 0)
 		{
-			current.setIsIndexed(indexId, docId);
+			currentDoc.setIsIndexed(indexId, docId);
 #ifdef DEBUG
 			cout << "QueryingThread::processResults: found in index " << indexId << endl;
 #endif
@@ -903,7 +903,7 @@
 		else cout << "QueryingThread::processResults: not found in any index" << endl;
 #endif
 
-		m_documentsList.push_back(current);
+		m_documentsList.push_back(currentDoc);
 	}
 
 	if (pDocsIndex != NULL)
@@ -925,13 +925,13 @@
 	for (vector<DocumentInfo>::const_iterator resultIter = resultsList.begin();
 		resultIter != resultsList.end(); ++resultIter)
 	{
-		DocumentInfo current(*resultIter);
+		DocumentInfo currentDoc(*resultIter);
 
 		// The engine has no notion of index IDs
-		unsigned int docId = current.getIsIndexed(zeroId);
-		current.setIsIndexed(indexId, docId);
+		unsigned int docId = currentDoc.getIsIndexed(zeroId);
+		currentDoc.setIsIndexed(indexId, docId);
 
-		m_documentsList.push_back(current);
+		m_documentsList.push_back(currentDoc);
 	}
 }
 



From fabricecolin at mail.berlios.de  Sun Sep 23 13:33:08 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 23 Sep 2007 13:33:08 +0200
Subject: [Pinot-svn] r986 - trunk/Search
Message-ID: <200709231133.l8NBX89l027863@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-23 13:33:08 +0200 (Sun, 23 Sep 2007)
New Revision: 986

Modified:
   trunk/Search/XapianEngine.h
Log:
Previous commit should have included this file too.


Modified: trunk/Search/XapianEngine.h
===================================================================
--- trunk/Search/XapianEngine.h	2007-09-23 11:19:37 UTC (rev 985)
+++ trunk/Search/XapianEngine.h	2007-09-23 11:33:08 UTC (rev 986)
@@ -50,10 +50,6 @@
 		XapianEngine(const std::string &database);
 		virtual ~XapianEngine();
 
-		/// Validates a query and extracts its terms.
-		static bool validateQuery(QueryProperties& queryProps, bool includePrefixed,
-			std::vector<std::string> &terms);
-
 		/// Sets whether the query should be expanded.
 		bool setQueryExpansion(std::set<unsigned int> &relevantDocuments);
 



From fabricecolin at mail.berlios.de  Sun Sep 23 16:27:17 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 23 Sep 2007 16:27:17 +0200
Subject: [Pinot-svn] r987 - trunk/po
Message-ID: <200709231427.l8NERHes005552@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-23 16:26:50 +0200 (Sun, 23 Sep 2007)
New Revision: 987

Modified:
   trunk/po/de.po
   trunk/po/es.po
   trunk/po/fr.po
   trunk/po/it.po
   trunk/po/nl.po
   trunk/po/pt.po
   trunk/po/pt_BR.po
   trunk/po/ru.po
   trunk/po/sv.po
   trunk/po/zh_TW.po
Log:
Synced with Rosetta. This includes updates to es.po by Jesus Tramullas, and
to de.po by Andreas Meyer.


Modified: trunk/po/de.po
===================================================================
--- trunk/po/de.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/de.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -2,19 +2,19 @@
 # Copyright (c) 2006 Rosetta Contributors and Canonical Ltd 2006
 # This file is distributed under the same license as the pinot package.
 #
-#, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.75\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
-"PO-Revision-Date: 2007-06-21 19:51+0800\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
+"PO-Revision-Date: 2007-09-10 12:48+0000\n"
 "Last-Translator: Christian Dywan <christian at twotoasts.de>\n"
 "Language-Team: German <de at li.org>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:32+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -24,36 +24,28 @@
 msgid "Current User"
 msgstr "Aktueller Benutzer"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "Meine Webseiten"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "Meine Dokumente"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-msgid "Date"
-msgstr "Datum"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr ""
@@ -88,15 +80,15 @@
 
 #: UI/GTK2/src/indexDialog_glade.cc:79 UI/GTK2/src/prefsDialog_glade.cc:82
 msgid "Address:"
-msgstr ""
+msgstr "Adresse"
 
 #: UI/GTK2/src/indexDialog_glade.cc:183
 msgid "External index"
 msgstr "Externer Index"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
-msgstr ""
+msgstr "Keine"
 
 #: UI/GTK2/src/importDialog_glade.cc:68
 #: UI/GTK2/src/propertiesDialog_glade.cc:67
@@ -125,7 +117,7 @@
 
 #: UI/GTK2/src/IndexPage.cpp:189
 msgid "All"
-msgstr ""
+msgstr "Alles"
 
 #: UI/GTK2/src/launcherDialog_glade.cc:64
 msgid ""
@@ -137,226 +129,232 @@
 
 #: UI/GTK2/src/launcherDialog_glade.cc:67
 msgid "Use this command for other documents of the same type."
-msgstr ""
+msgstr "Verwende diesen Befehl f?r weitere Dokumente des selben Typs."
 
 #: UI/GTK2/src/launcherDialog_glade.cc:99
 #, fuzzy
 msgid "Helper application"
 msgstr "Hilfsprogramm"
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
-msgstr ""
+msgstr "Zuletzt ausgef?hrt"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
-msgstr ""
+msgstr "?bersicht"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "Alle Suchmaschinen anzeigen"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "Index hinzuf?gen"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "Index entfernen"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
 msgstr "Bereit"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr "N/V"
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 msgid "Undefined"
 msgstr "Unbestimmt"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr ""
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 #, fuzzy
 msgid "Showing"
-msgstr "Zeige"
+msgstr "Zeigen"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr ""
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "Dokument aktualisiert"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "Indiziert"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "Nicht indizierte(s) Dokument(e)"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
-msgstr ""
+msgstr "Aktualisierte Dokumenteneigenschaften"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 #, fuzzy
 msgid "is already in use"
 msgstr "wird bereits benutzt"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "Index konnte nicht umbenannt werden"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1715
+#: UI/GTK2/src/mainWindow.cc:1853
 #, fuzzy
 msgid "Export Results"
-msgstr "Ergebnisse"
+msgstr "Ergebnisse exportieren"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
-msgstr ""
+msgstr "Index"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
-msgstr ""
+msgstr "existiert nicht"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
-msgstr "Dieses Dokument aus dem Index entfernen"
+msgstr "Soll dieses Dokument aus dem Index entfernt werden?"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
-msgstr "Diese Dokumente aus dem Index entfernen?"
+msgstr "Sollen diese Dokumente aus dem Index entfernt werden?"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
-msgstr ""
+msgstr "Ein Werkzeug zur Metasuche f?r den kostenfreien Desktop"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr "Durchsuchen Sie das Internet und Ihre Dokumente !"
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
-msgstr ""
+msgstr "Indexbezeichnung"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "Konnte Index nicht hinzuf?gen"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
-msgstr ""
+msgstr "Neuer Index hinzugef?gt"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "Konnte Index nicht entfernen"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr ""
+"Mindestens ein Vorgang wurde noch nicht abgeschlossen. Jetzt trotzdem "
+"beenden?"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "Keine Suchmaschine ausgew?hlt"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "Bitte geben Sie zuerst den Google API-Schl?ssel ein"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "Keine Standardanwendung f?r Typ angegeben"
 
@@ -448,91 +446,91 @@
 
 #: UI/GTK2/src/mainWindow_glade.cc:248
 msgid "_Results"
-msgstr ""
+msgstr "_Ergebnisse"
 
 #: UI/GTK2/src/mainWindow_glade.cc:254
 msgid "_Help"
-msgstr ""
+msgstr "_Hilfe"
 
 #: UI/GTK2/src/mainWindow_glade.cc:403
 msgid "Pinot"
 msgstr ""
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
-msgstr ""
+msgstr "Unbekannt"
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
-msgstr ""
+msgstr "D?nisch"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
-msgstr ""
+msgstr "Niederl?nisch"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "Englisch"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "Finnisch"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "Franz?sisch"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "Deutsch"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
-msgstr ""
+msgstr "Ungarisch"
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "Italienisch"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "Norwegisch"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "Portugiesisch"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
-msgstr ""
+msgstr "Rum?nisch"
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "Russisch"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "Spanisch"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "Schwedisch"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
-msgstr ""
+msgstr "T?rkisch"
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "Konnte Index nicht ?ffnen"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
-msgstr ""
+msgstr "Konnte Verlaufsdatenbank nicht anlegen"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
 msgstr ""
 
@@ -549,7 +547,7 @@
 msgid "Personal"
 msgstr "Pers?nlich"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr ""
 
@@ -660,7 +658,7 @@
 msgid "Preferences"
 msgstr "Einstellungen"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr ""
 
@@ -684,50 +682,57 @@
 msgid "Terms:"
 msgstr ""
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "Rechnername"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "Dateiname"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "Dateiendung"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr ""
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "Verzeichnis"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr ""
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr ""
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr ""
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+msgid "Date"
+msgstr "Datum"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
-msgstr ""
+#: UI/GTK2/src/queryDialog.cc:128
+#, fuzzy
+msgid "Time"
+msgstr "Titel"
 
+#: UI/GTK2/src/queryDialog.cc:129
+#, fuzzy
+msgid "Size"
+msgstr "Gr??e"
+
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
+msgid "New filter or range:"
 msgstr ""
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
@@ -742,15 +747,7 @@
 msgid "Number of results:"
 msgstr "Anzahl der Ergebnisse:"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr "Anfangsdatum:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr "Enddatum:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr ""
 
@@ -816,67 +813,75 @@
 msgid "Errors"
 msgstr "Fehler"
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "Kein Titel"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "Kann Dokumenttyp nicht indizieren"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr ""
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "Robots META-Tag verbietet das Indizieren"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr ""
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "Dokument konnte nicht aktualisiert werden"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr ""

Modified: trunk/po/es.po
===================================================================
--- trunk/po/es.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/es.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -3,19 +3,19 @@
 # This file is distributed under the same license as the pinot package.
 # Jes?s Tramullas <jesus at tramullas.com>, 2006.
 #
-#, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.75\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
-"PO-Revision-Date: 2007-07-21 12:37+0800\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
+"PO-Revision-Date: 2007-09-20 21:14+0000\n"
 "Last-Translator: Gar Bage <garbage at openfutura.com>\n"
 "Language-Team: es <fabricecolin at users.berlios.de>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=utf-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:30+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -25,44 +25,35 @@
 msgid "Current User"
 msgstr "Usuario"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "Mis Paginas Web"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "Mis documentos"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-msgid "Date"
-msgstr "Date"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr "Servido por"
 
 #: UI/GTK2/src/indexDialog.cc:124
-#, fuzzy
 msgid "Local"
-msgstr "Localizaci?n"
+msgstr "Local"
 
 #: UI/GTK2/src/indexDialog.cc:286
 msgid "Index location"
@@ -90,13 +81,13 @@
 
 #: UI/GTK2/src/indexDialog_glade.cc:79 UI/GTK2/src/prefsDialog_glade.cc:82
 msgid "Address:"
-msgstr ""
+msgstr "Direcci?n"
 
 #: UI/GTK2/src/indexDialog_glade.cc:183
 msgid "External index"
 msgstr "?ndice externo"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
 msgstr "Ninguno"
 
@@ -127,233 +118,238 @@
 
 #: UI/GTK2/src/IndexPage.cpp:189
 msgid "All"
-msgstr ""
+msgstr "Todos"
 
 #: UI/GTK2/src/launcherDialog_glade.cc:64
 msgid ""
 "There is no helper application defined for this document's type.\n"
 "Please enter the command to open this document."
 msgstr ""
+"No hay aplicaci?n de ayuda definida para este tipo de documento.\n"
+"Por favor, introduzca la orden para abrir este documento"
 
 #: UI/GTK2/src/launcherDialog_glade.cc:67
 msgid "Use this command for other documents of the same type."
-msgstr "Usar el mismo comando para otros documentos del mismo tipo"
+msgstr "Use esta orden para otros documentos del mismo tipo"
 
 #: UI/GTK2/src/launcherDialog_glade.cc:99
 msgid "Helper application"
 msgstr "Aplicaci?n de ayuda"
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr "Nombre de la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
 msgstr "?ltima ejecuci?n"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
 msgstr "Sumario"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "Mostrar todos los motores de b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "A?adir ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "Borrar ?ndice"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
-msgstr "Listo"
+msgstr "Preparado"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr "Desconocido"
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 msgid "Undefined"
 msgstr "Indefinido"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr "La localizaci?n del resultado es"
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr "La localizaci?n del documento es"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 msgid "Showing"
 msgstr "Mostrando"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr "documentos"
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr "documentos comenzando en"
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr "B?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr "en"
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr "finalizado"
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr "M?s como"
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr "Etiqueta(s) actualizada(s)"
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "Documento actualizado"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "Indizado"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "Documento(s) no indizado(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
 msgstr "Propiedades del documento actualizadas"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr "No se pudo renombrar ?ndice, nombre"
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 msgid "is already in use"
 msgstr "ya est? en uso"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "No se pudo renombrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr "?ndice editado"
 
-#: UI/GTK2/src/mainWindow.cc:1715
-#, fuzzy
+#: UI/GTK2/src/mainWindow.cc:1853
 msgid "Export Results"
-msgstr "resultados"
+msgstr "Exportar resultados"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr "B?squeda activa"
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr "No se pudo a?adir la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
 msgstr "no existe"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
 msgstr "?Borrar este documento del ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Una herramienta metabuscador para el escritorio libre"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr "Busca en el web y en sus documentos"
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
 msgstr "Nombre del ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "No se pudo a?adir el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
 msgstr "A?adido un nuevo ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "No se pudo borrar el ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Al menos una tarea no ha finalizado. ?Parar ahora?"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr "Nombre la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr "No se pudo actualizar la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr "B?squeda editada"
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr "No se pudo a?adir la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr "A?adida una nueva b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr "B?squeda no definida"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "Motor de b?squeda no seleccionado"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "Por favor, primero configure el API de Google"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr "Ejecutando la b?squeda"
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "No hay aplicaci?n predefinida para el tipo"
 
@@ -456,82 +452,82 @@
 msgstr "Pinot"
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
 msgstr "Desconocido"
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
 msgstr "Dan?s"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
 msgstr "Holand?s"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "Ingl?s"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "Finland?s"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "Franc?s"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "Alem?n"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
-msgstr ""
+msgstr "H?ngaro"
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "Italiano"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "Noruego"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "Portugu?s"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
-msgstr ""
+msgstr "Rumano"
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "Ruso"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "Espa?ol"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "Sueco"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
-msgstr ""
+msgstr "Turco"
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "No se pudo abrir el ?ndice"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
 msgstr "No se pudo crear la base de datos del hist?rico"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
-msgstr ""
+msgstr "Se recomienda actualizar todos los documentos en Mis P?ginas Web"
 
 #. Add default labels
 #: UI/GTK2/src/PinotSettings.cpp:317
@@ -546,7 +542,7 @@
 msgid "Personal"
 msgstr "Personal"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr "No clasificado"
 
@@ -568,11 +564,11 @@
 
 #: UI/GTK2/src/prefsDialog.cc:315
 msgid "Exclude these patterns from indexing"
-msgstr ""
+msgstr "Excluir de la indizacion estos patrones"
 
 #: UI/GTK2/src/prefsDialog.cc:316
 msgid "Only index these patterns"
-msgstr ""
+msgstr "Indizar s?lo estos patrones"
 
 #: UI/GTK2/src/prefsDialog.cc:406
 msgid "New Label"
@@ -612,15 +608,15 @@
 
 #: UI/GTK2/src/prefsDialog_glade.cc:79
 msgid "Direct connection to the Internet"
-msgstr ""
+msgstr "Conexi?n directa a Internet"
 
 #: UI/GTK2/src/prefsDialog_glade.cc:80
 msgid "Manual proxy configuration:"
-msgstr ""
+msgstr "Configuraci?n manual del proxy:"
 
 #: UI/GTK2/src/prefsDialog_glade.cc:93
 msgid "Network"
-msgstr ""
+msgstr "Red"
 
 #: UI/GTK2/src/prefsDialog_glade.cc:94
 msgid "Labels are used to classify indexed documents:"
@@ -656,7 +652,7 @@
 msgid "Preferences"
 msgstr "Preferencias"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "Etiqueta"
 
@@ -680,50 +676,58 @@
 msgid "Terms:"
 msgstr "T?rminos:"
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "Nombre de servidor"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "Nombre de archivo"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "Extensi?n del archivo"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "T?tulo"
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "Carpeta"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr "Codigo de idioma"
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr "Tipo MIME"
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr "Fecha inicial"
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+msgid "Date"
+msgstr "Date"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
-msgstr "Fecha final"
+#: UI/GTK2/src/queryDialog.cc:128
+#, fuzzy
+msgid "Time"
+msgstr "T?tulo"
 
+#: UI/GTK2/src/queryDialog.cc:129
+#, fuzzy
+msgid "Size"
+msgstr "Tama?o:"
+
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
+#, fuzzy
+msgid "New filter or range:"
 msgstr "Nuevo filtro:"
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
@@ -738,15 +742,7 @@
 msgid "Number of results:"
 msgstr "N?mero de resultados:"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr "Fecha de comienzo:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr "Fecha de fin:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr "Par?metros de b?squeda"
 
@@ -760,14 +756,12 @@
 msgstr "Extra?dos"
 
 #: UI/GTK2/src/statisticsDialog.cc:72
-#, fuzzy
 msgid "Indexes"
-msgstr "Indizado"
+msgstr "?ndices"
 
 #: UI/GTK2/src/statisticsDialog.cc:87
-#, fuzzy
 msgid "History"
-msgstr "Carpeta"
+msgstr "Hist?rico de b?squeda"
 
 #: UI/GTK2/src/statisticsDialog.cc:92
 msgid "Daemon"
@@ -779,7 +773,7 @@
 
 #: UI/GTK2/src/statisticsDialog.cc:132 UI/GTK2/src/statisticsDialog.cc:147
 msgid "Unknown error"
-msgstr ""
+msgstr "Error desconocido"
 
 #: UI/GTK2/src/statisticsDialog.cc:154
 msgid "Viewed"
@@ -791,17 +785,16 @@
 
 #. FIXME: check whether it's actually running !
 #: UI/GTK2/src/statisticsDialog.cc:171
-#, fuzzy
 msgid "Running under PID"
-msgstr "PID"
+msgstr "Ejecut?ndose bajo PID"
 
 #: UI/GTK2/src/statisticsDialog.cc:175
 msgid "Currently not running"
-msgstr ""
+msgstr "No se ejecuta actualmente"
 
 #: UI/GTK2/src/statisticsDialog.cc:182
 msgid "Crawled"
-msgstr ""
+msgstr "Capturado"
 
 #: UI/GTK2/src/statisticsDialog.cc:182
 msgid "files"
@@ -811,67 +804,75 @@
 msgid "Errors"
 msgstr "Errores"
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr "No se pudo indizar el buzon de correo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr "ya est? indizado"
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr "ya excluido"
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr "Error en el ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "Sin t?tulo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr "No se pudo crear el motor de b?squeda"
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr "No se pudo ejecutar la b?squeda contra el motor"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr "No se pudo usar un recuperador para el protocolo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr "No se pudo descargar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "No se pudo indizar el tipo de documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr "a"
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "La etiqueta META Robots proh?be la indizaci?n"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr "No se pudo indizar"
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr "No se pudo des-indizar lo(s) documento(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "No se pudo actualizar el documento"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr ""

Modified: trunk/po/fr.po
===================================================================
--- trunk/po/fr.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/fr.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -3,19 +3,19 @@
 # This file is distributed under the same license as the pinot package.
 # Fabrice Colin <fabricecolin at users.berlios.de>, 2005.
 #
-#, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.75\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
 "PO-Revision-Date: 2007-04-03 04:46+0000\n"
-"Last-Translator: FabriceColin <fabrice.colin at gmail.com>\n"
+"Last-Translator: Fabrice Colin <fabricecolin at users.berlios.de>\n"
 "Language-Team: fr <fabricecolin at users.berlios.de>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=utf-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:33+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -25,36 +25,28 @@
 msgid "Current User"
 msgstr "Utilisateur"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "Mes Pages Web"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "Mes Documents"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-msgid "Date"
-msgstr "Date"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr "Servi par"
@@ -95,7 +87,7 @@
 msgid "External index"
 msgstr "Index externe"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
 msgstr "Aucune"
 
@@ -144,217 +136,221 @@
 msgid "Helper application"
 msgstr "Application"
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr "Nom de la Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
 msgstr "Derniere Utilisation"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
 msgstr "Sommaire"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "Montrer tous les moteurs"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "Ajouter un index"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "Enlever un index"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
 msgstr "Pret"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr "Inconnue"
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 msgid "Undefined"
 msgstr "Indefini"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr "Le chemin du resultat est"
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr "Le chemin du document is"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 #, fuzzy
 msgid "Showing"
 msgstr "Montrant"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr "documents,"
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr "au total, a partir de"
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr "La recherche"
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr "sur"
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr "est terminee"
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr "Corrige"
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr "Similaire a"
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr "Mis a jour l(es) etiquette(s)"
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "Mis a jour le document"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "Indexe"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "Desindexe le(s) document(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
 msgstr "Mis a jour les proprietes du document"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr "N'a pas pu renommer l'index, le nom"
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 msgid "is already in use"
 msgstr "est deja utilise"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "N'a pas pu renommer l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr "Edite l'index"
 
-#: UI/GTK2/src/mainWindow.cc:1715
+#: UI/GTK2/src/mainWindow.cc:1853
 msgid "Export Results"
 msgstr "Exporter Les Resultats"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr "Recherche"
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr "N'a pas pu trouver"
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
 msgstr "L'index"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
 msgstr "n'existe pas"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
 msgstr "Enlever ce document de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
 msgstr "Enlever ces documents de l'index ?"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Un outil de recherche pour le Bureau Libre"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr "Cherche le Web et vos documents"
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
 msgstr "Nom de l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "N'a pas pu ajouter l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
 msgstr "Ajoute un nouvel index"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "N'a pas pu enlever l'index"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Au moins une tache n'est pas terminee. Quitter maintenant ?"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr "Nom de la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr "N'a pas pu mettre a jour la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr "Edite la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr "N'a pas pu ajouter la recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr "Ajoute une nouvelle recherche"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr "Recherche indefinie"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "Pas de moteur selectionne"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "Configurez la clef de l'API Google"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr "Recherche en cours"
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "Pas d'application definie pour le type"
 
@@ -457,80 +453,80 @@
 msgstr "Pinot"
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
 msgstr "Inconnu"
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
 msgstr "Danois"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
 msgstr "Hollandais"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "Anglais"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "Finlandais"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "Francais"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "Allemand"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
 msgstr "Hongrois"
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "Italien"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "Norvegien"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "Portugais"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
 msgstr "Roumain"
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "Russe"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "Espagnol"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "Suedois"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
 msgstr "Turc"
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "N'a pas pu ouvrir l'index"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
 msgstr "N'a pas pu creer la base d'historiques"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
 msgstr "Il est recommende de mettre a jour tous les documents de Mes Pages Web"
 
@@ -547,7 +543,7 @@
 msgid "Personal"
 msgstr "Personnel"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr "Sans classification"
 
@@ -656,7 +652,7 @@
 msgid "Preferences"
 msgstr "Preferences"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "Etiquette"
 
@@ -680,51 +676,57 @@
 msgid "Terms:"
 msgstr "Termes:"
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "Nom de machine"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "Nom de fichier"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "Extension de fichier"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "Titre"
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "Repertoire"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr "Code langue"
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr "Type MIME"
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr "Debut"
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+msgid "Date"
+msgstr "Date"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
-msgstr "Fin"
+#: UI/GTK2/src/queryDialog.cc:128
+msgid "Time"
+msgstr "Heure"
 
+#: UI/GTK2/src/queryDialog.cc:129
+msgid "Size"
+msgstr "Taille"
+
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
-msgstr "Nouveau filtre:"
+#, fuzzy
+msgid "New filter or range:"
+msgstr "Nouveau filtre ou gamme num?rique:"
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
 msgid "Query Text"
@@ -738,15 +740,7 @@
 msgid "Number of results:"
 msgstr "Nombre de resultats:"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr "Date de debut:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr "Date de fin:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr "Parametres de la recherche"
 
@@ -808,67 +802,75 @@
 msgid "Errors"
 msgstr "Erreurs"
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr "Ne peut pas indexer le courrier ici"
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr "est deja indexe"
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr "est exclus"
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr "Erreur sur l'index"
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "Pas de titre"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr "N'a pas pu creer le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr "N'a pas pu lancer la recherche sur le moteur"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N'a pas pu obtenir un brouteur pour"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr "N'a pas pu telecharger"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "Impossible d'indexer ce type de documents"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr "a"
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "Le META tag Robots interdit d'indexer"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr "N'a pas pu indexer"
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr "N'a pas pu desindexer le(s) document(s)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "N'a pas pu mettre a jour le document"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr "Pas de moniteur de fichiers disponible"
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr "N'a pas pu initialiser le moniteur de fichiers"

Modified: trunk/po/it.po
===================================================================
--- trunk/po/it.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/it.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -2,19 +2,19 @@
 # Copyright (c) 2006 Rosetta Contributors and Canonical Ltd 2006
 # This file is distributed under the same license as the pinot package.
 #
-#, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.75\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
-"PO-Revision-Date: 2007-06-21 19:51+0800\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: Marco Bazzani <visitors at libero.it>\n"
 "Language-Team: Italian <it at li.org>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:28+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -24,36 +24,28 @@
 msgid "Current User"
 msgstr "Utente attual"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "Pagine web personali"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "Documenti personali"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-msgid "Date"
-msgstr "Data"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr "Fornito da"
@@ -94,7 +86,7 @@
 msgid "External index"
 msgstr "Indice esterno"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
 msgstr "Nessuno"
 
@@ -143,217 +135,221 @@
 msgid "Helper application"
 msgstr "Applicazione associata"
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr "Nome da interrogare"
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
 msgstr "Ultimo Eseguito"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
 msgstr "Sommario"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "Mostrare tutti i motori di ricerca"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "Aggiungi Indice"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "Rimuovi indice"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
 msgstr "Pronto"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr "N/D"
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 msgid "Undefined"
 msgstr "Non Definito"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr "la posizione del risultato ?"
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr "La posizione Documento ?"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 msgid "Showing"
 msgstr "Mostrando"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr "dei"
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr "documenti, inizio a"
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr "Richiesta"
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr "sulla"
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr "conclusione"
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr "Molti gradiscono"
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr "Descrizione(i) aggiornata"
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "Documento aggiornato"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "Indicizzato"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "Documento/i non Indicizzato/i"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
 msgstr "Propriet? documento aggiornata"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr "Impossibile rinominare l'indice, nome"
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 msgid "is already in use"
 msgstr "? gi? in uso"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "Impossibile rinominare l'indice"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr "Indice modificato"
 
-#: UI/GTK2/src/mainWindow.cc:1715
+#: UI/GTK2/src/mainWindow.cc:1853
 #, fuzzy
 msgid "Export Results"
 msgstr "risultati"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr "Live Query"
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr "Impossibile trovare la query"
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
 msgstr "Indice"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
 msgstr "non esiste"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
 msgstr "Rimuovere questo documento dall'indice?"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
 msgstr "Rimuovere questi documenti dall'indice?"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Un tool di ricerca per il Desktop Libero"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr "Cerca nel Web e nei documenti !"
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
 msgstr "Nome indice"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "Impossibile aggiungere l'indice"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
 msgstr "Nuovo indice aggiunto"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "Impossibile rimuovere l'indice"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Nessuna operazione completata. Uscire comunque ?"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr "Nome Query"
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr "Impossibile aggiornare la query"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr "Query modificata"
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr "Impossibile aggiungere la query"
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr "Nuova query aggiunto"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr "Query non configurata"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "Nessun motore di ricerca selezionato"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "Prima inserisci la tua Google API key"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr "Query in esecuzione"
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "Nessuna applicazione di default ? stata definita per tipo"
 
@@ -456,80 +452,80 @@
 msgstr "Pinot"
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
 msgstr "Sconosciuto"
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
 msgstr "Danese"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
 msgstr "Olandese"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "Inglese"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "Finlandese"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "Francese"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "Tedesco"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "Italiano"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "Norvegese"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "Portoghese"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "Russo"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "Spagnolo"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "Svedese"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "Impossibile aprire l'indice"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
 msgstr "Impossibile creare una cronologia del database"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
 msgstr "E' consigliato aggiornare tutti le pagine web personali"
 
@@ -546,7 +542,7 @@
 msgid "Personal"
 msgstr "Personale"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr "Non classificato"
 
@@ -658,7 +654,7 @@
 msgid "Preferences"
 msgstr "Preferenze"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "Descrizione"
 
@@ -682,50 +678,58 @@
 msgid "Terms:"
 msgstr "Termini:"
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "Nome host"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "Nome file"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "Estensione file"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "Titolo"
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "Directory"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr "Codice di linguaggio"
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr "Tipo MIME"
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr "Data iniziale"
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+msgid "Date"
+msgstr "Data"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
-msgstr "Data finale"
+#: UI/GTK2/src/queryDialog.cc:128
+#, fuzzy
+msgid "Time"
+msgstr "Titolo"
 
+#: UI/GTK2/src/queryDialog.cc:129
+#, fuzzy
+msgid "Size"
+msgstr "Dimesione"
+
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
+#, fuzzy
+msgid "New filter or range:"
 msgstr "Nuovo filtro:"
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
@@ -740,15 +744,7 @@
 msgid "Number of results:"
 msgstr "Numero di risultati:"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr "Data di inizio:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr "Data di fine:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr "Parametri di Ricerca"
 
@@ -810,67 +806,75 @@
 msgid "Errors"
 msgstr "Errori"
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr "Impossibile indicizzare la mail qui"
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr "? gia' stato indicizzato"
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr "e' blacklistato"
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr "Errori indice su"
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "Nessun titolo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr "Impossibile creare un motore di ricerca"
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr "Impossibile avviare un query sul motore di ricerca"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr "Impossibile ottenere un downloader per il protocollo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr "Impossibile recuperare"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "Impossibile indicizzare tipo di documento"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr "a"
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "il Robots META tag vieta l'indicizzazione"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr "Impossibile indicizzare"
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr "Impossiible rimuovere i(l) documento/i dall'indice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "Impossibile aggiornare il documento"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr ""

Modified: trunk/po/nl.po
===================================================================
--- trunk/po/nl.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/nl.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -2,19 +2,19 @@
 # Copyright (c) 2006 Rosetta Contributors and Canonical Ltd 2006
 # This file is distributed under the same license as the pinot package.
 #
-#, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.75\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
-"PO-Revision-Date: 2007-08-03 19:02+0000\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: JW <jw00000 at gmail.com>\n"
 "Language-Team: Dutch <nl at li.org>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:25+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -24,36 +24,28 @@
 msgid "Current User"
 msgstr "Huidige gebruiker"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "Mijn webpagina's"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "Mijn documenten"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-msgid "Date"
-msgstr "Datum"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr "Geserveerd door"
@@ -94,7 +86,7 @@
 msgid "External index"
 msgstr "Externe index"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
 msgstr "Geen"
 
@@ -143,217 +135,221 @@
 msgid "Helper application"
 msgstr "Hulptoepassing"
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr "Querynaam"
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
 msgstr "Laatst geopend"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
 msgstr "Samenvatting"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "Toon alle zoekmachines"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "Toevoegen index"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "Verwijderen index"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
 msgstr "Gereed"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr "NVT"
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 msgid "Undefined"
 msgstr "Niet gedefinieerd"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr "Uitvoerlocatie is"
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr "Documentlocatie is"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 msgid "Showing"
 msgstr "Aan het tonen"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr "van"
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr "documenten, beginnend bij"
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr "Query"
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr "op"
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr "Beeindigd"
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr "Meer zoals"
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr "Vernieuwde na(a)m(en)"
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "Vernieuwd document"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "Geindexeerd"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "Niet geindexeerd(e) document(en)"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
 msgstr "Vernieuwde documenteigenschappen"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr "Kon index niet hernoemen, naam"
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 msgid "is already in use"
 msgstr "is reeds in gebruik"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "Kon index niet hernoemen"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr "Bewerkte index"
 
-#: UI/GTK2/src/mainWindow.cc:1715
+#: UI/GTK2/src/mainWindow.cc:1853
 #, fuzzy
 msgid "Export Results"
 msgstr "resultaten"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr "Rechtstreekse query"
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr "Kon query niet vinden"
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
 msgstr "Inhoudsopgave"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
 msgstr "bestaat niet"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
 msgstr "Verwijder dit document uit de inhoudsopgave"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
 msgstr "Verwijder deze documenten uit de inhoudsopgave"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Een metazoek tool voor de Free Desktop"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr "Zoek het web en uw documenten!"
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
 msgstr "Naam inhoudsopgave"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "Kon inhoudsopgave niet toevoegen"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
 msgstr "Nieuwe inhoudsopgave toegevoegd"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "Kon inhoudsopgave niet verwijderen"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Tenminste een taak is nog niet gereed. Nu stoppen?"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr "Naam query"
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr "Kon query niet actualiseren"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr "Bewerkte query"
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr "Kon query niet toevoegen"
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr "Nieuwe query toegevoegd"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr "Query niet vastgelegd"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "Geen zoekmachine geselecteerd"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "Geef eerst de Google API sleutel in"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr "Lopende query"
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "Geen standaard toepassing gedefinieerd voor het type"
 
@@ -456,80 +452,80 @@
 msgstr "Pinot"
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
 msgstr "Niet bekend"
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
 msgstr "Deens"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
 msgstr "Nederlands"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "Engels"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "Fins"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "Frans"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "Duits"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "Italiaans"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "Noors"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "Portugees"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "Russisch"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "Spaans"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "Zweeds"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "Kan index niet openen"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
 msgstr "Kon historische database niet maken"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
 msgstr ""
 "Het is aangeraden alle documenten in \"Mijn webpagina's\" te vernieuwen"
@@ -547,7 +543,7 @@
 msgid "Personal"
 msgstr "Persoonlijk"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr "Niet geclassificeerd"
 
@@ -660,7 +656,7 @@
 msgid "Preferences"
 msgstr "Voorkeuren"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "Bijschrift"
 
@@ -684,50 +680,58 @@
 msgid "Terms:"
 msgstr "Termen:"
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "Hostnaam"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "Bestandsnaam"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "Bestandsextensie"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "Titel"
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "Map"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr "Taal code"
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr "MIME type"
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr "Begindatum"
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+msgid "Date"
+msgstr "Datum"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
-msgstr "Einddatum"
+#: UI/GTK2/src/queryDialog.cc:128
+#, fuzzy
+msgid "Time"
+msgstr "Titel"
 
+#: UI/GTK2/src/queryDialog.cc:129
+#, fuzzy
+msgid "Size"
+msgstr "Grootte:"
+
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
+#, fuzzy
+msgid "New filter or range:"
 msgstr "Nieuw filter:"
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
@@ -742,15 +746,7 @@
 msgid "Number of results:"
 msgstr "Aantal resultaten:"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr "Begindatum:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr "Einddatum:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr "Queryparameters"
 
@@ -812,67 +808,75 @@
 msgid "Errors"
 msgstr "Fouten"
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr "Kan mail hier niet indexeren"
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr "wordt al geindexeerd"
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr "staat op blacklist"
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr "Indexeringsfout op"
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "Geen titel"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr "Kon zoekmachine niet maken"
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr "Kon query niet uitvoeren op zoekmachine"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr "Kon geen downloader verkrijgen voor protocol"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr "Kon niet opzoeken"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "Kan documenttype niet indexeren"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr "bij"
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "Robots META taf verbiedt indexeren"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr "Kon niet indexeren"
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr "Kan indexering van bestand(en) niet ongedaan maken"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "Kan document niet actualiseren"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr ""

Modified: trunk/po/pt.po
===================================================================
--- trunk/po/pt.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/pt.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -2,19 +2,19 @@
 # Copyright (c) 2007 Rosetta Contributors and Canonical Ltd 2007
 # This file is distributed under the same license as the pinot package.
 #
-#, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.75\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
 "PO-Revision-Date: 2007-08-17 10:07+0000\n"
 "Last-Translator: _PN_boy <pedro_nuno_pn at iol.pt>\n"
 "Language-Team: Portuguese <pt at li.org>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:17+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -25,36 +25,28 @@
 msgid "Current User"
 msgstr "Utilizador corrente"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "As minhas p?ginas Web"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "Os Meus Documentos"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-msgid "Date"
-msgstr "Data"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr "Servido por"
@@ -95,7 +87,7 @@
 msgid "External index"
 msgstr "Index externo"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
 msgstr "Nenhum"
 
@@ -144,217 +136,221 @@
 msgid "Helper application"
 msgstr "Aplica??o"
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr "Nome da Consulta"
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
 msgstr "?ltima execu??o"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
 msgstr "Resumo"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "Mostrar todos os motores de pesquisa"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "Adicionar index"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "Remover index"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
 msgstr "Pronto"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr "N/D"
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 msgid "Undefined"
 msgstr "Indefinido"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr "A localiza??o do resultado ?"
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr "A localiza??o do documento ?"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 msgid "Showing"
 msgstr "Visualizando"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr "de"
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr "documentos, come?ando em"
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr "Pesquisa"
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr "activar"
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr "terminado"
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr "Mais identico"
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr "T?tulo(s) atualizado(s)"
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "Documento actualizado"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "Indexado"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "Documento(s) n?o indexado(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
 msgstr "Propriedades do documento actualizado"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr "N?o foi poss?vel renomear o ?ndice, nome"
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 msgid "is already in use"
 msgstr "j? est? em uso"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "N?o foi poss?vel renomear o ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr "?ndice editado"
 
-#: UI/GTK2/src/mainWindow.cc:1715
+#: UI/GTK2/src/mainWindow.cc:1853
 #, fuzzy
 msgid "Export Results"
 msgstr "resultados"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr "Consulta activa"
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr "N?o foi poss?vel encontrar a consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
 msgstr "n?o existe"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
 msgstr "Remover este documento do ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
 msgstr "Remover estes documentos do ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Um mecanismo de metabusca para o Free Desktop"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr "Pesquise a Web e os seus documentos"
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
 msgstr "Nome do ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "N?o foi poss?vel adicionar ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
 msgstr "Adicionar novo ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "N?o foi possivel remover o ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Pelo menos uma tarefa ainda n?o foi concluida. Sair agora?"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr "Nome da consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr "N?o foi poss?vel actualizar a consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr "Consulta editada"
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr "N?o foi poss?vel adicionar consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr "Adicionar nova consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr "Consulta n?o foi actualizada"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "Nenhum mecanismo de pesquisa seleccionado"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "Primeiro escolha a tecla para a API Google"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr "A executar consulta"
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "Nenhuma aplica??o associada ao tipo"
 
@@ -457,80 +453,80 @@
 msgstr "Pinot"
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
 msgstr "Desconhecido"
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
 msgstr "Dinamarqu?s"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
 msgstr "Holand?s"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "Ingl?s"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "Finl?ndes"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "Franc?s"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "Alem?o"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
 msgstr "H?ngaro"
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "Italiano"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "Noruegu?s"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "Portugu?s"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
 msgstr "Romeno"
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "Russo"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "Espanhol"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "Sueco"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
 msgstr "Turco"
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "N?o foi poss?vel abrir o ?ndice"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
 msgstr "N?o foi poss?vel criar base de dados do hist?rico"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
 msgstr "A actualizar todos os documentos nas Minhas P?ginas Web ? recomendado"
 
@@ -547,7 +543,7 @@
 msgid "Personal"
 msgstr "Pessoal"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr "N?o classificado"
 
@@ -659,7 +655,7 @@
 msgid "Preferences"
 msgstr "Prefer?ncias"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "Etiqueta"
 
@@ -683,50 +679,58 @@
 msgid "Terms:"
 msgstr "Termos:"
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "Nome da m?quina"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "Nome do ficheiro"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "Extens?o do ficheiro"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "Titulo"
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "Direct?rio"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr "C?digo do idioma"
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr "Tipo MIME"
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr "Data de in?cio"
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+msgid "Date"
+msgstr "Data"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
-msgstr "Data de fim"
+#: UI/GTK2/src/queryDialog.cc:128
+#, fuzzy
+msgid "Time"
+msgstr "Titulo"
 
+#: UI/GTK2/src/queryDialog.cc:129
+#, fuzzy
+msgid "Size"
+msgstr "Tamanho:"
+
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
+#, fuzzy
+msgid "New filter or range:"
 msgstr "Novo filtro:"
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
@@ -741,15 +745,7 @@
 msgid "Number of results:"
 msgstr "N?mero de resultados:"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr "Data de in?cio:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr "Data de fim:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr "Par?metros da consulta"
 
@@ -811,67 +807,75 @@
 msgid "Errors"
 msgstr "Erros"
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr "N?o foi poss?vel indexar o mail aqui"
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr "j? est? a ser indexado"
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr "est? na lista negra"
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr "Erro na indexa??o em"
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "Sem t?tulo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr "N?o foi poss?vel criar mecanismo de pesquisa"
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr "N?o foi poss?vel efectuar consulta no mecanismo de pesquisa"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N?o foi poss?vel obter fonte de transfer?ncia para o protocolo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr "N?o foi poss?vel carregar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "Imposs?vel indexar tipo de ficheiro"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr "no"
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "Robots META tag n?o s?o permitidos no ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr "N?o foi poss?vel indexar"
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr "N?o foi poss?vel remover documento(s) do ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "N?o foi poss?vel actualizar o documento"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr ""

Modified: trunk/po/pt_BR.po
===================================================================
--- trunk/po/pt_BR.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/pt_BR.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -2,19 +2,19 @@
 # Copyright (c) 2006 Rosetta Contributors and Canonical Ltd 2006
 # This file is distributed under the same license as the pinot package.
 #
-#, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.75\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
-"PO-Revision-Date: 2007-07-21 12:37+0800\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: Leonardo Melo <leonardovazmelo at gmail.com>\n"
 "Language-Team: Portuguese (Brazil) <pt_BR at li.org>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:18+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -24,37 +24,28 @@
 msgid "Current User"
 msgstr "Usu?rio atual"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "Minhas P?ginas Web"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "Meus Documentos"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-#, fuzzy
-msgid "Date"
-msgstr "no"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr ""
@@ -96,7 +87,7 @@
 msgid "External index"
 msgstr "?ndice externo"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
 msgstr "Nenhum"
 
@@ -143,218 +134,222 @@
 msgid "Helper application"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr "Nome da consulta"
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
 msgstr "?ltimo executado"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
 msgstr "Resumo"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "Mostrar todos mecanimos de pesquisa"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "Adicionar ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "Remover ?ndice"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
 msgstr "Pronto"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr "N/A"
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 #, fuzzy
 msgid "Undefined"
 msgstr "<indefinido>"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr "Local resultante ?"
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr "Localiza??o do documento ?"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 msgid "Showing"
 msgstr "Exibindo"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr "de"
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr "documentos, come?am no"
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr "Consulta"
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr "no"
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr "finalizada"
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr "Mais pr?xima"
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr "T?tulo(s) atualizado(s)"
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "Documento atualizado"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "Indexado"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "Documento(s) n?o indexidado(s)"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
 msgstr "Propriedade de documentos atualizados"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr "N?o foi poss?vel renomear ?ndice, nome"
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 msgid "is already in use"
 msgstr "j? est? em uso"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "N?o foi poss?vel renomear ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr "?ndice editado"
 
-#: UI/GTK2/src/mainWindow.cc:1715
+#: UI/GTK2/src/mainWindow.cc:1853
 #, fuzzy
 msgid "Export Results"
 msgstr "_Resultados"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr "Query ativa"
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr "N?o foi poss?vel encontrar consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
 msgstr "?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
 msgstr "n?o existe"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
 msgstr "Remover documento do ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
 msgstr "Remover documentos do ?ndice?"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Um mecanismo de metabusca gr?tis para Desktop"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
 msgstr "Nome do ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "N?o foi poss?vel adicionar ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
 msgstr "Adicionar novo ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "N?o foi poss?vel remover ?ndice"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "Pelo menos uma tarefa n?o terminou ainda. Sair assim mesmo?"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr "Nome da consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr "N?o foi poss?vel atualizar consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr "Consulta editada"
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr "N?o foi poss?vel adicionar consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr "Adicionar nova consulta"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr "Consulta n?o foi atualizada"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "Nenhum mecanismo de pesquisa selecionado"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "Primeiro informe a tecla para Google API"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr "Executando consulta"
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "Aplica??o associada ao tipo n?o definida"
 
@@ -457,80 +452,80 @@
 msgstr "Pino"
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
 msgstr "Desconhecido"
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
 msgstr "Danish"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
 msgstr "Dutch"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "English"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "Terminar"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "French"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "German"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "Italian"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "Norwegian"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "Portugu?s"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "Russian"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "Spanish"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "Swedish"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "N?o foi poss?vel abrir ?ndice"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
 msgstr "N?o foi poss?vel criar base de hist?rico"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
 msgstr ""
 
@@ -547,7 +542,7 @@
 msgid "Personal"
 msgstr "Pessoal"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr "N?o classificado"
 
@@ -662,7 +657,7 @@
 msgid "Preferences"
 msgstr "Prefer?ncias"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "T?tulo"
 
@@ -686,50 +681,58 @@
 msgid "Terms:"
 msgstr ""
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "Nome do host"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "Nome do arquivo"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "Extens?o do arquivo"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "T?tulo"
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "Diret?rio"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr "C?digo da l?ngua"
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr "Tipo MIME"
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr ""
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+#, fuzzy
+msgid "Date"
+msgstr "no"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
+#: UI/GTK2/src/queryDialog.cc:128
+#, fuzzy
+msgid "Time"
+msgstr "T?tulo"
+
+#: UI/GTK2/src/queryDialog.cc:129
+msgid "Size"
 msgstr ""
 
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
+#, fuzzy
+msgid "New filter or range:"
 msgstr "Novo filtro:"
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
@@ -745,15 +748,7 @@
 msgid "Number of results:"
 msgstr "N?mero de resultados:"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr "Par?metros da consulta"
 
@@ -821,67 +816,75 @@
 msgid "Errors"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr "N?o foi poss?vel indexar mail aqui"
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr "j? est? sendo indexado"
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr "est? na lista negra"
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr "Erro no ?ndice no"
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "Sem t?tulo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr "N?o foi poss?vel criar mecanismo de pesquisa"
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr "N?o foi poss?vel executar consulta no mecanismo de pesquisa"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr "N?o foi poss?vel obter fonte de download para o protocolo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr "N?o foi poss?vel carregar"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "Imposs?vel indexar tipo de arquivo"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr "no"
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "Robots META tag n?o s?o permitidos no ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr "N?o foi poss?vel indexar"
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr "N?o foi poss?vel remover documento(s) do ?ndice"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "N?o foi poss?vel atualizar documento"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr ""

Modified: trunk/po/ru.po
===================================================================
--- trunk/po/ru.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/ru.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -2,19 +2,19 @@
 # Copyright (c) 2006 Rosetta Contributors and Canonical Ltd 2006
 # This file is distributed under the same license as the pinot package.
 #
-#, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot 0.75\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
-"PO-Revision-Date: 2007-07-21 12:37+0800\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: Sergey Vostrikov <s.vostrikov at gmail.com>\n"
 "Language-Team: Russian <ru at li.org>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:20+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -24,37 +24,28 @@
 msgid "Current User"
 msgstr "??????? ????????????"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "??? web-????????"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "??? ?????????"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-#, fuzzy
-msgid "Date"
-msgstr "?"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr ""
@@ -96,7 +87,7 @@
 msgid "External index"
 msgstr "??????? ??????"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
 msgstr "???"
 
@@ -143,218 +134,222 @@
 msgid "Helper application"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
 msgstr "????????? ?????????"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
 msgstr "??????"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "??? ????????? ???????"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "???????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "??????? ??????"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
 msgstr "?????"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr "N/A"
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 #, fuzzy
 msgid "Undefined"
 msgstr "<??????????????>"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr "??????? ?"
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr "???????????? ?????????"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 msgid "Showing"
 msgstr "????????"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr "??"
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr "??????????, ??????? ?"
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr "??"
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr "?????????????"
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr "????? ????????"
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr "????????? ????? (??)"
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "??????????? ????????"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "?????????????"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "?? ????????????? ??????????"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
 msgstr "?????????? ??????? ?????????"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr "?????????? ????????????? ??????, ????????"
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 msgid "is already in use"
 msgstr "??? ????????????"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "?????????? ????????????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr "?????????????? ???????"
 
-#: UI/GTK2/src/mainWindow.cc:1715
+#: UI/GTK2/src/mainWindow.cc:1853
 #, fuzzy
 msgid "Export Results"
 msgstr "_?????????"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr "???????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr "?????????? ????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
 msgstr "???"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
 msgstr "??????? ???????? ?? ??????? ?"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
 msgstr "??????? ??? ????????? ?? ????????"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
 msgstr "?????????? ?????????? ??? ?????????? ????????"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
 msgstr "???????? ???????"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "?????????? ???????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
 msgstr "???????? ????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "?????????? ??????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "?? ??????? ???? ???? ?????? ??? ?? ?????????. ????? ???????"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr "???????? ???????"
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr "?????????? ???????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr "?????? ???????"
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr "?????????? ???????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr "???????? ????? ??????"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr "?????? ?? ??????????"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "?? ???? ????????? ??????? ?? ???????"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "??????????, ??????? ????????????? ???? Google API"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr "?????? ???????"
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "?? ???? ?????????? ?? ????????? ?? ?????????? ??? ???? ??????????"
 
@@ -457,80 +452,80 @@
 msgstr "Pinot"
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
 msgstr "???????????"
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
 msgstr "???????"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
 msgstr "???????????"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "??????????"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "???????"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "???????????"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "????????"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "???????????"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "??????????"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "?????????????"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "???????"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "?????????"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "????????"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "?????????? ??????? ??????"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
 msgstr "?? ??????? ??????? ???? ?????? ???????"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
 msgstr ""
 
@@ -547,7 +542,7 @@
 msgid "Personal"
 msgstr "??????"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr "??????????????"
 
@@ -658,7 +653,7 @@
 msgid "Preferences"
 msgstr "?????????"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "?????"
 
@@ -682,50 +677,58 @@
 msgid "Terms:"
 msgstr ""
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "??? ????"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "????"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "?????????? ?????"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "????????"
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "URL"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "???????? ??????????"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr "??? ?????"
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr "??? MIME"
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr ""
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+#, fuzzy
+msgid "Date"
+msgstr "?"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
+#: UI/GTK2/src/queryDialog.cc:128
+#, fuzzy
+msgid "Time"
+msgstr "????????"
+
+#: UI/GTK2/src/queryDialog.cc:129
+msgid "Size"
 msgstr ""
 
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
+#, fuzzy
+msgid "New filter or range:"
 msgstr "????? ??????:"
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
@@ -741,15 +744,7 @@
 msgid "Number of results:"
 msgstr "?????????? ???????????:"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr ""
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr "????????? ???????"
 
@@ -817,67 +812,75 @@
 msgid "Errors"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr "?????? ????????????? ????? ?????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr "??? ??????????????????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr "??????????? ? ?????? ??????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr "?????? ??????? ??"
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "??? ????????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr "?? ??????? ??????? ????????? ???????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr "?? ??????? ????????? ?????? ? ????????? ???????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr "?? ??????? ???????? ????????? ??? ?????????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr "?? ??????? ???????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "?????????? ????????????? ?????? ??? ??????????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr "?"
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "META-???? ??????? ????????? ??????????????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr "?????????? ????????? ??????"
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr "?????????? ??????????????? ????????(?)"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "?????????? ???????? ????????"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr ""

Modified: trunk/po/sv.po
===================================================================
--- trunk/po/sv.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/sv.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -7,14 +7,15 @@
 msgstr ""
 "Project-Id-Version: pinot\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
 "PO-Revision-Date: 2007-07-29 16:48+0000\n"
 "Last-Translator: Daniel Nylander <yeager at ubuntu.com>\n"
 "Language-Team: Swedish <tp-sv at listor.tp-sv.se>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:27+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -24,36 +25,28 @@
 msgid "Current User"
 msgstr "Aktuell anv?ndare"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "Mina webbsidor"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "Mina dokument"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-msgid "Date"
-msgstr "Datum"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr "Erbjuds av"
@@ -94,7 +87,7 @@
 msgid "External index"
 msgstr "Externt index"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
 msgstr "Ingen"
 
@@ -143,216 +136,220 @@
 msgid "Helper application"
 msgstr "Hj?lpprogram"
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr "Fr?genamn"
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
 msgstr "Senaste k?rning"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
 msgstr "Sammandrag"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "Visa alla s?kmotorer"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "L?gg till index"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "Ta bort index"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
 msgstr "Redo"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr "-"
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 msgid "Undefined"
 msgstr "Odefinierad"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr "Resultatplatsen ?r"
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr "Dokumentplatsen ?r"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 msgid "Showing"
 msgstr "Visar"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr "av"
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr "dokument, b?rjar med"
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr "Fr?ga"
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr "p?"
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr "slutade"
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr "Kanske mer som"
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr "Uppdaterade etikett(er)"
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "Uppdaterade dokument"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "Indexerade"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "Ej indexerade dokument"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
 msgstr "Egenskaper f?r uppdaterade dokument"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr "Kunde inte byta namn p? index, namn"
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 msgid "is already in use"
 msgstr "anv?nds redan"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "Kunde inte byta namn p? index"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr "Redigerade index"
 
-#: UI/GTK2/src/mainWindow.cc:1715
+#: UI/GTK2/src/mainWindow.cc:1853
 msgid "Export Results"
 msgstr "Exportresultat"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr "Levande fr?ga"
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr "Kunde inte hitta fr?ga"
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
 msgstr "Index"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
 msgstr "finns inte"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
 msgstr "Ta bort detta dokument fr?n indexet?"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
 msgstr "Ta bort dessa dokument fr?n indexet?"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Ett metas?kningsverktyg f?r Free Desktop"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr "S?k p? webben och i dina dokument!"
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
 msgstr "Indexnamn"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "Kunde inte l?gga till index"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
 msgstr "Lade till nytt index"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "Kunde inte ta bort index"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "?tminstone en uppgift har inte f?rdigst?llts ?n. Avsluta nu?"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr "Fr?genamn"
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr "Kunde inte uppdatera fr?ga"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr "Redigerade fr?ga"
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr "Kunde inte l?gga till fr?ga"
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr "Lade till ny fr?ga"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr "Fr?gan ?r inte inst?lld"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "Ingen s?kmotor vald"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "St?ll in Google API-nyckeln f?rst"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr "K?r fr?ga"
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "Inget standardprogram definierat f?r typen"
 
@@ -455,80 +452,80 @@
 msgstr "Pinot"
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
 msgstr "Ok?nd"
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
 msgstr "Danska"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
 msgstr "Nederl?ndska"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "Engelska"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "Finska"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "Franska"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "Tyska"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
 msgstr "Ungerska"
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "Italienska"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "Norska"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "Portugisiska"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
 msgstr "Rum?nska"
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "Ryska"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "Spanska"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "Svenska"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
 msgstr "Turkiska"
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "Kunde inte ?ppna index"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
 msgstr "Kunde inte skapa historikdatabas"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
 msgstr "Uppdatering av alla dokument i Mina webbsidor rekommenderas"
 
@@ -545,7 +542,7 @@
 msgid "Personal"
 msgstr "Personlig"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr "Oklassificerad"
 
@@ -656,7 +653,7 @@
 msgid "Preferences"
 msgstr "Inst?llningar"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "Etikett"
 
@@ -680,50 +677,58 @@
 msgid "Terms:"
 msgstr "Villkor:"
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "V?rdnamn"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "Filnamn"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "Fil?ndelse"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "Titel"
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "Url"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "Katalog"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr "Spr?kkod"
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr "MIME-typ"
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr "Startdatum"
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+msgid "Date"
+msgstr "Datum"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
-msgstr "Slutdatum"
+#: UI/GTK2/src/queryDialog.cc:128
+#, fuzzy
+msgid "Time"
+msgstr "Titel"
 
+#: UI/GTK2/src/queryDialog.cc:129
+#, fuzzy
+msgid "Size"
+msgstr "Storlek:"
+
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
+#, fuzzy
+msgid "New filter or range:"
 msgstr "Nytt filter:"
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
@@ -738,15 +743,7 @@
 msgid "Number of results:"
 msgstr "Antal resultat:"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr "Startdatum:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr "Slutdatum:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr "Fr?geparametrar"
 
@@ -808,67 +805,75 @@
 msgid "Errors"
 msgstr "Fel"
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr "Kan inte indexera post h?r"
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr "h?ller redan p? att bli indexerad"
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr "?r svartlistad"
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr "Indexfel p?"
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "Ingen titel"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr "Kunde inte skapa s?kmotor"
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr "Kunde inte k?ra fr?ga p? s?kmotor"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr "Kunde inte f? protokollh?mtare"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr "Kunde inte h?mta"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "Kan inte indexera dokumenttyp"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr "p?"
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "Robots META-tagg f?rbjuder indexering"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr "Kunde inte indexera"
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr "Kunde inte avindexera dokument"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "Kunde inte uppdatera dokument"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr ""

Modified: trunk/po/zh_TW.po
===================================================================
--- trunk/po/zh_TW.po	2007-09-23 11:33:08 UTC (rev 986)
+++ trunk/po/zh_TW.po	2007-09-23 14:26:50 UTC (rev 987)
@@ -3,19 +3,19 @@
 # This file is distributed under the same license as the pinot package.
 # FIRST AUTHOR <EMAIL at ADDRESS>, 2007.
 #
-#, fuzzy
 msgid ""
 msgstr ""
 "Project-Id-Version: pinot\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2007-08-22 22:25+0800\n"
+"POT-Creation-Date: 2007-09-23 19:22+0800\n"
 "PO-Revision-Date: 2007-08-17 15:54+0000\n"
 "Last-Translator: Yung-chung Lin <henearkrxern at gmail.com>\n"
 "Language-Team: Traditional Chinese <zh_TW at li.org>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Rosetta-Export-Date: 2007-08-19 07:58:14+0000\n"
+"X-Launchpad-Export-Date: 2007-09-23 13:58+0000\n"
+"X-Generator: Launchpad (build Unknown)\n"
 
 #: UI/GTK2/src/EnginesTree.cpp:68
 msgid "Search Engines"
@@ -25,36 +25,28 @@
 msgid "Current User"
 msgstr "??????"
 
-#. Bind the callback's parameter to the index name
 #. Enable these menu items unless it is not the documents index
+#. Allow this only for internal indexes
 #. Internal indices
-#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:325
-#: UI/GTK2/src/mainWindow.cc:328 UI/GTK2/src/mainWindow.cc:541
-#: UI/GTK2/src/mainWindow.cc:1030 UI/GTK2/src/mainWindow.cc:1201
-#: UI/GTK2/src/mainWindow.cc:1243 UI/GTK2/src/mainWindow.cc:1265
-#: UI/GTK2/src/mainWindow.cc:1296 UI/GTK2/src/mainWindow.cc:1907
-#: UI/GTK2/src/PinotSettings.cpp:311 UI/GTK2/src/PinotSettings.cpp:1368
-#: UI/GTK2/src/PinotSettings.cpp:1424 UI/GTK2/src/statisticsDialog.cc:77
-#: UI/GTK2/src/WorkerThreads.cpp:821 UI/GTK2/src/WorkerThreads.cpp:880
+#: UI/GTK2/src/EnginesTree.cpp:337 UI/GTK2/src/mainWindow.cc:677
+#: UI/GTK2/src/mainWindow.cc:1187 UI/GTK2/src/mainWindow.cc:1339
+#: UI/GTK2/src/mainWindow.cc:1381 UI/GTK2/src/mainWindow.cc:1403
+#: UI/GTK2/src/mainWindow.cc:1434 UI/GTK2/src/mainWindow.cc:2045
+#: UI/GTK2/src/mainWindow.cc:2157 UI/GTK2/src/PinotSettings.cpp:311
+#: UI/GTK2/src/PinotSettings.cpp:1387 UI/GTK2/src/PinotSettings.cpp:1443
+#: UI/GTK2/src/statisticsDialog.cc:77 UI/GTK2/src/WorkerThreads.cpp:822
+#: UI/GTK2/src/WorkerThreads.cpp:881
 msgid "My Web Pages"
 msgstr "????"
 
-#. Populate the submenu
-#. Bind the callback's parameter to the index name
-#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:319
-#: UI/GTK2/src/mainWindow.cc:322 UI/GTK2/src/mainWindow.cc:1037
-#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1369
-#: UI/GTK2/src/PinotSettings.cpp:1425 UI/GTK2/src/statisticsDialog.cc:82
-#: UI/GTK2/src/WorkerThreads.cpp:826 UI/GTK2/src/WorkerThreads.cpp:890
+#: UI/GTK2/src/EnginesTree.cpp:338 UI/GTK2/src/mainWindow.cc:680
+#: UI/GTK2/src/mainWindow.cc:1194 UI/GTK2/src/mainWindow.cc:2158
+#: UI/GTK2/src/PinotSettings.cpp:312 UI/GTK2/src/PinotSettings.cpp:1388
+#: UI/GTK2/src/PinotSettings.cpp:1444 UI/GTK2/src/statisticsDialog.cc:82
+#: UI/GTK2/src/WorkerThreads.cpp:827 UI/GTK2/src/WorkerThreads.cpp:891
 msgid "My Documents"
 msgstr "????"
 
-#. The last column is for the timestamp
-#: UI/GTK2/src/dateDialog_glade.cc:76 UI/GTK2/src/queryDialog_glade.cc:91
-#: UI/GTK2/src/queryDialog_glade.cc:92 UI/GTK2/src/ResultsTree.cpp:151
-msgid "Date"
-msgstr "??"
-
 #: UI/GTK2/src/indexDialog.cc:122
 msgid "Served by"
 msgstr ""
@@ -95,7 +87,7 @@
 msgid "External index"
 msgstr "????"
 
-#: UI/GTK2/src/importDialog.cc:76 UI/GTK2/src/queryDialog.cc:119
+#: UI/GTK2/src/importDialog.cc:87 UI/GTK2/src/queryDialog.cc:95
 msgid "None"
 msgstr "?"
 
@@ -142,217 +134,221 @@
 msgid "Helper application"
 msgstr "????"
 
-#: UI/GTK2/src/mainWindow.cc:140
+#: UI/GTK2/src/mainWindow.cc:211
 msgid "Query Name"
 msgstr "????"
 
-#: UI/GTK2/src/mainWindow.cc:145
+#: UI/GTK2/src/mainWindow.cc:216
 msgid "Last Run"
 msgstr "???????"
 
-#: UI/GTK2/src/mainWindow.cc:150
+#: UI/GTK2/src/mainWindow.cc:221
 msgid "Summary"
 msgstr "??"
 
 #. Set tooltips
-#: UI/GTK2/src/mainWindow.cc:183
+#: UI/GTK2/src/mainWindow.cc:255
 msgid "Show all search engines"
 msgstr "?????????"
 
-#: UI/GTK2/src/mainWindow.cc:184
+#: UI/GTK2/src/mainWindow.cc:256
 msgid "Add index"
 msgstr "????"
 
-#: UI/GTK2/src/mainWindow.cc:185
+#: UI/GTK2/src/mainWindow.cc:257
 msgid "Remove index"
 msgstr "????"
 
 #. Now we are ready
-#: UI/GTK2/src/mainWindow.cc:191
+#: UI/GTK2/src/mainWindow.cc:282
 msgid "Ready"
 msgstr "???"
 
-#: UI/GTK2/src/mainWindow.cc:242
+#: UI/GTK2/src/mainWindow.cc:342
 msgid "N/A"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:257
+#: UI/GTK2/src/mainWindow.cc:357
 msgid "Undefined"
 msgstr "???"
 
 #. Show the URL of the first result in the status bar
-#: UI/GTK2/src/mainWindow.cc:476
+#: UI/GTK2/src/mainWindow.cc:611
 msgid "Result location is"
 msgstr "??????"
 
 #. Show the URL in the status bar
-#: UI/GTK2/src/mainWindow.cc:551
+#: UI/GTK2/src/mainWindow.cc:691
 msgid "Document location is"
 msgstr "?????"
 
-#: UI/GTK2/src/mainWindow.cc:884
+#: UI/GTK2/src/mainWindow.cc:1024
 msgid "Showing"
 msgstr "??"
 
-#: UI/GTK2/src/mainWindow.cc:889
+#: UI/GTK2/src/mainWindow.cc:1029
 msgid "of"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:894
+#: UI/GTK2/src/mainWindow.cc:1034
 msgid "documents, starting at"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:928
+#: UI/GTK2/src/mainWindow.cc:1068
 msgid "Query"
 msgstr "??"
 
-#: UI/GTK2/src/mainWindow.cc:932 UI/GTK2/src/mainWindow.cc:3028
+#: UI/GTK2/src/mainWindow.cc:1072 UI/GTK2/src/mainWindow.cc:3177
 msgid "on"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:936
+#: UI/GTK2/src/mainWindow.cc:1076
 msgid "ended"
 msgstr "??"
 
-#: UI/GTK2/src/mainWindow.cc:1066
+#: UI/GTK2/src/mainWindow.cc:1137
+msgid "Corrected"
+msgstr ""
+
+#: UI/GTK2/src/mainWindow.cc:1223
 msgid "More Like"
 msgstr "????"
 
-#: UI/GTK2/src/mainWindow.cc:1127
+#: UI/GTK2/src/mainWindow.cc:1265
 msgid "Updated label(s)"
 msgstr "?????"
 
 #. Yes, it did
-#: UI/GTK2/src/mainWindow.cc:1211
+#: UI/GTK2/src/mainWindow.cc:1349
 msgid "Updated document"
 msgstr "?????"
 
-#: UI/GTK2/src/mainWindow.cc:1224
+#: UI/GTK2/src/mainWindow.cc:1362
 msgid "Indexed"
 msgstr "???"
 
-#: UI/GTK2/src/mainWindow.cc:1266
+#: UI/GTK2/src/mainWindow.cc:1404
 msgid "Unindexed document(s)"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:1306
+#: UI/GTK2/src/mainWindow.cc:1444
 msgid "Updated document properties"
 msgstr "???????"
 
-#: UI/GTK2/src/mainWindow.cc:1359
+#: UI/GTK2/src/mainWindow.cc:1497
 msgid "Couldn't rename index, name"
 msgstr "????????????"
 
-#: UI/GTK2/src/mainWindow.cc:1363 UI/GTK2/src/mainWindow.cc:2296
-#: UI/GTK2/src/mainWindow.cc:2833
+#: UI/GTK2/src/mainWindow.cc:1501 UI/GTK2/src/mainWindow.cc:2441
+#: UI/GTK2/src/mainWindow.cc:2982
 msgid "is already in use"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:1376
+#: UI/GTK2/src/mainWindow.cc:1514
 msgid "Couldn't rename index"
 msgstr "?????????"
 
-#: UI/GTK2/src/mainWindow.cc:1389
+#: UI/GTK2/src/mainWindow.cc:1527
 msgid "Edited index"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:1715
+#: UI/GTK2/src/mainWindow.cc:1853
 #, fuzzy
 msgid "Export Results"
 msgstr "????"
 
 #. Find this query
-#: UI/GTK2/src/mainWindow.cc:1804 UI/GTK2/src/mainWindow.cc:2466
+#: UI/GTK2/src/mainWindow.cc:1942 UI/GTK2/src/mainWindow.cc:2615
 msgid "Live query"
 msgstr ""
 
-#: UI/GTK2/src/mainWindow.cc:1830
+#: UI/GTK2/src/mainWindow.cc:1968
 msgid "Couldn't find query"
 msgstr "???????"
 
-#: UI/GTK2/src/mainWindow.cc:2022 UI/GTK2/src/WorkerThreads.cpp:677
-#: UI/GTK2/src/WorkerThreads.cpp:1719
+#: UI/GTK2/src/mainWindow.cc:2167 UI/GTK2/src/WorkerThreads.cpp:678
+#: UI/GTK2/src/WorkerThreads.cpp:1720
 msgid "Index"
 msgstr "??"
 
-#: UI/GTK2/src/mainWindow.cc:2026 UI/GTK2/src/WorkerThreads.cpp:681
-#: UI/GTK2/src/WorkerThreads.cpp:1723
+#: UI/GTK2/src/mainWindow.cc:2171 UI/GTK2/src/WorkerThreads.cpp:682
+#: UI/GTK2/src/WorkerThreads.cpp:1724
 msgid "doesn't exist"
 msgstr "???"
 
-#: UI/GTK2/src/mainWindow.cc:2181
+#: UI/GTK2/src/mainWindow.cc:2326
 msgid "Remove this document from the index ?"
 msgstr "????????????"
 
-#: UI/GTK2/src/mainWindow.cc:2200
+#: UI/GTK2/src/mainWindow.cc:2345
 msgid "Remove these documents from the index ?"
 msgstr "????????????"
 
-#: UI/GTK2/src/mainWindow.cc:2246
+#: UI/GTK2/src/mainWindow.cc:2391
 msgid "A metasearch tool for the Free Desktop"
 msgstr "Free Desktop ??????"
 
-#: UI/GTK2/src/mainWindow.cc:2247
+#: UI/GTK2/src/mainWindow.cc:2392
 msgid "Search the Web and your documents !"
 msgstr "????????????"
 
-#: UI/GTK2/src/mainWindow.cc:2292
+#: UI/GTK2/src/mainWindow.cc:2437
 msgid "Index name"
 msgstr "????"
 
-#: UI/GTK2/src/mainWindow.cc:2307
+#: UI/GTK2/src/mainWindow.cc:2452
 msgid "Couldn't add index"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:2321
+#: UI/GTK2/src/mainWindow.cc:2468
 msgid "Added new index"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:2356
+#: UI/GTK2/src/mainWindow.cc:2503
 msgid "Couldn't remove index"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:2646
+#: UI/GTK2/src/mainWindow.cc:2795
 msgid "At least one task hasn't completed yet. Quit now ?"
 msgstr "??????????????????"
 
-#: UI/GTK2/src/mainWindow.cc:2829
+#: UI/GTK2/src/mainWindow.cc:2978
 msgid "Query name"
 msgstr "????"
 
-#: UI/GTK2/src/mainWindow.cc:2856
+#: UI/GTK2/src/mainWindow.cc:3005
 msgid "Couldn't update query"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:2864
+#: UI/GTK2/src/mainWindow.cc:3013
 msgid "Edited query"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:2871
+#: UI/GTK2/src/mainWindow.cc:3020
 msgid "Couldn't add query"
 msgstr "??????"
 
-#: UI/GTK2/src/mainWindow.cc:2879
+#: UI/GTK2/src/mainWindow.cc:3028
 msgid "Added new query"
 msgstr "?????"
 
-#: UI/GTK2/src/mainWindow.cc:2917
+#: UI/GTK2/src/mainWindow.cc:3066
 msgid "Query is not set"
 msgstr "???????"
 
-#: UI/GTK2/src/mainWindow.cc:2928
+#: UI/GTK2/src/mainWindow.cc:3077
 msgid "No search engine selected"
 msgstr "????????"
 
-#: UI/GTK2/src/mainWindow.cc:3015
+#: UI/GTK2/src/mainWindow.cc:3164
 msgid "Please set the Google API key first"
 msgstr "????Google API key"
 
-#: UI/GTK2/src/mainWindow.cc:3024
+#: UI/GTK2/src/mainWindow.cc:3173
 msgid "Running query"
 msgstr "???????"
 
-#: UI/GTK2/src/mainWindow.cc:3236
+#: UI/GTK2/src/mainWindow.cc:3382
 msgid "No default application defined for type"
 msgstr "????????????"
 
@@ -455,80 +451,80 @@
 msgstr "Pinot"
 
 #. Localize language names
-#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:332
+#: UI/GTK2/src/pinot.cc:249 UI/GTK2/src/pinot-dbus-daemon.cc:324
 #: UI/GTK2/src/propertiesDialog.cc:72 UI/GTK2/src/propertiesDialog.cc:81
 msgid "Unknown"
 msgstr ""
 
-#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:333
+#: UI/GTK2/src/pinot.cc:250 UI/GTK2/src/pinot-dbus-daemon.cc:325
 msgid "Danish"
 msgstr "???"
 
-#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:334
+#: UI/GTK2/src/pinot.cc:251 UI/GTK2/src/pinot-dbus-daemon.cc:326
 msgid "Dutch"
 msgstr "???"
 
-#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:335
+#: UI/GTK2/src/pinot.cc:252 UI/GTK2/src/pinot-dbus-daemon.cc:327
 msgid "English"
 msgstr "??"
 
-#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:336
+#: UI/GTK2/src/pinot.cc:253 UI/GTK2/src/pinot-dbus-daemon.cc:328
 msgid "Finnish"
 msgstr "???"
 
-#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:337
+#: UI/GTK2/src/pinot.cc:254 UI/GTK2/src/pinot-dbus-daemon.cc:329
 msgid "French"
 msgstr "??"
 
-#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:338
+#: UI/GTK2/src/pinot.cc:255 UI/GTK2/src/pinot-dbus-daemon.cc:330
 msgid "German"
 msgstr "??"
 
-#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:339
+#: UI/GTK2/src/pinot.cc:256 UI/GTK2/src/pinot-dbus-daemon.cc:331
 msgid "Hungarian"
 msgstr "????"
 
-#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:340
+#: UI/GTK2/src/pinot.cc:257 UI/GTK2/src/pinot-dbus-daemon.cc:332
 msgid "Italian"
 msgstr "????"
 
-#: UI/GTK2/src/pinot.cc:265 UI/GTK2/src/pinot-dbus-daemon.cc:341
+#: UI/GTK2/src/pinot.cc:258 UI/GTK2/src/pinot-dbus-daemon.cc:333
 msgid "Norwegian"
 msgstr "???"
 
-#: UI/GTK2/src/pinot.cc:266 UI/GTK2/src/pinot-dbus-daemon.cc:342
+#: UI/GTK2/src/pinot.cc:259 UI/GTK2/src/pinot-dbus-daemon.cc:334
 msgid "Portuguese"
 msgstr "????"
 
-#: UI/GTK2/src/pinot.cc:267 UI/GTK2/src/pinot-dbus-daemon.cc:343
+#: UI/GTK2/src/pinot.cc:260 UI/GTK2/src/pinot-dbus-daemon.cc:335
 msgid "Romanian"
 msgstr "?????"
 
-#: UI/GTK2/src/pinot.cc:268 UI/GTK2/src/pinot-dbus-daemon.cc:344
+#: UI/GTK2/src/pinot.cc:261 UI/GTK2/src/pinot-dbus-daemon.cc:336
 msgid "Russian"
 msgstr "??"
 
-#: UI/GTK2/src/pinot.cc:269 UI/GTK2/src/pinot-dbus-daemon.cc:345
+#: UI/GTK2/src/pinot.cc:262 UI/GTK2/src/pinot-dbus-daemon.cc:337
 msgid "Spanish"
 msgstr "????"
 
-#: UI/GTK2/src/pinot.cc:270 UI/GTK2/src/pinot-dbus-daemon.cc:346
+#: UI/GTK2/src/pinot.cc:263 UI/GTK2/src/pinot-dbus-daemon.cc:338
 msgid "Swedish"
 msgstr "???"
 
-#: UI/GTK2/src/pinot.cc:271 UI/GTK2/src/pinot-dbus-daemon.cc:347
+#: UI/GTK2/src/pinot.cc:264 UI/GTK2/src/pinot-dbus-daemon.cc:339
 msgid "Turkish"
 msgstr "????"
 
-#: UI/GTK2/src/pinot.cc:296
+#: UI/GTK2/src/pinot.cc:289
 msgid "Couldn't open index"
 msgstr "??????"
 
-#: UI/GTK2/src/pinot.cc:317
+#: UI/GTK2/src/pinot.cc:310
 msgid "Couldn't create history database"
 msgstr "?????????"
 
-#: UI/GTK2/src/pinot.cc:343
+#: UI/GTK2/src/pinot.cc:336
 msgid "Updating all documents in My Web Pages is recommended"
 msgstr "???????????????"
 
@@ -545,7 +541,7 @@
 msgid "Personal"
 msgstr "????"
 
-#: UI/GTK2/src/PinotSettings.cpp:1175
+#: UI/GTK2/src/PinotSettings.cpp:1198
 msgid "Unclassified"
 msgstr "????"
 
@@ -655,7 +651,7 @@
 msgid "Preferences"
 msgstr "????"
 
-#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:148
+#: UI/GTK2/src/propertiesDialog.cc:60 UI/GTK2/src/queryDialog.cc:124
 msgid "Label"
 msgstr "??"
 
@@ -679,50 +675,58 @@
 msgid "Terms:"
 msgstr "??"
 
-#: UI/GTK2/src/queryDialog.cc:138
+#: UI/GTK2/src/queryDialog.cc:114
 msgid "Host name"
 msgstr "????"
 
-#: UI/GTK2/src/queryDialog.cc:139
+#: UI/GTK2/src/queryDialog.cc:115
 msgid "File name"
 msgstr "????"
 
-#: UI/GTK2/src/queryDialog.cc:142
+#: UI/GTK2/src/queryDialog.cc:118
 msgid "File extension"
 msgstr "???"
 
 #. This is the title column
-#: UI/GTK2/src/queryDialog.cc:143 UI/GTK2/src/ResultsTree.cpp:133
+#: UI/GTK2/src/queryDialog.cc:119 UI/GTK2/src/ResultsTree.cpp:133
 msgid "Title"
 msgstr "??"
 
 #. URL
-#: UI/GTK2/src/queryDialog.cc:144 UI/GTK2/src/ResultsTree.cpp:143
+#: UI/GTK2/src/queryDialog.cc:120 UI/GTK2/src/ResultsTree.cpp:143
 msgid "URL"
 msgstr "??"
 
-#: UI/GTK2/src/queryDialog.cc:145
+#: UI/GTK2/src/queryDialog.cc:121
 msgid "Directory"
 msgstr "??"
 
-#: UI/GTK2/src/queryDialog.cc:146
+#: UI/GTK2/src/queryDialog.cc:122
 msgid "Language code"
 msgstr "????"
 
-#: UI/GTK2/src/queryDialog.cc:147
+#: UI/GTK2/src/queryDialog.cc:123
 msgid "MIME type"
 msgstr "MIME ??"
 
-#: UI/GTK2/src/queryDialog.cc:272
-msgid "Start date"
-msgstr "????"
+#. The last column is for the timestamp
+#: UI/GTK2/src/queryDialog.cc:127 UI/GTK2/src/ResultsTree.cpp:151
+msgid "Date"
+msgstr "??"
 
-#: UI/GTK2/src/queryDialog.cc:287
-msgid "End date"
-msgstr "????"
+#: UI/GTK2/src/queryDialog.cc:128
+#, fuzzy
+msgid "Time"
+msgstr "??"
 
+#: UI/GTK2/src/queryDialog.cc:129
+#, fuzzy
+msgid "Size"
+msgstr "???"
+
 #: UI/GTK2/src/queryDialog_glade.cc:72
-msgid "New filter:"
+#, fuzzy
+msgid "New filter or range:"
 msgstr "????????"
 
 #: UI/GTK2/src/queryDialog_glade.cc:81
@@ -737,15 +741,7 @@
 msgid "Number of results:"
 msgstr "????"
 
-#: UI/GTK2/src/queryDialog_glade.cc:89
-msgid "Start date:"
-msgstr "????:"
-
-#: UI/GTK2/src/queryDialog_glade.cc:90
-msgid "End date:"
-msgstr "?????"
-
-#: UI/GTK2/src/queryDialog_glade.cc:201
+#: UI/GTK2/src/queryDialog_glade.cc:181
 msgid "Query parameters"
 msgstr "?????"
 
@@ -807,67 +803,75 @@
 msgid "Errors"
 msgstr "??"
 
-#: UI/GTK2/src/WorkerThreads.cpp:306
+#: UI/GTK2/src/WorkerThreads.cpp:307
 msgid "Can't index mail here"
 msgstr "??????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:327 UI/GTK2/src/WorkerThreads.cpp:580
+#: UI/GTK2/src/WorkerThreads.cpp:328 UI/GTK2/src/WorkerThreads.cpp:581
 msgid "is already being indexed"
 msgstr "??????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:337
+#: UI/GTK2/src/WorkerThreads.cpp:338
 msgid "is blacklisted"
 msgstr "?????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:690 UI/GTK2/src/WorkerThreads.cpp:1050
-#: UI/GTK2/src/WorkerThreads.cpp:1134 UI/GTK2/src/WorkerThreads.cpp:1143
-#: UI/GTK2/src/WorkerThreads.cpp:1329 UI/GTK2/src/WorkerThreads.cpp:1599
-#: UI/GTK2/src/WorkerThreads.cpp:1732
+#: UI/GTK2/src/WorkerThreads.cpp:691 UI/GTK2/src/WorkerThreads.cpp:1051
+#: UI/GTK2/src/WorkerThreads.cpp:1135 UI/GTK2/src/WorkerThreads.cpp:1144
+#: UI/GTK2/src/WorkerThreads.cpp:1330 UI/GTK2/src/WorkerThreads.cpp:1600
+#: UI/GTK2/src/WorkerThreads.cpp:1733
 msgid "Index error on"
 msgstr "?????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:843
+#: UI/GTK2/src/WorkerThreads.cpp:844
 msgid "No title"
 msgstr "???"
 
-#: UI/GTK2/src/WorkerThreads.cpp:945 UI/GTK2/src/WorkerThreads.cpp:1071
+#: UI/GTK2/src/WorkerThreads.cpp:946 UI/GTK2/src/WorkerThreads.cpp:1072
 msgid "Couldn't create search engine"
 msgstr "????????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:969 UI/GTK2/src/WorkerThreads.cpp:1084
+#: UI/GTK2/src/WorkerThreads.cpp:970 UI/GTK2/src/WorkerThreads.cpp:1085
 msgid "Couldn't run query on search engine"
 msgstr "??????????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1237
+#: UI/GTK2/src/WorkerThreads.cpp:1238
 msgid "Couldn't obtain downloader for protocol"
 msgstr ""
 
-#: UI/GTK2/src/WorkerThreads.cpp:1262
+#: UI/GTK2/src/WorkerThreads.cpp:1263
 msgid "Couldn't retrieve"
 msgstr "????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1359 UI/GTK2/src/WorkerThreads.cpp:1438
+#: UI/GTK2/src/WorkerThreads.cpp:1360 UI/GTK2/src/WorkerThreads.cpp:1439
 msgid "Cannot index document type"
 msgstr "????????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1363 UI/GTK2/src/WorkerThreads.cpp:1442
+#: UI/GTK2/src/WorkerThreads.cpp:1364 UI/GTK2/src/WorkerThreads.cpp:1443
 msgid "at"
 msgstr ""
 
 #. No, it isn't
-#: UI/GTK2/src/WorkerThreads.cpp:1474
+#: UI/GTK2/src/WorkerThreads.cpp:1475
 msgid "Robots META tag forbids indexing"
 msgstr "Robots?meta???????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1528
+#: UI/GTK2/src/WorkerThreads.cpp:1529
 msgid "Couldn't index"
 msgstr "????"
 
 #. Be pessimistic and assume something will go wrong ;-)
-#: UI/GTK2/src/WorkerThreads.cpp:1610
+#: UI/GTK2/src/WorkerThreads.cpp:1611
 msgid "Couldn't unindex document(s)"
 msgstr "?????????"
 
-#: UI/GTK2/src/WorkerThreads.cpp:1744
+#: UI/GTK2/src/WorkerThreads.cpp:1745
 msgid "Couldn't update document"
 msgstr "??????"
+
+#: UI/GTK2/src/WorkerThreads.cpp:1981
+msgid "No monitoring handler"
+msgstr ""
+
+#: UI/GTK2/src/WorkerThreads.cpp:2023
+msgid "Couldn't initialize file monitor"
+msgstr ""



From fabricecolin at mail.berlios.de  Mon Sep 24 14:50:18 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Mon, 24 Sep 2007 14:50:18 +0200
Subject: [Pinot-svn] r988 - in trunk/UI/GTK2: . src
Message-ID: <200709241250.l8OCoIiR015711@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-24 14:50:16 +0200 (Mon, 24 Sep 2007)
New Revision: 988

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/mainWindow_glade.cc
   trunk/UI/GTK2/src/mainWindow_glade.hh
Log:
Implemented search in results. Rather than having the user select results,
the selected query is combined with the one whose results are being shown.
The Buttons next to the queries list are replaced with ToolButtons and a
MenuToolButton.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2007-09-23 14:26:50 UTC (rev 987)
+++ trunk/UI/GTK2/metase-gtk2.glade	2007-09-24 12:50:16 UTC (rev 988)
@@ -685,7 +685,7 @@
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
 		  <property name="can_focus">True</property>
-		  <property name="expanded">False</property>
+		  <property name="expanded">True</property>
 		  <property name="spacing">0</property>
 
 		  <child>
@@ -728,131 +728,75 @@
 		      </child>
 
 		      <child>
-			<widget class="GtkVButtonBox" id="queryVbuttonbox">
+			<widget class="GtkToolbar" id="queryToolbar">
 			  <property name="visible">True</property>
-			  <property name="layout_style">GTK_BUTTONBOX_START</property>
-			  <property name="spacing">0</property>
+			  <property name="orientation">GTK_ORIENTATION_VERTICAL</property>
+			  <property name="toolbar_style">GTK_TOOLBAR_ICONS</property>
+			  <property name="tooltips">True</property>
+			  <property name="show_arrow">False</property>
 
 			  <child>
-			    <widget class="GtkButton" id="addQueryButton">
-			      <property name="border_width">4</property>
+			    <widget class="GtkToolButton" id="addQueryButton">
 			      <property agent="glademm" name="cxx_visibility">protected</property>
 			      <property name="visible">True</property>
-			      <property name="can_default">True</property>
-			      <property name="can_focus">True</property>
-			      <property name="label">gtk-add</property>
-			      <property name="use_stock">True</property>
-			      <property name="relief">GTK_RELIEF_NORMAL</property>
-			      <property name="focus_on_click">True</property>
-			      <signal name="clicked" handler="on_addQueryButton_clicked" last_modification_time="Fri, 25 Feb 2005 23:22:27 GMT"/>
+			      <property name="stock_id">gtk-add</property>
+			      <property name="visible_horizontal">True</property>
+			      <property name="visible_vertical">True</property>
+			      <property name="is_important">False</property>
+			      <signal name="clicked" handler="on_addQueryButton_clicked" last_modification_time="Mon, 24 Sep 2007 03:03:29 GMT"/>
 			    </widget>
+			    <packing>
+			      <property name="expand">False</property>
+			      <property name="homogeneous">False</property>
+			    </packing>
 			  </child>
 
 			  <child>
-			    <widget class="GtkButton" id="editQueryButton">
-			      <property name="border_width">4</property>
+			    <widget class="GtkToolButton" id="editQueryButton">
 			      <property agent="glademm" name="cxx_visibility">protected</property>
 			      <property name="visible">True</property>
-			      <property name="can_default">True</property>
-			      <property name="can_focus">True</property>
-			      <property name="relief">GTK_RELIEF_NORMAL</property>
-			      <property name="focus_on_click">True</property>
-			      <signal name="clicked" handler="on_editQueryButton_clicked" last_modification_time="Fri, 25 Feb 2005 23:22:37 GMT"/>
-
-			      <child>
-				<widget class="GtkAlignment" id="alignment26">
-				  <property name="visible">True</property>
-				  <property name="xalign">0.5</property>
-				  <property name="yalign">0.5</property>
-				  <property name="xscale">0</property>
-				  <property name="yscale">0</property>
-				  <property name="top_padding">0</property>
-				  <property name="bottom_padding">0</property>
-				  <property name="left_padding">0</property>
-				  <property name="right_padding">0</property>
-
-				  <child>
-				    <widget class="GtkHBox" id="hbox40">
-				      <property name="visible">True</property>
-				      <property name="homogeneous">False</property>
-				      <property name="spacing">2</property>
-
-				      <child>
-					<widget class="GtkImage" id="image400">
-					  <property name="visible">True</property>
-					  <property name="stock">gtk-open</property>
-					  <property name="icon_size">4</property>
-					  <property name="xalign">0.5</property>
-					  <property name="yalign">0.5</property>
-					  <property name="xpad">0</property>
-					  <property name="ypad">0</property>
-					</widget>
-					<packing>
-					  <property name="padding">0</property>
-					  <property name="expand">False</property>
-					  <property name="fill">False</property>
-					</packing>
-				      </child>
-
-				      <child>
-					<widget class="GtkLabel" id="label47">
-					  <property name="visible">True</property>
-					  <property name="label" translatable="yes">Edit</property>
-					  <property name="use_underline">True</property>
-					  <property name="use_markup">False</property>
-					  <property name="justify">GTK_JUSTIFY_LEFT</property>
-					  <property name="wrap">False</property>
-					  <property name="selectable">False</property>
-					  <property name="xalign">0.5</property>
-					  <property name="yalign">0.5</property>
-					  <property name="xpad">0</property>
-					  <property name="ypad">0</property>
-					  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-					  <property name="width_chars">-1</property>
-					  <property name="single_line_mode">False</property>
-					  <property name="angle">0</property>
-					</widget>
-					<packing>
-					  <property name="padding">0</property>
-					  <property name="expand">False</property>
-					  <property name="fill">False</property>
-					</packing>
-				      </child>
-				    </widget>
-				  </child>
-				</widget>
-			      </child>
+			      <property name="stock_id">gtk-edit</property>
+			      <property name="visible_horizontal">True</property>
+			      <property name="visible_vertical">True</property>
+			      <property name="is_important">False</property>
+			      <signal name="clicked" handler="on_editQueryButton_clicked" last_modification_time="Mon, 24 Sep 2007 03:04:25 GMT"/>
 			    </widget>
+			    <packing>
+			      <property name="expand">False</property>
+			      <property name="homogeneous">False</property>
+			    </packing>
 			  </child>
 
 			  <child>
-			    <widget class="GtkButton" id="removeQueryButton">
-			      <property name="border_width">4</property>
+			    <widget class="GtkToolButton" id="removeQueryButton">
 			      <property agent="glademm" name="cxx_visibility">protected</property>
 			      <property name="visible">True</property>
-			      <property name="can_default">True</property>
-			      <property name="can_focus">True</property>
-			      <property name="label">gtk-remove</property>
-			      <property name="use_stock">True</property>
-			      <property name="relief">GTK_RELIEF_NORMAL</property>
-			      <property name="focus_on_click">True</property>
-			      <signal name="clicked" handler="on_removeQueryButton_clicked" last_modification_time="Fri, 25 Feb 2005 23:38:42 GMT"/>
+			      <property name="stock_id">gtk-remove</property>
+			      <property name="visible_horizontal">True</property>
+			      <property name="visible_vertical">True</property>
+			      <property name="is_important">False</property>
+			      <signal name="clicked" handler="on_removeQueryButton_clicked" last_modification_time="Mon, 24 Sep 2007 03:07:13 GMT"/>
 			    </widget>
+			    <packing>
+			      <property name="expand">False</property>
+			      <property name="homogeneous">False</property>
+			    </packing>
 			  </child>
 
 			  <child>
-			    <widget class="GtkButton" id="findQueryButton">
-			      <property name="border_width">4</property>
+			    <widget class="GtkToolButton" id="findQueryButton">
 			      <property agent="glademm" name="cxx_visibility">protected</property>
 			      <property name="visible">True</property>
-			      <property name="can_default">True</property>
-			      <property name="can_focus">True</property>
-			      <property name="label">gtk-find</property>
-			      <property name="use_stock">True</property>
-			      <property name="relief">GTK_RELIEF_NORMAL</property>
-			      <property name="focus_on_click">True</property>
-			      <signal name="clicked" handler="on_findQueryButton_clicked" last_modification_time="Sat, 26 Feb 2005 13:31:59 GMT"/>
+			      <property name="stock_id">gtk-find</property>
+			      <property name="visible_horizontal">True</property>
+			      <property name="visible_vertical">True</property>
+			      <property name="is_important">False</property>
+			      <signal name="clicked" handler="on_findQueryButton_clicked" last_modification_time="Mon, 24 Sep 2007 03:07:43 GMT"/>
 			    </widget>
+			    <packing>
+			      <property name="expand">False</property>
+			      <property name="homogeneous">False</property>
+			    </packing>
 			  </child>
 			</widget>
 			<packing>

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-23 14:26:50 UTC (rev 987)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-24 12:50:16 UTC (rev 988)
@@ -160,6 +160,7 @@
 	m_pNotebook(NULL),
 	m_pIndexMenu(NULL),
 	m_pCacheMenu(NULL),
+	m_pFindMenu(NULL),
 	m_pSettingsMonitor(MonitorFactory::getMonitor()),
 	m_pSettingsHandler(NULL),
 	m_state(m_maxIndexThreads, this)
@@ -224,13 +225,12 @@
 	// Connect to the "changed" signal
 	queryTreeview->get_selection()->signal_changed().connect(
 		SigC::slot(*this, &mainWindow::on_queryTreeviewSelection_changed));
+	// Connect to the find button's "show menu" signal
+	findQueryButton->signal_show_menu().connect(
+		SigC::slot(*this, &mainWindow::populate_findMenu));
 	// Populate
 	populate_queryTreeview("");
 
-	// Populate the menus
-	populate_cacheMenu();
-	populate_indexMenu();
-
 	// Create a notebook, without any page initially
 	m_pNotebook = manage(new Notebook());
 	m_pNotebook->set_flags(Gtk::CAN_FOCUS);
@@ -278,6 +278,11 @@
 		start_thread(pSettingsMonitorThread, true);
 	}
 
+	// Populate the menus
+	populate_cacheMenu();
+	populate_indexMenu();
+	populate_findMenu();
+
 	// Now we are ready
 	set_status(_("Ready"));
 	m_pNotebook->show();
@@ -364,7 +369,7 @@
 			// Select and scroll to this query
 			TreeModel::Path queryPath = m_refQueryTree->get_path(iter);
 			queryTreeview->get_selection()->select(queryPath);
-			queryTreeview->scroll_to_row(queryPath);
+			queryTreeview->scroll_to_row(queryPath, 0.5);
 		}
 	}
 }
@@ -469,6 +474,47 @@
 }
 
 //
+// Populate the find menu
+//
+void mainWindow::populate_findMenu()
+{
+	if (m_pFindMenu == NULL)
+	{
+		m_pFindMenu = manage(new Menu());
+		findQueryButton->set_menu(*m_pFindMenu);
+	}
+	else
+	{
+		// Clear the submenu
+		m_pFindMenu->items().clear();
+	}
+
+	// Regular find, as if the button was clicked
+	m_pFindMenu->items().push_back(Menu_Helpers::MenuElem(_("In all documents")));
+	MenuItem &menuItem0 = m_pFindMenu->items().back();
+	menuItem0.signal_activate().connect(SigC::slot(*this, &mainWindow::on_findQueryButton_clicked));
+
+	// Is a results page being shown right now ?
+	NotebookPageBox *pNotebookPage = get_current_page();
+	if (pNotebookPage != NULL)
+	{
+		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
+		if (pResultsPage != NULL)
+		{
+			ustring findMenuItem(_("In all results of"));
+
+			findMenuItem += " ";
+			findMenuItem += pResultsPage->getTitle();
+
+			// Find and combine with the query whose results are being shown
+			m_pFindMenu->items().push_back(Menu_Helpers::MenuElem(findMenuItem));
+			MenuItem &menuItem = m_pFindMenu->items().back();
+			menuItem.signal_activate().connect(SigC::slot(*this, &mainWindow::on_find_changed));
+		}
+	}
+}
+
+//
 // Add a query
 //
 void mainWindow::add_query(QueryProperties &queryProps, bool mergeQueries)
@@ -508,26 +554,96 @@
 }
 
 //
+// Get selected results in the current results tab
+//
+bool mainWindow::get_results_page_details(QueryProperties &queryProps, set<string> &locations)
+{
+	vector<DocumentInfo> resultsList;
+	ustring queryName;
+
+	locations.clear();
+
+	NotebookPageBox *pNotebookPage = get_current_page();
+	if (pNotebookPage != NULL)
+	{
+		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
+		if (pResultsPage != NULL)
+		{
+			ResultsTree *pResultsTree = pResultsPage->getTree();
+			if (pResultsTree != NULL)
+			{
+				pResultsTree->getSelection(resultsList);
+			}
+
+			queryName = pResultsPage->getTitle();
+		}
+	}
+
+	if (queryName.empty() == true)
+	{
+		return false;
+	}
+
+	// Find this query
+	if (queryName == _("Live query"))
+	{
+		queryProps.setName(queryName);
+		queryProps.setFreeQuery(liveQueryEntry->get_text());
+	}
+	else
+	{
+		bool foundQuery = false;
+
+		TreeModel::Children children = m_refQueryTree->children();
+		for (TreeModel::Children::iterator iter = children.begin();
+			iter != children.end(); ++iter)
+		{
+			TreeModel::Row row = *iter;
+
+			if (queryName == from_utf8(row[m_queryColumns.m_name]))
+			{
+				queryProps = row[m_queryColumns.m_properties];
+				foundQuery = true;
+				break;
+			}
+		}
+
+		if (foundQuery == false)
+		{
+			return false;
+		}
+	}
+
+	for (vector<DocumentInfo>::const_iterator docIter = resultsList.begin();
+		docIter != resultsList.end(); ++docIter)
+	{
+		if (docIter->getIsIndexed() == true)
+		{
+			locations.insert(docIter->getLocation());
+		}
+	}
+
+	return true;
+}
+
+//
 // Query list selection changed
 //
 void mainWindow::on_queryTreeviewSelection_changed()
 {
+	bool enableButtons = false;
+
 	TreeModel::iterator iter = queryTreeview->get_selection()->get_selected();
 	// Anything selected ?
 	if (iter)
 	{
-		// Enable those
-		editQueryButton->set_sensitive(true);
-		removeQueryButton->set_sensitive(true);
-		findQueryButton->set_sensitive(true);
+		// Enable all buttons
+		enableButtons = true;
 	}
-	else
-	{
-		// Disable those
-		editQueryButton->set_sensitive(false);
-		removeQueryButton->set_sensitive(false);
-		findQueryButton->set_sensitive(false);
-	}
+
+	editQueryButton->set_sensitive(enableButtons);
+	removeQueryButton->set_sensitive(enableButtons);
+	findQueryButton->set_sensitive(enableButtons);
 }
 
 //
@@ -855,7 +971,46 @@
 	}
 }
 
+//
+// Stored queries' Find menu selected
+//
+void mainWindow::on_find_changed()
+{
+	QueryProperties currentQueryProps;
+	set<string> locations;
 
+	if (get_results_page_details(currentQueryProps, locations) == false)
+	{
+		// No query and/or results found, run the search as per normal
+		on_findQueryButton_clicked();
+		return;
+	}
+
+	TreeModel::iterator queryIter = queryTreeview->get_selection()->get_selected();
+	// Anything selected ?
+	if (queryIter)
+	{
+		TreeModel::Row queryRow = *queryIter;
+		QueryProperties queryProps = queryRow[m_queryColumns.m_properties];
+		ustring queryName(queryProps.getName());
+		string queryStr(queryProps.getFreeQuery());
+		time_t lastRunTime = time(NULL);
+
+		// Combine both queries
+		queryProps.setName(queryName + " " + _("in") + " " + currentQueryProps.getName());
+		queryProps.setFreeQuery("(" + currentQueryProps.getFreeQuery() + ") + (" + queryStr + ")");
+#ifdef DEBUG
+		cout << "mainWindow::on_find_changed: combined into " << queryProps.getFreeQuery() << endl;
+#endif
+
+		run_search(queryProps);
+
+		// Update the Last Run column
+		queryRow[m_queryColumns.m_lastRun] = to_utf8(TimeConverter::toTimestamp(lastRunTime));
+		queryRow[m_queryColumns.m_lastRunTime] = lastRunTime;
+	}
+}
+
 //
 // Index queries combo selection changed
 //
@@ -1919,68 +2074,20 @@
 void mainWindow::on_morelikethis_activate()
 {
 	QueryProperties queryProps;
-	vector<DocumentInfo> resultsList;
-	ustring queryName;
+	set<string> locations;
 
-	NotebookPageBox *pNotebookPage = get_current_page();
-	if (pNotebookPage != NULL)
+	if (get_results_page_details(queryProps, locations) == false)
 	{
-		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-		if (pResultsPage != NULL)
-		{
-			ResultsTree *pResultsTree = pResultsPage->getTree();
-			if (pResultsTree != NULL)
-			{
-				pResultsTree->getSelection(resultsList);
-			}
-
-			queryName = pResultsPage->getTitle();
-		}
-	}
-
-	// Find this query
-	if (queryName == _("Live query"))
-	{
-		queryProps.setName(queryName);
-		queryProps.setFreeQuery(liveQueryEntry->get_text());
-	}
-	else
-	{
-		bool foundQuery = false;
-
-		TreeModel::Children children = m_refQueryTree->children();
-		for (TreeModel::Children::iterator iter = children.begin();
-			iter != children.end(); ++iter)
-		{
-			TreeModel::Row row = *iter;
-
-			if (queryName == from_utf8(row[m_queryColumns.m_name]))
-			{
-				queryProps = row[m_queryColumns.m_properties];
-				foundQuery = true;
-				break;
-			}
-		}
-
 		// Maybe the query was deleted
-		if (foundQuery == false)
+		if (queryProps.getName().empty() == false)
 		{
 			ustring status(_("Couldn't find query"));
 			status += " ";
-			status += queryName;
+			status += queryProps.getName();
 			set_status(status);
-			return;
 		}
-	}
 
-	set<string> locations;
-	for (vector<DocumentInfo>::const_iterator docIter = resultsList.begin();
-		docIter != resultsList.end(); ++docIter)
-	{
-		if (docIter->getIsIndexed() == true)
-		{
-			locations.insert(docIter->getLocation());
-		}
+		return;
 	}
 
 	if (locations.empty() == false)

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2007-09-23 14:26:50 UTC (rev 987)
+++ trunk/UI/GTK2/src/mainWindow.hh	2007-09-24 12:50:16 UTC (rev 988)
@@ -62,7 +62,9 @@
 	void save_queryTreeview();
 	void populate_cacheMenu();
 	void populate_indexMenu();
+	void populate_findMenu();
 	void add_query(QueryProperties &queryProps, bool mergeQueries);
+	bool get_results_page_details(QueryProperties &queryProps, std::set<std::string> &locations);
 
 	// Handlers
 	void on_enginesTreeviewSelection_changed();
@@ -71,6 +73,7 @@
 	void on_indexTreeviewSelection_changed(Glib::ustring indexName);
 	void on_index_changed(Glib::ustring indexName);
 	void on_cache_changed(PinotSettings::CacheProvider cacheProvider);
+	void on_find_changed();
 	void on_query_changed(Glib::ustring indexName, Glib::ustring queryName);
 	void on_switch_page(GtkNotebookPage *p0, guint p1);
 	void on_close_page(Glib::ustring title, NotebookPageBox::PageType type);
@@ -155,9 +158,11 @@
 	Glib::RefPtr<Gtk::ListStore> m_refQueryTree;
 	// Notebook
 	Gtk::Notebook *m_pNotebook;
-	// Index
+	// Menus
 	Gtk::Menu *m_pIndexMenu;
 	Gtk::Menu *m_pCacheMenu;
+	Gtk::Menu *m_pFindMenu;
+	// Index
 	ComboModelColumns m_indexNameColumns;
 	Glib::RefPtr<Gtk::ListStore> m_refIndexNameTree;
 	// Tooltips

Modified: trunk/UI/GTK2/src/mainWindow_glade.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.cc	2007-09-23 14:26:50 UTC (rev 987)
+++ trunk/UI/GTK2/src/mainWindow_glade.cc	2007-09-24 12:50:16 UTC (rev 988)
@@ -1,9 +1,9 @@
-// generated 2007/4/21 16:02:01 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/24 20:22:15 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.8 and gtkmm 2.10.7
+// for gtk 2.10.14 and gtkmm 2.10.11
 //
 // Please modify the corresponding derived classes in ./src/mainWindow.cc
 
@@ -46,7 +46,8 @@
 #include <gtkmm/label.h>
 #include <gtkmm/buttonbox.h>
 #include <gtkmm/scrolledwindow.h>
-#include <gtkmm/alignment.h>
+#include <gtkmm/stockid.h>
+#include <gtkmm/toolbar.h>
 #ifndef ENABLE_NLS
 #  define textdomain(String) (String)
 #  define gettext(String) (String)
@@ -132,24 +133,15 @@
    queryTreeview = Gtk::manage(new class Gtk::TreeView());
    
    Gtk::ScrolledWindow *queryScrolledwindow = Gtk::manage(new class Gtk::ScrolledWindow());
-   addQueryButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-add")));
+   addQueryButton = Gtk::manage(new class Gtk::ToolButton(Gtk::StockID("gtk-add")));
+   editQueryButton = Gtk::manage(new class Gtk::ToolButton(Gtk::StockID("gtk-edit")));
+   removeQueryButton = Gtk::manage(new class Gtk::ToolButton(Gtk::StockID("gtk-remove")));
+   findQueryButton = Gtk::manage(new class Gtk::MenuToolButton(Gtk::StockID("gtk-find")));
    
-   Gtk::Image *image400 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(4)));
-   Gtk::Label *label47 = Gtk::manage(new class Gtk::Label(_("Edit")));
-   Gtk::HBox *hbox40 = Gtk::manage(new class Gtk::HBox(false, 2));
-   Gtk::Alignment *alignment26 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
-   editQueryButton = Gtk::manage(new class Gtk::Button());
-   removeQueryButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-remove")));
-   findQueryButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-find")));
-   
-   Gtk::VButtonBox *queryVbuttonbox = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
+   Gtk::Toolbar *queryToolbar = Gtk::manage(new class Gtk::Toolbar());
    Gtk::HBox *queryHbox = Gtk::manage(new class Gtk::HBox(false, 0));
    Gtk::Label *queryLabel = Gtk::manage(new class Gtk::Label(_("Stored queries")));
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
    queryExpander = Gtk::manage(new class Gtk::Expander());
-#else //
-   queryExpander = Gtk::manage(new class Gtk::HandleBox());
-#endif //
    rightVbox = Gtk::manage(new class Gtk::VBox(false, 0));
    mainHpaned = Gtk::manage(new class Gtk::HPaned());
    mainProgressbar = Gtk::manage(new class Gtk::ProgressBar());
@@ -253,6 +245,10 @@
    
    mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Help"), *helpMenuitem_menu));
    helpMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
+   queryToolbar->append(*addQueryButton);
+   queryToolbar->append(*editQueryButton);
+   queryToolbar->append(*removeQueryButton);
+   queryToolbar->append(*findQueryButton);
    showextract1->set_active(true);
    searchenginegroup1->set_active(true);
    hostnamegroup1->set_active(false);
@@ -331,44 +327,42 @@
    queryScrolledwindow->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
    queryScrolledwindow->property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
    queryScrolledwindow->add(*queryTreeview);
-   addQueryButton->set_flags(Gtk::CAN_FOCUS);
-   addQueryButton->set_flags(Gtk::CAN_DEFAULT);
-   addQueryButton->set_border_width(4);
-   addQueryButton->set_relief(Gtk::RELIEF_NORMAL);
-   image400->set_alignment(0.5,0.5);
-   image400->set_padding(0,0);
-   label47->set_alignment(0.5,0.5);
-   label47->set_padding(0,0);
-   label47->set_justify(Gtk::JUSTIFY_LEFT);
-   label47->set_line_wrap(false);
-   label47->set_use_markup(false);
-   label47->set_selectable(false);
-   label47->set_ellipsize(Pango::ELLIPSIZE_NONE);
-   label47->set_width_chars(-1);
-   label47->set_angle(0);
-   label47->set_single_line_mode(false);
-   hbox40->pack_start(*image400, Gtk::PACK_SHRINK, 0);
-   hbox40->pack_start(*label47, Gtk::PACK_SHRINK, 0);
-   alignment26->add(*hbox40);
-   editQueryButton->set_flags(Gtk::CAN_FOCUS);
-   editQueryButton->set_flags(Gtk::CAN_DEFAULT);
-   editQueryButton->set_border_width(4);
-   editQueryButton->set_relief(Gtk::RELIEF_NORMAL);
-   editQueryButton->add(*alignment26);
-   removeQueryButton->set_flags(Gtk::CAN_FOCUS);
-   removeQueryButton->set_flags(Gtk::CAN_DEFAULT);
-   removeQueryButton->set_border_width(4);
-   removeQueryButton->set_relief(Gtk::RELIEF_NORMAL);
-   findQueryButton->set_flags(Gtk::CAN_FOCUS);
-   findQueryButton->set_flags(Gtk::CAN_DEFAULT);
-   findQueryButton->set_border_width(4);
-   findQueryButton->set_relief(Gtk::RELIEF_NORMAL);
-   queryVbuttonbox->pack_start(*addQueryButton);
-   queryVbuttonbox->pack_start(*editQueryButton);
-   queryVbuttonbox->pack_start(*removeQueryButton);
-   queryVbuttonbox->pack_start(*findQueryButton);
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
+   addQueryButton->set_visible_horizontal(true);
+   addQueryButton->set_visible_vertical(true);
+   addQueryButton->set_is_important(false);
+   addQueryButton->set_homogeneous(false);
+   addQueryButton->set_expand(false);
+#endif //
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
+   editQueryButton->set_visible_horizontal(true);
+   editQueryButton->set_visible_vertical(true);
+   editQueryButton->set_is_important(false);
+   editQueryButton->set_homogeneous(false);
+   editQueryButton->set_expand(false);
+#endif //
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
+   removeQueryButton->set_visible_horizontal(true);
+   removeQueryButton->set_visible_vertical(true);
+   removeQueryButton->set_is_important(false);
+   removeQueryButton->set_homogeneous(false);
+   removeQueryButton->set_expand(false);
+#endif //
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
+   findQueryButton->set_visible_horizontal(true);
+   findQueryButton->set_visible_vertical(true);
+   findQueryButton->set_is_important(false);
+   findQueryButton->set_homogeneous(false);
+   findQueryButton->set_expand(false);
+#endif //
+   queryToolbar->set_tooltips(true);
+   queryToolbar->set_toolbar_style(Gtk::TOOLBAR_ICONS);
+   queryToolbar->set_orientation(Gtk::ORIENTATION_VERTICAL);
+#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
+   queryToolbar->set_show_arrow(false);
+#endif //
    queryHbox->pack_start(*queryScrolledwindow);
-   queryHbox->pack_start(*queryVbuttonbox, Gtk::PACK_SHRINK, 0);
+   queryHbox->pack_start(*queryToolbar, Gtk::PACK_SHRINK, 0);
    queryLabel->set_alignment(0.5,0.5);
    queryLabel->set_padding(0,0);
    queryLabel->set_justify(Gtk::JUSTIFY_LEFT);
@@ -381,7 +375,7 @@
    queryLabel->set_single_line_mode(false);
    queryExpander->set_flags(Gtk::CAN_FOCUS);
 #if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
-   queryExpander->set_expanded(false);
+   queryExpander->set_expanded(true);
    queryExpander->set_spacing(0);
 #endif //
    queryExpander->add(*queryHbox);
@@ -462,14 +456,10 @@
    queryTreeview->show();
    queryScrolledwindow->show();
    addQueryButton->show();
-   image400->show();
-   label47->show();
-   hbox40->show();
-   alignment26->show();
    editQueryButton->show();
    removeQueryButton->show();
    findQueryButton->show();
-   queryVbuttonbox->show();
+   queryToolbar->show();
    queryHbox->show();
    queryLabel->show();
    queryExpander->show();

Modified: trunk/UI/GTK2/src/mainWindow_glade.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.hh	2007-09-23 14:26:50 UTC (rev 987)
+++ trunk/UI/GTK2/src/mainWindow_glade.hh	2007-09-24 12:50:16 UTC (rev 988)
@@ -1,9 +1,9 @@
-// generated 2007/4/17 21:14:18 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/24 20:22:15 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
 // glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.8 and gtkmm 2.10.7
+// for gtk 2.10.14 and gtkmm 2.10.11
 //
 // Please modify the corresponding derived classes in ./src/mainWindow.hh and./src/mainWindow.cc
 
@@ -41,11 +41,10 @@
 #include <gtkmm/togglebutton.h>
 #include <gtkmm/entry.h>
 #include <gtkmm/treeview.h>
+#include <gtkmm/toolbutton.h>
+#include <gtkmm/menutoolbutton.h>
 #include <gtkmm/handlebox.h>
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
 #include <gtkmm/expander.h>
-#else //
-#endif //
 #include <gtkmm/paned.h>
 #include <gtkmm/progressbar.h>
 #include <gtkmm/statusbar.h>
@@ -94,15 +93,11 @@
         class Gtk::Entry * liveQueryEntry;
         class Gtk::Button * findButton;
         class Gtk::TreeView * queryTreeview;
-        class Gtk::Button * addQueryButton;
-        class Gtk::Button * editQueryButton;
-        class Gtk::Button * removeQueryButton;
-        class Gtk::Button * findQueryButton;
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
+        class Gtk::ToolButton * addQueryButton;
+        class Gtk::ToolButton * editQueryButton;
+        class Gtk::ToolButton * removeQueryButton;
+        class Gtk::MenuToolButton * findQueryButton;
         class Gtk::Expander * queryExpander;
-#else //
-        class Gtk::HandleBox * queryExpander;
-#endif //
         class Gtk::VBox * rightVbox;
         class Gtk::HPaned * mainHpaned;
         class Gtk::ProgressBar * mainProgressbar;



From fabricecolin at mail.berlios.de  Tue Sep 25 15:29:33 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 25 Sep 2007 15:29:33 +0200
Subject: [Pinot-svn] r989 - trunk/Search
Message-ID: <200709251329.l8PDTX2P014175@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-25 15:29:33 +0200 (Tue, 25 Sep 2007)
New Revision: 989

Modified:
   trunk/Search/SearchEngineInterface.cpp
   trunk/Search/SearchEngineInterface.h
   trunk/Search/XapianEngine.cpp
   trunk/Search/XapianEngine.h
Log:
Reworked query expansion a tad. We now use an ExpandDecider, and capitalized
terms as well as subject terms are not skipped.


Modified: trunk/Search/SearchEngineInterface.cpp
===================================================================
--- trunk/Search/SearchEngineInterface.cpp	2007-09-24 12:50:16 UTC (rev 988)
+++ trunk/Search/SearchEngineInterface.cpp	2007-09-25 13:29:33 UTC (rev 989)
@@ -42,8 +42,8 @@
 	m_key = key;
 }
 
-/// Sets whether the query should be expanded.
-bool SearchEngineInterface::setQueryExpansion(set<unsigned int> &relevantDocuments)
+/// Sets the set of documents to expand from.
+bool SearchEngineInterface::setExpandSet(const set<unsigned int> &docsSet)
 {
 	// Not all engines support this
 	return false;

Modified: trunk/Search/SearchEngineInterface.h
===================================================================
--- trunk/Search/SearchEngineInterface.h	2007-09-24 12:50:16 UTC (rev 988)
+++ trunk/Search/SearchEngineInterface.h	2007-09-25 13:29:33 UTC (rev 989)
@@ -39,8 +39,8 @@
 		/// Sets the search engine's key, if applicable.
 		virtual void setKey(const string &key);
 
-		/// Sets whether the query should be expanded.
-		virtual bool setQueryExpansion(set<unsigned int> &relevantDocuments);
+		/// Sets the set of documents to expand from.
+		virtual bool setExpandSet(const set<unsigned int> &docsSet);
 
 		typedef enum { DEFAULT_OP_AND = 0, DEFAULT_OP_OR } DefaultOperator;
 

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2007-09-24 12:50:16 UTC (rev 988)
+++ trunk/Search/XapianEngine.cpp	2007-09-25 13:29:33 UTC (rev 989)
@@ -82,9 +82,10 @@
 class TimeValueRangeProcessor : public Xapian::ValueRangeProcessor
 {
 	public:
-		TimeValueRangeProcessor(Xapian::valueno valno) : Xapian::ValueRangeProcessor(), m_valueNumber(valno) { }
+		TimeValueRangeProcessor(Xapian::valueno valueNumber) : Xapian::ValueRangeProcessor(), m_valueNumber(valueNumber) { }
+		~TimeValueRangeProcessor() { }
 
-		Xapian::valueno operator()(string &begin, string &end)
+		virtual Xapian::valueno operator()(string &begin, string &end)
 		{
 			if ((begin.size() == 6) &&
 					(end.size() == 6))
@@ -121,6 +122,31 @@
 
 };
 
+class PrefixDecider : public Xapian::ExpandDecider
+{
+	public:
+		PrefixDecider(const string &allowedPrefixes) : Xapian::ExpandDecider(), m_allowedPrefixes(allowedPrefixes) { }
+		~PrefixDecider() { }
+
+		virtual bool operator()(const std::string &term) const
+		{
+			if ((isupper((int)(term[0])) == 0) ||
+				(m_allowedPrefixes.find(term[0]) != string::npos))
+			{
+				return true;
+			}
+#ifdef DEBUG
+			cout << "PrefixDecider::operator: rejecting " << term << endl;
+#endif
+
+			return false;
+		}
+
+	protected:
+		string m_allowedPrefixes;
+
+};
+
 XapianEngine::XapianEngine(const string &database) :
 	SearchEngineInterface()
 {
@@ -363,7 +389,7 @@
 		{
 			m_resultsCountEstimate = matches.get_matches_estimated();
 #ifdef DEBUG
-			cout << "XapianEngine::queryDatabase: " << m_resultsCountEstimate << "/"
+			cout << "XapianEngine::queryDatabase: " << matches.size() << "/" << m_resultsCountEstimate << "/"
 				<< maxResultsCount << " results found from position " << startDoc << endl;
 #endif
 
@@ -418,27 +444,38 @@
 		m_expandTerms.clear();
 
 		// Expand the query ?
-		if (m_relevantDocuments.empty() == false)
+		if (m_expandDocuments.empty() == false)
 		{
-			Xapian::RSet relevantDocs;
+			Xapian::RSet expandDocs;
 			unsigned int count = 0;
 
-			for (set<unsigned int>::const_iterator docIter = m_relevantDocuments.begin();
-				docIter != m_relevantDocuments.end(); ++docIter)
+			for (set<unsigned int>::const_iterator docIter = m_expandDocuments.begin();
+				docIter != m_expandDocuments.end(); ++docIter)
 			{
-				relevantDocs.add_document(*docIter);
+				expandDocs.add_document(*docIter);
 			}
 
 			// Get 10 non-prefixed terms
-			Xapian::ESet expandTerms = enquire.get_eset(20, relevantDocs);
+			PrefixDecider expandDecider("RS");
+			Xapian::ESet expandTerms = enquire.get_eset(20, expandDocs, &expandDecider);
+#ifdef DEBUG
+			cout << "XapianEngine::queryDatabase: " << expandTerms.size() << " expand terms" << endl;
+#endif
 			for (Xapian::ESetIterator termIter = expandTerms.begin();
 				(termIter != expandTerms.end()) && (count < 10); ++termIter)
 			{
-				if (isupper((int)((*termIter)[0])) == 0)
+				char firstChar = (*termIter)[0];
+
+				if ((firstChar == 'R') ||
+					(firstChar == 'S'))
 				{
+					m_expandTerms.insert((*termIter).substr(1));
+				}
+				else
+				{
 					m_expandTerms.insert(*termIter);
-					++count;
 				}
+				++count;
 			}
 		}
 	}
@@ -461,11 +498,14 @@
 // Implementation of SearchEngineInterface
 //
 
-/// Sets whether the query should be expanded.
-bool XapianEngine::setQueryExpansion(set<unsigned int> &relevantDocuments)
+/// Sets the set of documents to expand from.
+bool XapianEngine::setExpandSet(const set<unsigned int> &docsSet)
 {
-	copy(relevantDocuments.begin(), relevantDocuments.end(),
-		inserter(m_relevantDocuments, m_relevantDocuments.begin()));
+	copy(docsSet.begin(), docsSet.end(),
+		inserter(m_expandDocuments, m_expandDocuments.begin()));
+#ifdef DEBUG
+	cout << "XapianEngine::setExpandSet: " << m_expandDocuments.size() << " documents" << endl;
+#endif
 
 	return true;
 }

Modified: trunk/Search/XapianEngine.h
===================================================================
--- trunk/Search/XapianEngine.h	2007-09-24 12:50:16 UTC (rev 988)
+++ trunk/Search/XapianEngine.h	2007-09-25 13:29:33 UTC (rev 989)
@@ -50,8 +50,8 @@
 		XapianEngine(const std::string &database);
 		virtual ~XapianEngine();
 
-		/// Sets whether the query should be expanded.
-		bool setQueryExpansion(std::set<unsigned int> &relevantDocuments);
+		/// Sets the set of documents to expand from.
+		virtual bool setExpandSet(const std::set<unsigned int> &docsSet);
 
 		/// Runs a query; true if success.
 		virtual bool runQuery(QueryProperties& queryProps,
@@ -59,7 +59,7 @@
 
 	protected:
 		std::string m_databaseName;
-		std::set<unsigned int> m_relevantDocuments;
+		std::set<Xapian::docid> m_expandDocuments;
 
 		bool queryDatabase(Xapian::Database *pIndex, Xapian::Query &query,
 			unsigned int startDoc, unsigned int maxResultsCount);



From fabricecolin at mail.berlios.de  Tue Sep 25 15:32:15 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 25 Sep 2007 15:32:15 +0200
Subject: [Pinot-svn] r990 - trunk/UI/GTK2/src
Message-ID: <200709251332.l8PDWFg3014496@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-25 15:32:14 +0200 (Tue, 25 Sep 2007)
New Revision: 990

Modified:
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
Log:
Synced with changes to query expansion.


Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-25 13:29:33 UTC (rev 989)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-25 13:32:14 UTC (rev 990)
@@ -69,6 +69,34 @@
 	}
 };
 
+static string locationsToMergedIndexIds(const set<string> &locations, set<unsigned int> &docIds)
+{
+	IndexInterface *pIndex = PinotSettings::getInstance().getIndex("MERGED");
+
+	if ((pIndex == NULL) ||
+		(pIndex->isGood() == false))
+	{
+		string status(_("Index error on"));
+		status += " MERGED";
+		if (pIndex != NULL)
+		{
+			delete pIndex;
+		}
+		return status;
+	}
+
+	for (set<string>::iterator locationIter = locations.begin();
+		locationIter != locations.end(); ++locationIter)
+	{
+		unsigned int docId = pIndex->hasDocument(*locationIter);
+		docIds.insert(docId);
+	}
+
+	delete pIndex;
+
+	return "";
+}
+
 Dispatcher WorkerThread::m_dispatcher;
 pthread_mutex_t WorkerThread::m_dispatcherMutex = PTHREAD_MUTEX_INITIALIZER;
 bool WorkerThread::m_immediateFlush = true;
@@ -764,7 +792,7 @@
 	m_correctedSpelling(false)
 {
 #ifdef DEBUG
-	cout << "QueryingThread::QueryingThread: engine " << m_engineName << ", " << engineOption
+	cout << "QueryingThread::QueryingThread: engine " << m_engineName << ", " << m_engineOption
 		<< ", mode " << m_listingIndex << endl;
 #endif
 }
@@ -1007,12 +1035,12 @@
 }
 
 ExpandQueryThread::ExpandQueryThread(const QueryProperties &queryProps,
-	const set<string> &relevantDocs) :
+	const set<string> &expandFromDocsSet) :
 	WorkerThread(),
 	m_queryProps(queryProps)
 {
-	copy(relevantDocs.begin(), relevantDocs.end(),
-		inserter(m_relevantDocs, m_relevantDocs.begin()));
+	// Get the IDs of the documents to expand from
+	m_status = locationsToMergedIndexIds(expandFromDocsSet, m_docIdsSet);
 }
 
 ExpandQueryThread::~ExpandQueryThread()
@@ -1042,29 +1070,12 @@
 
 void ExpandQueryThread::doWork(void)
 {
-	IndexInterface *pIndex = PinotSettings::getInstance().getIndex("MERGED");
-	set<unsigned int> relevantDocIds;
-
-	if ((pIndex == NULL) ||
-		(pIndex->isGood() == false))
+	// Did locationsToMergedIndexIds() fail ?
+	if (m_status.empty() == false)
 	{
-		m_status = _("Index error on");
-		m_status += " MERGED";
-		if (pIndex != NULL)
-		{
-			delete pIndex;
-		}
 		return;
 	}
 
-	for (set<string>::iterator locationIter = m_relevantDocs.begin();
-		locationIter != m_relevantDocs.end(); ++locationIter)
-	{
-		relevantDocIds.insert(pIndex->hasDocument(*locationIter));
-	}
-
-	delete pIndex;
-
 	// Get the SearchEngine
 	SearchEngineInterface *pEngine = SearchEngineFactory::getSearchEngine("xapian", "MERGED");
 	if (pEngine == NULL)
@@ -1075,8 +1086,8 @@
 		return;
 	}
 
-	// Set whether to expand the query
-	pEngine->setQueryExpansion(relevantDocIds);
+	// Expand the query
+	pEngine->setExpandSet(m_docIdsSet);
 
 	// Run the query
 	pEngine->setDefaultOperator(SearchEngineInterface::DEFAULT_OP_AND);

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2007-09-25 13:29:33 UTC (rev 989)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2007-09-25 13:32:14 UTC (rev 990)
@@ -249,7 +249,7 @@
 {
 	public:
 		ExpandQueryThread(const QueryProperties &queryProps,
-			const std::set<std::string> &relevantDocs);
+			const std::set<std::string> &expandFromDocsSet);
 		virtual ~ExpandQueryThread();
 
 		virtual std::string getType(void) const;
@@ -262,7 +262,7 @@
 
 	protected:
 		QueryProperties m_queryProps;
-		std::set<std::string> m_relevantDocs;
+		std::set<unsigned int> m_docIdsSet;
 		std::set<std::string> m_expandTerms;
 
 		virtual void doWork(void);



From fabricecolin at mail.berlios.de  Tue Sep 25 15:40:01 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Tue, 25 Sep 2007 15:40:01 +0200
Subject: [Pinot-svn] r991 - in trunk/UI/GTK2: . src
Message-ID: <200709251340.l8PDe1kV015021@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-25 15:40:00 +0200 (Tue, 25 Sep 2007)
New Revision: 991

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/mainWindow_glade.cc
   trunk/UI/GTK2/src/mainWindow_glade.hh
Log:
Backtracked previous UI changes. I realized that combining queries is not that
useful. Users can do that manually with copy-and-paste already.
Now there's a Search Again For menuitem that runs a specific query against
currently selected (indexed) results.
Removed the Edit query button, edits are done on a double-click. Added tooltips.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2007-09-25 13:32:14 UTC (rev 990)
+++ trunk/UI/GTK2/metase-gtk2.glade	2007-09-25 13:40:00 UTC (rev 991)
@@ -176,7 +176,7 @@
 			      <property name="visible">True</property>
 			      <property name="label" translatable="yes">Search Engine</property>
 			      <property name="use_underline">True</property>
-			      <property name="active">True</property>
+			      <property name="active">False</property>
 			      <signal name="activate" handler="on_groupresults_activate" last_modification_time="Sat, 28 Feb 2004 17:56:26 GMT"/>
 			    </widget>
 			  </child>
@@ -187,7 +187,7 @@
 			      <property name="visible">True</property>
 			      <property name="label" translatable="yes">Host Name</property>
 			      <property name="use_underline">True</property>
-			      <property name="active">False</property>
+			      <property name="active">True</property>
 			      <property name="group">searchenginegroup1</property>
 			    </widget>
 			  </child>
@@ -215,7 +215,7 @@
 		      <signal name="activate" handler="on_clearresults_activate" last_modification_time="Wed, 03 Mar 2004 19:51:48 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image701">
+			<widget class="GtkImage" id="image718">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-clear</property>
 			  <property name="icon_size">1</property>
@@ -262,8 +262,29 @@
 		      <signal name="activate" handler="on_morelikethis_activate" last_modification_time="Sun, 18 Jun 2006 10:50:56 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image702">
+			<widget class="GtkImage" id="image719">
 			  <property name="visible">True</property>
+			  <property name="stock">gtk-add</property>
+			  <property name="icon_size">1</property>
+			  <property name="xalign">0.5</property>
+			  <property name="yalign">0.5</property>
+			  <property name="xpad">0</property>
+			  <property name="ypad">0</property>
+			</widget>
+		      </child>
+		    </widget>
+		  </child>
+
+		  <child>
+		    <widget class="GtkImageMenuItem" id="searchagain1">
+		      <property agent="glademm" name="cxx_visibility">protected</property>
+		      <property name="visible">True</property>
+		      <property name="label" translatable="yes">Search This For</property>
+		      <property name="use_underline">True</property>
+
+		      <child internal-child="image">
+			<widget class="GtkImage" id="image720">
+			  <property name="visible">True</property>
 			  <property name="stock">gtk-find</property>
 			  <property name="icon_size">1</property>
 			  <property name="xalign">0.5</property>
@@ -317,7 +338,7 @@
 		      <signal name="activate" handler="on_import_activate" last_modification_time="Tue, 02 Mar 2004 22:13:44 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image703">
+			<widget class="GtkImage" id="image721">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-open</property>
 			  <property name="icon_size">1</property>
@@ -355,7 +376,7 @@
 		      <signal name="activate" handler="on_refreshindex_activate" last_modification_time="Fri, 20 Feb 2004 18:57:09 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image704">
+			<widget class="GtkImage" id="image722">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-refresh</property>
 			  <property name="icon_size">1</property>
@@ -377,7 +398,7 @@
 		      <signal name="activate" handler="on_unindex_activate" last_modification_time="Thu, 28 Jul 2005 12:42:23 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image705">
+			<widget class="GtkImage" id="image723">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-delete</property>
 			  <property name="icon_size">1</property>
@@ -399,7 +420,7 @@
 		      <signal name="activate" handler="on_showfromindex_activate" last_modification_time="Sun, 06 Nov 2005 08:43:05 GMT"/>
 
 		      <child internal-child="image">
-			<widget class="GtkImage" id="image706">
+			<widget class="GtkImage" id="image724">
 			  <property name="visible">True</property>
 			  <property name="stock">gtk-properties</property>
 			  <property name="icon_size">1</property>
@@ -728,76 +749,55 @@
 		      </child>
 
 		      <child>
-			<widget class="GtkToolbar" id="queryToolbar">
+			<widget class="GtkVButtonBox" id="queryVbuttonbox">
 			  <property name="visible">True</property>
-			  <property name="orientation">GTK_ORIENTATION_VERTICAL</property>
-			  <property name="toolbar_style">GTK_TOOLBAR_ICONS</property>
-			  <property name="tooltips">True</property>
-			  <property name="show_arrow">False</property>
+			  <property name="layout_style">GTK_BUTTONBOX_START</property>
+			  <property name="spacing">0</property>
 
 			  <child>
-			    <widget class="GtkToolButton" id="addQueryButton">
+			    <widget class="GtkButton" id="addQueryButton">
+			      <property name="border_width">4</property>
 			      <property agent="glademm" name="cxx_visibility">protected</property>
 			      <property name="visible">True</property>
-			      <property name="stock_id">gtk-add</property>
-			      <property name="visible_horizontal">True</property>
-			      <property name="visible_vertical">True</property>
-			      <property name="is_important">False</property>
-			      <signal name="clicked" handler="on_addQueryButton_clicked" last_modification_time="Mon, 24 Sep 2007 03:03:29 GMT"/>
+			      <property name="can_default">True</property>
+			      <property name="can_focus">True</property>
+			      <property name="label">gtk-add</property>
+			      <property name="use_stock">True</property>
+			      <property name="relief">GTK_RELIEF_NORMAL</property>
+			      <property name="focus_on_click">True</property>
+			      <signal name="clicked" handler="on_addQueryButton_clicked" last_modification_time="Fri, 25 Feb 2005 23:22:27 GMT"/>
 			    </widget>
-			    <packing>
-			      <property name="expand">False</property>
-			      <property name="homogeneous">False</property>
-			    </packing>
 			  </child>
 
 			  <child>
-			    <widget class="GtkToolButton" id="editQueryButton">
+			    <widget class="GtkButton" id="removeQueryButton">
+			      <property name="border_width">4</property>
 			      <property agent="glademm" name="cxx_visibility">protected</property>
 			      <property name="visible">True</property>
-			      <property name="stock_id">gtk-edit</property>
-			      <property name="visible_horizontal">True</property>
-			      <property name="visible_vertical">True</property>
-			      <property name="is_important">False</property>
-			      <signal name="clicked" handler="on_editQueryButton_clicked" last_modification_time="Mon, 24 Sep 2007 03:04:25 GMT"/>
+			      <property name="can_default">True</property>
+			      <property name="can_focus">True</property>
+			      <property name="label">gtk-remove</property>
+			      <property name="use_stock">True</property>
+			      <property name="relief">GTK_RELIEF_NORMAL</property>
+			      <property name="focus_on_click">True</property>
+			      <signal name="clicked" handler="on_removeQueryButton_clicked" last_modification_time="Fri, 25 Feb 2005 23:38:42 GMT"/>
 			    </widget>
-			    <packing>
-			      <property name="expand">False</property>
-			      <property name="homogeneous">False</property>
-			    </packing>
 			  </child>
 
 			  <child>
-			    <widget class="GtkToolButton" id="removeQueryButton">
+			    <widget class="GtkButton" id="findQueryButton">
+			      <property name="border_width">4</property>
 			      <property agent="glademm" name="cxx_visibility">protected</property>
 			      <property name="visible">True</property>
-			      <property name="stock_id">gtk-remove</property>
-			      <property name="visible_horizontal">True</property>
-			      <property name="visible_vertical">True</property>
-			      <property name="is_important">False</property>
-			      <signal name="clicked" handler="on_removeQueryButton_clicked" last_modification_time="Mon, 24 Sep 2007 03:07:13 GMT"/>
+			      <property name="can_default">True</property>
+			      <property name="can_focus">True</property>
+			      <property name="label">gtk-find</property>
+			      <property name="use_stock">True</property>
+			      <property name="relief">GTK_RELIEF_NORMAL</property>
+			      <property name="focus_on_click">True</property>
+			      <signal name="clicked" handler="on_findQueryButton_clicked" last_modification_time="Sat, 26 Feb 2005 13:31:59 GMT"/>
 			    </widget>
-			    <packing>
-			      <property name="expand">False</property>
-			      <property name="homogeneous">False</property>
-			    </packing>
 			  </child>
-
-			  <child>
-			    <widget class="GtkToolButton" id="findQueryButton">
-			      <property agent="glademm" name="cxx_visibility">protected</property>
-			      <property name="visible">True</property>
-			      <property name="stock_id">gtk-find</property>
-			      <property name="visible_horizontal">True</property>
-			      <property name="visible_vertical">True</property>
-			      <property name="is_important">False</property>
-			      <signal name="clicked" handler="on_findQueryButton_clicked" last_modification_time="Mon, 24 Sep 2007 03:07:43 GMT"/>
-			    </widget>
-			    <packing>
-			      <property name="expand">False</property>
-			      <property name="homogeneous">False</property>
-			    </packing>
-			  </child>
 			</widget>
 			<packing>
 			  <property name="padding">0</property>

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-25 13:32:14 UTC (rev 990)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-25 13:40:00 UTC (rev 991)
@@ -225,9 +225,6 @@
 	// Connect to the "changed" signal
 	queryTreeview->get_selection()->signal_changed().connect(
 		SigC::slot(*this, &mainWindow::on_queryTreeviewSelection_changed));
-	// Connect to the find button's "show menu" signal
-	findQueryButton->signal_show_menu().connect(
-		SigC::slot(*this, &mainWindow::populate_findMenu));
 	// Populate
 	populate_queryTreeview("");
 
@@ -243,7 +240,6 @@
 		SigC::slot(*this, &mainWindow::on_switch_page), false);
 
 	// Gray out menu items
-	editQueryButton->set_sensitive(false);
 	removeQueryButton->set_sensitive(false);
 	findQueryButton->set_sensitive(false);
 	show_global_menuitems(false);
@@ -253,8 +249,12 @@
 
 	// Set tooltips
 	m_tooltips.set_tip(*enginesTogglebutton, _("Show all search engines"));
-	m_tooltips.set_tip(*addIndexButton, _("Add index"));
-	m_tooltips.set_tip(*removeIndexButton, _("Remove index"));
+	m_tooltips.set_tip(*findButton, _("Find documents that match the query string"));
+	m_tooltips.set_tip(*addIndexButton, _("Add an index"));
+	m_tooltips.set_tip(*removeIndexButton, _("Remove an index"));
+	m_tooltips.set_tip(*addQueryButton, _("Add a query"));
+	m_tooltips.set_tip(*removeQueryButton, _("Remove a query"));
+	m_tooltips.set_tip(*findQueryButton, _("Find documents that match the query"));
 
 	// Connect to threads' finished signal
 	m_state.connect();
@@ -481,7 +481,7 @@
 	if (m_pFindMenu == NULL)
 	{
 		m_pFindMenu = manage(new Menu());
-		findQueryButton->set_menu(*m_pFindMenu);
+		searchagain1->set_submenu(*m_pFindMenu);
 	}
 	else
 	{
@@ -489,28 +489,20 @@
 		m_pFindMenu->items().clear();
 	}
 
-	// Regular find, as if the button was clicked
-	m_pFindMenu->items().push_back(Menu_Helpers::MenuElem(_("In all documents")));
-	MenuItem &menuItem0 = m_pFindMenu->items().back();
-	menuItem0.signal_activate().connect(SigC::slot(*this, &mainWindow::on_findQueryButton_clicked));
+	SigC::Slot1<void, ustring> findSlot = SigC::slot(*this, &mainWindow::on_searchagain_changed);
 
-	// Is a results page being shown right now ?
-	NotebookPageBox *pNotebookPage = get_current_page();
-	if (pNotebookPage != NULL)
+	TreeModel::Children children = m_refQueryTree->children();
+	for (TreeModel::Children::iterator iter = children.begin();
+		iter != children.end(); ++iter)
 	{
-		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-		if (pResultsPage != NULL)
-		{
-			ustring findMenuItem(_("In all results of"));
+		TreeModel::Row row = *iter;
+		ustring queryName(row[m_queryColumns.m_name]);
 
-			findMenuItem += " ";
-			findMenuItem += pResultsPage->getTitle();
-
-			// Find and combine with the query whose results are being shown
-			m_pFindMenu->items().push_back(Menu_Helpers::MenuElem(findMenuItem));
-			MenuItem &menuItem = m_pFindMenu->items().back();
-			menuItem.signal_activate().connect(SigC::slot(*this, &mainWindow::on_find_changed));
-		}
+		m_pFindMenu->items().push_back(Menu_Helpers::MenuElem(queryName));
+		MenuItem &menuItem = m_pFindMenu->items().back();
+		// Bind the callback's parameter to the query name
+		SigC::Slot0<void> menuItemSlot = sigc::bind(findSlot, queryName);
+		menuItem.signal_activate().connect(menuItemSlot);
 	}
 }
 
@@ -550,44 +542,49 @@
 	{
 		populate_queryTreeview(queryName);
 		queryExpander->set_expanded(true);
+		populate_findMenu();
 	}	
 }
 
 //
 // Get selected results in the current results tab
 //
-bool mainWindow::get_results_page_details(QueryProperties &queryProps, set<string> &locations)
+bool mainWindow::get_results_page_details(const ustring &queryName,
+	QueryProperties &queryProps, set<string> &locations)
 {
 	vector<DocumentInfo> resultsList;
-	ustring queryName;
+	ustring currentQueryName(queryName);
 
 	locations.clear();
 
-	NotebookPageBox *pNotebookPage = get_current_page();
-	if (pNotebookPage != NULL)
+	if (currentQueryName.empty() == true)
 	{
-		ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
-		if (pResultsPage != NULL)
+		NotebookPageBox *pNotebookPage = get_current_page();
+		if (pNotebookPage != NULL)
 		{
-			ResultsTree *pResultsTree = pResultsPage->getTree();
-			if (pResultsTree != NULL)
+			ResultsPage *pResultsPage = dynamic_cast<ResultsPage*>(pNotebookPage);
+			if (pResultsPage != NULL)
 			{
-				pResultsTree->getSelection(resultsList);
+				ResultsTree *pResultsTree = pResultsPage->getTree();
+				if (pResultsTree != NULL)
+				{
+					pResultsTree->getSelection(resultsList);
+				}
+
+				currentQueryName = pResultsPage->getTitle();
 			}
+		}
 
-			queryName = pResultsPage->getTitle();
+		if (currentQueryName.empty() == true)
+		{
+			return false;
 		}
 	}
 
-	if (queryName.empty() == true)
-	{
-		return false;
-	}
-
 	// Find this query
-	if (queryName == _("Live query"))
+	if (currentQueryName == _("Live query"))
 	{
-		queryProps.setName(queryName);
+		queryProps.setName(currentQueryName);
 		queryProps.setFreeQuery(liveQueryEntry->get_text());
 	}
 	else
@@ -600,7 +597,7 @@
 		{
 			TreeModel::Row row = *iter;
 
-			if (queryName == from_utf8(row[m_queryColumns.m_name]))
+			if (currentQueryName == from_utf8(row[m_queryColumns.m_name]))
 			{
 				queryProps = row[m_queryColumns.m_properties];
 				foundQuery = true;
@@ -641,7 +638,6 @@
 		enableButtons = true;
 	}
 
-	editQueryButton->set_sensitive(enableButtons);
 	removeQueryButton->set_sensitive(enableButtons);
 	findQueryButton->set_sensitive(enableButtons);
 }
@@ -753,6 +749,7 @@
 		viewresults1->set_sensitive(isViewable);
 		viewcache1->set_sensitive(isCached);
 		morelikethis1->set_sensitive(isIndexed);
+		searchagain1->set_sensitive(isIndexed);
 		indexresults1->set_sensitive(isIndexable);
 	}
 	else
@@ -761,6 +758,7 @@
 		viewresults1->set_sensitive(false);
 		viewcache1->set_sensitive(false);
 		morelikethis1->set_sensitive(false);
+		searchagain1->set_sensitive(false);
 		indexresults1->set_sensitive(false);
 
 		// Reset
@@ -972,42 +970,71 @@
 }
 
 //
-// Stored queries' Find menu selected
+// Results > Search This For menu selected
 //
-void mainWindow::on_find_changed()
+void mainWindow::on_searchagain_changed(ustring queryName)
 {
+	QueryProperties queryProps;
 	QueryProperties currentQueryProps;
 	set<string> locations;
 
-	if (get_results_page_details(currentQueryProps, locations) == false)
+	// Get the properties of the given query and
+	// selected results on the current results page
+	if ((get_results_page_details(queryName, queryProps, locations) == false) ||
+		(get_results_page_details("", currentQueryProps, locations) == false))
 	{
-		// No query and/or results found, run the search as per normal
-		on_findQueryButton_clicked();
+		// Maybe the query was deleted
+		if (queryProps.getName().empty() == false)
+		{
+			ustring status(_("Couldn't find query"));
+			status += " ";
+			status += queryName;
+			set_status(status);
+		}
+
 		return;
 	}
 
-	TreeModel::iterator queryIter = queryTreeview->get_selection()->get_selected();
-	// Anything selected ?
-	if (queryIter)
+	if (locations.empty() == false)
 	{
-		TreeModel::Row queryRow = *queryIter;
-		QueryProperties queryProps = queryRow[m_queryColumns.m_properties];
+		std::map<std::string, std::string> indexes = m_settings.getIndexes();
 		ustring queryName(queryProps.getName());
-		string queryStr(queryProps.getFreeQuery());
-		time_t lastRunTime = time(NULL);
+		ustring queryStr(queryProps.getFreeQuery());
+		bool firstLocation = true;
 
-		// Combine both queries
-		queryProps.setName(queryName + " " + _("in") + " " + currentQueryProps.getName());
-		queryProps.setFreeQuery("(" + currentQueryProps.getFreeQuery() + ") + (" + queryStr + ")");
+		queryProps.setName(queryName + " " + _("in results"));
+		queryStr += " +(";
+		for (set<string>::const_iterator locationIter = locations.begin();
+			locationIter != locations.end(); ++locationIter)
+		{
+			if (firstLocation == false)
+			{
+				queryStr += " or ";
+			}
+			queryStr += "url:\"";
+			queryStr += *locationIter;
+			queryStr += "\"";
+			firstLocation = false;
+		}
+		queryStr += ")";
 #ifdef DEBUG
-		cout << "mainWindow::on_find_changed: combined into " << queryProps.getFreeQuery() << endl;
+		cout << "mainWindow::on_searchagain_changed: " << queryStr << endl;
 #endif
+		queryProps.setFreeQuery(queryStr);
 
-		run_search(queryProps);
-
-		// Update the Last Run column
-		queryRow[m_queryColumns.m_lastRun] = to_utf8(TimeConverter::toTimestamp(lastRunTime));
-		queryRow[m_queryColumns.m_lastRunTime] = lastRunTime;
+		// Spawn new threads
+		std::map<std::string, std::string>::const_iterator indexIter = indexes.find(_("My Documents"));
+		if (indexIter != indexes.end())
+		{
+			start_thread(new QueryingThread("xapian", indexIter->first,
+				indexIter->second, queryProps));
+		}
+		indexIter = indexes.find(_("My Web Pages"));
+		if (indexIter != indexes.end())
+		{
+			start_thread(new QueryingThread("xapian", indexIter->first,
+				indexIter->second, queryProps));
+		}
 	}
 }
 
@@ -2076,7 +2103,8 @@
 	QueryProperties queryProps;
 	set<string> locations;
 
-	if (get_results_page_details(queryProps, locations) == false)
+	// Get the current page's details
+	if (get_results_page_details("", queryProps, locations) == false)
 	{
 		// Maybe the query was deleted
 		if (queryProps.getName().empty() == false)
@@ -2737,26 +2765,6 @@
 }
 
 //
-// Edit query button click
-//
-void mainWindow::on_editQueryButton_clicked()
-{
-	TreeModel::iterator iter = queryTreeview->get_selection()->get_selected();
-	// Anything selected ?
-	if (iter)
-	{
-		TreeModel::Row row = *iter;
-#ifdef DEBUG
-		cout << "mainWindow::on_editQueryButton_clicked: selected " << row[m_queryColumns.m_name] << endl;
-#endif
-
-		// Edit this query's properties
-		QueryProperties queryProps = row[m_queryColumns.m_properties];
-		edit_query(queryProps, false);
-	}
-}
-
-//
 // Remove query button click
 //
 void mainWindow::on_removeQueryButton_clicked()
@@ -2783,6 +2791,8 @@
 			m_refQueryTree->erase(row);
 
 			queryTreeview->columns_autosize();
+
+			populate_findMenu();
 		}
 
 		if (m_state.read_lock_lists() == true)
@@ -2818,7 +2828,7 @@
 void mainWindow::on_findQueryButton_clicked()
 {
 	TreeModel::iterator queryIter = queryTreeview->get_selection()->get_selected();
-	// Anything selected ?
+	// Any query selected ?
 	if (queryIter)
 	{
 		TreeModel::Row queryRow = *queryIter;
@@ -2885,7 +2895,19 @@
 	// Check for double clicks
 	if (ev->type == GDK_2BUTTON_PRESS)
 	{
-		on_editQueryButton_clicked();
+		TreeModel::iterator iter = queryTreeview->get_selection()->get_selected();
+		// Anything selected ?
+		if (iter)
+		{
+			TreeModel::Row row = *iter;
+#ifdef DEBUG
+			cout << "mainWindow::on_queryTreeview_button_press_event: selected " << row[m_queryColumns.m_name] << endl;
+#endif
+
+			// Edit this query's properties
+			QueryProperties queryProps = row[m_queryColumns.m_properties];
+			edit_query(queryProps, false);
+		}
 	}
 
 	return false;
@@ -2953,6 +2975,7 @@
 	viewresults1->set_sensitive(showItems);
 	viewcache1->set_sensitive(showItems);
 	morelikethis1->set_sensitive(showItems);
+	searchagain1->set_sensitive(showItems);
 	indexresults1->set_sensitive(showItems);
 
 	// Index menuitems that depend on selection
@@ -3136,6 +3159,7 @@
 	}
 
 	populate_queryTreeview(queryProps.getName());
+	populate_findMenu();
 
 	if (m_state.read_lock_lists() == true)
 	{

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2007-09-25 13:32:14 UTC (rev 990)
+++ trunk/UI/GTK2/src/mainWindow.hh	2007-09-25 13:40:00 UTC (rev 991)
@@ -64,7 +64,8 @@
 	void populate_indexMenu();
 	void populate_findMenu();
 	void add_query(QueryProperties &queryProps, bool mergeQueries);
-	bool get_results_page_details(QueryProperties &queryProps, std::set<std::string> &locations);
+	bool get_results_page_details(const Glib::ustring &queryName,
+		QueryProperties &queryProps, std::set<std::string> &locations);
 
 	// Handlers
 	void on_enginesTreeviewSelection_changed();
@@ -73,7 +74,7 @@
 	void on_indexTreeviewSelection_changed(Glib::ustring indexName);
 	void on_index_changed(Glib::ustring indexName);
 	void on_cache_changed(PinotSettings::CacheProvider cacheProvider);
-	void on_find_changed();
+	void on_searchagain_changed(Glib::ustring queryName);
 	void on_query_changed(Glib::ustring indexName, Glib::ustring queryName);
 	void on_switch_page(GtkNotebookPage *p0, guint p1);
 	void on_close_page(Glib::ustring title, NotebookPageBox::PageType type);
@@ -115,7 +116,6 @@
 	virtual void on_liveQueryEntry_activate();
 	virtual void on_findButton_clicked();
 	virtual void on_addQueryButton_clicked();
-	virtual void on_editQueryButton_clicked();
 	virtual void on_removeQueryButton_clicked();
 	virtual void on_findQueryButton_clicked();
 

Modified: trunk/UI/GTK2/src/mainWindow_glade.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.cc	2007-09-25 13:32:14 UTC (rev 990)
+++ trunk/UI/GTK2/src/mainWindow_glade.cc	2007-09-25 13:40:00 UTC (rev 991)
@@ -1,4 +1,4 @@
-// generated 2007/9/24 20:22:15 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/24 22:21:22 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -41,13 +41,12 @@
 #include <gtkmm/menuitem.h>
 #include <gtkmm/menu.h>
 #include <gtkmm/image.h>
+#include <gtkmm/imagemenuitem.h>
 #include <gtkmm/menubar.h>
 #include <gtkmm/box.h>
 #include <gtkmm/label.h>
 #include <gtkmm/buttonbox.h>
 #include <gtkmm/scrolledwindow.h>
-#include <gtkmm/stockid.h>
-#include <gtkmm/toolbar.h>
 #ifndef ENABLE_NLS
 #  define textdomain(String) (String)
 #  define gettext(String) (String)
@@ -83,26 +82,28 @@
    Gtk::Menu *groupresults1_menu = Gtk::manage(new class Gtk::Menu());
    groupresults1 = NULL;
    exportresults1 = NULL;
-   Gtk::Image *image701 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-clear"), Gtk::IconSize(1)));
+   Gtk::Image *image718 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-clear"), Gtk::IconSize(1)));
    clearresults1 = NULL;
    Gtk::MenuItem *separator1 = NULL;
    viewresults1 = NULL;
    viewcache1 = NULL;
-   Gtk::Image *image702 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-find"), Gtk::IconSize(1)));
+   Gtk::Image *image719 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-add"), Gtk::IconSize(1)));
    morelikethis1 = NULL;
+   searchagain1 = NULL;
+   Gtk::Image *image720 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-find"), Gtk::IconSize(1)));
    indexresults1 = NULL;
    Gtk::Menu *resultsMenuitem_menu = Gtk::manage(new class Gtk::Menu());
    resultsMenuitem = NULL;
    list1 = NULL;
-   Gtk::Image *image703 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(1)));
+   Gtk::Image *image721 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-open"), Gtk::IconSize(1)));
    import1 = NULL;
    Gtk::MenuItem *separator3 = NULL;
    viewfromindex1 = NULL;
-   Gtk::Image *image704 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-refresh"), Gtk::IconSize(1)));
+   Gtk::Image *image722 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-refresh"), Gtk::IconSize(1)));
    refreshindex1 = NULL;
-   Gtk::Image *image705 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-delete"), Gtk::IconSize(1)));
+   Gtk::Image *image723 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-delete"), Gtk::IconSize(1)));
    unindex1 = NULL;
-   Gtk::Image *image706 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-properties"), Gtk::IconSize(1)));
+   Gtk::Image *image724 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-properties"), Gtk::IconSize(1)));
    showfromindex1 = NULL;
    Gtk::Menu *indexMenuitem_menu = Gtk::manage(new class Gtk::Menu());
    indexMenuitem = NULL;
@@ -133,12 +134,11 @@
    queryTreeview = Gtk::manage(new class Gtk::TreeView());
    
    Gtk::ScrolledWindow *queryScrolledwindow = Gtk::manage(new class Gtk::ScrolledWindow());
-   addQueryButton = Gtk::manage(new class Gtk::ToolButton(Gtk::StockID("gtk-add")));
-   editQueryButton = Gtk::manage(new class Gtk::ToolButton(Gtk::StockID("gtk-edit")));
-   removeQueryButton = Gtk::manage(new class Gtk::ToolButton(Gtk::StockID("gtk-remove")));
-   findQueryButton = Gtk::manage(new class Gtk::MenuToolButton(Gtk::StockID("gtk-find")));
+   addQueryButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-add")));
+   removeQueryButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-remove")));
+   findQueryButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-find")));
    
-   Gtk::Toolbar *queryToolbar = Gtk::manage(new class Gtk::Toolbar());
+   Gtk::VButtonBox *queryVbuttonbox = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
    Gtk::HBox *queryHbox = Gtk::manage(new class Gtk::HBox(false, 0));
    Gtk::Label *queryLabel = Gtk::manage(new class Gtk::Label(_("Stored queries")));
    queryExpander = Gtk::manage(new class Gtk::Expander());
@@ -189,7 +189,7 @@
    resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::StockMenuElem(Gtk::StockID("gtk-save-as")));
    exportresults1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Clear List"), *image701));
+   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Clear List"), *image718));
    clearresults1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
    
    resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
@@ -201,16 +201,19 @@
    resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("View Cache")));
    viewcache1 = (Gtk::MenuItem *)&resultsMenuitem_menu->items().back();
    
-   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("More Like This"), *image702));
+   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("More Like This"), *image719));
    morelikethis1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
    
+   resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Search This For"), *image720));
+   searchagain1 = (Gtk::ImageMenuItem *)&resultsMenuitem_menu->items().back();
+   
    resultsMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Index")));
    indexresults1 = (Gtk::MenuItem *)&resultsMenuitem_menu->items().back();
    
    indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("List Contents Of")));
    list1 = (Gtk::MenuItem *)&indexMenuitem_menu->items().back();
    
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Import URL"), *image703));
+   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Import URL"), *image721));
    import1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
    
    indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::SeparatorElem());
@@ -219,13 +222,13 @@
    indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("View")));
    viewfromindex1 = (Gtk::MenuItem *)&indexMenuitem_menu->items().back();
    
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Update"), *image704));
+   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Update"), *image722));
    refreshindex1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
    
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Unindex"), *image705));
+   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Unindex"), *image723));
    unindex1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
    
-   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Properties"), *image706));
+   indexMenuitem_menu->items().push_back(Gtk::Menu_Helpers::ImageMenuElem(_("Properties"), *image724));
    showfromindex1 = (Gtk::ImageMenuItem *)&indexMenuitem_menu->items().back();
    
    helpMenuitem_menu->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_About")));
@@ -245,25 +248,23 @@
    
    mainMenubar->items().push_back(Gtk::Menu_Helpers::MenuElem(_("_Help"), *helpMenuitem_menu));
    helpMenuitem = (Gtk::MenuItem *)&mainMenubar->items().back();
-   queryToolbar->append(*addQueryButton);
-   queryToolbar->append(*editQueryButton);
-   queryToolbar->append(*removeQueryButton);
-   queryToolbar->append(*findQueryButton);
    showextract1->set_active(true);
    searchenginegroup1->set_active(true);
    hostnamegroup1->set_active(false);
-   image701->set_alignment(0.5,0.5);
-   image701->set_padding(0,0);
-   image702->set_alignment(0.5,0.5);
-   image702->set_padding(0,0);
-   image703->set_alignment(0.5,0.5);
-   image703->set_padding(0,0);
-   image704->set_alignment(0.5,0.5);
-   image704->set_padding(0,0);
-   image705->set_alignment(0.5,0.5);
-   image705->set_padding(0,0);
-   image706->set_alignment(0.5,0.5);
-   image706->set_padding(0,0);
+   image718->set_alignment(0.5,0.5);
+   image718->set_padding(0,0);
+   image719->set_alignment(0.5,0.5);
+   image719->set_padding(0,0);
+   image720->set_alignment(0.5,0.5);
+   image720->set_padding(0,0);
+   image721->set_alignment(0.5,0.5);
+   image721->set_padding(0,0);
+   image722->set_alignment(0.5,0.5);
+   image722->set_padding(0,0);
+   image723->set_alignment(0.5,0.5);
+   image723->set_padding(0,0);
+   image724->set_alignment(0.5,0.5);
+   image724->set_padding(0,0);
    image439->set_alignment(0.5,0.5);
    image439->set_padding(0,0);
    addIndexButton->set_flags(Gtk::CAN_FOCUS);
@@ -317,52 +318,31 @@
    queryTreeview->set_rules_hint(false);
    queryTreeview->set_reorderable(false);
    queryTreeview->set_enable_search(false);
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=5
    queryTreeview->set_fixed_height_mode(false);
    queryTreeview->set_hover_selection(false);
    queryTreeview->set_hover_expand(false);
-#endif //
    queryScrolledwindow->set_flags(Gtk::CAN_FOCUS);
    queryScrolledwindow->set_shadow_type(Gtk::SHADOW_NONE);
    queryScrolledwindow->set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
    queryScrolledwindow->property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
    queryScrolledwindow->add(*queryTreeview);
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
-   addQueryButton->set_visible_horizontal(true);
-   addQueryButton->set_visible_vertical(true);
-   addQueryButton->set_is_important(false);
-   addQueryButton->set_homogeneous(false);
-   addQueryButton->set_expand(false);
-#endif //
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
-   editQueryButton->set_visible_horizontal(true);
-   editQueryButton->set_visible_vertical(true);
-   editQueryButton->set_is_important(false);
-   editQueryButton->set_homogeneous(false);
-   editQueryButton->set_expand(false);
-#endif //
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
-   removeQueryButton->set_visible_horizontal(true);
-   removeQueryButton->set_visible_vertical(true);
-   removeQueryButton->set_is_important(false);
-   removeQueryButton->set_homogeneous(false);
-   removeQueryButton->set_expand(false);
-#endif //
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
-   findQueryButton->set_visible_horizontal(true);
-   findQueryButton->set_visible_vertical(true);
-   findQueryButton->set_is_important(false);
-   findQueryButton->set_homogeneous(false);
-   findQueryButton->set_expand(false);
-#endif //
-   queryToolbar->set_tooltips(true);
-   queryToolbar->set_toolbar_style(Gtk::TOOLBAR_ICONS);
-   queryToolbar->set_orientation(Gtk::ORIENTATION_VERTICAL);
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
-   queryToolbar->set_show_arrow(false);
-#endif //
+   addQueryButton->set_flags(Gtk::CAN_FOCUS);
+   addQueryButton->set_flags(Gtk::CAN_DEFAULT);
+   addQueryButton->set_border_width(4);
+   addQueryButton->set_relief(Gtk::RELIEF_NORMAL);
+   removeQueryButton->set_flags(Gtk::CAN_FOCUS);
+   removeQueryButton->set_flags(Gtk::CAN_DEFAULT);
+   removeQueryButton->set_border_width(4);
+   removeQueryButton->set_relief(Gtk::RELIEF_NORMAL);
+   findQueryButton->set_flags(Gtk::CAN_FOCUS);
+   findQueryButton->set_flags(Gtk::CAN_DEFAULT);
+   findQueryButton->set_border_width(4);
+   findQueryButton->set_relief(Gtk::RELIEF_NORMAL);
+   queryVbuttonbox->pack_start(*addQueryButton);
+   queryVbuttonbox->pack_start(*removeQueryButton);
+   queryVbuttonbox->pack_start(*findQueryButton);
    queryHbox->pack_start(*queryScrolledwindow);
-   queryHbox->pack_start(*queryToolbar, Gtk::PACK_SHRINK, 0);
+   queryHbox->pack_start(*queryVbuttonbox, Gtk::PACK_SHRINK, 0);
    queryLabel->set_alignment(0.5,0.5);
    queryLabel->set_padding(0,0);
    queryLabel->set_justify(Gtk::JUSTIFY_LEFT);
@@ -374,14 +354,10 @@
    queryLabel->set_angle(0);
    queryLabel->set_single_line_mode(false);
    queryExpander->set_flags(Gtk::CAN_FOCUS);
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
-   queryExpander->set_expanded(true);
+   queryExpander->set_expanded(false);
    queryExpander->set_spacing(0);
-#endif //
    queryExpander->add(*queryHbox);
-#if GTKMM_MAJOR_VERSION==2 && GTKMM_MINOR_VERSION>=3
    queryExpander->set_label_widget(*queryLabel);
-#endif //
    rightVbox->pack_start(*liveQueryHbox, Gtk::PACK_SHRINK, 0);
    rightVbox->pack_start(*queryExpander, Gtk::PACK_SHRINK, 0);
    mainHpaned->set_flags(Gtk::CAN_FOCUS);
@@ -416,25 +392,27 @@
    hostnamegroup1->show();
    groupresults1->show();
    exportresults1->show();
-   image701->show();
+   image718->show();
    clearresults1->show();
    separator1->show();
    viewresults1->show();
    viewcache1->show();
-   image702->show();
+   image719->show();
    morelikethis1->show();
+   image720->show();
+   searchagain1->show();
    indexresults1->show();
    resultsMenuitem->show();
    list1->show();
-   image703->show();
+   image721->show();
    import1->show();
    separator3->show();
    viewfromindex1->show();
-   image704->show();
+   image722->show();
    refreshindex1->show();
-   image705->show();
+   image723->show();
    unindex1->show();
-   image706->show();
+   image724->show();
    showfromindex1->show();
    indexMenuitem->show();
    about1->show();
@@ -456,10 +434,9 @@
    queryTreeview->show();
    queryScrolledwindow->show();
    addQueryButton->show();
-   editQueryButton->show();
    removeQueryButton->show();
    findQueryButton->show();
-   queryToolbar->show();
+   queryVbuttonbox->show();
    queryHbox->show();
    queryLabel->show();
    queryExpander->show();
@@ -497,7 +474,6 @@
    findButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_findButton_clicked), false);
    queryTreeview->signal_button_press_event().connect(SigC::slot(*this, &mainWindow_glade::on_queryTreeview_button_press_event), false);
    addQueryButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_addQueryButton_clicked), false);
-   editQueryButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_editQueryButton_clicked), false);
    removeQueryButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_removeQueryButton_clicked), false);
    findQueryButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_findQueryButton_clicked), false);
    mainWindow->signal_delete_event().connect(SigC::slot(*this, &mainWindow_glade::on_mainWindow_delete_event), false);

Modified: trunk/UI/GTK2/src/mainWindow_glade.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.hh	2007-09-25 13:32:14 UTC (rev 990)
+++ trunk/UI/GTK2/src/mainWindow_glade.hh	2007-09-25 13:40:00 UTC (rev 991)
@@ -1,4 +1,4 @@
-// generated 2007/9/24 20:22:15 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/24 22:21:22 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -41,8 +41,6 @@
 #include <gtkmm/togglebutton.h>
 #include <gtkmm/entry.h>
 #include <gtkmm/treeview.h>
-#include <gtkmm/toolbutton.h>
-#include <gtkmm/menutoolbutton.h>
 #include <gtkmm/handlebox.h>
 #include <gtkmm/expander.h>
 #include <gtkmm/paned.h>
@@ -74,6 +72,7 @@
         class Gtk::MenuItem * viewresults1;
         class Gtk::MenuItem * viewcache1;
         class Gtk::ImageMenuItem * morelikethis1;
+        class Gtk::ImageMenuItem * searchagain1;
         class Gtk::MenuItem * indexresults1;
         class Gtk::MenuItem * resultsMenuitem;
         class Gtk::MenuItem * list1;
@@ -93,10 +92,9 @@
         class Gtk::Entry * liveQueryEntry;
         class Gtk::Button * findButton;
         class Gtk::TreeView * queryTreeview;
-        class Gtk::ToolButton * addQueryButton;
-        class Gtk::ToolButton * editQueryButton;
-        class Gtk::ToolButton * removeQueryButton;
-        class Gtk::MenuToolButton * findQueryButton;
+        class Gtk::Button * addQueryButton;
+        class Gtk::Button * removeQueryButton;
+        class Gtk::Button * findQueryButton;
         class Gtk::Expander * queryExpander;
         class Gtk::VBox * rightVbox;
         class Gtk::HPaned * mainHpaned;
@@ -135,7 +133,6 @@
         virtual void on_findButton_clicked() = 0;
         virtual bool on_queryTreeview_button_press_event(GdkEventButton *ev) = 0;
         virtual void on_addQueryButton_clicked() = 0;
-        virtual void on_editQueryButton_clicked() = 0;
         virtual void on_removeQueryButton_clicked() = 0;
         virtual void on_findQueryButton_clicked() = 0;
         virtual bool on_mainWindow_delete_event(GdkEventAny *ev) = 0;



From fabricecolin at mail.berlios.de  Wed Sep 26 15:58:16 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 26 Sep 2007 15:58:16 +0200
Subject: [Pinot-svn] r992 - in trunk: Index Search Search/Google
Message-ID: <200709261358.l8QDwG18005326@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-26 15:58:15 +0200 (Wed, 26 Sep 2007)
New Revision: 992

Modified:
   trunk/Index/XapianIndex.cpp
   trunk/Search/Google/GoogleAPIEngine.cpp
   trunk/Search/Google/GoogleAPIEngine.h
   trunk/Search/QueryProperties.cpp
   trunk/Search/QueryProperties.h
   trunk/Search/SearchEngineFactory.cpp
   trunk/Search/SearchEngineInterface.cpp
   trunk/Search/SearchEngineInterface.h
   trunk/Search/XapianEngine.cpp
   trunk/Search/XapianEngine.h
Log:
QueryProperties has a sort order (relevance or date). XapianIndex stores date
and time in value 4 for that purpose.
Removed setKey() from engines interface, it's only relevant to the Google API.


Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Index/XapianIndex.cpp	2007-09-26 13:58:15 UTC (rev 992)
@@ -610,13 +610,15 @@
 	string yyyymmdd(TimeConverter::toYYYYMMDDString(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday));
 	string hhmmss(TimeConverter::toHHMMSSString(tm->tm_hour, tm->tm_min, tm->tm_sec));
 
-	// Add this value to allow sorting by date
+	// Date
 	doc.add_value(0, yyyymmdd);
 	// FIXME: checksum in value 1
-	// Size goes in value 2
+	// Size
 	doc.add_value(2, Xapian::sortable_serialise((double )info.getSize()));
-	// Time goes in value 3
+	// Time
 	doc.add_value(3, hhmmss);
+	// Date and time, for results sorting
+	doc.add_value(4, yyyymmdd + hhmmss);
 
 	DocumentInfo docCopy(info);
 	docCopy.setLanguage(language);

Modified: trunk/Search/Google/GoogleAPIEngine.cpp
===================================================================
--- trunk/Search/Google/GoogleAPIEngine.cpp	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Search/Google/GoogleAPIEngine.cpp	2007-09-26 13:58:15 UTC (rev 992)
@@ -29,8 +29,9 @@
 using std::cerr;
 using std::endl;
 
-GoogleAPIEngine::GoogleAPIEngine() :
-	WebEngine()
+GoogleAPIEngine::GoogleAPIEngine(const string &key) :
+	WebEngine(),
+	m_key(key)
 {
 }
 
@@ -44,7 +45,8 @@
 	GoogleSearchBinding soapProxy;
 	xsd__base64Binary base64Page;
 
-	if (soapProxy.gapi1__doGetCachedPage(m_key, url, base64Page))
+	if ((m_key.empty() == true) ||
+		(soapProxy.gapi1__doGetCachedPage(m_key, url, base64Page)))
 	{
 		return NULL;
 	}
@@ -69,7 +71,8 @@
 	GoogleSearchBinding soapProxy;
 	string spellOut;
 
-	if (soapProxy.gapi1__doSpellingSuggestion(m_key, text, spellOut))
+	if ((m_key.empty() == true) ||
+		(soapProxy.gapi1__doSpellingSuggestion(m_key, text, spellOut)))
 	{
 		return "";
 	}

Modified: trunk/Search/Google/GoogleAPIEngine.h
===================================================================
--- trunk/Search/Google/GoogleAPIEngine.h	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Search/Google/GoogleAPIEngine.h	2007-09-26 13:58:15 UTC (rev 992)
@@ -30,7 +30,7 @@
 class GoogleAPIEngine : public WebEngine
 {
 	public:
-		GoogleAPIEngine();
+		GoogleAPIEngine(const string &key);
 		virtual ~GoogleAPIEngine();
 
 		/// Runs a query; true if success.
@@ -43,6 +43,9 @@
 		/// Checks spelling.
 		string checkSpelling(const string &text);
 
+	protected:
+		string m_key;
+
 	private:
 		GoogleAPIEngine(const GoogleAPIEngine &other);
 		GoogleAPIEngine &operator=(const GoogleAPIEngine &other);

Modified: trunk/Search/QueryProperties.cpp
===================================================================
--- trunk/Search/QueryProperties.cpp	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Search/QueryProperties.cpp	2007-09-26 13:58:15 UTC (rev 992)
@@ -27,6 +27,7 @@
 
 QueryProperties::QueryProperties() :
 	m_type(XAPIAN_QP),
+	m_order(RELEVANCE),
 	m_resultsCount(10),
 	m_indexResults(false)
 {
@@ -36,6 +37,7 @@
 	QueryType type) :
 	m_name(name),
 	m_type(type),
+	m_order(RELEVANCE),
 	m_freeQuery(freeQuery),
 	m_resultsCount(10),
 	m_indexResults(false)
@@ -46,6 +48,7 @@
 QueryProperties::QueryProperties(const QueryProperties &other) :
 	m_name(other.m_name),
 	m_type(other.m_type),
+	m_order(other.m_order),
 	m_freeQuery(other.m_freeQuery),
 	m_freeQueryWithoutFilters(other.m_freeQueryWithoutFilters),
 	m_resultsCount(other.m_resultsCount),
@@ -64,6 +67,7 @@
 	{
 		m_name = other.m_name;
 		m_type = other.m_type;
+		m_order = other.m_order;
 		m_freeQuery = other.m_freeQuery;
 		m_freeQueryWithoutFilters = other.m_freeQueryWithoutFilters;
 		m_resultsCount = other.m_resultsCount;
@@ -156,6 +160,18 @@
 	return m_type;
 }
 
+/// Sets the sort order.
+void QueryProperties::setSortOrder(SortOrder order)
+{
+	m_order = order;
+}
+
+/// Gets the sort order.
+QueryProperties::SortOrder QueryProperties::getSortOrder(void) const
+{
+	return m_order;
+}
+
 /// Sets the query string.
 void QueryProperties::setFreeQuery(const string &freeQuery)
 {

Modified: trunk/Search/QueryProperties.h
===================================================================
--- trunk/Search/QueryProperties.h	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Search/QueryProperties.h	2007-09-26 13:58:15 UTC (rev 992)
@@ -29,6 +29,7 @@
 {
 	public:
 		typedef enum { XAPIAN_QP = 0, XESAM_QL, XESAM_UL } QueryType;
+		typedef enum { RELEVANCE = 0, DATE } SortOrder;
 
 		QueryProperties();
 		QueryProperties(const string &name, const string &freeQuery,
@@ -50,6 +51,11 @@
 		/// Gets the type.
 		QueryType getType(void) const;
 
+		/// Sets the sort order.
+		void setSortOrder(SortOrder order);
+		/// Gets the sort order.
+		SortOrder getSortOrder(void) const;
+
 		/// Sets the query string.
 		void setFreeQuery(const string &freeQuery);
 		/// Gets the query string.
@@ -82,6 +88,7 @@
 	protected:
 		string m_name;
 		QueryType m_type;
+		SortOrder m_order;
 		string m_freeQuery;
 		string m_freeQueryWithoutFilters;
 		unsigned int m_resultsCount;

Modified: trunk/Search/SearchEngineFactory.cpp
===================================================================
--- trunk/Search/SearchEngineFactory.cpp	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Search/SearchEngineFactory.cpp	2007-09-26 13:58:15 UTC (rev 992)
@@ -48,8 +48,7 @@
 #ifdef HAVE_GOOGLEAPI
 	else if (type == "googleapi")
 	{
-		myEngine = new GoogleAPIEngine();
-		myEngine->setKey(option);
+		myEngine = new GoogleAPIEngine(option);
 	}
 #endif
 

Modified: trunk/Search/SearchEngineInterface.cpp
===================================================================
--- trunk/Search/SearchEngineInterface.cpp	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Search/SearchEngineInterface.cpp	2007-09-26 13:58:15 UTC (rev 992)
@@ -36,12 +36,6 @@
 {
 }
 
-/// Sets the search engine's key, if applicable.
-void SearchEngineInterface::setKey(const string &key)
-{
-	m_key = key;
-}
-
 /// Sets the set of documents to expand from.
 bool SearchEngineInterface::setExpandSet(const set<unsigned int> &docsSet)
 {

Modified: trunk/Search/SearchEngineInterface.h
===================================================================
--- trunk/Search/SearchEngineInterface.h	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Search/SearchEngineInterface.h	2007-09-26 13:58:15 UTC (rev 992)
@@ -36,9 +36,6 @@
 	public:
 		virtual ~SearchEngineInterface();
 
-		/// Sets the search engine's key, if applicable.
-		virtual void setKey(const string &key);
-
 		/// Sets the set of documents to expand from.
 		virtual bool setExpandSet(const set<unsigned int> &docsSet);
 
@@ -70,7 +67,6 @@
 		virtual const set<string> &getExpandTerms(void) const;
 
 	protected:
-		string m_key;
 		DefaultOperator m_defaultOperator;
 		vector<DocumentInfo> m_resultsList;
 		unsigned int m_resultsCountEstimate;

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Search/XapianEngine.cpp	2007-09-26 13:58:15 UTC (rev 992)
@@ -363,8 +363,9 @@
 }
 
 bool XapianEngine::queryDatabase(Xapian::Database *pIndex, Xapian::Query &query,
-	unsigned int startDoc, unsigned int maxResultsCount)
+	unsigned int startDoc, const QueryProperties &queryProps)
 {
+	unsigned int maxResultsCount = queryProps.getMaximumResultsCount();
 	bool completedQuery = false;
 
 	if (pIndex == NULL)
@@ -382,6 +383,17 @@
 
 		// Give the query object to the enquire session
 		enquire.set_query(query);
+		// How should results be sorted ?
+		if (queryProps.getSortOrder() == QueryProperties::RELEVANCE)
+		{
+			// By relevance, only
+			enquire.set_sort_by_relevance();
+		}
+		else if (queryProps.getSortOrder() == QueryProperties::DATE)
+		{
+			// By date, and then by relevance
+			enquire.set_sort_by_value_then_relevance(4);
+		}
 
 		// Get the top results of the query
 		Xapian::MSet matches = enquire.get_mset(startDoc, maxResultsCount, maxResultsCount + 1);
@@ -552,8 +564,7 @@
 			cout << "XapianEngine::runQuery: " << fullQuery.get_description() << endl;
 #endif
 			// Query the database
-			if (queryDatabase(pIndex, fullQuery, startDoc,
-				queryProps.getMaximumResultsCount()) == false)
+			if (queryDatabase(pIndex, fullQuery, startDoc, queryProps) == false)
 			{
 				break;
 			}

Modified: trunk/Search/XapianEngine.h
===================================================================
--- trunk/Search/XapianEngine.h	2007-09-25 13:40:00 UTC (rev 991)
+++ trunk/Search/XapianEngine.h	2007-09-26 13:58:15 UTC (rev 992)
@@ -62,7 +62,7 @@
 		std::set<Xapian::docid> m_expandDocuments;
 
 		bool queryDatabase(Xapian::Database *pIndex, Xapian::Query &query,
-			unsigned int startDoc, unsigned int maxResultsCount);
+			unsigned int startDoc, const QueryProperties &queryProps);
 
 		static Xapian::Query parseQuery(Xapian::Database *pIndex, const QueryProperties &queryProps,
 			const string &stemLanguage, DefaultOperator defaultOperator,



From fabricecolin at mail.berlios.de  Wed Sep 26 16:09:54 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 26 Sep 2007 16:09:54 +0200
Subject: [Pinot-svn] r993 - in trunk/UI/GTK2: . src
Message-ID: <200709261409.l8QE9sBL006178@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-26 16:09:53 +0200 (Wed, 26 Sep 2007)
New Revision: 993

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/PinotSettings.cpp
   trunk/UI/GTK2/src/queryDialog.cc
   trunk/UI/GTK2/src/queryDialog_glade.cc
   trunk/UI/GTK2/src/queryDialog_glade.hh
Log:
Show the results sort order in queryDialog, save it in PinotSettings.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2007-09-26 13:58:15 UTC (rev 992)
+++ trunk/UI/GTK2/metase-gtk2.glade	2007-09-26 14:09:53 UTC (rev 993)
@@ -2475,7 +2475,7 @@
 	  <child>
 	    <widget class="GtkTable" id="actionsTable">
 	      <property name="visible">True</property>
-	      <property name="n_rows">2</property>
+	      <property name="n_rows">3</property>
 	      <property name="n_columns">2</property>
 	      <property name="homogeneous">False</property>
 	      <property name="row_spacing">0</property>
@@ -2497,8 +2497,8 @@
 		<packing>
 		  <property name="left_attach">0</property>
 		  <property name="right_attach">1</property>
-		  <property name="top_attach">1</property>
-		  <property name="bottom_attach">2</property>
+		  <property name="top_attach">2</property>
+		  <property name="bottom_attach">3</property>
 		  <property name="x_padding">4</property>
 		  <property name="y_padding">4</property>
 		  <property name="x_options">fill</property>
@@ -2516,8 +2516,8 @@
 		<packing>
 		  <property name="left_attach">1</property>
 		  <property name="right_attach">2</property>
-		  <property name="top_attach">1</property>
-		  <property name="bottom_attach">2</property>
+		  <property name="top_attach">2</property>
+		  <property name="bottom_attach">3</property>
 		  <property name="x_padding">4</property>
 		  <property name="y_padding">4</property>
 		  <property name="y_options">fill</property>
@@ -2577,6 +2577,54 @@
 		  <property name="y_options">fill</property>
 		</packing>
 	      </child>
+
+	      <child>
+		<widget class="GtkLabel" id="sortOrderLabel">
+		  <property name="visible">True</property>
+		  <property name="label" translatable="yes">Sort order:</property>
+		  <property name="use_underline">False</property>
+		  <property name="use_markup">False</property>
+		  <property name="justify">GTK_JUSTIFY_LEFT</property>
+		  <property name="wrap">False</property>
+		  <property name="selectable">False</property>
+		  <property name="xalign">0</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xpad">0</property>
+		  <property name="ypad">0</property>
+		  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+		  <property name="width_chars">-1</property>
+		  <property name="single_line_mode">False</property>
+		  <property name="angle">0</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">0</property>
+		  <property name="right_attach">1</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
+
+	      <child>
+		<widget class="GtkComboBox" id="sortOrderCombobox">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="add_tearoffs">False</property>
+		  <property name="focus_on_click">True</property>
+		</widget>
+		<packing>
+		  <property name="left_attach">1</property>
+		  <property name="right_attach">2</property>
+		  <property name="top_attach">1</property>
+		  <property name="bottom_attach">2</property>
+		  <property name="x_padding">4</property>
+		  <property name="y_padding">4</property>
+		  <property name="y_options">fill</property>
+		</packing>
+	      </child>
 	    </widget>
 	    <packing>
 	      <property name="padding">0</property>

Modified: trunk/UI/GTK2/src/PinotSettings.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotSettings.cpp	2007-09-26 13:58:15 UTC (rev 992)
+++ trunk/UI/GTK2/src/PinotSettings.cpp	2007-09-26 14:09:53 UTC (rev 993)
@@ -685,6 +685,17 @@
 		{
 			queryProps.setName(nodeContent);
 		}
+		else if (nodeName == "sortorder")
+		{
+			if (nodeContent == "DATE")
+			{
+				queryProps.setSortOrder(QueryProperties::DATE);
+			}
+			else
+			{
+				queryProps.setSortOrder(QueryProperties::RELEVANCE);
+			}
+		}
 		else if (nodeName == "text")
 		{
 			freeQuery = nodeContent;
@@ -1294,6 +1305,7 @@
 			unsigned int day, month, year;
 
 			addChildElement(pElem, "name", queryIter->first);
+			addChildElement(pElem, "sortorder", (queryIter->second.getSortOrder() == QueryProperties::DATE ? "DATE" : "RELEVANCE"));
 			addChildElement(pElem, "text", queryIter->second.getFreeQuery());
 			sprintf(numStr, "%u", queryIter->second.getMaximumResultsCount());
 			addChildElement(pElem, "maxresults", numStr);

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2007-09-26 13:58:15 UTC (rev 992)
+++ trunk/UI/GTK2/src/queryDialog.cc	2007-09-26 14:09:53 UTC (rev 993)
@@ -79,7 +79,7 @@
 
 		// FIXME: this is extremely hacky !
 		if ((sscanf(rowPath.c_str(), "%u", &rowPos) == 1) &&
-			((rowPos == 2) || (rowPos == 10)))
+			(rowPos == 9))
 		{
 			return true;
 		}
@@ -92,29 +92,10 @@
 {
 	unsigned int labelNum = 1;
 
-	labelNameCombobox->append_text(_("None"));
-	labelNameCombobox->set_active(0);
-
-	// Add all labels to the label combo and select the one defined for the query
-	for (set<string>::const_iterator labelIter = m_labels.begin(); labelIter != m_labels.end(); ++labelIter)
-	{
-		string labelName(*labelIter);
-
-		labelNameCombobox->append_text(to_utf8(labelName));
-		if (labelName == m_properties.getLabelName())
-		{
-			labelNameCombobox->set_active(labelNum);
-		}
-
-		++labelNum;
-	}
-
 	// All supported filters
 	filterCombobox->set_row_separator_func(SigC::slot(*this, &queryDialog::is_separator));
 	filterCombobox->append_text(_("Host name"));
 	filterCombobox->append_text(_("File name"));
-	// Separate filters that apply to all engines from the rest
-	filterCombobox->append_text("===");
 	filterCombobox->append_text(_("File extension"));
 	filterCombobox->append_text(_("Title"));
 	filterCombobox->append_text(_("URL"));
@@ -128,6 +109,35 @@
 	filterCombobox->append_text(_("Time"));
 	filterCombobox->append_text(_("Size"));
 	filterCombobox->set_active(0);
+
+	// Sort order
+	sortOrderCombobox->append_text(_("By relevance"));
+	sortOrderCombobox->append_text(_("By date"));
+	if (m_properties.getSortOrder() == QueryProperties::DATE)
+	{
+		sortOrderCombobox->set_active(1);
+	}
+	else
+	{
+		sortOrderCombobox->set_active(0);
+	}
+
+	// Labels
+	labelNameCombobox->append_text(_("None"));
+	labelNameCombobox->set_active(0);
+	// Add all labels to the label combo and select the one defined for the query
+	for (set<string>::const_iterator labelIter = m_labels.begin(); labelIter != m_labels.end(); ++labelIter)
+	{
+		string labelName(*labelIter);
+
+		labelNameCombobox->append_text(to_utf8(labelName));
+		if (labelName == m_properties.getLabelName())
+		{
+			labelNameCombobox->set_active(labelNum);
+		}
+
+		++labelNum;
+	}
 }
 
 bool queryDialog::badName(void) const
@@ -167,6 +177,15 @@
 	}
 	// Maximum number of results
 	m_properties.setMaximumResultsCount((unsigned int)resultsCountSpinbutton->get_value());
+	// Sort order
+	if (sortOrderCombobox->get_active_row_number() == 1)
+	{
+		m_properties.setSortOrder(QueryProperties::DATE);
+	}
+	else
+	{
+		m_properties.setSortOrder(QueryProperties::RELEVANCE);
+	}
 	// Index all results
 	m_properties.setIndexResults(indexCheckbutton->get_active());
 	// Index label
@@ -210,43 +229,40 @@
 			filter = "file";
 			break;
 		case 2:
-			// Separator
+			filter = "ext";
 			break;
 		case 3:
-			filter = "ext";
+			filter = "title";
 			break;
 		case 4:
-			filter = "title";
+			filter = "url";
 			break;
 		case 5:
-			filter = "url";
+			filter = "dir";
 			break;
 		case 6:
-			filter = "dir";
+			filter = "lang";
 			break;
 		case 7:
-			filter = "lang";
+			filter = "type";
 			break;
 		case 8:
-			filter = "type";
+			filter = "label";
 			break;
 		case 9:
-			filter = "label";
+			// Separator
 			break;
 		case 10:
-			// Separator
-			break;
-		case 11:
 			filter = TimeConverter::toYYYYMMDDString(tm->tm_year + 1900, tm->tm_mon + 1, tm->tm_mday);
 			filter += "..20991231";
 			hasValue = false;
 			break;
-		case 12:
+		case 11:
 			filter = TimeConverter::toHHMMSSString(tm->tm_hour, tm->tm_min, tm->tm_sec);
 			filter += "..235959";
 			hasValue = false;
 			break;
-		case 13:
+		case 12:
 			filter += "0..10240b";
 			hasValue = false;
 			break;

Modified: trunk/UI/GTK2/src/queryDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog_glade.cc	2007-09-26 13:58:15 UTC (rev 992)
+++ trunk/UI/GTK2/src/queryDialog_glade.cc	2007-09-26 14:09:53 UTC (rev 993)
@@ -1,9 +1,9 @@
-// generated 2007/9/7 23:17:50 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/26 15:21:49 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.14 and gtkmm 2.10.9
+// glade-- /home/fabrice/Projects/pinot-0.76/UI/GTK2/metase-gtk2.glade
+// for gtk 2.10.14 and gtkmm 2.10.11
 //
 // Please modify the corresponding derived classes in ./src/queryDialog.cc
 
@@ -87,6 +87,9 @@
    Gtk::Adjustment *resultsCountSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(10, 10, 100, 10, 20, 20));
    resultsCountSpinbutton = Gtk::manage(new class Gtk::SpinButton(*resultsCountSpinbutton_adj, 1, 0));
    
+   Gtk::Label *sortOrderLabel = Gtk::manage(new class Gtk::Label(_("Sort order:")));
+   sortOrderCombobox = Gtk::manage(new class Gtk::ComboBoxText());
+   
    Gtk::Table *actionsTable = Gtk::manage(new class Gtk::Table(2, 2, false));
    Gtk::VBox *queryVbox = Gtk::manage(new class Gtk::VBox(false, 0));
    queryCancelbutton->set_flags(Gtk::CAN_FOCUS);
@@ -165,12 +168,20 @@
    resultsCountSpinbutton->set_numeric(false);
    resultsCountSpinbutton->set_digits(0);
    resultsCountSpinbutton->set_wrap(false);
+   sortOrderLabel->set_alignment(0,0.5);
+   sortOrderLabel->set_padding(0,0);
+   sortOrderLabel->set_justify(Gtk::JUSTIFY_LEFT);
+   sortOrderLabel->set_line_wrap(false);
+   sortOrderLabel->set_use_markup(false);
+   sortOrderLabel->set_selectable(false);
    actionsTable->set_row_spacings(0);
    actionsTable->set_col_spacings(0);
-   actionsTable->attach(*indexCheckbutton, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 4, 4);
-   actionsTable->attach(*labelNameCombobox, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   actionsTable->attach(*indexCheckbutton, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 4, 4);
+   actionsTable->attach(*labelNameCombobox, 1, 2, 2, 3, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    actionsTable->attach(*resultsCountLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 4, 4);
    actionsTable->attach(*resultsCountSpinbutton, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   actionsTable->attach(*sortOrderLabel, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 4, 4);
+   actionsTable->attach(*sortOrderCombobox, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    queryVbox->pack_start(*nameTable, Gtk::PACK_SHRINK, 0);
    queryVbox->pack_start(*queryHbox, Gtk::PACK_SHRINK, 0);
    queryVbox->pack_start(*queryFrame, Gtk::PACK_EXPAND_WIDGET, 4);
@@ -204,6 +215,8 @@
    labelNameCombobox->show();
    resultsCountLabel->show();
    resultsCountSpinbutton->show();
+   sortOrderLabel->show();
+   sortOrderCombobox->show();
    actionsTable->show();
    queryVbox->show();
    queryDialog->show();

Modified: trunk/UI/GTK2/src/queryDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/queryDialog_glade.hh	2007-09-26 13:58:15 UTC (rev 992)
+++ trunk/UI/GTK2/src/queryDialog_glade.hh	2007-09-26 14:09:53 UTC (rev 993)
@@ -1,9 +1,9 @@
-// generated 2007/9/7 23:17:50 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/26 15:21:49 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
-// for gtk 2.10.14 and gtkmm 2.10.9
+// glade-- /home/fabrice/Projects/pinot-0.76/UI/GTK2/metase-gtk2.glade
+// for gtk 2.10.14 and gtkmm 2.10.11
 //
 // Please modify the corresponding derived classes in ./src/queryDialog.hh and./src/queryDialog.cc
 
@@ -53,6 +53,7 @@
         class Gtk::CheckButton * indexCheckbutton;
         class Gtk::ComboBoxText * labelNameCombobox;
         class Gtk::SpinButton * resultsCountSpinbutton;
+        class Gtk::ComboBoxText * sortOrderCombobox;
         
         queryDialog_glade();
         



From fabricecolin at mail.berlios.de  Wed Sep 26 16:59:48 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 26 Sep 2007 16:59:48 +0200
Subject: [Pinot-svn] r994 - in trunk: Search UI/GTK2/src
Message-ID: <200709261459.l8QExmY5011914@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-26 16:59:46 +0200 (Wed, 26 Sep 2007)
New Revision: 994

Modified:
   trunk/Search/SearchEngineInterface.cpp
   trunk/Search/SearchEngineInterface.h
   trunk/Search/XapianEngine.cpp
   trunk/Search/XapianEngine.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/mainWindow.cc
Log:
QueryingThread and ExpandQueryThread made assumptions about how index stuff
works that are better encapsulated in SearchEngine classes.


Modified: trunk/Search/SearchEngineInterface.cpp
===================================================================
--- trunk/Search/SearchEngineInterface.cpp	2007-09-26 14:09:53 UTC (rev 993)
+++ trunk/Search/SearchEngineInterface.cpp	2007-09-26 14:59:46 UTC (rev 994)
@@ -36,17 +36,24 @@
 {
 }
 
-/// Sets the set of documents to expand from.
-bool SearchEngineInterface::setExpandSet(const set<unsigned int> &docsSet)
+/// Sets whether AND is the default operator.
+void SearchEngineInterface::setDefaultOperator(DefaultOperator op)
 {
+	m_defaultOperator = op;
+}
+
+/// Sets the set of documents to limit to.
+bool SearchEngineInterface::setLimitSet(const set<string> &docsSet)
+{
 	// Not all engines support this
 	return false;
 }
 
-/// Sets whether AND is the default operator.
-void SearchEngineInterface::setDefaultOperator(DefaultOperator op)
+/// Sets the set of documents to expand from.
+bool SearchEngineInterface::setExpandSet(const set<string> &docsSet)
 {
-	m_defaultOperator = op;
+	// Not all engines support this
+	return false;
 }
 
 /// Returns the downloader used if any.

Modified: trunk/Search/SearchEngineInterface.h
===================================================================
--- trunk/Search/SearchEngineInterface.h	2007-09-26 14:09:53 UTC (rev 993)
+++ trunk/Search/SearchEngineInterface.h	2007-09-26 14:59:46 UTC (rev 994)
@@ -34,16 +34,19 @@
 class SearchEngineInterface
 {
 	public:
+		typedef enum { DEFAULT_OP_AND = 0, DEFAULT_OP_OR } DefaultOperator;
+
 		virtual ~SearchEngineInterface();
 
-		/// Sets the set of documents to expand from.
-		virtual bool setExpandSet(const set<unsigned int> &docsSet);
-
-		typedef enum { DEFAULT_OP_AND = 0, DEFAULT_OP_OR } DefaultOperator;
-
 		/// Sets whether AND is the default operator.
 		virtual void setDefaultOperator(DefaultOperator op);
 
+		/// Sets the set of documents to limit to.
+		virtual bool setLimitSet(const set<string> &docsSet);
+
+		/// Sets the set of documents to expand from.
+		virtual bool setExpandSet(const set<string> &docsSet);
+
 		/// Returns the downloader used if any.
 		virtual DownloaderInterface *getDownloader(void);
 

Modified: trunk/Search/XapianEngine.cpp
===================================================================
--- trunk/Search/XapianEngine.cpp	2007-09-26 14:09:53 UTC (rev 993)
+++ trunk/Search/XapianEngine.cpp	2007-09-26 14:59:46 UTC (rev 994)
@@ -167,10 +167,11 @@
 
 Xapian::Query XapianEngine::parseQuery(Xapian::Database *pIndex, const QueryProperties &queryProps,
 	const string &stemLanguage, DefaultOperator defaultOperator,
-	string &correctedFreeQuery, bool minimal)
+	const string &limitQuery, string &correctedFreeQuery, bool minimal)
 {
 	Xapian::QueryParser parser;
 	Xapian::Stem stemmer;
+	string freeQuery(StringManip::replaceSubString(queryProps.getFreeQuery(), "\n", " "));
 	unsigned int minDay, minMonth, minYear = 0;
 	unsigned int maxDay, maxMonth, maxYear = 0;
 
@@ -218,6 +219,15 @@
 	parser.add_boolean_prefix("type", "T");
 	parser.add_boolean_prefix("label", "XLABEL:");
 
+	// Any limit on what documents should be searched ?
+	if (limitQuery.empty() == false)
+	{
+		freeQuery += limitQuery;
+#ifdef DEBUG
+		cout << "XapianEngine::parseQuery: " << freeQuery << endl;
+#endif
+	}
+
 	// What type of query is this ?
 	QueryProperties::QueryType type = queryProps.getType();
 	if (type != QueryProperties::XAPIAN_QP)
@@ -242,7 +252,7 @@
 
 		if (pParser != NULL)
 		{
-			bool parsedQuery = pParser->parse(queryProps.getFreeQuery(), builder);
+			bool parsedQuery = pParser->parse(freeQuery, builder);
 
 			delete pParser;
 
@@ -256,7 +266,6 @@
 	}
 
 	// Do some pre-processing : look for filters with quoted values
-	string freeQuery(StringManip::replaceSubString(queryProps.getFreeQuery(), "\n", " "));
 	string::size_type escapedFilterEnd = 0;
 	string::size_type escapedFilterStart = freeQuery.find(":\"");
 	while ((escapedFilterStart != string::npos) &&
@@ -310,18 +319,6 @@
 		escapedFilterStart = freeQuery.find(":\"", escapedFilterEnd);
 	}
 
-	// Activate all necessary options
-	unsigned int flags = Xapian::QueryParser::FLAG_BOOLEAN|Xapian::QueryParser::FLAG_PHRASE|
-		Xapian::QueryParser::FLAG_LOVEHATE|Xapian::QueryParser::FLAG_BOOLEAN_ANY_CASE|
-		Xapian::QueryParser::FLAG_PURE_NOT;
-	if (minimal == false)
-	{
-		flags |= Xapian::QueryParser::FLAG_WILDCARD;
-#if ENABLE_XAPIAN_SPELLING_CORRECTION>0
-		flags |= Xapian::QueryParser::FLAG_SPELLING_CORRECTION;
-#endif
-	}
-
 	// Date range
 	Xapian::DateValueRangeProcessor dateProcessor(0);
 	parser.add_valuerangeprocessor(&dateProcessor);
@@ -344,7 +341,17 @@
 	TimeValueRangeProcessor timeProcessor(3);
 	parser.add_valuerangeprocessor(&timeProcessor);
 
-	// Parse the query string
+	// Parse the query string with all necessary options
+	unsigned int flags = Xapian::QueryParser::FLAG_BOOLEAN|Xapian::QueryParser::FLAG_PHRASE|
+		Xapian::QueryParser::FLAG_LOVEHATE|Xapian::QueryParser::FLAG_BOOLEAN_ANY_CASE|
+		Xapian::QueryParser::FLAG_PURE_NOT;
+	if (minimal == false)
+	{
+		flags |= Xapian::QueryParser::FLAG_WILDCARD;
+#if ENABLE_XAPIAN_SPELLING_CORRECTION>0
+		flags |= Xapian::QueryParser::FLAG_SPELLING_CORRECTION;
+#endif
+	}
 	Xapian::Query parsedQuery = parser.parse_query(freeQuery, flags);
 	if (minimal == true)
 	{
@@ -461,11 +468,21 @@
 			Xapian::RSet expandDocs;
 			unsigned int count = 0;
 
-			for (set<unsigned int>::const_iterator docIter = m_expandDocuments.begin();
+			for (set<string>::const_iterator docIter = m_expandDocuments.begin();
 				docIter != m_expandDocuments.end(); ++docIter)
 			{
-				expandDocs.add_document(*docIter);
+				string uniqueTerm(string("U") + XapianDatabase::limitTermLength(Url::escapeUrl(Url::canonicalizeUrl(*docIter)), true));
+
+				// Only one document may have this term
+				Xapian::PostingIterator postingIter = pIndex->postlist_begin(uniqueTerm);
+				if (postingIter != pIndex->postlist_end(uniqueTerm))
+				{
+					expandDocs.add_document(*postingIter);
+				}
 			}
+#ifdef DEBUG
+			cout << "XapianEngine::queryDatabase: expand from " << expandDocs.size() << " documents" << endl;
+#endif
 
 			// Get 10 non-prefixed terms
 			PrefixDecider expandDecider("RS");
@@ -510,8 +527,42 @@
 // Implementation of SearchEngineInterface
 //
 
+/// Sets the set of documents to limit to.
+bool XapianEngine::setLimitSet(const set<string> &docsSet)
+{
+	bool firstLocation = true;
+
+	m_limitQuery.clear();
+
+	if (docsSet.empty() == true)
+	{
+		return true;
+	}
+
+	// FIXME: there must be a better way !
+	m_limitQuery = " +(";
+	for (set<string>::const_iterator docIter = docsSet.begin();
+		docIter != docsSet.end(); ++docIter)
+	{
+		if (firstLocation == false)
+		{
+			m_limitQuery += " or ";
+		}
+		m_limitQuery += "url:\"";
+		m_limitQuery += *docIter;
+		m_limitQuery += "\"";
+		firstLocation = false;
+	}
+	m_limitQuery += ")";
+#ifdef DEBUG
+	cout << "XapianEngine::setLimitSet: " << m_limitQuery << endl;
+#endif
+
+	return true;
+}
+
 /// Sets the set of documents to expand from.
-bool XapianEngine::setExpandSet(const set<unsigned int> &docsSet)
+bool XapianEngine::setExpandSet(const set<string> &docsSet)
 {
 	copy(docsSet.begin(), docsSet.end(),
 		inserter(m_expandDocuments, m_expandDocuments.begin()));
@@ -557,7 +608,7 @@
 		// 1. don't stem terms
 		// 2. if no results, stem terms if a language is defined for the query
 		Xapian::Query fullQuery = parseQuery(pIndex, queryProps, "",
-			m_defaultOperator, m_correctedFreeQuery);
+			m_defaultOperator, m_limitQuery, m_correctedFreeQuery);
 		while (fullQuery.empty() == false)
 		{
 #ifdef DEBUG
@@ -578,7 +629,7 @@
 				cout << "XapianEngine::runQuery: trying again with stemming" << endl;
 #endif
 				fullQuery = parseQuery(pIndex, queryProps, Languages::toEnglish(stemLanguage),
-					m_defaultOperator, m_correctedFreeQuery);
+					m_defaultOperator, m_limitQuery, m_correctedFreeQuery);
 				++searchStep;
 				continue;
 			}

Modified: trunk/Search/XapianEngine.h
===================================================================
--- trunk/Search/XapianEngine.h	2007-09-26 14:09:53 UTC (rev 993)
+++ trunk/Search/XapianEngine.h	2007-09-26 14:59:46 UTC (rev 994)
@@ -50,8 +50,11 @@
 		XapianEngine(const std::string &database);
 		virtual ~XapianEngine();
 
+		/// Sets the set of documents to limit to.
+		virtual bool setLimitSet(const std::set<std::string> &docsSet);
+
 		/// Sets the set of documents to expand from.
-		virtual bool setExpandSet(const std::set<unsigned int> &docsSet);
+		virtual bool setExpandSet(const std::set<std::string> &docsSet);
 
 		/// Runs a query; true if success.
 		virtual bool runQuery(QueryProperties& queryProps,
@@ -59,14 +62,15 @@
 
 	protected:
 		std::string m_databaseName;
-		std::set<Xapian::docid> m_expandDocuments;
+		std::string m_limitQuery;
+		std::set<std::string> m_expandDocuments;
 
 		bool queryDatabase(Xapian::Database *pIndex, Xapian::Query &query,
 			unsigned int startDoc, const QueryProperties &queryProps);
 
 		static Xapian::Query parseQuery(Xapian::Database *pIndex, const QueryProperties &queryProps,
 			const string &stemLanguage, DefaultOperator defaultOperator,
-			string &correctedFreeQuery, bool minimal = false);
+			const string &limitQuery, string &correctedFreeQuery, bool minimal = false);
 
 	private:
 		XapianEngine(const XapianEngine &other);

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-26 14:09:53 UTC (rev 993)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-26 14:59:46 UTC (rev 994)
@@ -69,34 +69,6 @@
 	}
 };
 
-static string locationsToMergedIndexIds(const set<string> &locations, set<unsigned int> &docIds)
-{
-	IndexInterface *pIndex = PinotSettings::getInstance().getIndex("MERGED");
-
-	if ((pIndex == NULL) ||
-		(pIndex->isGood() == false))
-	{
-		string status(_("Index error on"));
-		status += " MERGED";
-		if (pIndex != NULL)
-		{
-			delete pIndex;
-		}
-		return status;
-	}
-
-	for (set<string>::iterator locationIter = locations.begin();
-		locationIter != locations.end(); ++locationIter)
-	{
-		unsigned int docId = pIndex->hasDocument(*locationIter);
-		docIds.insert(docId);
-	}
-
-	delete pIndex;
-
-	return "";
-}
-
 Dispatcher WorkerThread::m_dispatcher;
 pthread_mutex_t WorkerThread::m_dispatcherMutex = PTHREAD_MUTEX_INITIALIZER;
 bool WorkerThread::m_immediateFlush = true;
@@ -744,33 +716,29 @@
 	m_documentsList.clear();
 	m_documentsList.reserve(m_maxDocsCount);
 
+	unsigned int indexId = PinotSettings::getInstance().getIndexId(m_indexName);
 	for (set<unsigned int>::iterator iter = docIDList.begin(); iter != docIDList.end(); ++iter)
 	{
+		unsigned int docId = (*iter);
+
 		if (m_done == true)
 		{
 			break;
 		}
 
-		// Get the document ID
-		unsigned int docId = (*iter);
-
 		DocumentInfo docInfo;
 		if (pIndex->getDocumentInfo(docId, docInfo) == true)
 		{
-			string type = docInfo.getType();
+			string type(docInfo.getType());
+
 			if (type.empty() == true)
 			{
-				type = "text/html";
+				docInfo.setType("text/html");
 			}
+			docInfo.setIsIndexed(indexId, docId);
 
-			DocumentInfo indexedDoc(docInfo.getTitle(), docInfo.getLocation(),
-				type, docInfo.getLanguage());
-			indexedDoc.setTimestamp(docInfo.getTimestamp());
-			indexedDoc.setSize(docInfo.getSize());
-			indexedDoc.setIsIndexed(PinotSettings::getInstance().getIndexId(m_indexName), docId);
-
 			// Insert that document
-			m_documentsList.push_back(indexedDoc);
+			m_documentsList.push_back(docInfo);
 			++numDocs;
 		}
 #ifdef DEBUG
@@ -797,6 +765,25 @@
 #endif
 }
 
+QueryingThread::QueryingThread(const string &engineName, const string &engineDisplayableName,
+	const string &engineOption, const QueryProperties &queryProps,
+	const set<string> &limitToDocsSet, unsigned int startDoc) :
+	ListerThread(engineDisplayableName, startDoc),
+	m_engineName("xapian"),
+	m_engineDisplayableName(engineDisplayableName),
+	m_engineOption(engineOption),
+	m_queryProps(queryProps),
+	m_listingIndex(false),
+	m_correctedSpelling(false)
+{
+	copy(limitToDocsSet.begin(), limitToDocsSet.end(),
+		inserter(m_limitToDocsSet, m_limitToDocsSet.begin()));
+#ifdef DEBUG
+	cout << "QueryingThread::QueryingThread: engine " << m_engineName << ", " << m_engineOption
+		<< ", limited to " << m_limitToDocsSet.size() << " documents" << endl;
+#endif
+}
+
 QueryingThread::~QueryingThread()
 {
 }
@@ -991,6 +978,11 @@
 		pDownloader->setSetting("proxytype", settings.m_proxyType);
 	}
 
+	if (m_listingIndex == false)
+	{
+		pEngine->setLimitSet(m_limitToDocsSet);
+	}
+
 	// Run the query
 	pEngine->setDefaultOperator(SearchEngineInterface::DEFAULT_OP_AND);
 	if (pEngine->runQuery(m_queryProps, m_startDoc) == false)
@@ -1039,8 +1031,8 @@
 	WorkerThread(),
 	m_queryProps(queryProps)
 {
-	// Get the IDs of the documents to expand from
-	m_status = locationsToMergedIndexIds(expandFromDocsSet, m_docIdsSet);
+	copy(expandFromDocsSet.begin(), expandFromDocsSet.end(),
+		inserter(m_expandFromDocsSet, m_expandFromDocsSet.begin()));
 }
 
 ExpandQueryThread::~ExpandQueryThread()
@@ -1070,12 +1062,6 @@
 
 void ExpandQueryThread::doWork(void)
 {
-	// Did locationsToMergedIndexIds() fail ?
-	if (m_status.empty() == false)
-	{
-		return;
-	}
-
 	// Get the SearchEngine
 	SearchEngineInterface *pEngine = SearchEngineFactory::getSearchEngine("xapian", "MERGED");
 	if (pEngine == NULL)
@@ -1087,7 +1073,7 @@
 	}
 
 	// Expand the query
-	pEngine->setExpandSet(m_docIdsSet);
+	pEngine->setExpandSet(m_expandFromDocsSet);
 
 	// Run the query
 	pEngine->setDefaultOperator(SearchEngineInterface::DEFAULT_OP_AND);
@@ -1110,8 +1096,10 @@
 	const map<string, string> &labelsToRename) :
 	WorkerThread()
 {
-	copy(labelsToDelete.begin(), labelsToDelete.end(), inserter(m_labelsToDelete, m_labelsToDelete.begin()));
-	copy(labelsToRename.begin(), labelsToRename.end(), inserter(m_labelsToRename, m_labelsToRename.begin()));
+	copy(labelsToDelete.begin(), labelsToDelete.end(),
+		inserter(m_labelsToDelete, m_labelsToDelete.begin()));
+	copy(labelsToRename.begin(), labelsToRename.end(),
+		inserter(m_labelsToRename, m_labelsToRename.begin()));
 }
 
 LabelUpdateThread::LabelUpdateThread(const string &labelName,

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2007-09-26 14:09:53 UTC (rev 993)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2007-09-26 14:59:46 UTC (rev 994)
@@ -211,6 +211,9 @@
 		QueryingThread(const std::string &engineName, const std::string &engineDisplayableName,
 			const std::string &engineOption, const QueryProperties &queryProps,
 			unsigned int startDoc = 0, bool listingIndex = false);
+		QueryingThread(const std::string &engineName, const std::string &engineDisplayableName,
+			const std::string &engineOption, const QueryProperties &queryProps,
+			const std::set<std::string> &limitToDocsSet, unsigned int startDoc = 0);
 		virtual ~QueryingThread();
 
 		virtual std::string getType(void) const;
@@ -229,6 +232,7 @@
 		std::string m_engineOption;
 		QueryProperties m_queryProps;
 		std::string m_resultsCharset;
+		std::set<std::string> m_limitToDocsSet;
 		bool m_listingIndex;
 		bool m_correctedSpelling;
 
@@ -262,7 +266,7 @@
 
 	protected:
 		QueryProperties m_queryProps;
-		std::set<unsigned int> m_docIdsSet;
+		std::set<std::string> m_expandFromDocsSet;
 		std::set<std::string> m_expandTerms;
 
 		virtual void doWork(void);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-26 14:09:53 UTC (rev 993)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-26 14:59:46 UTC (rev 994)
@@ -999,41 +999,22 @@
 	{
 		std::map<std::string, std::string> indexes = m_settings.getIndexes();
 		ustring queryName(queryProps.getName());
-		ustring queryStr(queryProps.getFreeQuery());
 		bool firstLocation = true;
 
-		queryProps.setName(queryName + " " + _("in results"));
-		queryStr += " +(";
-		for (set<string>::const_iterator locationIter = locations.begin();
-			locationIter != locations.end(); ++locationIter)
-		{
-			if (firstLocation == false)
-			{
-				queryStr += " or ";
-			}
-			queryStr += "url:\"";
-			queryStr += *locationIter;
-			queryStr += "\"";
-			firstLocation = false;
-		}
-		queryStr += ")";
-#ifdef DEBUG
-		cout << "mainWindow::on_searchagain_changed: " << queryStr << endl;
-#endif
-		queryProps.setFreeQuery(queryStr);
+		queryProps.setName(queryName + " " + _("In Results"));
 
 		// Spawn new threads
 		std::map<std::string, std::string>::const_iterator indexIter = indexes.find(_("My Documents"));
 		if (indexIter != indexes.end())
 		{
 			start_thread(new QueryingThread("xapian", indexIter->first,
-				indexIter->second, queryProps));
+				indexIter->second, queryProps, locations));
 		}
 		indexIter = indexes.find(_("My Web Pages"));
 		if (indexIter != indexes.end())
 		{
 			start_thread(new QueryingThread("xapian", indexIter->first,
-				indexIter->second, queryProps));
+				indexIter->second, queryProps, locations));
 		}
 	}
 }



From fabricecolin at mail.berlios.de  Wed Sep 26 17:01:40 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Wed, 26 Sep 2007 17:01:40 +0200
Subject: [Pinot-svn] r995 - trunk
Message-ID: <200709261501.l8QF1e8w012098@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-26 17:01:39 +0200 (Wed, 26 Sep 2007)
New Revision: 995

Modified:
   trunk/README
Log:
Updated blurb about filters. Talk about ranges.


Modified: trunk/README
===================================================================
--- trunk/README	2007-09-26 14:59:46 UTC (rev 994)
+++ trunk/README	2007-09-26 15:01:39 UTC (rev 995)
@@ -167,17 +167,17 @@
   When querying an index, Pinot attempts to find the documents that best match
   the query. The query is run first as is. If no results are found, the terms
   are stemmed and the query is run again.
-  Stemming is available only to Stored Queries for which a language is defined.
+  Stemming is available only to Stored Queries for which a language filter is
+  defined.
 
-  Queries can be expressed in a very natural way, using a combination of operators
-  and filters. For instance "type:text/html and lang:en and (tcp near ip)" looks
-  for HTML files in English that mention TCP/IP. 
+  Queries can be expressed in a very natural way, using a combination of
+  operators, filters and ranges. For instance, the query "type:text/html and
+  lang:en and (tcp near ip)" will look for HTML files in English that mention
+  TCP/IP. 
 
   Supported filters are :
-    * filters that apply to all engines
       "site" for host name, eg "site:pinot.berlios.de"
       "file" for file name, eg "file:index.html"
-    * filters that only apply to Current User engines
       "ext" for file extension, eg "ext:html"
       "title" for title, eg "title:Session"
       "url" for URL, eg "url:http://pinot.berlios.de/"
@@ -189,6 +189,13 @@
   Allowed language codes are "da", "nl", "en", "fi", "fr", "de", "it", "nn", "pt",
   "ru", "es" and "sv".
 
+  The values of "file", "url", "dir" and "label" may be double-quoted.
+
+  Supported ranges are :
+      "YYYYMMDD..YYYYMMDD" for date ranges, eg "20070801..20070831"
+      "HHMMSS..HHMMSS" for time ranges, eg "090000..180000"
+      "size0..size1b" for size in bytes, eg "0..10240b"
+
   For more information about the query syntax, you may want to have a look at the
   documentation for Xapian's QueryParser at http://www.xapian.org/docs/queryparser.html
 



From fabricecolin at mail.berlios.de  Thu Sep 27 14:32:03 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Thu, 27 Sep 2007 14:32:03 +0200
Subject: [Pinot-svn] r996 - trunk/SQL
Message-ID: <200709271232.l8RCW3Gx015507@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-27 14:32:02 +0200 (Thu, 27 Sep 2007)
New Revision: 996

Modified:
   trunk/SQL/QueryHistory.cpp
   trunk/SQL/QueryHistory.h
Log:
Overloaded deleteItems(), added getEngines().


Modified: trunk/SQL/QueryHistory.cpp
===================================================================
--- trunk/SQL/QueryHistory.cpp	2007-09-26 15:01:39 UTC (rev 995)
+++ trunk/SQL/QueryHistory.cpp	2007-09-27 12:32:02 UTC (rev 996)
@@ -134,6 +134,36 @@
 	return success;
 }
 
+/// Gets the list of engines the query was run on.
+bool QueryHistory::getEngines(const string &queryName, set<string> &enginesList)
+{
+	bool success = false;
+
+	SQLiteResults *results = executeStatement("SELECT EngineName FROM QueryHistory \
+		WHERE QueryName='%q' GROUP BY EngineName",
+		queryName.c_str());
+	if (results != NULL)
+	{
+		while (results->hasMoreRows() == true)
+		{
+			SQLiteRow *row = results->nextRow();
+			if (row == NULL)
+			{
+				break;
+			}
+
+			enginesList.insert(row->getColumn(0));
+			success = true;
+
+			delete row;
+		}
+
+		delete results;
+	}
+
+	return success;
+}
+
 /// Gets the first max items for the given query, engine pair.
 bool QueryHistory::getItems(const string &queryName, const string &engineName,
 	unsigned int max, vector<DocumentInfo> &resultsList)
@@ -275,6 +305,23 @@
 	return lastRun;
 }
 
+/// Deletes items at least as old as the given date.
+bool QueryHistory::deleteItems(const string &queryName, const string &engineName,
+	time_t cutOffDate)
+{
+	SQLiteResults *results = executeStatement("DELETE FROM QueryHistory \
+		WHERE QueryName='%q' AND EngineName='%q' AND Date<='%d';",
+		queryName.c_str(), engineName.c_str(), cutOffDate);
+	if (results != NULL)
+	{
+		delete results;
+
+		return true;
+	}
+
+	return false;
+}
+
 /// Deletes items.
 bool QueryHistory::deleteItems(const string &name, bool isQueryName)
 {

Modified: trunk/SQL/QueryHistory.h
===================================================================
--- trunk/SQL/QueryHistory.h	2007-09-26 15:01:39 UTC (rev 995)
+++ trunk/SQL/QueryHistory.h	2007-09-27 12:32:02 UTC (rev 996)
@@ -53,6 +53,9 @@
 		bool updateItem(const string &queryName, const string &engineName, const string &url,
 			const string &title, const string &extract, const string &charset, float score);
 
+		/// Gets the list of engines the query was run on.
+		bool getEngines(const string &queryName, set<string> &enginesList);
+
 		/// Gets the first max items for the given query, engine pair.
 		bool getItems(const string &queryName, const string &engineName,
 			unsigned int max, vector<DocumentInfo> &resultsList);
@@ -68,6 +71,10 @@
 		/// Gets a query's last run time.
 		string getLastRun(const string &queryName, const string &engineName = "");
 
+		/// Deletes items at least as old as the given date.
+		bool deleteItems(const string &queryName, const string &engineName,
+			time_t cutOffDate);
+
 		/// Deletes items.
 		bool deleteItems(const string &name, bool isQueryName);
 



From fabricecolin at mail.berlios.de  Thu Sep 27 14:36:17 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Thu, 27 Sep 2007 14:36:17 +0200
Subject: [Pinot-svn] r997 - in trunk/UI/GTK2: . src
Message-ID: <200709271236.l8RCaHaJ015953@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-27 14:36:15 +0200 (Thu, 27 Sep 2007)
New Revision: 997

Modified:
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/ResultsTree.cpp
   trunk/UI/GTK2/src/ResultsTree.h
   trunk/UI/GTK2/src/ServerThreads.cpp
   trunk/UI/GTK2/src/ServerThreads.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/mainWindow_glade.cc
   trunk/UI/GTK2/src/mainWindow_glade.hh
Log:
Query history button to show a stored query's latest results, for all engines
it's been run against, as found in the history database.
QueryingThread specializes into EngineQuery and EngineHistory sub-classes.
ResultsTree removes entries from previous queries if necessary.


Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/metase-gtk2.glade	2007-09-27 12:36:15 UTC (rev 997)
@@ -706,7 +706,7 @@
 		  <property agent="glademm" name="cxx_visibility">protected</property>
 		  <property name="visible">True</property>
 		  <property name="can_focus">True</property>
-		  <property name="expanded">True</property>
+		  <property name="expanded">False</property>
 		  <property name="spacing">0</property>
 
 		  <child>
@@ -785,6 +785,21 @@
 			  </child>
 
 			  <child>
+			    <widget class="GtkButton" id="queryHistoryButton">
+			      <property name="border_width">4</property>
+			      <property agent="glademm" name="cxx_visibility">protected</property>
+			      <property name="visible">True</property>
+			      <property name="can_default">True</property>
+			      <property name="can_focus">True</property>
+			      <property name="label">History</property>
+			      <property name="use_underline">True</property>
+			      <property name="relief">GTK_RELIEF_NORMAL</property>
+			      <property name="focus_on_click">True</property>
+			      <signal name="clicked" handler="on_queryHistoryButton_clicked" last_modification_time="Wed, 26 Sep 2007 15:13:22 GMT"/>
+			    </widget>
+			  </child>
+
+			  <child>
 			    <widget class="GtkButton" id="findQueryButton">
 			      <property name="border_width">4</property>
 			      <property agent="glademm" name="cxx_visibility">protected</property>
@@ -2254,7 +2269,7 @@
 	    <widget class="GtkTable" id="nameTable">
 	      <property name="visible">True</property>
 	      <property name="n_rows">1</property>
-	      <property name="n_columns">2</property>
+	      <property name="n_columns">3</property>
 	      <property name="homogeneous">False</property>
 	      <property name="row_spacing">0</property>
 	      <property name="column_spacing">0</property>
@@ -2311,6 +2326,27 @@
 		  <property name="y_options"></property>
 		</packing>
 	      </child>
+
+	      <child>
+		<widget class="GtkButton" id="queryHistoryButton">
+		  <property agent="glademm" name="cxx_visibility">protected</property>
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="label">Show History</property>
+		  <property name="use_underline">True</property>
+		  <property name="relief">GTK_RELIEF_NORMAL</property>
+		  <property name="focus_on_click">True</property>
+		  <signal name="clicked" handler="on_addFilterButton_clicked" last_modification_time="Sat, 14 Oct 2006 01:28:04 GMT"/>
+		</widget>
+		<packing>
+		  <property name="left_attach">2</property>
+		  <property name="right_attach">3</property>
+		  <property name="top_attach">0</property>
+		  <property name="bottom_attach">1</property>
+		  <property name="x_options">fill</property>
+		  <property name="y_options"></property>
+		</packing>
+	      </child>
 	    </widget>
 	    <packing>
 	      <property name="padding">0</property>

Modified: trunk/UI/GTK2/src/ResultsTree.cpp
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.cpp	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/ResultsTree.cpp	2007-09-27 12:36:15 UTC (rev 997)
@@ -458,7 +458,7 @@
 // Returns true if something was added to the tree.
 //
 bool ResultsTree::addResults(const string &engineName, const vector<DocumentInfo> &resultsList,
-	const string &charset)
+	const string &charset, bool updateHistory)
 {
 	std::map<string, TreeModel::iterator> updatedGroups;
 	ResultsModelColumns::RowType rootType;
@@ -502,15 +502,23 @@
 
 	QueryHistory queryHistory(m_settings.getHistoryDatabaseName());
 	ViewHistory viewHistory(m_settings.getHistoryDatabaseName());
+	string lastRun(queryHistory.getLastRun(m_treeName, engineName));
+	time_t lastRunTime = 0;
 	bool isNewQuery = false;
-	if (queryHistory.getLastRun(m_treeName, engineName).empty() == true)
+
+	// Is this a new query ?
+	if (lastRun.empty() == true)
 	{
 		isNewQuery = true;
 	}
+	else
+	{
+		lastRunTime = TimeConverter::fromTimestamp(lastRun);
+	}
 
 	// Look at the results list
 #ifdef DEBUG
-	cout << "ResultsTree::addResults: " << resultsList.size() << " results" << endl;
+	cout << "ResultsTree::addResults: " << resultsList.size() << " results, last run " << lastRun << endl;
 #endif
 	for (vector<DocumentInfo>::const_iterator resultIter = resultsList.begin();
 		resultIter != resultsList.end(); ++resultIter)
@@ -544,16 +552,22 @@
 				location, oldestScore);
 			if (previousScore > 0)
 			{
-				// Update this result whatever the current and previous rankings were
-				queryHistory.updateItem(m_treeName, engineName, location,
-					title, extract, charset, currentScore);
+				if (updateHistory == true)
+				{
+					// Update this result whatever the current and previous rankings were
+					queryHistory.updateItem(m_treeName, engineName, location,
+						title, extract, charset, currentScore);
+				}
 				rankDiff = (int)(currentScore - previousScore);
 			}
 			else
 			{
 				// No, this is a new result
-				queryHistory.insertItem(m_treeName, engineName, location,
-					resultIter->getTitle(), extract, charset, currentScore);
+				if (updateHistory == true)
+				{
+					queryHistory.insertItem(m_treeName, engineName, location,
+						resultIter->getTitle(), extract, charset, currentScore);
+				}
 				// New results are displayed as such only if the query has already been run on the engine
 				if (isNewQuery == false)
 				{
@@ -595,6 +609,17 @@
 		}
 	}
 
+	// Remove older items ?
+	if ((isNewQuery == false) &&
+		(updateHistory == true))
+	{
+#ifdef DEBUG
+		cout << "ResultsTree::addResults: removing items for " << m_treeName
+			<< ", " << engineName << " older than " << lastRunTime << endl;
+#endif
+		queryHistory.deleteItems(m_treeName, engineName, lastRunTime);
+	}
+
 	if (count > 0)
 	{
 #ifdef DEBUG

Modified: trunk/UI/GTK2/src/ResultsTree.h
===================================================================
--- trunk/UI/GTK2/src/ResultsTree.h	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/ResultsTree.h	2007-09-27 12:36:15 UTC (rev 997)
@@ -64,7 +64,7 @@
 		  * Returns true if something was added to the tree.
 		  */
 		bool addResults(const std::string &engineName, const std::vector<DocumentInfo> &resultsList,
-			const std::string &charset);
+			const std::string &charset, bool updateHistory);
 
 		/// Sets how results are grouped.
 		void setGroupMode(GroupByMode groupMode);

Modified: trunk/UI/GTK2/src/ServerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.cpp	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/ServerThreads.cpp	2007-09-27 12:36:15 UTC (rev 997)
@@ -549,12 +549,6 @@
 	return "DBusServletThread";
 }
 
-bool DBusServletThread::stop(void)
-{
-	m_done = true;
-	return true;
-}
-
 DBusConnection *DBusServletThread::getConnection(void) const
 {
 	return m_pConnection;

Modified: trunk/UI/GTK2/src/ServerThreads.h
===================================================================
--- trunk/UI/GTK2/src/ServerThreads.h	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/ServerThreads.h	2007-09-27 12:36:15 UTC (rev 997)
@@ -91,8 +91,6 @@
 
 		virtual std::string getType(void) const;
 
-		virtual bool stop(void);
-
 		DBusConnection *getConnection(void) const;
 
 		DBusMessage *getReply(void) const;

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2007-09-27 12:36:15 UTC (rev 997)
@@ -128,6 +128,13 @@
 	return Thread::create(slot_class(*this, &WorkerThread::threadHandler), false);
 }
 
+bool WorkerThread::stop(void)
+{
+	m_done = true;
+
+	return true;
+}
+
 bool WorkerThread::isDone(void) const
 {
 	return m_done;
@@ -659,12 +666,6 @@
 {
 }
 
-bool IndexBrowserThread::stop(void)
-{
-	m_done = true;
-	return true;
-}
-
 void IndexBrowserThread::doWork(void)
 {
 	set<unsigned int> docIDList;
@@ -757,33 +758,11 @@
 	m_engineOption(engineOption),
 	m_queryProps(queryProps),
 	m_listingIndex(listingIndex),
-	m_correctedSpelling(false)
+	m_correctedSpelling(false),
+	m_isLive(true)
 {
-#ifdef DEBUG
-	cout << "QueryingThread::QueryingThread: engine " << m_engineName << ", " << m_engineOption
-		<< ", mode " << m_listingIndex << endl;
-#endif
 }
 
-QueryingThread::QueryingThread(const string &engineName, const string &engineDisplayableName,
-	const string &engineOption, const QueryProperties &queryProps,
-	const set<string> &limitToDocsSet, unsigned int startDoc) :
-	ListerThread(engineDisplayableName, startDoc),
-	m_engineName("xapian"),
-	m_engineDisplayableName(engineDisplayableName),
-	m_engineOption(engineOption),
-	m_queryProps(queryProps),
-	m_listingIndex(false),
-	m_correctedSpelling(false)
-{
-	copy(limitToDocsSet.begin(), limitToDocsSet.end(),
-		inserter(m_limitToDocsSet, m_limitToDocsSet.begin()));
-#ifdef DEBUG
-	cout << "QueryingThread::QueryingThread: engine " << m_engineName << ", " << m_engineOption
-		<< ", limited to " << m_limitToDocsSet.size() << " documents" << endl;
-#endif
-}
-
 QueryingThread::~QueryingThread()
 {
 }
@@ -798,6 +777,11 @@
 	return "QueryingThread";
 }
 
+bool QueryingThread::isLive(void) const
+{
+	return m_isLive;
+}
+
 string QueryingThread::getEngineName(void) const
 {
 	return m_engineDisplayableName;
@@ -814,14 +798,36 @@
 	return m_resultsCharset;
 }
 
-bool QueryingThread::stop(void)
+EngineQueryThread::EngineQueryThread(const string &engineName, const string &engineDisplayableName,
+	const string &engineOption, const QueryProperties &queryProps,
+	unsigned int startDoc, bool listingIndex) :
+	QueryingThread(engineName, engineDisplayableName, engineOption, queryProps, startDoc, listingIndex)
 {
-	m_done = true;
-	return true;
+#ifdef DEBUG
+	cout << "EngineQueryThread::EngineQueryThread: engine " << m_engineName << ", " << m_engineOption
+		<< ", mode " << m_listingIndex << endl;
+#endif
 }
 
-void QueryingThread::processResults(const vector<DocumentInfo> &resultsList)
+EngineQueryThread::EngineQueryThread(const string &engineName, const string &engineDisplayableName,
+	const string &engineOption, const QueryProperties &queryProps,
+	const set<string> &limitToDocsSet, unsigned int startDoc) :
+	QueryingThread(engineName, engineDisplayableName, engineOption, queryProps, startDoc, false)
 {
+	copy(limitToDocsSet.begin(), limitToDocsSet.end(),
+		inserter(m_limitToDocsSet, m_limitToDocsSet.begin()));
+#ifdef DEBUG
+	cout << "EngineQueryThread::EngineQueryThread: engine " << m_engineName << ", " << m_engineOption
+		<< ", limited to " << m_limitToDocsSet.size() << " documents" << endl;
+#endif
+}
+
+EngineQueryThread::~EngineQueryThread()
+{
+}
+
+void EngineQueryThread::processResults(const vector<DocumentInfo> &resultsList)
+{
 	PinotSettings &settings = PinotSettings::getInstance();
 	IndexInterface *pDocsIndex = NULL;
 	IndexInterface *pDaemonIndex = NULL;
@@ -868,7 +874,7 @@
 		}
 		currentDoc.setTitle(title);
 #ifdef DEBUG
-		cout << "QueryingThread::processResults: title is " << title << endl;
+		cout << "EngineQueryThread::processResults: title is " << title << endl;
 #endif
 
 		// Use the query's language if the result's is unknown
@@ -911,11 +917,11 @@
 		{
 			currentDoc.setIsIndexed(indexId, docId);
 #ifdef DEBUG
-			cout << "QueryingThread::processResults: found in index " << indexId << endl;
+			cout << "EngineQueryThread::processResults: found in index " << indexId << endl;
 #endif
 		}
 #ifdef DEBUG
-		else cout << "QueryingThread::processResults: not found in any index" << endl;
+		else cout << "EngineQueryThread::processResults: not found in any index" << endl;
 #endif
 
 		m_documentsList.push_back(currentDoc);
@@ -931,7 +937,7 @@
 	}
 }
 
-void QueryingThread::processResults(const vector<DocumentInfo> &resultsList,
+void EngineQueryThread::processResults(const vector<DocumentInfo> &resultsList,
 	unsigned int indexId)
 {
 	unsigned int zeroId = 0;
@@ -950,7 +956,7 @@
 	}
 }
 
-void QueryingThread::doWork(void)
+void EngineQueryThread::doWork(void)
 {
 	PinotSettings &settings = PinotSettings::getInstance();
 
@@ -999,7 +1005,7 @@
 		m_documentsList.reserve(resultsList.size());
 		m_documentsCount = pEngine->getResultsCountEstimate();
 #ifdef DEBUG
-		cout << "QueryingThread::doWork: " << resultsList.size() << " off " << m_documentsCount
+		cout << "EngineQueryThread::doWork: " << resultsList.size() << " off " << m_documentsCount
 			<< " results to process, starting at position " << m_startDoc << endl;
 #endif
 
@@ -1026,6 +1032,40 @@
 	delete pEngine;
 }
 
+EngineHistoryThread::EngineHistoryThread(const string &engineDisplayableName,
+	const QueryProperties &queryProps, unsigned int maxDocsCount) :
+	QueryingThread("", engineDisplayableName, "", queryProps, 0, false),
+	m_maxDocsCount(maxDocsCount)
+{
+#ifdef DEBUG
+	cout << "EngineHistoryThread::EngineHistoryThread: engine " << m_engineDisplayableName << endl;
+#endif
+	m_isLive = false;
+}
+
+EngineHistoryThread::~EngineHistoryThread()
+{
+}
+
+void EngineHistoryThread::doWork(void)
+{
+	QueryHistory history(PinotSettings::getInstance().getHistoryDatabaseName());
+
+	if (history.getItems(m_queryProps.getName(), m_engineDisplayableName,
+		m_maxDocsCount, m_documentsList) == false)
+	{
+		m_status = _("Couldn't get history for search engine");
+		m_status += " ";
+		m_status += m_engineDisplayableName;
+	}
+	else if (m_documentsList.empty() == false)
+	{
+		// Get the first result's charset
+		history.getItemExtract(m_queryProps.getName(), m_engineDisplayableName,
+			m_documentsList.front().getLocation(), m_resultsCharset);
+	}
+}
+
 ExpandQueryThread::ExpandQueryThread(const QueryProperties &queryProps,
 	const set<string> &expandFromDocsSet) :
 	WorkerThread(),
@@ -1054,12 +1094,6 @@
 	return m_expandTerms;
 }
 
-bool ExpandQueryThread::stop(void)
-{
-	m_done = true;
-	return true;
-}
-
 void ExpandQueryThread::doWork(void)
 {
 	// Get the SearchEngine
@@ -1120,12 +1154,6 @@
 	return "LabelUpdateThread";
 }
 
-bool LabelUpdateThread::stop(void)
-{
-	m_done = true;
-	return true;
-}
-
 void LabelUpdateThread::doWork(void)
 {
 	IndexInterface *pDocsIndex = PinotSettings::getInstance().getIndex(PinotSettings::getInstance().m_docsIndexLocation);
@@ -1214,12 +1242,6 @@
 	return m_pDoc;
 }
 
-bool DownloadingThread::stop(void)
-{
-	m_done = true;
-	return true;
-}
-
 void DownloadingThread::doWork(void)
 {
 	if (m_pDownloader != NULL)
@@ -1305,17 +1327,6 @@
 	return true;
 }
 
-bool IndexingThread::stop(void)
-{
-	if (DownloadingThread::stop() == true)
-	{
-		m_done = true;
-		return true;
-	}
-
-	return false;
-}
-
 void IndexingThread::doWork(void)
 {
 	IndexInterface *pIndex = PinotSettings::getInstance().getIndex(m_indexLocation);
@@ -1583,12 +1594,6 @@
 	return m_docsCount;
 }
 
-bool UnindexingThread::stop(void)
-{
-	m_done = true;
-	return true;
-}
-
 void UnindexingThread::doWork(void)
 {
 	IndexInterface *pIndex = PinotSettings::getInstance().getIndex(m_indexLocation);
@@ -1702,12 +1707,6 @@
 	return m_docInfo;
 }
 
-bool UpdateDocumentThread::stop(void)
-{
-	m_done = true;
-	return true;
-}
-
 void UpdateDocumentThread::doWork(void)
 {
 	if (m_done == false)
@@ -1773,12 +1772,6 @@
 	return "StartDaemonThread";
 }
 
-bool StartDaemonThread::stop(void)
-{
-	m_done = true;
-	return true;
-}
-
 void StartDaemonThread::doWork(void)
 {
 	if (m_done == false)

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2007-09-27 12:36:15 UTC (rev 997)
@@ -63,7 +63,7 @@
 
 		virtual std::string getType(void) const = 0;
 
-		virtual bool stop(void) = 0;
+		virtual bool stop(void);
 
 		bool isDone(void) const;
 
@@ -192,8 +192,6 @@
 
 		std::string getLabelName(void) const;
 
-		virtual bool stop(void);
-
 	protected:
 		unsigned int m_maxDocsCount;
 
@@ -211,31 +209,48 @@
 		QueryingThread(const std::string &engineName, const std::string &engineDisplayableName,
 			const std::string &engineOption, const QueryProperties &queryProps,
 			unsigned int startDoc = 0, bool listingIndex = false);
-		QueryingThread(const std::string &engineName, const std::string &engineDisplayableName,
-			const std::string &engineOption, const QueryProperties &queryProps,
-			const std::set<std::string> &limitToDocsSet, unsigned int startDoc = 0);
 		virtual ~QueryingThread();
 
 		virtual std::string getType(void) const;
 
+		bool isLive(void) const;
+
 		std::string getEngineName(void) const;
 
 		QueryProperties getQuery(bool &wasCorrected) const;
 
 		std::string getCharset(void) const;
 
-		virtual bool stop(void);
-
 	protected:
 		std::string m_engineName;
 		std::string m_engineDisplayableName;
 		std::string m_engineOption;
 		QueryProperties m_queryProps;
 		std::string m_resultsCharset;
-		std::set<std::string> m_limitToDocsSet;
 		bool m_listingIndex;
 		bool m_correctedSpelling;
+		bool m_isLive;
 
+	private:
+		QueryingThread(const QueryingThread &other);
+		QueryingThread &operator=(const QueryingThread &other);
+
+};
+
+class EngineQueryThread : public QueryingThread
+{
+	public:
+		EngineQueryThread(const std::string &engineName, const std::string &engineDisplayableName,
+			const std::string &engineOption, const QueryProperties &queryProps,
+			unsigned int startDoc = 0, bool listingIndex = false);
+		EngineQueryThread(const std::string &engineName, const std::string &engineDisplayableName,
+			const std::string &engineOption, const QueryProperties &queryProps,
+			const std::set<std::string> &limitToDocsSet, unsigned int startDoc = 0);
+		virtual ~EngineQueryThread();
+
+	protected:
+		std::set<std::string> m_limitToDocsSet;
+
 		virtual void processResults(const std::vector<DocumentInfo> &resultsList);
 
 		virtual void processResults(const std::vector<DocumentInfo> &resultsList,
@@ -244,11 +259,29 @@
 		virtual void doWork(void);
 
 	private:
-		QueryingThread(const QueryingThread &other);
-		QueryingThread &operator=(const QueryingThread &other);
+		EngineQueryThread(const EngineQueryThread &other);
+		EngineQueryThread &operator=(const EngineQueryThread &other);
 
 };
 
+class EngineHistoryThread : public QueryingThread
+{
+	public:
+		EngineHistoryThread(const std::string &engineDisplayableName,
+			const QueryProperties &queryProps, unsigned int maxDocsCount);
+		virtual ~EngineHistoryThread();
+
+	protected:
+		unsigned int m_maxDocsCount;
+
+		virtual void doWork(void);
+
+	private:
+		EngineHistoryThread(const EngineHistoryThread &other);
+		EngineHistoryThread &operator=(const EngineHistoryThread &other);
+
+};
+
 class ExpandQueryThread : public WorkerThread
 {
 	public:
@@ -262,8 +295,6 @@
 
 		const std::set<std::string> &getExpandTerms(void) const;
 
-		virtual bool stop(void);
-
 	protected:
 		QueryProperties m_queryProps;
 		std::set<std::string> m_expandFromDocsSet;
@@ -290,8 +321,6 @@
 
 		virtual std::string getType(void) const;
 
-		virtual bool stop(void);
-
 	protected:
 		std::set<std::string> m_labelsToDelete;
 		std::map<std::string, std::string> m_labelsToRename;
@@ -319,8 +348,6 @@
 
 		const Document *getDocument(void) const;
 
-		virtual bool stop(void);
-
 	protected:
 		DocumentInfo m_docInfo;
 		Document *m_pDoc;
@@ -351,8 +378,6 @@
 
 		bool isNewDocument(void) const;
 
-		virtual bool stop(void);
-
 	protected:
 		DocumentInfo m_docInfo;
 		unsigned int m_docId;
@@ -381,8 +406,6 @@
 
 		unsigned int getDocumentsCount(void) const;
 
-		virtual bool stop(void);
-
 	protected:
 		std::set<unsigned int> m_docIdList;
 		std::set<std::string> m_labelNames;
@@ -411,8 +434,6 @@
 
 		const DocumentInfo &getDocumentInfo(void) const;
 
-		virtual bool stop(void);
-
 	protected:
 		std::string m_indexName;
 		unsigned int m_docId;
@@ -435,8 +456,6 @@
 
 		virtual std::string getType(void) const;
 
-		virtual bool stop(void);
-
 	protected:
 		virtual void doWork(void);
 

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/mainWindow.cc	2007-09-27 12:36:15 UTC (rev 997)
@@ -241,6 +241,7 @@
 
 	// Gray out menu items
 	removeQueryButton->set_sensitive(false);
+	queryHistoryButton->set_sensitive(false);
 	findQueryButton->set_sensitive(false);
 	show_global_menuitems(false);
 	show_selectionbased_menuitems(false);
@@ -254,6 +255,7 @@
 	m_tooltips.set_tip(*removeIndexButton, _("Remove an index"));
 	m_tooltips.set_tip(*addQueryButton, _("Add a query"));
 	m_tooltips.set_tip(*removeQueryButton, _("Remove a query"));
+	m_tooltips.set_tip(*queryHistoryButton, _("Show the query's previous results"));
 	m_tooltips.set_tip(*findQueryButton, _("Find documents that match the query"));
 
 	// Connect to threads' finished signal
@@ -639,6 +641,7 @@
 	}
 
 	removeQueryButton->set_sensitive(enableButtons);
+	queryHistoryButton->set_sensitive(enableButtons);
 	findQueryButton->set_sensitive(enableButtons);
 }
 
@@ -1007,13 +1010,13 @@
 		std::map<std::string, std::string>::const_iterator indexIter = indexes.find(_("My Documents"));
 		if (indexIter != indexes.end())
 		{
-			start_thread(new QueryingThread("xapian", indexIter->first,
+			start_thread(new EngineQueryThread("xapian", indexIter->first,
 				indexIter->second, queryProps, locations));
 		}
 		indexIter = indexes.find(_("My Web Pages"));
 		if (indexIter != indexes.end())
 		{
-			start_thread(new QueryingThread("xapian", indexIter->first,
+			start_thread(new EngineQueryThread("xapian", indexIter->first,
 				indexIter->second, queryProps, locations));
 		}
 	}
@@ -1179,7 +1182,7 @@
 				const vector<DocumentInfo> &docsList = pListThread->getDocuments();
 
 				// Add the documents to the tree
-				pResultsTree->addResults("", docsList, "");
+				pResultsTree->addResults("", docsList, "", false);
 
 				pIndexPage->setDocumentsCount(pListThread->getDocumentsCount());
 				pIndexPage->updateButtonsState(m_maxDocsCount);
@@ -1291,7 +1294,7 @@
 			// Add the results to the tree, using the current group by mode
 			pResultsTree->deleteResults(engineName);
 			pResultsTree->addResults(engineName, resultsList,
-				resultsCharset);
+				resultsCharset, pQueryThread->isLive());
 		}
 
 		// Suggest the correction to the user
@@ -2804,6 +2807,41 @@
 }
 
 //
+// Previous Results button click
+//
+void mainWindow::on_queryHistoryButton_clicked()
+{
+	TreeModel::iterator queryIter = queryTreeview->get_selection()->get_selected();
+	// Any query selected ?
+	if (queryIter)
+	{
+		QueryHistory history(m_settings.getHistoryDatabaseName());
+		TreeModel::Row queryRow = *queryIter;
+		set<string> engineNames;
+		QueryProperties queryProps = queryRow[m_queryColumns.m_properties];
+		ustring queryName(queryRow[m_queryColumns.m_name]);
+
+		if ((history.getEngines(queryName, engineNames) == false) ||
+			(engineNames.empty() == true))
+		{
+			ustring statusText = _("No history for");
+			statusText += " ";
+			statusText += queryName;
+
+			set_status(statusText);
+			return;
+		}
+
+		for (set<string>::const_iterator engineIter = engineNames.begin();
+			engineIter != engineNames.end(); ++engineIter)
+		{
+			// Spawn a new thread
+			start_thread(new EngineHistoryThread(*engineIter, queryProps, m_maxDocsCount));
+		}
+	}
+}
+
+//
 // Find query button click
 //
 void mainWindow::on_findQueryButton_clicked()
@@ -3292,7 +3330,7 @@
 		set_status(status);
 
 		// Spawn a new thread
-		start_thread(new QueryingThread(from_utf8(engineName),
+		start_thread(new EngineQueryThread(from_utf8(engineName),
 			from_utf8(engineDisplayableName), engineOption, queryProps));
 	}
 }
@@ -3350,7 +3388,7 @@
 			std::map<string, string>::const_iterator mapIter = indexesMap.find(indexName);
 			if (mapIter != indexesMap.end())
 			{
-				start_thread(new QueryingThread("xapian", from_utf8(indexName),
+				start_thread(new EngineQueryThread("xapian", from_utf8(indexName),
 					mapIter->second, queryProps, startDoc, true));
 			}
 #ifdef DEBUG
@@ -3570,7 +3608,7 @@
 
 		// Add a row
 		docsList.push_back(docInfo);
-		pResultsTree->addResults("", docsList, "");
+		pResultsTree->addResults("", docsList, "", false);
 
 		return true;
 	}

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/mainWindow.hh	2007-09-27 12:36:15 UTC (rev 997)
@@ -117,6 +117,7 @@
 	virtual void on_findButton_clicked();
 	virtual void on_addQueryButton_clicked();
 	virtual void on_removeQueryButton_clicked();
+	virtual void on_queryHistoryButton_clicked();
 	virtual void on_findQueryButton_clicked();
 
 	virtual void on_indexBackButton_clicked(Glib::ustring indexName);

Modified: trunk/UI/GTK2/src/mainWindow_glade.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.cc	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/mainWindow_glade.cc	2007-09-27 12:36:15 UTC (rev 997)
@@ -1,4 +1,4 @@
-// generated 2007/9/24 22:21:22 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/26 23:15:09 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -41,7 +41,6 @@
 #include <gtkmm/menuitem.h>
 #include <gtkmm/menu.h>
 #include <gtkmm/image.h>
-#include <gtkmm/imagemenuitem.h>
 #include <gtkmm/menubar.h>
 #include <gtkmm/box.h>
 #include <gtkmm/label.h>
@@ -89,8 +88,8 @@
    viewcache1 = NULL;
    Gtk::Image *image719 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-add"), Gtk::IconSize(1)));
    morelikethis1 = NULL;
+   Gtk::Image *image720 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-find"), Gtk::IconSize(1)));
    searchagain1 = NULL;
-   Gtk::Image *image720 = Gtk::manage(new class Gtk::Image(Gtk::StockID("gtk-find"), Gtk::IconSize(1)));
    indexresults1 = NULL;
    Gtk::Menu *resultsMenuitem_menu = Gtk::manage(new class Gtk::Menu());
    resultsMenuitem = NULL;
@@ -136,6 +135,7 @@
    Gtk::ScrolledWindow *queryScrolledwindow = Gtk::manage(new class Gtk::ScrolledWindow());
    addQueryButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-add")));
    removeQueryButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-remove")));
+   queryHistoryButton = Gtk::manage(new class Gtk::Button(_("History")));
    findQueryButton = Gtk::manage(new class Gtk::Button(Gtk::StockID("gtk-find")));
    
    Gtk::VButtonBox *queryVbuttonbox = Gtk::manage(new class Gtk::VButtonBox(Gtk::BUTTONBOX_START, 0));
@@ -334,12 +334,17 @@
    removeQueryButton->set_flags(Gtk::CAN_DEFAULT);
    removeQueryButton->set_border_width(4);
    removeQueryButton->set_relief(Gtk::RELIEF_NORMAL);
+   queryHistoryButton->set_flags(Gtk::CAN_FOCUS);
+   queryHistoryButton->set_flags(Gtk::CAN_DEFAULT);
+   queryHistoryButton->set_border_width(4);
+   queryHistoryButton->set_relief(Gtk::RELIEF_NORMAL);
    findQueryButton->set_flags(Gtk::CAN_FOCUS);
    findQueryButton->set_flags(Gtk::CAN_DEFAULT);
    findQueryButton->set_border_width(4);
    findQueryButton->set_relief(Gtk::RELIEF_NORMAL);
    queryVbuttonbox->pack_start(*addQueryButton);
    queryVbuttonbox->pack_start(*removeQueryButton);
+   queryVbuttonbox->pack_start(*queryHistoryButton);
    queryVbuttonbox->pack_start(*findQueryButton);
    queryHbox->pack_start(*queryScrolledwindow);
    queryHbox->pack_start(*queryVbuttonbox, Gtk::PACK_SHRINK, 0);
@@ -435,6 +440,7 @@
    queryScrolledwindow->show();
    addQueryButton->show();
    removeQueryButton->show();
+   queryHistoryButton->show();
    findQueryButton->show();
    queryVbuttonbox->show();
    queryHbox->show();
@@ -475,6 +481,7 @@
    queryTreeview->signal_button_press_event().connect(SigC::slot(*this, &mainWindow_glade::on_queryTreeview_button_press_event), false);
    addQueryButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_addQueryButton_clicked), false);
    removeQueryButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_removeQueryButton_clicked), false);
+   queryHistoryButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_queryHistoryButton_clicked), false);
    findQueryButton->signal_clicked().connect(SigC::slot(*this, &mainWindow_glade::on_findQueryButton_clicked), false);
    mainWindow->signal_delete_event().connect(SigC::slot(*this, &mainWindow_glade::on_mainWindow_delete_event), false);
 }

Modified: trunk/UI/GTK2/src/mainWindow_glade.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow_glade.hh	2007-09-27 12:32:02 UTC (rev 996)
+++ trunk/UI/GTK2/src/mainWindow_glade.hh	2007-09-27 12:36:15 UTC (rev 997)
@@ -1,4 +1,4 @@
-// generated 2007/9/24 22:21:22 SGT by fabrice at amra.dyndns.org.(none)
+// generated 2007/9/26 23:15:09 SGT by fabrice at amra.dyndns.org.(none)
 // using glademm V2.12.1
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -94,6 +94,7 @@
         class Gtk::TreeView * queryTreeview;
         class Gtk::Button * addQueryButton;
         class Gtk::Button * removeQueryButton;
+        class Gtk::Button * queryHistoryButton;
         class Gtk::Button * findQueryButton;
         class Gtk::Expander * queryExpander;
         class Gtk::VBox * rightVbox;
@@ -134,6 +135,7 @@
         virtual bool on_queryTreeview_button_press_event(GdkEventButton *ev) = 0;
         virtual void on_addQueryButton_clicked() = 0;
         virtual void on_removeQueryButton_clicked() = 0;
+        virtual void on_queryHistoryButton_clicked() = 0;
         virtual void on_findQueryButton_clicked() = 0;
         virtual bool on_mainWindow_delete_event(GdkEventAny *ev) = 0;
 };



From fabricecolin at mail.berlios.de  Sat Sep 29 08:00:42 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sat, 29 Sep 2007 08:00:42 +0200
Subject: [Pinot-svn] r998 - in trunk: . Search UI/GTK2/src
Message-ID: <200709290600.l8T60gJk016402@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-29 08:00:41 +0200 (Sat, 29 Sep 2007)
New Revision: 998

Modified:
   trunk/Search/XapianEngine.h
   trunk/UI/GTK2/src/pinot-dbus-daemon.cc
   trunk/UI/GTK2/src/pinot.cc
   trunk/configure.in
Log:
NUM_VERSION defines for Xapian and DBus.


Modified: trunk/Search/XapianEngine.h
===================================================================
--- trunk/Search/XapianEngine.h	2007-09-27 12:36:15 UTC (rev 997)
+++ trunk/Search/XapianEngine.h	2007-09-29 06:00:41 UTC (rev 998)
@@ -28,20 +28,15 @@
 #include "SearchEngineInterface.h"
 #include "DownloaderFactory.h"
 
+#if !ENABLE_XAPIAN_SPELLING_CORRECTION
 // Spelling correction in Xapian <= 1.0.2 may cause a crash
 // See http://www.xapian.org/cgi-bin/bugzilla/show_bug.cgi?id=194
-#define ENABLE_XAPIAN_SPELLING_CORRECTION 0
-#if XAPIAN_MAJOR_VERSION>1
+#if XAPIAN_NUM_VERSION > 1000002
 #define ENABLE_XAPIAN_SPELLING_CORRECTION 1
-#elif XAPIAN_MAJOR_VERSION==1
-#if XAPIAN_MINOR_VERSION>0
-#define ENABLE_XAPIAN_SPELLING_CORRECTION 1
 #else
-#if XAPIAN_REVISION>2
-#define ENABLE_XAPIAN_SPELLING_CORRECTION 1
+#define ENABLE_XAPIAN_SPELLING_CORRECTION 0
 #endif
 #endif
-#endif
 
 /// Wraps Xapian's search funtionality.
 class XapianEngine : public SearchEngineInterface

Modified: trunk/UI/GTK2/src/pinot-dbus-daemon.cc
===================================================================
--- trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2007-09-27 12:36:15 UTC (rev 997)
+++ trunk/UI/GTK2/src/pinot-dbus-daemon.cc	2007-09-29 06:00:41 UTC (rev 998)
@@ -251,7 +251,7 @@
 	}
 	// Initialize the GType and the D-Bus thread system
 	g_type_init();
-#if DBUS_VERSION > 1000000
+#if DBUS_NUM_VERSION > 1000000
 	dbus_threads_init_default();
 #endif
 	dbus_g_thread_init();

Modified: trunk/UI/GTK2/src/pinot.cc
===================================================================
--- trunk/UI/GTK2/src/pinot.cc	2007-09-27 12:36:15 UTC (rev 997)
+++ trunk/UI/GTK2/src/pinot.cc	2007-09-29 06:00:41 UTC (rev 998)
@@ -32,7 +32,7 @@
 #include "config.h"
 extern "C"
 {
-#if DBUS_VERSION < 1000000
+#if DBUS_NUM_VERSION < 1000000
 #define DBUS_API_SUBJECT_TO_CHANGE
 #endif
 #include <dbus/dbus.h>
@@ -172,7 +172,7 @@
 	}
 	// Initialize the GType and the D-Bus thread system
 	g_type_init();
-#if DBUS_VERSION > 1000000
+#if DBUS_NUM_VERSION > 1000000
 	dbus_threads_init_default();
 #endif
 	dbus_g_thread_init();

Modified: trunk/configure.in
===================================================================
--- trunk/configure.in	2007-09-27 12:36:15 UTC (rev 997)
+++ trunk/configure.in	2007-09-29 06:00:41 UTC (rev 998)
@@ -159,6 +159,9 @@
 fi
 XAPIAN_CFLAGS=`$XAPIAN_CONFIG --cxxflags`
 XAPIAN_LIBS=`$XAPIAN_CONFIG --libs`
+XAPIAN_NUM_VERSION=`xapian-config --version | $SED -e "s/xapian-config - xapian-core //g" | $AWK 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
+AC_DEFINE_UNQUOTED(XAPIAN_NUM_VERSION,$XAPIAN_NUM_VERSION,
+    [Xapian version number])
 
 dnl inotify
 linuxinotify="no"
@@ -254,9 +257,9 @@
 PKG_CHECK_MODULES(DBUS, dbus-glib-1)
 AC_SUBST(DBUS_CFLAGS)
 AC_SUBST(DBUS_LIBS)
-DBUS_VERSION=`pkg-config --modversion dbus-1 | $AWK 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
-AC_DEFINE_UNQUOTED(DBUS_VERSION,$DBUS_VERSION,
-    [DBus version])
+DBUS_NUM_VERSION=`pkg-config --modversion dbus-1 | $AWK 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
+AC_DEFINE_UNQUOTED(DBUS_NUM_VERSION,$DBUS_NUM_VERSION,
+    [DBus version number])
 PKG_CHECK_MODULES(SIGCPP, sigc++-2.0 >= 2.0 )
 AC_SUBST(SIGCPP_CFLAGS)
 AC_SUBST(SIGCPP_LIBS)



From fabricecolin at mail.berlios.de  Sun Sep 30 11:54:31 2007
From: fabricecolin at mail.berlios.de (fabricecolin at BerliOS)
Date: Sun, 30 Sep 2007 11:54:31 +0200
Subject: [Pinot-svn] r999 - trunk/Index
Message-ID: <200709300954.l8U9sVcM001186@sheep.berlios.de>

Author: fabricecolin
Date: 2007-09-30 11:54:25 +0200 (Sun, 30 Sep 2007)
New Revision: 999

Modified:
   trunk/Index/DBusXapianIndex.cpp
   trunk/Index/DBusXapianIndex.h
   trunk/Index/IndexInterface.h
   trunk/Index/XapianDatabaseFactory.cpp
   trunk/Index/XapianIndex.cpp
   trunk/Index/XapianIndex.h
Log:
If database metadata is available (Xapian >= 1.0.3), use it to store version and
labels. New method reset() gets XapianDatabaseFactory::getDatabase() to
overwrite and re-open the database.
DBusXapianIndex makes use of the D-Bus method SetLabels.


Modified: trunk/Index/DBusXapianIndex.cpp
===================================================================
--- trunk/Index/DBusXapianIndex.cpp	2007-09-29 06:00:41 UTC (rev 998)
+++ trunk/Index/DBusXapianIndex.cpp	2007-09-30 09:54:25 UTC (rev 999)
@@ -352,6 +352,74 @@
 	return XapianIndex::getDocumentInfo(docId, docInfo);
 }
 
+/// Sets the list of known labels.
+bool DBusXapianIndex::setLabels(const set<string> &labels)
+{
+	gboolean updatedLabels = FALSE;
+
+	DBusGConnection *pBus = getBusConnection();
+	if (pBus == NULL)
+	{
+		return false;
+	}
+
+	DBusGProxy *pBusProxy = getBusProxy(pBus);
+	if (pBusProxy == NULL)
+	{
+		cerr << "DBusXapianIndex::setLabels: couldn't get bus proxy" << endl;
+		return false;
+	}
+
+	GError *pError = NULL;
+	dbus_uint32_t labelsCount = labels.size();
+	char **pLabels;
+	unsigned int labelIndex = 0;
+
+	pLabels = g_new(char *, labelsCount + 1);
+	for (set<string>::const_iterator labelIter = labels.begin();
+		labelIter != labels.end(); ++labelIter)
+	{
+		pLabels[labelIndex] = g_strdup(labelIter->c_str());
+		++labelIndex;
+	}
+	pLabels[labelIndex] = NULL;
+
+	// G_TYPE_STRV is the GLib equivalent of DBUS_TYPE_ARRAY, DBUS_TYPE_STRING
+	if (dbus_g_proxy_call(pBusProxy, "SetLabels", &pError,
+		G_TYPE_STRV, pLabels,
+		G_TYPE_INVALID,
+		G_TYPE_BOOLEAN, &updatedLabels,
+		G_TYPE_INVALID) == FALSE)
+	{
+		if (pError != NULL)
+		{
+			cerr << "DBusXapianIndex::setDocumentLabels: " << pError->message << endl;
+			g_error_free(pError);
+		}
+	}
+
+	// Free the array
+	g_strfreev(pLabels);
+
+	g_object_unref(pBusProxy);
+	// FIXME: don't we have to call dbus_g_connection_unref(pBus); ?
+
+	if (updatedLabels == TRUE)
+	{
+		return true;
+	}
+
+	return false;
+}
+
+/// Gets the list of known labels.
+bool DBusXapianIndex::getLabels(set<string> &labels) const
+{
+	reopen();
+
+	return XapianIndex::getLabels(labels);
+}
+
 /// Determines whether a document has a label.
 bool DBusXapianIndex::hasLabel(unsigned int docId, const string &name) const
 {
@@ -368,6 +436,149 @@
 	return XapianIndex::getDocumentLabels(docId, labels);
 }
 
+/// Sets a document's labels.
+bool DBusXapianIndex::setDocumentLabels(unsigned int docId, const set<string> &labels,
+	bool resetLabels)
+{
+	bool updatedLabels = false;
+
+	DBusGConnection *pBus = getBusConnection();
+	if (pBus == NULL)
+	{
+		return false;
+	}
+
+	DBusGProxy *pBusProxy = getBusProxy(pBus);
+	if (pBusProxy == NULL)
+	{
+		cerr << "DBusXapianIndex::setDocumentLabels: couldn't get bus proxy" << endl;
+		return false;
+	}
+
+	GError *pError = NULL;
+	dbus_uint32_t labelsCount = labels.size();
+	char **pLabels;
+	unsigned int labelIndex = 0;
+
+	pLabels = g_new(char *, labelsCount + 1);
+	for (set<string>::const_iterator labelIter = labels.begin();
+		labelIter != labels.end(); ++labelIter)
+	{
+		pLabels[labelIndex] = g_strdup(labelIter->c_str());
+		++labelIndex;
+	}
+	pLabels[labelIndex] = NULL;
+
+	// G_TYPE_STRV is the GLib equivalent of DBUS_TYPE_ARRAY, DBUS_TYPE_STRING
+	if (dbus_g_proxy_call(pBusProxy, "SetDocumentLabels", &pError,
+		G_TYPE_UINT, docId,
+		G_TYPE_STRV, pLabels,
+		G_TYPE_BOOLEAN, (resetLabels == true ? TRUE : FALSE),
+		G_TYPE_INVALID,
+		G_TYPE_UINT, &docId,
+		G_TYPE_INVALID) == TRUE)
+	{
+		updatedLabels = true;
+	}
+	else
+	{
+		if (pError != NULL)
+		{
+			cerr << "DBusXapianIndex::setDocumentLabels: " << pError->message << endl;
+			g_error_free(pError);
+		}
+	}
+
+	// Free the array
+	g_strfreev(pLabels);
+
+	g_object_unref(pBusProxy);
+	// FIXME: don't we have to call dbus_g_connection_unref(pBus); ?
+
+	return updatedLabels;
+}
+
+/// Sets documents' labels.
+bool DBusXapianIndex::setDocumentsLabels(const set<unsigned int> &docIds,
+	const set<string> &labels, bool resetLabels)
+{
+	gboolean updatedLabels = FALSE;
+
+	DBusGConnection *pBus = getBusConnection();
+	if (pBus == NULL)
+	{
+		return false;
+	}
+
+	DBusGProxy *pBusProxy = getBusProxy(pBus);
+	if (pBusProxy == NULL)
+	{
+		cerr << "DBusXapianIndex::setDocumentsLabels: couldn't get bus proxy" << endl;
+		return false;
+	}
+
+	GError *pError = NULL;
+	dbus_uint32_t idsCount = docIds.size();
+	dbus_uint32_t labelsCount = labels.size();
+	char **pDocIds;
+	char **pLabels;
+	unsigned int idIndex = 0, labelIndex = 0;
+
+	pDocIds = g_new(char *, idsCount + 1);
+	pLabels = g_new(char *, labelsCount + 1);
+	for (set<unsigned int>::const_iterator idIter = docIds.begin();
+		idIter != docIds.end(); ++idIter)
+	{
+		pDocIds[idIndex] = g_strdup_printf("%u", *idIter); 
+#ifdef DEBUG
+		cout << "DBusXapianIndex::setDocumentsLabels: document " << pDocIds[idIndex] << endl;
+#endif
+		++idIndex;
+	}
+	pDocIds[idIndex] = NULL;
+	for (set<string>::const_iterator labelIter = labels.begin();
+		labelIter != labels.end(); ++labelIter)
+	{
+		pLabels[labelIndex] = g_strdup(labelIter->c_str());
+#ifdef DEBUG
+		cout << "DBusXapianIndex::setDocumentsLabels: label " << pLabels[labelIndex] << endl;
+#endif
+		++labelIndex;
+	}
+	pLabels[labelIndex] = NULL;
+
+	// G_TYPE_STRV is the GLib equivalent of DBUS_TYPE_ARRAY, DBUS_TYPE_STRING
+	if (dbus_g_proxy_call(pBusProxy, "SetDocumentsLabels", &pError,
+		G_TYPE_STRV, pDocIds,
+		G_TYPE_STRV, pLabels,
+		G_TYPE_BOOLEAN, (resetLabels == true ? TRUE : FALSE),
+		G_TYPE_INVALID,
+		G_TYPE_BOOLEAN, &updatedLabels,
+		G_TYPE_INVALID) == FALSE)
+	{
+		if (pError != NULL)
+		{
+			cerr << "DBusXapianIndex::setDocumentsLabels: " << pError->message << endl;
+			g_error_free(pError);
+		}
+		updatedLabels = false;
+	}
+
+	// Free the arrays
+	g_strfreev(pDocIds);
+	g_strfreev(pLabels);
+
+	g_object_unref(pBusProxy);
+	// FIXME: don't we have to call dbus_g_connection_unref(pBus); ?
+
+	if (updatedLabels == TRUE)
+	{
+		return true;
+	}
+
+	return false;
+}
+
 /// Checks whether the given URL is in the index.
 unsigned int DBusXapianIndex::hasDocument(const string &url) const
 {
@@ -526,144 +737,6 @@
 	return updated;
 }
 
-/// Sets a document's labels.
-bool DBusXapianIndex::setDocumentLabels(unsigned int docId, const set<string> &labels,
-	bool resetLabels)
-{
-	bool updatedLabels = false;
-
-	DBusGConnection *pBus = getBusConnection();
-	if (pBus == NULL)
-	{
-		return false;
-	}
-
-	DBusGProxy *pBusProxy = getBusProxy(pBus);
-	if (pBusProxy == NULL)
-	{
-		cerr << "DBusXapianIndex::setDocumentLabels: couldn't get bus proxy" << endl;
-		return false;
-	}
-
-	GError *pError = NULL;
-	dbus_uint32_t labelsCount = labels.size();
-	char **pLabels;
-	unsigned int labelIndex = 0;
-
-	pLabels = g_new(char *, labelsCount + 1);
-	for (set<string>::const_iterator labelIter = labels.begin();
-		labelIter != labels.end(); ++labelIter)
-	{
-		pLabels[labelIndex] = g_strdup(labelIter->c_str());
-		++labelIndex;
-	}
-	pLabels[labelIndex] = NULL;
-
-	// G_TYPE_STRV is the GLib equivalent of DBUS_TYPE_ARRAY, DBUS_TYPE_STRING
-	if (dbus_g_proxy_call(pBusProxy, "SetDocumentLabels", &pError,
-		G_TYPE_UINT, docId,
-		G_TYPE_STRV, pLabels,
-		G_TYPE_BOOLEAN, resetLabels,
-		G_TYPE_INVALID,
-		G_TYPE_UINT, &docId,
-		G_TYPE_INVALID) == TRUE)
-	{
-		updatedLabels = true;
-	}
-	else
-	{
-		if (pError != NULL)
-		{
-			cerr << "DBusXapianIndex::setDocumentLabels: " << pError->message << endl;
-			g_error_free(pError);
-		}
-	}
-
-	// Free the array
-	g_strfreev(pLabels);
-
-	g_object_unref(pBusProxy);
-	// FIXME: don't we have to call dbus_g_connection_unref(pBus); ?
-
-	return updatedLabels;
-}
-
-/// Sets documents' labels.
-bool DBusXapianIndex::setDocumentsLabels(const set<unsigned int> &docIds,
-	const set<string> &labels, bool resetLabels)
-{
-	bool updatedLabels = false;
-
-	DBusGConnection *pBus = getBusConnection();
-	if (pBus == NULL)
-	{
-		return false;
-	}
-
-	DBusGProxy *pBusProxy = getBusProxy(pBus);
-	if (pBusProxy == NULL)
-	{
-		cerr << "DBusXapianIndex::setDocumentsLabels: couldn't get bus proxy" << endl;
-		return false;
-	}
-
-	GError *pError = NULL;
-	dbus_uint32_t idsCount = docIds.size();
-	dbus_uint32_t labelsCount = labels.size();
-	char **pDocIds;
-	char **pLabels;
-	unsigned int idIndex = 0, labelIndex = 0;
-
-	pDocIds = g_new(char *, idsCount + 1);
-	pLabels = g_new(char *, labelsCount + 1);
-	for (set<unsigned int>::const_iterator idIter = docIds.begin();
-		idIter != docIds.end(); ++idIter)
-	{
-		pDocIds[idIndex] = g_strdup_printf("%u", *idIter); 
-#ifdef DEBUG
-		cout << "DBusXapianIndex::setDocumentsLabels: document " << pDocIds[idIndex] << endl;
-#endif
-		++idIndex;
-	}
-	pDocIds[idIndex] = NULL;
-	for (set<string>::const_iterator labelIter = labels.begin();
-		labelIter != labels.end(); ++labelIter)
-	{
-		pLabels[labelIndex] = g_strdup(labelIter->c_str());
-#ifdef DEBUG
-		cout << "DBusXapianIndex::setDocumentsLabels: label " << pLabels[labelIndex] << endl;
-#endif
-		++labelIndex;
-	}
-	pLabels[labelIndex] = NULL;
-
-	// G_TYPE_STRV is the GLib equivalent of DBUS_TYPE_ARRAY, DBUS_TYPE_STRING
-	if (dbus_g_proxy_call(pBusProxy, "SetDocumentsLabels", &pError,
-		G_TYPE_STRV, pDocIds,
-		G_TYPE_STRV, pLabels,
-		G_TYPE_BOOLEAN, resetLabels,
-		G_TYPE_INVALID,
-		G_TYPE_BOOLEAN, &updatedLabels,
-		G_TYPE_INVALID) == FALSE)
-	{
-		if (pError != NULL)
-		{
-			cerr << "DBusXapianIndex::setDocumentsLabels: " << pError->message << endl;
-			g_error_free(pError);
-		}
-		updatedLabels = false;
-	}
-
-	// Free the arrays
-	g_strfreev(pDocIds);
-	g_strfreev(pLabels);
-
-	g_object_unref(pBusProxy);
-	// FIXME: don't we have to call dbus_g_connection_unref(pBus); ?
-
-	return updatedLabels;
-}
-
 /// Unindexes the given document; true if success.
 bool DBusXapianIndex::unindexDocument(unsigned int docId)
 {
@@ -778,6 +851,14 @@
 /// Flushes recent changes to the disk.
 bool DBusXapianIndex::flush(void)
 {
-	// There is no method for this because the daemon knows best when to flush
+	// The daemon knows best when to flush
 	return true;
 }
+
+/// Resets the index.
+bool DBusXapianIndex::reset(void)
+{
+	// This can't be done here
+	return false;
+}
+

Modified: trunk/Index/DBusXapianIndex.h
===================================================================
--- trunk/Index/DBusXapianIndex.h	2007-09-29 06:00:41 UTC (rev 998)
+++ trunk/Index/DBusXapianIndex.h	2007-09-30 09:54:25 UTC (rev 999)
@@ -61,12 +61,26 @@
 		/// Returns a document's properties.
 		virtual bool getDocumentInfo(unsigned int docId, DocumentInfo &docInfo) const;
 
+		/// Sets the list of known labels.
+		virtual bool setLabels(const std::set<std::string> &labels);
+
+		/// Gets the list of known labels.
+		virtual bool getLabels(std::set<std::string> &labels) const;
+
 		/// Determines whether a document has a label.
 		virtual bool hasLabel(unsigned int docId, const std::string &name) const;
 
 		/// Returns a document's labels.
 		virtual bool getDocumentLabels(unsigned int docId, std::set<std::string> &labels) const;
 
+		/// Sets a document's labels.
+		virtual bool setDocumentLabels(unsigned int docId, const std::set<std::string> &labels,
+			bool resetLabels = true);
+
+		/// Sets documents' labels.
+		virtual bool setDocumentsLabels(const std::set<unsigned int> &docIds,
+			const std::set<std::string> &labels, bool resetLabels = true);
+
 		/// Checks whether the given URL is in the index.
 		virtual unsigned int hasDocument(const std::string &url) const;
 
@@ -97,14 +111,6 @@
 		/// Updates a document's properties.
 		virtual bool updateDocumentInfo(unsigned int docId, const DocumentInfo &docInfo);
 
-		/// Sets a document's labels.
-		virtual bool setDocumentLabels(unsigned int docId, const std::set<std::string> &labels,
-			bool resetLabels = true);
-
-		/// Sets documents' labels.
-		virtual bool setDocumentsLabels(const std::set<unsigned int> &docIds,
-			const std::set<std::string> &labels, bool resetLabels = true);
-
 		/// Unindexes the given document.
 		virtual bool unindexDocument(unsigned int docId);
 
@@ -123,6 +129,9 @@
 		/// Flushes recent changes to the disk.
 		virtual bool flush(void);
 
+		/// Resets the index.
+		virtual bool reset(void);
+
 	protected:
 		void reopen(void) const;
 

Modified: trunk/Index/IndexInterface.h
===================================================================
--- trunk/Index/IndexInterface.h	2007-09-29 06:00:41 UTC (rev 998)
+++ trunk/Index/IndexInterface.h	2007-09-30 09:54:25 UTC (rev 999)
@@ -51,12 +51,26 @@
 		/// Returns a document's terms count.
 		virtual unsigned int getDocumentTermsCount(unsigned int docId) const = 0;
 
+		/// Sets the list of known labels.
+		virtual bool setLabels(const std::set<std::string> &labels) = 0;
+
+		/// Gets the list of known labels.
+		virtual bool getLabels(std::set<std::string> &labels) const = 0;
+
 		/// Determines whether a document has a label.
 		virtual bool hasLabel(unsigned int docId, const std::string &name) const = 0;
 
 		/// Returns a document's labels.
 		virtual bool getDocumentLabels(unsigned int docId, std::set<std::string> &labels) const = 0;
 
+		/// Sets a document's labels.
+		virtual bool setDocumentLabels(unsigned int docId, const std::set<std::string> &labels,
+			bool resetLabels = true) = 0;
+
+		/// Sets documents' labels.
+		virtual bool setDocumentsLabels(const std::set<unsigned int> &docIds,
+			const std::set<std::string> &labels, bool resetLabels = true) = 0;
+
 		/// Checks whether the given URL is in the index.
 		virtual unsigned int hasDocument(const std::string &url) const = 0;
 
@@ -87,14 +101,6 @@
 		/// Updates a document's properties.
 		virtual bool updateDocumentInfo(unsigned int docId, const DocumentInfo &docInfo) = 0;
 
-		/// Sets a document's labels.
-		virtual bool setDocumentLabels(unsigned int docId, const std::set<std::string> &labels,
-			bool resetLabels = true) = 0;
-
-		/// Sets documents' labels.
-		virtual bool setDocumentsLabels(const std::set<unsigned int> &docIds,
-			const std::set<std::string> &labels, bool resetLabels = true) = 0;
-
 		/// Unindexes the given document.
 		virtual bool unindexDocument(unsigned int docId) = 0;
 
@@ -116,6 +122,9 @@
 		/// Flushes recent changes to the disk.
 		virtual bool flush(void) = 0;
 
+		/// Resets the index.
+		virtual bool reset(void) = 0;
+
 	protected:
 		IndexInterface() { };
 

Modified: trunk/Index/XapianDatabaseFactory.cpp
===================================================================
--- trunk/Index/XapianDatabaseFactory.cpp	2007-09-29 06:00:41 UTC (rev 998)
+++ trunk/Index/XapianDatabaseFactory.cpp	2007-09-30 09:54:25 UTC (rev 999)
@@ -81,12 +81,28 @@
 		return NULL;
 	}
 
+	// Is the database already open ?
 	map<string, XapianDatabase *>::iterator dbIter = m_databases.find(location);
 	if (dbIter != m_databases.end())
 	{
 		pDb = dbIter->second;
+
+		// Overwrite the database ?
+		if (overwrite == true)
+		{
+			dbIter->second = NULL;
+#ifdef DEBUG
+			cout << "XapianDatabaseFactory::getDatabase: closing " << dbIter->first << endl;
+#endif
+			m_databases.erase(dbIter);
+			delete pDb;
+
+			dbIter = m_databases.end();
+		}
 	}
-	else
+
+	// Open the database ?
+	if (dbIter == m_databases.end())
 	{
 		// Create a new instance
 		pDb = new XapianDatabase(location, readOnly, overwrite);

Modified: trunk/Index/XapianIndex.cpp
===================================================================
--- trunk/Index/XapianIndex.cpp	2007-09-29 06:00:41 UTC (rev 998)
+++ trunk/Index/XapianIndex.cpp	2007-09-30 09:54:25 UTC (rev 999)
@@ -682,9 +682,36 @@
 /// Gets the version number.
 string XapianIndex::getVersion(void) const
 {
+	string version;
+
+#if ENABLE_XAPIAN_DB_METADATA>0
+	XapianDatabase *pDatabase = XapianDatabaseFactory::getDatabase(m_databaseName);
+	if (pDatabase == NULL)
+	{
+		cerr << "Bad index " << m_databaseName << endl;
+		return false;
+	}
+
+	try
+	{
+		Xapian::Database *pIndex = pDatabase->readLock();
+		if (pIndex != NULL)
+		{
+			version = pIndex->get_metadata("version");
+		}
+	}
+	catch (const Xapian::Error &error)
+	{
+		cerr << "Couldn't get database version: " << error.get_type() << ": " << error.get_msg() << endl;
+	}
+	catch (...)
+	{
+		cerr << "Couldn't get database version, unknown exception occured" << endl;
+	}
+	pDatabase->unlock();
+#else
 	ifstream verFile;
 	string verFileName(m_databaseName + "/version");
-	string version;
 
 	verFile.open(verFileName.c_str());
 	if (verFile.good() == true)
@@ -692,6 +719,7 @@
 		verFile >> version;
 	}
 	verFile.close();
+#endif
 
 	return version;
 }
@@ -699,10 +727,38 @@
 /// Sets the version number.
 bool XapianIndex::setVersion(const string &version) const
 {
+	bool setVer = false;
+
+#if ENABLE_XAPIAN_DB_METADATA>0
+	XapianDatabase *pDatabase = XapianDatabaseFactory::getDatabase(m_databaseName);
+	if (pDatabase == NULL)
+	{
+		cerr << "Bad index " << m_databaseName << endl;
+		return false;
+	}
+
+	try
+	{
+		Xapian::WritableDatabase *pIndex = pDatabase->writeLock();
+		if (pIndex != NULL)
+		{
+			pIndex->set_metadata("version", version);
+			setVer = true;
+		}
+	}
+	catch (const Xapian::Error &error)
+	{
+		cerr << "Couldn't set database version: " << error.get_type() << ": " << error.get_msg() << endl;
+	}
+	catch (...)
+	{
+		cerr << "Couldn't set database version, unknown exception occured" << endl;
+	}
+	pDatabase->unlock();
+#else
 	ofstream verFile, cacheDirFile;
 	string verFileName(m_databaseName + "/version");
 	string cacheDirFileName(m_databaseName + "/CACHEDIR.TAG");
-	bool setVer = false;
 
 	verFile.open(verFileName.c_str(), ios::trunc);
 	if (verFile.good() == true)
@@ -723,6 +779,7 @@
 		cacheDirFile << "# http://www.brynosaurus.com/cachedir/" << endl;
 	}
 	cacheDirFile.close();
+#endif
 
 	return setVer;
 }
@@ -840,6 +897,109 @@
 	return termsCount;
 }
 
+/// Sets the list of known labels.
+bool XapianIndex::setLabels(const set<string> &labels)
+{
+	bool setLabels = false;
+
+#if ENABLE_XAPIAN_DB_METADATA>0
+	string labelString;
+
+	XapianDatabase *pDatabase = XapianDatabaseFactory::getDatabase(m_databaseName);
+	if (pDatabase == NULL)
+	{
+		cerr << "Bad index " << m_databaseName << endl;
+		return false;
+	}
+
+	for (set<string>::const_iterator labelIter = labels.begin();
+		labelIter != labels.end(); ++labelIter)
+	{
+		labelString += "[";
+		labelString += Url::escapeUrl(*labelIter);
+		labelString += "]";
+	}
+
+	try
+	{
+#ifdef DEBUG
+		cout << "XapianIndex::setLabels: " << labels.size() << " labels" << endl;
+#endif
+		Xapian::WritableDatabase *pIndex = pDatabase->writeLock();
+		if (pIndex != NULL)
+		{
+			pIndex->set_metadata("labels", labelString);
+			setLabels = true;
+		}
+	}
+	catch (const Xapian::Error &error)
+	{
+		cerr << "Couldn't set database labels: " << error.get_type() << ": " << error.get_msg() << endl;
+	}
+	catch (...)
+	{
+		cerr << "Couldn't set database labels, unknown exception occured" << endl;
+	}
+	pDatabase->unlock();
+#endif
+
+	return setLabels;
+}
+
+/// Gets the list of known labels.
+bool XapianIndex::getLabels(set<string> &labels) const
+{
+#if ENABLE_XAPIAN_DB_METADATA>0
+	string labelsString;
+
+	XapianDatabase *pDatabase = XapianDatabaseFactory::getDatabase(m_databaseName);
+	if (pDatabase == NULL)
+	{
+		cerr << "Bad index " << m_databaseName << endl;
+		return false;
+	}
+
+	try
+	{
+		Xapian::Database *pIndex = pDatabase->readLock();
+		if (pIndex != NULL)
+		{
+			labelsString = pIndex->get_metadata("labels");
+		}
+	}
+	catch (const Xapian::Error &error)
+	{
+		cerr << "Couldn't get database labels: " << error.get_type() << ": " << error.get_msg() << endl;
+	}
+	catch (...)
+	{
+		cerr << "Couldn't get database labels, unknown exception occured" << endl;
+	}
+	pDatabase->unlock();
+
+	if (labelsString.empty() == false)
+	{
+		string::size_type endPos = 0;
+		string label(StringManip::extractField(labelsString, "[", "]", endPos));
+
+		while (label.empty() == false)
+		{
+			labels.insert(Url::unescapeUrl(label));
+
+			if (endPos == string::npos)
+			{
+				break;
+			}
+			label = StringManip::extractField(labelsString, "[", "]", endPos);
+		}
+
+		return true;
+	}
+#endif
+
+	return false;
+}
+
 /// Determines whether a document has a label.
 bool XapianIndex::hasLabel(unsigned int docId, const string &name) const
 {
@@ -940,6 +1100,89 @@
 	return gotLabels;
 }
 
+/// Sets a document's labels.
+bool XapianIndex::setDocumentLabels(unsigned int docId, const set<string> &labels,
+	bool resetLabels)
+{
+	set<unsigned int> docIds;
+
+	docIds.insert(docId);
+	return setDocumentsLabels(docIds, labels, resetLabels);
+}
+
+/// Sets documents' labels.
+bool XapianIndex::setDocumentsLabels(const set<unsigned int> &docIds,
+	const set<string> &labels, bool resetLabels)
+{
+	bool updatedLabels = false;
+
+	XapianDatabase *pDatabase = XapianDatabaseFactory::getDatabase(m_databaseName, false);
+	if (pDatabase == NULL)
+	{
+		cerr << "Bad index " << m_databaseName << endl;
+		return false;
+	}
+
+	for (set<unsigned int>::const_iterator docIter = docIds.begin();
+		docIter != docIds.end(); ++docIter)
+	{
+		try
+		{
+			Xapian::WritableDatabase *pIndex = pDatabase->writeLock();
+			if (pIndex == NULL)
+			{
+				break;
+			}
+
+			unsigned int docId = (*docIter);
+			Xapian::Document doc = pIndex->get_document(docId);
+
+			// Reset existing labels ?
+			if (resetLabels == true)
+			{
+				Xapian::TermIterator termIter = pIndex->termlist_begin(docId);
+				if (termIter != pIndex->termlist_end(docId))
+				{
+					for (termIter.skip_to("XLABEL:");
+						termIter != pIndex->termlist_end(docId); ++termIter)
+					{
+						// Is this a label ?
+						if (strncasecmp((*termIter).c_str(), "XLABEL:", min(7, (int)(*termIter).length())) == 0)
+						{
+							doc.remove_term(*termIter);
+						}
+					}
+				}
+			}
+
+			// Set new labels
+			for (set<string>::const_iterator labelIter = labels.begin(); labelIter != labels.end();
+				++labelIter)
+			{
+				if (labelIter->empty() == false)
+				{
+					doc.add_term(string("XLABEL:") + XapianDatabase::limitTermLength(Url::escapeUrl(*labelIter)));
+				}
+			}
+
+			pIndex->replace_document(docId, doc);
+			updatedLabels = true;
+		}
+		catch (const Xapian::Error &error)
+		{
+			cerr << "Couldn't update document's labels: " << error.get_type() << ": " << error.get_msg() << endl;
+		}
+		catch (...)
+		{
+			cerr << "Couldn't update document's labels, unknown exception occured" << endl;
+		}
+
+		pDatabase->unlock();
+	}
+
+	return updatedLabels;
+}
+
 /// Checks whether the given URL is in the index.
 unsigned int XapianIndex::hasDocument(const string &url) const
 {
@@ -1361,89 +1604,6 @@
 	return updated;
 }
 
-/// Sets a document's labels.
-bool XapianIndex::setDocumentLabels(unsigned int docId, const set<string> &labels,
-	bool resetLabels)
-{
-	set<unsigned int> docIds;
-
-	docIds.insert(docId);
-	return setDocumentsLabels(docIds, labels, resetLabels);
-}
-
-/// Sets documents' labels.
-bool XapianIndex::setDocumentsLabels(const set<unsigned int> &docIds,
-	const set<string> &labels, bool resetLabels)
-{
-	bool updatedLabels = false;
-
-	XapianDatabase *pDatabase = XapianDatabaseFactory::getDatabase(m_databaseName, false);
-	if (pDatabase == NULL)
-	{
-		cerr << "Bad index " << m_databaseName << endl;
-		return false;
-	}
-
-	for (set<unsigned int>::const_iterator docIter = docIds.begin();
-		docIter != docIds.end(); ++docIter)
-	{
-		try
-		{
-			Xapian::WritableDatabase *pIndex = pDatabase->writeLock();
-			if (pIndex == NULL)
-			{
-				break;
-			}
-
-			unsigned int docId = (*docIter);
-			Xapian::Document doc = pIndex->get_document(docId);
-
-			// Reset existing labels ?
-			if (resetLabels == true)
-			{
-				Xapian::TermIterator termIter = pIndex->termlist_begin(docId);
-				if (termIter != pIndex->termlist_end(docId))
-				{
-					for (termIter.skip_to("XLABEL:");
-						termIter != pIndex->termlist_end(docId); ++termIter)
-					{
-						// Is this a label ?
-						if (strncasecmp((*termIter).c_str(), "XLABEL:", min(7, (int)(*termIter).length())) == 0)
-						{
-							doc.remove_term(*termIter);
-						}
-					}
-				}
-			}
-
-			// Set new labels
-			for (set<string>::const_iterator labelIter = labels.begin(); labelIter != labels.end();
-				++labelIter)
-			{
-				if (labelIter->empty() == false)
-				{
-					doc.add_term(string("XLABEL:") + XapianDatabase::limitTermLength(Url::escapeUrl(*labelIter)));
-				}
-			}
-
-			pIndex->replace_document(docId, doc);
-			updatedLabels = true;
-		}
-		catch (const Xapian::Error &error)
-		{
-			cerr << "Couldn't update document's labels: " << error.get_type() << ": " << error.get_msg() << endl;
-		}
-		catch (...)
-		{
-			cerr << "Couldn't update document's labels, unknown exception occured" << endl;
-		}
-
-		pDatabase->unlock();
-	}
-
-	return updatedLabels;
-}
-
 /// Unindexes the given document; true if success.
 bool XapianIndex::unindexDocument(unsigned int docId)
 {
@@ -1655,3 +1815,17 @@
 	return flushed;
 }
 
+/// Resets the index.
+bool XapianIndex::reset(void)
+{
+	// Overwrite and reopen
+	XapianDatabase *pDatabase = XapianDatabaseFactory::getDatabase(m_databaseName, false, true);
+	if (pDatabase == NULL)
+	{
+		cerr << "Bad index " << m_databaseName << endl;
+		return false;
+	}
+
+	return true;
+}
+

Modified: trunk/Index/XapianIndex.h
===================================================================
--- trunk/Index/XapianIndex.h	2007-09-29 06:00:41 UTC (rev 998)
+++ trunk/Index/XapianIndex.h	2007-09-30 09:54:25 UTC (rev 999)
@@ -25,6 +25,15 @@
 #include "XapianDatabase.h"
 #include "IndexInterface.h"
 
+#if !ENABLE_XAPIAN_DB_METADATA
+// Database metadata is only available in Xapian > 1.0.2
+#if XAPIAN_NUM_VERSION > 1000002
+#define ENABLE_XAPIAN_DB_METADATA 1
+#else
+#define ENABLE_XAPIAN_DB_METADATA 0
+#endif
+#endif
+
 /// A Xapian-based index.
 class XapianIndex : public IndexInterface
 {
@@ -53,12 +62,26 @@
 		/// Returns a document's terms count.
 		virtual unsigned int getDocumentTermsCount(unsigned int docId) const;
 
+		/// Sets the list of known labels.
+		virtual bool setLabels(const std::set<std::string> &labels);
+
+		/// Gets the list of known labels.
+		virtual bool getLabels(std::set<std::string> &labels) const;
+
 		/// Determines whether a document has a label.
 		virtual bool hasLabel(unsigned int docId, const std::string &name) const;
 
 		/// Returns a document's labels.
 		virtual bool getDocumentLabels(unsigned int docId, std::set<std::string> &labels) const;
 
+		/// Sets a document's labels.
+		virtual bool setDocumentLabels(unsigned int docId, const std::set<std::string> &labels,
+			bool resetLabels = true);
+
+		/// Sets documents' labels.
+		virtual bool setDocumentsLabels(const std::set<unsigned int> &docIds,
+			const std::set<std::string> &labels, bool resetLabels = true);
+
 		/// Checks whether the given URL is in the index.
 		virtual unsigned int hasDocument(const std::string &url) const;
 
@@ -89,14 +112,6 @@
 		/// Updates a document's properties.
 		virtual bool updateDocumentInfo(unsigned int docId, const DocumentInfo &docInfo);
 
-		/// Sets a document's labels.
-		virtual bool setDocumentLabels(unsigned int docId, const std::set<std::string> &labels,
-			bool resetLabels = true);
-
-		/// Sets documents' labels.
-		virtual bool setDocumentsLabels(const std::set<unsigned int> &docIds,
-			const std::set<std::string> &labels, bool resetLabels = true);
-
 		/// Unindexes the given document.
 		virtual bool unindexDocument(unsigned int docId);
 
@@ -118,6 +133,9 @@
 		/// Flushes recent changes to the disk.
 		virtual bool flush(void);
 
+		/// Resets the index.
+		virtual bool reset(void);
+
 	protected:
 		static const std::string MAGIC_TERM;
 		std::string m_databaseName;



