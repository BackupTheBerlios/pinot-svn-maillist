<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Pinot-svn] r53 - in trunk: Index Tokenize UI/GTK2 UI/GTK2/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/pinot-svn/2006-January/index.html" >
   <LINK REL="made" HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r53%20-%20in%20trunk%3A%20Index%20Tokenize%20UI/GTK2%20UI/GTK2/src&In-Reply-To=%3C200601100946.k0A9kUh2024771%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000051.html">
   <LINK REL="Next"  HREF="000053.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Pinot-svn] r53 - in trunk: Index Tokenize UI/GTK2 UI/GTK2/src</H1>
    <B>fabricecolin at BerliOS</B> 
    <A HREF="mailto:pinot-svn%40lists.berlios.de?Subject=Re%3A%20%5BPinot-svn%5D%20r53%20-%20in%20trunk%3A%20Index%20Tokenize%20UI/GTK2%20UI/GTK2/src&In-Reply-To=%3C200601100946.k0A9kUh2024771%40sheep.berlios.de%3E"
       TITLE="[Pinot-svn] r53 - in trunk: Index Tokenize UI/GTK2 UI/GTK2/src">fabricecolin at berlios.de
       </A><BR>
    <I>Tue Jan 10 10:46:30 CET 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000051.html">[Pinot-svn] r52 - trunk/po
</A></li>
        <LI>Next message: <A HREF="000053.html">[Pinot-svn] r54 - trunk/UI/GTK2/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52">[ date ]</a>
              <a href="thread.html#52">[ thread ]</a>
              <a href="subject.html#52">[ subject ]</a>
              <a href="author.html#52">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fabricecolin
Date: 2006-01-10 10:46:28 +0100 (Tue, 10 Jan 2006)
New Revision: 53

Modified:
   trunk/Index/LanguageDetector.cpp
   trunk/Index/Summarizer.cpp
   trunk/Tokenize/TokenizerFactory.cpp
   trunk/Tokenize/TokenizerFactory.h
   trunk/UI/GTK2/metase-gtk2.glade
   trunk/UI/GTK2/src/ModelColumns.cpp
   trunk/UI/GTK2/src/ModelColumns.h
   trunk/UI/GTK2/src/PinotUtils.cpp
   trunk/UI/GTK2/src/PinotUtils.h
   trunk/UI/GTK2/src/WorkerThreads.cpp
   trunk/UI/GTK2/src/WorkerThreads.h
   trunk/UI/GTK2/src/importDialog.cc
   trunk/UI/GTK2/src/importDialog.hh
   trunk/UI/GTK2/src/importDialog_glade.cc
   trunk/UI/GTK2/src/importDialog_glade.hh
   trunk/UI/GTK2/src/indexDialog.cc
   trunk/UI/GTK2/src/indexDialog.hh
   trunk/UI/GTK2/src/indexDialog_glade.cc
   trunk/UI/GTK2/src/mainWindow.cc
   trunk/UI/GTK2/src/mainWindow.hh
   trunk/UI/GTK2/src/prefsDialog.cc
   trunk/UI/GTK2/src/prefsDialog.hh
   trunk/UI/GTK2/src/prefsDialog_glade.cc
   trunk/UI/GTK2/src/propertiesDialog.cc
   trunk/UI/GTK2/src/propertiesDialog.hh
   trunk/UI/GTK2/src/propertiesDialog_glade.cc
   trunk/UI/GTK2/src/queryDialog.cc
   trunk/UI/GTK2/src/queryDialog.hh
   trunk/UI/GTK2/src/queryDialog_glade.cc
Log:
Tweaked user interface. Redone importDialog; documents are now imported
directly and not handled by the main window.


Modified: trunk/Index/LanguageDetector.cpp
===================================================================
--- trunk/Index/LanguageDetector.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/Index/LanguageDetector.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -137,7 +137,7 @@
 #endif
 #ifdef DEBUG
 	cout &lt;&lt; &quot;LanguageDetector::guessLanguage: language guessing with &quot;
-		&lt;&lt; textcat_Version() &lt;&lt; &quot; took &quot; &lt;&lt; timer.stop() &lt;&lt; &quot; us&quot; &lt;&lt; endl;
+		&lt;&lt; textcat_Version() &lt;&lt; &quot; took &quot; &lt;&lt; timer.stop()/1000 &lt;&lt; &quot; ms&quot; &lt;&lt; endl;
 #endif
 
 	// Close the descriptor

Modified: trunk/Index/Summarizer.cpp
===================================================================
--- trunk/Index/Summarizer.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/Index/Summarizer.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -91,7 +91,7 @@
 			pSummary = ots_get_doc_text(pArticle, &amp;outputLen);
 #ifdef DEBUG
 			cout &lt;&lt; &quot;Summarizer::summarize: summarized to &quot; &lt;&lt; outputLen &lt;&lt; &quot; bytes in &quot;
-				&lt;&lt; timer.stop() &lt;&lt; &quot; us &quot; &lt;&lt; endl;
+				&lt;&lt; timer.stop()/1000 &lt;&lt; &quot; ms&quot; &lt;&lt; endl;
 #endif
 
 			// Get the title before freeing the article

Modified: trunk/Tokenize/TokenizerFactory.cpp
===================================================================
--- trunk/Tokenize/TokenizerFactory.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/Tokenize/TokenizerFactory.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -148,7 +148,7 @@
 				if ((stat(fileName.c_str(), &amp;fileStat) == 0) &amp;&amp;
 					(S_ISREG(fileStat.st_mode)))
 				{
-					void *pHandle = dlopen(fileName.c_str(), RTLD_LAZY);
+					void *pHandle = dlopen(fileName.c_str(), RTLD_LAZY|RTLD_LOCAL);
 					if (pHandle != NULL)
 					{
 						// What type does this support ?
@@ -177,6 +177,9 @@
 						else cout &lt;&lt; &quot;TokenizerFactory::loadTokenizers: couldn't find export getTokenizerType&quot; &lt;&lt; endl;
 #endif
 					}
+#ifdef DEBUG
+					else cout &lt;&lt; &quot;TokenizerFactory::loadTokenizers: couldn't open &quot; &lt;&lt; fileName &lt;&lt; endl;
+#endif
 				}
 #ifdef DEBUG
 				else cout &lt;&lt; &quot;TokenizerFactory::loadTokenizers: &quot;
@@ -262,6 +265,19 @@
 	return pTokenizer;
 }
 
+void TokenizerFactory::getSupportedTypes(set&lt;string&gt; &amp;types)
+{
+	types.clear();
+
+	// List supported types
+	types.insert(&quot;text/plain&quot;);
+	types.insert(&quot;text/html&quot;);
+	for (map&lt;string, string&gt;::iterator iter = m_types.begin(); iter != m_types.end(); ++iter)
+	{
+		types.insert(iter-&gt;first);
+	}
+}
+
 bool TokenizerFactory::isSupportedType(const string &amp;type)
 {
 	string typeOnly = type;
@@ -292,4 +308,3 @@
 
 	return false;
 }
-

Modified: trunk/Tokenize/TokenizerFactory.h
===================================================================
--- trunk/Tokenize/TokenizerFactory.h	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/Tokenize/TokenizerFactory.h	2006-01-10 09:46:28 UTC (rev 53)
@@ -24,6 +24,7 @@
 
 #include &lt;string&gt;
 #include &lt;map&gt;
+#include &lt;set&gt;
 
 class TokenizerFactory
 {
@@ -47,6 +48,9 @@
 		/// Returns a Tokenizer that handles the given MIME type; NULL if unavailable.
 		static Tokenizer *getTokenizerByType(const string &amp;type, const Document *pDocument);
 
+		/// Returns all supported MIME types.
+		static void getSupportedTypes(set&lt;string&gt; &amp;types);
+
 		/// Indicates whether a MIME type is supported or not.
 		static bool isSupportedType(const string &amp;type);
 

Modified: trunk/UI/GTK2/metase-gtk2.glade
===================================================================
--- trunk/UI/GTK2/metase-gtk2.glade	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/metase-gtk2.glade	2006-01-10 09:46:28 UTC (rev 53)
@@ -145,7 +145,7 @@
 		      &lt;signal name=&quot;activate&quot; handler=&quot;on_clearresults_activate&quot; last_modification_time=&quot;Wed, 03 Mar 2004 19:51:48 GMT&quot;/&gt;
 
 		      &lt;child internal-child=&quot;image&quot;&gt;
-			&lt;widget class=&quot;GtkImage&quot; id=&quot;image546&quot;&gt;
+			&lt;widget class=&quot;GtkImage&quot; id=&quot;image569&quot;&gt;
 			  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 			  &lt;property name=&quot;stock&quot;&gt;gtk-clear&lt;/property&gt;
 			  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;
@@ -273,7 +273,7 @@
 		      &lt;signal name=&quot;activate&quot; handler=&quot;on_import_activate&quot; last_modification_time=&quot;Tue, 02 Mar 2004 22:13:44 GMT&quot;/&gt;
 
 		      &lt;child internal-child=&quot;image&quot;&gt;
-			&lt;widget class=&quot;GtkImage&quot; id=&quot;image547&quot;&gt;
+			&lt;widget class=&quot;GtkImage&quot; id=&quot;image570&quot;&gt;
 			  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 			  &lt;property name=&quot;stock&quot;&gt;gtk-open&lt;/property&gt;
 			  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;
@@ -311,7 +311,7 @@
 		      &lt;signal name=&quot;activate&quot; handler=&quot;on_refreshindex_activate&quot; last_modification_time=&quot;Fri, 20 Feb 2004 18:57:09 GMT&quot;/&gt;
 
 		      &lt;child internal-child=&quot;image&quot;&gt;
-			&lt;widget class=&quot;GtkImage&quot; id=&quot;image548&quot;&gt;
+			&lt;widget class=&quot;GtkImage&quot; id=&quot;image571&quot;&gt;
 			  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 			  &lt;property name=&quot;stock&quot;&gt;gtk-refresh&lt;/property&gt;
 			  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;
@@ -333,7 +333,7 @@
 		      &lt;signal name=&quot;activate&quot; handler=&quot;on_unindex_activate&quot; last_modification_time=&quot;Thu, 28 Jul 2005 12:42:23 GMT&quot;/&gt;
 
 		      &lt;child internal-child=&quot;image&quot;&gt;
-			&lt;widget class=&quot;GtkImage&quot; id=&quot;image549&quot;&gt;
+			&lt;widget class=&quot;GtkImage&quot; id=&quot;image572&quot;&gt;
 			  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 			  &lt;property name=&quot;stock&quot;&gt;gtk-delete&lt;/property&gt;
 			  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;
@@ -355,7 +355,7 @@
 		      &lt;signal name=&quot;activate&quot; handler=&quot;on_showfromindex_activate&quot; last_modification_time=&quot;Sun, 06 Nov 2005 08:43:05 GMT&quot;/&gt;
 
 		      &lt;child internal-child=&quot;image&quot;&gt;
-			&lt;widget class=&quot;GtkImage&quot; id=&quot;image550&quot;&gt;
+			&lt;widget class=&quot;GtkImage&quot; id=&quot;image573&quot;&gt;
 			  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 			  &lt;property name=&quot;stock&quot;&gt;gtk-properties&lt;/property&gt;
 			  &lt;property name=&quot;icon_size&quot;&gt;1&lt;/property&gt;
@@ -609,7 +609,7 @@
 		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
 		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 		  &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
-		  &lt;property name=&quot;expanded&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;expanded&quot;&gt;True&lt;/property&gt;
 		  &lt;property name=&quot;spacing&quot;&gt;0&lt;/property&gt;
 
 		  &lt;child&gt;
@@ -1149,7 +1149,7 @@
 		&lt;widget class=&quot;GtkHBox&quot; id=&quot;browserHbox&quot;&gt;
 		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 		  &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
-		  &lt;property name=&quot;spacing&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;spacing&quot;&gt;4&lt;/property&gt;
 
 		  &lt;child&gt;
 		    &lt;widget class=&quot;GtkEntry&quot; id=&quot;browserEntry&quot;&gt;
@@ -1184,7 +1184,7 @@
 		      &lt;signal name=&quot;clicked&quot; handler=&quot;on_browserButton_clicked&quot; last_modification_time=&quot;Sun, 10 Aug 2003 10:20:18 GMT&quot;/&gt;
 		    &lt;/widget&gt;
 		    &lt;packing&gt;
-		      &lt;property name=&quot;padding&quot;&gt;4&lt;/property&gt;
+		      &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
 		      &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
 		      &lt;property name=&quot;fill&quot;&gt;False&lt;/property&gt;
 		    &lt;/packing&gt;
@@ -2611,7 +2611,6 @@
 
 &lt;widget class=&quot;GtkDialog&quot; id=&quot;propertiesDialog&quot;&gt;
   &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;public&lt;/property&gt;
-  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
   &lt;property name=&quot;title&quot; translatable=&quot;yes&quot;&gt;Properties&lt;/property&gt;
   &lt;property name=&quot;type&quot;&gt;GTK_WINDOW_TOPLEVEL&lt;/property&gt;
   &lt;property name=&quot;window_position&quot;&gt;GTK_WIN_POS_NONE&lt;/property&gt;
@@ -3080,7 +3079,7 @@
 	    &lt;widget class=&quot;GtkHBox&quot; id=&quot;locationHbox&quot;&gt;
 	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 	      &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;spacing&quot;&gt;0&lt;/property&gt;
+	      &lt;property name=&quot;spacing&quot;&gt;4&lt;/property&gt;
 
 	      &lt;child&gt;
 		&lt;widget class=&quot;GtkEntry&quot; id=&quot;locationEntry&quot;&gt;
@@ -3116,7 +3115,7 @@
 		  &lt;signal name=&quot;clicked&quot; handler=&quot;on_locationButton_clicked&quot; last_modification_time=&quot;Tue, 15 Feb 2005 18:12:48 GMT&quot;/&gt;
 		&lt;/widget&gt;
 		&lt;packing&gt;
-		  &lt;property name=&quot;padding&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
 		  &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
 		  &lt;property name=&quot;fill&quot;&gt;False&lt;/property&gt;
 		&lt;/packing&gt;
@@ -3298,7 +3297,6 @@
 &lt;/widget&gt;
 
 &lt;widget class=&quot;GtkDialog&quot; id=&quot;importDialog&quot;&gt;
-  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
   &lt;property name=&quot;title&quot; translatable=&quot;yes&quot;&gt;Import document&lt;/property&gt;
   &lt;property name=&quot;type&quot;&gt;GTK_WINDOW_TOPLEVEL&lt;/property&gt;
   &lt;property name=&quot;window_position&quot;&gt;GTK_WIN_POS_NONE&lt;/property&gt;
@@ -3312,6 +3310,7 @@
   &lt;property name=&quot;gravity&quot;&gt;GDK_GRAVITY_NORTH_WEST&lt;/property&gt;
   &lt;property name=&quot;focus_on_map&quot;&gt;True&lt;/property&gt;
   &lt;property name=&quot;has_separator&quot;&gt;True&lt;/property&gt;
+  &lt;signal name=&quot;response&quot; handler=&quot;on_importDialog_response&quot; last_modification_time=&quot;Tue, 10 Jan 2006 05:41:42 GMT&quot;/&gt;
 
   &lt;child internal-child=&quot;vbox&quot;&gt;
     &lt;widget class=&quot;GtkVBox&quot; id=&quot;dialog-vbox7&quot;&gt;
@@ -3325,21 +3324,6 @@
 	  &lt;property name=&quot;layout_style&quot;&gt;GTK_BUTTONBOX_END&lt;/property&gt;
 
 	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkButton&quot; id=&quot;importButton&quot;&gt;
-	      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
-	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;can_default&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Import&lt;/property&gt;
-	      &lt;property name=&quot;use_underline&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;relief&quot;&gt;GTK_RELIEF_NORMAL&lt;/property&gt;
-	      &lt;property name=&quot;focus_on_click&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;response_id&quot;&gt;0&lt;/property&gt;
-	      &lt;signal name=&quot;clicked&quot; handler=&quot;on_importButton_clicked&quot; last_modification_time=&quot;Mon, 02 Jan 2006 02:49:48 GMT&quot;/&gt;
-	    &lt;/widget&gt;
-	  &lt;/child&gt;
-
-	  &lt;child&gt;
 	    &lt;widget class=&quot;GtkButton&quot; id=&quot;closeButton&quot;&gt;
 	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 	      &lt;property name=&quot;can_default&quot;&gt;True&lt;/property&gt;
@@ -3348,7 +3332,7 @@
 	      &lt;property name=&quot;use_stock&quot;&gt;True&lt;/property&gt;
 	      &lt;property name=&quot;relief&quot;&gt;GTK_RELIEF_NORMAL&lt;/property&gt;
 	      &lt;property name=&quot;focus_on_click&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;response_id&quot;&gt;-7&lt;/property&gt;
+	      &lt;property name=&quot;response_id&quot;&gt;-5&lt;/property&gt;
 	    &lt;/widget&gt;
 	  &lt;/child&gt;
 	&lt;/widget&gt;
@@ -3361,33 +3345,333 @@
       &lt;/child&gt;
 
       &lt;child&gt;
-	&lt;widget class=&quot;GtkTable&quot; id=&quot;docTable&quot;&gt;
-	  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+	&lt;widget class=&quot;GtkVBox&quot; id=&quot;importVbox&quot;&gt;
 	  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	  &lt;property name=&quot;n_rows&quot;&gt;4&lt;/property&gt;
-	  &lt;property name=&quot;n_columns&quot;&gt;3&lt;/property&gt;
 	  &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
-	  &lt;property name=&quot;row_spacing&quot;&gt;0&lt;/property&gt;
-	  &lt;property name=&quot;column_spacing&quot;&gt;0&lt;/property&gt;
+	  &lt;property name=&quot;spacing&quot;&gt;0&lt;/property&gt;
 
 	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkHButtonBox&quot; id=&quot;hbuttonbox4&quot;&gt;
+	    &lt;widget class=&quot;GtkTable&quot; id=&quot;docTable&quot;&gt;
+	      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
 	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;layout_style&quot;&gt;GTK_BUTTONBOX_DEFAULT_STYLE&lt;/property&gt;
-	      &lt;property name=&quot;spacing&quot;&gt;0&lt;/property&gt;
+	      &lt;property name=&quot;n_rows&quot;&gt;4&lt;/property&gt;
+	      &lt;property name=&quot;n_columns&quot;&gt;2&lt;/property&gt;
+	      &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
+	      &lt;property name=&quot;row_spacing&quot;&gt;0&lt;/property&gt;
+	      &lt;property name=&quot;column_spacing&quot;&gt;0&lt;/property&gt;
 
 	      &lt;child&gt;
-		&lt;widget class=&quot;GtkButton&quot; id=&quot;selectButton&quot;&gt;
+		&lt;widget class=&quot;GtkEntry&quot; id=&quot;titleEntry&quot;&gt;
 		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
 		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;editable&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;visibility&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;max_length&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;text&quot; translatable=&quot;yes&quot;&gt;&lt;/property&gt;
+		  &lt;property name=&quot;has_frame&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;invisible_char&quot;&gt;*&lt;/property&gt;
+		  &lt;property name=&quot;activates_default&quot;&gt;False&lt;/property&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
+		  &lt;property name=&quot;top_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;bottom_attach&quot;&gt;2&lt;/property&gt;
+		  &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkLabel&quot; id=&quot;locationLabel&quot;&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Location:&lt;/property&gt;
+		  &lt;property name=&quot;use_underline&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
+		  &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;selectable&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;xalign&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
+		  &lt;property name=&quot;xpad&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;ypad&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;ellipsize&quot;&gt;PANGO_ELLIPSIZE_NONE&lt;/property&gt;
+		  &lt;property name=&quot;width_chars&quot;&gt;-1&lt;/property&gt;
+		  &lt;property name=&quot;single_line_mode&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;angle&quot;&gt;0&lt;/property&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;left_attach&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;right_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;top_attach&quot;&gt;2&lt;/property&gt;
+		  &lt;property name=&quot;bottom_attach&quot;&gt;3&lt;/property&gt;
+		  &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
+		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkLabel&quot; id=&quot;titleLabel&quot;&gt;
+		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Title:&lt;/property&gt;
+		  &lt;property name=&quot;use_underline&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
+		  &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;selectable&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;xalign&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
+		  &lt;property name=&quot;xpad&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;ypad&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;ellipsize&quot;&gt;PANGO_ELLIPSIZE_NONE&lt;/property&gt;
+		  &lt;property name=&quot;width_chars&quot;&gt;-1&lt;/property&gt;
+		  &lt;property name=&quot;single_line_mode&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;angle&quot;&gt;0&lt;/property&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;left_attach&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;right_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;top_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;bottom_attach&quot;&gt;2&lt;/property&gt;
+		  &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
+		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkComboBox&quot; id=&quot;typeCombobox&quot;&gt;
+		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;items&quot; translatable=&quot;yes&quot;&gt;&lt;/property&gt;
+		  &lt;property name=&quot;add_tearoffs&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;focus_on_click&quot;&gt;True&lt;/property&gt;
+		  &lt;signal name=&quot;changed&quot; handler=&quot;on_typeCombobox_changed&quot; last_modification_time=&quot;Sun, 18 Sep 2005 04:09:29 GMT&quot;/&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
+		  &lt;property name=&quot;top_attach&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;bottom_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkLabel&quot; id=&quot;typeLabel&quot;&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Type:&lt;/property&gt;
+		  &lt;property name=&quot;use_underline&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
+		  &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;selectable&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;xalign&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
+		  &lt;property name=&quot;xpad&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;ypad&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;ellipsize&quot;&gt;PANGO_ELLIPSIZE_NONE&lt;/property&gt;
+		  &lt;property name=&quot;width_chars&quot;&gt;-1&lt;/property&gt;
+		  &lt;property name=&quot;single_line_mode&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;angle&quot;&gt;0&lt;/property&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;left_attach&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;right_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;top_attach&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;bottom_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
+		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkHBox&quot; id=&quot;locationHbox&quot;&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;spacing&quot;&gt;4&lt;/property&gt;
+
+		  &lt;child&gt;
+		    &lt;widget class=&quot;GtkEntry&quot; id=&quot;locationEntry&quot;&gt;
+		      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;editable&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;visibility&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;max_length&quot;&gt;0&lt;/property&gt;
+		      &lt;property name=&quot;text&quot; translatable=&quot;yes&quot;&gt;&lt;/property&gt;
+		      &lt;property name=&quot;has_frame&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;invisible_char&quot;&gt;*&lt;/property&gt;
+		      &lt;property name=&quot;activates_default&quot;&gt;False&lt;/property&gt;
+		      &lt;signal name=&quot;changed&quot; handler=&quot;on_locationEntry_changed&quot; last_modification_time=&quot;Sun, 18 Sep 2005 03:55:37 GMT&quot;/&gt;
+		    &lt;/widget&gt;
+		    &lt;packing&gt;
+		      &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+		      &lt;property name=&quot;expand&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
+		    &lt;/packing&gt;
+		  &lt;/child&gt;
+
+		  &lt;child&gt;
+		    &lt;widget class=&quot;GtkButton&quot; id=&quot;locationButton&quot;&gt;
+		      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;can_default&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;...&lt;/property&gt;
+		      &lt;property name=&quot;use_underline&quot;&gt;True&lt;/property&gt;
+		      &lt;property name=&quot;relief&quot;&gt;GTK_RELIEF_NORMAL&lt;/property&gt;
+		      &lt;property name=&quot;focus_on_click&quot;&gt;True&lt;/property&gt;
+		      &lt;signal name=&quot;clicked&quot; handler=&quot;on_locationButton_clicked&quot; last_modification_time=&quot;Wed, 04 Jan 2006 20:22:51 GMT&quot;/&gt;
+		    &lt;/widget&gt;
+		    &lt;packing&gt;
+		      &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+		      &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+		      &lt;property name=&quot;fill&quot;&gt;False&lt;/property&gt;
+		    &lt;/packing&gt;
+		  &lt;/child&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
+		  &lt;property name=&quot;top_attach&quot;&gt;2&lt;/property&gt;
+		  &lt;property name=&quot;bottom_attach&quot;&gt;3&lt;/property&gt;
+		  &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
+		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkLabel&quot; id=&quot;depthLabel&quot;&gt;
+		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Depth:&lt;/property&gt;
+		  &lt;property name=&quot;use_underline&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
+		  &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;selectable&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;xalign&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
+		  &lt;property name=&quot;xpad&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;ypad&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;ellipsize&quot;&gt;PANGO_ELLIPSIZE_NONE&lt;/property&gt;
+		  &lt;property name=&quot;width_chars&quot;&gt;-1&lt;/property&gt;
+		  &lt;property name=&quot;single_line_mode&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;angle&quot;&gt;0&lt;/property&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;left_attach&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;right_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;top_attach&quot;&gt;3&lt;/property&gt;
+		  &lt;property name=&quot;bottom_attach&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
+		  &lt;property name=&quot;y_options&quot;&gt;&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkSpinButton&quot; id=&quot;depthSpinbutton&quot;&gt;
+		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;climb_rate&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;digits&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;numeric&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;update_policy&quot;&gt;GTK_UPDATE_ALWAYS&lt;/property&gt;
+		  &lt;property name=&quot;snap_to_ticks&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;adjustment&quot;&gt;0 0 100 1 5 5&lt;/property&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
+		  &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
+		  &lt;property name=&quot;top_attach&quot;&gt;3&lt;/property&gt;
+		  &lt;property name=&quot;bottom_attach&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
+		  &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
+	    &lt;/widget&gt;
+	    &lt;packing&gt;
+	      &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+	      &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+	      &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
+	    &lt;/packing&gt;
+	  &lt;/child&gt;
+
+	  &lt;child&gt;
+	    &lt;widget class=&quot;GtkScrolledWindow&quot; id=&quot;mimeScrolledwindow&quot;&gt;
+	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;hscrollbar_policy&quot;&gt;GTK_POLICY_AUTOMATIC&lt;/property&gt;
+	      &lt;property name=&quot;vscrollbar_policy&quot;&gt;GTK_POLICY_AUTOMATIC&lt;/property&gt;
+	      &lt;property name=&quot;shadow_type&quot;&gt;GTK_SHADOW_IN&lt;/property&gt;
+	      &lt;property name=&quot;window_placement&quot;&gt;GTK_CORNER_TOP_LEFT&lt;/property&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkTreeView&quot; id=&quot;mimeTreeview&quot;&gt;
+		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;headers_visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;rules_hint&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;reorderable&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;enable_search&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;fixed_height_mode&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;hover_selection&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;hover_expand&quot;&gt;False&lt;/property&gt;
+		&lt;/widget&gt;
+	      &lt;/child&gt;
+	    &lt;/widget&gt;
+	    &lt;packing&gt;
+	      &lt;property name=&quot;padding&quot;&gt;4&lt;/property&gt;
+	      &lt;property name=&quot;expand&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
+	    &lt;/packing&gt;
+	  &lt;/child&gt;
+
+	  &lt;child&gt;
+	    &lt;widget class=&quot;GtkHBox&quot; id=&quot;importHbox&quot;&gt;
+	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
+	      &lt;property name=&quot;spacing&quot;&gt;4&lt;/property&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkProgressBar&quot; id=&quot;importProgressbar&quot;&gt;
+		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;orientation&quot;&gt;GTK_PROGRESS_LEFT_TO_RIGHT&lt;/property&gt;
+		  &lt;property name=&quot;fraction&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;pulse_step&quot;&gt;0.10000000149&lt;/property&gt;
+		  &lt;property name=&quot;ellipsize&quot;&gt;PANGO_ELLIPSIZE_END&lt;/property&gt;
+		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;expand&quot;&gt;True&lt;/property&gt;
+		  &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
+		&lt;/packing&gt;
+	      &lt;/child&gt;
+
+	      &lt;child&gt;
+		&lt;widget class=&quot;GtkButton&quot; id=&quot;importButton&quot;&gt;
+		  &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
+		  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 		  &lt;property name=&quot;can_default&quot;&gt;True&lt;/property&gt;
 		  &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
 		  &lt;property name=&quot;relief&quot;&gt;GTK_RELIEF_NORMAL&lt;/property&gt;
 		  &lt;property name=&quot;focus_on_click&quot;&gt;True&lt;/property&gt;
-		  &lt;signal name=&quot;clicked&quot; handler=&quot;on_selectButton_clicked&quot; last_modification_time=&quot;Tue, 09 Mar 2004 19:27:45 GMT&quot;/&gt;
+		  &lt;signal name=&quot;clicked&quot; handler=&quot;on_importButton_clicked&quot; last_modification_time=&quot;Wed, 04 Jan 2006 23:11:30 GMT&quot;/&gt;
 
 		  &lt;child&gt;
-		    &lt;widget class=&quot;GtkAlignment&quot; id=&quot;alignment29&quot;&gt;
+		    &lt;widget class=&quot;GtkAlignment&quot; id=&quot;alignment34&quot;&gt;
 		      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 		      &lt;property name=&quot;xalign&quot;&gt;0.5&lt;/property&gt;
 		      &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
@@ -3399,13 +3683,13 @@
 		      &lt;property name=&quot;right_padding&quot;&gt;0&lt;/property&gt;
 
 		      &lt;child&gt;
-			&lt;widget class=&quot;GtkHBox&quot; id=&quot;hbox43&quot;&gt;
+			&lt;widget class=&quot;GtkHBox&quot; id=&quot;hbox52&quot;&gt;
 			  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 			  &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
 			  &lt;property name=&quot;spacing&quot;&gt;2&lt;/property&gt;
 
 			  &lt;child&gt;
-			    &lt;widget class=&quot;GtkImage&quot; id=&quot;image551&quot;&gt;
+			    &lt;widget class=&quot;GtkImage&quot; id=&quot;image575&quot;&gt;
 			      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
 			      &lt;property name=&quot;stock&quot;&gt;gtk-open&lt;/property&gt;
 			      &lt;property name=&quot;icon_size&quot;&gt;4&lt;/property&gt;
@@ -3422,9 +3706,9 @@
 			  &lt;/child&gt;
 
 			  &lt;child&gt;
-			    &lt;widget class=&quot;GtkLabel&quot; id=&quot;label50&quot;&gt;
+			    &lt;widget class=&quot;GtkLabel&quot; id=&quot;label55&quot;&gt;
 			      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-			      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Select&lt;/property&gt;
+			      &lt;property name=&quot;label&quot;&gt;Import&lt;/property&gt;
 			      &lt;property name=&quot;use_underline&quot;&gt;True&lt;/property&gt;
 			      &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
 			      &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
@@ -3450,225 +3734,19 @@
 		    &lt;/widget&gt;
 		  &lt;/child&gt;
 		&lt;/widget&gt;
+		&lt;packing&gt;
+		  &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+		  &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+		  &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
+		&lt;/packing&gt;
 	      &lt;/child&gt;
 	    &lt;/widget&gt;
 	    &lt;packing&gt;
-	      &lt;property name=&quot;left_attach&quot;&gt;2&lt;/property&gt;
-	      &lt;property name=&quot;right_attach&quot;&gt;3&lt;/property&gt;
-	      &lt;property name=&quot;top_attach&quot;&gt;3&lt;/property&gt;
-	      &lt;property name=&quot;bottom_attach&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
+	      &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+	      &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+	      &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
 	    &lt;/packing&gt;
 	  &lt;/child&gt;
-
-	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkEntry&quot; id=&quot;locationEntry&quot;&gt;
-	      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
-	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;editable&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;visibility&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;max_length&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;text&quot; translatable=&quot;yes&quot;&gt;&lt;/property&gt;
-	      &lt;property name=&quot;has_frame&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;invisible_char&quot;&gt;*&lt;/property&gt;
-	      &lt;property name=&quot;activates_default&quot;&gt;False&lt;/property&gt;
-	      &lt;signal name=&quot;changed&quot; handler=&quot;on_locationEntry_changed&quot; last_modification_time=&quot;Sun, 18 Sep 2005 03:55:37 GMT&quot;/&gt;
-	    &lt;/widget&gt;
-	    &lt;packing&gt;
-	      &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
-	      &lt;property name=&quot;top_attach&quot;&gt;3&lt;/property&gt;
-	      &lt;property name=&quot;bottom_attach&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
-	    &lt;/packing&gt;
-	  &lt;/child&gt;
-
-	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkEntry&quot; id=&quot;titleEntry&quot;&gt;
-	      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
-	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;editable&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;visibility&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;max_length&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;text&quot; translatable=&quot;yes&quot;&gt;&lt;/property&gt;
-	      &lt;property name=&quot;has_frame&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;invisible_char&quot;&gt;*&lt;/property&gt;
-	      &lt;property name=&quot;activates_default&quot;&gt;False&lt;/property&gt;
-	    &lt;/widget&gt;
-	    &lt;packing&gt;
-	      &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
-	      &lt;property name=&quot;top_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;bottom_attach&quot;&gt;2&lt;/property&gt;
-	      &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
-	    &lt;/packing&gt;
-	  &lt;/child&gt;
-
-	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkLabel&quot; id=&quot;locationLabel&quot;&gt;
-	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Location:&lt;/property&gt;
-	      &lt;property name=&quot;use_underline&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
-	      &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;selectable&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;xalign&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
-	      &lt;property name=&quot;xpad&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;ypad&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;ellipsize&quot;&gt;PANGO_ELLIPSIZE_NONE&lt;/property&gt;
-	      &lt;property name=&quot;width_chars&quot;&gt;-1&lt;/property&gt;
-	      &lt;property name=&quot;single_line_mode&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;angle&quot;&gt;0&lt;/property&gt;
-	    &lt;/widget&gt;
-	    &lt;packing&gt;
-	      &lt;property name=&quot;left_attach&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;right_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;top_attach&quot;&gt;3&lt;/property&gt;
-	      &lt;property name=&quot;bottom_attach&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
-	      &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
-	    &lt;/packing&gt;
-	  &lt;/child&gt;
-
-	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkLabel&quot; id=&quot;titleLabel&quot;&gt;
-	      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
-	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Title:&lt;/property&gt;
-	      &lt;property name=&quot;use_underline&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
-	      &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;selectable&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;xalign&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
-	      &lt;property name=&quot;xpad&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;ypad&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;ellipsize&quot;&gt;PANGO_ELLIPSIZE_NONE&lt;/property&gt;
-	      &lt;property name=&quot;width_chars&quot;&gt;-1&lt;/property&gt;
-	      &lt;property name=&quot;single_line_mode&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;angle&quot;&gt;0&lt;/property&gt;
-	    &lt;/widget&gt;
-	    &lt;packing&gt;
-	      &lt;property name=&quot;left_attach&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;right_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;top_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;bottom_attach&quot;&gt;2&lt;/property&gt;
-	      &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
-	      &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
-	    &lt;/packing&gt;
-	  &lt;/child&gt;
-
-	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkLabel&quot; id=&quot;depthLabel&quot;&gt;
-	      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
-	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Maximum depth:&lt;/property&gt;
-	      &lt;property name=&quot;use_underline&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
-	      &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;selectable&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;xalign&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
-	      &lt;property name=&quot;xpad&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;ypad&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;ellipsize&quot;&gt;PANGO_ELLIPSIZE_NONE&lt;/property&gt;
-	      &lt;property name=&quot;width_chars&quot;&gt;-1&lt;/property&gt;
-	      &lt;property name=&quot;single_line_mode&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;angle&quot;&gt;0&lt;/property&gt;
-	    &lt;/widget&gt;
-	    &lt;packing&gt;
-	      &lt;property name=&quot;left_attach&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;right_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;top_attach&quot;&gt;2&lt;/property&gt;
-	      &lt;property name=&quot;bottom_attach&quot;&gt;3&lt;/property&gt;
-	      &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
-	      &lt;property name=&quot;y_options&quot;&gt;&lt;/property&gt;
-	    &lt;/packing&gt;
-	  &lt;/child&gt;
-
-	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkSpinButton&quot; id=&quot;depthSpinbutton&quot;&gt;
-	      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
-	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;climb_rate&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;digits&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;numeric&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;update_policy&quot;&gt;GTK_UPDATE_ALWAYS&lt;/property&gt;
-	      &lt;property name=&quot;snap_to_ticks&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;adjustment&quot;&gt;0 0 100 1 5 5&lt;/property&gt;
-	    &lt;/widget&gt;
-	    &lt;packing&gt;
-	      &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
-	      &lt;property name=&quot;top_attach&quot;&gt;2&lt;/property&gt;
-	      &lt;property name=&quot;bottom_attach&quot;&gt;3&lt;/property&gt;
-	      &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
-	    &lt;/packing&gt;
-	  &lt;/child&gt;
-
-	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkComboBox&quot; id=&quot;typeCombobox&quot;&gt;
-	      &lt;property agent=&quot;glademm&quot; name=&quot;cxx_visibility&quot;&gt;protected&lt;/property&gt;
-	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;items&quot; translatable=&quot;yes&quot;&gt;&lt;/property&gt;
-	      &lt;property name=&quot;add_tearoffs&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;focus_on_click&quot;&gt;True&lt;/property&gt;
-	      &lt;signal name=&quot;changed&quot; handler=&quot;on_typeCombobox_changed&quot; last_modification_time=&quot;Sun, 18 Sep 2005 04:09:29 GMT&quot;/&gt;
-	    &lt;/widget&gt;
-	    &lt;packing&gt;
-	      &lt;property name=&quot;left_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;right_attach&quot;&gt;2&lt;/property&gt;
-	      &lt;property name=&quot;top_attach&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;bottom_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;x_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_padding&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
-	    &lt;/packing&gt;
-	  &lt;/child&gt;
-
-	  &lt;child&gt;
-	    &lt;widget class=&quot;GtkLabel&quot; id=&quot;typeLabel&quot;&gt;
-	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
-	      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Type:&lt;/property&gt;
-	      &lt;property name=&quot;use_underline&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
-	      &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;selectable&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;xalign&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
-	      &lt;property name=&quot;xpad&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;ypad&quot;&gt;4&lt;/property&gt;
-	      &lt;property name=&quot;ellipsize&quot;&gt;PANGO_ELLIPSIZE_NONE&lt;/property&gt;
-	      &lt;property name=&quot;width_chars&quot;&gt;-1&lt;/property&gt;
-	      &lt;property name=&quot;single_line_mode&quot;&gt;False&lt;/property&gt;
-	      &lt;property name=&quot;angle&quot;&gt;0&lt;/property&gt;
-	    &lt;/widget&gt;
-	    &lt;packing&gt;
-	      &lt;property name=&quot;left_attach&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;right_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;top_attach&quot;&gt;0&lt;/property&gt;
-	      &lt;property name=&quot;bottom_attach&quot;&gt;1&lt;/property&gt;
-	      &lt;property name=&quot;x_options&quot;&gt;fill&lt;/property&gt;
-	      &lt;property name=&quot;y_options&quot;&gt;fill&lt;/property&gt;
-	    &lt;/packing&gt;
-	  &lt;/child&gt;
 	&lt;/widget&gt;
 	&lt;packing&gt;
 	  &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;

Modified: trunk/UI/GTK2/src/ModelColumns.cpp
===================================================================
--- trunk/UI/GTK2/src/ModelColumns.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/ModelColumns.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -119,3 +119,13 @@
 MailAccountModelColumns::~MailAccountModelColumns()
 {
 }
+
+TypeModelColumns::TypeModelColumns()
+{
+	add(m_enabled);
+	add(m_type);
+}
+
+TypeModelColumns::~TypeModelColumns()
+{
+}

Modified: trunk/UI/GTK2/src/ModelColumns.h
===================================================================
--- trunk/UI/GTK2/src/ModelColumns.h	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/ModelColumns.h	2006-01-10 09:46:28 UTC (rev 53)
@@ -150,4 +150,16 @@
 
 };
 
+/// Import window, model column for the types tree.
+class TypeModelColumns : public Gtk::TreeModel::ColumnRecord
+{
+public:
+	TypeModelColumns();
+	virtual ~TypeModelColumns();
+
+	Gtk::TreeModelColumn&lt;bool&gt; m_enabled;
+	Gtk::TreeModelColumn&lt;Glib::ustring&gt; m_type;
+
+};
+
 #endif // _MODELCOLUMNS_HH

Modified: trunk/UI/GTK2/src/PinotUtils.cpp
===================================================================
--- trunk/UI/GTK2/src/PinotUtils.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/PinotUtils.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -15,6 +15,8 @@
  */
 
 #include &lt;iostream&gt;
+#include &lt;pangomm/font.h&gt;
+#include &lt;gtkmm/rc.h&gt;
 #include &lt;gtkmm/stock.h&gt;
 #include &lt;gtkmm/filechooserdialog.h&gt;
 
@@ -27,6 +29,7 @@
 using namespace Glib;
 using namespace Gtk;
 
+/// Open a FileChooserDialog.
 bool select_file_name(Window &amp;parentWindow, const ustring &amp;title,
 	ustring &amp;location, bool openOrCreate, bool directoriesOnly)
 {
@@ -69,6 +72,7 @@
 	return false;
 }
 
+/// Prepare a FileChooser.
 bool prepare_chooser(FileChooser *pChooser, ustring &amp;location,
 	bool openOrCreate, bool directoriesOnly)
 {
@@ -118,6 +122,40 @@
 	return false;
 }
 
+/// Get a column height.
+int get_column_height(TreeView *pTree)
+{
+	if (pTree == NULL)
+	{
+		return 0;
+	}
+
+	RefPtr&lt;Style&gt; refRCStyle = RC::get_style(*pTree);
+	int fontSize = refRCStyle-&gt;get_font().get_size();
+	int height = fontSize / Pango::SCALE;
+#ifdef DEBUG
+	cout &lt;&lt; &quot;get_column_height: font &quot; &lt;&lt; height &lt;&lt; &quot;, &quot; &lt;&lt; fontSize &lt;&lt; endl;
+#endif
+
+	TreeViewColumn *pColumn = pTree-&gt;get_column(1);
+	if (pColumn != NULL)
+	{
+		Gdk::Rectangle cellArea;
+		int xOffset, yOffset, cellWidth, cellHeight;
+
+		pColumn-&gt;cell_get_size(cellArea, xOffset, yOffset, cellWidth, cellHeight);
+		height += cellHeight;
+#ifdef DEBUG
+		cout &lt;&lt; &quot;get_column_height: cell &quot; &lt;&lt; cellHeight &lt;&lt; &quot; &quot; &lt;&lt; yOffset &lt;&lt; endl;
+#endif
+	}
+#ifdef DEBUG
+	cout &lt;&lt; &quot;get_column_height: &quot; &lt;&lt; height &lt;&lt; endl;
+#endif
+
+	return height;
+}
+
 /// Create a resizable text column.
 TreeViewColumn *create_resizable_column(const ustring &amp;title, const TreeModelColumnBase&amp; modelColumn)
 {

Modified: trunk/UI/GTK2/src/PinotUtils.h
===================================================================
--- trunk/UI/GTK2/src/PinotUtils.h	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/PinotUtils.h	2006-01-10 09:46:28 UTC (rev 53)
@@ -18,7 +18,6 @@
 #define _PINOTUTILS_HH
 
 #include &lt;string&gt;
-#include &lt;vector&gt;
 #if GTKMM_MAJOR_VERSION==2 &amp;&amp; GTKMM_MINOR_VERSION&gt;2
 #include &lt;sigc++/compatibility.h&gt;
 #endif
@@ -36,6 +35,9 @@
 bool prepare_chooser(Gtk::FileChooser *pChooser, Glib::ustring &amp;location,
 	bool openOrCreate = true, bool directoriesOnly = false);
 
+/// Get a column height.
+int get_column_height(Gtk::TreeView *pTree);
+
 /// Create a resizable text column.
 Gtk::TreeViewColumn *create_resizable_column(const Glib::ustring &amp;title,
 	const Gtk::TreeModelColumnBase&amp; modelColumn);

Modified: trunk/UI/GTK2/src/WorkerThreads.cpp
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/WorkerThreads.cpp	2006-01-10 09:46:28 UTC (rev 53)
@@ -15,6 +15,7 @@
  */
 
 #include &lt;sys/types.h&gt;
+#include &lt;dirent.h&gt;
 #include &lt;sys/stat.h&gt;
 #include &lt;unistd.h&gt;
 #include &lt;stdlib.h&gt;
@@ -51,16 +52,30 @@
 using namespace Glib;
 using namespace std;
 
-// The Dispatcher object used to signal the UI thread
-Dispatcher WorkerThread::m_signalFinished;
+// A function object to delete pointers from a set with for_each()
+struct DeleteSetPointer
+{
+	template&lt;typename T&gt;
+	void operator()(const T *ptr) const
+	{
+		delete ptr;
+	}
+};
 
-WorkerThread::WorkerThread()
+Dispatcher WorkerThread::m_dispatcher;
+
+Dispatcher &amp;WorkerThread::getDispatcher(void)
 {
-	m_id = 0;
-	m_background = m_done = false;
-	m_status = &quot;&quot;;
+	return m_dispatcher;
 }
 
+WorkerThread::WorkerThread() :
+	m_id(0),
+	m_background(false),
+	m_done(false)
+{
+}
+
 WorkerThread::~WorkerThread()
 {
 }
@@ -90,11 +105,6 @@
 	return m_id &lt; other.m_id;
 }
 
-Dispatcher&amp; WorkerThread::getFinishedSignal()
-{
-	return m_signalFinished;
-}
-
 bool WorkerThread::isDone(void) const
 {
 	return m_done;
@@ -116,9 +126,195 @@
 	cout &lt;&lt; &quot;WorkerThread::emitSignal: end of thread &quot; &lt;&lt; m_id &lt;&lt; endl;
 #endif
 	m_done = true;
-	m_signalFinished.emit();
+	m_dispatcher.emit();
 }
 
+ThreadsManager::ThreadsManager() :
+	m_nextId(1),
+	m_backgroundThreadsCount(0)
+{
+	pthread_rwlock_init(&amp;m_rwLock, NULL);
+}
+
+ThreadsManager::~ThreadsManager()
+{
+	if (m_threads.empty() == false)
+	{
+		for_each(m_threads.begin(), m_threads.end(), DeleteSetPointer());
+	}
+	// Destroy the read/write lock
+	pthread_rwlock_destroy(&amp;m_rwLock);
+}
+
+bool ThreadsManager::read_lock(unsigned int where)
+{
+	if (pthread_rwlock_rdlock(&amp;m_rwLock) == 0)
+	{
+#ifdef DEBUG
+		cout &lt;&lt; &quot;ThreadsManager::read_lock &quot; &lt;&lt; where &lt;&lt; endl;
+#endif
+		return true;
+	}
+
+	return false;
+}
+
+bool ThreadsManager::write_lock(unsigned int where)
+{
+	if (pthread_rwlock_wrlock(&amp;m_rwLock) == 0)
+	{
+#ifdef DEBUG
+		cout &lt;&lt; &quot;ThreadsManager::write_lock &quot; &lt;&lt; where &lt;&lt; endl;
+#endif
+		return true;
+	}
+
+	return false;
+}
+
+void ThreadsManager::unlock(void)
+{
+#ifdef DEBUG
+	cout &lt;&lt; &quot;ThreadsManager::unlock&quot; &lt;&lt; endl;
+#endif
+	pthread_rwlock_unlock(&amp;m_rwLock);
+}
+
+WorkerThread *ThreadsManager::on_thread_end(void)
+{
+	WorkerThread *pThread = NULL;
+
+	// Get the first thread that's finished
+	if (read_lock(1) == true)
+	{
+		for (set&lt;WorkerThread *&gt;::iterator threadIter = m_threads.begin();
+			threadIter != m_threads.end(); ++threadIter)
+		{
+			if ((*threadIter)-&gt;isDone() == true)
+			{
+				// This one will do...
+				pThread = (*threadIter);
+				// Remove it
+				m_threads.erase(threadIter);
+				break;
+			}
+#ifdef DEBUG
+			cout &lt;&lt; &quot;ThreadsManager::on_thread_end: thread &quot;
+				&lt;&lt; (*threadIter)-&gt;getId() &lt;&lt; &quot; is not done&quot; &lt;&lt; endl;
+#endif
+		}
+
+		unlock();
+	}
+
+	if (pThread == NULL)
+	{
+		return NULL;
+	}
+
+	if (pThread-&gt;isBackground() == true)
+	{
+		--m_backgroundThreadsCount;
+	}
+
+	return pThread;
+}
+
+bool ThreadsManager::start_thread(WorkerThread *pNewThread, bool inBackground)
+{
+	bool insertedThread = false;
+
+	if (pNewThread == NULL)
+	{
+		return false;
+	}
+
+	pNewThread-&gt;setId(m_nextId);
+	if (write_lock(2) == true)
+	{
+		pair&lt;set&lt;WorkerThread *&gt;::iterator, bool&gt; insertPair = m_threads.insert(pNewThread);
+		insertedThread = insertPair.second;
+
+		unlock();
+	}
+
+	// Was it inserted ?
+	if (insertedThread == false)
+	{
+		// No, it wasn't
+#ifdef DEBUG
+		cout &lt;&lt; &quot;ThreadsManager::start_thread: couldn't start &quot;
+			&lt;&lt; pNewThread-&gt;getType() &lt;&lt; endl;
+#endif
+		return false;
+	}
+
+	// Start the thread
+	if (inBackground == true)
+	{
+		pNewThread-&gt;inBackground();
+		++m_backgroundThreadsCount;
+	}
+	pNewThread-&gt;start();
+	++m_nextId;
+
+	return true;
+}
+
+unsigned int ThreadsManager::get_threads_count(void)
+{
+	int count = 0;
+
+	if (read_lock(3) == true)
+	{
+		count = m_threads.size() - m_backgroundThreadsCount;
+
+		unlock();
+	}
+#ifdef DEBUG
+	cout &lt;&lt; &quot;ThreadsManager::get_threads_count: &quot; &lt;&lt; count &lt;&lt; &quot; threads left&quot; &lt;&lt; endl;
+#endif
+
+	// A negative count would mean that a background thread
+	// exited without signaling
+	return (unsigned int)max(count , 0);
+}
+
+bool ThreadsManager::has_threads(void)
+{
+	if (m_threads.empty() == true)
+	{
+		return false;
+	}
+
+	return true;
+}
+
+void ThreadsManager::stop_threads(void)
+{
+	if (read_lock(4) == true)
+	{
+		for (set&lt;WorkerThread *&gt;::iterator threadIter = m_threads.begin();
+			threadIter != m_threads.end(); ++threadIter)
+		{
+			// Stop all threads
+			// FIXME: what if one thread doesn't stop ?
+			(*threadIter)-&gt;stop();
+		}
+
+		unlock();
+	}
+}
+
+void ThreadsManager::disconnect(void)
+{
+	m_threadsEndConnection.block();
+	m_threadsEndConnection.disconnect();
+#ifdef DEBUG
+	cout &lt;&lt; &quot;ThreadsManager::disconnect: disconnected&quot; &lt;&lt; endl;
+#endif
+}
+
 IndexBrowserThread::IndexBrowserThread(const string &amp;indexName,
 	unsigned int maxDocsCount, unsigned int startDoc) :
 	WorkerThread()
@@ -240,9 +436,7 @@
 			IndexedDocument indexedDoc(docInfo.getTitle(), url, docInfo.getLocation(),
 				type, docInfo.getLanguage());
 			indexedDoc.setTimestamp(date);
-#ifdef DEBUG
-			cout &lt;&lt; &quot;IndexBrowserThread::do_browsing: timestamp for &quot; &lt;&lt; docId &lt;&lt; &quot; is &quot; &lt;&lt; date &lt;&lt; endl;
-#endif
+
 			// Signal
 			m_signalUpdate(indexedDoc, docId, m_indexName);
 			++numDocs;
@@ -1157,10 +1351,11 @@
 		while (m_done == false)
 		{
 			int fdCount = select(fd + 1, &amp;listenSet, NULL, NULL, NULL);
-			if (fdCount &lt; 0)
+			if ((fdCount &lt; 0) &amp;&amp;
+				(errno != EINTR))
 			{
 #ifdef DEBUG
-				perror(&quot;ListenerThread::do_listening: select() failed&quot;);
+				cout &lt;&lt; &quot;ListenerThread::do_listening: select() failed&quot; &lt;&lt; endl;
 #endif
 				break;
 			}
@@ -1338,24 +1533,22 @@
 		selectTimeout.tv_usec = 0;
 
 		int fdCount = select(fd + 1, &amp;listenSet, NULL, NULL, &amp;selectTimeout);
-		if (fdCount &lt; 0)
+		if ((fdCount &lt; 0) &amp;&amp;
+			(errno != EINTR))
 		{
 #ifdef DEBUG
-			perror(&quot;MonitorThread::do_monitoring: select() failed&quot;);
+			cout &lt;&lt; &quot;MonitorThread::do_monitoring: select() failed&quot; &lt;&lt; endl;
 #endif
 			break;
 		}
 		else if (FD_ISSET(fd, &amp;listenSet))
 		{
-#ifdef DEBUG
-			cout &lt;&lt; &quot;MonitorThread::do_monitoring: select() returned&quot; &lt;&lt; endl;
-#endif
 			// There might be more than one event waiting...
 			int pendingEvents = FAMPending(&amp;famConn);
 			if (pendingEvents &lt; 0)
 			{
 #ifdef DEBUG
-				perror(&quot;MonitorThread::do_monitoring: FAMPending() failed&quot;);
+				cout &lt;&lt; &quot;MonitorThread::do_monitoring: FAMPending() failed&quot; &lt;&lt; endl;
 #endif
 				break;
 			}
@@ -1462,9 +1655,6 @@
 			setLocationsToMonitor = true;
 		}
 	}
-#ifdef DEBUG
-	cout &lt;&lt; &quot;MonitorThread::do_monitoring: quitting...&quot; &lt;&lt; endl;
-#endif
 
 	// Stop monitoring and close the connection
 	FAMCancelMonitor(&amp;famConn, &amp;famReq);
@@ -1472,3 +1662,173 @@
 
 	emitSignal();
 }
+
+DirectoryScannerThread::DirectoryScannerThread(const std::string &amp;dirName,
+			unsigned int maxLevel, pthread_mutex_t *pMutex,
+			pthread_cond_t *pCondVar) :
+	WorkerThread(),
+	m_dirName(dirName),
+	m_maxLevel(maxLevel),
+	m_pMutex(pMutex),
+	m_pCondVar(pCondVar)
+{
+}
+
+DirectoryScannerThread::~DirectoryScannerThread()
+{
+}
+
+bool DirectoryScannerThread::start(void)
+{
+	// Create a non-joinable thread
+	Thread::create(slot_class(*this, &amp;DirectoryScannerThread::do_scanning), false);
+
+	return true;
+}
+
+string DirectoryScannerThread::getType(void) const
+{
+	return &quot;DirectoryScannerThread&quot;;
+}
+
+bool DirectoryScannerThread::stop(void)
+{
+	m_done = true;
+	m_status = _(&quot;Stopped scanning &quot;);
+	m_status += &quot; &quot;;
+	m_status += m_dirName;
+
+	return true;
+}
+
+Signal1&lt;bool, const string&amp;&gt;&amp; DirectoryScannerThread::getFileFoundSignal(void)
+{
+	return m_signalFileFound;
+}
+
+void DirectoryScannerThread::found_file(const string &amp;fileName)
+{
+	if (fileName.empty() == true)
+	{
+		return;
+	}
+
+	if ((m_pMutex != NULL) &amp;&amp;
+		(m_pCondVar != NULL) &amp;&amp;
+		(pthread_mutex_lock(m_pMutex) == 0))
+	{
+		if (m_signalFileFound(fileName) == true)
+		{
+			// Another file is needed right now
+			pthread_mutex_unlock(m_pMutex);
+		}
+		else
+		{
+#ifdef DEBUG
+			cout &lt;&lt; &quot;DirectoryScannerThread::found_file: waiting&quot; &lt;&lt; endl;
+#endif
+			// Don't resume until signaled
+			pthread_cond_wait(m_pCondVar, m_pMutex);
+			pthread_mutex_unlock(m_pMutex);
+#ifdef DEBUG
+			cout &lt;&lt; &quot;DirectoryScannerThread::found_file: signaled&quot; &lt;&lt; endl;
+#endif
+		}
+	}
+}
+
+void DirectoryScannerThread::do_scanning()
+{
+	struct stat fileStat;
+
+	if ((m_dirName.empty() == true) ||
+		(lstat(m_dirName.c_str(), &amp;fileStat) == -1))
+	{
+#ifdef DEBUG
+		cout &lt;&lt; &quot;DirectoryScannerThread::do_scanning: stat failed&quot; &lt;&lt; endl;
+#endif
+		return;
+	}
+
+	// Is it a file or a directory ?
+	if (S_ISLNK(fileStat.st_mode))
+	{
+		// Don't follow
+#ifdef DEBUG
+		cout &lt;&lt; &quot;DirectoryScannerThread::do_scanning: skipping symlink&quot; &lt;&lt; endl;
+#endif
+		return;
+	}
+	else if (S_ISREG(fileStat.st_mode))
+	{
+		// It's actually a file
+		found_file(m_dirName);
+	}
+	else if (S_ISDIR(fileStat.st_mode))
+	{
+		// A directory : scan it
+		DIR *pDir = opendir(m_dirName.c_str());
+		if (pDir == NULL)
+		{
+			return;
+		}
+#ifdef DEBUG
+		cout &lt;&lt; &quot;DirectoryScannerThread::do_scanning: entering &quot; &lt;&lt; m_dirName &lt;&lt; endl;
+#endif
+
+		// Iterate through this directory's entries
+		struct dirent *pDirEntry = readdir(pDir);
+		while ((m_done == false) &amp;&amp;
+			(pDirEntry != NULL))
+		{
+			char *pEntryName = pDirEntry-&gt;d_name;
+			if (pEntryName != NULL)
+			{
+				string entryName = m_dirName;
+				if (m_dirName[m_dirName.length() - 1] != '/')
+				{
+					entryName += &quot;/&quot;;
+				}
+				entryName += pEntryName;
+
+				// Skip . .. and dotfiles
+				Url urlObj(&quot;<A HREF="file://">file://</A>&quot; + entryName);
+				if ((urlObj.getFile() == &quot;.&quot;) ||
+					(urlObj.getFile() == &quot;..&quot;) ||
+					(urlObj.getFile()[0] == '.') ||
+					(lstat(entryName.c_str(), &amp;fileStat) == -1))
+				{
+					// Next entry
+					pDirEntry = readdir(pDir);
+					continue;
+				}
+
+#ifdef DEBUG
+				cout &lt;&lt; &quot;DirectoryScannerThread::do_scanning: stat'ing &quot; &lt;&lt; entryName &lt;&lt; endl;
+#endif
+				// File or directory
+				if (S_ISREG(fileStat.st_mode))
+				{
+					found_file(entryName);
+				}
+				else if (S_ISDIR(fileStat.st_mode))
+				{
+					// Can we scan this directory ?
+					if (m_currentLevel + 1 &lt; m_maxLevel)
+					{
+						++m_currentLevel;
+						m_dirName = entryName;
+						do_scanning();
+						--m_currentLevel;
+					}
+				}
+			}
+
+			// Next entry
+			pDirEntry = readdir(pDir);
+		}
+		closedir(pDir);
+	}
+
+	emitSignal();
+}

Modified: trunk/UI/GTK2/src/WorkerThreads.h
===================================================================
--- trunk/UI/GTK2/src/WorkerThreads.h	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/WorkerThreads.h	2006-01-10 09:46:28 UTC (rev 53)
@@ -22,7 +22,9 @@
 #include &lt;vector&gt;
 #include &lt;set&gt;
 #include &lt;map&gt;
+#include &lt;pthread.h&gt;
 #include &lt;sigc++/slot.h&gt;
+#include &lt;sigc++/connection.h&gt;
 #include &lt;glibmm/dispatcher.h&gt;
 #include &lt;glibmm/ustring.h&gt;
 
@@ -39,6 +41,8 @@
 		WorkerThread();
 		virtual ~WorkerThread();
 
+		static Glib::Dispatcher &amp;getDispatcher(void);
+
 		void setId(unsigned int id);
 
 		unsigned int getId(void);
@@ -55,9 +59,6 @@
 
 		virtual bool stop(void) = 0;
 
-		/// Only one thread (the GUI thread) should connect to this, before calling start().
-		static Glib::Dispatcher&amp; getFinishedSignal();
-
 		bool isDone(void) const;
 
 		void reset(void);
@@ -65,8 +66,8 @@
 		std::string getStatus(void) const;
 
 	protected:
-		/// Use a Dispatcher, not a Signal, for thread safety
-		static Glib::Dispatcher m_signalFinished;
+		/// Use a Dispatcher for thread safety
+		static Glib::Dispatcher m_dispatcher;
 		unsigned int m_id;
 		bool m_background;
 		bool m_done;
@@ -80,6 +81,42 @@
 
 };
 
+class ThreadsManager
+{
+	public:
+		ThreadsManager();
+		virtual ~ThreadsManager();
+
+		bool read_lock(unsigned int where);
+		bool write_lock(unsigned int where);
+		void unlock(void);
+
+		bool start_thread(WorkerThread *pNewThread, bool inBackground);
+
+		WorkerThread *on_thread_end(void);
+
+		unsigned int get_threads_count(void);
+
+		bool has_threads(void);
+
+		void stop_threads(void);
+
+		virtual void disconnect(void);
+
+	protected:
+		SigC::Connection m_threadsEndConnection;
+		// Read/write lock
+		pthread_rwlock_t m_rwLock;
+		std::set&lt;WorkerThread *&gt; m_threads;
+		unsigned int m_nextId;
+		unsigned int m_backgroundThreadsCount;
+
+	private:
+		ThreadsManager(const ThreadsManager &amp;other);
+		ThreadsManager &amp;operator=(const ThreadsManager &amp;other);
+
+};
+
 class IndexBrowserThread : public WorkerThread
 {
 	public:
@@ -387,4 +424,37 @@
 
 };
 
+class DirectoryScannerThread : public WorkerThread
+{
+	public:
+		DirectoryScannerThread(const std::string &amp;dirName,
+			unsigned int maxLevel, pthread_mutex_t *pMutex,
+			pthread_cond_t *pCondVar);
+		virtual ~DirectoryScannerThread();
+
+		virtual bool start(void);
+
+		virtual std::string getType(void) const;
+
+		virtual bool stop(void);
+
+		SigC::Signal1&lt;bool, const std::string&amp;&gt;&amp; getFileFoundSignal(void);
+
+	protected:
+		std::string m_dirName;
+		unsigned int m_maxLevel;
+		pthread_mutex_t *m_pMutex;
+		pthread_cond_t *m_pCondVar;
+		unsigned int m_currentLevel;
+		SigC::Signal1&lt;bool, const std::string&amp;&gt; m_signalFileFound;
+
+		void found_file(const std::string &amp;fileName);
+		void do_scanning();
+
+	private:
+		DirectoryScannerThread(const DirectoryScannerThread &amp;other);
+		DirectoryScannerThread &amp;operator=(const DirectoryScannerThread &amp;other);
+
+};
+
 #endif // _WORKERTHREADS_HH

Modified: trunk/UI/GTK2/src/importDialog.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/importDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,22 +1,34 @@
-// generated 2004/3/6 14:15:21 GMT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to importDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include &lt;stdlib.h&gt;
-#include &lt;sys/types.h&gt;
-#include &lt;dirent.h&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;unistd.h&gt;
+#include &lt;strings.h&gt;
 #include &lt;iostream&gt;
+#include &lt;algorithm&gt;
+#include &lt;utility&gt;
+#include &lt;sigc++/class_slot.h&gt;
 #include &lt;glibmm/convert.h&gt;
+#include &lt;gtkmm/stock.h&gt;
+#include &lt;gtkmm/main.h&gt;
 
 #include &quot;config.h&quot;
 #include &quot;MIMEScanner.h&quot;
 #include &quot;NLS.h&quot;
 #include &quot;Url.h&quot;
+#include &quot;XapianIndex.h&quot;
 #include &quot;PinotSettings.h&quot;
 #include &quot;PinotUtils.h&quot;
 #include &quot;importDialog.hh&quot;
@@ -26,63 +38,96 @@
 using namespace Glib;
 using namespace Gtk;
 
-string importDialog::m_directory = &quot;&quot;;
+string importDialog::InternalState::m_defaultDirectory = &quot;&quot;;
 
+importDialog::InternalState::InternalState(importDialog *pWindow) :
+	ThreadsManager(),
+	m_importing(false),
+	m_pImportWindow(pWindow)
+{
+	pthread_mutex_init(&amp;m_scanMutex, NULL);
+	pthread_cond_init(&amp;m_scanCondVar, NULL);
+}
+
+importDialog::InternalState::~InternalState()
+{
+	pthread_cond_destroy(&amp;m_scanCondVar);
+	pthread_mutex_destroy(&amp;m_scanMutex);
+}
+
+void importDialog::InternalState::connect(void)
+{
+	if (m_pImportWindow != NULL)
+	{
+		// Connect the dispatcher
+		m_threadsEndConnection = WorkerThread::getDispatcher().connect(
+			SigC::slot(*m_pImportWindow, &amp;importDialog::on_thread_end));
+#ifdef DEBUG
+		cout &lt;&lt; &quot;importDialog::InternalState::connect: connected&quot; &lt;&lt; endl;
+#endif
+	}
+}
+
 importDialog::importDialog(const Glib::ustring &amp;title,
-	bool selectTitle, bool selectDepth, bool allowLocalOnly) :
+	const set&lt;string&gt; &amp;mimeTypes) :
 	importDialog_glade(),
 	m_docsCount(0),
 	m_importDirectory(false),
-	m_maxDirLevel(1)
+	m_state(this)
 {
-	// Associate the columns model to the type combo
-	m_refTypeList = ListStore::create(m_typeColumns);
-	typeCombobox-&gt;set_model(m_refTypeList);
-	typeCombobox-&gt;pack_start(m_typeColumns.m_name);
-	// Populate
-	populate_combobox(allowLocalOnly);
+	set_title(title);
 
+	// Copy the list of authorized MIME types
+	copy(mimeTypes.begin(), mimeTypes.end(), inserter(m_mimeTypes, m_mimeTypes.begin()));
+	// FIXME: populate the list
+
 	// Initialize the default directory
-	if (m_directory.empty() == true)
+	if (m_state.m_defaultDirectory.empty() == true)
 	{
 		char *homeDir = getenv(&quot;HOME&quot;);
 		if (homeDir != NULL)
 		{
-			m_directory = homeDir + string(&quot;/&quot;);
+			m_state.m_defaultDirectory = homeDir + string(&quot;/&quot;);
 		}
 	}
 
-	set_title(title);
+	// Associate the columns model to the type combo
+	m_refTypeList = ListStore::create(m_typeColumns);
+	typeCombobox-&gt;set_model(m_refTypeList);
+	typeCombobox-&gt;pack_start(m_typeColumns.m_name);
+	// Populate
+	populate_typeCombobox(false);
 
-	if (selectTitle == false)
-	{
-		titleLabel-&gt;hide();
-		titleEntry-&gt;hide();
-	}
+	// The default type is not directory
+	// FIXME: this could also apply to URLs !
+	depthSpinbutton-&gt;set_sensitive(false);
+	depthSpinbutton-&gt;set_value(1);
 
-	if (selectDepth == false)
-	{
-		depthLabel-&gt;hide();
-		depthSpinbutton-&gt;hide();
-	}
-	else
-	{
-		// The default type is not directory
-		// FIXME: this could also apply to URLs !
-		depthSpinbutton-&gt;set_sensitive(false);
-		depthSpinbutton-&gt;set_value(m_maxDirLevel);
-	}
+	// Associate the columns model to the MIME types tree
+	m_refMimeTypeList = ListStore::create(m_mimeTypeColumns);
+	mimeTreeview-&gt;set_model(m_refMimeTypeList);
+	mimeTreeview-&gt;append_column_editable(_(&quot;Enabled&quot;), m_mimeTypeColumns.m_enabled);
+	mimeTreeview-&gt;append_column(_(&quot;MIME Type&quot;), m_mimeTypeColumns.m_type);
+	// Allow only single selection
+	mimeTreeview-&gt;get_selection()-&gt;set_mode(SELECTION_SINGLE);
+	// Populate
+	populate_mimeTreeview();
 
+	// Connect to threads' finished signal
+	m_state.connect();
+
 	// Disable this button as long the location entry field is empty
 	// The title field may remain empty
 	importButton-&gt;set_sensitive(false);
+	importProgressbar-&gt;set_pulse_step(0.10);
+	importProgressbar-&gt;set_text(_(&quot;Waiting...&quot;));
 }
 
 importDialog::~importDialog()
 {
 }
 
-void importDialog::populate_combobox(bool allowLocalOnly)
+void importDialog::populate_typeCombobox(bool localOnly)
 {
 	bool foundLanguage = false;
 
@@ -92,7 +137,7 @@
 	iter = m_refTypeList-&gt;append();
 	row = *iter;
 	row[m_typeColumns.m_name] = _(&quot;Whole directory&quot;);
-	if (allowLocalOnly == false)
+	if (localOnly == false)
 	{
 		iter = m_refTypeList-&gt;append();
 		row = *iter;
@@ -102,113 +147,179 @@
 	typeCombobox-&gt;set_active(0);
 }
 
-void importDialog::scan_file(const string &amp;fileName, unsigned int &amp;level)
+void importDialog::populate_mimeTreeview(void)
 {
-	struct stat fileStat;
-	Url urlObj(&quot;<A HREF="file://">file://</A>&quot; + fileName);
+	// Add all MIME types
+	for (set&lt;string&gt;::const_iterator typeIter = m_mimeTypes.begin();
+		typeIter != m_mimeTypes.end(); ++typeIter)
+	{
+		TreeModel::iterator iter = m_refMimeTypeList-&gt;append();
+		TreeModel::Row row = *iter;
 
-	if ((fileName.empty() == true) ||
-		(urlObj.getFile() == &quot;.&quot;) ||
-		(urlObj.getFile() == &quot;..&quot;))
-	{
-		return;
+		row[m_mimeTypeColumns.m_enabled] = true;
+		row[m_mimeTypeColumns.m_type] = to_utf8(*typeIter);
 	}
+}
 
-	// Skip dotfiles
-	if (urlObj.getFile()[0] == '.')
+bool importDialog::start_thread(WorkerThread *pNewThread)
+{
+	if (m_state.start_thread(pNewThread, false) == false)
 	{
-		return;
+		// Delete the object
+		delete pNewThread;
+		return false;
 	}
-
 #ifdef DEBUG
-	cout &lt;&lt; &quot;importDialog::scan_file: &quot; &lt;&lt; fileName &lt;&lt; endl;
+	cout &lt;&lt; &quot;importDialog::start_thread: started thread &quot; &lt;&lt; pNewThread-&gt;getId() &lt;&lt; endl;
 #endif
-	if (lstat(fileName.c_str(), &amp;fileStat) == -1)
+
+	return true;
+}
+
+bool importDialog::on_import_file(const string &amp;fileName)
+{
+	string mimeType = MIMEScanner::scanFile(fileName);
+	bool askForAnotherFile = false;
+
+	// Check the MIME type
+	if ((m_mimeTypesBlackList.find(mimeType) != m_mimeTypesBlackList.end()) ||
+		((m_mimeTypes.find(mimeType) == m_mimeTypes.end()) &amp;&amp;
+		(strncasecmp(mimeType.c_str(), &quot;text&quot;, 4) != 0)))
 	{
 #ifdef DEBUG
-		cout &lt;&lt; &quot;importDialog::scan_file: stat failed&quot; &lt;&lt; endl;
+		cout &lt;&lt; &quot;importDialog::on_import_file: filtering out type &quot; &lt;&lt; mimeType &lt;&lt; endl;
 #endif
-		return;
+		// It's black-listed, or not authorized and not text
+		askForAnotherFile = true;
 	}
+	else
+	{
+		XapianIndex index(PinotSettings::getInstance().m_indexLocation);
+		IndexingThread *pThread = NULL;
+		string url(&quot;<A HREF="file://">file://</A>&quot; + fileName);
+		string title = locale_from_utf8(m_title);
+		unsigned int docId = 0;
 
-	// Is it a file or a directory ?
-	if (S_ISLNK(fileStat.st_mode))
-	{
-		cout &lt;&lt; &quot;importDialog::scan_file: skipping symlink&quot; &lt;&lt; endl;
-		return;
-	}
-	else if (S_ISDIR(fileStat.st_mode))
-	{
-		// A directory : scan it
-		DIR *pDir = opendir(fileName.c_str());
-		if (pDir == NULL)
+		importProgressbar-&gt;pulse();
+		importProgressbar-&gt;set_text(to_utf8(fileName));
+
+		if (index.isGood() == true)
 		{
-			return;
+			docId = index.hasDocument(url);
 		}
 
-		// Iterate through this directory's entries
-		struct dirent *pDirEntry = readdir(pDir);
-		while (pDirEntry != NULL)
+		if (m_importDirectory == true)
 		{
-			char *pEntryName = pDirEntry-&gt;d_name;
-			if (pEntryName != NULL)
+			Url urlObj(url);
+
+			if (title.empty() == false)
 			{
-				string location = fileName;
-				if (fileName[fileName.length() - 1] != '/')
-				{
-					location += &quot;/&quot;;
-				}
-				location += pEntryName;
+				title += &quot; &quot;;
+			}
+			title += urlObj.getFile();
+		}
+		DocumentInfo docInfo(title, url, mimeType, &quot;&quot;);
 
-				// Scan this entry
-				if ((m_maxDirLevel == 0) ||
-					(level &lt; m_maxDirLevel))
-				{
-					++level;
-					scan_file(location, level);
-					--level;
-				}
+		if (docId &gt; 0)
+		{
+			// This document needs updating
+			index.getDocumentInfo(docId, docInfo);
+			pThread = new IndexingThread(docInfo, docId);
+		}
+		else
+		{
+			pThread = new IndexingThread(docInfo, &quot;&quot;);
+		}
+
+		// Launch the new thread
+		start_thread(pThread);
+	}
+
+	return askForAnotherFile;
+}
+
+void importDialog::on_thread_end()
+{
+	ustring status;
+
+	WorkerThread *pThread = m_state.on_thread_end();
+	if (pThread == NULL)
+	{
+		// It's likely to be a thread that was started by the main window
 #ifdef DEBUG
-				else cout &lt;&lt; &quot;importDialog::scan_file: not going deeper than level &quot; &lt;&lt; level &lt;&lt; endl;
+		cout &lt;&lt; &quot;importDialog::on_thread_end: foreign thread&quot; &lt;&lt; endl;
 #endif
-			}
+		return;
+	}
 
-			// Next entry
-			pDirEntry = readdir(pDir);
-		}
-		closedir(pDir);
+	// Any thread still running ?
+	if (m_state.has_threads() == false)
+	{
+#ifdef DEBUG
+		cout &lt;&lt; &quot;importDialog::on_thread_end: imported all&quot; &lt;&lt; endl;
+#endif
+		m_state.m_importing = false;
 	}
-	else if (S_ISREG(fileStat.st_mode))
+
+	// What type of thread was it ?
+	string type = pThread-&gt;getType();
+	if (type == &quot;IndexingThread&quot;)
 	{
-		// Build a valid URL
-		string location = &quot;<A HREF="file://">file://</A>&quot;;
-		location += fileName;
-		string title = locale_from_utf8(m_title);
+		// Did it succeed ?
+		if (pThread-&gt;getStatus().empty() == true)
+		{
+			// Yes, it did
+			++m_docsCount;
+		}
 
-		if (m_importDirectory == true)
+		if (m_state.m_importing == true)
 		{
-			title += &quot; &quot;;
-			title += urlObj.getFile();
+			// Ask the scanner for another file
+			pthread_mutex_lock(&amp;m_state.m_scanMutex);
+			pthread_cond_signal(&amp;m_state.m_scanCondVar);
+			pthread_mutex_unlock(&amp;m_state.m_scanMutex);
+#ifdef DEBUG
+			cout &lt;&lt; &quot;importDialog::on_thread_end: signaled DirectoryScannerThread&quot; &lt;&lt; endl;
+#endif
 		}
+	}
 
-		DocumentInfo docInfo(title, location,
-			MIMEScanner::scanFile(fileName), &quot;&quot;);
+	// Delete the thread
+	delete pThread;
 
-		import_file(urlObj.getFile(), docInfo);
+	do
+	{
+#ifdef DEBUG
+		cout &lt;&lt; &quot;importDialog::on_thread_end: UI event&quot; &lt;&lt; endl;
+#endif
+		Main::iteration(false);
+	} while(Main::events_pending() == true);
+
+	if (m_state.m_importing == false)
+	{
+		importProgressbar-&gt;set_text(_(&quot;Done&quot;));
+		importProgressbar-&gt;set_fraction(1.0);
+		importButton-&gt;set_sensitive(true);
 	}
 }
 
-void importDialog::import_file(const string &amp;fileName,
-	const DocumentInfo &amp;docInfo)
+void importDialog::setHeight(int maxHeight)
 {
-	// Fire up the signal
-	m_signalImportFile(docInfo);
-	++m_docsCount;
-}
+	// FIXME: there must be a better way to determine how high the tree should be
+	// for all rows to be visible !
+	int rowsCount = m_refTypeList-&gt;children().size();
+	// By default, the tree is high enough for one row
+	if (rowsCount &gt; 1)
+	{
+		int width, height;
 
-ustring importDialog::getDocumentTitle(void)
-{
-	return m_title;
+		// What's the current size ?
+		get_size(width, height);
+		// Add enough room for the rows we need to show
+		height += get_column_height(mimeTreeview) * (rowsCount - 1);
+		// Resize
+		resize(width, min(maxHeight, height));
+	}
 }
 
 unsigned int importDialog::getDocumentsCount(void)
@@ -216,125 +327,166 @@
 	return m_docsCount;
 }
 
-Signal1&lt;void, DocumentInfo&gt; &amp;importDialog::getImportFileSignal(void)
+void importDialog::on_typeCombobox_changed()
 {
-	return m_signalImportFile;
+	unsigned int type = typeCombobox-&gt;get_active_row_number();
+	bool selectLocation = true;
+
+	m_importDirectory = false;
+	if (type == 1)
+	{
+		m_importDirectory = true;
+	}
+	else if (type &gt; 1)
+	{
+		// Disable the select button only if type is URL
+		selectLocation = false;
+	}
+
+	// See whether import should be enabled
+	on_locationEntry_changed();
+
+	// FIXME: this could also apply to URLs !
+	depthSpinbutton-&gt;set_sensitive(m_importDirectory);
+	locationButton-&gt;set_sensitive(selectLocation);
 }
 
-void importDialog::on_importButton_clicked()
+void importDialog::on_locationEntry_changed()
 {
-	string location = locale_from_utf8(locationEntry-&gt;get_text());
-	unsigned int level = 0;
+	ustring fileName = locationEntry-&gt;get_text();
+	bool enableImport = true;
 
-	importButton-&gt;set_sensitive(false);
+	if (fileName.empty() == false)
+	{
+		unsigned int type = typeCombobox-&gt;get_active_row_number();
 
-	// Title
-	m_title = titleEntry-&gt;get_text();
-	// Type
-	if (typeCombobox-&gt;get_active_row_number() &lt;= 1)
-	{
-		string::size_type pos = location.find_last_of(&quot;/&quot;);
-		if (pos != string::npos)
+		// Check the entry makes sense
+		if (type &lt;= 1)
 		{
-			// Update m_directory
-			m_directory = location.substr(0, pos + 1);
-#ifdef DEBUG
-			cout &lt;&lt; &quot;importDialog::on_importButton_clicked: directory now &quot; &lt;&lt; m_directory &lt;&lt; endl;
-#endif
+			if (fileName[0] != '/')
+			{
+				enableImport = false;
+			}
 		}
+		else
+		{
+			Url urlObj(locale_from_utf8(fileName));
 
-		// Maximum depth
-		m_maxDirLevel = (unsigned int)depthSpinbutton-&gt;get_value();
-
-		scan_file(location, level);
+			// Check the URL is valid
+			if (urlObj.getProtocol().empty() == true)
+			{
+				enableImport = false;
+			}
+			// FIXME: be more thorough
+		}
 	}
 	else
 	{
-		Url urlObj(location);
-		DocumentInfo docInfo(locale_from_utf8(m_title), location,
-			MIMEScanner::scanUrl(urlObj), &quot;&quot;);
+		enableImport = false;
+	}
 
-		import_file(urlObj.getFile(), docInfo);
+	// Keep the button disabled as lon as we are importing
+	if (m_state.m_importing == true)
+	{
+		enableImport = false;
 	}
+	importButton-&gt;set_sensitive(enableImport);
 }
 
-void importDialog::on_selectButton_clicked()
+void importDialog::on_locationButton_clicked()
 {
-	ustring fileName = to_utf8(m_directory);
+	ustring fileName = to_utf8(m_state.m_defaultDirectory);
 
 	if (select_file_name(*this, _(&quot;Document To Import&quot;), fileName, true, m_importDirectory) == true)
 	{
 		// Update the location
 #ifdef DEBUG
-		cout &lt;&lt; &quot;importDialog::on_selectButton_clicked: location is &quot; &lt;&lt; fileName &lt;&lt; endl;
+		cout &lt;&lt; &quot;importDialog::on_locationButton_clicked: location is &quot; &lt;&lt; fileName &lt;&lt; endl;
 #endif
 		locationEntry-&gt;set_text(fileName);
 		ustring::size_type pos = fileName.find_last_of(&quot;/&quot;);
 		if (pos != string::npos)
 		{
-			// Update m_directory
-			m_directory = locale_from_utf8(fileName.substr(0, pos + 1));
+			// Update the default directory
+			m_state.m_defaultDirectory = locale_from_utf8(fileName.substr(0, pos + 1));
 #ifdef DEBUG
-			cout &lt;&lt; &quot;importDialog::on_selectButton_clicked: directory now &quot; &lt;&lt; m_directory &lt;&lt; endl;
+			cout &lt;&lt; &quot;importDialog::on_locationButton_clicked: directory now &quot;
+				&lt;&lt; m_state.m_defaultDirectory &lt;&lt; endl;
 #endif
 		}
 	}
 }
 
-void importDialog::on_locationEntry_changed()
+void importDialog::on_importButton_clicked()
 {
-	ustring fileName = locationEntry-&gt;get_text();
-	bool enableOk = true;
+	string location = locale_from_utf8(locationEntry-&gt;get_text());
+	unsigned int level = 0;
 
-	if (fileName.empty() == false)
+	// Rudimentary lock
+	if (m_state.m_importing == true)
 	{
-		unsigned int type = typeCombobox-&gt;get_active_row_number();
+		return;
+	}
+	m_state.m_importing = true;
 
-		// Check the entry makes sense
-		if (type &lt;= 1)
+	importProgressbar-&gt;set_fraction(0.0);
+	// Disable the import button
+	importButton-&gt;set_sensitive(false);
+
+	// Update the list of MIME types, based on list selection
+	m_mimeTypes.clear();
+	m_mimeTypesBlackList.clear();
+	TreeModel::Children children = m_refMimeTypeList-&gt;children();
+	if (children.empty() == false)
+	{
+		for (TreeModel::Children::iterator iter = children.begin();
+			iter != children.end(); ++iter)
 		{
-			if (fileName[0] != '/')
+			TreeModel::Row row = *iter;
+			string mimeType(locale_from_utf8(row[m_mimeTypeColumns.m_type]));
+			bool enabled = row[m_mimeTypeColumns.m_enabled];
+
+			if (enabled == true)
 			{
-				enableOk = false;
+				m_mimeTypes.insert(mimeType);
 			}
-		}
-		else
-		{
-			Url urlObj(locale_from_utf8(fileName));
-
-			// Check the URL is valid
-			if (urlObj.getProtocol().empty() == true)
+			else
 			{
-				enableOk = false;
+				m_mimeTypesBlackList.insert(mimeType);
 			}
-			// FIXME: be more thorough
 		}
 	}
+#ifdef DEBUG
+	cout &lt;&lt; &quot;importDialog::on_importButton_clicked: &quot; &lt;&lt; m_mimeTypes.size()
+		&lt;&lt; &quot; types, &quot; &lt;&lt; m_mimeTypesBlackList.size() &lt;&lt; &quot; in blacklist&quot; &lt;&lt; endl;
+#endif
+
+	// Title
+	m_title = titleEntry-&gt;get_text();
+	// Type
+	if (typeCombobox-&gt;get_active_row_number() &lt;= 1)
+	{
+		// Maximum depth
+		unsigned int maxDirLevel = (unsigned int)depthSpinbutton-&gt;get_value();
+
+		// Scan the directory and import all its files
+		DirectoryScannerThread *pThread = new DirectoryScannerThread(location,
+			maxDirLevel, &amp;m_state.m_scanMutex, &amp;m_state.m_scanCondVar);
+		pThread-&gt;getFileFoundSignal().connect(SigC::slot(*this, &amp;importDialog::on_import_file));
+		start_thread(pThread);
+	}
 	else
 	{
-		enableOk = false;
+		on_import_file(location);
 	}
-
-	importButton-&gt;set_sensitive(enableOk);
+#ifdef DEBUG
+	cout &lt;&lt; &quot;importDialog::on_importButton_clicked: done&quot; &lt;&lt; endl;
+#endif
 }
 
-void importDialog::on_typeCombobox_changed()
+void importDialog::on_importDialog_response(int response_id)
 {
-	unsigned int type = typeCombobox-&gt;get_active_row_number();
-	bool selectLocation = true;
-
-	m_importDirectory = false;
-	if (type == 1)
-	{
-		m_importDirectory = true;
-	}
-	else if (type &gt; 1)
-	{
-		// Disable the select button only if type is URL
-		selectLocation = false;
-	}
-
-	// FIXME: this could also apply to URLs !
-	depthSpinbutton-&gt;set_sensitive(m_importDirectory);
-	selectButton-&gt;set_sensitive(selectLocation);
+	// Closing the window should stop everything
+	m_state.stop_threads();
+	m_state.disconnect();
 }

Modified: trunk/UI/GTK2/src/importDialog.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/importDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,19 +1,25 @@
-// generated 2004/3/6 14:15:21 GMT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to importDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _IMPORTDIALOG_HH
 #define _IMPORTDIALOG_HH
 
 #include &lt;string&gt;
-#include &lt;vector&gt;
+#include &lt;set&gt;
+#include &lt;pthread.h&gt;
 #include &lt;sigc++/slot.h&gt;
 #include &lt;glibmm/refptr.h&gt;
 #include &lt;glibmm/ustring.h&gt;
@@ -22,6 +28,7 @@
 
 #include &quot;DocumentInfo.h&quot;
 #include &quot;ModelColumns.h&quot;
+#include &quot;WorkerThreads.h&quot;
 #include &quot;importDialog_glade.hh&quot;
 
 class importDialog : public importDialog_glade
@@ -29,37 +36,57 @@
 public:
 	/// Open the dialog box in import mode.
 	importDialog(const Glib::ustring &amp;title,
-		bool selectTitle = true, bool selectDepth = true,
-		bool allowLocalOnly = false);
+		const std::set&lt;std::string&gt; &amp;mimeTypes);
 	virtual ~importDialog();
 
-	Glib::ustring getDocumentTitle(void);
+	void setHeight(int maxHeight);
 
 	unsigned int getDocumentsCount(void);
 
-	/// Returns the import file signal.
-	SigC::Signal1&lt;void, DocumentInfo&gt;&amp; getImportFileSignal(void);
-
 protected:
-	void populate_combobox(bool allowLocalOnly);
-	void scan_file(const std::string &amp;fileName, unsigned int &amp;level);
-	void import_file(const std::string &amp;fileName,
-		const DocumentInfo &amp;docInfo);
+	void populate_typeCombobox(bool localOnly);
+	void populate_mimeTreeview(void);
+	bool start_thread(WorkerThread *pNewThread);
 
+	bool on_import_file(const std::string &amp;fileName);
+	void on_thread_end(void);
+
 private:
+	std::set&lt;std::string&gt; m_mimeTypes;
+	std::set&lt;std::string&gt; m_mimeTypesBlackList;
 	ComboModelColumns m_typeColumns;
 	Glib::RefPtr&lt;Gtk::ListStore&gt; m_refTypeList;
 	Glib::ustring m_title;
 	unsigned int m_docsCount;
 	bool m_importDirectory;
-	unsigned int m_maxDirLevel;
-	SigC::Signal1&lt;void, DocumentInfo&gt; m_signalImportFile;
-	static std::string m_directory;
+	TypeModelColumns m_mimeTypeColumns;
+	Glib::RefPtr&lt;Gtk::ListStore&gt; m_refMimeTypeList;
+	// Internal state
+	class InternalState : public ThreadsManager
+	{
+		public:
+			InternalState(importDialog *pWindow);
+			~InternalState();
 
+			void connect(void);
+
+			// Directory scanning
+			bool m_importing;
+			pthread_mutex_t m_scanMutex;
+			pthread_cond_t m_scanCondVar;
+			// The default directory
+			static std::string m_defaultDirectory;
+
+		protected:
+			importDialog *m_pImportWindow;
+
+	} m_state;
+
+	virtual void on_typeCombobox_changed();
+	virtual void on_locationEntry_changed();
+	virtual void on_locationButton_clicked();
 	virtual void on_importButton_clicked();
-	virtual void on_selectButton_clicked();
-	virtual void on_locationEntry_changed();
-	virtual void on_typeCombobox_changed();
+	virtual void on_importDialog_response(int response_id);
 
 };
 

Modified: trunk/UI/GTK2/src/importDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/importDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2006/1/2 11:20:27 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at thorgrim.dyndns.org.</A>(none)
+// generated 2006/1/10 13:41:10 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -46,11 +46,12 @@
 #include &lt;gtkmm/accelgroup.h&gt;
 #include &lt;gtkmm/button.h&gt;
 #include &lt;gtkmm/buttonbox.h&gt;
-#include &lt;gtkmm/image.h&gt;
 #include &lt;gtkmm/label.h&gt;
 #include &lt;gtkmm/box.h&gt;
+#include &lt;gtkmm/adjustment.h&gt;
+#include &lt;gtkmm/scrolledwindow.h&gt;
+#include &lt;gtkmm/image.h&gt;
 #include &lt;gtkmm/alignment.h&gt;
-#include &lt;gtkmm/adjustment.h&gt;
 
 importDialog_glade::importDialog_glade(
 )
@@ -58,62 +59,46 @@
    
    Gtk::Dialog *importDialog = this;
    gmm_data = new GlademmData(get_accel_group());
-   importButton = Gtk::manage(new class Gtk::Button(_(&quot;Import&quot;)));
    
    Gtk::Button *closeButton = Gtk::manage(new class Gtk::Button(Gtk::StockID(&quot;gtk-close&quot;)));
-   Gtk::Image *image551 = Gtk::manage(new class Gtk::Image(Gtk::StockID(&quot;gtk-open&quot;), Gtk::IconSize(4)));
-   Gtk::Label *label50 = Gtk::manage(new class Gtk::Label(_(&quot;Select&quot;)));
-   Gtk::HBox *hbox43 = Gtk::manage(new class Gtk::HBox(false, 2));
-   Gtk::Alignment *alignment29 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
-   selectButton = Gtk::manage(new class Gtk::Button());
-   
-   Gtk::HButtonBox *hbuttonbox4 = Gtk::manage(new class Gtk::HButtonBox(Gtk::BUTTONBOX_DEFAULT_STYLE, 0));
-   locationEntry = Gtk::manage(new class Gtk::Entry());
    titleEntry = Gtk::manage(new class Gtk::Entry());
    
    Gtk::Label *locationLabel = Gtk::manage(new class Gtk::Label(_(&quot;Location:&quot;)));
    titleLabel = Gtk::manage(new class Gtk::Label(_(&quot;Title:&quot;)));
-   depthLabel = Gtk::manage(new class Gtk::Label(_(&quot;Maximum depth:&quot;)));
+   typeCombobox = Gtk::manage(new class Gtk::ComboBox());
    
+   Gtk::Label *typeLabel = Gtk::manage(new class Gtk::Label(_(&quot;Type:&quot;)));
+   locationEntry = Gtk::manage(new class Gtk::Entry());
+   locationButton = Gtk::manage(new class Gtk::Button(_(&quot;...&quot;)));
+   
+   Gtk::HBox *locationHbox = Gtk::manage(new class Gtk::HBox(false, 4));
+   depthLabel = Gtk::manage(new class Gtk::Label(_(&quot;Depth:&quot;)));
+   
    Gtk::Adjustment *depthSpinbutton_adj = Gtk::manage(new class Gtk::Adjustment(0, 0, 100, 1, 5, 5));
    depthSpinbutton = Gtk::manage(new class Gtk::SpinButton(*depthSpinbutton_adj, 1, 0));
-   typeCombobox = Gtk::manage(new class Gtk::ComboBox());
+   docTable = Gtk::manage(new class Gtk::Table(2, 2, false));
+   mimeTreeview = Gtk::manage(new class Gtk::TreeView());
    
-   Gtk::Label *typeLabel = Gtk::manage(new class Gtk::Label(_(&quot;Type:&quot;)));
-   docTable = Gtk::manage(new class Gtk::Table(2, 2, false));
-   importButton-&gt;set_flags(Gtk::CAN_FOCUS);
-   importButton-&gt;set_flags(Gtk::CAN_DEFAULT);
-   importButton-&gt;set_relief(Gtk::RELIEF_NORMAL);
+   Gtk::ScrolledWindow *mimeScrolledwindow = Gtk::manage(new class Gtk::ScrolledWindow());
+   importProgressbar = Gtk::manage(new class Gtk::ProgressBar());
+   
+   Gtk::Image *image575 = Gtk::manage(new class Gtk::Image(Gtk::StockID(&quot;gtk-open&quot;), Gtk::IconSize(4)));
+   Gtk::Label *label55 = Gtk::manage(new class Gtk::Label(_(&quot;Import&quot;)));
+   Gtk::HBox *hbox52 = Gtk::manage(new class Gtk::HBox(false, 2));
+   Gtk::Alignment *alignment34 = Gtk::manage(new class Gtk::Alignment(0.5, 0.5, 0, 0));
+   importButton = Gtk::manage(new class Gtk::Button());
+   
+   Gtk::HBox *importHbox = Gtk::manage(new class Gtk::HBox(false, 4));
+   Gtk::VBox *importVbox = Gtk::manage(new class Gtk::VBox(false, 0));
    closeButton-&gt;set_flags(Gtk::CAN_FOCUS);
    closeButton-&gt;set_flags(Gtk::CAN_DEFAULT);
    closeButton-&gt;set_relief(Gtk::RELIEF_NORMAL);
    importDialog-&gt;get_action_area()-&gt;property_layout_style().set_value(Gtk::BUTTONBOX_END);
-   image551-&gt;set_alignment(0.5,0.5);
-   image551-&gt;set_padding(0,0);
-   label50-&gt;set_alignment(0.5,0.5);
-   label50-&gt;set_padding(0,0);
-   label50-&gt;set_justify(Gtk::JUSTIFY_LEFT);
-   label50-&gt;set_line_wrap(false);
-   label50-&gt;set_use_markup(false);
-   label50-&gt;set_selectable(false);
-   hbox43-&gt;pack_start(*image551, Gtk::PACK_SHRINK, 0);
-   hbox43-&gt;pack_start(*label50, Gtk::PACK_SHRINK, 0);
-   alignment29-&gt;add(*hbox43);
-   selectButton-&gt;set_flags(Gtk::CAN_FOCUS);
-   selectButton-&gt;set_flags(Gtk::CAN_DEFAULT);
-   selectButton-&gt;set_relief(Gtk::RELIEF_NORMAL);
-   selectButton-&gt;add(*alignment29);
-   hbuttonbox4-&gt;pack_start(*selectButton);
-   locationEntry-&gt;set_flags(Gtk::CAN_FOCUS);
-   locationEntry-&gt;set_visibility(true);
-   locationEntry-&gt;set_editable(true);
-   locationEntry-&gt;set_max_length(0);
-   locationEntry-&gt;set_has_frame(true);
-   locationEntry-&gt;set_activates_default(false);
    titleEntry-&gt;set_flags(Gtk::CAN_FOCUS);
    titleEntry-&gt;set_visibility(true);
    titleEntry-&gt;set_editable(true);
    titleEntry-&gt;set_max_length(0);
+   titleEntry-&gt;set_text(_(&quot;&quot;));
    titleEntry-&gt;set_has_frame(true);
    titleEntry-&gt;set_activates_default(false);
    locationLabel-&gt;set_alignment(0,0.5);
@@ -128,6 +113,24 @@
    titleLabel-&gt;set_line_wrap(false);
    titleLabel-&gt;set_use_markup(false);
    titleLabel-&gt;set_selectable(false);
+   typeLabel-&gt;set_alignment(0,0.5);
+   typeLabel-&gt;set_padding(4,4);
+   typeLabel-&gt;set_justify(Gtk::JUSTIFY_LEFT);
+   typeLabel-&gt;set_line_wrap(false);
+   typeLabel-&gt;set_use_markup(false);
+   typeLabel-&gt;set_selectable(false);
+   locationEntry-&gt;set_flags(Gtk::CAN_FOCUS);
+   locationEntry-&gt;set_visibility(true);
+   locationEntry-&gt;set_editable(true);
+   locationEntry-&gt;set_max_length(0);
+   locationEntry-&gt;set_text(_(&quot;&quot;));
+   locationEntry-&gt;set_has_frame(true);
+   locationEntry-&gt;set_activates_default(false);
+   locationButton-&gt;set_flags(Gtk::CAN_FOCUS);
+   locationButton-&gt;set_flags(Gtk::CAN_DEFAULT);
+   locationButton-&gt;set_relief(Gtk::RELIEF_NORMAL);
+   locationHbox-&gt;pack_start(*locationEntry);
+   locationHbox-&gt;pack_start(*locationButton, Gtk::PACK_SHRINK, 0);
    depthLabel-&gt;set_alignment(0,0.5);
    depthLabel-&gt;set_padding(4,4);
    depthLabel-&gt;set_justify(Gtk::JUSTIFY_LEFT);
@@ -139,56 +142,83 @@
    depthSpinbutton-&gt;set_numeric(false);
    depthSpinbutton-&gt;set_digits(0);
    depthSpinbutton-&gt;set_wrap(false);
-   typeLabel-&gt;set_alignment(0,0.5);
-   typeLabel-&gt;set_padding(4,4);
-   typeLabel-&gt;set_justify(Gtk::JUSTIFY_LEFT);
-   typeLabel-&gt;set_line_wrap(false);
-   typeLabel-&gt;set_use_markup(false);
-   typeLabel-&gt;set_selectable(false);
    docTable-&gt;set_row_spacings(0);
    docTable-&gt;set_col_spacings(0);
-   docTable-&gt;attach(*hbuttonbox4, 2, 3, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   docTable-&gt;attach(*locationEntry, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable-&gt;attach(*titleEntry, 1, 2, 1, 2, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
-   docTable-&gt;attach(*locationLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::FILL, 0, 0);
+   docTable-&gt;attach(*locationLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::FILL, 0, 0);
    docTable-&gt;attach(*titleLabel, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL, 0, 0);
-   docTable-&gt;attach(*depthLabel, 0, 1, 2, 3, Gtk::FILL, Gtk::AttachOptions(), 0, 0);
-   docTable-&gt;attach(*depthSpinbutton, 1, 2, 2, 3, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable-&gt;attach(*typeCombobox, 1, 2, 0, 1, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
    docTable-&gt;attach(*typeLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 0, 0);
+   docTable-&gt;attach(*locationHbox, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL, 4, 4);
+   docTable-&gt;attach(*depthLabel, 0, 1, 3, 4, Gtk::FILL, Gtk::AttachOptions(), 0, 0);
+   docTable-&gt;attach(*depthSpinbutton, 1, 2, 3, 4, Gtk::EXPAND|Gtk::FILL, Gtk::FILL, 4, 4);
+   mimeTreeview-&gt;set_flags(Gtk::CAN_FOCUS);
+   mimeTreeview-&gt;set_headers_visible(true);
+   mimeTreeview-&gt;set_rules_hint(false);
+   mimeTreeview-&gt;set_reorderable(false);
+   mimeTreeview-&gt;set_enable_search(true);
+   mimeScrolledwindow-&gt;set_flags(Gtk::CAN_FOCUS);
+   mimeScrolledwindow-&gt;set_shadow_type(Gtk::SHADOW_IN);
+   mimeScrolledwindow-&gt;set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_AUTOMATIC);
+   mimeScrolledwindow-&gt;property_window_placement().set_value(Gtk::CORNER_TOP_LEFT);
+   mimeScrolledwindow-&gt;add(*mimeTreeview);
+   image575-&gt;set_alignment(0.5,0.5);
+   image575-&gt;set_padding(0,0);
+   label55-&gt;set_alignment(0.5,0.5);
+   label55-&gt;set_padding(0,0);
+   label55-&gt;set_justify(Gtk::JUSTIFY_LEFT);
+   label55-&gt;set_line_wrap(false);
+   label55-&gt;set_use_markup(false);
+   label55-&gt;set_selectable(false);
+   hbox52-&gt;pack_start(*image575, Gtk::PACK_SHRINK, 0);
+   hbox52-&gt;pack_start(*label55, Gtk::PACK_SHRINK, 0);
+   alignment34-&gt;add(*hbox52);
+   importButton-&gt;set_flags(Gtk::CAN_FOCUS);
+   importButton-&gt;set_flags(Gtk::CAN_DEFAULT);
+   importButton-&gt;set_relief(Gtk::RELIEF_NORMAL);
+   importButton-&gt;add(*alignment34);
+   importHbox-&gt;pack_start(*importProgressbar);
+   importHbox-&gt;pack_start(*importButton, Gtk::PACK_SHRINK, 0);
+   importVbox-&gt;pack_start(*docTable, Gtk::PACK_SHRINK, 0);
+   importVbox-&gt;pack_start(*mimeScrolledwindow, Gtk::PACK_EXPAND_WIDGET, 4);
+   importVbox-&gt;pack_start(*importHbox, Gtk::PACK_SHRINK, 0);
    importDialog-&gt;get_vbox()-&gt;set_homogeneous(false);
    importDialog-&gt;get_vbox()-&gt;set_spacing(0);
-   importDialog-&gt;get_vbox()-&gt;pack_start(*docTable);
+   importDialog-&gt;get_vbox()-&gt;pack_start(*importVbox);
    importDialog-&gt;set_title(_(&quot;Import document&quot;));
    importDialog-&gt;set_modal(false);
    importDialog-&gt;property_window_position().set_value(Gtk::WIN_POS_NONE);
    importDialog-&gt;set_resizable(true);
    importDialog-&gt;property_destroy_with_parent().set_value(false);
    importDialog-&gt;set_has_separator(true);
-   importDialog-&gt;add_action_widget(*importButton, 0);
-   importDialog-&gt;add_action_widget(*closeButton, -7);
-   importButton-&gt;show();
+   importDialog-&gt;add_action_widget(*closeButton, -5);
    closeButton-&gt;show();
-   image551-&gt;show();
-   label50-&gt;show();
-   hbox43-&gt;show();
-   alignment29-&gt;show();
-   selectButton-&gt;show();
-   hbuttonbox4-&gt;show();
-   locationEntry-&gt;show();
    titleEntry-&gt;show();
    locationLabel-&gt;show();
    titleLabel-&gt;show();
+   typeCombobox-&gt;show();
+   typeLabel-&gt;show();
+   locationEntry-&gt;show();
+   locationButton-&gt;show();
+   locationHbox-&gt;show();
    depthLabel-&gt;show();
    depthSpinbutton-&gt;show();
-   typeCombobox-&gt;show();
-   typeLabel-&gt;show();
    docTable-&gt;show();
-   importDialog-&gt;show();
+   mimeTreeview-&gt;show();
+   mimeScrolledwindow-&gt;show();
+   importProgressbar-&gt;show();
+   image575-&gt;show();
+   label55-&gt;show();
+   hbox52-&gt;show();
+   alignment34-&gt;show();
+   importButton-&gt;show();
+   importHbox-&gt;show();
+   importVbox-&gt;show();
+   typeCombobox-&gt;signal_changed().connect(SigC::slot(*this, &amp;importDialog_glade::on_typeCombobox_changed), false);
+   locationEntry-&gt;signal_changed().connect(SigC::slot(*this, &amp;importDialog_glade::on_locationEntry_changed), false);
+   locationButton-&gt;signal_clicked().connect(SigC::slot(*this, &amp;importDialog_glade::on_locationButton_clicked), false);
    importButton-&gt;signal_clicked().connect(SigC::slot(*this, &amp;importDialog_glade::on_importButton_clicked), false);
-   selectButton-&gt;signal_clicked().connect(SigC::slot(*this, &amp;importDialog_glade::on_selectButton_clicked), false);
-   locationEntry-&gt;signal_changed().connect(SigC::slot(*this, &amp;importDialog_glade::on_locationEntry_changed), false);
-   typeCombobox-&gt;signal_changed().connect(SigC::slot(*this, &amp;importDialog_glade::on_typeCombobox_changed), false);
+   importDialog-&gt;signal_response().connect(SigC::slot(*this, &amp;importDialog_glade::on_importDialog_response), false);
 }
 
 importDialog_glade::~importDialog_glade()

Modified: trunk/UI/GTK2/src/importDialog_glade.hh
===================================================================
--- trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/importDialog_glade.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2006/1/2 11:20:27 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at thorgrim.dyndns.org.</A>(none)
+// generated 2006/1/10 13:34:08 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -32,35 +32,40 @@
 #endif //GLADEMM_DATA
 
 #include &lt;gtkmm/dialog.h&gt;
-#include &lt;gtkmm/button.h&gt;
 #include &lt;gtkmm/entry.h&gt;
 #include &lt;gtkmm/label.h&gt;
+#include &lt;gtkmm/combobox.h&gt;
+#include &lt;gtkmm/button.h&gt;
 #include &lt;gtkmm/spinbutton.h&gt;
-#include &lt;gtkmm/combobox.h&gt;
 #include &lt;gtkmm/table.h&gt;
+#include &lt;gtkmm/treeview.h&gt;
+#include &lt;gtkmm/progressbar.h&gt;
 
 class importDialog_glade : public Gtk::Dialog
 {  
         
         GlademmData *gmm_data;
 protected:
-        class Gtk::Button * importButton;
-        class Gtk::Button * selectButton;
-        class Gtk::Entry * locationEntry;
         class Gtk::Entry * titleEntry;
         class Gtk::Label * titleLabel;
+        class Gtk::ComboBox * typeCombobox;
+        class Gtk::Entry * locationEntry;
+        class Gtk::Button * locationButton;
         class Gtk::Label * depthLabel;
         class Gtk::SpinButton * depthSpinbutton;
-        class Gtk::ComboBox * typeCombobox;
         class Gtk::Table * docTable;
+        class Gtk::TreeView * mimeTreeview;
+        class Gtk::ProgressBar * importProgressbar;
+        class Gtk::Button * importButton;
         
         importDialog_glade();
         
         ~importDialog_glade();
 private:
+        virtual void on_typeCombobox_changed() = 0;
+        virtual void on_locationEntry_changed() = 0;
+        virtual void on_locationButton_clicked() = 0;
         virtual void on_importButton_clicked() = 0;
-        virtual void on_selectButton_clicked() = 0;
-        virtual void on_locationEntry_changed() = 0;
-        virtual void on_typeCombobox_changed() = 0;
+        virtual void on_importDialog_response(int response_id) = 0;
 };
 #endif

Modified: trunk/UI/GTK2/src/indexDialog.cc
===================================================================
--- trunk/UI/GTK2/src/indexDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/indexDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,10 +1,19 @@
-// generated 2005/2/14 18:45:02 GMT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.6.0
-//
-// newer (non customized) versions of this file go to indexDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include &lt;iostream&gt;
 
 #include &quot;config.h&quot;

Modified: trunk/UI/GTK2/src/indexDialog.hh
===================================================================
--- trunk/UI/GTK2/src/indexDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/indexDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,19 @@
-// generated 2005/2/14 18:45:02 GMT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.6.0
-//
-// newer (non customized) versions of this file go to indexDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _INDEXDIALOG_HH
 #define _INDEXDIALOG_HH
 

Modified: trunk/UI/GTK2/src/indexDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/indexDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/indexDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,9 +1,9 @@
-// generated 2005/4/17 5:19:13 BST by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at thorgrim.dyndns.org.</A>(none)
+// generated 2006/1/5 9:17:19 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at thorgrim.dyndns.org.</A>(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
-// glade-- /home/fabrice/Projects/MetaSE/metase/UI/GTK2/metase-gtk2.glade
-// for gtk 2.4.0 and gtkmm 2.4.8
+// glade-- /home/fabrice/Projects/MetaSE/pinot/UI/GTK2/metase-gtk2.glade
+// for gtk 2.6.10 and gtkmm 2.6.2
 //
 // Please modify the corresponding derived classes in ./src/indexDialog.cc
 
@@ -63,7 +63,7 @@
    locationEntry = Gtk::manage(new class Gtk::Entry());
    locationButton = Gtk::manage(new class Gtk::Button(_(&quot;...&quot;)));
    
-   Gtk::HBox *locationHbox = Gtk::manage(new class Gtk::HBox(false, 0));
+   Gtk::HBox *locationHbox = Gtk::manage(new class Gtk::HBox(false, 4));
    Gtk::Label *typeLabel = Gtk::manage(new class Gtk::Label(_(&quot;Type:&quot;)));
    Gtk::Label *locationLabel = Gtk::manage(new class Gtk::Label(_(&quot;Location:&quot;)));
    Gtk::Label *portLabel = Gtk::manage(new class Gtk::Label(_(&quot;Port:&quot;)));
@@ -97,7 +97,7 @@
    locationButton-&gt;set_flags(Gtk::CAN_DEFAULT);
    locationButton-&gt;set_relief(Gtk::RELIEF_NORMAL);
    locationHbox-&gt;pack_start(*locationEntry);
-   locationHbox-&gt;pack_start(*locationButton, Gtk::PACK_SHRINK, 4);
+   locationHbox-&gt;pack_start(*locationButton, Gtk::PACK_SHRINK, 0);
    typeLabel-&gt;set_alignment(0,0.5);
    typeLabel-&gt;set_padding(4,4);
    typeLabel-&gt;set_justify(Gtk::JUSTIFY_LEFT);

Modified: trunk/UI/GTK2/src/mainWindow.cc
===================================================================
--- trunk/UI/GTK2/src/mainWindow.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/mainWindow.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -36,6 +36,7 @@
 #include &quot;IndexedDocument.h&quot;
 #include &quot;TimeConverter.h&quot;
 #include &quot;Url.h&quot;
+#include &quot;TokenizerFactory.h&quot;
 #include &quot;QueryHistory.h&quot;
 #include &quot;ViewHistory.h&quot;
 #include &quot;DownloaderFactory.h&quot;
@@ -58,69 +59,36 @@
 using namespace Gdk;
 using namespace Gtk;
 
-// A function object to delete pointers from a set with for_each()
-struct DeleteSetPointer
-{
-	template&lt;typename T&gt;
-	void operator()(const T *ptr) const
-	{
-		delete ptr;
-	}
-};
-
 // FIXME: this ought to be configurable
 unsigned int mainWindow::m_maxDocsCount = 100;
 unsigned int mainWindow::m_maxThreads = 2;
 
-mainWindow::InternalState::InternalState() :
+mainWindow::InternalState::InternalState(mainWindow *pWindow) :
+	ThreadsManager(),
 	m_liveQueryLength(0),
 	m_currentPage(0),
-	m_backgroundThreads(0),
-	m_browsingIndex(false)
+	m_browsingIndex(false),
+	m_pMainWindow(pWindow)
 {
-	pthread_rwlock_init(&amp;m_rwLock, NULL);
 }
 
 mainWindow::InternalState::~InternalState()
 {
-	// Destroy the read/write lock
-	pthread_rwlock_destroy(&amp;m_rwLock);
 }
 
-bool mainWindow::InternalState::readLock(unsigned int where)
+void mainWindow::InternalState::connect(void)
 {
-	if (pthread_rwlock_rdlock(&amp;m_rwLock) == 0)
+	if (m_pMainWindow != NULL)
 	{
+		// Connect the dispatcher
+		m_threadsEndConnection = WorkerThread::getDispatcher().connect(
+			SigC::slot(*m_pMainWindow, &amp;mainWindow::on_thread_end));
 #ifdef DEBUG
-		cout &lt;&lt; &quot;mainWindow::InternalState::readLock &quot; &lt;&lt; where &lt;&lt; endl;
+		cout &lt;&lt; &quot;mainWindow::InternalState::connect: connected&quot; &lt;&lt; endl;
 #endif
-		return true;
 	}
-
-	return false;
 }
 
-bool mainWindow::InternalState::writeLock(unsigned int where)
-{
-	if (pthread_rwlock_wrlock(&amp;m_rwLock) == 0)
-	{
-#ifdef DEBUG
-		cout &lt;&lt; &quot;mainWindow::InternalState::writeLock &quot; &lt;&lt; where &lt;&lt; endl;
-#endif
-		return true;
-	}
-
-	return false;
-}
-
-void mainWindow::InternalState::unlock(void)
-{
-#ifdef DEBUG
-	cout &lt;&lt; &quot;mainWindow::InternalState::unlock&quot; &lt;&lt; endl;
-#endif
-	pthread_rwlock_unlock(&amp;m_rwLock);
-}
-
 //
 // Constructor
 //
@@ -130,7 +98,8 @@
 	m_pNotebook(NULL),
 	m_pIndexMenu(NULL),
 	m_pLabelsMenu(NULL),
-	m_pHtmlView(NULL)
+	m_pHtmlView(NULL),
+	m_state(this)
 {
 	// Reposition and resize the window
 	// Make sure the coordinates and sizes make sense
@@ -243,8 +212,7 @@
 	m_tooltips.set_tip(*removeIndexButton, _(&quot;Remove index&quot;));
 
 	// Connect to threads' finished signal
-	m_threadsEndConnection = WorkerThread::getFinishedSignal().connect(
-		SigC::slot(*this, &amp;mainWindow::on_thread_end));
+	m_state.connect();
 
 	// FIXME: delete all &quot;ignored&quot; threads when exiting !!!
 	// Fire up a listener thread
@@ -277,11 +245,6 @@
 	// Save queries
 	save_queryTreeview();
 
-	if (m_state.m_pThreads.empty() == false)
-	{
-		for_each(m_state.m_pThreads.begin(), m_state.m_pThreads.end(), DeleteSetPointer());
-	}
-
 	// Stop in case we were loading a page
 	NotebookPageBox *pNotebookPage = get_page(_(&quot;View&quot;), NotebookPageBox::VIEW_PAGE);
 	if (pNotebookPage != NULL)
@@ -636,7 +599,7 @@
 			SigC::slot(*this, &amp;mainWindow::on_indexForwardButton_clicked));
 
 		// Append the page
-		if (m_state.writeLock(1) == true)
+		if (m_state.write_lock(1) == true)
 		{
 			int pageNum = m_pNotebook-&gt;append_page(*pIndexPage, *pTab);
 			m_pNotebook-&gt;pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
@@ -752,7 +715,7 @@
 				pPage-&gt;hide();
 			}
 		}
-		else if (m_state.writeLock(2) == true)
+		else if (m_state.write_lock(2) == true)
 		{
 			// Remove the page
 			m_pNotebook-&gt;remove_page(pageNum);
@@ -767,30 +730,9 @@
 //
 void mainWindow::on_thread_end()
 {
-	WorkerThread *pThread = NULL;
 	ustring status;
 
-	// Get the first thread that's finished
-	if (m_state.readLock(3) == true)
-	{
-		for (set&lt;WorkerThread *&gt;::iterator threadIter = m_state.m_pThreads.begin();
-			threadIter != m_state.m_pThreads.end(); ++threadIter)
-		{
-#ifdef DEBUG
-			cout &lt;&lt; &quot;mainWindow::on_thread_end: looking for thread&quot; &lt;&lt; endl;
-#endif
-			if ((*threadIter)-&gt;isDone() == true)
-			{
-				// This one will do...
-				pThread = (*threadIter);
-				// Remove it
-				m_state.m_pThreads.erase(threadIter);
-				break;
-			}
-		}
-
-		m_state.unlock();
-	}
+	WorkerThread *pThread = m_state.on_thread_end();
 	if (pThread == NULL)
 	{
 #ifdef DEBUG
@@ -801,14 +743,9 @@
 #ifdef DEBUG
 	cout &lt;&lt; &quot;mainWindow::on_thread_end: end of thread &quot; &lt;&lt; pThread-&gt;getId() &lt;&lt; endl;
 #endif
-	update_threads_status();
 
 	// What type of thread was it ?
 	string type = pThread-&gt;getType();
-	if (pThread-&gt;isBackground() == true)
-	{
-		m_state.m_backgroundThreads--;
-	}
 	// Did the thread fail for some reason ?
 	string threadStatus = pThread-&gt;getStatus();
 	if (threadStatus.empty() == false)
@@ -936,7 +873,7 @@
 				SigC::slot(*this, &amp;mainWindow::on_resultsTreeviewSelection_changed));
 
 			// Append the page
-			if (m_state.writeLock(1) == true)
+			if (m_state.write_lock(3) == true)
 			{
 				pageNum = m_pNotebook-&gt;append_page(*pResultsPage, *pTab);
 				m_pNotebook-&gt;pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
@@ -1136,7 +1073,7 @@
 			status += to_utf8(url);
 
 			// Update the in-progress list
-			if (m_state.writeLock(4) == true)
+			if (m_state.write_lock(4) == true)
 			{
 				set&lt;string&gt;::iterator urlIter = m_state.m_beingIndexed.find(url);
 				if (urlIter != m_state.m_beingIndexed.end())
@@ -1236,7 +1173,7 @@
 	check_queue();
 
 	// Any threads left to return ?
-	if (get_threads_count() == 0)
+	if (m_state.get_threads_count() == 0)
 	{
 		if (m_timeoutConnection.connected() == true)
 		{
@@ -1370,20 +1307,6 @@
 }
 
 //
-// Message reception from importDialog
-//
-void mainWindow::on_message_import(DocumentInfo docInfo)
-{
-	string location = docInfo.getLocation();
-
-	if (location.empty() == false)
-	{
-		// Index the selected file
-		queue_index(docInfo, &quot;&quot;);
-	}
-}
-
-//
 // Session &gt; Configure menu selected
 //
 void mainWindow::on_configure_activate()
@@ -1403,7 +1326,7 @@
 	// FIXME: if mail accounts are configured, make sure the MonitorThread
 	// is running and knows about the new accounts
 
-	if (m_state.readLock(5) == true)
+	if (m_state.read_lock(2) == true)
 	{
 		for (int pageNum = 0; pageNum &lt; m_pNotebook-&gt;get_n_pages(); ++pageNum)
 		{
@@ -1819,13 +1742,35 @@
 //
 void mainWindow::on_import_activate()
 {
-	importDialog importBox(_(&quot;Import Document(s)&quot;));
+	set&lt;string&gt; mimeTypes;
+	int width, height;
 
-	importBox.getImportFileSignal().connect(SigC::slot(*this,
-		&amp;mainWindow::on_message_import));
+	TokenizerFactory::getSupportedTypes(mimeTypes);
+	get_size(width, height);
+
+	m_state.disconnect();
+
+	importDialog importBox(_(&quot;Import Document(s)&quot;), mimeTypes);
+	importBox.setHeight(height / 2);
 	importBox.show();
 	importBox.run();
-	// Let the signal handler deal with importing stuff
+
+	m_state.connect();
+
+	// Was anything imported ?
+	if (importBox.getDocumentsCount() &gt; 0)
+	{
+		ustring indexName(_(&quot;My Documents&quot;));
+
+		// Is the index still being shown ?
+		IndexTree *pIndexTree = NULL;
+		NotebookPageBox *pPage = get_page(indexName, NotebookPageBox::INDEX_PAGE);
+		if (pPage != NULL)
+		{
+			// Refresh
+			browse_index(indexName, 0);
+		}
+	}
 }
 
 //
@@ -2463,9 +2408,9 @@
 bool mainWindow::on_mainWindow_delete_event(GdkEventAny *ev)
 {
 	// Any thread still running ?
-	if (get_threads_count() &gt; 0)
+	if (m_state.get_threads_count() &gt; 0)
 	{
-		ustring boxTitle = _(&quot;At least one background task hasn't been completed yet. Quit now ?&quot;);
+		ustring boxTitle = _(&quot;At least one task hasn't completed yet. Quit now ?&quot;);
 		MessageDialog msgDialog(boxTitle, false, MESSAGE_QUESTION, BUTTONS_YES_NO);
 		msgDialog.set_transient_for(*this);
 		msgDialog.show();
@@ -2475,30 +2420,10 @@
 			return true;
 		}
 
-		if (m_state.readLock(6) == true)
-		{
-			for (set&lt;WorkerThread *&gt;::iterator threadIter = m_state.m_pThreads.begin();
-				threadIter != m_state.m_pThreads.end(); ++threadIter)
-			{
-#ifdef DEBUG
-				cout &lt;&lt; &quot;mainWindow::on_mainWindow_delete_event: stopping thread &quot;
-					&lt;&lt; (*threadIter)-&gt;getId() &lt;&lt; endl;
-#endif
-				// Stop all non-background threads
-				if ((*threadIter)-&gt;isBackground() == false)
-				{
-					// FIXME: what if one thread doesn't stop ? can it corrupt anything ?
-					(*threadIter)-&gt;stop();
-				}
-			}
-
-			m_state.unlock();
-		}
+		m_state.stop_threads();
 	}
-
 	// Disconnect the threads' finished signal
-	m_threadsEndConnection.block();
-	m_threadsEndConnection.disconnect();
+	m_state.disconnect();
 
 	// Save the window's position and dimensions now
 	// Don't worry about the gravity, it hasn't been changed
@@ -2520,7 +2445,7 @@
 {
 	NotebookPageBox *pNotebookPage = NULL;
 
-	if (m_state.readLock(7) == true)
+	if (m_state.read_lock(4) == true)
 	{
 		Widget *pPage = m_pNotebook-&gt;get_nth_page(m_pNotebook-&gt;get_current_page());
 		if (pPage != NULL)
@@ -2541,7 +2466,7 @@
 {
 	NotebookPageBox *pNotebookPage = NULL;
 
-	if (m_state.readLock(8) == true)
+	if (m_state.read_lock(5) == true)
 	{
 		for (int pageNum = 0; pageNum &lt; m_pNotebook-&gt;get_n_pages(); ++pageNum)
 		{
@@ -2578,7 +2503,7 @@
 {
 	int pageNumber = -1;
 
-	if (m_state.readLock(9) == true)
+	if (m_state.read_lock(6) == true)
 	{
 		for (int pageNum = 0; pageNum &lt; m_pNotebook-&gt;get_n_pages(); ++pageNum)
 		{
@@ -2614,9 +2539,9 @@
 bool mainWindow::queue_index(const DocumentInfo &amp;docInfo,
 	const string &amp;labelName, unsigned int docId)
 {
-	if (get_threads_count() &gt;= m_maxThreads)
+	if (m_state.get_threads_count() &gt;= m_maxThreads)
 	{
-		if (m_state.writeLock(50) == true)
+		if (m_state.write_lock(5) == true)
 		{
 			m_state.m_indexQueue[docInfo] = labelName;
 
@@ -2927,7 +2852,7 @@
 			docId = index.hasDocument(url);
 		}
 		if ((docId == 0) &amp;&amp;
-			(m_state.writeLock(10) == true))
+			(m_state.write_lock(6) == true))
 		{
 			if (m_state.m_beingIndexed.find(url) == m_state.m_beingIndexed.end())
 			{
@@ -3039,7 +2964,7 @@
 				pViewPage = manage(new ViewPage(viewName, m_pHtmlView, m_settings));
 
 				// Append the page
-				if (m_state.writeLock(1) == true)
+				if (m_state.write_lock(7) == true)
 				{
 					pageNum = m_pNotebook-&gt;append_page(*pViewPage, *pTab);
 					m_pNotebook-&gt;pages().back().set_tab_label_packing(false, true, Gtk::PACK_START);
@@ -3074,48 +2999,15 @@
 //
 // Start of worker thread
 //
-void mainWindow::start_thread(WorkerThread *pNewThread, bool inBackground)
+bool mainWindow::start_thread(WorkerThread *pNewThread, bool inBackground)
 {
-	static unsigned int nextId = 1;
-	bool insertedThread = false;
-
-	if (pNewThread == NULL)
+	if (m_state.start_thread(pNewThread, inBackground) == false)
 	{
-		return;
-	}
-
-	pNewThread-&gt;setId(nextId);
-	if (m_state.writeLock(11) == true)
-	{
-		pair&lt;set&lt;WorkerThread *&gt;::iterator, bool&gt; insertPair = m_state.m_pThreads.insert(pNewThread);
-		insertedThread = insertPair.second;
-
-		m_state.unlock();
-	}
-
-	// Was it inserted ?
-	if (insertedThread == false)
-	{
-		// No, it wasn't : delete the object and return
-		cerr &lt;&lt; &quot;mainWindow::start_thread: couldn't start &quot;
-			&lt;&lt; pNewThread-&gt;getType() &lt;&lt; &quot; &quot; &lt;&lt; pNewThread-&gt;getId() &lt;&lt; endl;
+		// Delete the object
 		delete pNewThread;
-
-		return;
+		return false;
 	}
 
-	// Start the thread
-#ifdef DEBUG
-	cout &lt;&lt; &quot;mainWindow::start_thread: start of &quot; &lt;&lt; pNewThread-&gt;getType()
-		&lt;&lt; &quot; &quot; &lt;&lt; pNewThread-&gt;getId() &lt;&lt; endl;
-#endif
-	if (inBackground == true)
-	{
-		pNewThread-&gt;inBackground();
-		++m_state.m_backgroundThreads;
-	}
-	pNewThread-&gt;start();
-
 	if (inBackground == false)
 	{
 		// Enable the activity progress bar
@@ -3124,10 +3016,9 @@
 		m_timeoutConnection = Glib::signal_timeout().connect(SigC::slot(*this,
 			&amp;mainWindow::on_activity_timeout), 1000);
 		m_timeoutConnection.unblock();
-		// Update the status
-		update_threads_status();
 	}
-	++nextId;
+
+	return true;
 }
 
 //
@@ -3135,7 +3026,7 @@
 //
 bool mainWindow::check_queue(void)
 {
-	if (get_threads_count() &gt;= m_maxThreads)
+	if (m_state.get_threads_count() &gt;= m_maxThreads)
 	{
 #ifdef DEBUG
 		cout &lt;&lt; &quot;mainWindow::check_queue: too many threads&quot; &lt;&lt; endl;
@@ -3146,7 +3037,7 @@
 	DocumentInfo docInfo;
 	string labelName;
 
-	if (m_state.writeLock(12) == true)
+	if (m_state.write_lock(9) == true)
 	{
 		if (m_state.m_indexQueue.empty() == false)
 		{
@@ -3191,52 +3082,6 @@
 }
 
 //
-// Returns the number of non-background threads.
-//
-unsigned int mainWindow::get_threads_count(void)
-{
-	int count = 0;
-
-	if (m_state.readLock(13) == true)
-	{
-		count = m_state.m_pThreads.size() - m_state.m_backgroundThreads;
-		m_state.unlock();
-	}
-#ifdef DEBUG
-	cout &lt;&lt; &quot;mainWindow::get_threads_count: &quot; &lt;&lt; count &lt;&lt; &quot; threads left&quot; &lt;&lt; endl;
-#endif
-
-	// A negative count would mean that a background thread returned
-	// without the main thread knowing about it
-	return (unsigned int)max(count , 0);
-}
-
-//
-// Updates the threads status text.
-//
-void mainWindow::update_threads_status(void)
-{
-	ustring text;
-	unsigned int threads = get_threads_count();
-
-	// Update the threads status text for the next call to set_status()
-	if (threads &gt; 0)
-	{
-		char countStr[64];
-		snprintf(countStr, 64, &quot;%d&quot;, threads);
-		text = countStr;
-		text += &quot; &quot;;
-		text += _(&quot;task(s) running&quot;);
-		text += &quot; - &quot;;
-		m_threadStatusText = text;
-	}
-	else
-	{
-		m_threadStatusText = &quot;&quot;;
-	}
-}
-
-//
 // Sets the status bar text.
 //
 void mainWindow::set_status(const ustring &amp;text, bool canBeSkipped)
@@ -3252,11 +3097,22 @@
 	}
 	lastTime = now;
 	
+	unsigned int threadsCount = m_state.get_threads_count();
+	if (threadsCount &gt; 0)
+	{
+		char threadsCountStr[64];
+
+		snprintf(threadsCountStr, 64, &quot;%u&quot;, threadsCount);
+		// Display the number of threads
+		mainProgressbar-&gt;set_text(threadsCountStr);
+	}
+	else
+	{
+		// Reset
+		mainProgressbar-&gt;set_text(&quot;&quot;);
+	}
 	// Pop the previous message
 	mainStatusbar-&gt;pop();
-	// Append the new message to the threads status text
-	ustring newText = m_threadStatusText;
-	newText += text;
 	// Push
-	mainStatusbar-&gt;push(newText);
+	mainStatusbar-&gt;push(text);
 }

Modified: trunk/UI/GTK2/src/mainWindow.hh
===================================================================
--- trunk/UI/GTK2/src/mainWindow.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/mainWindow.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -20,7 +20,6 @@
 #include &lt;string&gt;
 #include &lt;map&gt;
 #include &lt;set&gt;
-#include &lt;pthread.h&gt;
 #include &lt;sigc++/connection.h&gt;
 #include &lt;glibmm/refptr.h&gt;
 #include &lt;gdkmm/pixbuf.h&gt;
@@ -73,7 +72,6 @@
 	void on_editindex(Glib::ustring indexName, Glib::ustring location);
 	void on_message_reception(DocumentInfo docInfo, std::string labelName);
 	void on_message_indexupdate(IndexedDocument docInfo, unsigned int docId, std::string indexName);
-	void on_message_import(DocumentInfo docInfo);
 
 	// Handlers inherited from the base class
 	virtual void on_configure_activate();
@@ -130,19 +128,14 @@
 	void index_document(const DocumentInfo &amp;docInfo, const std::string &amp;labelName,
 		unsigned int docId = 0);
 	bool view_document(const std::string &amp;url, bool internalViewerOnly = false);
-	void start_thread(WorkerThread *pNewThread, bool inBackground = false);
+	bool start_thread(WorkerThread *pNewThread, bool inBackground = false);
 	bool check_queue(void);
 
 	// Status methods
 	bool on_activity_timeout(void);
-	unsigned int get_threads_count(void);
-	void update_threads_status(void);
 	void set_status(const Glib::ustring &amp;text, bool canBeSkipped = false);
 
 private:
-	// Threads
-	SigC::Connection m_threadsEndConnection;
-	Glib::ustring m_threadStatusText;
 	// Global settings
 	PinotSettings &amp;m_settings;
 	// Engine
@@ -167,23 +160,18 @@
 	// Activity timeout
 	SigC::Connection m_timeoutConnection;
 	// Internal state
-	struct InternalState
+	class InternalState : public ThreadsManager
 	{
 		public:
-			InternalState();
+			InternalState(mainWindow *pWindow);
 			~InternalState();
 
-			bool readLock(unsigned int where);
-			bool writeLock(unsigned int where);
-			void unlock(void);
+			void connect(void);
 
 			// Query
 			unsigned int m_liveQueryLength;
 			// Notebook pages
 			int m_currentPage;
-			// Worker threads
-			std::set&lt;WorkerThread *&gt; m_pThreads;
-			unsigned int m_backgroundThreads;
 			// In-progress actions
 			std::set&lt;std::string&gt; m_beingIndexed;
 			bool m_browsingIndex;
@@ -191,8 +179,7 @@
 			std::map&lt;DocumentInfo, string&gt; m_indexQueue;
 
 		protected:
-			// Read/write lock
-			pthread_rwlock_t m_rwLock;
+			mainWindow *m_pMainWindow;
 
 	} m_state;
 	static unsigned int m_maxDocsCount;

Modified: trunk/UI/GTK2/src/prefsDialog.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/prefsDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,10 +1,19 @@
-// generated 2003/5/18 21:15:37 BST by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to prefsDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include &lt;stdlib.h&gt;
 #include &lt;iostream&gt;
 #include &lt;glibmm/convert.h&gt;
@@ -20,7 +29,6 @@
 #include &quot;config.h&quot;
 #include &quot;NLS.h&quot;
 #include &quot;PinotUtils.h&quot;
-#include &quot;importDialog.hh&quot;
 #include &quot;prefsDialog.hh&quot;
 
 using namespace std;
@@ -281,33 +289,6 @@
 	return true;
 }
 
-void prefsDialog::on_message_import(DocumentInfo docInfo)
-{
-	Url urlObj(docInfo.getLocation());
-	string mimeType = docInfo.getType();
-
-	if ((urlObj.getProtocol() == &quot;file&quot;) &amp;&amp;
-		(mimeType == &quot;text/x-mail&quot;))
-	{
-		string fileName = urlObj.getLocation();
-		fileName += &quot;/&quot;;
-		fileName += urlObj.getFile();
-
-		// Create a new entry in the mail accounts list
-		TreeModel::iterator iter = m_refMailTree-&gt;append();
-		TreeModel::Row row = *iter;
-
-		row[m_mailColumns.m_location] = to_utf8(fileName);
-		row[m_mailColumns.m_type] = to_utf8(mimeType);
-		row[m_mailColumns.m_mTime] = 0;
-		row[m_mailColumns.m_minDate] = 0;
-	}
-
-	// Enable these buttons
-	editAccountButton-&gt;set_sensitive(true);
-	removeAccountButton-&gt;set_sensitive(true);
-}
-
 void prefsDialog::on_prefsOkbutton_clicked()
 {
 	// Synchronise widgets with settings
@@ -448,13 +429,34 @@
 
 void prefsDialog::on_addAccountButton_clicked()
 {
-	importDialog importBox(_(&quot;Import Mail Box(es)&quot;), false, true, true);
+	ustring fileName;
 
-	importBox.getImportFileSignal().connect(SigC::slot(*this,
-		&amp;prefsDialog::on_message_import));
-	importBox.show();
-	importBox.run();
-	// Let the signal handler deal with importing mail accounts
+	TreeModel::Children children = m_refMailTree-&gt;children();
+	bool wasEmpty = children.empty();
+
+	if (select_file_name(*this, _(&quot;Mbox File Location&quot;), fileName, true) == true)
+	{
+		string mimeType = MIMEScanner::scanFile(fileName);
+
+		if (mimeType == &quot;text/x-mail&quot;)
+		{
+			// Create a new entry in the mail accounts list
+			TreeModel::iterator iter = m_refMailTree-&gt;append();
+			TreeModel::Row row = *iter;
+	
+			row[m_mailColumns.m_location] = to_utf8(fileName);
+			row[m_mailColumns.m_type] = to_utf8(mimeType);
+			row[m_mailColumns.m_mTime] = 0;
+			row[m_mailColumns.m_minDate] = 0;
+
+			if (wasEmpty == true)
+			{
+				// Enable these buttons
+				editAccountButton-&gt;set_sensitive(true);
+				removeAccountButton-&gt;set_sensitive(true);
+			}
+		}
+	}
 }
 
 void prefsDialog::on_editAccountButton_clicked()

Modified: trunk/UI/GTK2/src/prefsDialog.hh
===================================================================
--- trunk/UI/GTK2/src/prefsDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/prefsDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,19 @@
-// generated 2003/5/18 21:15:37 BST by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to prefsDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _PREFSDIALOG_HH
 #define _PREFSDIALOG_HH
 
@@ -52,7 +57,6 @@
 	bool save_labelsTreeview();
 	void populate_mailTreeview();
 	bool save_mailTreeview();
-	void on_message_import(DocumentInfo docInfo);
 
 private:
 	PinotSettings &amp;m_settings;

Modified: trunk/UI/GTK2/src/prefsDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/prefsDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/prefsDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2005/12/1 23:54:57 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
+// generated 2006/1/5 9:17:18 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at thorgrim.dyndns.org.</A>(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -69,7 +69,7 @@
    browserEntry = Gtk::manage(new class Gtk::Entry());
    browserButton = Gtk::manage(new class Gtk::Button(_(&quot;...&quot;)));
    
-   Gtk::HBox *browserHbox = Gtk::manage(new class Gtk::HBox(false, 0));
+   Gtk::HBox *browserHbox = Gtk::manage(new class Gtk::HBox(false, 4));
    Gtk::Table *generalTable = Gtk::manage(new class Gtk::Table(2, 2, false));
    Gtk::Label *generalLabel = Gtk::manage(new class Gtk::Label(_(&quot;General&quot;)));
    Gtk::Label *indexLabelsLabel = Gtk::manage(new class Gtk::Label(_(&quot;Labels are used to classify indexed documents:&quot;)));
@@ -166,7 +166,7 @@
    browserButton-&gt;set_flags(Gtk::CAN_DEFAULT);
    browserButton-&gt;set_relief(Gtk::RELIEF_NORMAL);
    browserHbox-&gt;pack_start(*browserEntry);
-   browserHbox-&gt;pack_start(*browserButton, Gtk::PACK_SHRINK, 4);
+   browserHbox-&gt;pack_start(*browserButton, Gtk::PACK_SHRINK, 0);
    generalTable-&gt;set_row_spacings(0);
    generalTable-&gt;set_col_spacings(0);
    generalTable-&gt;attach(*robotsLabel, 0, 1, 0, 1, Gtk::FILL, Gtk::FILL, 0, 0);

Modified: trunk/UI/GTK2/src/propertiesDialog.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/propertiesDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,21 @@
-// generated 2004/8/13 22:59:43 BST by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.6.0_cvs
-//
-// newer (non customized) versions of this file go to propertiesDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include &lt;iostream&gt;
-#include &lt;glibmm/convert.h&gt;
-#include &lt;pangomm/font.h&gt;
-#include &lt;gtkmm/rc.h&gt;
+#include &lt;utility&gt;
 
 #include &quot;config.h&quot;
 #include &quot;NLS.h&quot;
@@ -18,7 +25,6 @@
 
 using namespace std;
 using namespace Glib;
-using namespace Gdk;
 using namespace Gtk;
 
 propertiesDialog::propertiesDialog(const std::set&lt;std::string&gt; &amp;docLabels,
@@ -100,41 +106,18 @@
 {
 	// FIXME: there must be a better way to determine how high the tree should be
 	// for all rows to be visible !
-	int labelsCount = m_refLabelsTree-&gt;children().size();
-	// By default, the tree is high enough for two rows to be visible
-	if (labelsCount &gt; 2)
+	int rowsCount = m_refLabelsTree-&gt;children().size();
+	// By default, the tree is high enough for two rows
+	if (rowsCount &gt; 2)
 	{
 		int width, height;
-		get_size(width, height);
 
-		RefPtr&lt;Style&gt; refRCStyle = RC::get_style(*labelsTreeview);
-		int fontSize = refRCStyle-&gt;get_font().get_size() / Pango::SCALE;
-#ifdef DEBUG
-		cout &lt;&lt; &quot;propertiesDialog::setHeight: max &quot; &lt;&lt; maxHeight &lt;&lt; &quot;, dialog &quot; &lt;&lt; height
-			&lt;&lt; &quot;, font &quot; &lt;&lt; fontSize &lt;&lt; &quot; &quot; &lt;&lt; refRCStyle-&gt;get_font().get_size() &lt;&lt; endl;
-#endif
-		height += fontSize * (labelsCount - 2);
-
-		TreeViewColumn *pColumn = labelsTreeview-&gt;get_column(1);
-		if (pColumn != NULL)
-		{
-			Rectangle cell_area;
-			int x_offset, y_offset, cellWidth, cellHeight;
-			pColumn-&gt;cell_get_size(cell_area, x_offset, y_offset, cellWidth, cellHeight);
-#ifdef DEBUG
-			cout &lt;&lt; &quot;propertiesDialog::setHeight: cell &quot; &lt;&lt; cellHeight &lt;&lt; &quot; &quot; &lt;&lt; y_offset &lt;&lt; endl;
-#endif
-			height += cellHeight * (labelsCount - 2);
-		}
-#ifdef DEBUG
-		cout &lt;&lt; &quot;propertiesDialog::setHeight: dialog &quot; &lt;&lt; height &lt;&lt; endl;
-#endif
-
-		if (height &gt; maxHeight)
-		{
-			height = maxHeight;
-		}
-		resize(width, height);
+		// What's the current size ?
+		get_size(width, height);
+		// Add enough room for the rows we need to show
+		height += get_column_height(labelsTreeview) * (rowsCount - 2);
+		// Resize
+		resize(width, min(maxHeight, height));
 	}
 }
 

Modified: trunk/UI/GTK2/src/propertiesDialog.hh
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/propertiesDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,19 @@
-// generated 2004/8/13 22:59:43 BST by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.6.0_cvs
-//
-// newer (non customized) versions of this file go to propertiesDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _LABELDIALOG_HH
 #define _LABELDIALOG_HH
 

Modified: trunk/UI/GTK2/src/propertiesDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/propertiesDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2005/11/26 18:15:06 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
+// generated 2006/1/5 9:17:19 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at thorgrim.dyndns.org.</A>(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -192,7 +192,6 @@
    viewport1-&gt;show();
    labelsScrolledwindow-&gt;show();
    propertiesVbox-&gt;show();
-   propertiesDialog-&gt;show();
    labelOkButton-&gt;signal_clicked().connect(SigC::slot(*this, &amp;propertiesDialog_glade::on_labelOkButton_clicked), false);
 }
 

Modified: trunk/UI/GTK2/src/queryDialog.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/queryDialog.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,10 +1,19 @@
-// generated 2003/6/13 20:26:49 BST by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to queryDialog.cc_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// This file is for your program, I won't touch it again!
-
 #include &lt;iostream&gt;
 #include &lt;glibmm/ustring.h&gt;
 #include &lt;glibmm/convert.h&gt;

Modified: trunk/UI/GTK2/src/queryDialog.hh
===================================================================
--- trunk/UI/GTK2/src/queryDialog.hh	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/queryDialog.hh	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,14 +1,19 @@
-// generated 2003/6/13 20:26:49 BST by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
-// using glademm V2.0.0
-//
-// newer (non customized) versions of this file go to queryDialog.hh_new
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU Library General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
 
-// you might replace
-//    class foo : public foo_glade { ... };
-// by
-//    typedef foo_glade foo;
-// if you didn't make any modifications to the widget
-
 #ifndef _QUERYDIALOG_HH
 #define _QUERYDIALOG_HH
 

Modified: trunk/UI/GTK2/src/queryDialog_glade.cc
===================================================================
--- trunk/UI/GTK2/src/queryDialog_glade.cc	2006-01-03 19:19:59 UTC (rev 52)
+++ trunk/UI/GTK2/src/queryDialog_glade.cc	2006-01-10 09:46:28 UTC (rev 53)
@@ -1,4 +1,4 @@
-// generated 2005/12/15 22:39:14 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
+// generated 2006/1/9 22:33:43 SGT by <A HREF="https://lists.berlios.de/mailman/listinfo/pinot-svn">fabrice at amra.dyndns.org.</A>(none)
 // using glademm V2.6.0
 //
 // DO NOT EDIT THIS FILE ! It was created using
@@ -116,6 +116,7 @@
    nameEntry-&gt;set_visibility(true);
    nameEntry-&gt;set_editable(true);
    nameEntry-&gt;set_max_length(0);
+   nameEntry-&gt;set_text(_(&quot;&quot;));
    nameEntry-&gt;set_has_frame(true);
    nameEntry-&gt;set_activates_default(false);
    table1-&gt;set_row_spacings(0);
@@ -126,18 +127,21 @@
    anyEntry-&gt;set_visibility(true);
    anyEntry-&gt;set_editable(true);
    anyEntry-&gt;set_max_length(0);
+   anyEntry-&gt;set_text(_(&quot;&quot;));
    anyEntry-&gt;set_has_frame(true);
    anyEntry-&gt;set_activates_default(false);
    hostNameEntry-&gt;set_flags(Gtk::CAN_FOCUS);
    hostNameEntry-&gt;set_visibility(true);
    hostNameEntry-&gt;set_editable(true);
    hostNameEntry-&gt;set_max_length(0);
+   hostNameEntry-&gt;set_text(_(&quot;&quot;));
    hostNameEntry-&gt;set_has_frame(true);
    hostNameEntry-&gt;set_activates_default(false);
    fileNameEntry-&gt;set_flags(Gtk::CAN_FOCUS);
    fileNameEntry-&gt;set_visibility(true);
    fileNameEntry-&gt;set_editable(true);
    fileNameEntry-&gt;set_max_length(0);
+   fileNameEntry-&gt;set_text(_(&quot;&quot;));
    fileNameEntry-&gt;set_has_frame(true);
    fileNameEntry-&gt;set_activates_default(false);
    resultsCountSpinbutton-&gt;set_flags(Gtk::CAN_FOCUS);
@@ -183,6 +187,7 @@
    notEntry-&gt;set_visibility(true);
    notEntry-&gt;set_editable(true);
    notEntry-&gt;set_max_length(0);
+   notEntry-&gt;set_text(_(&quot;&quot;));
    notEntry-&gt;set_has_frame(true);
    notEntry-&gt;set_activates_default(false);
    tersmTable-&gt;set_row_spacings(0);
@@ -216,6 +221,7 @@
    phraseEntry-&gt;set_visibility(true);
    phraseEntry-&gt;set_editable(true);
    phraseEntry-&gt;set_max_length(0);
+   phraseEntry-&gt;set_text(_(&quot;&quot;));
    phraseEntry-&gt;set_has_frame(true);
    phraseEntry-&gt;set_activates_default(false);
    phraseLabel-&gt;set_alignment(0,0.5);
@@ -234,6 +240,7 @@
    andEntry-&gt;set_visibility(true);
    andEntry-&gt;set_editable(true);
    andEntry-&gt;set_max_length(0);
+   andEntry-&gt;set_text(_(&quot;&quot;));
    andEntry-&gt;set_has_frame(true);
    andEntry-&gt;set_activates_default(false);
    andLabel-&gt;set_alignment(0,0.5);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000051.html">[Pinot-svn] r52 - trunk/po
</A></li>
	<LI>Next message: <A HREF="000053.html">[Pinot-svn] r54 - trunk/UI/GTK2/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52">[ date ]</a>
              <a href="thread.html#52">[ thread ]</a>
              <a href="subject.html#52">[ subject ]</a>
              <a href="author.html#52">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/pinot-svn">More information about the Pinot-svn
mailing list</a><br>
</body></html>
